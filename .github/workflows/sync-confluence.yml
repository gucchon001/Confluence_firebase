name: Sync Confluence Data

on:
  # ÊØéÊó•ÂçàÂâç2ÊôÇÔºàJST = UTC 17:00ÂâçÊó•Ôºâ„Å´Ëá™ÂãïÂÆüË°å
  schedule:
    - cron: '0 17 * * *'  # UTC 17:00 = JST 2:00ÔºàÁøåÊó•Ôºâ
  
  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Sync type (differential or full)'
        required: true
        default: 'differential'
        type: choice
        options:
          - differential
          - full

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}
      
      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Install dependencies
        run: npm install
      
      - name: Debug workflow context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Sync type: ${{ github.event.inputs.sync_type }}"
          echo "Should run differential: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'differential') }}"
          echo "Should run full: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'full' }}"
      
      - name: Run differential sync
        id: differential_sync
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'differential')
        run: npm run sync:confluence:differential
        continue-on-error: false
        env:
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CONFLUENCE_BASE_URL: https://giginc.atlassian.net
          CONFLUENCE_USER_EMAIL: kanri@jukust.jp
          CONFLUENCE_SPACE_KEY: CLIENTTOMO
      
      - name: Run full sync
        id: full_sync
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'full'
        run: npm run sync:confluence:batch
        env:
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CONFLUENCE_BASE_URL: https://giginc.atlassian.net
          CONFLUENCE_USER_EMAIL: kanri@jukust.jp
          CONFLUENCE_SPACE_KEY: CLIENTTOMO
      
      - name: Create LanceDB indexes
        id: create_indexes
        if: steps.differential_sync.outcome == 'success' || steps.full_sync.outcome == 'success'
        run: npm run lancedb:create-indexes
        env:
          GOOGLE_CLOUD_PROJECT: confluence-copilot-ppjye
        continue-on-error: true
      
      - name: Rebuild Lunr index
        id: rebuild_lunr
        if: steps.differential_sync.outcome == 'success' || steps.full_sync.outcome == 'success'
        run: npm run rebuild:lunr
        env:
          GOOGLE_CLOUD_PROJECT: confluence-copilot-ppjye
        continue-on-error: true
      
      - name: Upload data to Cloud Storage
        id: upload_data
        if: steps.differential_sync.outcome == 'success' || steps.full_sync.outcome == 'success'
        run: npm run upload:production-data
        env:
          GOOGLE_CLOUD_PROJECT: confluence-copilot-ppjye
      
      - name: Check if sync step was executed
        if: always()
        run: |
          if [ "${{ steps.differential_sync.outcome }}" != "success" ] && [ "${{ steps.full_sync.outcome }}" != "success" ]; then
            echo "‚ùå ÂêåÊúü„Çπ„ÉÜ„ÉÉ„Éó„ÅåÂÆüË°å„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü"
            echo "Event name: ${{ github.event_name }}"
            echo "Sync type: ${{ github.event.inputs.sync_type }}"
            echo "Differential sync outcome: ${{ steps.differential_sync.outcome }}"
            echo "Full sync outcome: ${{ steps.full_sync.outcome }}"
            exit 1
          fi
      
      - name: Notify completion
        if: steps.upload_data.outcome == 'success'
        run: |
          echo "‚úÖ Confluence data sync completed successfully"
          echo "üìä Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "üì¶ Index creation: ${{ steps.create_indexes.outcome }}"
          echo "üì¶ Lunr rebuild: ${{ steps.rebuild_lunr.outcome }}"
          echo "üì¶ Data upload: ${{ steps.upload_data.outcome }}"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Confluence data sync failed"
          echo "Please check the logs above for details"
          echo ""
          echo "Common issues:"
          echo "1. Check if environment variables are set correctly"
          echo "2. Check if Confluence API token is valid"
          echo "3. Check if Gemini API key is valid"
          echo "4. Check the previous step logs for error messages"
          echo "5. Check if sync step was executed (differential or full)"

