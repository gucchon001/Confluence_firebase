name: Sync Confluence Data

on:
  # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST = UTC 17:00å‰æ—¥ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 17 * * *'  # UTC 17:00 = JST 2:00ï¼ˆç¿Œæ—¥ï¼‰
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Sync type (differential or full)'
        required: true
        default: 'differential'
        type: choice
        options:
          - differential
          - full

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12æ™‚é–“ï¼ˆåˆå›åŒæœŸã§å…¨ãƒšãƒ¼ã‚¸å‡¦ç†ã™ã‚‹å ´åˆã«å‚™ãˆã¦å»¶é•·ï¼‰
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}
      
      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Install dependencies
        run: npm install
      
      - name: Debug workflow context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Sync type: ${{ github.event.inputs.sync_type }}"
          echo "Should run differential: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'differential') }}"
          echo "Should run full: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'full' }}"
      
      - name: Run differential sync
        id: differential_sync
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'differential')
        run: npm run sync:confluence:differential
        continue-on-error: false
        env:
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CONFLUENCE_BASE_URL: https://giginc.atlassian.net
          CONFLUENCE_USER_EMAIL: kanri@jukust.jp
          CONFLUENCE_SPACE_KEY: CLIENTTOMO
      
      - name: Run full sync
        id: full_sync
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type == 'full'
        run: npm run sync:confluence:batch
        env:
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CONFLUENCE_BASE_URL: https://giginc.atlassian.net
          CONFLUENCE_USER_EMAIL: kanri@jukust.jp
          CONFLUENCE_SPACE_KEY: CLIENTTOMO
      
      - name: Create LanceDB indexes
        id: create_indexes
        if: steps.differential_sync.outcome == 'success' || steps.full_sync.outcome == 'success'
        run: npm run lancedb:create-indexes
        env:
          GOOGLE_CLOUD_PROJECT: confluence-copilot-ppjye
        continue-on-error: true
      
      - name: Rebuild Lunr index
        id: rebuild_lunr
        if: steps.differential_sync.outcome == 'success' || steps.full_sync.outcome == 'success'
        run: npm run rebuild:lunr
        env:
          GOOGLE_CLOUD_PROJECT: confluence-copilot-ppjye
        continue-on-error: true
      
      - name: Upload data to Cloud Storage
        id: upload_data
        if: steps.differential_sync.outcome == 'success' || steps.full_sync.outcome == 'success'
        run: npm run upload:production-data
        env:
          GOOGLE_CLOUD_PROJECT: confluence-copilot-ppjye
      
      - name: Check if sync step was executed
        if: always()
        run: |
          # å·®åˆ†åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€å·®åˆ†ãŒãªã„å ´åˆã‚‚æ­£å¸¸çµ‚äº†ï¼ˆexit code 0ï¼‰ã™ã‚‹ãŸã‚ã€
          # success ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚ã“ã‚Œã¯æ­£å¸¸ãªå‹•ä½œã§ã™ã€‚
          differential_outcome="${{ steps.differential_sync.outcome }}"
          full_outcome="${{ steps.full_sync.outcome }}"
          
          echo "ğŸ“Š åŒæœŸã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè¡Œçµæœ:"
          echo "  Differential sync outcome: $differential_outcome"
          echo "  Full sync outcome: $full_outcome"
          echo "  Event name: ${{ github.event_name }}"
          echo "  Sync type: ${{ github.event.inputs.sync_type }}"
          
          # ã©ã¡ã‚‰ã‹ãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆã¯OKï¼ˆå·®åˆ†ãŒãªã„å ´åˆã‚‚å«ã‚€ï¼‰
          if [ "$differential_outcome" == "success" ] || [ "$full_outcome" == "success" ]; then
            echo "âœ… åŒæœŸã‚¹ãƒ†ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ"
            echo "   å·®åˆ†ãŒãªã„å ´åˆã‚‚æ­£å¸¸çµ‚äº†ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™"
            exit 0
          fi
          
          # ä¸¡æ–¹ã¨ã‚‚ skipped ã®å ´åˆã¯ã€æ¡ä»¶ã‚’æº€ãŸã•ãªã‹ã£ãŸï¼ˆã“ã‚Œã¯å•é¡Œï¼‰
          if [ "$differential_outcome" == "skipped" ] && [ "$full_outcome" == "skipped" ]; then
            echo "âŒ åŒæœŸã‚¹ãƒ†ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ï¼‰"
            echo "   ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã¯å·®åˆ†åŒæœŸãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¹ãã§ã™"
            exit 1
          fi
          
          # cancelled ã¾ãŸã¯ failure ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if [ "$differential_outcome" == "cancelled" ] || [ "$differential_outcome" == "failure" ] || \
             [ "$full_outcome" == "cancelled" ] || [ "$full_outcome" == "failure" ]; then
            echo "âŒ åŒæœŸã‚¹ãƒ†ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯å¤±æ•—ã—ã¾ã—ãŸ"
            echo ""
            echo "è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :"
            echo "1. å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆnpm installã€èªè¨¼ãªã©ï¼‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸ"
            echo "2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ãŸï¼ˆç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 720åˆ†ï¼‰"
            echo "3. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ‰‹å‹•ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸ"
            echo "4. GitHub Actionsã®ãƒªã‚½ãƒ¼ã‚¹åˆ¶ç´„"
            echo ""
            echo "ç¢ºèªäº‹é …:"
            echo "- å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆç‰¹ã« 'Install dependencies' ã‚„ 'Debug workflow context'ï¼‰ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            echo "- å·®åˆ†åŒæœŸã‚¹ãƒ†ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          # ãã®ä»–ã®äºˆæœŸã—ãªã„çŠ¶æ…‹
          echo "âš ï¸ äºˆæœŸã—ãªã„çŠ¶æ…‹ã§ã™"
          exit 1
      
      - name: Notify completion
        if: steps.upload_data.outcome == 'success'
        run: |
          echo "âœ… Confluence data sync completed successfully"
          echo "ğŸ“Š Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ğŸ“¦ Index creation: ${{ steps.create_indexes.outcome }}"
          echo "ğŸ“¦ Lunr rebuild: ${{ steps.rebuild_lunr.outcome }}"
          echo "ğŸ“¦ Data upload: ${{ steps.upload_data.outcome }}"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Confluence data sync failed"
          echo "Please check the logs above for details"
          echo ""
          echo "Common issues:"
          echo "1. Check if environment variables are set correctly"
          echo "2. Check if Confluence API token is valid"
          echo "3. Check if Gemini API key is valid"
          echo "4. Check the previous step logs for error messages"
          echo "5. Check if sync step was executed (differential or full)"

