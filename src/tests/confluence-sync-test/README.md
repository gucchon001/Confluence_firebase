# Confluence同期テスト

## 概要

正しいデータ構造に基づくConfluence同期プログラムのテストです。20ページの実際のConfluenceデータを使用して、以下の機能を検証します。

## テスト内容

### 1. 新規・差分更新テスト
- **pageId** による既存ページの検索
- **日付比較** による更新判定
- 新規追加・更新・変更なしの処理

### 2. ハイブリッド検索テスト
- ベクトル検索の動作確認
- BM25検索の動作確認
- ラベルフィルタリングの動作確認
- 検索結果の品質確認

### 3. 埋め込み・ラベルロジックの検証
- 768次元埋め込みベクトルの生成
- ラベル抽出・保存の正確性
- データ型の正確性（pageId: number, lastUpdated: string）

## ファイル構成

```
src/tests/confluence-sync-test/
├── confluence-sync-test.ts    # メインテストクラス
├── run-test.ts               # テスト実行スクリプト
└── README.md                 # このファイル
```

## 実行方法

```bash
# テスト実行
npx tsx src/tests/confluence-sync-test/run-test.ts
```

## 必要な環境変数

```env
CONFLUENCE_BASE_URL=https://your-domain.atlassian.net
CONFLUENCE_USER_EMAIL=your-email@example.com
CONFLUENCE_SPACE_KEY=YOUR_SPACE_KEY
CONFLUENCE_API_TOKEN=your-api-token
```

## テスト結果

### 期待される結果

1. **同期テスト**
   - 初回同期: 20ページが新規追加される
   - 2回目同期: すべて「変更なし」として処理される

2. **ハイブリッド検索**
   - 5つのテストクエリすべてで結果が返される
   - ラベルデータが正しく保存・検索される
   - ベクトル検索が正常に動作する

3. **データ品質**
   - pageIdが数値型で保存される
   - lastUpdatedが文字列で保存される
   - labelsが配列で保存される
   - vectorが768次元で保存される

### 検証ポイント

- ✅ **新規・差分更新**: pageIdと日付比較が正しく動作
- ✅ **ハイブリッド検索**: ベクトル・BM25・ラベル検索が統合動作
- ✅ **埋め込みロジック**: 768次元ベクトルが正しく生成
- ✅ **ラベルロジック**: ラベルが正しく抽出・保存・検索される

## トラブルシューティング

### よくある問題

1. **環境変数エラー**
   - `.env`ファイルの設定を確認
   - APIトークンの権限を確認

2. **同期エラー**
   - Confluence APIの制限を確認
   - ネットワーク接続を確認

3. **検索エラー**
   - LanceDBの初期化を確認
   - 埋め込みサービスの動作を確認

### ログの確認

テスト実行時は詳細なログが出力されます：
- ページ取得の進捗
- 同期処理の結果
- 検索テストの結果
- データ品質の確認結果
