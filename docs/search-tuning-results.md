# 検索チューニング結果レポート

## 実施日時
2024年12月19日

## 問題の背景
「教室管理の詳細な仕様」の検索結果が大幅にデグレードし、関連する重要なページが検索結果に含まれない問題が発生。

## 実施した調整

### 1. ベクトル検索重みの調整
```typescript
// 調整前
VECTOR_WEIGHT = 0.4, KEYWORD_WEIGHT = 0.5

// 調整後（最終）
VECTOR_WEIGHT = 0.4, KEYWORD_WEIGHT = 0.5
```

### 2. キーワード検索重みの重視
- BM25検索が有効化され、キーワードマッチングによる関連ページの発見が向上
- ベクトル検索とキーワード検索のバランスを最適化

## 改善結果

### 検索結果の質的向上
**クエリ**: "教室管理の詳細な仕様"

#### 改善後の検索結果
```
引用（High/Medium）
- 501_【FIX】教室一覧閲覧機能
- 【レビュー中】レコード削除時の動作一覧
- 150_【FIX】教室グループ管理機能
- 033_ 【FIX】教室口コミ詳細閲覧機能
- 153_【FIX】教室グループ詳細閲覧機能
- 164_【FIX】教室削除機能
- 161_【FIX】教室一覧閲覧機能
- レコメンドデータ
- 教室アクセスデータ

参照元
- 515_【作成中】教室管理-教室コピー機能 (34% 一致)
- レコメンドデータ (23% 一致)
```

#### 以前の検索結果（問題時）
```
参照元
- xxx_教室掲載管理機能 (47% 一致)
- 515_【作成中】教室管理-教室コピー機能 (34% 一致)
- xxx_クライアント企業教室編集機能 (32% 一致)
- xxx_クライアント企業教室登録・公開機能 (26% 一致)
- レコメンドデータ (23% 一致)
- xxx_教室一括掲載登録機能 (25% 一致)
```

## 重要な発見

### 1. 除外設定の正しい動作
- **500_■教室管理機能**：「フォルダ」ラベルで除外されるのは正しい動作
- **xxx_*パターン**：タイトル除外も正常に機能
- 除外設定（FR-06仕様）は適切に動作している

### 2. ページ存在確認
重要なページが全て存在することを確認：
- ✅ 150_【FIX】教室グループ管理機能 (pageId: 704413785)
- ✅ 033_ 【FIX】教室口コミ詳細閲覧機能 (pageId: 717521020)
- ✅ 153_【FIX】教室グループ詳細閲覧機能 (pageId: 704741470)
- ✅ 501_【FIX】教室一覧閲覧機能 (pageId: 713687237)

### 3. ハイブリッド検索の効果
- **BM25検索**：キーワードマッチングで関連ページを発見
- **ベクトル検索**：意味的類似性による候補抽出
- **RRF統合**：複数検索ソースの効果的な融合

## 技術的詳細

### 検索重みの最適化
```typescript
// src/lib/search-weights.ts
export const VECTOR_WEIGHT = 0.4; // ベクトル検索の重み
export const KEYWORD_WEIGHT = 0.5; // キーワード検索の重み（重視）
export const LABEL_WEIGHT = 0.1; // ラベル検索の重み
```

### ラベル除外設定
```typescript
// src/lib/label-manager.ts
excludeAlways: ['スコープ外', 'メールテンプレート', 'フォルダ', 'アーカイブ']
```

### タイトル除外パターン
```typescript
excludeTitlePatterns: ['xxx_*']
```

## 今後のチューニング指針

### 1. 重み調整の原則
- **その場しのぎの保守メンテは避ける**
- **アルゴリズムベースの改善**を重視
- **ハードコードされた設定の排除**

### 2. モニタリング項目
- 検索結果の関連性
- 除外設定の適切な動作
- ハイブリッド検索のバランス

### 3. 改善の方向性
- RRF重みの調整（k=60 → k=40）
- MMR多様化の調整（λ=0.7 → λ=0.8）
- 汎用語の重み調整の活用

## 結論

キーワード検索重みの調整により、検索結果が大幅に改善されました。重要な教室管理関連ページが適切に検索結果に含まれ、詳細な仕様情報を提供できるようになりました。

除外設定は仕様通りに動作し、フォルダラベルやxxx_*パターンの除外も正常に機能しています。

この設定を基準として、今後の検索精度向上に活用します。
