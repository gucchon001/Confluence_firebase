# パフォーマンス最適化アクションプラン

**作成日**: 2025-11-02  
**問題**: ベクトル検索に5.8秒かかっている（目標: 100-500ms）

## 📊 現状分析

### 解決済み ✅
- ベクトル検索エラー: 解消済み
- データ読み込み: `.lancedb`がコンテナイメージに含まれる

### 新たな課題 ❌
- **パフォーマンス**: 5.8秒（目標の10倍以上）
- **ボトルネック**: ベクトル検索（BM25は13msで正常）

## 🎯 最優先アクション

### Step 1: インデックス有無の確認（最優先）

```bash
npm run lancedb:check-indexes
```

**期待される結果**:
- ✅ インデックス存在 → 別の原因（コールドスタート、リソース不足）を調査
- ❌ インデックス不在 → **これが原因の可能性が非常に高い**

### Step 2: インデックス作成（インデックスが不在の場合）

```bash
npm run lancedb:create-indexes
```

**期待される改善**:
- 5.8秒 → **100-500ms**（10倍以上高速化）

### Step 3: 再現性テスト

複数回の検索リクエストを送り、時間を測定：
1. 1回目: コールドスタート（遅いのは想定）
2. 2回目以降: ウォーム検索（速いはず）

**確認項目**:
- 2回目以降も5.8秒かかる → インデックスまたはリソース問題
- 2回目以降が速い → コールドスタートが原因

### Step 4: 本番環境への反映

1. **ローカルでインデックス作成**
   ```bash
   npm run lancedb:create-indexes
   ```

2. **データアップロード**（インデックス付き）
   ```bash
   npm run upload:production-data
   ```

3. **本番環境で検証**
   - パフォーマンス改善を確認
   - Cloud Loggingで`[PERF]`メトリクスを監視

## 📋 チェックリスト

### 即座に実施

- [ ] インデックス有無を確認: `npm run lancedb:check-indexes`
- [ ] インデックスが不在なら作成: `npm run lancedb:create-indexes`
- [ ] 再現性テスト: 複数回検索リクエストを送る

### 次に実施

- [ ] ローカルでインデックス作成を確認
- [ ] インデックス付きデータを本番環境にアップロード
- [ ] 本番環境でパフォーマンス改善を検証

### 継続的監視

- [ ] Cloud Runメトリクス: CPU/メモリ使用率
- [ ] 検索時間のトレンド監視
- [ ] コールドスタートの発生頻度

## 🔧 技術的詳細

### インデックスの種類

**IVF-PQ (Inverted File - Product Quantization)**:
- パーティション数: 256（デフォルト）
- サブベクトル数: 96（768次元 ÷ 8）
- 効果: 全件スキャン → インデックス検索（10倍以上高速化）

### リソース設定

現在の設定（`apphosting.yaml`）:
- CPU: 2
- メモリ: 4096MiB
- 最小インスタンス数: 2

## 📈 期待される改善

### ベフォア（インデックスなし）
- ベクトル検索: **5,800ms**
- 全件スキャンによる遅延

### アフター（インデックスあり）
- ベクトル検索: **100-500ms**（推定）
- インデックス検索による高速化

### ユーザー体験
- 検索レスポンス: 5.8秒 → **0.5秒以下**
- UX: 大幅改善

## 🚨 トラブルシューティング

### インデックス作成に失敗する場合

1. **エラーメッセージを確認**
   - 既に存在する場合: 正常（スキップされる）
   - その他のエラー: 詳細を確認

2. **データベースの状態を確認**
   ```bash
   npm run lancedb:check-schema
   ```

### インデックス作成後も遅い場合

1. **インデックスパラメータの調整**
   - `numPartitions`: データ量に応じて調整
   - `numSubVectors`: 次元数に応じて調整

2. **リソースの増加**
   - CPU/メモリを増やす

3. **コールドスタート対策**
   - `minInstances`を確認（既に2に設定されている）

## 📝 関連ファイル

- **インデックス確認**: `scripts/check-lancedb-indexes.ts`
- **インデックス作成**: `scripts/create-lancedb-indexes.ts`
- **データ再構築**: `scripts/rebuild-lancedb-smart-chunking.ts`
- **設定**: `apphosting.yaml`

## 🎯 次のステップ

1. ✅ インデックス有無を確認（最優先）
2. ✅ インデックス作成（必要な場合）
3. ✅ 本番環境への反映
4. ✅ パフォーマンス改善を検証

---

**重要**: インデックスの不在がパフォーマンス問題の最も可能性の高い原因です。

