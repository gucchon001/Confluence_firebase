# ベクトル検索パフォーマンス問題の調査

**日付**: 2025-11-02  
**ステータス**: エラー解決済み → パフォーマンス問題発生

## 📊 現状

### ✅ 解決済み
- **ベクトル検索エラー**: `No vector column found` エラーは解消
- **データ読み込み**: `.lancedb`がコンテナイメージに正しく含まれるようになった
- **検索実行**: ベクトル検索が正常に実行され、結果が返されている

### ❌ 新たな課題
- **パフォーマンス**: ベクトル検索に約**5.8秒**かかっている
- **目標**: 通常、最適化されたベクトル検索は数十〜数百ミリ秒で完了するべき

## 🔍 ログから読み解く詳細

### 成功の証拠

```
[Vector Search] Found 80 results
[Phase 5] - Vector: 78件 (fulfilled)
revision_name: "confluence-chat-build-2025-11-02-001"
```

### パフォーマンス警告

```
[PERF] 🔍 Vector search completed in 5798ms
🚨 [CRITICAL] Slow parallel search detected: 5803ms (5.80s)
🚨 [CRITICAL] This indicates a bottleneck in either vector or BM25 search
```

**BM25検索は13msで完了**しているため、ボトルネックは**ベクトル検索**であることが明確。

## 🎯 考えられる原因

### 1. **コールドスタートの影響**（可能性：高）

**シナリオ**:
- Cloud Runインスタンスが起動した直後の最初の検索リクエスト
- 313MBの`.lancedb`ファイルをメモリに読み込む「ウォームアップ」に時間がかかる

**確認方法**:
- 同じインスタンスに対して複数回検索リクエストを送る
- 2回目以降も同様に5.8秒かかるか確認

**対策**:
- `minInstances: 2`は既に設定されている（`apphosting.yaml`）
- もしコールドスタートが原因なら、`minInstances`を確認

### 2. **インデックスの不在または非効率**（可能性：非常に高い）

**シナリオ**:
- LanceDBのテーブルに効率的な検索インデックス（IVF-PQ）が作成されていない
- インデックスがないと、全件スキャン（全ベクトルと比較）になるため、非常に遅い

**確認方法**:
1. `scripts/create-lancedb-indexes.ts`が実行されているか確認
2. インデックスが存在するか確認

**対策**:
- インデックス作成スクリプトを実行
- データベース再構築時にインデックスも作成されるようにする

### 3. **リソース不足**（可能性：中）

**シナリオ**:
- Cloud RunのCPUやメモリが、大量のベクトルデータを扱うには不足
- 現在の設定: `CPU: 2, メモリ: 4096MiB`

**確認方法**:
- Cloud ConsoleでCPU/メモリ使用率を確認
- 検索実行中のメトリクスを監視

**対策**:
- リソース割り当てを増やす（必要に応じて）

## 📋 調査チェックリスト

### 即座に確認すべき項目

- [ ] **再現性の確認**: 2回目以降の検索も5.8秒かかるか？
  - コールドスタートかウォーム検索かを切り分ける
  
- [ ] **インデックスの確認**: `.lancedb`にベクトルインデックスが存在するか？
  - `scripts/check-lancedb-indexes.ts`を実行（作成が必要）
  
- [ ] **Cloud Runメトリクス**: CPU/メモリ使用率を確認
  - 検索実行中のリソース使用状況を監視

### 次のステップ

- [ ] **インデックス作成**: インデックスがない場合、作成を実行
  - `npm run lancedb:create-indexes`（package.jsonに登録されているか確認）
  
- [ ] **データ再構築**: 必要に応じて、インデックス付きで再構築
  - `rebuild-lancedb-smart-chunking.ts`の後に`create-lancedb-indexes.ts`を実行

## 🔧 推奨アクションプラン

### Phase 1: 原因の切り分け（最優先）

1. **再現性テスト**: 複数回の検索リクエストを送り、時間を測定
2. **インデックス確認**: インデックス有無を確認するスクリプトを作成・実行

### Phase 2: インデックス作成（可能性が高い）

1. **インデックス作成スクリプトの確認**: `scripts/create-lancedb-indexes.ts`が正しく動作するか
2. **インデックス作成の実行**: ローカルでインデックスを作成
3. **本番データへの反映**: インデックス付きデータを本番環境にアップロード

### Phase 3: 最適化（必要に応じて）

1. **リソース調整**: CPU/メモリを増やす
2. **インデックスパラメータ調整**: `numPartitions`, `numSubVectors`の最適化

## 📝 関連ファイル

- **インデックス作成**: `scripts/create-lancedb-indexes.ts`
- **データ再構築**: `scripts/rebuild-lancedb-smart-chunking.ts`
- **設定**: `apphosting.yaml`（リソース設定）

## 🎯 期待される改善

インデックス作成後の期待値：
- **ベクトル検索**: 5.8秒 → **100-500ms**
- **ユーザー体験**: 大幅に改善

---

**次のアクション**: インデックス有無の確認スクリプトを作成し、実行する

