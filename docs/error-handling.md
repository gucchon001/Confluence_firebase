# エラーハンドリング仕様書: Confluence仕様書要約チャットボット

## 1. 概要

本ドキュメントは、アプリケーションで発生しうる主要なエラーケースと、その際のシステムの挙動、ユーザーへの通知方法を定義する。
これにより、堅牢でユーザーフレンドリーな体験を提供することを目指す。

## 2. エラーレスポンスの基本フォーマット

バックエンドAPIがエラーを返す際は、`api-design.md`で定義した通り、以下のJSON形式を基本とする。

```json
{
  "error": {
    "code": "resource_not_found",
    "message": "指定された会話が見つかりません。"
  }
}
```

## 3. 主要エラーケースと対応

| No. | エラーケース | 発生トリガー | バックエンドの対応 | フロントエンドの対応 |
|-----|--------------|--------------|-------------------|---------------------|
| 1 | 認証トークン無効 | - IDトークンの有効期限切れ<br>- 不正なトークン | HTTP 401 Unauthorized<br>code: "unauthorized"<br>message: "認証トークンが無効です。" | - ログイン画面へ強制的にリダイレクトする。<br>- 「セッションが切れました。再度ログインしてください。」というメッセージを表示する。 |
| 2 | Confluence APIエラー | - APIからのタイムアウト<br>- メンテナンス<br>- 権限不足 | HTTP 503 Service Unavailable<br>code: "confluence_api_error"<br>message: "Confluenceからのデータ取得に失敗しました。" | - AIの回答エリアに「仕様書の取得に失敗しました。時間をおいて再度お試しください。」というエラーメッセージを表示する。<br>- ローディング状態を解除する。 |
| 3 | LLM APIエラー | - APIからのタイムアウト<br>- コンテンツフィルタによるブロック | HTTP 503 Service Unavailable<br>code: "llm_api_error"<br>message: "AIからの回答生成に失敗しました。" | - AIの回答エリアに「回答の生成中にエラーが発生しました。別の質問をお試しください。」というエラーメッセージを表示する。<br>- ローディング状態を解除する。 |
| 4 | ベクトル検索エラー | - ベクトルDBの障害<br>- インデックスの問題 | HTTP 500 Internal Server Error<br>code: "vector_search_error"<br>message: "関連情報の検索に失敗しました。" | - AIの回答エリアに「内部エラーが発生しました。管理者にお問い合わせください。」という汎用エラーメッセージを表示する。 |
| 5 | DB書き込みエラー | - Firestoreへの書き込み失敗 | HTTP 500 Internal Server Error<br>code: "database_write_error"<br>message: "会話履歴の保存に失敗しました。" | - 「会話履歴の保存に失敗しました。」というトーストメッセージを短時間表示する。<br>- 会話自体は続行可能とするが、履歴には残らない可能性があることを示唆する。 |
| 6 | リソース未検出 | - 存在しない会話IDへのアクセス | HTTP 404 Not Found<br>code: "resource_not_found"<br>message: "指定された会話が見つかりません。" | - 「お探しの会話履歴は見つかりませんでした。」というメッセージを表示し、新しいチャット画面にリダイレクトする。 |
| 7 | 不正なリクエスト | - リクエストボディの形式が不正 | HTTP 400 Bad Request<br>code: "bad_request"<br>message: "リクエストの形式が正しくありません。" | - 基本的に発生しない想定だが、発生した場合は汎用の内部エラーメッセージを表示する。 |

## 4. バッチ処理のエラーハンドリング

バッチ処理（特にConfluenceからのデータ同期、ベクトル化、Vector Search更新）における堅牢なエラーハンドリングは、システムの信頼性を確保するために重要である。

### 4.1 Embedding APIエラー対応

| エラーケース | 発生トリガー | システムの対応 | リカバリ戦略 |
|--------------|--------------|--------------|-------------|
| ペイロードサイズ超過 | - 大きなテキストチャンク<br>- バッチサイズ過大 | - エラーログ記録<br>- 動的バッチサイズ調整<br>- 必要に応じてバッチ分割 | 1. バッチサイズを半減<br>2. 再試行<br>3. 単一チャンク処理に降格 |
| API制限到達 | - 短時間での多量リクエスト | - エラーログ記録<br>- 指数バックオフ<br>- リトライカウンタ管理 | 1. 待機時間を指数的に増加<br>2. 最大3回まで再試行<br>3. 失敗したバッチをログに記録し次回同期で優先処理 |
| 認証エラー | - APIキー無効<br>- 権限不足 | - 詳細なエラーログ記録<br>- 処理中断<br>- 管理者通知 | 1. 設定確認を促すエラーメッセージ<br>2. 処理を中断し再設定後に再実行 |

### 4.2 動的バッチサイズ調整アルゴリズム

大きなテキストチャンクによるペイロードサイズ制限エラーを防ぐため、以下のアルゴリズムを実装する：

1. コンテンツサイズに基づく最適バッチサイズ計算
   - 最大ペイロードサイズ: 30,000バイト（36,000の安全マージン）
   - 平均コンテンツサイズを計算
   - 最適バッチサイズ = MAX_PAYLOAD_SIZE ÷ 平均サイズ
   - 最小1、最大50に制限

2. 適応的リトライメカニズム
   - ペイロードエラー発生時はバッチを半分に分割
   - 指数バックオフで待機時間を増加（初期1秒、最大64秒）
   - 最大3回のリトライ後は空の埋め込みで続行

### 4.3 バッチ処理の冪等性確保

処理の途中失敗と再実行に対応するため、以下の冪等性メカニズムを実装する：

1. 処理状態の記録
   - `processingState`コレクションに処理状態を記録
   - ページID + バッチIDによる一意キー
   - 状態遷移: processing → completed/failed

2. 再開メカニズム
   - 同期開始時に前回の失敗バッチを確認
   - 失敗したページから処理を再開
   - 完了済みページはスキップ

## 5. エラーログと監視

### 5.1 構造化エラーログ

エラー発生時は以下の情報を含む構造化ログを生成する：

```json
{
  "operation": "embedding_generation",
  "code": "payload_size_exceeded",
  "message": "Request payload size exceeds the limit: 36000 bytes",
  "timestamp": "2025-09-12T02:01:08.825Z",
  "context": {
    "batchNumber": 14,
    "recordCount": 20,
    "contentSample": "文書の先頭部分...",
    "payloadSize": 38500
  }
}
```

### 5.2 エラーログの保存

- Firestoreの`errorLogs`コレクションに保存
- 重大なエラーは管理者に通知
- 定期的なエラーログ分析によるシステム改善

### 5.3 リトライポリシー

| エラータイプ | 最大リトライ回数 | 初期待機時間 | バックオフ係数 | 最大待機時間 |
|------------|---------------|------------|------------|------------|
| 一時的なネットワークエラー | 5 | 1秒 | 2 | 32秒 |
| API制限エラー | 3 | 5秒 | 2 | 20秒 |
| ペイロードサイズエラー | 2 | 0秒 | - | - |
| 認証エラー | 0 | - | - | - |

## 6. 実装ガイドライン

### 6.1 エラーハンドリングユーティリティ

以下のユーティリティ関数を実装し、一貫したエラー処理を行う：

1. `logError(operation, error, context)`: 構造化エラーログの生成と保存
2. `embedWithRetry(records, maxRetries, initialDelay)`: リトライロジック付き埋め込み生成
3. `calculateOptimalBatchSize(contents)`: 動的バッチサイズ計算
4. `processWithIdempotency(operation, key, processFn)`: 冪等性を確保した処理実行

### 6.2 エラー監視ダッシュボード

管理者向けに以下の情報を表示するダッシュボードを実装する：

- 日次/週次のエラー発生件数と種類
- バッチ処理の成功率と処理時間
- 失敗したバッチとその詳細
- リトライ回数と成功率

これにより、システム全体の健全性を把握し、継続的な改善を行う。