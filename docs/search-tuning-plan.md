# 検索チューニング設計・要件・品質チェックリスト・開発計画

## 1. 目的
- 質問に本質的に関連する一次情報を安定して取得し、UIには簡潔な要約と確実にクリック可能な参照（タイトル/URL）を返す。
- メール通知/議事録などノイズ文書の混入を抑え、仕様・設計ドキュメントを優先する。

## 2. アーキテクチャ方針（ベストプラクティス）
### 2.1 クエリ前処理
- 正規化（全角/半角、空白、記号）。
- 意図判定（仕様/操作/障害/運用/メール等）。
- 安全な拡張：
  - 同義語はドメイン限定語にのみ付与（例: ログイン→認証/login/サインイン）。
  - 汎用語（仕様/spec/要件/requirement/detail）はスコア計算から除外 or 重み極小。
  - 否定語（-メール/-通知 など）はフィルタにのみ適用し、採点から除外。

### 2.2 検索（並列）
- 空間制約: `space_key=CLIENTTOMO` で基本絞り込み。
- 並列実行と候補拡大：
  - Vector 検索 topK=100（原文クエリ/軽量拡張クエリを並列, 384次元）。
  - BM25/キーワード検索 topK=100。
  - タイトル/ラベル厳格一致（ログイン/ログアウト/認証）topK=50。
- フィルタ/重み：
  - 完全除外: フォルダ/スコープ外/アーカイブ/メールテンプレート。
  - 条件除外: 議事録（明示 opt-in で解除）。
  - 加点: 仕様書/設計書/機能要件/画面仕様/API仕様。
- マージ: 同一 `pageId` は先頭チャンク優遇、重複統合。

### 2.3 再ランク
- 軽量版（ルール/重み; 実装は `search-weights.ts` の `calculateKeywordScore`/`calculateLabelScore`/`calculateHybridScore`）→ 可能なら cross-encoder による rerank。
- ブースト: タイトル完全一致 > タイトル部分一致 > ラベル一致 > 本文一致。
- 見出し近接ブースト、ソース多様性制御（同一機能群の過集中抑制）。

### 2.4 生成（RAG）
- コンテキスト整形：見出し優先で結合、最大トークン制限。
- プロンプト規律：参照をテキストに埋めない、足りない時は「不足」と明示＋候補3件。
- 出力後処理：参照テキスト混入の除去、用語整形。

### 2.5 観測性/評価
- ログ: クエリ/拡張差分/各レイヤtopK/除外理由/採択理由（寄与内訳）。
- KPI: nDCG@k, MRR@k, Coverage（正例含有率）, ノイズ率（メール/議事録混入）。
- フィードバック: 「役立った/違う」から正負例を蓄積、重み/モデル更新。

## 3. 機能要件（抜粋）
- FR-01: `pageId` を検索結果の必須フィールドとして返却する。
- FR-02: 否定語はスコアリング対象外、フィルタのみで解釈する。
- FR-03: タイトル/ラベル厳格一致の候補を常に再ランク対象へ合流させる。
- FR-04: 一次候補の topK を 20→50（または100）に拡大して再ランクで絞る。
- FR-05: 一致理由（Title/Label/Content/Vector）をログとUIに表示可能にする。
- FR-06: Always exclude: フォルダ/スコープ外/アーカイブ/メールテンプレート。
- FR-07: 条件付き: 議事録はデフォルト除外、パラメータで解除。

## 4. 非機能要件（抜粋）
- NFR-01: 95パーセンタイルの応答時間 < 2.0s（一次候補集約まで）。
- NFR-02: 回帰テスト30クエリで nDCG@5 を現行比 +15%以上。
- NFR-03: ログのPIIマスク、監査用保持30日。

## 5. 品質テスト チェックリスト
- クエリ前処理
  - [ ] 否定語が採点に影響しない
  - [ ] 汎用語の重みが0/極小
- 検索候補
  - [ ] 原文/拡張/厳格一致の3系列が並列に走る
  - [ ] topK拡大後、再ランク候補にログイン系が含まれる
- フィルタ
  - [ ] アーカイブ/フォルダ/メールが除外される
  - [ ] 議事録は既定除外、パラメータで解除される
- 再ランク
  - [ ] タイトル一致が強ブースト
  - [ ] ラベル重みが仕様系で高く機能
- 生成
  - [ ] 参照のテキスト混入がない（UIのみでリンク表示）
- 観測性
  - [ ] 除外理由/採点内訳がログに残る
  - [ ] 代表30クエリの自動評価スクリプトが通る

## 6. 開発計画（フェーズ）
### Phase 1（即効・1〜2日）✅ 完了
- ✅ 否定語の採点除外、汎用語重み0化（`search-weights.ts`で実装）
- ✅ タイトル/ラベル厳格一致を再ランク候補に合流
- ✅ topK拡大（20→50）と簡易再ランク（ルール重み）
- ✅ ログに寄与内訳を追加

### Phase 2（1週）✅ 完了
- ✅ 並列 BM25 実装と候補統合（`lunr-search-client.ts`で実装）
- ✅ 一致理由タグのUI表示
- ✅ 代表30クエリで自動評価（nDCG/MRR）

### Phase 3（2〜3週）❌ 未実装
- ❌ cross-encoder による再ランク導入
- ❌ 重み/ルールを `search-weights.json` に外出し
- ❌ フィードバック学習パイプライン整備

## 7. ロールバック/フォールバック
- 閾値未満時はタイトル厳格一致のフォールバックを提示
- 設定は環境変数フラグで段階的リリース（ABテスト）

## 8. パフォーマンスSLOとレイテンシ目安
- 取得フェーズ（RAG検索）
  - 目標: P50 0.6–0.9s / P95 1.5–2.0s / P99 ≤ 3.0s
  - 内訳目安: クエリ前処理 ≤20ms、ベクトル検索 50–150ms、BM25 50–150ms、マージ/再スコア 50–200ms、I/O 50–150ms
- 再ランク導入時（200→20件）
  - 追加: 200–600ms（モデル/CPU/GPUによる）
  - 目標: P95 ≤ 2.5s
- 生成込み（回答生成まで）
  - 目標: P50 1.8–2.5s / P95 3.0–4.0s / P99 ≤ 5.0s
- 運用指針
  - タイムアウト: 取得2.5s、全体4.5–5.0s（フォールバックでタイトル一致提示）
  - 上限制御: 再ランク対象≤200件、要約対象≤5件・合計トークン上限
  - 監視: P50/P95/P99、失敗率、除外理由比率、キャッシュヒット率を可視化
