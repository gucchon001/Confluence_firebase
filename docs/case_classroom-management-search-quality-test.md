# 教室管理検索品質テスト仕様書

## 概要

「教室管理の詳細は」クエリを品質基準として、検索システムの抽出ページと出力結果の品質を評価するテスト仕様書です。

## テスト対象クエリ

**メインクエリ:** `教室管理の詳細は`

## 品質基準

### 1. 理想の抽出ページ（NotebookLMの出力に基づく）

#### 1.1 主要な教室管理機能ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `160_【FIX】教室管理機能` | 80+ | `["機能要件"]` | メインの教室管理機能 |
| `161_【FIX】教室一覧閲覧機能` | 75+ | `["機能要件"]` | 教室一覧閲覧 |
| `162_【FIX】教室新規登録機能` | 75+ | `["機能要件"]` | 教室新規登録 |
| `163_【FIX】教室情報編集機能` | 75+ | `["機能要件"]` | 教室情報編集 |
| `168_【FIX】教室コピー機能` | 70+ | `["機能要件"]` | 教室コピー機能 |
| `169-1_【FIX】教室掲載フラグ切り替え機能` | 70+ | `["機能要件"]` | 掲載フラグ切り替え |
| `169-2_【FIX】教室公開フラグ切り替え機能` | 70+ | `["機能要件"]` | 公開フラグ切り替え |
| `164_【FIX】教室削除機能` | 70+ | `["機能要件"]` | 教室削除 |

#### 1.2 関連する求人管理ページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `511_【FIX】教室管理-求人一覧閲覧機能` | 60+ | `["機能要件"]` | 求人一覧閲覧 |
| `512_【FIX】教室管理-求人情報新規登録機能` | 60+ | `["機能要件"]` | 求人情報新規登録 |
| `513_【FIX】教室管理-求人情報編集機能` | 60+ | `["機能要件"]` | 求人情報編集 |
| `514_【レビュー中】教室管理-求人削除機能` | 60+ | `["機能要件"]` | 求人削除 |
| `515_【作成中】教室管理-教室コピー機能` | 60+ | `["機能要件"]` | 教室コピー機能（作成中） |
| `516_【FIX】教室管理-一括更新機能` | 60+ | `["機能要件"]` | 一括更新機能 |

#### 1.3 関連する基本情報ページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `【FIX】教室：基本情報／所在地` | 50+ | `["機能要件"]` | 教室基本情報 |
| `【FIX】教室：応募情報転送連絡先／応募後連絡先電話番号` | 50+ | `["機能要件"]` | 応募情報転送連絡先 |
| `【FIX】教室：塾チャート` | 50+ | `["機能要件"]` | 塾チャート |
| `【FIX】教室：ロゴ・スライド画像` | 50+ | `["機能要件"]` | ロゴ・スライド画像 |

### 2. 除外されるべきページ

#### 2.1 フォルダラベルページ（除外対象）

| ページタイトル | ラベル | 除外理由 |
|---|---|---|
| `500_■教室管理機能` | `["フォルダ"]` | フォルダラベル |
| `510_■教室管理-求人管理機能` | `["機能要件", "フォルダ"]` | フォルダラベル |
| `010_■求人・教室管理機能` | `["機能要件", "フォルダ"]` | フォルダラベル |
| `塾講師ステーションドキュメントスペース` | `["フォルダ"]` | フォルダラベル |
| `710_■教室・求人情報関連バッチ` | `["機能要件", "フォルダ"]` | フォルダラベル |
| `910_■企業・教室グループ・教室` | `["フォルダ"]` | フォルダラベル |

#### 2.2 関連性の低いページ（除外対象）

| ページタイトル | ラベル | 除外理由 |
|---|---|---|
| `レコメンドデータ` | `["帳票"]` | 教室管理の詳細仕様とは直接関係なし |
| `教室アクセスデータ` | `["帳票"]` | 教室管理の詳細仕様とは直接関係なし |
| `【作成中】塾チャート` | `["共通要件"]` | 教室管理の詳細仕様とは直接関係なし |

## テストケース

### テストケース1: 基本検索テスト

**クエリ:** `教室管理の詳細は`

**期待される結果:**
- 抽出ページ数: 8-12件
- 上位3件に主要な教室管理機能ページが含まれる
- フォルダラベルページが除外される
- 関連性の低いページが除外される

**合格基準:**
- 主要な教室管理機能ページ（1.1）のうち5件以上が検索結果に含まれる
- 除外されるべきページ（2.1, 2.2）が検索結果に含まれない
- 上位3件のスコアが60以上

### テストケース2: キーワードマッチングテスト

**クエリ:** `教室管理の詳細は`

**期待されるキーワード抽出:**
- 基本キーワード: `["教室", "管理"]`
- 分割キーワード: `["教室管理", "詳細な仕様"]`
- LLM拡張キーワード: 教室管理に関連する同義語

**理想のキーワード抽出結果:**
```json
{
  "keywords": [
    "教室管理", "教室", "教室一覧", "教室登録", 
    "教室編集", "教室削除", "教室コピー", "教室管理の詳細"
  ],
  "highPriority": ["教室管理", "教室"],
  "lowPriority": ["教室一覧", "教室登録", "教室編集", "教室削除", "教室コピー", "教室管理の詳細"]
}
```

**合格基準:**
- キーワードスコアが0でない
- 分割されたキーワードが正しく抽出される
- タイトルマッチングが正しく動作する
- 理想のキーワード抽出結果に近い結果が得られる
- キーワード数が5個以上
- 教室管理に関連する具体的な機能名が含まれる

### テストケース3: スコアリングテスト

**クエリ:** `教室管理の詳細は`

**期待されるスコア分布:**
- 主要な教室管理機能ページ: 70-90点
- 関連する求人管理ページ: 50-70点
- 関連する基本情報ページ: 40-60点

**合格基準:**
- スコアが期待値の±10点以内
- スコアの順序が期待される優先度と一致

## 品質メトリクス

### 1. 検索精度（Precision）

```
Precision = 関連するページ数 / 検索結果総数
```

**目標値:** 0.8以上

### 2. 検索再現率（Recall）

```
Recall = 検索結果に含まれる関連ページ数 / 理想の関連ページ総数
```

**目標値:** 0.7以上

### 3. F1スコア

```
F1 = 2 × (Precision × Recall) / (Precision + Recall)
```

**目標値:** 0.75以上

### 4. 平均スコア

```
Average Score = 検索結果のスコア合計 / 検索結果数
```

**目標値:** 60以上

## テスト実行手順

### 1. 事前準備

```bash
# 検索システムの起動
npm run dev

# テストデータの確認
npx tsx -e "import { searchLanceDB } from './src/lib/lancedb-search-client'; searchLanceDB({ query: '教室管理の詳細は', topK: 20 }).then(r => console.log('Search results:', r.map(x => ({ title: x.title, score: x.score, labels: x.labels }))))"
```

### 2. テスト実行

```bash
# テストスクリプトの実行
npx tsx src/tests/classroom-management-search-test.ts
```

### 3. 結果評価

1. 検索結果の確認
2. スコアの検証
3. 除外ページの確認
4. メトリクスの計算

## 品質改善の指針

### 1. キーワード抽出の改善

- 分割キーワードの精度向上
- 同義語の拡張
- ストップワードの最適化

### 2. スコアリングの改善

- タイトルマッチングの重み調整
- コンテンツマッチングの精度向上
- ラベルマッチングの最適化

### 3. フィルタリングの改善

- ラベルフィルタリングの精度向上
- 関連性の低いページの除外

## 継続的改善

### 1. 定期的なテスト実行

- 週次での品質テスト実行
- 月次でのメトリクス分析

### 2. フィードバックの収集

- ユーザーフィードバックの収集
- 検索結果の品質評価

### 3. アルゴリズムの改善

- テスト結果に基づくパラメータ調整
- 新しい検索手法の導入

## 参考資料

- [NotebookLMの出力結果](./classroom-management-notebooklm-output.md)
- [検索チューニング計画](./search-tuning-plan.md)
- [検索チューニング結果](./search-tuning-results.md)
