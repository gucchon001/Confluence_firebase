# Phase 0A-4 段階的改善テスト基準

## 📋 概要

段階的改善（Phase 1-4）における各フェーズの想定精度・スピードを定義

## 🎯 テストケース定義

| # | クエリ | 期待ページ | 難易度 |
|---|--------|-----------|--------|
| 1 | 退会した会員が再度登録することは可能ですか | 046_【FIX】退会機能 | ⭐⭐ |
| 2 | 教室削除ができないのは何が原因ですか | 164_【FIX】教室削除機能 | ⭐⭐ |
| 3 | 教室コピーでコピーされる項目を教えてください | 168_【FIX】教室コピー機能 | ⭐⭐ |
| 4 | 塾講師が同時に何件まで応募できるか教えてください | 014_【FIX】応募機能 | ⭐⭐⭐ |
| 5 | 重複応募不可期間はいつからいつまでですか | 014_【FIX】応募機能 | ⭐⭐⭐ |
| 6 | 塾講師プロフィールの学年・職業を更新する方法を教えてください | 721_【FIX】塾講師-学年・職業更新機能 | ⭐⭐ |

**難易度の定義:**
- ⭐: タイトル直接一致（"削除" → "削除機能"）
- ⭐⭐: タイトル部分一致（"教室コピー" → "教室コピー機能"）
- ⭐⭐⭐: セマンティック検索必須（"何件まで応募" → "重複応募制限"）

---

## 📊 フェーズ別想定スコア

### Baseline: Phase 0A-2（KG統合前）

| 事例 | 発見 | 順位 | 検索時間 | 理由 |
|------|------|------|----------|------|
| 1 | ✅ | 1位 | ~700ms | タイトル+BM25で完全一致 |
| 2 | ✅ | 1位 | ~700ms | タイトル+BM25で完全一致 |
| 3 | ✅ | 1位 | ~700ms | タイトル+BM25で完全一致 |
| 4 | ✅ | 3位 | ~700ms | セマンティック検索でカバー |
| 5 | ✅ | 2位 | ~700ms | セマンティック検索でカバー |
| 6 | ✅ | 1位 | ~700ms | タイトル+BM25で完全一致 |

**Baseline総合:**
- **発見率: 100% (6/6)**
- **Top 3: 100% (6/6)**
- **平均検索時間: 714ms**

---

### Phase 0A-3（KG統合後 - 劣化状態）

| 事例 | 発見 | 順位 | 検索時間 | 問題 |
|------|------|------|----------|------|
| 1 | ❌ | - | ~15,000ms | チャンクサイズ過大、タイトルブースト無効 |
| 2 | ❌ | - | ~7,000ms | 同上 |
| 3 | ✅ | 1位 | ~17,000ms | 同上、偶然発見 |
| 4 | ❌ | - | ~8,000ms | 同上 |
| 5 | ❌ | - | ~9,000ms | 同上 |
| 6 | ❌ | - | ~4,000ms | 同上 |

**Phase 0A-3 総合:**
- **発見率: 17% (1/6)** ❌
- **Top 3: 17% (1/6)**
- **平均検索時間: 14,945ms** ❌

---

### Phase 1: タイトル検索最優先化（想定）

**実装内容:**
- ✅ タイトル厳格一致検索（Early Exit）
- ✅ タイトル部分一致検索（キーワードベース）
- ✅ ラベル一致検索

**想定効果:**

| 事例 | 発見 | 順位 | 検索時間 | 改善ロジック |
|------|------|------|----------|--------------|
| 1 | ✅ | 1位 | ~1,000ms | タイトル部分一致: "退会" |
| 2 | ✅ | 1位 | ~1,000ms | タイトル部分一致: "教室削除" |
| 3 | ✅ | 1位 | ~1,000ms | タイトル部分一致: "教室コピー" |
| 4 | ❌→✅ | 5位 | ~1,000ms | BM25タイトルブースト: "応募" |
| 5 | ❌→❌ | - | ~1,000ms | セマンティック検索依存 |
| 6 | ❌→❌ | - | ~1,000ms | 期待ページがLanceDBに存在しない可能性 |

**Phase 1 想定:**
- **発見率: 50-67% (3-4/6)** 🎯
- **Top 3: 50% (3/6)**
- **平均検索時間: 1,000ms**

**Phase 1 実測:**
- **発見率: 17-33% (1-2/6)** ⚠️ 想定より低い
- **平均検索時間: 7,567ms** ⚠️ 想定より遅い（全レコード取得が原因）

---

### Phase 2: チャンクサイズ最適化（想定）

**実装内容:**
- ✅ TOKEN_LIMIT: 8,192 → 1,024トークン
- ✅ CHUNK_SIZE: 1,800 → 1,600文字
- ✅ CHUNK_OVERLAP: 200文字
- ✅ LanceDB再構築

**想定効果:**

| 事例 | 発見 | 順位 | 検索時間 | 改善ロジック |
|------|------|------|----------|--------------|
| 1 | ✅ | 1位 | ~800ms | ベクトル検索精度向上 |
| 2 | ✅ | 1位 | ~800ms | ベクトル検索精度向上 |
| 3 | ✅ | 1位 | ~800ms | ベクトル検索精度向上 |
| 4 | ✅ | 3位 | ~800ms | 小さいチャンク→セマンティック検索改善 |
| 5 | ❌→✅ | 5位 | ~800ms | 小さいチャンク→セマンティック検索改善 |
| 6 | ❌→✅ | 3位 | ~800ms | ベクトル検索精度向上 |

**Phase 2 想定:**
- **発見率: 75-85% (4.5-5/6)** 🎯
- **Top 3: 67-75% (4-4.5/6)**
- **平均検索時間: 800ms**

**Phase 2 実測:**
- **発見率: 17% (1/6)** ❌ 想定より大幅に低い
- **平均検索時間: 3,797ms** ⚠️ 想定の4.7倍
- **チャンク統合時間: 977ms** ✅ 大幅改善（-57%）

---

### Phase 3: 複合スコアリング（想定）

**実装内容:**
- ✅ BM25スコア重視（40%）
- ✅ ベクトル検索（30%）
- ✅ タイトルマッチ（20%）
- ✅ ラベルマッチ（10%）

**想定効果:**

| 事例 | 発見 | 順位 | 検索時間 | 改善ロジック |
|------|------|------|----------|--------------|
| 1 | ✅ | 1位 | ~1,000ms | BM25+タイトルで高スコア |
| 2 | ✅ | 1位 | ~1,000ms | BM25+タイトルで高スコア |
| 3 | ✅ | 1位 | ~1,000ms | BM25+タイトルで高スコア |
| 4 | ✅ | 2位 | ~1,000ms | BM25"応募"+セマンティック |
| 5 | ✅ | 3位 | ~1,000ms | BM25"応募"+"期間"+セマンティック |
| 6 | ✅ | 1位 | ~1,000ms | BM25"学年"+"更新"+タイトル |

**Phase 3 想定:**
- **発見率: 85-100% (5-6/6)** 🎯
- **Top 3: 85-100% (5-6/6)**
- **平均検索時間: 1,000ms**

---

### Phase 4: KG早期統合（想定）

**実装内容:**
- ⬜ KGをPhase 1（検索前）に統合
- ⬜ ドメイン・タグによる事前フィルタリング
- ⬜ 参照リンク抽出による関連ページ発見

**想定効果:**

| 事例 | 発見 | 順位 | 検索時間 | 改善ロジック |
|------|------|------|----------|--------------|
| 1 | ✅ | 1位 | ~1,200ms | Phase 3維持 |
| 2 | ✅ | 1位 | ~1,200ms | Phase 3維持 |
| 3 | ✅ | 1位 | ~1,200ms | Phase 3維持 |
| 4 | ✅ | 1位 | ~1,200ms | KGで関連ページを発見 |
| 5 | ✅ | 1位 | ~1,200ms | KGで関連ページを発見 |
| 6 | ✅ | 1位 | ~1,200ms | KGで関連ページを発見 |

**Phase 4 想定:**
- **発見率: 100% (6/6)** 🎯
- **Top 3: 100% (6/6)**
- **平均検索時間: 1,200ms** (KGオーバーヘッド+200ms)

---

## 🎯 最終目標（Phase 4完了時）

### 精度目標
| 指標 | Baseline | Phase 0A-3 | Phase 4目標 |
|------|----------|------------|-------------|
| 発見率 | 100% | 17% | **100%** ✅ |
| Top 3率 | 100% | 17% | **100%** ✅ |
| 平均順位 | 1.5位 | - | **1.0位** ✅ |

### スピード目標
| 指標 | Baseline | Phase 0A-3 | Phase 4目標 |
|------|----------|------------|-------------|
| 検索時間 | 714ms | 14,945ms | **800-1,200ms** ✅ |
| チャンク統合 | - | 2,265ms | **500-800ms** ✅ |
| KG拡張 | - | 14,785ms | **8,000-10,000ms** ✅ |
| **合計時間** | **714ms** | **32,492ms** | **10,000-15,000ms** ✅ |

### 品質目標
| 指標 | 目標 | 測定方法 |
|------|------|----------|
| タイトル一致精度 | 100% | タイトルにキーワード含む場合は必ず上位3位 |
| BM25一致精度 | 100% | コンテンツにキーワード含む場合は必ず発見 |
| セマンティック精度 | 85%+ | 意味的に関連するページを発見 |
| KG拡張精度 | 50%+ | 参照リンクから関連ページを発見 |

---

## 📊 現状分析（Phase 2完了時点）

### ✅ 達成できたこと

| 項目 | 目標 | 実測 | 状態 |
|------|------|------|------|
| 検索速度 | <1,000ms | **3,797ms** | ⚠️ 想定の3.8倍 |
| チャンク統合 | <800ms | **977ms** | ✅ ほぼ達成 |
| 発見率 | 75-85% | **17%** | ❌ 大幅に未達 |

### ❌ 未達成の課題

1. **発見率が17%のまま**
   - 原因: ベクトル検索で期待ページが上位に来ていない
   - Phase 3（複合スコアリング）で改善予定

2. **検索時間が想定の3.8倍**
   - 原因: 不明（Phase 2で改善したはずだが想定より遅い）
   - さらなる調査が必要

---

## 🔬 Phase 3 テスト基準（複合スコアリング）

### 想定改善

| 事例 | Phase 2 | Phase 3想定 | 改善手法 |
|------|---------|-------------|----------|
| 1 | ❌ | ✅ (1位) | BM25"退会"+タイトル"退会" |
| 2 | ❌ | ✅ (1位) | BM25"削除"+タイトル"削除" |
| 3 | ✅ (1位) | ✅ (1位) | 維持 |
| 4 | ❌ | ✅ (3位) | BM25"応募"+セマンティック |
| 5 | ❌ | ✅ (3位) | BM25"応募"+"期間" |
| 6 | ❌ | ✅ (2位) | BM25"学年"+"更新" |

### 合格基準

| 指標 | 最低基準 | 目標 |
|------|----------|------|
| **発見率** | **≥80% (5/6)** | **100% (6/6)** |
| **Top 3率** | **≥67% (4/6)** | **100% (6/6)** |
| **検索時間** | **≤1,500ms** | **≤1,000ms** |
| **合計時間** | **≤15,000ms** | **≤12,000ms** |

---

## 🔬 Phase 4 テスト基準（KG早期統合）

### 想定改善

| 事例 | Phase 3 | Phase 4想定 | 改善手法 |
|------|---------|-------------|----------|
| 1 | ✅ (1位) | ✅ (1位) | 維持 |
| 2 | ✅ (1位) | ✅ (1位) | 維持 |
| 3 | ✅ (1位) | ✅ (1位) | 維持 |
| 4 | ✅ (3位) | ✅ (1位) | KGで"応募制限"関連ページを早期発見 |
| 5 | ✅ (3位) | ✅ (1位) | KGで"重複応募"関連ページを早期発見 |
| 6 | ✅ (2位) | ✅ (1位) | KGで"学年更新"関連ページを早期発見 |

### 合格基準

| 指標 | 最低基準 | 目標 |
|------|----------|------|
| **発見率** | **100% (6/6)** | **100% (6/6)** |
| **Top 3率** | **100% (6/6)** | **100% (6/6)** |
| **Top 1率** | **≥67% (4/6)** | **≥83% (5/6)** |
| **検索時間** | **≤1,500ms** | **≤1,200ms** |
| **合計時間** | **≤15,000ms** | **≤12,000ms** |

---

## 🚨 Phase 2 で発見した重大な問題

### ❌ 問題1: 期待ページが存在しない可能性

**事例6**: `721_【FIX】塾講師-学年・職業更新機能`

- 実際に見つかったページ: `721_【作成中】学年自動更新バッチ`
- **可能性1**: 期待ページのタイトルが誤っている
- **可能性2**: 期待ページがConfluenceに存在しない

**対応:** テストケースの期待ページを修正する必要がある

### ❌ 問題2: 発見率が想定より大幅に低い

**Phase 2想定: 75-85%**
**Phase 2実測: 17%**

**原因仮説:**
1. ベクトル検索の精度が依然として低い
2. BM25とベクトルの統合（RRF）が効いていない
3. タイトルブーストが効いていない（titleWeight=3.0でも不十分）
4. 期待ページのタイトルとクエリのミスマッチ

**対応:** 詳細調査が必要

---

## 📈 改善ロードマップ

### Phase 3での重点施策

1. **BM25スコアを最優先化（40% → 50%）**
   - キーワード完全一致を最重視
   - タイトルマッチをBM25に統合

2. **タイトルブースト強化**
   - 現在: 2-3倍ブースト
   - 改善: 5-10倍ブースト（タイトル一致は圧倒的優先）

3. **期待ページの検証**
   - 全6事例の期待ページがLanceDBに存在するか確認
   - 存在しない場合は正しいタイトルを特定

### Phase 4での重点施策

1. **KGを検索前に統合**
   - 現在: 検索後にKG拡張（遅い）
   - 改善: ドメイン・タグで事前フィルタリング

2. **参照リンク活用**
   - ページ内の"177_機能名"リンクを抽出
   - 関連ページを事前に候補に追加

3. **キャッシュ戦略**
   - ドメイン知識をメモリにキャッシュ
   - KGクエリ結果をキャッシュ

---

## 🔍 次のアクション

### 優先度1: 期待ページの検証（緊急）

```typescript
// scripts/verify-all-expected-pages.ts
// 全6事例の期待ページがLanceDBに存在するか確認
```

**目的:** テスト基準の正確性を担保

### 優先度2: Phase 3 効果測定

```bash
npm run perf:test
```

**合格基準:**
- 発見率 ≥80% (5/6)
- 検索時間 ≤1,500ms

### 優先度3: 根本原因の特定

**なぜPhase 2で発見率が改善しなかったのか？**

仮説検証:
1. [ ] 期待ページがLanceDBに存在しない
2. [ ] 期待ページのタイトルがテストケースと異なる
3. [ ] ベクトル検索の精度が依然として低い（エンベディング品質）
4. [ ] BM25とベクトルの統合方法に問題がある

---

## 📝 メトリクス定義

### 精度メトリクス

| メトリクス | 計算式 | 目標値 |
|-----------|--------|--------|
| 発見率 | 発見した事例数 / 総事例数 | ≥80% |
| Top 3率 | Top 3に入った事例数 / 総事例数 | ≥67% |
| Top 1率 | 1位で発見した事例数 / 総事例数 | ≥50% |
| MRR (平均逆順位) | 平均(1/順位) | ≥0.7 |

### スピードメトリクス

| メトリクス | 目標値 | 許容値 |
|-----------|--------|--------|
| 検索時間 | ≤1,000ms | ≤1,500ms |
| チャンク統合時間 | ≤800ms | ≤1,200ms |
| KG拡張時間 | ≤9,000ms | ≤12,000ms |
| **合計時間** | **≤12,000ms** | **≤15,000ms** |

### 品質メトリクス

| メトリクス | 計算式 | 目標値 |
|-----------|--------|--------|
| タイトル一致発見率 | タイトルにキーワード含む場合の発見率 | 100% |
| BM25一致発見率 | BM25で高スコアの場合の発見率 | 100% |
| チャンク統合率 | マージされたチャンク数 / 総チャンク数 | 30-50% |
| KG拡張率 | KGで追加されたページ数 / 初期結果数 | 10-30% |

---

## 💡 テスト実行ガイド

### Phase 3 テスト実行

```bash
# 1. Phase 3 実装を確認
git status

# 2. パフォーマンステスト実行
npm run perf:test

# 3. 結果を評価
# - 発見率 ≥80% → 合格
# - 検索時間 ≤1,500ms → 合格
```

### 合格判定

```
✅ Phase 3 合格基準:
  - 発見率: ≥80% (5/6以上)
  - Top 3率: ≥67% (4/6以上)
  - 検索時間: ≤1,500ms
  - 合計時間: ≤15,000ms

❌ Phase 3 不合格の場合:
  - 根本原因を特定
  - 追加施策を検討
  - Phase 3.5として追加改善を実施
```

---

## 📚 参考資料

- **Phase 0A-2 Baseline**: `docs/implementation/phase-0a-2-completion-report.md`
- **Phase 0A-3 劣化分析**: `docs/implementation/phase-0a-3-quality-investigation-report.md`
- **Phase 0A-4 設計**: `docs/architecture/enhanced-hybrid-search-design.md`
- **ハイブリッド検索分析**: `docs/architecture/hybrid-search-flow-analysis.md`

