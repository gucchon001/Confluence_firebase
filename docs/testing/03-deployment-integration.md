# デプロイ・整合性テスト

ローカル・本番環境でのデプロイ、型チェック、データ整合性の確認を行うテストです。

## 📚 関連ドキュメント

テストを理解するために、以下のドキュメントを参照してください：

- **[デプロイガイド](../../operations/01-deployment-guide.md)**: デプロイ手順と運用方法
- **[環境変数設定ガイド](../../operations/13-environment-variables.md)**: 環境変数の設定方法
- **[環境別設定ガイド](../../operations/12-environment-setup.md)**: 開発環境のセットアップ方法
- **[拡張スキーマ運用ガイド](../../operations/05-extended-schema-operation-guide.md)**: 拡張スキーマの運用方法
- **[システム全体仕様書](../../specifications/spec.md)**: システム全体の機能要件と技術スタック

## 📋 テスト項目

### 1. 環境変数・設定値検証

#### 1.1 設定値管理移行テスト

**目的**: 統合設定ファイルへの移行が正しく動作しているか確認

**詳細**: [`config-migration-test-results.md`](./config-migration-test-results.md)を参照

**確認項目**:
- [ ] Confluence設定が正しく読み込まれる
- [ ] Jira設定が正しく読み込まれる
- [ ] Gemini設定が正しく読み込まれる
- [ ] Firebase設定が正しく読み込まれる
- [ ] 環境判定が正しく動作する
- [ ] デプロイメント判定が正しく動作する

**実行方法**:
```bash
# 設定値の検証（コード内で実行）
# 各サービスが正しく設定値を読み込んでいるか確認
```

### 2. 型安全性検証

#### 2.1 TypeScript型チェック

**目的**: 型エラーがないことを確認

**実行方法**:
```bash
npx tsc --noEmit
```

**確認項目**:
- [ ] 型エラーがない
- [ ] 型定義が正しい
- [ ] インターフェースが正しく定義されている

#### 2.2 データ型整合性

**目的**: データベースとコード間の型整合性を確認

**確認項目**:
- [ ] LanceDBスキーマとTypeScript型が一致している
- [ ] FirestoreスキーマとTypeScript型が一致している
- [ ] APIレスポンスの型が正しい

### 3. ローカル環境テスト

#### 3.1 ローカルビルドテスト

**目的**: ローカル環境でビルドが正常に完了するか確認

**実行方法**:
```bash
npm run test:local-build
npm run build
```

**確認項目**:
- [ ] ビルドが正常に完了する
- [ ] ビルドエラーがない
- [ ] ビルド成果物が正しく生成される

#### 3.2 ローカル開発サーバー

**目的**: ローカル開発サーバーが正常に起動するか確認

**実行方法**:
```bash
npm run dev
```

**確認項目**:
- [ ] サーバーが正常に起動する
- [ ] エラーログがない
- [ ] APIエンドポイントが正常に動作する

### 4. 本番環境デプロイテスト

#### 4.1 本番デプロイ準備

**目的**: 本番環境へのデプロイ準備が整っているか確認

**実行方法**:
```bash
npm run prepare:production
```

**確認項目**:
- [ ] 環境変数が正しく設定されている
- [ ] データベース接続が正常
- [ ] インデックスが作成されている

#### 4.2 本番データ整合性

**目的**: 本番環境のデータが正しいか確認

**実行方法**:
```bash
npm run check:production-lancedb-schema
npm run check:cloud-storage-lancedb
```

**確認項目**:
- [ ] 本番LanceDBのスキーマが正しい
- [ ] 本番データが正しく保存されている
- [ ] 本番インデックスが作成されている

### 5. データ整合性検証

#### 5.1 データ同期整合性

**目的**: データ同期が正しく動作しているか確認

**確認項目**:
- [ ] ConfluenceとLanceDBのデータが一致している
- [ ] JiraとLanceDBのデータが一致している
- [ ] データの更新が正しく反映されている

#### 5.2 データ整合性チェック

**目的**: データの整合性を確認

**実行方法**:
```bash
npm run check:lancedb-table-schema
npm run verify:extended-schema
```

**確認項目**:
- [ ] データの整合性が保たれている
- [ ] 重複データがない
- [ ] 欠損データがない

## 📊 テスト結果

### 設定値管理移行テスト結果

詳細な結果は [`09-config-migration-test-results.md`](./09-config-migration-test-results.md) を参照してください。

**サマリー**:
- ✅ 総テスト数: 22件
- ✅ 成功: 22件 (100%)
- ❌ 失敗: 0件

**テスト項目**:
1. ✅ 統合設定ファイルの読み込み
   - Confluence設定の読み込み
   - Jira設定の読み込み
   - Gemini設定の読み込み
   - Firebase設定の読み込み
   - 環境判定の読み込み
   - デプロイメント判定の読み込み

2. ✅ ConfluenceSyncServiceのテスト
   - インスタンス化
   - 設定値の整合性確認

3. ✅ JiraSyncServiceのテスト
   - インスタンス化
   - フォールバックロジック確認
   - maxIssuesのデフォルト値確認

4. ✅ URL構築ユーティリティのテスト
   - buildConfluenceUrl（統合設定使用）
   - buildJiraUrl（統合設定使用）

5. ✅ 後方互換性のテスト
   - 環境変数と統合設定の整合性確認

## 🔄 定期的な実行

以下のテストは定期的に実行することを推奨します：

- **型チェック**: コード変更後、プルリクエスト作成前
- **ローカルビルド**: デプロイ前
- **本番デプロイ準備**: 本番デプロイ前
- **データ整合性**: データ更新後、デプロイ後

