# データベース再構築スクリプトガイド

## 概要

このガイドは、`pageId`から`page_id`へのデータベースマイグレーションを実行する方法を説明します。

## マイグレーションスクリプト

### スクリプト名
`scripts/migrate-pageid-to-page-id.ts`

### 実行方法
```bash
npm run migrate:pageid-to-page-id
```

## マイグレーション処理の流れ

### 1. データベース接続確認
- `.lancedb`ディレクトリの存在確認
- 既存テーブル`confluence`の存在確認

### 2. データ統計情報の取得
- 総行数の確認
- データの有無を確認

### 3. バックアップ作成（自動）
- マイグレーション前に自動バックアップを作成
- バックアップパス: `.lancedb.backup-<timestamp>`

### 4. 既存データの読み込み
- すべてのレコードを読み込む
- 大きなデータセットの場合は時間がかかる場合があります

### 5. データ変換
- `pageId`フィールドを`page_id`に変換
- 型変換（number → bigint）
- すべてのフィールドを新しいスキーマに適合

### 6. 古いテーブルの削除
- 既存の`confluence`テーブルを削除

### 7. 新しいテーブルの作成
- `page_id`フィールドを使用した新しいスキーマで作成
- 変換済みデータを書き込み

### 8. スカラーインデックス作成
- `page_id`スカラーインデックスを作成
- `id`スカラーインデックスを作成

### 9. 検証
- データ数の確認
- スキーマの確認（`page_id`フィールドの存在確認）

### 10. パフォーマンステスト
- サンプルクエリを実行してパフォーマンスを確認
- 期待される結果: < 100ms

## 注意事項

### ⚠️ 重要な警告

1. **データバックアップ**: スクリプトは自動的にバックアップを作成しますが、念のため手動でもバックアップを推奨します

2. **実行時間**: データ量に応じて時間がかかります
   - 10,000行: 約1-2分
   - 100,000行: 約10-20分
   - 1,000,000行: 約1-2時間

3. **ディスク容量**: マイグレーション中は一時的に2倍の容量が必要です（バックアップ用）

4. **実行中の中断**: マイグレーション中に中断すると、データが破損する可能性があります。必ず完了まで待ってください

### ✅ 実行前の確認事項

- [ ] データベースのバックアップを取得（推奨）
- [ ] 十分なディスク容量があることを確認
- [ ] アプリケーションが停止していることを確認
- [ ] マイグレーションに十分な時間があることを確認

## 実行後の確認

### 1. マイグレーション統計の確認
- 移行成功行数
- 移行失敗行数
- 総実行時間

### 2. パフォーマンステストの実行
```bash
npm run test:get-all-chunks-page-id
```

### 3. アプリケーションの動作確認
- 検索機能の確認
- データ取得機能の確認
- エラーログの確認

## トラブルシューティング

### エラー: テーブルが見つからない
- **原因**: 既存のテーブルが存在しない
- **対処**: データベースの状態を確認してください

### エラー: ディスク容量不足
- **原因**: バックアップ作成に必要な容量が不足
- **対処**: ディスク容量を確保してから再実行

### エラー: マイグレーション失敗
- **原因**: データの型変換エラーなど
- **対処**: 
  1. バックアップから復元
  2. エラーログを確認
  3. 問題のあるデータを修正

### パフォーマンステストが遅い
- **原因**: インデックスが正しく作成されていない
- **対処**: スカラーインデックスの作成を再実行

## バックアップからの復元

バックアップから復元する場合:

```bash
# バックアップパスを確認（マイグレーション完了時に表示されます）
BACKUP_PATH=".lancedb.backup-<timestamp>"

# 既存のデータベースを削除
rm -rf .lancedb

# バックアップから復元
cp -r $BACKUP_PATH .lancedb
```

## 次のステップ

マイグレーション完了後:

1. ✅ パフォーマンステストを実行
2. ✅ アプリケーションを再起動して動作確認
3. ✅ 問題がなければ、バックアップを削除
4. ✅ 本番環境への適用準備

## 関連スクリプト

- `npm run lancedb:check-indexes`: インデックスの確認
- `npm run lancedb:create-indexes`: インデックスの作成（別用途）
- `npm run test:get-all-chunks-page-id`: パフォーマンステスト

