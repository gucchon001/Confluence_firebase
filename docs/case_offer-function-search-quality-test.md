# オファー機能検索品質テスト仕様書

## 概要

「オファー機能の種類は？」クエリを品質基準として、検索システムの抽出ページと出力結果の品質を評価するテスト仕様書です。

## テスト対象クエリ

**メインクエリ:** `オファー機能の種類は？`

## 品質基準

### 1. 理想の抽出ページ（NotebookLMの出力に基づく）

#### 1.1 主要なオファー機能ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `071_【FIX】オファー一覧閲覧機能` | 85+ | `["機能要件"]` | オファー一覧閲覧のメイン機能 |
| `【FIX】オファー履歴` | 80+ | `["機能要件"]` | オファー履歴の管理 |
| `193_【FIX】オファー新規作成機能` | 75+ | `["機能要件"]` | パーソナルオファー新規作成 |
| `194_【FIX】自動オファー設定機能` | 75+ | `["機能要件"]` | 自動オファー設定 |
| `053_【FIX】スカウト・マッチ利用設定機能` | 70+ | `["機能要件"]` | 会員側のオファー機能管理 |
| `562_【FIX】自動オファー条件設定機能` | 70+ | `["機能要件"]` | 自動オファー条件設定 |

#### 1.2 パーソナルオファー管理ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `542_【FIX】パーソナルオファー管理 - テンプレート新規作成機能` | 70+ | `["機能要件"]` | パーソナルオファーテンプレート作成 |
| `543_【FIX】パーソナルオファー管理 - テンプレート編集機能` | 70+ | `["機能要件"]` | パーソナルオファーテンプレート編集 |

#### 1.3 自動オファー関連ページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `【FIX】オファー設定情報（自動オファー）` | 65+ | `["機能要件"]` | 自動オファー設定情報 |
| `742_【作成中】自動オファー送信バッチ` | 60+ | `["機能要件"]` | 自動オファー送信バッチ |

#### 1.4 通知関連ページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `パーソナルオファー受信通知メール（会員宛）` | 60+ | `["機能要件"]` | パーソナルオファー通知 |
| `自動オファー受信通知メール（会員宛）` | 60+ | `["機能要件"]` | 自動オファー通知 |

### 2. 除外されるべきページ

#### 2.1 フォルダラベルページ（除外対象）

| ページタイトル | ラベル | 除外理由 |
|---|---|---|
| `■オファー機能` | `["フォルダ"]` | フォルダラベル |
| `■オファー管理機能` | `["機能要件", "フォルダ"]` | フォルダラベル |
| `■会員管理機能` | `["機能要件", "フォルダ"]` | フォルダラベル |

#### 2.2 関連性の低いページ（除外対象）

| ページタイトル | ラベル | 除外理由 |
|---|---|---|
| `オファー統計データ` | `["帳票"]` | オファー機能の種類とは直接関係なし |
| `オファー送信ログ` | `["ログ"]` | オファー機能の種類とは直接関係なし |
| `【作成中】オファー分析機能` | `["共通要件"]` | オファー機能の種類とは直接関係なし |

## テストケース

### テストケース1: 基本検索テスト

**クエリ:** `オファー機能の種類は？`

**期待される結果:**
- 抽出ページ数: 8-12件
- 上位3件に主要なオファー機能ページが含まれる
- フォルダラベルページが除外される
- 関連性の低いページが除外される

**合格基準:**
- 主要なオファー機能ページ（1.1）のうち5件以上が検索結果に含まれる
- 除外されるべきページ（2.1, 2.2）が検索結果に含まれない
- 上位3件のスコアが70以上

### テストケース2: キーワードマッチングテスト

**クエリ:** `オファー機能の種類は？`

**期待されるキーワード抽出:**
- 基本キーワード: `["オファー", "機能", "種類"]`
- 分割キーワード: `["オファー機能", "オファーの種類", "スカウト", "マッチ"]`
- LLM拡張キーワード: オファー機能に関連する同義語

**理想のキーワード抽出結果:**
```json
{
  "keywords": [
    "オファー機能", "オファー", "スカウト", "マッチ", 
    "パーソナルオファー", "自動オファー", "オファー一覧", 
    "オファー履歴", "オファー種類"
  ],
  "highPriority": ["オファー機能", "オファー", "スカウト", "マッチ"],
  "lowPriority": ["パーソナルオファー", "自動オファー", "オファー一覧", "オファー履歴", "オファー種類"]
}
```

**合格基準:**
- キーワードスコアが0でない
- 分割されたキーワードが正しく抽出される
- タイトルマッチングが正しく動作する
- 理想のキーワード抽出結果に近い結果が得られる
- キーワード数が6個以上
- オファー機能に関連する具体的な機能名が含まれる

### テストケース3: スコアリングテスト

**クエリ:** `オファー機能の種類は？`

**期待されるスコア分布:**
- 主要なオファー機能ページ: 75-90点
- パーソナルオファー管理ページ: 70-80点
- 自動オファー関連ページ: 60-75点
- 通知関連ページ: 55-70点

**合格基準:**
- スコアが期待値の±10点以内
- スコアの順序が期待される優先度と一致

### テストケース4: 機能分類テスト

**クエリ:** `オファー機能の種類は？`

**期待される機能分類:**
1. **スカウト（パーソナルオファー）関連ページ**
   - オファー新規作成機能
   - パーソナルオファー管理機能
   - パーソナルオファー通知

2. **マッチ（自動オファー）関連ページ**
   - 自動オファー設定機能
   - 自動オファー条件設定機能
   - 自動オファー送信バッチ
   - 自動オファー通知

3. **共通機能ページ**
   - オファー一覧閲覧機能
   - オファー履歴
   - スカウト・マッチ利用設定機能

**合格基準:**
- 各機能分類から適切なページが抽出される
- スカウト関連ページが3件以上
- マッチ関連ページが3件以上
- 共通機能ページが2件以上

## 品質メトリクス

### 1. 検索精度（Precision）

```
Precision = 関連するページ数 / 検索結果総数
```

**目標値:** 0.8以上

### 2. 検索再現率（Recall）

```
Recall = 検索結果に含まれる関連ページ数 / 理想の関連ページ総数
```

**目標値:** 0.7以上

### 3. F1スコア

```
F1 = 2 × (Precision × Recall) / (Precision + Recall)
```

**目標値:** 0.75以上

### 4. 平均スコア

```
Average Score = 検索結果のスコア合計 / 検索結果数
```

**目標値:** 70以上

### 5. 機能分類カバレッジ

```
Coverage = 抽出された機能分類数 / 理想の機能分類数
```

**目標値:** 0.8以上（3分類中2.4以上）

## テスト実行手順

### 1. 事前準備

```bash
# 検索システムの起動
npm run dev

# テストデータの確認
npx tsx -e "import { searchLanceDB } from './src/lib/lancedb-search-client'; searchLanceDB({ query: 'オファー機能の種類は？', topK: 20 }).then(r => console.log('Search results:', r.map(x => ({ title: x.title, score: x.score, labels: x.labels }))))"
```

### 2. テスト実行

```bash
# テストスクリプトの実行
npx tsx src/tests/offer-function-search-test.ts
```

### 3. 結果評価

1. 検索結果の確認
2. スコアの検証
3. 除外ページの確認
4. 機能分類の確認
5. メトリクスの計算

## 品質改善の指針

### 1. キーワード抽出の改善

- 分割キーワードの精度向上
- オファー機能関連の同義語拡張
- ストップワードの最適化

### 2. スコアリングの改善

- タイトルマッチングの重み調整
- コンテンツマッチングの精度向上
- ラベルマッチングの最適化

### 3. フィルタリングの改善

- ラベルフィルタリングの精度向上
- 関連性の低いページの除外

### 4. 機能分類の改善

- スカウト・マッチ関連ページの識別精度向上
- 共通機能ページの適切な分類

## 継続的改善

### 1. 定期的なテスト実行

- 週次での品質テスト実行
- 月次でのメトリクス分析

### 2. フィードバックの収集

- ユーザーフィードバックの収集
- 検索結果の品質評価

### 3. アルゴリズムの改善

- テスト結果に基づくパラメータ調整
- 新しい検索手法の導入

## 参考資料

- [NotebookLMの出力結果](./offer-function-notebooklm-output.md)
- [検索チューニング計画](./search-tuning-plan.md)
- [検索チューニング結果](./search-tuning-results.md)
- [教室管理検索品質テスト](./classroom-management-search-quality-test.md)
