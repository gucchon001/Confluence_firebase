# Google Drive統合 仕様書

**最終更新**: 2025年1月  
**バージョン**: 1.0  
**ステータス**: ✅ 実装完了

---

## 1. 概要

### 1.1 目的

社内のGoogle Driveに保存されているマニュアルや内部資料（PDF、Google Docs、Spreadsheet、Slides、テキストファイル、Markdown等）を検索可能なソースとして追加し、Confluenceと同様に自然言語による対話形式で検索・要約・深掘りを可能にする。これにより、情報が分散している課題を解決し、開発者やプロダクトマネージャーの情報検索コストを削減する。

### 1.2 主要機能

- **Google Driveファイルインポート**: サービスアカウントまたはOAuth2トークンを使用してGoogle Driveからファイルを取得
- **多形式ファイル対応**: PDF、Google Docs、Spreadsheet、Slides、テキストファイル、Markdownをサポート
- **共有ドライブ対応**: Google Workspaceの共有ドライブにアクセス可能
- **自動インデックス化**: インポートされたファイルを自動的にLanceDBにインデックス化
- **統合検索**: Confluence、Jiraと同様にハイブリッド検索で検索可能
- **データソース識別**: 検索結果にGoogle Driveソースであることを明示

---

## 2. システムアーキテクチャ

### 2.1 全体構成

```
管理ダッシュボード → Google DriveインポートUI
                            ↓
                    API Routes
                            ↓
            ┌───────────────┴───────────────┐
            ↓                               ↓
    Google Drive API              Firestore
    (ファイル取得・変換)        (メタデータ保存)
            ↓                               ↓
            └───────────────┬───────────────┘
                            ↓
                    LanceDB
                (ベクトル検索)
                            ↓
                    統合検索エンジン
                    (Confluence/Jira/Google Drive)
```

### 2.2 データフロー

1. **インポートフロー**
   - 管理ダッシュボードからファイルIDまたはフォルダIDを指定
   - Google Drive APIでファイル情報と内容を取得
   - ファイル形式に応じてテキストに変換
   - Firestoreにメタデータを保存
   - テキストをチャンク分割（1800文字、200文字オーバーラップ）
   - Gemini Embeddings APIで埋め込みベクトル生成（768次元）
   - LanceDBにベクトルとメタデータを保存

2. **検索フロー**
   - ユーザークエリをGemini Embeddings APIで埋め込みベクトルに変換
   - LanceDBでベクトル検索（Confluence/Jira/Google Drive統合）
   - データソースフィルタリング（必要に応じて）
   - スコアリング統合
   - Gemini APIで回答生成
   - 参照元にGoogle DriveファイルのURLを表示

---

## 3. データスキーマ

### 3.1 Firestoreスキーマ

#### Collection: `google_drive_documents`

```typescript
interface GoogleDriveDocumentRecord {
  fileId: string;                    // Google DriveファイルID
  fileName: string;                  // ファイル名
  mimeType: string;                  // MIMEタイプ
  content: string;                   // ファイル内容（テキスト）
  url: string;                       // Google DriveファイルURL
  lastModified?: string;             // 最終更新日時（ISO文字列）
  size?: number;                     // ファイルサイズ（バイト）
  importedAt: Timestamp;             // インポート日時
  importedBy: string;                // インポート実行ユーザーID
  lastSyncedAt: Timestamp;           // 最終同期日時
  version: number;                   // バージョン番号（更新回数）
}
```

### 3.2 LanceDBスキーマ

```typescript
interface GoogleDriveLanceDBRecord {
  id: string;                        // チャンクID (fileId-chunkIndex)
  file_id: string;                   // Google DriveファイルID
  title: string;                     // ファイル名
  content: string;                   // チャンク内容
  chunkIndex: number;                // チャンク番号
  lastUpdated: string;               // 最終更新日時（ISO文字列）
  url: string;                       // Google DriveファイルURL
  mime_type: string;                 // MIMEタイプ
  vector: number[];                  // 768次元の埋め込みベクトル
  source: 'google_drive';            // データソース識別子
}
```

---

## 4. 認証方式

### 4.1 サービスアカウント認証（推奨）

- **用途**: 共有ドライブへのアクセス、自動化されたインポート
- **設定**: `config/boxwood-dynamo-384411-6dec80faabfc.json`にサービスアカウントキーを配置
- **スコープ**: 
  - `https://www.googleapis.com/auth/drive.readonly`
  - `https://www.googleapis.com/auth/drive`
- **共有ドライブ対応**: `supportsAllDrives: true`, `includeItemsFromAllDrives: true`, `corpora: 'allDrives'`

### 4.2 OAuth2認証（オプション）

- **用途**: 個人のGoogle Driveへのアクセス
- **設定**: ユーザーが手動でアクセストークンを取得・入力
- **スコープ**: 同上

---

## 5. サポートファイル形式

### 5.1 Google Workspace形式

| 形式 | MIMEタイプ | エクスポート形式 | 備考 |
|------|-----------|----------------|------|
| Google Docs | `application/vnd.google-apps.document` | `text/plain` | テキスト形式でエクスポート |
| Google Spreadsheet | `application/vnd.google-apps.spreadsheet` | `text/csv` | CSV形式でエクスポート後、テキストに変換 |
| Google Slides | `application/vnd.google-apps.presentation` | `text/plain` | テキスト形式でエクスポート |

### 5.2 標準ファイル形式

| 形式 | MIMEタイプ | 処理方法 | 備考 |
|------|-----------|---------|------|
| PDF | `application/pdf` | `pdf-parse`ライブラリでテキスト抽出 | バイナリダウンロード後、pdf-parseで処理 |
| テキストファイル | `text/plain` | 直接ダウンロード | UTF-8エンコーディングを想定 |
| Markdown | `text/markdown` | 直接ダウンロード | Markdown形式のまま保存 |

---

## 6. API仕様

### 6.1 ファイルインポートAPI

**エンドポイント**: `POST /api/admin/google-drive/import`

**リクエストボディ**:
```typescript
{
  useServiceAccount?: boolean;      // サービスアカウントを使用するか（デフォルト: true）
  accessToken?: string;              // OAuth2アクセストークン（useServiceAccount=falseの場合）
  serviceAccountPath?: string;       // サービスアカウントキーファイルパス（オプション）
  fileIds?: string[];                // インポートするファイルIDの配列
  folderId?: string;                 // インポートするフォルダID（フォルダ内の全ファイルをインポート）
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  message: string;
  results: Array<{
    fileId: string;
    success: boolean;
    error?: string;
  }>;
  summary: {
    total: number;
    success: number;
    failure: number;
  };
  indexing: {
    indexed: number;                 // LanceDBにインデックス化された件数
    errors: number;                  // インデックス化エラー件数
  };
}
```

### 6.2 ファイル一覧取得API

**エンドポイント**: `GET /api/admin/google-drive/list`

**クエリパラメータ**:
- `useServiceAccount`: `true` | `false`（デフォルト: `true`）
- `accessToken`: OAuth2アクセストークン（useServiceAccount=falseの場合）
- `serviceAccountPath`: サービスアカウントキーファイルパス（オプション）
- `folderId`: フォルダID（指定したフォルダ内のファイルを取得）
- `mimeTypes`: カンマ区切りのMIMEタイプ（フィルタリング用）

**レスポンス**:
```typescript
{
  success: boolean;
  files: Array<{
    id: string;
    name: string;
    mimeType: string;
    webViewLink?: string;
    webContentLink?: string;
    modifiedTime?: string;
    createdTime?: string;
    size?: string;
    parents?: string[];
  }>;
  count: number;
}
```

---

## 7. UI仕様

### 7.1 管理ダッシュボード - データソース管理タブ

**場所**: 管理ダッシュボード > データソース管理タブ

**画面構成**:

```
┌─────────────────────────────────────────────────────────┐
│  Google Driveインポート                                  │
├─────────────────────────────────────────────────────────┤
│  ☑ サービスアカウントを使用（共有ドライブ対応）          │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │ ファイルID（カンマ区切り）                        │  │
│  │ fileId1, fileId2, fileId3                        │  │
│  └──────────────────────────────────────────────────┘  │
│  複数のファイルIDをカンマで区切って入力                  │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │ フォルダID                                        │  │
│  │ folderId                                          │  │
│  └──────────────────────────────────────────────────┘  │
│  フォルダ内のすべてのファイルをインポート                │
│                                                          │
│  [ファイル一覧を取得]  [インポート]                     │
└─────────────────────────────────────────────────────────┘
```

**機能詳細**:

#### 1. 認証方式選択

- **チェックボックス**: 「サービスアカウントを使用（共有ドライブ対応）」
  - ✅ チェック時: サービスアカウントキー（`config/boxwood-dynamo-384411-6dec80faabfc.json`）を使用
  - ❌ 未チェック時: OAuth2アクセストークンを入力欄に入力

#### 2. ファイル指定方法

**方法1: ファイルID指定（複数指定可能）**
- **入力欄**: 「ファイルID（カンマ区切り）」
- **形式**: `fileId1, fileId2, fileId3`
- **特徴**:
  - カンマ区切りで複数のファイルIDを指定可能
  - 空白は自動的にトリムされる
  - 例: `1mAz0-lVQ5F50WUXFl8brrvGI9_h1pXi_nYdjRf0c_Cg, 1-N2D3IP_XM_KZnSoYsYlmC9bbGWWNR6vCiMjjDx6JgE`

**方法2: フォルダID指定（フォルダ内全ファイル）**
- **入力欄**: 「フォルダID」
- **形式**: 単一のフォルダID
- **特徴**:
  - 指定したフォルダ内のすべてのサポート対象ファイルをインポート
  - サブフォルダは再帰的に処理されない（現在の実装）
  - 例: `19dA0N9V5t3zBaJGCxne8BjOmCGMurhAd`

**注意事項**:
- ファイルIDとフォルダIDは同時に指定できない（どちらか一方のみ）
- ファイルIDを指定した場合、フォルダIDは無視される
- フォルダIDを指定した場合、ファイルIDは無視される

#### 3. 操作ボタン

**「ファイル一覧を取得」ボタン**:
- **機能**: 指定したフォルダ内のファイル一覧を取得して表示
- **表示内容**:
  - ファイル名
  - ファイルタイプ（Google Docs、Spreadsheet、Slides、PDF、テキスト、Markdown）
  - ファイルID
  - 「選択」ボタン（クリックでファイルIDを入力欄に設定）
- **制限**: フォルダIDが指定されている場合のみ有効

**「インポート」ボタン**:
- **機能**: 指定したファイルをインポート
- **処理内容**:
  1. Google Drive APIでファイル情報と内容を取得
  2. Firestoreにメタデータを保存
  3. LanceDBにベクトルインデックス化
- **制限**: ファイルIDまたはフォルダIDが指定されている必要がある

#### 4. 結果表示

**インポート結果カード**:
- **サマリー**:
  - 合計件数
  - 成功件数（緑色バッジ）
  - 失敗件数（赤色バッジ、失敗がある場合のみ表示）
- **詳細結果**:
  - 各ファイルのインポート結果（成功/失敗）
  - ファイルID
  - エラーメッセージ（失敗の場合）
- **インデックス化結果**:
  - LanceDBへのインデックス化件数
  - エラー件数（エラーがある場合）

**ファイル一覧カード**:
- 取得したファイルの一覧を表示
- 各ファイルに「選択」ボタンがあり、クリックでファイルIDを入力欄に設定

#### 5. サポートファイル形式表示

以下のファイル形式がサポートされていることを表示:
- 📄 Google Docs
- 📊 Google Spreadsheet
- 📽️ Google Slides
- 📕 PDF
- 📝 テキストファイル (.txt)
- 📝 Markdown (.md)

### 7.2 インポート済みファイルの確認方法

**現在の実装状況**: 📋 実装待ち

**実装予定機能**:
- Firestoreに保存されたインポート済みファイルの一覧表示
- ファイル名、ファイルタイプ、インポート日時、インポートユーザーを表示
- ファイルの削除機能（将来的に実装）
- ファイルの再インポート機能（将来的に実装）

**現在の確認方法**:
- インポート結果画面で確認（インポート直後のみ）
- Firestoreコンソールで直接確認（`google_drive_documents`コレクション）
- スクリプトで確認（`src/scripts/check-firestore.ts`を使用）

---

## 8. エラーハンドリング

### 8.1 認証エラー

- **サービスアカウントキーファイルが見つからない**: エラーメッセージを表示し、ファイルパスを確認
- **無効なアクセストークン**: エラーメッセージを表示し、再認証を促す
- **権限不足**: 共有ドライブへのアクセス権限がない場合、エラーメッセージを表示

### 8.2 ファイル処理エラー

- **サポートされていないファイル形式**: エラーメッセージを表示し、スキップ
- **PDF解析エラー**: pdf-parseライブラリのエラーをキャッチし、エラーメッセージを表示
- **ファイルサイズ制限**: 大きなファイルの場合は警告を表示（将来的に実装）

### 8.3 インデックス化エラー

- **埋め込みベクトル生成エラー**: リトライロジックを実装（将来的に実装）
- **LanceDB保存エラー**: エラーメッセージを表示し、ログに記録

---

## 9. パフォーマンス考慮事項

### 9.1 インポート処理

- **バッチ処理**: 複数ファイルのインポートは順次処理（将来的に並列処理を検討）
- **チャンク分割**: 1800文字、200文字オーバーラップで最適化
- **埋め込み生成**: 各チャンクごとにGemini Embeddings APIを呼び出し

### 9.2 検索処理

- **統合検索**: Confluence/Jira/Google Driveを統合して検索
- **データソースフィルタリング**: 必要に応じてデータソースでフィルタリング可能
- **スコアリング**: データソースに関係なく統合スコアリング

---

## 10. セキュリティ考慮事項

### 10.1 認証情報の管理

- **サービスアカウントキー**: `config/`ディレクトリに配置（`.gitignore`に追加推奨）
- **アクセストークン**: クライアント側で一時的に保持（サーバー側には保存しない）

### 10.2 アクセス制御

- **管理画面アクセス**: 管理者権限が必要
- **APIエンドポイント**: Firebase Authenticationで認証チェック

### 10.3 データプライバシー

- **ファイル内容**: FirestoreとLanceDBに保存（適切なアクセス制御が必要）
- **メタデータ**: インポート実行ユーザー情報を記録

---

## 11. 今後の拡張予定

### 11.1 機能拡張

- [ ] 自動同期機能（定期的にGoogle Driveをチェックして更新を検出）
- [ ] ファイル削除検出（Google Driveで削除されたファイルをLanceDBからも削除）
- [ ] 画像ファイルのOCR対応
- [ ] 動画ファイルの音声文字起こし対応

### 11.2 パフォーマンス改善

- [ ] 並列インポート処理
- [ ] 増分インポート（変更されたファイルのみ再インポート）
- [ ] キャッシュ機能（一度取得したファイル内容をキャッシュ）

### 11.3 UI改善

- [ ] インポート進捗表示（リアルタイム）
- [ ] インポート履歴表示
- [ ] ファイルプレビュー機能

---

## 12. 依存関係

### 12.1 必要なパッケージ

```json
{
  "googleapis": "^144.0.0",
  "google-auth-library": "^10.5.0",
  "pdf-parse": "^1.1.1"
}
```

### 12.2 必要な環境変数

- `GOOGLE_APPLICATION_CREDENTIALS`: サービスアカウントキーファイルパス（オプション）
- `FIREBASE_SERVICE_ACCOUNT_KEY`: Firebase Admin SDK用サービスアカウントキー（JSON文字列）

---

## 13. テスト計画

### 13.1 単体テスト

- [ ] Google Drive API接続テスト
- [ ] ファイル形式変換テスト（各形式）
- [ ] チャンク分割テスト
- [ ] Firestore保存テスト
- [ ] LanceDBインデックス化テスト

### 13.2 統合テスト

- [ ] エンドツーエンドインポートテスト
- [ ] 検索統合テスト（Confluence/Jira/Google Drive）
- [ ] エラーハンドリングテスト

### 13.3 パフォーマンステスト

- [ ] 大量ファイルインポートテスト
- [ ] 検索パフォーマンステスト

---

**関連ドキュメント**:
- [Google Drive統合設計書](../01-architecture/01.02.05-google-drive-integration-design.md)
- [LanceDB-Firestore統合設計書](../01-architecture/01.02.01-lancedb-firestore-integration-design.md)
- [ハイブリッド検索仕様書](../01-architecture/02.01.02-hybrid-search-specification.md)

