# RRF計算でのkeywordとtitle-exactの寄与がundefinedになる理由

**作成日**: 2025年1月  
**最終更新**: 2025年1月  
**ステータス**: 📋 技術説明

---

## 質問

「Confluenceはkeywordとtitle-exactの寄与があるが、Jiraは通常undefined（寄与が0）になる理由は何ですか？」

---

## 回答

### 1. `keyword`順位が`undefined`になる理由

**実装コード** (`src/lib/unified-search-result-processor.ts`):
```typescript
const byKeyword = [...results].sort((a, b) => (b._keywordScore ?? 0) - (a._keywordScore ?? 0));
byKeyword.forEach((r, idx) => kwRank.set(r.id, idx + 1));

// RRF計算時
const kr = kwRank.get(result.id) ?? 1000000;
const keywordContribution = 0.8 * (1 / (kRrf + kr));
```

**理由**:
1. **`_keywordScore`は設定されている**: ベクトル検索結果（995行目）とBM25検索結果（1090行目）の両方で`_keywordScore`が設定される
2. **`byKeyword`は`_keywordScore`でソートされる**: すべての結果が`_keywordScore`でソートされるため、`byKeyword`にはすべての結果が含まれる
3. **`kwRank`には順位が設定される**: `byKeyword`に含まれるすべての結果に対して`kwRank`に順位が設定される

**結論**: `keyword`順位は**通常設定される**（`undefined`ではない）

**実際のテスト結果**:
```
Keyword順位: 1 (寄与: 0.013115)
Keyword順位: 5 (寄与: 0.012308)
Keyword順位: 2 (寄与: 0.012903)
```

---

### 2. `title-exact`順位が`undefined`になる理由

**実装コード** (`src/lib/unified-search-result-processor.ts`):
```typescript
const byTitleExact = results.filter(r => r._sourceType === 'title-exact');
byTitleExact.forEach((r, idx) => titleRank.set(r.id, idx + 1));

// RRF計算時
const tr = titleRank.get(result.id);
const titleContribution = tr ? 1.2 * (1 / (kRrf + tr)) : 0;
```

**理由**:
1. **`_sourceType: 'title-exact'`が設定される条件**:
   - Issue Key完全一致の場合（595行目）
   - タイトル救済検索で見つかった新規結果の場合（828行目）
   - 既存のベクトル検索結果と重複している場合、`_sourceType: 'title-exact'`を設定（841行目）

2. **Jiraで`title-exact`が設定されない場合**:
   - タイトル救済検索が実行されない（タイトル候補が0件の場合）
   - タイトル救済検索で見つかった結果が、既存のベクトル検索結果と重複していない場合でも、`_sourceType: 'title-exact'`が設定される（828行目）
   - しかし、タイトル救済検索で見つかった結果が、既存のベクトル検索結果と重複している場合、`_sourceType: 'title-exact'`が設定される（841行目）

**結論**: `title-exact`順位は**条件によって設定される**（Issue Key完全一致やタイトル救済検索で見つかった場合）

**実際のテスト結果**:
```
Title順位: 1 (寄与: 0.019672)
Title順位: 2 (寄与: 0.019355)
Title順位: 4 (寄与: 0.018750)
```

---

## まとめ

### `keyword`順位について

- **設定される**: `_keywordScore`はすべての結果に設定されるため、`keyword`順位は通常設定される
- **`undefined`になる場合**: ない（すべての結果が`byKeyword`に含まれるため）

### `title-exact`順位について

- **設定される条件**:
  1. Issue Key完全一致の場合
  2. タイトル救済検索で見つかった場合（新規または既存の結果と重複している場合）
- **`undefined`になる場合**:
  1. タイトル救済検索が実行されない場合（タイトル候補が0件）
  2. タイトル救済検索で見つからなかった場合

### 実際の動作

**Jira** (`indeed`クエリ):
- `keyword`順位: ✅ 設定される（例: 1位、2位、5位）
- `title-exact`順位: ✅ 設定される（例: 1位、2位、4位）

**Confluence**:
- `keyword`順位: ✅ 設定される
- `title-exact`順位: ✅ 設定される（タイトル救済検索で見つかった場合）

---

## 補足説明

### ドキュメントとの不一致

**ドキュメント** (`02.04-confluence-jira-comparison.md`):
> Jiraは`keyword`と`title-exact`の順位は通常`undefined`（寄与が0）

**実際の動作**:
- `keyword`順位: 通常設定される（`_keywordScore`はすべての結果に設定されるため）
- `title-exact`順位: 条件によって設定される（タイトル救済検索で見つかった場合）

**修正が必要**:
- ドキュメントの記述を修正する必要がある
- Jiraでも`keyword`順位は通常設定される
- `title-exact`順位は、タイトル救済検索で見つかった場合に設定される

---

## 関連ドキュメント

- [Confluence / Jira 仕様比較](./02.04-confluence-jira-comparison.md)
- [Confluence / Jira 検索実装の違い（詳細版）](./02.05-confluence-jira-search-implementation-differences.md)

---

**最終更新**: 2025年1月  
**作成者**: AI Assistant  
**レビュー**: 未実施

