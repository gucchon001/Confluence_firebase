# Confluence検索システム 仕様書

**最終更新**: 2025年1月  
**バージョン**: 1.0  
**ステータス**: ✅ 本番稼働中

---

## 1. 概要

### 1.1 目的

社内のConfluenceには、多数のプロダクト仕様書が蓄積されているが、情報が分散しており、目的の仕様を探し出すのに時間がかかるという課題がある。本システムは、Atlassian APIを通じてConfluence上の仕様書をAIに学習させ、自然言語による対話形式で仕様の検索・要約・深掘りを可能にすることで、開発者やプロダクトマネージャーの情報検索コストを大幅に削減し、開発効率を向上させることを目的とする。

### 1.2 主要機能

- **自然言語検索**: ユーザーが自然言語で質問を入力し、関連する仕様書を検索
- **AI要約**: 検索結果を基に、AIが要約した回答を生成
- **ストリーミング回答**: リアルタイムで回答を生成・表示
- **会話履歴管理**: 過去の質疑応答の履歴を保存・表示
- **参照元リンク表示**: 回答の生成元となったConfluenceのページURLを明記

---

## 2. システムアーキテクチャ

### 2.1 全体構成

```
ユーザー → Next.js UI → API Routes → ハイブリッド検索エンジン
                                              ↓
                                    ┌─────────┴─────────┐
                                    ↓                   ↓
                              LanceDB              Lunr.js
                            (ベクトル検索)        (BM25検索)
                                    ↓
                              Gemini API
                            (回答生成)
```

### 2.2 データフロー

1. **データ同期フロー**
   - Confluence APIからページデータを取得
   - HTMLからテキストを抽出
   - テキストをチャンク分割（1800文字、オーバーラップなし）
   - Gemini Embeddings API (text-embedding-004) による埋め込みベクトル生成（768次元）
   - LanceDBにベクトルとメタデータを保存

2. **検索フロー**
   - ユーザークエリをGemini Embeddings APIで埋め込みベクトルに変換（768次元）
   - 並列実行による複数検索ソースの組み合わせ：
     - **ベクトル検索**: LanceDBで類似ベクトル検索（意味的類似性）
     - **キーワード検索**: LanceDBのLIKE句によるタイトル・コンテンツ検索
     - **BM25検索**: Lunr.jsによる全文検索（BM25アルゴリズム）
     - **タイトル厳格一致検索**: タイトルがクエリに完全一致する検索
   - 早期ラベルフィルタリング（議事録、アーカイブ等の除外）
   - 動的キーワード抽出（ドメイン知識データベースから関連キーワードを抽出）
   - スコアリング統合（キーワードスコア、ラベルスコア、ハイブリッドスコア）
   - 動的関連性スコアリング（クエリに応じた結果ソート）
   - 重複除去と結果統合
   - Gemini APIで回答生成

3. **ストリーミング回答フロー**
   - ユーザーの質問をAPIエンドポイントに送信
   - ストリーミングレスポンスの開始
   - 段階的なプログレス表示：
     - ステップ1: 関連ドキュメント検索中
     - ステップ2: 検索結果の分析・整理中
     - ステップ3: AI回答生成中
   - リアルタイムでの回答生成と表示
   - マークダウン正規化とテーブル表示の最適化
   - 会話履歴のFirestore保存

---

## 3. データスキーマ

### 3.1 LanceDBスキーマ

```typescript
interface ConfluenceRecord {
  id: string;                    // チャンクID (pageId-chunkIndex)
  vector: number[];              // 768次元の埋め込みベクトル
  page_id: number;               // ConfluenceページID（int64型）
  chunkIndex: number;            // チャンク番号
  space_key: string;             // スペースキー
  title: string;                 // ページタイトル
  content: string;               // チャンク内容
  url: string;                   // ページURL
  lastUpdated: string;           // 最終更新日時（ISO文字列）
  labels: string[];              // ラベル配列（空配列も可）
  isChunked: boolean;            // チャンク分割済みフラグ
  totalChunks: number;           // 総チャンク数
}
```

### 3.2 重要なフィールド

- **page_id**: `number`（int64型）- スカラーインデックス対応
- **lastUpdated**: `string`（ISO 8601形式）
- **labels**: `string[]`配列 - 空配列も可
- **vector**: `number[]`配列 - 768次元（float32）

---

## 4. 検索システム

### 4.1 ハイブリッド検索コンポーネント

1. **ベクトル検索** (5%)
   - Gemini Embedding 768次元
   - コサイン類似度
   - 意味的類似性に基づく検索

2. **BM25検索** (50% - 最優先)
   - Lunr.js + Kuromoji
   - Okapi BM25アルゴリズム
   - 日本語全文検索

3. **タイトル救済検索** (25%)
   - LanceDB LIKE検索
   - 1〜3語組み合わせ
   - 完全一致による高精度検索

4. **ラベルスコア** (15%)
   - カテゴリ、ドメイン、優先度
   - 構造化ラベルによる分類

5. **スコアリング統合**
   - RRF融合（Reciprocal Rank Fusion）
   - Composite Scoring（複合スコアリング）

### 4.2 検索パラメータ

```typescript
interface LanceDBSearchParams {
  query: string;                 // 検索クエリ
  topK: number;                  // 取得件数（デフォルト: 10）
  useLunrIndex?: boolean;        // Lunrインデックス使用フラグ
  labelFilters?: LabelFilterOptions; // ラベルフィルタリング
  tableName?: string;            // テーブル名（デフォルト: 'confluence'）
}
```

### 4.3 ラベルフィルタリング

**常に除外されるラベル**:
- `スコープ外`: 検索対象外のドキュメント
- `メールテンプレート`: メール関連のテンプレート

**条件付き除外ラベル**:
- `議事録`, `meeting-notes`: `includeMeetingNotes`がfalseの場合
- `アーカイブ`, `archived`: `includeArchived`がfalseの場合

---

## 5. API仕様

### 5.1 検索API

**エンドポイント**: `POST /api/search`

**リクエスト**:
```json
{
  "query": "ログイン機能の詳細",
  "topK": 10,
  "source": "confluence",
  "useHybridSearch": true
}
```

**レスポンス**:
```json
{
  "results": [
    {
      "pageId": "123456789",
      "title": "ログイン機能仕様",
      "content": "...",
      "url": "https://confluence.example.com/pages/viewpage.action?pageId=123456789",
      "score": 0.95,
      "scoreText": "Hybrid 0.95",
      "labels": ["機能要件", "画面仕様"]
    }
  ],
  "searchTime": 1234
}
```

### 5.2 ストリーミングAPI

**エンドポイント**: `POST /api/streaming-process`

**リクエスト**: 検索APIと同じ

**レスポンス**: Server-Sent Events (SSE)形式でストリーミング

---

## 6. UI/UX仕様

### 6.1 チャットインターフェース

- **入力フィールド**: 自然言語で質問を入力
- **送信ボタン**: 質問を送信
- **ストリーミング表示**: リアルタイムで回答を表示
- **プログレス表示**: 検索・分析・生成の各ステップを表示
- **マークダウン表示**: 見出し、箇条書き、テーブル、コードブロックなどの適切な表示

### 6.2 検索結果表示

- **タイトル**: ページタイトル
- **コンテンツ**: 関連するチャンクの内容
- **参照元リンク**: Confluenceページへのリンク
- **スコア**: 検索スコア（デバッグ用）
- **ラベル**: 関連ラベル

### 6.3 会話履歴

- **履歴一覧**: 過去の質疑応答を一覧表示
- **履歴選択**: 特定の会話を選択して再表示
- **コンテキスト維持**: 会話の文脈を維持したまま追加質問が可能

---

## 7. 認証・セキュリティ

### 7.1 認証方式

- **Firebase Authentication**: Googleアカウントでログイン
- **ドメイン制限**: `@tomonokai-corp.com` ドメインのユーザーのみアクセス可能

### 7.2 セキュリティ対策

- Firestoreセキュリティルールによる適切なアクセス制御
- Atlassian APIキーなどの機密情報は環境変数で管理
- HTTPS通信の強制

---

## 8. パフォーマンス

### 8.1 検索性能

- **平均検索時間**: 7-23ms
- **ベクトル次元**: 768次元
- **メモリ使用量**: 100回検索で約0.5MB増加
- **対応ページ数**: 最大10,000ページ

### 8.2 最適化ポイント

1. **インデックス作成**: 頻繁に検索されるフィールドにインデックス
2. **ラベルフィルタリング**: 早期除外による処理速度向上
3. **並列処理**: 複数検索タイプの並列実行
4. **キャッシュ**: 頻繁に使用されるクエリの結果キャッシュ

---

## 9. 運用・メンテナンス

### 9.1 データ同期

```bash
# 全データ同期
npm run sync:confluence:batch

# 差分同期
npm run sync:confluence:differential
```

### 9.2 インデックス初期化

```bash
# Lunrインデックスの初期化
npm run init:confluence-lunr
```

### 9.3 監視・ログ

- Cloud Loggingによるログ監視
- パフォーマンスメトリクスの記録
- エラー通知の設定

---

## 10. 技術スタック

### 10.1 フロントエンド

- **フレームワーク**: Next.js 15.3.3 (React 18.3.1)
- **言語**: TypeScript 5.9.2
- **スタイリング**: Tailwind CSS 3.4.1
- **UIコンポーネント**: Radix UI

### 10.2 バックエンド

- **API**: Next.js API Routes
- **スクリプト**: Node.js Scripts (tsx)
- **言語**: TypeScript

### 10.3 AI・機械学習

- **LLM**: Google AI - Gemini API (gemini-2.5-flash)
- **埋め込みモデル**: Gemini Embeddings API (text-embedding-004, 768次元)
- **AIフレームワーク**: Genkit 1.19.2（部分統合）

### 10.4 データベース・ストレージ

- **認証**: Firebase Authentication 11.9.1
- **NoSQL**: Firestore (会話履歴・ユーザーデータ)
- **ベクトルDB**: LanceDB 0.22.0 (ローカルベクトルDB)
- **検索エンジン**: Lunr.js 2.3.9 (BM25検索)

### 10.5 外部API・サービス

- **Atlassian API**: Confluence REST API
- **Google AI API**: Gemini API
- **Firebase Services**: Authentication, Firestore, Hosting

---

## 11. 関連ドキュメント

- [LanceDB統合ガイド](../01-architecture/01.02.04-lancedb-integration-guide.md)
- [ハイブリッド検索システム仕様](../01-architecture/02.01.02-hybrid-search-specification.md)
- [データ同期戦略](../04-operations/04.03-data-synchronization-strategy.md)

