# Jira 変更履歴の検索統合仕様

**作成日**: 2025-01-27  
**最終更新**: 2025-01-27  
**ステータス**: ✅ 仕様確定

---

## 📋 概要

Jiraの変更履歴（changelog）をどのように保存し、ハイブリッド検索・ランキングに組み込むかの仕様を定義します。

---

## 🎯 設計方針

### 基本原則

1. **データの保存**: Firestore + LanceDBの2段階保存
2. **検索への組み込み**: contentフィールドを通じて自動的に検索対象とする
3. **時系列順の保持**: 変更履歴は時系列順（古い順）で保存・検索
4. **検索精度の向上**: 変更履歴を含めることで、経緯の追跡を可能にする

---

## 💾 データ保存仕様

### 1. Firestoreへの保存

**保存場所**: `jiraIssues/{issueKey}/changelog`

**データ構造**:
```typescript
interface ChangelogItem {
  id: string;        // 変更履歴ID
  field: string;     // フィールド名（日本語）
  from: string;      // 変更前の値
  to: string;        // 変更後の値
  changedAt: string; // 変更日時（ISO文字列）
  changedBy: string; // 変更者名
}
```

**保存形式**:
```typescript
{
  changelog: ChangelogItem[]  // 時系列順（古い順）の配列
}
```

**用途**:
- 検索結果の詳細表示で使用
- 管理画面での変更履歴表示
- 将来的な変更履歴専用検索への対応

**実装状況**: ✅ 実装済み

---

### 2. LanceDBへの保存

**保存場所**: `jira_issues`テーブルの`content`フィールド

**データ構造**:
```
メタデータ
説明
コメント履歴
変更履歴:
変更1:
変更日時: 2025-01-15T10:00:00Z
変更者: 池田広大
フィールド: ステータス
変更前: TO DO
変更後: In Progress

変更2:
変更日時: 2025-01-16T14:30:00Z
変更者: 山田太郎
フィールド: 担当者
変更前: (unassigned)
変更後: 池田広大
```

**保存順序**:
1. メタデータ（ステータス、優先度、担当者など）
2. 説明（description）
3. コメント履歴（時系列順：古い順）
4. **変更履歴（時系列順：古い順）** ← 新規追加

**実装状況**: ✅ 実装済み

---

## 🔍 ハイブリッド検索への組み込み

### 現在の検索方式

Jiraの検索では、以下の2種類の検索を実行：

1. **ベクトル検索**
   - LanceDBの`content`フィールドをベクトル化
   - 変更履歴は`content`フィールドに含まれるため、**自動的に検索対象**

2. **BM25検索**
   - Lunr.jsインデックスで`content`フィールドを検索
   - 変更履歴は`content`フィールドに含まれるため、**自動的に検索対象**

### 検索対象への組み込み方針

#### オプション1: 現在の実装（contentフィールドに含める）✅ 採用

**方法**: 
- 変更履歴を`content`フィールドにテキスト統合
- ベクトル検索とBM25検索で自動的に検索対象となる

**メリット**:
- ✅ 実装がシンプル
- ✅ 変更履歴が検索対象に自動的に含まれる
- ✅ 経緯の追跡が可能
- ✅ 追加の実装が不要

**デメリット**:
- ⚠️ `content`フィールドが長くなる可能性
- ⚠️ 変更履歴のみを対象とした検索はできない

**実装状況**: ✅ 実装済み

---

#### オプション2: 変更履歴専用の検索インデックス（将来の拡張案）

**方法**:
- 変更履歴を個別のチャンクとしてLanceDBに保存
- 変更履歴専用のベクトル検索を実装

**メリット**:
- ✅ 変更履歴のみを対象とした検索が可能
- ✅ より細かい検索制御が可能

**デメリット**:
- ❌ 実装が複雑
- ❌ ストレージコストが増加
- ❌ 検索結果の重複が発生する可能性

**実装状況**: ❌ 未実装（将来の拡張案）

---

### 推奨アプローチ

**オプション1を採用**（現在の実装）

**理由**:
1. 実装がシンプルで保守性が高い
2. 変更履歴が自動的に検索対象となり、経緯の追跡が可能
3. 追加の実装が不要で、即座に利用可能
4. 「経緯は時系列で整理する必要がありますよね」という要件を満たす

---

## 📊 ランキングへの影響

### 現在のランキング方式

Jiraの検索結果は以下の複合スコアでランキングされる：

```
最終スコア = 
  BM25スコア      × 53% +
  タイトルマッチ  × 26% +
  ラベルスコア    × 16% +
  ベクトルスコア  × 5%
```

### 変更履歴のランキングへの影響

#### 1. ベクトル検索への影響

**影響方法**:
- 変更履歴は`content`フィールドに含まれる
- `content`フィールド全体でベクトル化される
- クエリとの意味的類似性に基づいてスコアが計算される

**例**:
- クエリ: "ステータスが完了になった課題"
- 変更履歴に「ステータス: TO DO → 完了」が含まれる場合、ベクトル検索で高いスコア

**実装状況**: ✅ 自動的に組み込まれている

---

#### 2. BM25検索への影響

**影響方法**:
- 変更履歴は`content`フィールドに含まれる
- Lunr.jsインデックスで`content`フィールドが検索対象
- キーワードマッチに基づいてスコアが計算される

**例**:
- クエリ: "ステータス 完了"
- 変更履歴に「フィールド: ステータス」「変更後: 完了」が含まれる場合、BM25検索でマッチ

**実装状況**: ✅ 自動的に組み込まれている

---

#### 3. ランキングへの直接的な影響

**現在の実装**:
- 変更履歴は`content`フィールドを通じて間接的にランキングに影響
- 変更履歴専用のスコアリングは実装されていない

**将来の拡張案**:
- 変更履歴の重要度に基づいたスコアブースト
- ステータス変更履歴のみを対象としたブースト
- 最近の変更履歴に対する時間減衰関数の適用

**実装状況**: ❌ 直接的なスコアリングは未実装（将来的な拡張案）

---

## 🎨 UI表示仕様

### 検索結果での表示

**現在の実装**:
- 検索結果に変更履歴は表示されていない
- 検索結果はタイトル、説明、ステータスなどの基本情報のみ表示

**将来の拡張案**:
- 検索結果に変更履歴のサマリーを表示
- 「ステータス変更: TO DO → 完了 (2025-01-15)」などの形式
- 変更履歴の詳細は詳細画面で表示

**実装状況**: ❌ 未実装（将来の拡張案）

---

### 詳細画面での表示

**現在の実装**:
- 管理画面の詳細表示で変更履歴を取得可能
- APIエンドポイント: `/api/admin/jira-dashboard/issue/[issueKey]`
- Firestoreから`changelog`フィールドを取得して表示可能

**表示形式案**:
```
変更履歴:
1. 2025-01-15 10:00 池田広大
   ステータス: TO DO → In Progress

2. 2025-01-16 14:30 山田太郎
   担当者: (unassigned) → 池田広大
```

**実装状況**: ⚠️ APIは実装済み、UI表示は要実装

---

## 📈 検索精度への影響

### 期待される効果

1. **経緯の追跡**:
   - 「ステータスが完了になった課題」などのクエリで、変更履歴が検索対象となる
   - 経緯を質問された場合に適切な回答が生成される

2. **検索精度の向上**:
   - 変更履歴に含まれる情報が検索対象となる
   - より詳細な情報を検索可能

3. **時系列の理解**:
   - 変更履歴を時系列順で保存することで、経緯を時系列で理解可能

### 注意事項

1. **contentフィールドの長さ** ⚠️ 重要な課題:
   - 変更履歴を追加したことで、`content`フィールドがさらに長くなる
   - コメントが多いIssue + 変更履歴が多いIssue = 非常に長い`content`フィールド
   - ベクトル化の品質が低下する可能性
   - **対策**: 長いIssueのチャンク処理を優先的に実装する必要がある（優先度: 高）

2. **検索ノイズ**:
   - すべての変更履歴が検索対象となるため、ノイズが増える可能性
   - ただし、BM25検索とベクトル検索で関連性の高い結果が優先される

3. **チャンク処理の必要性**:
   - Confluenceは1800文字でチャンク分割しているが、Jiraは現在Issue単位
   - 変更履歴を追加したことで、チャンク処理の必要性が高まった

---

## 🔄 実装フロー

### データ取得から検索までのフロー

```
1. Jira APIから変更履歴を取得
   ↓
   /rest/api/3/issue/{issueKey}/changelog
   ↓
2. データ正規化
   ↓
   ChangelogItem[] に変換（時系列順：古い順）
   ↓
3. Firestoreに保存
   ↓
   jiraIssues/{issueKey}/changelog: ChangelogItem[]
   ↓
4. LanceDB用テキスト構築
   ↓
   contentフィールドに変更履歴をテキスト統合
   ↓
5. ベクトル生成
   ↓
   contentフィールド全体でベクトル化
   ↓
6. LanceDBに保存
   ↓
   jira_issuesテーブルのcontentフィールドとvectorフィールド
   ↓
7. 検索時に自動的に検索対象となる
   ↓
   ベクトル検索: contentフィールドが対象
   BM25検索: contentフィールドが対象
```

---

## 📝 仕様まとめ

### 保存方法

| 保存先 | 形式 | 順序 | 実装状況 |
|--------|------|------|---------|
| **Firestore** | 配列（`changelog`フィールド） | 時系列順（古い順） | ✅ 実装済み |
| **LanceDB** | テキスト統合（`content`フィールド） | 時系列順（古い順） | ✅ 実装済み |

### 検索への組み込み

| 検索方式 | 検索対象 | 影響方法 | 実装状況 |
|---------|---------|---------|---------|
| **ベクトル検索** | `content`フィールド | 自動的に検索対象 | ✅ 実装済み |
| **BM25検索** | `content`フィールド | 自動的に検索対象 | ✅ 実装済み |

### ランキングへの影響

| 影響方法 | 実装状況 | 備考 |
|---------|---------|------|
| **間接的影響**（`content`フィールド経由） | ✅ 実装済み | ベクトル検索とBM25検索で自動的に組み込まれる |
| **直接的なスコアリング** | ❌ 未実装 | 将来の拡張案 |

### UI表示

| 表示場所 | 実装状況 | 備考 |
|---------|---------|------|
| **検索結果** | ✅ 表示しない（仕様確定） | 基本情報のみ表示 |
| **詳細画面（API）** | ✅ 実装済み | Firestoreから取得可能 |
| **詳細画面（UI）** | ⚠️ 要実装 | APIは実装済み、優先度: 高 |

---

## 🚀 今後の実装予定

### 優先度: 高

1. **長いIssueのチャンク処理** ⚠️ 重要
   - **背景**: 変更履歴を追加したことで、`content`フィールドがさらに長くなる可能性
   - **課題**: 
     - コメントが多いIssue + 変更履歴が多いIssue = 非常に長い`content`フィールド
     - ベクトル化の品質が低下する可能性
     - 検索精度に影響する可能性
   - **詳細仕様**: `docs/02-specifications/02.11-jira-chunking-specification.md`を参照
   - **実装方法**:
     - 閾値: `content`フィールドが3000文字以上
     - チャンクサイズ: 1800文字、200文字オーバーラップ（Confluenceと同様）
     - Issue全体をチャンク分割（セマンティックチャンキングは将来の拡張案）
     - 階層的構造を保持（`issue_key` + `chunkIndex`）
   - **参考**: Confluenceのチャンキング実装（`src/lib/confluence-sync-service.ts`の`splitPageIntoChunks`メソッド）
   - **実装時期**: 変更履歴実装後、次回の同期前に実装推奨

2. **詳細画面での変更履歴表示**
   - 管理画面の詳細表示で変更履歴を表示
   - 時系列順で見やすく表示

### 優先度: 中

3. **検索結果での変更履歴サマリー表示**
   - 検索結果に変更履歴のサマリーを表示
   - 「ステータス変更: TO DO → 完了」などの形式

4. **変更履歴フィルタリング**
   - 重要な変更のみを検索対象とする
   - 例: ステータス変更、担当者変更のみ

### 優先度: 低

5. **変更履歴専用の検索インデックス**
   - 変更履歴を個別のチャンクとして保存
   - 変更履歴のみを対象とした検索

6. **変更履歴のスコアブースト**
   - ステータス変更履歴に対するブースト
   - 最近の変更履歴に対する時間減衰関数

---

## 🔗 関連ドキュメント

- `docs/02-specifications/02.09-jira-comments-and-history-implementation-details.md`: コメントと履歴の実装詳細
- `docs/01-architecture/02.01.01-hybrid-search-quick-reference.md`: ハイブリッド検索クイックリファレンス
- `docs/02-specifications/02.03-jira-spec.md`: Jira検索システム仕様書
- `src/lib/jira-sync-service.ts`: 変更履歴取得と保存の実装

---

---

## ❓ 決定が必要な事項

### 1. Firestoreへの保存 ✅ 決定済み

**決定**: Firestoreに`changelog`フィールドとして配列形式で保存する

**理由**: 
- 検索結果の詳細表示で使用するため
- 管理画面での変更履歴表示に必要
- 構造化データとして扱いやすい

**実装状況**: ✅ 実装済み

---

### 2. ハイブリッド検索への組み込み ✅ 決定済み

**決定**: `content`フィールドにテキスト統合することで、自動的に検索対象とする

**理由**:
- 実装がシンプルで保守性が高い
- 変更履歴が自動的に検索対象となり、経緯の追跡が可能
- 追加の実装が不要で、即座に利用可能
- 「経緯は時系列で整理する必要がありますよね」という要件を満たす

**実装状況**: ✅ 実装済み

---

### 3. ランキングへの直接的な影響 ✅ 決定済み

**決定**: オプションA - 現在の実装のまま（間接的な影響のみ）

**方法**: 
- 変更履歴は`content`フィールドを通じて間接的にランキングに影響
- 変更履歴専用のスコアリングは実装しない

**理由**:
1. ✅ 実装がシンプルで保守性が高い
2. ✅ 既存の検索ロジックを変更しない
3. ✅ 追加のパラメータ調整が不要
4. ✅ 現在の実装で十分に検索精度が向上している

**実装状況**: ✅ 現在の実装（変更不要）

---

### 4. UI表示 ✅ 決定済み

**決定**: オプションA - 検索結果には表示しない（基本情報のみ）

**方法**: 
- 検索結果はタイトル、説明、ステータスなどの基本情報のみ表示
- 変更履歴は詳細画面で表示

**理由**:
1. ✅ 検索結果がシンプルで見やすい
2. ✅ 情報過多を避けられる
3. ✅ パフォーマンスが良い
4. ✅ 詳細情報は詳細画面で確認する設計が適切

---

#### 詳細画面での表示 ✅ 決定済み

**決定**: 詳細画面で変更履歴を時系列順で表示する

**表示形式**:
```
変更履歴:
1. 2025-01-15 10:00 池田広大
   ステータス: TO DO → In Progress

2. 2025-01-16 14:30 山田太郎
   担当者: (unassigned) → 池田広大
```

**実装状況**: ⚠️ APIは実装済み、UI表示は要実装

---

## 🎯 仕様決定サマリー

### 決定済み事項

1. ✅ **Firestoreへの保存**: 配列形式で保存（実装済み）
2. ✅ **LanceDBへの保存**: `content`フィールドにテキスト統合（実装済み）
3. ✅ **検索への組み込み**: `content`フィールド経由で自動的に検索対象（実装済み）
4. ✅ **ランキングへの影響**: 現在の実装のまま（間接的な影響のみ）
5. ✅ **検索結果での表示**: 表示しない（基本情報のみ）
6. ⚠️ **詳細画面UI実装**: 優先度: 高（API実装済み、UI要実装）

### 実装完了事項

- ✅ 変更履歴の取得
- ✅ Firestoreへの保存
- ✅ LanceDBへの保存（contentフィールドに統合）
- ✅ ベクトル検索への自動組み込み
- ✅ BM25検索への自動組み込み

### 今後実装予定（優先順位順）

1. ⚠️ **長いIssueのチャンク処理**（優先度: 高）
   - 変更履歴を追加したことで、`content`フィールドが長くなる課題に対応
   - 閾値: `content`フィールドが3000文字以上、またはコメント+変更履歴が一定数以上
   - チャンクサイズ: 1800文字、200文字オーバーラップ（Confluenceと同様）
   
2. ⚠️ **詳細画面での変更履歴表示**（優先度: 高）
   - APIは実装済み、UI実装が必要

---

**最終更新日**: 2025-01-27  
**仕様確定日**: 2025-01-27  
**重要な注意**: 変更履歴を追加したことで、長いIssueのチャンク処理がより重要になりました。次回の同期前に実装を推奨します。  
**次回レビュー**: チャンク処理実装時

