# BigQuery対話型DWH 仕様書

**最終更新**: 2025年1月  
**バージョン**: 1.0  
**ステータス**: 📋 仕様策定中

---

## 1. 概要

### 1.1 目的

BigQueryに格納されているローテーブル（求人データ等）に対して、自然言語による対話形式でデータ取得・分析を可能にする。ユーザーがSQLを書かずに、チャット形式で「東京の求人を教えて」などの質問をすることで、AIが自動的にSQLクエリを生成・実行し、結果を分かりやすい形式で返すことを目的とする。

### 1.2 主要機能

- **自然言語クエリ**: ユーザーが自然言語で質問を入力し、BigQueryからデータを取得
- **自動SQL生成**: AIがユーザーの意図を理解し、適切なSQLクエリを自動生成
- **スキーマ理解**: BigQueryテーブルのスキーマとメタデータ（データカタログ）を活用して精度の高いSQLを生成
- **結果の可視化**: クエリ結果を表形式やグラフ形式で表示（将来拡張）
- **会話履歴管理**: 過去の質問と結果を保存・参照可能
- **エラーハンドリング**: SQL実行エラー時の適切なフィードバックと修正提案

### 1.3 参考資料

- [自動化のその先へ。BigQueryが切り拓く「自律型データウェアハウス」の未来](https://share.google/wIVrZ6z9QEciLV0rS)
- BigQuery Conversational Analytics
- Google Cloud Data Catalog

---

## 2. システムアーキテクチャ

### 2.1 全体構成

```
ユーザー → Next.js UI (チャット) → API Routes → BigQuery Flow
                                                      ↓
                                            ┌────────┴────────┐
                                            ↓                 ↓
                                    Gemini API          BigQuery Client
                                  (SQL生成)            (クエリ実行)
                                            ↓
                                    BigQuery
                                  (ローテーブル)
                                            ↓
                                    結果整形・返却
```

### 2.2 データフロー

1. **スキーマ取得フロー**
   - BigQuery APIからテーブルスキーマを取得
   - データカタログ（テーブル・列の説明）を取得
   - スキーマ情報をAIに提供してSQL生成の精度を向上

2. **クエリ生成・実行フロー**
   - ユーザーの自然言語質問を受信
   - テーブルスキーマとメタデータをコンテキストとして提供
   - Gemini APIでSQLクエリを生成
   - 生成されたSQLを検証（構文チェック、セキュリティチェック）
   - BigQueryでクエリを実行
   - 結果を整形してユーザーに返却

3. **エラーハンドリングフロー**
   - SQL実行エラーが発生した場合、エラーメッセージを分析
   - エラー原因を特定（列名の誤り、型の不一致等）
   - 修正されたSQLを再生成・再実行
   - 最大3回までリトライ

---

## 3. データスキーマ

### 3.1 BigQuery接続設定

```typescript
interface BigQueryConfig {
  projectId: string;              // プロジェクトID（例: "bigquery-jukust"）
  datasetId: string;              // データセットID（例: "job_listings"）
  credentialsPath?: string;       // 認証情報ファイルパス（オプション）
  location?: string;              // リージョン（例: "asia-northeast1"）
}
```

### 3.2 テーブルスキーマ例（求人データ）

```typescript
interface JobListingTable {
  // 基本情報
  job_id: string;                 // 求人ID
  title: string;                  // 求人タイトル
  company_name: string;           // 会社名
  
  // 勤務地情報（フラット化推奨）
  location_prefecture: string;    // 都道府県（例: "東京都"）
  location_city: string;          // 市区町村（例: "港区"）
  
  // 給与情報
  salary_min: number;             // 最低給与（万円）
  salary_max: number;             // 最高給与（万円）
  salary_type: string;            // 給与タイプ（例: "月給", "年収"）
  
  // ステータス（文字列化推奨）
  publication_status: string;     // 掲載ステータス（"掲載", "非掲載"）
  
  // 日付情報
  posting_date: timestamp;        // 掲載開始日
  expiration_date: timestamp;     // 掲載終了日
  created_at: timestamp;          // 作成日時
  updated_at: timestamp;          // 更新日時
}
```

### 3.3 データカタログ（メタデータ）

**テーブル説明**:
```
現在と過去の全求人情報が格納されている生データテーブル。
求人の掲載・非掲載状態、勤務地、給与情報などを含む。
```

**列説明例**:
- `publication_status`: 求人の掲載ステータス。0は「掲載」、1は「非掲載」を意味する。
- `location_prefecture`: 勤務地の都道府県名（例: "東京都", "大阪府"）
- `salary_min`: 最低給与（単位: 万円、月給の場合）
- `posting_date`: 求人の掲載開始日時

---

## 4. 機能仕様

### 4.1 自然言語クエリ処理

#### 4.1.1 対応する質問例

- **基本的な検索**: 「東京の求人を教えて」
- **条件付き検索**: 「給与が500万円以上の求人を探して」
- **集計クエリ**: 「都道府県別の求人数を教えて」
- **時系列分析**: 「先月の新規求人数は？」
- **複合条件**: 「東京で給与500万円以上、掲載中の求人を探して」

#### 4.1.2 SQL生成プロンプト

```typescript
const SQL_GENERATION_PROMPT = `
あなたはBigQueryのSQL生成アシスタントです。
以下のテーブルスキーマとメタデータを参考に、ユーザーの質問に応じたSQLクエリを生成してください。

【テーブル情報】
テーブル名: {{tableName}}
データセット: {{datasetId}}
プロジェクト: {{projectId}}

【スキーマ】
{{schemaDescription}}

【列の説明】
{{columnDescriptions}}

【ユーザーの質問】
{{userQuestion}}

【重要なルール】
1. SELECT文のみを生成（INSERT/UPDATE/DELETEは禁止）
2. 列名は正確に使用すること（大文字小文字を区別）
3. 数値コード（0, 1等）は、メタデータの説明に基づいて適切に解釈すること
4. 日付の比較は適切な関数を使用すること（CURRENT_DATE(), DATE()等）
5. 結果は最大1000件に制限すること（LIMIT 1000）
6. 生成するSQLのみを出力し、説明文は不要

【出力形式】
SQLクエリのみを出力してください。
`;
```

### 4.2 SQL検証

#### 4.2.1 構文チェック

- BigQueryのSQL構文に準拠しているか
- 存在するテーブル・列を参照しているか
- 予約語の誤用がないか

#### 4.2.2 セキュリティチェック

- SELECT文のみを許可（INSERT/UPDATE/DELETE/DROP等は拒否）
- データセット・プロジェクトのスコープを制限
- 危険な関数（`EXECUTE_IMMEDIATE`等）の使用を禁止

### 4.3 エラーハンドリング

#### 4.3.1 エラー分類

1. **スキーマエラー**: 存在しない列名、テーブル名
2. **型エラー**: 型の不一致（文字列と数値の比較等）
3. **構文エラー**: SQL構文の誤り
4. **権限エラー**: テーブルへのアクセス権限がない
5. **タイムアウトエラー**: クエリ実行時間が制限を超えた

#### 4.3.2 エラー回復戦略

1. エラーメッセージを解析
2. エラー原因を特定
3. 修正されたSQLを再生成
4. 最大3回までリトライ
5. 3回失敗した場合は、エラーメッセージと共にユーザーに通知

### 4.4 結果整形

#### 4.4.1 データフォーマット

- **表形式**: 小規模な結果（100件以下）は表形式で表示
- **集計結果**: COUNT、SUM等の集計結果は数値とグラフで表示（将来拡張）
- **時系列データ**: 日付を含む結果は時系列グラフで表示（将来拡張）

#### 4.4.2 レスポンス形式

```typescript
interface BigQueryResponse {
  success: boolean;
  sql: string;                    // 実行されたSQLクエリ
  data?: any[];                   // クエリ結果
  error?: {
    message: string;
    code: string;
    retryCount: number;
  };
  metadata: {
    rowCount: number;
    executionTime: number;        // 実行時間（ミリ秒）
    bytesProcessed: number;       // 処理されたバイト数
  };
}
```

---

## 5. UI/UX仕様

### 5.1 チャットインターフェース

- 既存のチャットUI（`src/components/chat-page.tsx`）を拡張
- データソース選択に「BigQuery」を追加
- BigQuery選択時は、自然言語での質問を促すUIを表示

### 5.2 データソース切替

```typescript
type DataSource = 'confluence' | 'jira' | 'bigquery' | 'mixed';
```

- チャット画面でデータソースを選択可能
- BigQuery選択時は、利用可能なテーブル一覧を表示（将来拡張）

### 5.3 結果表示

- **表形式**: クエリ結果を表形式で表示
- **SQL表示**: 実行されたSQLクエリを折りたたみ可能な形式で表示
- **メタデータ表示**: 実行時間、処理バイト数、件数等を表示

---

## 6. 実装要件

### 6.1 技術スタック

- **BigQuery Client**: `@google-cloud/bigquery`
- **AI生成**: Gemini API（既存のGenkitフローを活用）
- **認証**: Service Account（`config/bigquery-jukust-0f1ac3a2ac72.json`）

### 6.2 必要な実装

1. **BigQuery接続ユーティリティ** (`src/lib/bigquery-client.ts`)
   - BigQueryクライアントの初期化
   - テーブルスキーマ取得
   - クエリ実行

2. **SQL生成AIフロー** (`src/ai/flows/bigquery-sql-generation.ts`)
   - 自然言語からSQL生成
   - スキーマ情報の活用
   - エラーハンドリング

3. **APIエンドポイント** (`src/app/api/chat/bigquery/route.ts`)
   - チャットリクエストの受信
   - SQL生成・実行
   - 結果の返却

4. **UI拡張** (`src/components/chat-page.tsx`)
   - BigQueryデータソースの追加
   - 結果表示の拡張

### 6.3 データ準備要件

#### 6.3.1 テーブル構造の最適化

- **フラット化**: JSON形式のデータは可能な限りフラットな列に展開
  - ❌ 悪い例: `job_details`列にJSONデータを格納
  - ✅ 良い例: `location_prefecture`, `location_city`等の列に展開

- **文字列化**: 数値コードは意味のある文字列に変換
  - ❌ 悪い例: `publication_status`列に`0`や`1`が入っている
  - ✅ 良い例: `publication_status`列に`"掲載"`や`"非掲載"`が入っている
  - または、ビューを作成して変換: `CASE publication_status WHEN 0 THEN '掲載' WHEN 1 THEN '非掲載' END`

#### 6.3.2 データカタログの整備

- **テーブル説明**: 各テーブルの目的と内容を説明
- **列説明**: 各列の意味、単位、コード値の意味を説明
- **実装方法**: BigQueryコンソールまたはSQL（`ALTER TABLE ... ALTER COLUMN ... SET OPTIONS(description=...)`）

---

## 7. セキュリティ

### 7.1 アクセス制御

- Service Accountに最小限の権限を付与
- 読み取り専用の権限（`roles/bigquery.dataViewer`, `roles/bigquery.jobUser`）
- 特定のデータセット・テーブルのみにアクセス可能にする

### 7.2 SQLインジェクション対策

- SELECT文のみを許可
- 危険な関数の使用を禁止
- データセット・プロジェクトのスコープを制限
- 生成されたSQLを検証してから実行

### 7.3 コスト管理

- クエリ実行時間の制限（例: 30秒）
- 処理バイト数の制限（例: 1GB）
- 結果件数の制限（例: 1000件）
- クエリ実行履歴の記録（将来拡張）

---

## 8. パフォーマンス

### 8.1 クエリ最適化

- 不要な列の選択を避ける（`SELECT *`の使用を制限）
- 適切なWHERE句の使用を推奨
- インデックスの活用（BigQueryの自動最適化に依存）

### 8.2 キャッシュ

- スキーマ情報のキャッシュ（1時間）
- よく使われるクエリの結果キャッシュ（将来拡張）

### 8.3 タイムアウト

- SQL生成: 10秒
- クエリ実行: 30秒
- 全体のタイムアウト: 60秒

---

## 9. エラーハンドリング

### 9.1 エラー分類と対応

| エラー種別 | 原因 | 対応 |
|----------|------|------|
| スキーマエラー | 存在しない列名・テーブル名 | SQL再生成（列名の修正提案） |
| 型エラー | 型の不一致 | SQL再生成（型変換の追加） |
| 構文エラー | SQL構文の誤り | SQL再生成（構文の修正） |
| 権限エラー | アクセス権限がない | エラーメッセージを表示 |
| タイムアウト | クエリ実行時間超過 | エラーメッセージとクエリ最適化の提案 |

### 9.2 ユーザーフィードバック

- エラー発生時は、分かりやすい日本語のメッセージを表示
- 可能な場合は、修正提案を表示
- エラー詳細は開発者向けログに記録

---

## 10. 将来拡張

### 10.1 機能拡張

- **可視化**: クエリ結果のグラフ表示（Recharts等を使用）
- **クエリ履歴**: 過去のクエリと結果の保存・再利用
- **テーブル一覧**: 利用可能なテーブル一覧の表示
- **クエリエディタ**: 生成されたSQLの手動編集機能
- **エクスポート**: 結果のCSV/Excelエクスポート

### 10.2 統合拡張

- **Confluence/Jira統合**: BigQueryの結果とConfluence/Jiraの情報を統合して回答
- **ダッシュボード**: よく使われるクエリのダッシュボード化
- **アラート**: 特定の条件を満たすデータが検出された場合の通知

---

## 11. 実装フェーズ

### Phase 1: 基本機能（MVP）

- [ ] BigQuery接続ユーティリティの実装
- [ ] テーブルスキーマ取得機能
- [ ] 基本的なSQL生成（単純なSELECT文）
- [ ] クエリ実行機能
- [ ] エラーハンドリング（基本的なもの）
- [ ] UI統合（データソース選択）

### Phase 2: 高度な機能

- [ ] データカタログの活用
- [ ] 複雑なクエリ生成（JOIN、集計等）
- [ ] エラー回復機能（自動リトライ）
- [ ] 結果の整形・表示改善

### Phase 3: 拡張機能

- [ ] 可視化機能
- [ ] クエリ履歴
- [ ] パフォーマンス最適化
- [ ] 統合機能（Confluence/Jiraとの統合）

---

## 12. 参考実装

### 12.1 既存のAIフロー

- `src/ai/flows/retrieve-relevant-docs-lancedb.ts`: ドキュメント検索フロー
- `src/ai/flows/streaming-summarize-confluence-docs.ts`: ストリーミング回答生成

### 12.2 既存のクライアント

- `src/lib/lancedb-client.ts`: LanceDBクライアントの実装例
- `src/lib/lancedb-search-client.ts`: 検索クライアントの実装例

---

## 13. 用語集

- **ローテーブル**: 生データがそのまま格納されているテーブル
- **データカタログ**: テーブルや列の説明（メタデータ）を管理する機能
- **対話型DWH**: 自然言語で対話しながらデータを取得できるデータウェアハウス
- **フラット化**: ネストされたJSONデータを平らな列に展開すること
- **文字列化**: 数値コードを意味のある文字列に変換すること

---

**次のステップ**: 実装開始前に、実際のBigQueryテーブル構造を確認し、データカタログの整備状況を調査する。

