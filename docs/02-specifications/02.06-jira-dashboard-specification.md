# Jiraダッシュボード仕様書

**作成日**: 2025-01-XX  
**最終更新**: 2025-01-XX  
**バージョン**: 1.0

## 📋 概要

Jira課題データを可視化・分析するための管理ダッシュボード機能の仕様書です。掲載件数の推移、統計情報、個別案件の検索・詳細表示を提供します。

## 🎯 目的

- **進捗管理**: 課題のステータス別件数と推移を可視化
- **負荷分析**: 担当者別のワークロードを把握
- **トレンド分析**: 完了件数の推移を時系列で確認
- **案件検索**: 個別案件の検索と詳細情報の確認

## 🏗️ システム構成

### 技術スタック
- **フロントエンド**: Next.js 14, React, TypeScript, Tailwind CSS
- **バックエンド**: Next.js API Routes, Firebase Admin SDK
- **データベース**: 
  - LanceDB (`jira_issues`テーブル) - 検索用メタデータ
  - Firestore (`jiraIssues`コレクション) - 詳細データ、コメント履歴
- **可視化**: Recharts (LineChart, BarChart, PieChart)
- **UI コンポーネント**: shadcn/ui

### APIエンドポイント

#### 1. ダッシュボードデータ取得
- **URL**: `/api/admin/jira-dashboard`
- **メソッド**: GET
- **認証**: 管理者権限が必要
- **パラメータ**:
  - `period`: 期間 (`all` | `1month` | `3months` | `custom`)
  - `startDate`: 開始日 (YYYY-MM-DD, `custom`の場合)
  - `endDate`: 終了日 (YYYY-MM-DD, `custom`の場合)
  - `granularity`: 粒度 (`day` | `week` | `month`)
  - `status`: ステータス（カンマ区切り）
  - `statusCategory`: ステータスカテゴリ（カンマ区切り）
  - `assignee`: 担当者（カンマ区切り）
  - `priority`: 優先度（カンマ区切り）
  - `issueType`: 課題タイプ（カンマ区切り）
  - `completedStatusFilter`: 完了件数フィルタ（カンマ区切り）
  - `searchQuery`: 検索クエリ（Issue Key、タイトル、担当者、ステータス）

#### 2. フィルタオプション取得
- **URL**: `/api/admin/jira-dashboard/filter-options`
- **メソッド**: GET
- **認証**: 管理者権限が必要
- **レスポンス**: 利用可能なフィルタオプション一覧

#### 3. 個別案件詳細取得
- **URL**: `/api/admin/jira-dashboard/issue/[issueKey]`
- **メソッド**: GET
- **認証**: 管理者権限が必要
- **パラメータ**:
  - `issueKey`: Issue Key (例: `CTJ-5343`)

## 📊 機能仕様

### 1. 統計カード

#### 1.1 総課題数
- **表示内容**: フィルタ条件に該当する全課題数
- **更新頻度**: フィルタ変更時、手動更新時

#### 1.2 To Do件数
- **表示内容**: ステータスカテゴリが「To Do」または「未着手」の課題数
- **アイコン**: 時計アイコン

#### 1.3 進行中件数
- **表示内容**: ステータスカテゴリが「In Progress」または「進行中」の課題数
- **アイコン**: トレンドアップアイコン

#### 1.4 完了件数
- **表示内容**: ステータスカテゴリが「Done」または「完了」の課題数
- **アイコン**: チェックマークアイコン

### 2. フィルター機能

#### 2.1 期間フィルタ
- **オプション**:
  - `all`: 全期間
  - `1month`: 直近1ヶ月
  - `3months`: 直近3ヶ月
  - `custom`: カスタム期間（将来実装予定）

#### 2.2 粒度切り替え
- **オプション**:
  - `day`: 日単位（YYYY-MM-DD形式）
  - `week`: 週単位（YYYY-MM-WN形式）
  - `month`: 月単位（YYYY-MM形式）

#### 2.3 ステータスカテゴリフィルタ
- **説明**: ステータスカテゴリでフィルタリング
- **選択方式**: ドロップダウン（単一選択）
- **オプション**: 動的に取得（LanceDBから）

#### 2.4 担当者フィルタ
- **説明**: 担当者でフィルタリング
- **選択方式**: ドロップダウン（単一選択）
- **オプション**: 動的に取得（LanceDBから）

### 3. グラフ表示

#### 3.1 ステータス推移グラフ
- **タイプ**: 折れ線グラフ（LineChart）
- **表示データ**:
  - 総数: 全課題数
  - To Do: To Do状態の課題数
  - 進行中: 進行中状態の課題数
  - 完了: 完了状態の課題数
  - 完了件数: 完了日ベースの完了件数（破線）
- **X軸**: 期間（粒度に応じて日/週/月）
- **Y軸**: 件数
- **完了件数フィルタ**: 特定ステータスのみを完了件数に含める

#### 3.2 ステータスカテゴリ別分布
- **タイプ**: 円グラフ（PieChart）
- **表示内容**: ステータスカテゴリ別の課題数と割合
- **ラベル**: カテゴリ名とパーセンテージ

#### 3.3 担当者別ワークロード
- **タイプ**: 棒グラフ（BarChart）
- **表示内容**: 担当者別の課題数（上位10件）
- **X軸**: 担当者名（長い場合は省略）
- **Y軸**: 件数
- **ソート**: 件数の降順

#### 3.4 優先度別分布
- **タイプ**: 棒グラフ（BarChart）
- **表示内容**: 優先度別の課題数
- **X軸**: 優先度名
- **Y軸**: 件数

### 4. 個別案件一覧

#### 4.1 検索機能
- **検索対象**:
  - Issue Key（例: `CTJ-5343`）
  - タイトル
  - 担当者
  - ステータス
- **検索方式**: 部分一致（大文字小文字を区別しない）
- **実行方法**: 
  - 検索ボタンクリック
  - Enterキー押下

#### 4.2 一覧表示
- **表示項目**:
  - Issue Key
  - タイトル（最大幅で省略表示）
  - ステータス（バッジ表示）
  - 担当者
  - 優先度（バッジ表示）
  - 更新日（YYYY-MM-DD形式）
  - 操作（Jiraで開くボタン）
- **表示件数**: 最大50件
- **ソート**: 更新日時の降順
- **ページネーション**: 将来実装予定

#### 4.3 ドリルダウン機能
- **トリガー**: テーブル行をクリック
- **表示内容**: 案件詳細ダイアログ
  - 基本情報（タイトル、ステータス、担当者、優先度、作成日、更新日）
  - コメント履歴（投稿者、投稿日、内容）
  - Jiraで開くボタン

### 5. 案件詳細表示

#### 5.1 基本情報
- **表示項目**:
  - タイトル
  - ステータス
  - 担当者
  - 優先度
  - 作成日時
  - 更新日時
- **レイアウト**: 2列グリッド

#### 5.2 コメント履歴
- **表示内容**: 全コメントを時系列順（古い順）で表示
- **各コメントの表示項目**:
  - 投稿者
  - 投稿日時
  - 内容（テキスト形式）
- **表示件数**: 全件表示（スクロール可能）
- **最大高さ**: 256px（スクロール可能）

#### 5.3 外部リンク
- **機能**: Jiraの該当課題ページを新しいタブで開く
- **URL形式**: `https://giginc.atlassian.net/browse/{issueKey}`

## 🔄 データフロー

### 1. ダッシュボードデータ取得フロー

```
1. ユーザーがフィルタを設定
   ↓
2. フロントエンドがAPIリクエスト送信
   ↓
3. APIがLanceDBから全課題データを取得
   ↓
4. フィルタを適用してデータを絞り込み
   ↓
5. 統計データを集計
   ↓
6. トレンドデータを集計（完了日はFirestoreから取得）
   ↓
7. 個別案件一覧を生成（検索クエリがある場合はフィルタ）
   ↓
8. レスポンスを返却
   ↓
9. フロントエンドがグラフ・テーブルを更新
```

### 2. 個別案件詳細取得フロー

```
1. ユーザーがテーブル行をクリック
   ↓
2. フロントエンドが詳細APIリクエスト送信
   ↓
3. APIがFirestoreから詳細データを取得
   ↓
4. コメント履歴を含む詳細情報を返却
   ↓
5. フロントエンドがダイアログに表示
```

## 📐 データ構造

### 統計データ（JiraDashboardStats）

```typescript
interface JiraDashboardStats {
  total: number;                              // 総課題数
  byStatus: Record<string, number>;           // ステータス別件数
  byStatusCategory: Record<string, number>;   // ステータスカテゴリ別件数
  byAssignee: Record<string, number>;         // 担当者別件数
  byPriority: Record<string, number>;         // 優先度別件数
  byIssueType: Record<string, number>;        // 課題タイプ別件数
  byImpactDomain?: Record<string, number>;    // 影響業務別件数（オプション）
  byImpactLevel?: Record<string, number>;     // 業務影響度別件数（オプション）
}
```

### トレンドデータ（JiraTrendData）

```typescript
interface JiraTrendData {
  period: string;        // 期間（YYYY-MM-DD or YYYY-MM-WN or YYYY-MM）
  date: string;          // 期間の開始日（YYYY-MM-DD形式）
  total: number;         // 総課題数
  toDo: number;          // To Do件数
  inProgress: number;    // 進行中件数
  done: number;          // 完了件数
  completed: number;     // 完了日ベースの完了件数
}
```

### 個別案件データ（JiraIssue）

```typescript
interface JiraIssue {
  issue_key: string;        // Issue Key（例: "CTJ-5343"）
  title: string;            // タイトル
  status: string;           // ステータス名
  status_category: string;  // ステータスカテゴリ
  assignee: string;         // 担当者
  priority: string;         // 優先度
  issue_type: string;       // 課題タイプ
  created_at: string;       // 作成日時（ISO文字列）
  updated_at: string;       // 更新日時（ISO文字列）
  url: string;              // Jira URL
}
```

### フィルタ（JiraDashboardFilters）

```typescript
interface JiraDashboardFilters {
  period?: 'all' | '1month' | '3months' | 'custom';
  startDate?: string;                    // YYYY-MM-DD
  endDate?: string;                      // YYYY-MM-DD
  granularity?: 'day' | 'week' | 'month';
  status?: string[];                     // ステータス配列
  statusCategory?: string[];             // ステータスカテゴリ配列
  assignee?: string[];                   // 担当者配列
  priority?: string[];                   // 優先度配列
  issueType?: string[];                  // 課題タイプ配列
  completedStatusFilter?: string[];      // 完了件数フィルタ
  searchQuery?: string;                  // 検索クエリ
}
```

## 🎨 UI/UX仕様

### レイアウト

1. **ヘッダー**
   - タイトル: "Jiraダッシュボード"
   - 最終更新時刻
   - 更新ボタン

2. **フィルターセクション**
   - カード形式
   - 4列グリッド（レスポンシブ対応）

3. **統計カード**
   - 4列グリッド（レスポンシブ対応）
   - 各カードにアイコンと数値を表示

4. **グラフセクション**
   - 2列グリッド（レスポンシブ対応）
   - 各グラフはカード形式

5. **個別案件一覧**
   - カード形式
   - テーブル表示
   - 検索ボックス付き

### レスポンシブデザイン

- **モバイル**: 1列表示
- **タブレット**: 2列表示
- **デスクトップ**: 4列表示（統計カード）、2列表示（グラフ）

### 色設定

- **To Do**: グレー系（#9ca3af）
- **進行中**: イエロー系（#fbbf24）
- **完了**: グリーン系（#10b981）
- **完了件数**: レッド系（#ef4444、破線）
- **総数**: ブルー系（#8884d8）

### バッジ色

- **ステータス**:
  - 完了: `default`（グリーン）
  - 進行中: `secondary`（グレー）
  - その他: `outline`
- **優先度**:
  - Highest: `destructive`（レッド）
  - High: `default`（ブルー）
  - その他: `outline`

## ⚡ パフォーマンス

### 最適化

1. **データ取得**
   - LanceDBから全データを一度に取得（インメモリでフィルタリング）
   - Firestoreから完了日はバッチ取得（500件ずつ）

2. **表示制限**
   - 個別案件一覧は最大50件表示
   - コメント履歴はスクロール可能な領域に制限

3. **キャッシュ**
   - フィルタオプションは初回取得時にキャッシュ
   - データは手動更新またはフィルタ変更時に再取得

## 🔒 セキュリティ

- **認証**: 管理者権限が必要
- **データアクセス**: Firestoreのセキュリティルールに準拠
- **API**: Next.js API Routesで認証チェック

## 📝 今後の拡張予定

1. **カスタム期間選択**
   - 開始日・終了日のカレンダー選択

2. **ページネーション**
   - 個別案件一覧のページネーション機能

3. **エクスポート機能**
   - CSV/Excel形式でのデータエクスポート

4. **保存されたビュー**
   - よく使うフィルタ条件の保存・読み込み

5. **リアルタイム更新**
   - WebSocketまたはポーリングによる自動更新

6. **影響業務・業務影響度の可視化**
   - マトリクス表示やヒートマップ

7. **検証ステータスの表示**
   - dev検証・本番検証の進捗トラッカー

## 📚 関連ドキュメント

- [Jira統合計画](../01-architecture/06.01.01-confluence-jira-integration-plan.md)
- [Jiraダッシュボード指標整理](../../99-archive/architecture-legacy/jira-dashboard-indicators.md)
- [管理ダッシュボード仕様書](./02.05-management-dashboard-specification.md)

