# レコメンド機能仕様

**作成日**: 2025-01-27  
**最終更新**: 2025-01-27  
**ステータス**: 📋 仕様検討中（実装未着手）

---

## 📋 概要

チャットボットのユーザー体験を向上させるため、関連する質問や次のステップを提案するレコメンド機能を実装します。既存の質問分析機能を活用し、段階的に機能を拡張していきます。

---

## 🎯 目的

1. **ユーザーの探索を支援**: 関連する質問を提案することで、ユーザーがより深く情報を探索できるようにする
2. **よくある質問への導線**: 頻出質問を表示することで、ユーザーがよく聞かれる質問を簡単に見つけられるようにする
3. **会話の継続性向上**: 文脈に基づいた質問提案により、会話の流れを自然に保つ
4. **ユーザー満足度の向上**: より多くの情報にアクセスしやすくすることで、ユーザー満足度を向上させる

---

## 📊 現状分析

### 既存の機能

#### 1. 質問分析サービス (`src/lib/question-analysis-service.ts`)

**実装済み機能**:
- ✅ 頻出質問の分析
- ✅ 質問ログからの統計情報取得
- ✅ 質問タイプの分類（functional, technical, general, other）
- ✅ 回答品質の分析

**利用可能なデータ**:
```typescript
interface QuestionAnalysis {
  frequentQuestions: {
    question: string;
    count: number;
    lastAsked: Date;
    averageResponseTime: number;
    qualityScore: number;
  }[];
  // ... その他の分析データ
}
```

#### 2. 検索機能

**実装済み機能**:
- ✅ ハイブリッド検索（ベクトル検索 + BM25 + タイトル検索）
- ✅ 検索結果の参照元情報
- ✅ 検索結果のタイトルとコンテンツ

**活用可能な情報**:
- 検索結果のタイトルから関連質問を生成可能
- 参照元のタイトルから関連トピックを推測可能

#### 3. 会話履歴

**実装済み機能**:
- ✅ 会話履歴の保存
- ✅ 会話コンテキストの保持
- ✅ メッセージのタイムスタンプ

**活用可能な情報**:
- 現在の会話の文脈
- 過去の質問履歴
- ユーザーの興味関心

---

## 🔧 実装レベル別仕様

### レベル1: シンプルなレコメンド（実装容易）

**実装時間**: 1-2時間  
**優先度**: 高  
**推奨**: 最初に実装

#### 1.1 固定FAQの表示

**仕様**:
- 空の状態（メッセージがない時）に固定のFAQリストを表示
- よくある質問を3-5件表示

**表示タイミング**:
- チャットページが空の時
- 新しい会話を開始した時

**実装方法**:
```typescript
const DEFAULT_FAQS = [
  'ログイン認証の仕組みはどうなっていますか？',
  '求人詳細画面の仕様について教えてください',
  'プロジェクトXの要件定義書を要約して',
  // ... その他のよくある質問
];
```

**UI**:
- カード形式で表示
- クリックで質問を送信
- 視覚的に分かりやすいデザイン

#### 1.2 頻出質問の表示

**仕様**:
- 既存の`question-analysis-service.ts`を活用
- 過去30日間の頻出質問を取得
- 上位5-10件を表示

**表示タイミング**:
- 回答完了後
- 空の状態（固定FAQと併用）

**実装方法**:
```typescript
// question-analysis-service.tsを活用
const analysis = await questionAnalysisService.getQuestionAnalysis(30);
const frequentQuestions = analysis.frequentQuestions.slice(0, 10);
```

**UI**:
- 「よくある質問」セクションとして表示
- 質問をクリックで送信
- 頻出度を視覚的に表示（オプション）

---

### レベル2: 文脈に基づくレコメンド（中程度の複雑さ）

**実装時間**: 半日〜1日  
**優先度**: 中  
**推奨**: レベル1実装後に検討

#### 2.1 検索結果ベースの関連質問

**仕様**:
- 現在の質問の検索結果から関連質問を生成
- 検索結果のタイトルから関連トピックを抽出
- 3-5件の関連質問を提案

**実装方法**:
```typescript
// 検索結果のタイトルから関連質問を生成
function generateRelatedQuestions(searchResults: any[], currentQuestion: string): string[] {
  const titles = searchResults.map(r => r.title);
  const relatedQuestions = titles
    .filter(title => title !== currentQuestion)
    .slice(0, 5)
    .map(title => `${title}について教えてください`);
  
  return relatedQuestions;
}
```

**表示タイミング**:
- 回答完了後
- 検索結果が3件以上ある場合

**UI**:
- 「関連する質問」セクションとして表示
- 質問をクリックで送信

#### 2.2 会話の流れに基づく質問提案

**仕様**:
- 現在の会話の文脈から次の質問を推測
- キーワード抽出と関連トピックのマッピング
- 会話履歴を考慮した提案

**実装方法**:
```typescript
// 会話履歴からキーワードを抽出
function extractKeywords(messages: Message[]): string[] {
  // メッセージからキーワードを抽出
  // 名詞や重要な概念を抽出
}

// キーワードから関連質問を生成
function generateContextualQuestions(keywords: string[]): string[] {
  // キーワードの組み合わせから質問を生成
  // 例: ['ログイン', '認証'] → 'ログイン認証のエラー処理について教えてください'
}
```

**表示タイミング**:
- 回答完了後
- 会話が2往復以上ある場合

**UI**:
- 「次のステップ」セクションとして表示
- 質問をクリックで送信

#### 2.3 類似質問の提案

**仕様**:
- 現在の質問と類似した過去の質問を検索
- ベクトル検索で類似質問を取得
- 3-5件の類似質問を提案

**実装方法**:
```typescript
// ベクトル検索で類似質問を取得
async function findSimilarQuestions(currentQuestion: string): Promise<string[]> {
  // 現在の質問をベクトル化
  const embedding = await generateEmbedding(currentQuestion);
  
  // 過去の質問ログから類似質問を検索
  const similarQuestions = await searchSimilarQuestions(embedding, 5);
  
  return similarQuestions.map(q => q.question);
}
```

**表示タイミング**:
- 回答完了後
- 類似質問が3件以上見つかった場合

**UI**:
- 「似たような質問」セクションとして表示
- 質問をクリックで送信

---

### レベル3: 高度なレコメンド（複雑）

**実装時間**: 数日〜1週間  
**優先度**: 低  
**推奨**: 将来的な拡張として検討

#### 3.1 LLMを使った動的質問生成

**仕様**:
- Gemini APIを使用して会話の流れに応じた質問を生成
- より自然で文脈に合った質問を提案
- ユーザーの意図を理解した質問生成

**実装方法**:
```typescript
// LLMで質問を生成
async function generateQuestionsWithLLM(
  conversationHistory: Message[],
  currentAnswer: string,
  searchResults: any[]
): Promise<string[]> {
  const prompt = `
以下の会話履歴と回答を基に、ユーザーが次に聞きそうな質問を3-5件生成してください。

会話履歴:
${conversationHistory.map(m => `${m.role}: ${m.content}`).join('\n')}

現在の回答:
${currentAnswer}

検索結果のタイトル:
${searchResults.map(r => r.title).join('\n')}

関連する質問を3-5件生成してください。
  `;
  
  const response = await callGeminiAPI(prompt);
  return parseQuestions(response);
}
```

**表示タイミング**:
- 回答完了後
- 会話が継続している場合

**UI**:
- 「おすすめの質問」セクションとして表示
- 質問をクリックで送信

#### 3.2 パーソナライズされた提案

**仕様**:
- ユーザーの行動履歴に基づいた提案
- ユーザーがよく聞くトピックを優先
- ユーザーの興味関心を学習

**実装方法**:
```typescript
// ユーザーの行動履歴を分析
async function getPersonalizedRecommendations(
  userId: string,
  currentQuestion: string
): Promise<string[]> {
  // ユーザーの過去の質問を取得
  const userHistory = await getUserQuestionHistory(userId);
  
  // ユーザーがよく聞くトピックを分析
  const userTopics = analyzeUserTopics(userHistory);
  
  // 現在の質問と関連するトピックから質問を生成
  const recommendations = generatePersonalizedQuestions(
    currentQuestion,
    userTopics
  );
  
  return recommendations;
}
```

**表示タイミング**:
- 回答完了後
- ユーザーがログインしている場合

**UI**:
- 「あなたへのおすすめ」セクションとして表示
- 質問をクリックで送信

---

## 🎨 UI/UX設計

### 表示位置

1. **空の状態時**:
   - メインコンテンツエリアに表示
   - 固定FAQ + 頻出質問を表示

2. **回答完了後**:
   - 回答の下に表示
   - 「関連する質問」セクションとして表示

3. **会話継続時**:
   - サイドバーに表示（オプション）
   - 常に見える位置に配置

### UIコンポーネント

```typescript
// レコメンド質問カードコンポーネント
interface RecommendationCardProps {
  question: string;
  onClick: () => void;
  type?: 'frequent' | 'related' | 'similar' | 'suggested';
  metadata?: {
    count?: number; // 頻出度
    relevance?: number; // 関連度
  };
}
```

### デザイン方針

- **視覚的な区別**: レコメンドタイプごとに色やアイコンで区別
- **クリックしやすさ**: カード形式でクリック領域を確保
- **情報の階層**: セクションタイトルで情報を整理
- **レスポンシブ**: モバイルでも見やすく表示

---

## 📝 実装計画

### Phase 1: レベル1の実装（推奨）

**実装内容**:
1. 固定FAQの表示
2. 頻出質問の表示

**実装ファイル**:
- `src/components/chat-page.tsx`: UIコンポーネントの追加
- `src/components/recommendation-section.tsx`: 新規コンポーネント
- `src/lib/recommendation-service.ts`: 新規サービス（頻出質問取得）

**実装時間**: 1-2時間

### Phase 2: レベル2の実装

**実装内容**:
1. 検索結果ベースの関連質問
2. 会話の流れに基づく質問提案
3. 類似質問の提案

**実装ファイル**:
- `src/lib/recommendation-service.ts`: 拡張
- `src/components/recommendation-section.tsx`: 拡張

**実装時間**: 半日〜1日

### Phase 3: レベル3の実装（将来）

**実装内容**:
1. LLMを使った動的質問生成
2. パーソナライズされた提案

**実装時間**: 数日〜1週間

---

## 🔗 関連ドキュメント

- `src/lib/question-analysis-service.ts`: 質問分析サービス（既存）
- `src/components/chat-page.tsx`: チャットページコンポーネント
- `src/ai/flows/streaming-summarize-confluence-docs.ts`: ストリーミング要約フロー
- `src/lib/reference-enhancer.ts`: 参照元拡張機能

---

## 🎯 仕様決定サマリー

### 実装優先度

| レベル | 機能 | 優先度 | 実装時間 | 推奨 |
|--------|------|--------|----------|------|
| レベル1 | 固定FAQ + 頻出質問 | 高 | 1-2時間 | ✅ 最初に実装 |
| レベル2 | 文脈ベースのレコメンド | 中 | 半日〜1日 | レベル1後に検討 |
| レベル3 | LLMベースの高度なレコメンド | 低 | 数日〜1週間 | 将来的な拡張 |

### 決定済み事項

1. ✅ **段階的な実装**: レベル1から順に実装
2. ✅ **既存機能の活用**: `question-analysis-service.ts`を活用
3. ✅ **UI表示位置**: 空の状態時と回答完了後に表示
4. ✅ **実装方針**: シンプルな実装から始めて段階的に拡張

### 未決定事項

- ⚠️ レコメンド質問の最大表示件数（3-5件を推奨）
- ⚠️ レコメンドの更新頻度（リアルタイム vs キャッシュ）
- ⚠️ パーソナライズ機能の必要性（将来の検討事項）

---

**最終更新日**: 2025-01-27  
**仕様確定日**: 2025-01-27  
**次回レビュー**: 実装開始時

