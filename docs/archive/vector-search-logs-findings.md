# Vector Search ログ調査結果

## ログの分析

Google Cloud Consoleのログビューアと`firebase functions:log`コマンドの両方で`syncConfluenceData`関数のログを詳細に分析しました。

## 主な発見

1. **APIエンドポイントの情報**:
   ```
   path: '/v1/projects/confluence-copilot-ppjye/locations/asia-northeast1/indexes/7360896096425476096:upsertDatapoints'
   ```
   - プロジェクトID: `confluence-copilot-ppjye`
   - リージョン: `asia-northeast1`
   - インデックスID: `7360896096425476096`
   - エンドポイント: `upsertDatapoints`

2. **エラーの詳細**:
   ```
   data: { error: [Object] }
   status: 400
   ```
   - 400 Bad Requestエラーが発生していますが、エラーの詳細は`[Object]`としてしか表示されていません
   - これはログの表示制限によるもので、実際のエラー内容は取得できていません

3. **関数の実行状況**:
   - 関数自体は正常に実行され、ステータスコード200で終了しています
   - 実行時間は約5秒（5015ミリ秒）でした
   - 処理されたページ数は100、生成されたレコード数は182と報告されています

4. **エラーの一貫性**:
   - 最小限のテスト関数でも同様の400エラーが発生しています
   - これはデータの内容ではなく、APIの呼び出し方法やリクエスト形式に問題がある可能性を示唆しています

## 考察

1. **エンドポイントの確認**:
   - ログから確認したエンドポイントURLは正しい形式です
   - インデックスID `7360896096425476096` が実際のVector Searchインデックスと一致しているか確認が必要です

2. **リクエスト形式の問題**:
   - 400エラーは通常、リクエストの形式や内容に問題があることを示します
   - 特にフィールド名、データ型、必須パラメータなどが仕様と一致していない可能性があります

3. **インデックスの設定との不一致**:
   - ベクトルの次元数がインデックス作成時の設定と一致していない可能性があります
   - 現在のコードでは768次元のベクトルを生成していますが、インデックスの設定と一致しているか確認が必要です

## 次のステップ

1. **インデックスの詳細確認**:
   - Google Cloud Consoleで「Vertex AI」→「Vector Search」→「インデックス」から詳細を確認
   - 特に次元数、アルゴリズム設定、メタデータ制約などを確認

2. **エラーログの改善**:
   - エラーオブジェクトをCloud Storageに直接保存するなど、別の方法でエラー詳細を確認する仕組みを検討
   - エラーオブジェクトの特定の部分（例：`error.message`）を個別にログ出力する

3. **最小限のテスト関数の修正**:
   - より単純なデータ構造でテストを実施
   - 特に`embedding`フィールドの形式を変更して試す（例：`embedding: [...]`の代わりに`embedding: { values: [...] }`など）
   - メタデータフィールドを完全に省略したバージョンでテスト

4. **APIドキュメントの再確認**:
   - 最新のVertex AI Vector Search APIドキュメントを参照して、リクエスト形式を再検証
   - 特に`upsertDatapoints`エンドポイントの正確な仕様を確認
