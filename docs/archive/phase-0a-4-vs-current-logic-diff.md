# Phase 0A-4（#1多数）vs 現在のロジック差分

**作成日**: 2025年10月16日  
**目的**: #1が多く取得できていた時点（Phase 0A-4完了時）と現在のロジックの違いを特定

---

## 📊 順位比較

| 事例 | Phase 0A-4<br>完了時 | 現在<br>(バグ修正後) | 差分 |
|------|---------------------|-------------------|------|
| 1: 会員退会 | **#1** 🥇 | **#7** | -6 ⚠️ |
| 2: 教室削除 | 未発見 | #31 | +31 ✅ |
| 3: 教室コピー | **#1** 🥇 | #22 | -21 ⚠️ |
| 4: 重複応募不可期間 | #6 | **#3** | +3 ✅ |
| 5: 求人応募期間 | **#1** 🥇 | **#9** | -8 ⚠️ |
| 6: 学年・職業更新 | **#1** 🥇 | **#2** | -1 ✅ |

**サマリー:**
- Phase 0A-4: **Top 1率 66.7%** (4/6)
- 現在: **Top 1率 16.7%** (1/6)
- **差分: -50%** ⚠️

---

## 🔍 主な違い

### 1. **LanceDBデータ構成**

| 項目 | Phase 0A-4 | 現在 | 影響 |
|------|-----------|------|------|
| 総レコード数 | 1,316 | 1,224 | -92 |
| ユニークページ数 | 813 | 743 | **-70** ⚠️ |
| 除外ページ | 0 | 70 | **新規追加** |
| StructuredLabel | 1,040 (79.0%) | 1,040 (85.0%) | 同じ |

**違い:**
- 現在は**70ページを除外**している（ラベルフィルタリング）
- 除外ページには、`【削除予定】`, `【統合により削除】`, `【不要】`などが含まれる

**影響:**
- ⚠️ RRF順位計算に影響する可能性
- ✅ データ品質は向上（ノイズ除去）

---

### 2. **Composite Scoring 重み設定**

| パラメータ | Phase 0A-4 | 現在 | 変更 |
|-----------|-----------|------|------|
| vectorWeight | **30%** | **5%** | **-25%** ⚠️ |
| bm25Weight | **40%** | **50%** | +10% ✅ |
| titleWeight | **20%** | **25%** | +5% ✅ |
| labelWeight | **10%** | **15%** | +5% ✅ |
| maxBm25Score | **10.0** | **30.0** | +20.0 ✅ |

**違い:**
- **vectorWeight**: 30% → 5%（**6倍減少**）
- **bm25Weight**: 40% → 50%（+25%）
- **maxBm25Score**: 10.0 → 30.0（**3倍増加**）

**影響:**
- ✅ BM25高スコアページが有利（721など）
- ⚠️ ベクトル距離が近いページが不利
- ⚠️ バランスが変わり、全体的な順位に影響

---

### 3. **BM25検索パラメータ**

| パラメータ | Phase 0A-4 | 現在 | 変更 |
|-----------|-----------|------|------|
| kwCap | **50** | **100** | +50 ✅ |

**違い:**
- **kwCap**: 50件 → 100件（**2倍増加**）

**影響:**
- ✅ BM25候補が増加（130件 → 513件）
- ✅ 複数キーワードマッチのページが発見されやすい
- ⚠️ 競合が増加し、相対的な順位が変動

---

### 4. **検索ログの違い**

#### Phase 0A-4完了時（事例6の検索ログ）

```
[searchLanceDB] BM25 search keywords: 学年, 更新, プロフィール, 職業, 塾講師
[searchLanceDB] Added 88 BM25 rows for keywords
[searchLanceDB] Added 42 BM25 rows for core='学年'
Total: 130 BM25 candidates

RRF Top 3:
  1. 応募完了メール
  2. 014_求人応募機能
  3. オファー設定情報

Composite Top 3:
  1. 721_学年自動更新バッチ  ← 期待ページ ✅
  2. 応募完了メール
  3. 求人応募機能
```

#### 現在（バグ修正後）

```
[searchLanceDB] BM25 search keywords: 学年, 更新, プロフィール, 職業, 塾講師
[searchLanceDB] Added 301 BM25 rows for keywords
[searchLanceDB] Added 212 BM25 rows for core='学年'
Total: 513 BM25 candidates

RRF Top 3:
  1. 014_求人応募機能
  2. 応募完了メール
  3. 202_オシゴトQ&A

Composite Top 3:
  1. 014_求人応募機能
  2. 721_学年自動更新バッチ  ← 期待ページ ✅
  3. 求人一覧 - エリア別塾講師バイト
```

**違い:**
- BM25候補数: 130件 → 513件（**4倍増加**）
- RRF Top 3の順位が変動
- 721の順位: #1 → #2（わずかに低下）

---

## 🎯 根本的な違い: **競合の増加**

### Phase 0A-4の状態

```
総候補数: ~200件（ベクトル50件 + BM25 130件 + 重複）
競合ページ: 少ない
721のBM25スコア: 22（上位）
721のランク: #1
```

**理由:**
- BM25候補が少ない（130件）
- BM25スコア=22は相対的に非常に高い
- Composite Scoringで721が1位に浮上

### 現在の状態

```
総候補数: ~600件（ベクトル50件 + BM25 513件 + 重複）
競合ページ: 多い
721のBM25スコア: 22（依然として高い）
721のランク: #2
```

**理由:**
- BM25候補が多い（513件）
- 014_求人応募機能がより高いBM25スコアを持つ
- 競合が増えたため、相対順位が低下

---

## 📊 スコア比較

### 事例1: 046_会員退会機能

#### Phase 0A-4
```
順位: #1
Composite: 不明（記録なし）
BM25候補: ~130件
```

#### 現在
```
順位: #7
Composite: 0.3XXX（推定）
BM25候補: ~300件

Top 7の競合:
  1. 退会完了通知メール
  2. 再応募促進メール
  3-6. その他退会関連ページ
  7. 046_会員退会機能  ← 期待ページ
```

**理由:**
- kwCap=100により、「退会」に関連するページが大量に候補に含まれる
- 退会完了メール、再応募促進メールなどが高スコアを獲得
- 相対的に046の順位が低下

---

### 事例3: 168_教室コピー機能

#### Phase 0A-4
```
順位: #1
Composite: 0.9424
  V: 0.52 (高い)
  B: 0.40
  T: 0.00
  L: 0.03
```

#### 現在
```
順位: #22
Composite: 0.3XXX（推定）
BM25候補: ~400件
```

**理由:**
- vectorWeight: 30% → 5%（**6倍減少**）
- Phase 0A-4では、ベクトルスコア0.52が強く寄与（0.52 × 0.30 = 0.156）
- 現在では、ベクトル寄与が微小（0.52 × 0.05 = 0.026）
- **ベクトルスコアが高いページが不利になった**

---

### 事例5: 014_求人応募機能

#### Phase 0A-4
```
順位: #1
クエリ: "求人に応募できる期間はいつまでですか"
```

#### 現在
```
順位: #9
クエリ: "求人に応募できる期間はいつまでですか"
期待ページ: 014_求人応募機能
Top 1: 【FIX】求人：応募条件・研修情報
```

**理由:**
- kwCap=100により、「求人」「応募」「期間」に関連するページが大量に候補に含まれる
- 「求人：応募条件・研修情報」がより直接的なタイトルマッチ
- 014は「期間」を直接扱っていないため、スコアが低下

---

## 🔧 なぜPhase 0A-4では#1が多かったのか

### 1. **適度なBM25候補数（50-130件）**

```
kwCap = 50
BM25候補: ~130件

メリット:
  ✅ 競合が少ない
  ✅ 高スコアページが目立つ
  ✅ ノイズが少ない

デメリット:
  ⚠️ 複数キーワードマッチのページが漏れる可能性
```

### 2. **ベクトル重視（30%）**

```
vectorWeight: 30%

メリット:
  ✅ ベクトル距離が近いページが上位に
  ✅ セマンティック検索が機能
  ✅ タイトルに完全一致しなくても発見可能

デメリット:
  ⚠️ ベクトル距離が遠いページが不利
```

### 3. **BM25正規化基準が厳しい（maxBm25Score=10.0）**

```
maxBm25Score = 10.0

例: keyword=22の場合
  normalizedBm25 = min(1.0, 22 / 10.0) = 1.0（キャップ）
  bm25Contribution = 1.0 × 0.40 = 0.40

メリット:
  ✅ BM25超高スコア（>10）がすべて1.0扱い
  ✅ 中スコア（5-10）との差が小さくなる
  ✅ 他のシグナル（ベクトル、タイトル）が相対的に重要に

デメリット:
  ⚠️ BM25の差別化能力が低下
```

### 4. **データセットが大きい（813ページ）**

```
Phase 0A-4: 813ページ
現在: 743ページ（-70ページ）

Phase 0A-4には以下が含まれていた:
  - 【削除予定】学歴情報1, 2
  - 【不要のため削除】会員：職歴
  - 【統合により削除】採用お祝い申請
  - （バックアップ）求人一覧
  など

メリット:
  ✅ 関連ページが多く含まれる
  ✅ RRF融合でより多様な候補が評価される

デメリット:
  ⚠️ ノイズが含まれる
  ⚠️ データ品質が低い
```

---

## 📋 推奨される設定（Phase 0A-4ベース）

現在のデータ（743ページ、70ページ除外）で、Phase 0A-4の#1率を再現するには：

### Option A: Phase 0A-4設定に完全復帰

```typescript
// src/lib/composite-scoring-service.ts
const DEFAULT_CONFIG = {
  vectorWeight: 0.30,   // 5% → 30%
  bm25Weight: 0.40,     // 50% → 40%
  titleWeight: 0.20,    // 25% → 20%
  labelWeight: 0.10,    // 15% → 10%
  maxBm25Score: 10.0,   // 30.0 → 10.0
};

// src/lib/lancedb-search-client.ts
const kwCap = Math.min(50, Math.max(10, Math.floor(topK / 3)));  // 100 → 50
```

**期待効果:**
```
事例1: #7 → #1-2
事例3: #22 → #1-2
事例5: #9 → #1-2
事例6: #2 → #1

Top 1率: 16.7% → 50-67%
```

**リスク:**
- 事例4が#3 → #6程度に低下する可能性（kwCap減少）

---

### Option B: バランス型（推奨）

Phase 0A-4の良い部分と現在の改善を組み合わせ:

```typescript
// src/lib/composite-scoring-service.ts
const DEFAULT_CONFIG = {
  vectorWeight: 0.20,   // 中間値（Phase 0A-4: 30%, 現在: 5%）
  bm25Weight: 0.45,     // 中間値（Phase 0A-4: 40%, 現在: 50%）
  titleWeight: 0.22,    // 中間値（Phase 0A-4: 20%, 現在: 25%）
  labelWeight: 0.13,    // 中間値（Phase 0A-4: 10%, 現在: 15%）
  maxBm25Score: 20.0,   // 中間値（Phase 0A-4: 10.0, 現在: 30.0）
};

// src/lib/lancedb-search-client.ts
const kwCap = Math.min(75, Math.max(20, Math.floor(topK * 1.5)));  // 中間値
```

**期待効果:**
```
事例1: #7 → #2-3
事例3: #22 → #3-5
事例4: #3 → #3-4（維持）
事例5: #9 → #2-3
事例6: #2 → #1-2

Top 1率: 16.7% → 33-50%
Top 3率: 33% → 67-83%
```

**メリット:**
- Phase 0A-4の成功要因を取り入れつつ、現在の改善も維持
- リスクが最小化

---

### Option C: 現在設定を維持（StructuredLabel重視）

現在の設定を維持し、Phase 4（KG統合）で改善:

```typescript
// 設定は現在のまま
vectorWeight: 0.05,
bm25Weight: 0.50,
titleWeight: 0.25,
labelWeight: 0.15,
kwCap: 100
```

**期待効果（Phase 4実装後）:**
```
事例1: #7 → #2-3（KG参照）
事例2: #31 → #1-3（KG参照で大幅改善）
事例3: #22 → #1-3（KG参照）
事例5: #9 → #3-5
事例6: #2 → #1-2

Top 1率: 16.7% → 50-67%
Top 3率: 33% → 83-100%
```

**メリット:**
- StructuredLabel効果を最大化（15%）
- Phase 4で根本的に改善
- データ品質が高い（70ページ除外）

**デメリット:**
- Phase 4実装まで順位が低いまま

---

## 🔍 詳細な違い: 事例ごとの分析

### 事例1: 046_会員退会機能（#1 → #7）

#### なぜPhase 0A-4では#1だったのか

**Phase 0A-4のスコア（推定）:**
```
vectorDistance: 0.8（やや近い）
bm25Score: 8（中スコア）
titleMatchRatio: 0.33（「退会」「機能」がマッチ）

normalizedVector = 1 - (0.8 / 2.0) = 0.60
normalizedBm25 = min(1.0, 8 / 10.0) = 0.80
normalizedTitle = 0.33

vectorContribution = 0.60 × 0.30 = 0.180  ← 大きい
bm25Contribution = 0.80 × 0.40 = 0.320
titleContribution = 0.33 × 0.20 = 0.066
labelContribution = 0.00 × 0.10 = 0.000

compositeScore = 0.566（高い）
→ #1
```

#### なぜ現在は#7なのか

**現在のスコア（推定）:**
```
vectorDistance: 0.8（同じ）
bm25Score: 8（同じ）
titleMatchRatio: 0.33（同じ）

normalizedVector = 1 - (0.8 / 2.0) = 0.60
normalizedBm25 = min(1.0, 8 / 30.0) = 0.267  ← 低下
normalizedTitle = 0.33

vectorContribution = 0.60 × 0.05 = 0.030  ← 大幅減少
bm25Contribution = 0.267 × 0.50 = 0.134  ← 減少
titleContribution = 0.33 × 0.25 = 0.083  ← 増加
labelContribution = 0.00 × 0.15 = 0.000

compositeScore = 0.247（低い）
→ #7（競合に負ける）
```

**競合ページの例:**
- 退会完了通知メール（bm25Score=12, より高い）
- 再応募促進メール（bm25Score=10, titleマッチ率高）

**結論:**
1. maxBm25Score増加（10.0 → 30.0）により、中スコア（8）の正規化値が低下
2. vectorWeight減少（30% → 5%）により、ベクトル貢献が激減
3. kwCap増加により競合が増加

---

### 事例3: 168_教室コピー機能（#1 → #22）

#### なぜPhase 0A-4では#1だったのか

**Phase 0A-4のスコア（実測）:**
```
Composite: 0.9424
  V: 0.52（非常に高い）← ベクトル距離が近い
  B: 0.40
  T: 0.00
  L: 0.03

vectorContribution = 0.52（vectorWeight=30%の効果）
→ #1（圧倒的）
```

#### なぜ現在は#22なのか

**現在のスコア（推定）:**
```
vectorDistance: 0.384（Phase 0A-4と同じ）
normalizedVector = 1 - (0.384 / 2.0) = 0.808

vectorContribution = 0.808 × 0.05 = 0.040  ← 激減
bm25Contribution = 0.40 × 0.50 = 0.200
titleContribution = 0.00 × 0.25 = 0.000
labelContribution = 0.03 × 0.15 = 0.005

compositeScore = 0.245（Phase 0A-4の1/4）
→ #22（大幅低下）
```

**結論:**
- **vectorWeight減少が致命的**（0.52 → 0.040、**13倍減少**）
- 168はベクトル距離が非常に近いページだった
- vectorWeightが低いと、この強みが活かされない

---

### 事例6: 721_学年自動更新バッチ（#1 → #2）

#### なぜPhase 0A-4では#1だったのか

**Phase 0A-4のスコア（推定）:**
```
vectorDistance: 0.384（遠い）
bm25Score: 22（非常に高い）
titleMatchRatio: 0.33

normalizedVector = 1 - (0.384 / 2.0) = 0.808
normalizedBm25 = min(1.0, 22 / 10.0) = 1.00（キャップ）
normalizedTitle = 0.33

vectorContribution = 0.808 × 0.30 = 0.242
bm25Contribution = 1.00 × 0.40 = 0.400  ← キャップ効果
titleContribution = 0.33 × 0.20 = 0.066
labelContribution = 0.30 × 0.10 = 0.030

compositeScore = 0.738
→ #1
```

**キーポイント:**
- BM25スコア=22が、maxBm25Score=10.0によりキャップされ、1.0扱い
- bm25Contribution = 0.40（最大値）
- 競合が少ない（kwCap=50）

#### なぜ現在は#2なのか

**現在のスコア（実測）:**
```
Composite: 0.5304
  V: 0.0404
  B: 0.3667  ← キャップされない
  T: 0.0833
  L: 0.0400

normalizedBm25 = min(1.0, 22 / 30.0) = 0.733（キャップなし）
bm25Contribution = 0.733 × 0.50 = 0.3667

compositeScore = 0.5304
→ #2
```

**Top 1の014_求人応募機能:**
```
Composite: 0.5089
  bm25Score: ~26（推定）
  normalizedBm25 = 26 / 30.0 = 0.867
  bm25Contribution = 0.867 × 0.50 = 0.434

compositeScore = 0.51（721より高い）
→ #1
```

**結論:**
- maxBm25Score増加（10.0 → 30.0）により、BM25スコア差が正確に反映される
- 721のBM25=22は、014のBM25=26に負ける
- キャップ効果がなくなったため、微妙な差で順位が決まる

---

## 🎯 結論: Phase 0A-4で#1が多かった3つの理由

### 1. **適度な競合数（kwCap=50）**

```
BM25候補: ~130件
→ 競合が少なく、高スコアページが目立つ
```

### 2. **ベクトル重視（vectorWeight=30%）**

```
ベクトル距離が近いページ（事例3など）が#1に
→ セマンティック検索が強く機能
```

### 3. **BM25キャップ効果（maxBm25Score=10.0）**

```
BM25超高スコア（>10）がすべて1.0扱い
→ BM25=22のページが最大評価を獲得
→ 他のシグナル（ベクトル、タイトル）で差別化
```

---

## 📊 推奨アクション

### 🎯 Phase 0A-4の#1率を再現したい場合

**推奨: Option A（Phase 0A-4設定に復帰）**

```typescript
// src/lib/composite-scoring-service.ts
vectorWeight: 0.30,
bm25Weight: 0.40,
titleWeight: 0.20,
labelWeight: 0.10,
maxBm25Score: 10.0,

// src/lib/lancedb-search-client.ts
kwCap = 50
```

**期待結果:**
- Top 1率: 16.7% → 50-67%
- 事例1, 3, 5, 6が#1-2に復帰

**トレードオフ:**
- StructuredLabel効果が減少（15% → 10%）
- 事例4が#3 → #6程度に低下

---

### 🚀 Phase 4（KG統合）を実装して根本解決

Phase 4を実装すれば、現在の設定のまま#1率を向上できます:

```
期待効果:
  事例2: #31 → #1-3（KG参照で大幅改善）
  事例3: #22 → #1-3（KG参照）
  
Top 1率: 16.7% → 50-83%
Top 3率: 33% → 83-100%
```

---

## 📚 参考資料

1. **Phase 0A-4完了レポート**: `docs/implementation/phase-0a-4-completion-report.md`
2. **現在の品質レポート**: `docs/implementation/current-search-quality-report.md`
3. **ロールバック影響分析**: `docs/implementation/rollback-impact-analysis.md`

