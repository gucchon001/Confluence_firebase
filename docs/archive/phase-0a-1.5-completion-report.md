# Phase 0A-1.5 å®Ÿè£…å®Œäº†å ±å‘Š

**ãƒ•ã‚§ãƒ¼ã‚ºå**: Phase 0A-1.5 æ¤œç´¢å“è³ªç·Šæ€¥æ”¹å–„  
**å®Œäº†æ—¥**: 2025-10-14  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†ã€StructuredLabelç”Ÿæˆä¸­  
**æ‹…å½“**: é–‹ç™ºãƒãƒ¼ãƒ 

---

## ğŸ¯ ç›®çš„

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æŒ‡æ‘˜ã•ã‚ŒãŸæ¤œç´¢å“è³ªå•é¡Œã®æ”¹å–„**

### å¯¾è±¡å•é¡Œï¼ˆ6äº‹ä¾‹ï¼‰

| ID | è³ªå• | æœŸå¾…ãƒšãƒ¼ã‚¸ | ç¾çŠ¶ç²¾åº¦ | ç›®æ¨™ç²¾åº¦ |
|----|------|-----------|---------|---------|
| 1 | é€€ä¼šå¾Œã®å†ç™»éŒ² | 046 | 0% | 60% |
| 2 | æ•™å®¤å‰Šé™¤æ¡ä»¶ | 164 | 50% | 95% |
| 3 | æ•™å®¤ã‚³ãƒ”ãƒ¼é …ç›® | 168 | 30% | 85% |
| 4 | å¿œå‹Ÿåˆ¶é™æœ‰ç„¡ | 014 | 0% | 40% |
| 5 | é‡è¤‡å¿œå‹ŸæœŸé–“ | 014 | 0% | 30% |
| 6 | å­¦å¹´ãƒ»è·æ¥­æ›´æ–°æ¡ä»¶ | 721 | 70% | 95% |

**å…¨ä½“ç›®æ¨™**: 16% â†’ **62%**ï¼ˆ+46%æ”¹å–„ï¼‰

---

## âœ… å®Ÿè£…ã—ãŸ3ã¤ã®æ”¹å–„

### æ”¹å–„1: ç©ºãƒšãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ğŸ”¥ğŸ”¥ğŸ”¥

#### å®Ÿè£…å†…å®¹

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´**ï¼ˆ`src/lib/lancedb-search-client.ts`ï¼‰:
```typescript
function filterInvalidPagesByContent(results: any[]): any[] {
  const validResults = [];
  
  for (const result of results) {
    const contentLength = result.content?.length || 0;
    
    // 100æ–‡å­—æœªæº€ã®ãƒšãƒ¼ã‚¸ã‚’é™¤å¤–
    if (contentLength < 100) {
      console.log(`[EmptyPageFilter] Excluded: ${result.title} (content too short: ${contentLength}chars)`);
      continue;
    }
    
    validResults.push(result);
  }
  
  return validResults;
}
```

**ã‚µãƒ¼ãƒãƒ¼å´**ï¼ˆ`src/ai/flows/retrieve-relevant-docs-lancedb.ts`ï¼‰:
```typescript
async function filterInvalidPagesServer(results: any[]): Promise<any[]> {
  // StructuredLabelã‚’ä¸€æ‹¬å–å¾—ï¼ˆAdmin SDKä½¿ç”¨ï¼‰
  const pageIds = results.map((r) => String(r.pageId || r.id || 'unknown'));
  const labels = await getStructuredLabels(pageIds);
  
  for (const result of results) {
    const pageId = String(result.pageId || result.id || 'unknown');
    const label = labels.get(pageId);
    
    // StructuredLabelãŒã‚ã‚‹å ´åˆ: is_validã§åˆ¤å®š
    if (label && label.is_valid === false) {
      console.log(`[EmptyPageFilter] Excluded: ${result.title} (is_valid: false)`);
      continue;
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é•·ã§åˆ¤å®š
    if (!label && result.content?.length < 100) {
      console.log(`[EmptyPageFilter] Excluded: ${result.title} (content too short)`);
      continue;
    }
    
    validResults.push(result);
  }
  
  return validResults;
}
```

#### å®Ÿè£…èª²é¡Œã¨è§£æ±º

**èª²é¡Œ1**: Firestoreæ¨©é™ã‚¨ãƒ©ãƒ¼
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§StructuredLabelå–å¾—æ™‚ã«`permission-denied`ã‚¨ãƒ©ãƒ¼
- **è§£æ±º**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é•·ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¿½åŠ å®Ÿè£…

**èª²é¡Œ2**: LanceDB WHEREå¥ã®ã‚±ãƒ¼ã‚¹
- `where("pageId" = ...)` ãŒã‚¨ãƒ©ãƒ¼ï¼ˆNo field named pageidï¼‰
- **è§£æ±º**: `where('"pageId" = ...)` ã¨ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€

**èª²é¡Œ3**: idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å½¢å¼
- `id`ã¯`{pageId}-{chunkIndex}`å½¢å¼ï¼ˆä¾‹: "640450787-0"ï¼‰
- **è§£æ±º**: å…¨ä»¶å–å¾—å¾Œã€å‰æ–¹ä¸€è‡´ã§æŠ½å‡º

#### åŠ¹æœæ¤œè¨¼

```
ã€äº‹ä¾‹3: æ•™å®¤ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã€‘
Before: 515ï¼ˆç©ºãƒšãƒ¼ã‚¸ã€21æ–‡å­—ï¼‰ãŒ3ä½ â†’ 168ãŒ13ä½
After:  515é™¤å¤– â†’ 168ãŒ3ä½ã«æµ®ä¸Š âœ…
```

**é™¤å¤–å®Ÿç¸¾**:
- 515_æ•™å®¤ç®¡ç†-æ•™å®¤ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ï¼ˆ21æ–‡å­—ï¼‰
- ç¾åœ¨ã®è·æ¥­ï¼ˆ5æ–‡å­—ï¼‰
- æ±‚äººãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ16æ–‡å­—ï¼‰

---

### æ”¹å–„2: å…¨ãƒãƒ£ãƒ³ã‚¯çµ±åˆ ğŸ”¥ğŸ”¥ğŸ”¥

#### å®Ÿè£…å†…å®¹

```typescript
async function enrichWithAllChunks(results: any[]): Promise<any[]> {
  const enriched = await Promise.all(
    results.map(async (result) => {
      const pageId = result.pageId || result.id;
      
      // ã“ã®ãƒšãƒ¼ã‚¸ã®å…¨ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—
      const allChunks = await getAllChunksByPageId(String(pageId));
      
      if (allChunks.length <= 1) {
        return result; // çµ±åˆä¸è¦
      }
      
      // å…¨ãƒãƒ£ãƒ³ã‚¯ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’çµ±åˆ
      const mergedContent = allChunks
        .map((chunk) => chunk.content || '')
        .filter(Boolean)
        .join('\n\n');
      
      console.log(
        `[ChunkMerger] Merged ${allChunks.length} chunks for "${result.title}" (${result.content?.length || 0} â†’ ${mergedContent.length} chars)`
      );
      
      return {
        ...result,
        content: mergedContent,
        chunkCount: allChunks.length,
      };
    })
  );
  
  return enriched;
}

async function getAllChunksByPageId(pageId: string): Promise<any[]> {
  const connection = await optimizedLanceDBClient.getConnection();
  const table = connection.table;
  
  // å…¨ä»¶å–å¾—ã—ã¦pageIdã§å‰æ–¹ä¸€è‡´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const allArrow = await table.query().limit(10000).toArrow();
  const chunks: any[] = [];
  
  for (let i = 0; i < allArrow.numRows; i++) {
    const id = String(idColumn?.get(i) || '');
    
    if (id.startsWith(`${pageId}-`)) {
      // ãƒãƒ£ãƒ³ã‚¯ã‚’æŠ½å‡º
      chunks.push(extractRow(allArrow, i));
    }
  }
  
  // chunkIndexã§ã‚½ãƒ¼ãƒˆ
  chunks.sort((a, b) => {
    const aIndex = parseInt(String(a.id).split('-').pop() || '0', 10);
    const bIndex = parseInt(String(b.id).split('-').pop() || '0', 10);
    return aIndex - bIndex;
  });
  
  return chunks;
}
```

#### åŠ¹æœæ¤œè¨¼

```
ã€ãƒãƒ£ãƒ³ã‚¯çµ±åˆå®Ÿç¸¾ã€‘
[ChunkMerger] Merged 11 chunks for "014_æ±‚äººå¿œå‹Ÿæ©Ÿèƒ½" (1800 â†’ 19578 chars) âœ…
[ChunkMerger] Merged 8 chunks for "041_ä¼šå“¡æ–°è¦ç™»éŒ²æ©Ÿèƒ½" (1800 â†’ 13218 chars) âœ…
[ChunkMerger] Merged 5 chunks for "596_å¿œå‹Ÿãƒ»æ¡ç”¨ç®¡ç†" (1800 â†’ 8314 chars) âœ…
[ChunkMerger] Merged 3 chunks for "043_1_ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†" (1800 â†’ 4312 chars) âœ…
[ChunkMerger] Merged 2 chunks for "721_å­¦å¹´è‡ªå‹•æ›´æ–°ãƒãƒƒãƒ" (1799 â†’ 2309 chars) âœ…

Total chunks merged: 32
```

**äº‹ä¾‹6ï¼ˆ721ï¼‰**: 
- Before: 1ãƒãƒ£ãƒ³ã‚¯ï¼ˆ1,799æ–‡å­—ï¼‰â†’ éƒ¨åˆ†çš„ãªæƒ…å ±
- After: 2ãƒãƒ£ãƒ³ã‚¯çµ±åˆï¼ˆ2,309æ–‡å­—ï¼‰â†’ å®Œå…¨ãªæƒ…å ± âœ…

---

### æ”¹å–„3: ãƒšãƒ¼ã‚¸å˜ä½ã®é‡è¤‡æ’é™¤ ğŸ”¥ğŸ”¥

#### å®Ÿè£…å†…å®¹

```typescript
function deduplicateByPageId(results: any[]): any[] {
  const pageMap = new Map<string, any>();
  
  results.forEach(result => {
    const pageId = String(result.pageId || 'unknown');
    const existing = pageMap.get(pageId);
    
    if (!existing) {
      pageMap.set(pageId, result);
    } else {
      // ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ï¼ˆè·é›¢ãŒå°ã•ã„æ–¹ï¼‰ã‚’ä¿æŒ
      const currentDistance = result._distance || 999;
      const existingDistance = existing._distance || 999;
      
      if (currentDistance < existingDistance) {
        pageMap.set(pageId, result);
        console.log(`[Deduplicator] Updated best chunk for ${result.title}`);
      }
    }
  });
  
  const deduplicated = Array.from(pageMap.values());
  
  if (deduplicated.length < results.length) {
    console.log(`[Deduplicator] Deduplicated: ${results.length} â†’ ${deduplicated.length} results`);
  }
  
  return deduplicated;
}
```

#### åŠ¹æœæ¤œè¨¼

```
ã€é‡è¤‡æ’é™¤å®Ÿç¸¾ã€‘
168_æ•™å®¤ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½: 8ãƒãƒ£ãƒ³ã‚¯ â†’ 1ã‚¨ãƒ³ãƒˆãƒªï¼ˆãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢é¸æŠï¼‰ âœ…
```

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

### å®Ÿæ¸¬ç²¾åº¦: 17%ï¼ˆ1/6ä»¶æˆåŠŸï¼‰

| äº‹ä¾‹ | è³ªå• | æœŸå¾…ãƒšãƒ¼ã‚¸ | çµæœ | ãƒãƒ£ãƒ³ã‚¯çµ±åˆ |
|------|------|-----------|------|------------|
| 1 | é€€ä¼šå¾Œã®å†ç™»éŒ² | 046 | âŒ æœªç™ºè¦‹ | - |
| 2 | æ•™å®¤å‰Šé™¤æ¡ä»¶ | 164 | âŒ æœªç™ºè¦‹ | - |
| 3 | æ•™å®¤ã‚³ãƒ”ãƒ¼é …ç›® | 168 | âŒ æœªç™ºè¦‹ï¼ˆtopK=8ã§é™¤å¤–ï¼‰ | - |
| 4 | å¿œå‹Ÿåˆ¶é™æœ‰ç„¡ | 014 | âŒ æœªç™ºè¦‹ | - |
| 5 | é‡è¤‡å¿œå‹ŸæœŸé–“ | 014 | âŒ æœªç™ºè¦‹ | - |
| 6 | å­¦å¹´ãƒ»è·æ¥­æ›´æ–°æ¡ä»¶ | 721 | âœ… **1ä½** | **2ãƒãƒ£ãƒ³ã‚¯çµ±åˆ** âœ… |

### æ©Ÿèƒ½å‹•ä½œç¢ºèª

âœ… **ç©ºãƒšãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: æ­£å¸¸å‹•ä½œ
- 515ï¼ˆ21æ–‡å­—ï¼‰é™¤å¤–ç¢ºèª
- ç¾åœ¨ã®è·æ¥­ï¼ˆ5æ–‡å­—ï¼‰é™¤å¤–ç¢ºèª
- æ±‚äººãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ16æ–‡å­—ï¼‰é™¤å¤–ç¢ºèª

âœ… **ãƒãƒ£ãƒ³ã‚¯çµ±åˆ**: æ­£å¸¸å‹•ä½œ
- 32ãƒãƒ£ãƒ³ã‚¯çµ±åˆç¢ºèª
- æœ€å¤§11ãƒãƒ£ãƒ³ã‚¯ï¼ˆ014ï¼‰çµ±åˆç¢ºèª

âœ… **é‡è¤‡æ’é™¤**: æ­£å¸¸å‹•ä½œ
- 168ã®8ãƒãƒ£ãƒ³ã‚¯ â†’ 1ã‚¨ãƒ³ãƒˆãƒªç¢ºèª

---

## ğŸ” æƒ³å®šã¨å®Ÿæ¸¬ã®ã‚®ãƒ£ãƒƒãƒ—åˆ†æ

### æƒ³å®šï¼ˆ62%ï¼‰vs å®Ÿæ¸¬ï¼ˆ17%ï¼‰ã®åŸå› 

#### æƒ³å®šã®å‰ææ¡ä»¶

Phase 0A-1.5ã®è¨ˆç”»ã§ã¯ã€ä»¥ä¸‹ã‚’å‰æã¨ã—ã¦ã„ã¾ã—ãŸï¼š

| å‰æ | å®Ÿéš› |
|------|------|
| æœŸå¾…ãƒšãƒ¼ã‚¸ãŒæ¤œç´¢çµæœï¼ˆtopK=8ï¼‰ã«å«ã¾ã‚Œã¦ã„ã‚‹ | âŒ **å«ã¾ã‚Œã¦ã„ãªã„** |
| Phase 0A-1.5ã§ã€Œæ¤œç´¢å¾Œã®å‡¦ç†ã€ã‚’æ”¹å–„ã™ã‚Œã°ç²¾åº¦å‘ä¸Š | âš ï¸ ã€Œæ¤œç´¢å‰ã€ã®å•é¡ŒãŒä¸»å›  |

#### è©³ç´°åˆ†æï¼ˆäº‹ä¾‹3: æ•™å®¤ã‚³ãƒ”ãƒ¼ï¼‰

**topK=20ã§ã®æ¤œç´¢çµæœ**:
```
[1] ã€FIXã€‘æ•™å®¤ã®ãƒ­ã‚´ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒ (BM25 61%)
[2] ã€FIXã€‘æ•™å®¤ã®å¿œå‹Ÿæƒ…å ±è»¢é€å…ˆ... (BM25 62%)
[3] 515_æ•™å®¤ç®¡ç†-æ•™å®¤ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ (Hybrid 51.6%) â† ç©ºãƒšãƒ¼ã‚¸
[4] 168_ã€FIXã€‘æ•™å®¤ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ (Hybrid 25.2%) â† æœŸå¾…ãƒšãƒ¼ã‚¸ âœ…
...
```

**Phase 0A-1.5é©ç”¨å¾Œ**:
```
[1] ã€FIXã€‘æ•™å®¤ã®ãƒ­ã‚´ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒ (BM25 61%)
[2] ã€FIXã€‘æ•™å®¤ã®å¿œå‹Ÿæƒ…å ±è»¢é€å…ˆ... (BM25 62%)
[3] 168_ã€FIXã€‘æ•™å®¤ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ (Hybrid 25.2%) â† 515é™¤å¤–ã§æµ®ä¸Š âœ…
```

**å•é¡Œç‚¹**:
- âœ… 515é™¤å¤–ã§168ãŒ3ä½ã«æµ®ä¸Š
- âŒ topK=8ã§ã¯ä¾ç„¶ã¨ã—ã¦BM25ã®1-2ä½ãŒå¼·ã™ãã‚‹
- âŒ 168ãŒtopK=8ã«å…¥ã‚‹ã‹ã¯ä¸ç¢ºå®Ÿ

#### æ ¹æœ¬åŸå› 

**Phase 0A-1.5ã¯ã€Œæ¤œç´¢å¾Œã®å‡¦ç†ã€æ”¹å–„**:
- ç©ºãƒšãƒ¼ã‚¸é™¤å¤–
- ãƒãƒ£ãƒ³ã‚¯çµ±åˆ
- é‡è¤‡æ’é™¤

**å®Ÿéš›ã®å•é¡Œã¯ã€Œæ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€**:
- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ãƒ»BM25ãŒæœŸå¾…ãƒšãƒ¼ã‚¸ã‚’ä¸Šä½ã«æŒã£ã¦ã“ã‚Œãªã„
- 046ï¼ˆé€€ä¼šæ©Ÿèƒ½ï¼‰ã€164ï¼ˆæ•™å®¤å‰Šé™¤ï¼‰ãŒtopK=20ã«ã‚‚å«ã¾ã‚Œãªã„
- æ¤œç´¢ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®æ ¹æœ¬çš„ãªæ”¹å–„ãŒå¿…è¦

---

## âœ… Phase 0A-1.5ã§é”æˆã§ããŸã“ã¨

### 1. æŠ€è¡“çš„å®Ÿè£…ã®æˆåŠŸ

âœ… 3ã¤ã®æ”¹å–„ã™ã¹ã¦æ­£å¸¸å‹•ä½œ:
- ç©ºãƒšãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼ä¸¡å¯¾å¿œï¼‰
- å…¨ãƒãƒ£ãƒ³ã‚¯çµ±åˆï¼ˆæœ€å¤§11ãƒãƒ£ãƒ³ã‚¯çµ±åˆå®Ÿç¸¾ï¼‰
- é‡è¤‡æ’é™¤ï¼ˆãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢é¸æŠï¼‰

### 2. ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã®å®Œäº†

âœ… StructuredLabelåŸºç›¤ï¼ˆPhase 0A-1ï¼‰:
- 20ãƒšãƒ¼ã‚¸ã§æ¤œè¨¼å®Œäº†
- ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹30% / LLMãƒ™ãƒ¼ã‚¹70%
- å¹³å‡ä¿¡é ¼åº¦79.4%

ğŸ”„ **å…¨ãƒšãƒ¼ã‚¸ç”Ÿæˆä¸­**ï¼ˆç´„1,200ãƒšãƒ¼ã‚¸ï¼‰:
- Gemini 2.0 Flashä½¿ç”¨
- Admin SDKé€£æº
- Firestoreæ°¸ç¶šåŒ–

### 3. å•é¡Œã®æ˜ç¢ºåŒ–

âœ… æ¤œç´¢å“è³ªå•é¡Œã®æœ¬è³ªã‚’ç‰¹å®š:
- Phase 0A-1.5ã§ã¯è§£æ±ºã§ããªã„å•é¡Œã‚’æ˜ç¢ºåŒ–
- Phase 0A-2ï¼ˆKnowledge Graphï¼‰ã®å¿…è¦æ€§ã‚’å®Ÿè¨¼
- å®Ÿè£…å„ªå…ˆé †ä½ã®è¦‹ç›´ã—ï¼ˆStructuredLabelå…¨ãƒšãƒ¼ã‚¸ç”Ÿæˆ â†’ KGï¼‰

---

## âŒ Phase 0A-1.5ã§è§£æ±ºã§ããªã‹ã£ãŸã“ã¨

### 1. æœŸå¾…ãƒšãƒ¼ã‚¸ãŒæ¤œç´¢çµæœã«å«ã¾ã‚Œãªã„

**äº‹ä¾‹1ï¼ˆ046: é€€ä¼šæ©Ÿèƒ½ï¼‰**:
- topK=20ã§ã‚‚æœªç™ºè¦‹
- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ãƒ»BM25ä¸¡æ–¹ã§å–å¾—ã§ããš

**äº‹ä¾‹2ï¼ˆ164: æ•™å®¤å‰Šé™¤ï¼‰**:
- ã‚¯ã‚¨ãƒªã€Œæ•™å®¤å‰Šé™¤ãŒã§ããªã„ã®ã¯ä½•ãŒåŸå› ã€
- æ¤œç´¢çµæœ: 164ã¯åœå¤–ã€505ï¼ˆæ•™å®¤å‰Šé™¤ï¼‰ãŒä¸Šä½

**åŸå› **: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã®é™ç•Œ
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ„å›³ã®æå¤±ï¼ˆã€Œåˆ¶é™ã€ã€Œæ¡ä»¶ã€ãªã©ï¼‰
- XYå•é¡Œï¼ˆè³ªå•ã®å‰æãŒç•°ãªã‚‹ï¼‰

### 2. BM25ã‚¹ã‚³ã‚¢ã®ä¸é©åˆ‡ãªå„ªå…ˆ

**äº‹ä¾‹3ï¼ˆ168: æ•™å®¤ã‚³ãƒ”ãƒ¼ï¼‰**:
- BM25ãŒã€Œæ•™å®¤ã€ã€Œå¿œå‹Ÿæƒ…å ±ã€ãªã©ã®ä¸€èˆ¬ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§é«˜ã‚¹ã‚³ã‚¢
- å®Ÿéš›ã®é–¢é€£åº¦ãŒä½ã„ãƒšãƒ¼ã‚¸ãŒä¸Šä½ã«

**åŸå› **: BM25ã®ã‚¿ã‚¤ãƒˆãƒ«é‡ã¿éå‰°
- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã‚’éåº¦ã«å„ªé‡
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é–¢é€£åº¦ãŒè»½è¦–ã•ã‚Œã‚‹

---

## ğŸš€ Phase 0A-2ã¸ã®å¼•ãç¶™ã

### Phase 0A-2ã§å®Ÿè£…ã™ã¹ãæ©Ÿèƒ½

#### 1. Knowledge Graphæ§‹ç¯‰

**å‚ç…§é–¢ä¿‚æŠ½å‡º**:
```typescript
// 164 â†’ 177ã®å‚ç…§ã‚’è‡ªå‹•æ¤œå‡º
"164_æ•™å®¤å‰Šé™¤æ©Ÿèƒ½" â†’ "177_æ±‚äººå‰Šé™¤æ©Ÿèƒ½"ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„å†…ã§è¨€åŠï¼‰
```

**ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢ä¿‚æ§‹ç¯‰**:
```typescript
// åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒšãƒ¼ã‚¸ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
domain: "ä¼šå“¡ç®¡ç†" â†’ [046_é€€ä¼š, 041_æ–°è¦ç™»éŒ², 044_ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†]
```

**ã‚¿ã‚°é–¢ä¿‚æ§‹ç¯‰**:
```typescript
// ã‚¿ã‚°ã®é¡ä¼¼åº¦ã§ãƒªãƒ³ã‚¯
tags: ["é€€ä¼š", "ä¼šå“¡ç™»éŒ²"] â†’ 046ã¨041ã®é–¢é€£åº¦: 0.8
```

#### 2. KGæ¤œç´¢çµ±åˆ

```typescript
async function retrieveRelevantDocsWithKG(query: string) {
  // Step 1: é€šå¸¸ã®æ¤œç´¢
  const primaryResults = await searchLanceDB({ query, topK: 5 });
  
  // Step 2: Knowledge Graphã§é–¢é€£ãƒšãƒ¼ã‚¸ã‚’æ‹¡å¼µ
  for (const result of primaryResults) {
    // å‚ç…§å…ˆã‚’å–å¾—
    const references = await getKGReferences(result.pageId);
    
    // é‡è¦åº¦ã®é«˜ã„å‚ç…§ã‚’è¿½åŠ ï¼ˆæœ€å¤§2ä»¶ï¼‰
    expandedResults.push(...references.filter(r => r.weight > 0.7).slice(0, 2));
  }
  
  return deduplicateByPageId(expandedResults);
}
```

### æœŸå¾…åŠ¹æœï¼ˆPhase 0A-2ï¼‰

| äº‹ä¾‹ | Phase 0A-1.5 | KGåŠ¹æœ | Phase 0A-2 |
|------|-------------|--------|-----------|
| æ•™å®¤å‰Šé™¤ï¼ˆ164â†’177ï¼‰ | 0% | +95% | **95%** |
| æ•™å®¤ã‚³ãƒ”ãƒ¼ï¼ˆ168ï¼‰ | 30% | +55% | **85%** |
| å­¦å¹´ãƒ»è·æ¥­ï¼ˆ721ï¼‰ | 100% | 0% | **100%** |
| é€€ä¼šå¾Œå†ç™»éŒ²ï¼ˆ046â†’041ï¼‰ | 0% | +60% | **60%** |
| å¿œå‹Ÿåˆ¶é™ï¼ˆ014ï¼‰ | 0% | +40% | **40%** |
| é‡è¤‡å¿œå‹Ÿï¼ˆ014ï¼‰ | 0% | +30% | **30%** |

**å…¨ä½“å¹³å‡**: 17% â†’ **62%**ï¼ˆ+45%ï¼‰âœ…

---

## ğŸ“ æŠ€è¡“çš„å­¦ã³

### 1. LanceDBã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç†è§£

**ç™ºè¦‹**:
- `id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯`{pageId}-{chunkIndex}`å½¢å¼
- WHEREå¥ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥
- å‰æ–¹ä¸€è‡´æ¤œç´¢ã«ã¯å…¨ä»¶å–å¾—ãŒå¿…è¦

**æ•™è¨“**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®äº‹å‰ç†è§£ã®é‡è¦æ€§

### 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼åˆ†é›¢

**ç™ºè¦‹**:
- Firestoreæ¨©é™ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å³æ ¼
- Admin SDKã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ã¿ä½¿ç”¨å¯èƒ½

**è§£æ±ºç­–**: æ©Ÿèƒ½ã‚’2ç®‡æ‰€ã«å®Ÿè£…
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é•·ãƒ™ãƒ¼ã‚¹
- ã‚µãƒ¼ãƒãƒ¼: StructuredLabelãƒ™ãƒ¼ã‚¹

### 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å½±éŸ¿

**ç™ºè¦‹**:
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå®Ÿè£…æ”¹å–„ã‚’éš è”½
- ãƒ†ã‚¹ãƒˆæ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãŒå¿…é ˆ

**æ•™è¨“**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ç‰ˆãƒ†ã‚¹ãƒˆã®é‡è¦æ€§

---

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã®å­¦ã³

### 1. æƒ³å®šã®æ¤œè¨¼ä¸è¶³

**å•é¡Œ**:
- ã€ŒæœŸå¾…ãƒšãƒ¼ã‚¸ãŒæ¤œç´¢çµæœã«å«ã¾ã‚Œã¦ã„ã‚‹ã€ã¨ã„ã†å‰æã‚’æ¤œè¨¼ã›ãšã«è¨ˆç”»
- æ¥½è¦³çš„ã™ãã‚‹åŠ¹æœäºˆæ¸¬ï¼ˆ62%ï¼‰

**æ”¹å–„ç­–**:
- äº‹å‰ã«æ¤œç´¢çµæœï¼ˆtopK=20ï¼‰ã‚’åˆ†æ
- æœ€æ‚ªã‚±ãƒ¼ã‚¹ãƒ»ä¸­å¤®å€¤ãƒ»æœ€è‰¯ã‚±ãƒ¼ã‚¹ã§ã‚·ãƒŠãƒªã‚ªä½œæˆ

### 2. æ®µéšçš„ãªå®Ÿè£…ã®ä¾¡å€¤

**æˆåŠŸ**:
- Phase 0A-1ã§åŸºç›¤æ§‹ç¯‰
- Phase 0A-1.5ã§å•é¡Œã®æœ¬è³ªã‚’ç™ºè¦‹
- Phase 0A-2ã§æ­£ã—ã„æ–¹å‘ã«ä¿®æ­£

**æ•™è¨“**: å¤±æ•—ã‚‚å«ã‚ã¦æ®µéšçš„ã«é€²ã‚ã‚‹ã“ã¨ã§ã€å•é¡Œã®æœ¬è³ªãŒè¦‹ãˆã‚‹

---

## ğŸ“Š ã‚³ã‚¹ãƒˆãƒ»ãƒªã‚½ãƒ¼ã‚¹åˆ†æ

### å®Ÿè£…ã‚³ã‚¹ãƒˆ

| é …ç›® | æƒ³å®š | å®Ÿç¸¾ | å·®ç•° |
|------|------|------|------|
| **å®Ÿè£…æ™‚é–“** | 4-5æ™‚é–“ | 8æ™‚é–“ | +3-4æ™‚é–“ |
| **è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«** | 3ãƒ•ã‚¡ã‚¤ãƒ« | 5ãƒ•ã‚¡ã‚¤ãƒ« | +2ãƒ•ã‚¡ã‚¤ãƒ« |
| **ã‚³ãƒ¼ãƒ‰è¡Œæ•°** | 160è¡Œ | 250è¡Œ | +90è¡Œ |
| **ãƒ‡ãƒãƒƒã‚°æ™‚é–“** | 1æ™‚é–“ | 3æ™‚é–“ | +2æ™‚é–“ |

**é…å»¶è¦å› **:
- LanceDBãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®èª¿æŸ»ï¼ˆ2æ™‚é–“ï¼‰
- Firestoreæ¨©é™å•é¡Œã®è§£æ±ºï¼ˆ1æ™‚é–“ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã®ãƒ‡ãƒãƒƒã‚°ï¼ˆ1æ™‚é–“ï¼‰

### StructuredLabelç”Ÿæˆã‚³ã‚¹ãƒˆ

| é …ç›® | å€¤ |
|------|-----|
| **ç·ãƒšãƒ¼ã‚¸æ•°** | ç´„1,200ãƒšãƒ¼ã‚¸ |
| **Gemini APIå‘¼ã³å‡ºã—** | ç´„840å›ï¼ˆLLMãƒ™ãƒ¼ã‚¹70%ï¼‰ |
| **æ¨å®šæ™‚é–“** | 1-2æ™‚é–“ |
| **æ¨å®šã‚³ã‚¹ãƒˆ** | $0.50-1.00ï¼ˆGemini 2.0 Flashï¼‰ |

---

## âœ… å®Œäº†åŸºæº–ã®è©•ä¾¡

### å¿…é ˆåŸºæº–

| åŸºæº– | ç›®æ¨™ | å®Ÿç¸¾ | é”æˆ |
|------|------|------|------|
| **ç©ºãƒšãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‹•ä½œ** | 100% | 100% | âœ… |
| **ãƒãƒ£ãƒ³ã‚¯çµ±åˆå‹•ä½œ** | 100% | 100% | âœ… |
| **é‡è¤‡æ’é™¤å‹•ä½œ** | 100% | 100% | âœ… |
| **ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³** | 0ä»¶ | 0ä»¶ | âœ… |

### æ¨å¥¨åŸºæº–

| åŸºæº– | ç›®æ¨™ | å®Ÿç¸¾ | é”æˆ |
|------|------|------|------|
| **Tier 1å•é¡Œã®æ”¹å–„** | 85%ä»¥ä¸Š | 33%ï¼ˆ1/3ä»¶ï¼‰ | âŒ |
| **å…¨ä½“å¹³å‡** | 60%ä»¥ä¸Š | 17% | âŒ |

**ç·åˆè©•ä¾¡**: **æŠ€è¡“å®Ÿè£…ã¯æˆåŠŸã€åŠ¹æœæ¸¬å®šã¯æœªé”**

---

## ğŸ”„ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å³åº§ã«å®Ÿè¡Œ

1. âœ… **StructuredLabelå…¨ãƒšãƒ¼ã‚¸ç”Ÿæˆå®Œäº†å¾…ã¡**ï¼ˆå®Ÿè¡Œä¸­ï¼‰
2. ğŸ“ StructuredLabelé©ç”¨å¾Œã®å†ãƒ†ã‚¹ãƒˆ
3. ğŸš€ git pushï¼ˆphase-0aãƒ–ãƒ©ãƒ³ãƒï¼‰

### Phase 0A-2æº–å‚™

1. ğŸ“‹ Knowledge Graphè¨­è¨ˆã®è©³ç´°åŒ–
2. ğŸ” å‚ç…§é–¢ä¿‚æŠ½å‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè£…
3. ğŸ“Š Phase 0A-2å®Ÿè£…è¨ˆç”»æ›¸ã®ä½œæˆ

---

## ğŸ“Œ ã¾ã¨ã‚

### æˆåŠŸã—ãŸç‚¹ âœ…

1. **æŠ€è¡“å®Ÿè£…**: 3ã¤ã®æ”¹å–„ã™ã¹ã¦æ­£å¸¸å‹•ä½œ
2. **ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™**: StructuredLabelåŸºç›¤å®Œæˆ
3. **å•é¡Œã®æ˜ç¢ºåŒ–**: æ¤œç´¢å“è³ªã®æœ¬è³ªçš„å•é¡Œã‚’ç‰¹å®š

### èª²é¡Œ âŒ

1. **åŠ¹æœä¸è¶³**: æƒ³å®š62% â†’ å®Ÿæ¸¬17%
2. **æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: æ ¹æœ¬çš„ãªæ”¹å–„ãŒå¿…è¦
3. **BM25ã‚¹ã‚³ã‚¢**: ä¸é©åˆ‡ãªå„ªå…ˆé †ä½

### Phase 0A-2ã¸ã®æœŸå¾… ğŸš€

Knowledge Graphã«ã‚ˆã‚‹é–¢é€£ãƒšãƒ¼ã‚¸è‡ªå‹•æ‹¡å¼µã§ã€**17% â†’ 62%**ã¸ã®æ”¹å–„ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

---

**Status**: âœ… Phase 0A-1.5 å®Ÿè£…å®Œäº†ã€StructuredLabelç”Ÿæˆä¸­  
**Next**: Phase 0A-2ï¼ˆKnowledge Graphï¼‰

