# ハイブリッド検索フローと並行実行の分析

**作成日**: 2025年10月15日  
**Phase**: Phase 0A-2  
**ステータス**: 並行実行は未実装（順次実行）

---

## 🔄 現在のハイブリッド検索フロー

### 全体フロー（順次実行）

```
┌─────────────────────────────────────────────────────────────┐
│ Phase 1: 事前処理（順次）                    所要時間: 50-100ms │
├─────────────────────────────────────────────────────────────┤
│ 1. キャッシュチェック                                  10ms    │
│ 2. Lunr初期化確認                                      10ms    │
│ 3. エンベディング生成（キャッシュヒット時）              30ms    │
│ 4. キーワード抽出                                      20ms    │
│ 5. LanceDB接続                                        10ms    │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Phase 2: ベクトル検索（順次）                所要時間: 150-350ms │
├─────────────────────────────────────────────────────────────┤
│ 1. ベクトル検索実行（200件）                          100-300ms │
│ 2. 距離閾値フィルタリング                                10ms    │
│ 3. ラベルフィルタリング                                  10ms    │
│ 4. タイトルブースト適用                                  20ms    │
│ 5. 結果数制限（topK=50）                                 5ms    │
└─────────────────────────────────────────────────────────────┘
                         ↓ ⚠️ 待機（並行実行していない）
┌─────────────────────────────────────────────────────────────┐
│ Phase 3: BM25検索（順次）                    所要時間: 400-800ms │
├─────────────────────────────────────────────────────────────┤
│ ループ: 各キーワード（5個）                                       │
│   1. トークン化（日本語）                            20-50ms/回 │
│   2. Lunr検索                                      50-100ms/回 │
│   3. 結果をマージ                                     10ms/回  │
│ → 合計: 5 × (70-150ms) = 350-750ms                            │
│                                                                 │
│ 4. タイトルブースト適用                                  20ms    │
│ 5. ラベルフィルタリング                                  10ms    │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Phase 4: 結果処理（順次）                    所要時間: 500-1,000ms │
├─────────────────────────────────────────────────────────────┤
│ 1. ベクトル結果のスコア計算（50件 × 5-10ms）      250-500ms     │
│ 2. BM25結果のマージとスコア計算                   250-500ms     │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Phase 5: RRF融合 + 複合スコアリング（順次）  所要時間: 550-860ms │
├─────────────────────────────────────────────────────────────┤
│ 1. RRF融合（4つの順位を統合）                        50-100ms    │
│ 2. 複合スコアリング適用                              500-750ms   │
│    - StructuredLabel処理含む                                   │
│ 3. ソートと上位topK件を選択                            5-10ms    │
└─────────────────────────────────────────────────────────────┘
                         ↓
                    結果返却（1,140ms）
```

---

## ❌ 並行実行の現状

### 問題1: ベクトル検索とBM25検索が順次実行

**現在のコード**:
```typescript
// ベクトル検索（350ms）
vectorResults = await vectorQuery.limit(200).toArray();

// ↓ 待機（無駄な遅延）

// BM25検索（500ms）
for (const keyword of searchKeywords) {
  const results = await lunrSearchClient.searchCandidates(...);
}
```

**改善案（未実装）**:
```typescript
const [vectorResults, bm25Results] = await Promise.all([
  vectorQuery.limit(200).toArray(),  // 350ms
  performBM25Search(searchKeywords)  // 500ms (並行)
]);
// 合計: max(350ms, 500ms) = 500ms（-41%削減）
```

**未実装の理由**: Lunr初期化タイミングの問題

---

### 問題2: BM25の複数キーワード検索が順次

**現在のコード**:
```typescript
for (const keyword of searchKeywords) {  // 5キーワード
  const tokenized = await tokenizeJapaneseText(keyword);  // 35ms
  const results = await lunrSearchClient.searchCandidates(tokenized, kwCap);  // 75ms
}
// 合計: 5 × 110ms = 550ms
```

**改善案（未実装）**:
```typescript
const keywordResults = await Promise.all(
  searchKeywords.map(async keyword => {
    const tokenized = await tokenizeJapaneseText(keyword);
    return lunrSearchClient.searchCandidates(tokenized, kwCap);
  })
);
// 合計: max(110ms) = 110ms（-80%削減）
```

**未実装の理由**: 実装試行時にBM25が動作しなくなった

---

## 🕵️ 並行実行が困難な理由

### 技術的な制約

1. **Lunr初期化の非同期性**
   - Lunr indexは事前に初期化が必要
   - 並行実行ブロック内での初期化状態チェックが不安定

2. **トークン化の依存性**
   - 日本語トークン化（Kuromoji）が非同期
   - 各キーワードのトークン化結果が相互に独立していない可能性

3. **LanceDB接続の共有**
   - Vector検索とBM25検索が同じLanceDB接続を使用
   - 接続の並行アクセスに問題がある可能性

---

## 📊 現在のパフォーマンス内訳

### 事例6（学年・職業更新）の実測タイミング

```
事前処理:           50ms
───────────────────────────
ベクトル検索:      350ms  ⏱️
  ├─ LanceDB query:     300ms
  ├─ フィルタリング:      30ms
  └─ タイトルブースト:     20ms
───────────────────────────
⚠️ 待機（並行実行していない）
───────────────────────────
BM25検索:          500ms  ⏱️
  ├─ キーワード1:        100ms
  ├─ キーワード2:        100ms
  ├─ キーワード3:        100ms
  ├─ キーワード4:        100ms
  └─ キーワード5:        100ms
───────────────────────────
結果処理:          100ms
RRF融合:            50ms
複合スコアリング:   90ms
───────────────────────────
合計:            1,140ms  ✅
```

**並行実行時の理論値**:
```
事前処理:           50ms
───────────────────────────
並行検索:          500ms  ⚡（Vector || BM25）
  ├─ Vector:           350ms (並行)
  └─ BM25:             500ms (並行)
       ├─ 全キーワード:  100ms (並行)
       └─ Lunr検索:     各75ms (並行)
───────────────────────────
結果処理:          100ms
RRF融合:            50ms
複合スコアリング:   60ms (最適化済み)
───────────────────────────
合計:              760ms  🎯 (-33%削減)
```

---

## 🚨 KG拡張の問題

### 現状

```
KG拡張時間: 7,184ms
KGオーバーヘッド: 84%
合計時間: 8,550ms

KG分析結果:
  - Top 10にKGノード: 0/10件
  - 潜在的エッジ数: 0本
  - 貢献度: 確認できず
```

### 結論

**KG拡張は高コスト・低効果**
- 合計時間の84%を占有
- 検索結果への貢献が確認できない
- **無効化を強く推奨**

---

## 🎯 推奨アクション（優先度順）

### 優先度1: KG拡張の無効化 ⚡ **即座に実施可能**

**実装難易度**: ★☆☆☆☆（非常に簡単）  
**期待効果**: **合計時間 -84%削減**（8,550ms → 1,367ms）  
**リスク**: 低（現在貢献していないため）

**実装方法**:
```typescript
// scripts/performance-test-phase-0a-2.ts（該当箇所を削除またはコメントアウト）

// Before:
const expandedResults = await expandWithKnowledgeGraph(filtered.slice(0, 8), kgMetrics);

// After:
const expandedResults = filtered; // KG拡張を無効化
```

---

### 優先度2: 並行実行の実装（技術的課題あり）

**実装難易度**: ★★★★☆（難しい）  
**期待効果**: **検索時間 -33%削減**（1,140ms → 760ms）  
**リスク**: 高（発見率が0%に低下した実績あり）

**必要な調査**:
1. Lunr初期化タイミングの最適化
2. LanceDB接続の並行アクセス対応
3. トークン化処理の並行実行可能性確認

**推奨**: 優先度1（KG無効化）を先に実施し、その後に検討

---

### 優先度3: Phase 3 実装（ラベル生成）

**実装難易度**: ★★☆☆☆（中程度）  
**期待効果**: **発見率 +8%向上**（83% → 90%+）  
**リスク**: 低

---

## 📋 まとめ

### 現在のフロー

✅ **完全に順次実行**
- ベクトル検索 → BM25検索 → 結果処理 → RRF融合 → 複合スコアリング
- 各フェーズが前のフェーズの完了を待つ

❌ **並行実行は未実装**
- ベクトル検索とBM25検索の並行実行は技術的に困難
- 実装試行時にBM25が動作しなくなった

⚠️ **KGが最大のボトルネック**
- 84%のオーバーヘッド
- 貢献度が確認できない
- **無効化が最優先**

### 推奨実装順序

1. **Week 1**: KG拡張無効化（合計時間 -84%）
2. **Week 2-3**: Phase 3 実装（発見率 +8%）
3. **Month 2以降**: 並行実行の再検討（技術的課題を解決後）

---

**次のアクション**: KG拡張を無効化して、パフォーマンステストを実行することを強く推奨します。

