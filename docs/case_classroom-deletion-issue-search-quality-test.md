# 教室削除問題検索品質テスト仕様書

## 概要

「教室削除ができないのは何が原因ですか」クエリを品質基準として、検索システムの抽出ページと出力結果の品質を評価するテスト仕様書です。

## テスト対象クエリ

**メインクエリ:** `教室削除ができないのは何が原因ですか`

## 品質基準

### 1. 理想の抽出ページ（NotebookLMの出力に基づく）

#### 1.1 主要な教室削除機能ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `164_【FIX】教室削除機能` | 90+ | `["機能要件"]` | メインの教室削除機能 |
| `教室削除の制限条件` | 85+ | `["機能要件"]` | 削除制限条件の詳細 |
| `教室削除エラー処理` | 80+ | `["機能要件"]` | 削除エラーの処理 |

#### 1.2 求人関連制限ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `求人掲載状態管理` | 80+ | `["機能要件"]` | 求人の掲載状態管理 |
| `求人非掲載機能` | 75+ | `["機能要件"]` | 求人の非掲載機能 |
| `教室と求人の紐づけ管理` | 70+ | `["機能要件"]` | 教室と求人の関連管理 |

#### 1.3 応募情報関連制限ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `【FIX】応募情報` | 85+ | `["機能要件"]` | 応募情報の管理 |
| `応募履歴管理` | 80+ | `["機能要件"]` | 応募履歴の管理 |
| `採用ステータス管理` | 75+ | `["機能要件"]` | 採用ステータスの管理 |
| `採用決定日管理` | 70+ | `["機能要件"]` | 採用決定日の管理 |

#### 1.4 削除制限条件ページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `教室削除前チェック機能` | 75+ | `["機能要件"]` | 削除前の条件チェック |
| `論理削除機能` | 70+ | `["機能要件"]` | 論理削除の実装 |
| `削除権限管理` | 65+ | `["機能要件"]` | 削除権限の管理 |

#### 1.5 エラーハンドリングページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `教室削除エラーメッセージ` | 70+ | `["機能要件"]` | 削除エラーメッセージ |
| `削除制限通知機能` | 65+ | `["機能要件"]` | 削除制限の通知 |
| `削除可能性チェック機能` | 60+ | `["機能要件"]` | 削除可能性の事前チェック |

### 2. 除外されるべきページ

#### 2.1 フォルダラベルページ（除外対象）

| ページタイトル | ラベル | 除外理由 |
|---|---|---|---|
| `■教室管理機能` | `["フォルダ"]` | フォルダラベル |
| `■削除機能` | `["機能要件", "フォルダ"]` | フォルダラベル |
| `■エラーハンドリング` | `["機能要件", "フォルダ"]` | フォルダラベル |

#### 2.2 関連性の低いページ（除外対象）

| ページタイトル | ラベル | 除外理由 |
|---|---|---|---|
| `教室統計データ` | `["帳票"]` | 教室削除の問題とは直接関係なし |
| `教室作成ログ` | `["ログ"]` | 教室削除の問題とは直接関係なし |
| `【作成中】教室復元機能` | `["共通要件"]` | 教室削除の問題とは直接関係なし |

#### 2.3 物理削除関連ページ（除外対象）

| ページタイトル | ラベル | 除外理由 |
|---|---|---|---|
| `教室物理削除機能` | `["機能要件"]` | 論理削除が対象のため除外 |
| `データ完全削除機能` | `["機能要件"]` | 論理削除が対象のため除外 |

## テストケース

### テストケース1: 基本検索テスト

**クエリ:** `教室削除ができないのは何が原因ですか`

**期待される結果:**
- 抽出ページ数: 8-12件
- 上位3件に主要な教室削除機能ページが含まれる
- フォルダラベルページが除外される
- 関連性の低いページが除外される
- 物理削除関連ページが除外される

**合格基準:**
- 主要な教室削除機能ページ（1.1）のうち3件以上が検索結果に含まれる
- 除外されるべきページ（2.1, 2.2, 2.3）が検索結果に含まれない
- 上位3件のスコアが80以上

### テストケース2: キーワードマッチングテスト

**クエリ:** `教室削除ができないのは何が原因ですか`

**期待されるキーワード抽出:**
- 基本キーワード: `["教室", "削除", "できない", "原因"]`
- 分割キーワード: `["教室削除", "削除できない", "削除問題", "削除制限"]`
- LLM拡張キーワード: 教室削除の問題に関連する同義語

**理想のキーワード抽出結果:**
```json
{
  "keywords": [
    "教室削除", "削除できない", "削除問題", "削除制限", 
    "教室", "削除", "求人掲載", "応募情報", "採用ステータス", 
    "削除条件", "削除エラー", "削除制限条件"
  ],
  "highPriority": ["教室削除", "削除できない", "削除問題", "削除制限"],
  "lowPriority": ["教室", "削除", "求人掲載", "応募情報", "採用ステータス", "削除条件", "削除エラー", "削除制限条件"]
}
```

**合格基準:**
- キーワードスコアが0でない
- 分割されたキーワードが正しく抽出される
- タイトルマッチングが正しく動作する
- 理想のキーワード抽出結果に近い結果が得られる
- キーワード数が8個以上
- 教室削除の問題に関連する具体的な機能名が含まれる

### テストケース3: スコアリングテスト

**クエリ:** `教室削除ができないのは何が原因ですか`

**期待されるスコア分布:**
- 主要な教室削除機能ページ: 85-95点
- 求人関連制限ページ: 75-90点
- 応募情報関連制限ページ: 80-90点
- 削除制限条件ページ: 70-85点
- エラーハンドリングページ: 65-80点

**合格基準:**
- スコアが期待値の±10点以内
- スコアの順序が期待される優先度と一致

### テストケース4: 問題原因分類テスト

**クエリ:** `教室削除ができないのは何が原因ですか`

**期待される問題原因分類:**
1. **求人掲載状態の問題**
   - 求人が掲載中である
   - 求人の非掲載処理が必要

2. **応募情報の問題**
   - 応募情報が存在する
   - 採用ステータスが未登録・保留
   - 採用決定日から1年以内

3. **削除制限条件の問題**
   - 削除前チェックで条件未満
   - 削除権限の問題

4. **エラーハンドリングの問題**
   - 削除エラーの発生
   - 削除制限の通知

**合格基準:**
- 各問題原因分類から適切なページが抽出される
- 求人掲載状態の問題ページが2件以上
- 応募情報の問題ページが3件以上
- 削除制限条件の問題ページが2件以上
- エラーハンドリングの問題ページが1件以上

### テストケース5: 制限条件テスト

**クエリ:** `教室削除ができないのは何が原因ですか`

**期待される制限条件ページ:**
- 求人掲載状態の制限
- 応募情報の制限
- 採用ステータスの制限
- 採用決定日の制限
- 削除前チェックの制限

**合格基準:**
- 制限条件関連ページが5件以上抽出される
- 求人掲載状態の制限が含まれる
- 応募情報の制限が含まれる
- 採用ステータスの制限が含まれる

## 品質メトリクス

### 1. 検索精度（Precision）

```
Precision = 関連するページ数 / 検索結果総数
```

**目標値:** 0.8以上

### 2. 検索再現率（Recall）

```
Recall = 検索結果に含まれる関連ページ数 / 理想の関連ページ総数
```

**目標値:** 0.7以上

### 3. F1スコア

```
F1 = 2 × (Precision × Recall) / (Precision + Recall)
```

**目標値:** 0.75以上

### 4. 平均スコア

```
Average Score = 検索結果のスコア合計 / 検索結果数
```

**目標値:** 80以上

### 5. 問題原因分類カバレッジ

```
Coverage = 抽出された問題原因分類数 / 理想の問題原因分類数
```

**目標値:** 0.8以上（4分類中3.2以上）

### 6. 制限条件カバレッジ

```
Restriction Coverage = 抽出された制限条件数 / 理想の制限条件数
```

**目標値:** 0.8以上（5条件中4以上）

## テスト実行手順

### 1. 事前準備

```bash
# 検索システムの起動
npm run dev

# テストデータの確認
npx tsx -e "import { searchLanceDB } from './src/lib/lancedb-search-client'; searchLanceDB({ query: '教室削除ができないのは何が原因ですか', topK: 20 }).then(r => console.log('Search results:', r.map(x => ({ title: x.title, score: x.score, labels: x.labels }))))"
```

### 2. テスト実行

```bash
# テストスクリプトの実行
npx tsx src/tests/classroom-deletion-issue-search-test.ts
```

### 3. 結果評価

1. 検索結果の確認
2. スコアの検証
3. 除外ページの確認
4. 問題原因分類の確認
5. 制限条件の確認
6. メトリクスの計算

## 品質改善の指針

### 1. キーワード抽出の改善

- 分割キーワードの精度向上
- 教室削除問題関連の同義語拡張
- ストップワードの最適化

### 2. スコアリングの改善

- タイトルマッチングの重み調整
- コンテンツマッチングの精度向上
- ラベルマッチングの最適化

### 3. フィルタリングの改善

- ラベルフィルタリングの精度向上
- 関連性の低いページの除外
- 物理削除関連ページの除外

### 4. 問題原因分類の改善

- 求人掲載状態問題の識別精度向上
- 応募情報問題の適切な分類
- 削除制限条件問題の分類

### 5. 制限条件の改善

- 制限条件関連ページの識別精度向上
- 削除前チェック機能の適切な抽出
- エラーハンドリング機能の分類

## 継続的改善

### 1. 定期的なテスト実行

- 週次での品質テスト実行
- 月次でのメトリクス分析

### 2. フィードバックの収集

- ユーザーフィードバックの収集
- 検索結果の品質評価

### 3. アルゴリズムの改善

- テスト結果に基づくパラメータ調整
- 新しい検索手法の導入

## 参考資料

- [NotebookLMの出力結果](./classroom-deletion-issue-notebooklm-output.md)
- [検索チューニング計画](./search-tuning-plan.md)
- [検索チューニング結果](./search-tuning-results.md)
- [教室管理検索品質テスト](./classroom-management-search-quality-test.md)
- [オファー機能検索品質テスト](./offer-function-search-quality-test.md)
- [会員ログイン機能検索品質テスト](./member-login-function-search-quality-test.md)
