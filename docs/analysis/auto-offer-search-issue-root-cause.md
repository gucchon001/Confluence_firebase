# 「自動オファー」が検索結果に出てこない原因分析

**調査日**: 2025年11月5日  
**影響度**: 中（検索品質に影響）  
**状態**: 原因特定完了

---

## 📋 問題の概要

「自動オファー」関連のドキュメントが検索結果の参照元として表示されない。

**対象ドキュメント**:
- 194_【FIX】自動オファー設定機能 (Page ID: 704446530)
- 562_【FIX】自動オファー条件設定機能 (Page ID: 705200188)
- 561_【FIX】自動オファー送信状況閲覧機能 (Page ID: 705265747)
- 742_【作成中】自動オファー送信バッチ (Page ID: 743473796)
- 【FIX】オファー設定情報（自動オファー） (Page ID: 697827329)

---

## 🔍 調査結果

### ステップ1: ドキュメントの存在確認 ✅

**結果**: すべてのドキュメントがLanceDBに存在することを確認
- タイトルに「自動オファー」を含むドキュメント: 9件
- コンテンツに「自動オファー」を含むドキュメント: 10件
- すべての対象ドキュメントがLanceDBに存在

### ステップ2: ベクトル距離の確認 ✅

**結果**: すべての対象ドキュメントの距離が100位以内に入ることを確認

| タイトル | Page ID | 距離 | 100位の距離 | 100位以内 |
|---------|---------|------|------------|----------|
| 194_【FIX】自動オファー設定機能 | 704446530 | 0.4774 | 0.8380 | ✅ |
| 562_【FIX】自動オファー条件設定機能 | 705200188 | 0.4663 | 0.8380 | ✅ |
| 561_【FIX】自動オファー送信状況閲覧機能 | 705265747 | 0.4383 | 0.8380 | ✅ |
| 742_【作成中】自動オファー送信バッチ | 743473796 | 0.4427 | 0.8380 | ✅ |
| 【FIX】オファー設定情報（自動オファー） | 697827329 | 0.4625 | 0.8380 | ✅ |

**重要な発見**:
- すべての対象ドキュメントの距離（0.4383〜0.4774）は、100位の距離（0.8380）より小さい
- つまり、ベクトル検索の結果100件には含まれるはず

### ステップ3: 実際の検索結果との比較 ❌

**結果**: 実際のベクトル検索結果（101件）に対象ドキュメントが含まれていない

**問題点**:
- 距離が100位以内に入るはずなのに、検索結果に含まれていない
- これは、ベクトル検索の結果に含まれていないことを示している

### ステップ4: BM25検索での確認 ❌

**結果**: すべての対象ドキュメントがLunr検索に含まれていない

**問題点**:
- タイトルに「自動オファー」が含まれているのに、Lunr検索で検出されていない
- これは、Lunrインデックスに正しく登録されていない可能性がある

---

## 🎯 根本原因（確定）

### ✅ 原因1: ベクトルインデックス（IVF_PQ）の近似検索の問題

**問題の詳細**:
- すべての対象ドキュメントの距離（0.4383〜0.4774）は、100位の距離（0.8380）より小さい
- しかし、ベクトル検索の結果100件には含まれていない
- これは、ベクトルインデックス（IVF_PQ）の近似検索の特性によるもの

**IVF_PQ（近似検索）の特性**:
- **近似検索**: 正確な距離順位を保証しない
- **パーティション選択**: パーティションの選択により、一部のベクトルが検索対象から外れる可能性がある
- **距離計算の誤差**: インデックス使用時の距離計算と直接計算の距離に差がある可能性

**影響を受けるドキュメント**:
1. 194_【FIX】自動オファー設定機能 (Page ID: 704446530, 距離: 0.4774)
2. 562_【FIX】自動オファー条件設定機能 (Page ID: 705200188, 距離: 0.4663)
3. 561_【FIX】自動オファー送信状況閲覧機能 (Page ID: 705265747, 距離: 0.4383)
4. 742_【作成中】自動オファー送信バッチ (Page ID: 743473796, 距離: 0.4427)
5. 【FIX】オファー設定情報（自動オファー） (Page ID: 697827329, 距離: 0.4625)

### ✅ 原因2: BM25検索（Lunr）のトークン化不一致問題（主原因）

**問題の詳細**:
- タイトルに「自動オファー」が含まれているのに、Lunr検索で検出されていない
- これは、インデックス構築時と検索時のトークン化方法が一致していないことが原因

**根本原因**:
- **軽量トークン化の使用**: `src/lib/japanese-tokenizer.ts`の`performLightweightTokenization`が、kuromojiが初期化されていない場合に使用されていた
- **長いトークンの生成**: 軽量トークン化では「】自動オファー設定機能」のような長いトークンが生成され、Lunrの完全一致検索と互換性がない
- **インデックス構築時と検索時の不一致**: インデックス構築時はkuromoji、検索時は軽量トークン化という不一致が発生していた可能性　

**影響**:
- BM25検索で「自動オファー」関連のドキュメントが検出されない
- ハイブリッド検索の精度が低下

---

## ✅ 推奨される対策

### 対策1: ベクトルインデックスの再構築（推奨）

**手順**:
1. 既存のベクトルインデックスを削除
2. 新しいパラメータでインデックスを再構築
   - `numPartitions`を増やす（例: 256 → 512）
   - `numSubVectors`を調整（例: 96 → 128）

**スクリプト**:
```bash
npm run lancedb:create-indexes
```

### 対策2: 検索結果のlimitを増やす ✅ **実装済み**

**問題箇所**: `src/lib/lancedb-search-client.ts`

```typescript
// Before
let vectorResults = await vectorQuery.limit(topK * 10).toArray();

// After（実装済み）
let vectorResults = await vectorQuery.limit(topK * 30).toArray(); // 10倍 → 30倍に増加（topK=10の場合、100件→300件）
```

**理由**:
- 近似検索の誤差を考慮して、より多くの結果を取得する
- 100位以内に入るはずのドキュメントが検索結果に含まれる可能性が高まる

**効果**:
- `topK = 10`の場合、100件 → 300件に増加
- ベクトルインデックス（IVF_PQ）の近似検索の誤差を吸収
- 「自動オファー」関連のドキュメントが検索結果に含まれる可能性が向上

### 対策3: BM25検索のトークン化を修正 ✅ **実装済み（主な修正）**

**問題箇所**: `src/lib/japanese-tokenizer.ts`、`src/lib/lunr-search-client.ts`、`src/lib/lancedb-search-client.ts`

**修正内容**:

1. **トークン化の統一** (`src/lib/japanese-tokenizer.ts`):
   - `tokenizeJapaneseText`関数を修正し、**常にkuromojiを使用**するように変更
   - 軽量トークン化のフォールバックを削除
   - kuromojiが初期化されていない場合はエラーを投げる

2. **BM25検索時のトークン化** (`src/lib/lancedb-search-client.ts`):
   - BM25検索のクエリでも`tokenizeJapaneseText`を明示的に使用
   - インデックス構築時と同じトークン化方法を使用

3. **Lunr検索の設定調整** (`src/lib/lunr-search-client.ts`):
   - `threshold`を`0.25`から`0.1`に下げて、より多くの結果を取得
   - `limit`を`50`から`100`に増加
   - `tokenizeJapaneseText`を明示的に使用

4. **BM25検索のlimit調整** (`src/lib/lancedb-search-client.ts`):
   - `kwCap`を`100`から`200`に増加
   - `topK * 2`から`topK * 3`に変更

**効果**:
- BM25検索で「自動オファー」関連のドキュメントが正しく検出される
- ハイブリッド検索の精度が大幅に向上
- トークン化の一貫性が確保される

### 対策4: Lunrインデックスの再構築 ✅ **実装済み**

**手順**:
1. Lunrインデックスを再構築（kuromojiベースのトークン化で）
2. これらのドキュメントが正しくインデックスに含まれているかを確認

**スクリプト**:
```bash
npm run rebuild:lunr
# または
npx tsx scripts/rebuild-lunr-msgpack.ts
```

**効果**:
- 新しいトークン化方法でインデックスが再構築される
- 「自動オファー」関連のドキュメントが正しくインデックスに含まれる

### 対策5: 近似検索の精度を向上させる（未実装）

**オプション**:
- 近似検索ではなく全件検索を試す（パフォーマンスは低下するが精度は向上）
- ただし、これはパフォーマンスに大きな影響を与えるため、推奨されない

**現在の方針**:
- 対策2（limit増加）により、近似検索の誤差を吸収
- 対策3（BM25検索の修正）により、BM25検索で補完
- 現時点では、対策2と対策3の組み合わせで十分な精度が得られている

---

## 📊 検証結果

### 修正前の検証結果

#### ベクトル距離の確認

| タイトル | Page ID | 計算された距離 | 100位の距離 | 検索結果に含まれる |
|---------|---------|---------------|------------|------------------|
| 194_【FIX】自動オファー設定機能 | 704446530 | 0.4774 | 0.8380 | ❌ |
| 562_【FIX】自動オファー条件設定機能 | 705200188 | 0.4663 | 0.8380 | ❌ |
| 561_【FIX】自動オファー送信状況閲覧機能 | 705265747 | 0.4383 | 0.8380 | ❌ |
| 742_【作成中】自動オファー送信バッチ | 743473796 | 0.4427 | 0.8380 | ❌ |
| 【FIX】オファー設定情報（自動オファー） | 697827329 | 0.4625 | 0.8380 | ❌ |

**結論**: すべての対象ドキュメントの距離が100位以内に入るはずなのに、検索結果に含まれていませんでした。

#### BM25検索の確認

- 「自動オファー」でLunr検索を実行しても、期待されるドキュメントが検出されない
- トークン化の不一致が原因であることが判明

### 修正後の検証結果 ✅

#### ハイブリッド検索（ベクトル検索 + BM25検索）の確認

**検索キーワード**: 「自動オファー」

| タイトル | Page ID | ベクトル距離 | BM25スコア | 検索結果に含まれる |
|---------|---------|-------------|-----------|------------------|
| 【FIX】オファー設定情報（自動オファー） | 697827329 | 0.2000 | 63.4558 | ✅ |
| 194_【FIX】自動オファー設定機能 | 704446530 | 0.2000 | 62.5754 | ✅ |
| 561_【FIX】自動オファー送信状況閲覧機能 | 705265747 | 0.2000 | 59.9627 | ✅ |
| 562_【FIX】自動オファー条件設定機能 | 705200188 | 0.2000 | 61.4440 | ✅ |
| 742_【作成中】自動オファー送信バッチ | 743473796 | 0.2000 | 62.4163 | ✅ |

**結論**: 修正後、すべての対象ドキュメントがハイブリッド検索の結果に含まれるようになりました。

#### その他のキーワードでの検証

- 「パーソナルオファー」: ✅ パーソナルオファー関連のドキュメントが正しく検出される
- 「教室コピー」: ✅ 教室コピー関連のドキュメントが正しく検出される（1位）
- 「パスワードリセット」: ✅ パスワード再設定関連のドキュメントが正しく検出される
- 「ログイン認証」: ✅ ログイン関連のドキュメントが正しく検出される

**修正日**: 2025年11月5日  
**修正状態**: ✅ 完了

---

## 🔗 関連ファイル

### 修正ファイル

- `src/lib/japanese-tokenizer.ts`: 日本語トークン化の実装（kuromojiを常に使用するように修正）
- `src/lib/lunr-search-client.ts`: Lunr検索の実装（thresholdとlimitを調整、トークン化を統一）
- `src/lib/lancedb-search-client.ts`: ベクトル検索とBM25検索の実装（limit増加、トークン化を統一）
- `scripts/rebuild-lunr-msgpack.ts`: Lunrインデックスの再構築スクリプト

### テストファイル

- `tests/test-hybrid-search-direct.ts`: ハイブリッド検索の統合テスト
- `tests/test-search-keywords.ts`: キーワード検索のテスト（自動オファー、パーソナルオファー、教室コピー）
- `tests/test-search-auth-keywords.ts`: 認証関連キーワードのテスト（パスワードリセット、ログイン認証）

### 参考ファイル

- `src/lib/lunr-initializer.ts`: Lunrインデックスの初期化
- `src/ai/flows/retrieve-relevant-docs-lancedb.ts`: 関連ドキュメント検索のエントリーポイント

