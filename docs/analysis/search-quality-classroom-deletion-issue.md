# 検索品質問題分析: 「教室削除ができないのは何が原因ですか」

**作成日**: 2025年11月2日  
**問題**: 「164__【FIX】教室削除機能」が上位に表示されず、「教室グループ削除機能」が上位に表示される

## 📋 問題の概要

### 期待される動作
- クエリ: 「教室削除ができないのは何が原因ですか」
- 期待される結果: 「164__【FIX】教室削除機能」が1位に表示される

### 実際の動作
- 「155_【FIX】教室グループ削除機能」が上位に表示される
- 「164__【FIX】教室削除機能」が上位に表示されない

## 🔍 原因分析

### 1. タイトル救済検索（title-exact）の問題

**現在の実装**:
```typescript
// generateTitleCandidates関数は、キーワードから2語、3語の組み合わせを生成
function generateTitleCandidates(keywords: string[]): string[] {
  // 「教室削除」というキーワードが生成される
  // 「164__【FIX】教室削除機能」と「155_【FIX】教室グループ削除機能」の両方が「教室削除」を含む
  // 両方ともLIKE検索でマッチし、_sourceType: 'title-exact'としてマークされる
}
```

**問題点**:
- 両方のドキュメントが「教室削除」を含むため、同じように`title-exact`として扱われる
- RRF融合では`title-exact`は重み1.2で扱われるが、どちらがより関連性が高いかを区別できない
- 機能名の明確化（「教室削除機能」vs「教室グループ削除機能」）ができていない

### 2. タイトル部分一致検索（title-partial）が使われていない

**現在の実装**:
- `title-search-service.ts`には`searchTitlePartial`関数がある
- しかし、`lancedb-search-client.ts`では使われていない
- タイトル部分一致検索の結果がRRF融合に含まれていない

**問題点**:
- タイトル部分一致検索は、キーワードがタイトルに含まれるかどうかをチェックする
- しかし、この結果がRRF融合に含まれていないため、機能名の明確化に活用されていない

### 3. 機能名マッチングの強化が必要

**現在の実装**:
- `calculateTitleMatch`関数は、キーワードがタイトルに含まれるかどうかをチェックする
- しかし、「教室削除」というキーワードは、「教室削除機能」と「教室グループ削除機能」の両方にマッチする

**問題点**:
- 機能名の明確化（「教室削除機能」vs「教室グループ削除機能」）ができていない
- クエリの意図（「教室削除」ができない原因）を正確に反映できていない

### 4. RRF融合の重み調整が必要

**現在の実装**:
```typescript
// RRF融合の重み: vector=1.0, keyword=0.8, title-exact=1.2, bm25=0.6
let rrf = (1.0 / (kRrf + vr)) + 0.8 * (1 / (kRrf + kr)) + (tr ? 1.2 * (1 / (kRrf + tr)) : 0) + (br ? 0.6 * (1 / (kRrf + br)) : 0);
```

**問題点**:
- `title-exact`は重み1.2で扱われるが、機能名の明確化ができていない
- `title-partial`がRRF融合に含まれていないため、機能名の明確化に活用されていない

## 🎯 改善案

### 1. タイトル部分一致検索の統合

**実装内容**:
- `lancedb-search-client.ts`にタイトル部分一致検索を追加
- タイトル部分一致検索の結果を`_sourceType: 'title-partial'`としてマーク
- RRF融合に`title-partial`を追加し、重み1.0で扱う

**期待される効果**:
- 機能名の明確化ができる（「教室削除機能」vs「教室グループ削除機能」）
- より関連性の高いドキュメントが上位に表示される

### 2. 機能名マッチングの強化

**実装内容**:
- クエリから機能名を抽出（例: 「教室削除」→「教室削除機能」）
- タイトルに機能名が含まれる場合、スコアをブースト
- 機能名の完全一致を優先（例: 「教室削除機能」が「教室グループ削除機能」より優先される）

**期待される効果**:
- クエリの意図を正確に反映できる
- より関連性の高いドキュメントが上位に表示される

### 3. RRF融合の重み調整

**実装内容**:
```typescript
// title-partialを追加し、重み1.0で扱う
// title-exactは重み1.2、title-partialは重み1.0
let rrf = (1.0 / (kRrf + vr)) 
  + 0.8 * (1 / (kRrf + kr)) 
  + (tr ? 1.2 * (1 / (kRrf + tr)) : 0) 
  + (tp ? 1.0 * (1 / (kRrf + tp)) : 0)  // title-partialを追加
  + (br ? 0.6 * (1 / (kRrf + br)) : 0);
```

**期待される効果**:
- タイトル部分一致検索の結果がRRF融合に含まれる
- より関連性の高いドキュメントが上位に表示される

### 4. キーワード抽出の改善

**実装内容**:
- クエリから機能名を抽出（例: 「教室削除ができない」→「教室削除」）
- 機能名を優先キーワードとして扱う
- 機能名がタイトルに含まれる場合、スコアをブースト

**期待される効果**:
- クエリの意図を正確に反映できる
- より関連性の高いドキュメントが上位に表示される

## 📊 実装計画

### Phase 1: タイトル部分一致検索の統合
1. `lancedb-search-client.ts`にタイトル部分一致検索を追加
2. タイトル部分一致検索の結果を`_sourceType: 'title-partial'`としてマーク
3. RRF融合に`title-partial`を追加

### Phase 2: 機能名マッチングの強化
1. クエリから機能名を抽出
2. タイトルに機能名が含まれる場合、スコアをブースト
3. 機能名の完全一致を優先

### Phase 3: RRF融合の重み調整
1. RRF融合に`title-partial`を追加
2. 重みを調整（title-exact=1.2, title-partial=1.0）

### Phase 4: テストと検証
1. 「教室削除ができないのは何が原因ですか」でテスト
2. 「164__【FIX】教室削除機能」が1位に表示されることを確認
3. 他の類似クエリでも動作を確認

## 🔗 関連ドキュメント

- [ハイブリッド検索仕様書](../architecture/hybrid-search-specification-latest.md)
- [タイトル検索サービス実装](../src/lib/title-search-service.ts)
- [LanceDB検索クライアント実装](../src/lib/lancedb-search-client.ts)

