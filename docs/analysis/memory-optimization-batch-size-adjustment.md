# メモリ最適化: バッチサイズ調整と分析強化

**作成日**: 2025年11月23日  
**最終更新**: 2025年11月23日  
**ステータス**: ✅ 実装完了

---

## 1. 問題の分析

### 1.1 ユーザーの指摘

バッチ処理（ストリーミング処理）の導入はメモリ消費の抑制に効果的だが、**まだ完全には解決していない（または別の要因が残っている）**可能性がある。

**ログから読み取れる現状**:
```
⚠️ [Memory] Search execution ... RSS increased by +950.44MB
```

### 1.2 原因の可能性

1. **Lunrインデックス自体のサイズ**: 1233件のドキュメントのインデックスは数百MBになる可能性
2. **検索結果オブジェクトの生成**: 検索がヒットした後、結果を整形して返す際に、一時的に多くのオブジェクトが生成
3. **GC（ガベージコレクション）のタイミング**: メモリが解放されるのはGCが走ったタイミング
4. **インデックス構築と検索処理の重複**: 検索処理中にLunrインデックスの構築が走っている場合、そのメモリ消費が検索処理の増加分として計測されてしまう

### 1.3 最も有力な説

**「バッチ処理は効いているが、インデックス構築のメモリ消費と重なっている」**

---

## 2. 実装した対策

### 2.1 バッチサイズの調整

**変更内容**:
- **content削除のバッチサイズ**: 100件 → **50件**に削減
- **content復元のバッチサイズ**: 50件 → **20件**に削減

**理由**:
- バッチサイズが大きすぎると、1バッチあたりのメモリ消費が大きくなる
- より小さなバッチサイズで処理することで、メモリピークを下げる

**実装箇所**:
- `src/lib/lancedb-search-client.ts` (1336行目、972行目)

### 2.2 メモリ分析の強化

**変更内容**:
- 検索処理完了時に、Lunrインデックスの初期化状態を確認
- 初期化中であれば警告を追加し、メモリ増加の原因を明確化

**実装箇所**:
- `src/lib/lancedb-search-client.ts` (1023-1036行目)
- `src/lib/lunr-initializer.ts` (475-481行目): `isInitializing()`メソッドを追加

**ログ出力例**:
```
⚠️ [Memory] Lunr index is initializing during search execution (confluence) - memory increase may include index construction
⚠️ [Memory] Search execution (...): RSS increased by +950.44MB (threshold: 500MB)
```

---

## 3. 期待される効果

### 3.1 バッチサイズの調整

- **メモリピークの削減**: より小さなバッチサイズで処理することで、一時的なメモリ使用量を削減
- **GCの促進**: より頻繁にバッチ処理が完了するため、GCが走る機会が増える

### 3.2 メモリ分析の強化

- **原因の特定**: インデックス構築と検索処理を分離して記録することで、メモリ増加の原因を特定しやすくなる
- **ログの改善**: 初期化中であることを明示することで、メモリ増加が正常な動作かどうかを判断しやすくなる

---

## 4. 本番環境での確認事項

### 4.1 メモリ使用量の監視

本番環境で以下のログを確認してください:

```
⚠️ [Memory] Lunr index is initializing during search execution (confluence) - memory increase may include index construction
⚠️ [Memory] Search execution (...): RSS increased by +XXX.XXMB (threshold: 500MB)
```

**期待される効果**:
- 初期化中でない場合: メモリ増加は検索処理自体によるもの
- 初期化中の場合: メモリ増加はインデックス構築によるもの（正常な動作）

### 4.2 バッチサイズの効果

- メモリピークが削減されているか
- 検索処理時間が維持されているか（微細な速度低下は許容範囲）

---

## 5. 次のステップ

### 5.1 本番環境での確認

1. メモリ使用量のログを確認
2. インデックス構築と検索処理が重なっているか確認
3. バッチサイズの調整効果を確認

### 5.2 さらなる最適化（必要に応じて）

1. **バッチサイズのさらなる調整**: 50件 → 20件、20件 → 10件など
2. **インデックス構築のタイミング調整**: 起動時初期化を強化し、検索処理と重ならないようにする
3. **GCの強制実行**: 検索処理完了後に明示的にGCを実行（開発環境のみ）

---

## 6. 関連ドキュメント

- [メモリ最適化の動作確認結果](./memory-optimization-verification.md)
- [パフォーマンス最適化テスト結果レポート](../05-testing/05.72-performance-optimization-test-2025-11-23.md)
- [Lunr初期化根本原因分析](./lunr-initialization-root-cause.md)

---

## 7. 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2025-11-23 | 初版作成 | - |

