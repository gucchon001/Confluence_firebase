# ローカル環境と本番環境の検索結果差異分析

## 問題の概要
- **ローカル環境**: `pageId=703594590`（045_【FIX】パスワード再設定機能）が9位
- **本番環境**: 同じクエリで異なる順位（ログに`pageId=703594590`のデバッグログが出力されていない）

## 検証済み項目

### ✅ タグ取得方法
- ローカル環境: `getLabelsAsArray`を使用して正しく実装されている
- 本番環境: 同じコードが使用されるため、タグ取得方法は問題なし

### ❓ 未確認項目

1. **本番環境のLanceDBデータ**
   - `structured_tags`がLanceDBに正しく同期されているか
   - Firestoreにはタグが存在するが、LanceDBに反映されているか

2. **本番環境のコードバージョン**
   - タグマッチングロジックが実装されているバージョンがデプロイされているか
   - `getLabelsAsArray`が正しく動作するバージョンか

3. **検索結果への含まれ方**
   - `pageId=703594590`が検索結果に含まれているか（順位が低すぎて除外されている可能性）

## 本番環境ログの分析

提供された本番環境のログには以下のログが**出力されていない**：
- `[Tag Boost] pageId=703594590` - RRF融合時のタグマッチングボーナス
- `[Composite Tag Boost] pageId=703594590` - Composite Score計算時のタグマッチングボーナス

### 考えられる原因

1. **LanceDBデータが古い**
   - Firestoreにはタグが存在するが、LanceDBに同期されていない
   - `sync-firestore-labels-to-lancedb.ts`が本番環境で実行されていない

2. **コードバージョンが古い**
   - タグマッチングロジックが実装される前のバージョンがデプロイされている
   - `getLabelsAsArray`が`Utf8Vector`に対応していないバージョン

3. **検索結果に含まれていない**
   - ベクトル検索やBM25検索で`pageId=703594590`が取得されていない
   - フィルタリング段階で除外されている

## 確認すべき項目

### 1. 本番環境のLanceDBデータ確認
```bash
# 本番環境のLanceDBから直接確認
# （GCS上のLanceDBバンドルを確認）
```

### 2. 本番環境のコードバージョン確認
```bash
# デプロイされているコードのバージョンを確認
# git log で最新のコミットを確認
```

### 3. 本番環境での検索結果確認
- 本番環境のログで`pageId=703594590`が検索結果に含まれているかを確認
- 検索結果の上位60件に含まれているかを確認

## 推奨される対応

1. **本番環境のLanceDBデータを確認**
   - GCS上のLanceDBバンドルから`pageId=703594590`の`structured_tags`を確認

2. **本番環境でLanceDB同期を実行**
   - `sync-firestore-labels-to-lancedb.ts`を本番環境で実行
   - その後、LanceDBバンドルをGCSにアップロード

3. **本番環境のコードを最新化**
   - 最新のコードをデプロイ
   - タグマッチングロジックが含まれていることを確認

4. **本番環境で再テスト**
   - 同じクエリで検索を実行
   - `pageId=703594590`のデバッグログが出力されるかを確認

