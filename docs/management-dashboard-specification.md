# 管理画面・ダッシュボード仕様書

## 📋 概要

Confluence AI アシスタントの投稿監視・パフォーマンス分析・ログ管理を行うための管理画面システムの仕様書です。

## 🎯 目的

- **リアルタイム投稿監視**: 現在進行中の会話をリアルタイムで監視
- **パフォーマンス分析**: 検索時間、AI生成時間、総処理時間の可視化
- **ログ分析**: 質問内容、回答品質、エラー分析
- **システムヘルス監視**: エラー率、レスポンス時間、システム状況

## 🏗️ システム構成

### 技術スタック
- **フロントエンド**: Next.js 14, React, TypeScript, Tailwind CSS
- **バックエンド**: Next.js API Routes, Firebase Admin SDK
- **データベース**: Firestore (リアルタイムデータ), LanceDB (検索ログ)
- **認証**: Firebase Authentication (管理者権限)
- **リアルタイム**: Firestore Real-time Listeners, WebSocket
- **可視化**: Chart.js, Recharts
- **UI コンポーネント**: shadcn/ui

### アーキテクチャ
```
管理画面システム
├── フロントエンド (Next.js)
│   ├── ダッシュボードページ
│   ├── 投稿監視ページ
│   ├── パフォーマンス分析ページ
│   └── ログ分析ページ
├── バックエンド (API Routes)
│   ├── リアルタイム監視API
│   ├── パフォーマンスデータAPI
│   ├── ログ分析API
│   └── システムヘルスAPI
└── データ層
    ├── Firestore (リアルタイムデータ)
    ├── ローカルログファイル
    └── パフォーマンスメトリクス
```

## 📊 機能仕様

### 1. リアルタイム投稿監視

#### 1.1 現在進行中の会話表示
- **機能**: リアルタイムで進行中の会話を表示
- **表示項目**:
  - ユーザーID（匿名化）
  - 質問内容
  - 処理ステップ（検索中、AI生成中、完了）
  - 経過時間
  - 進捗率

#### 1.2 会話履歴監視
- **機能**: 過去の会話履歴を表示・検索
- **表示項目**:
  - 質問・回答ペア
  - 処理時間（検索時間、AI生成時間、総時間）
  - 回答品質スコア
  - 参照ドキュメント数
  - エラー発生状況

### 2. パフォーマンス分析ダッシュボード

#### 2.1 リアルタイムメトリクス
- **検索時間**: 平均、最小、最大、95パーセンタイル
- **AI生成時間**: 平均、最小、最大、95パーセンタイル
- **総処理時間**: 平均、最小、最大、95パーセンタイル
- **スループット**: 1分間あたりの処理数

#### 2.2 時系列グラフ
- **検索時間推移**: 過去24時間の検索時間グラフ
- **AI生成時間推移**: 過去24時間のAI生成時間グラフ
- **エラー率推移**: 過去24時間のエラー発生率
- **アクティブユーザー数**: 同時接続ユーザー数

#### 2.3 パフォーマンスアラート
- **検索時間警告**: 5秒超過で警告
- **AI生成時間警告**: 30秒超過で警告
- **エラー率警告**: 5%超過で警告
- **システム負荷警告**: メモリ使用率80%超過で警告

### 3. ログ分析システム

#### 3.1 質問分析
- **頻出質問ランキング**: 最も多く質問される内容
- **質問カテゴリ分析**: 質問の分類と傾向
- **質問長分析**: 質問の文字数分布
- **質問時間分析**: 質問が集中する時間帯

#### 3.2 回答品質分析
- **回答長分析**: 回答の文字数分布
- **参照ドキュメント数**: 回答に使用されたドキュメント数
- **マークダウン形式**: 回答の形式化状況
- **ユーザー満足度**: 評価データ（将来実装）

#### 3.3 エラー分析
- **エラー種別**: 検索エラー、AI生成エラー、システムエラー
- **エラー発生率**: 時間別、日別のエラー率
- **エラー詳細**: スタックトレース、コンテキスト情報
- **エラー解決状況**: 解決済み、未解決、調査中

### 4. システムヘルス監視

#### 4.1 システム状況
- **データベース接続**: LanceDB、Firestore接続状況
- **メモリ使用量**: ヒープ使用量、RSS使用量
- **CPU使用率**: プロセス別CPU使用率
- **ディスク使用量**: ログファイル、キャッシュファイル

#### 4.2 サービス状況
- **検索サービス**: LanceDB検索、Lunr検索の稼働状況
- **AI生成サービス**: Gemini API接続状況
- **認証サービス**: Firebase認証の稼働状況
- **キャッシュサービス**: 埋め込み、キーワードキャッシュの状況

## 🗄️ データ構造

### 1. 投稿ログ (PostLog)
```typescript
interface PostLog {
  id: string;
  userId: string; // 匿名化済み
  question: string;
  answer: string;
  searchTime: number; // ミリ秒
  aiGenerationTime: number; // ミリ秒
  totalTime: number; // ミリ秒
  referencesCount: number;
  answerLength: number;
  qualityScore?: number; // 将来実装
  timestamp: Date;
  processingSteps: ProcessingStep[];
  errors?: ErrorLog[];
  metadata: {
    userAgent?: string;
    ipAddress?: string; // 匿名化済み
    sessionId: string;
  };
}
```

### 2. パフォーマンスメトリクス (PerformanceMetrics)
```typescript
interface PerformanceMetrics {
  id: string;
  timestamp: Date;
  category: 'search' | 'ai' | 'total' | 'system';
  operation: string;
  duration: number;
  success: boolean;
  error?: string;
  metadata: {
    memoryUsage?: {
      heapUsed: number;
      heapTotal: number;
      rss: number;
    };
    cpuUsage?: number;
    requestCount?: number;
  };
}
```

### 3. システムヘルス (SystemHealth)
```typescript
interface SystemHealth {
  id: string;
  timestamp: Date;
  status: 'healthy' | 'warning' | 'critical';
  services: {
    lancedb: ServiceStatus;
    firestore: ServiceStatus;
    gemini: ServiceStatus;
    authentication: ServiceStatus;
  };
  metrics: {
    memoryUsage: number; // パーセンテージ
    cpuUsage: number; // パーセンテージ
    diskUsage: number; // パーセンテージ
    activeConnections: number;
  };
  alerts: Alert[];
}
```

### 4. エラーログ (ErrorLog)
```typescript
interface ErrorLog {
  id: string;
  timestamp: Date;
  level: 'error' | 'warning' | 'info';
  category: 'search' | 'ai' | 'system' | 'auth';
  message: string;
  stack?: string;
  context: {
    userId?: string;
    sessionId?: string;
    requestId?: string;
    operation?: string;
  };
  resolved: boolean;
  resolvedAt?: Date;
  resolvedBy?: string;
}
```

## 🔐 認証・権限管理

### 管理者権限
- **スーパー管理者**: 全機能アクセス、システム設定変更
- **監視管理者**: ダッシュボード閲覧、ログ分析
- **運用管理者**: エラー対応、システムメンテナンス

### 認証方式
- Firebase Authentication
- ドメイン制限（社内メールアドレスのみ）
- 多要素認証（推奨）

## 📱 画面設計

### 1. ダッシュボード（メイン画面）
```
┌─────────────────────────────────────────────────────────┐
│ 🏠 管理ダッシュボード                    👤 管理者名 ▼ │
├─────────────────────────────────────────────────────────┤
│ 📊 リアルタイムメトリクス                               │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│ │検索時間 │ │AI生成時間│ │総時間   │ │エラー率 │        │
│ │ 2.3s    │ │ 15.2s   │ │ 17.5s  │ │ 0.5%    │        │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │
├─────────────────────────────────────────────────────────┤
│ 📈 パフォーマンス推移（過去24時間）                     │
│ [検索時間グラフ] [AI生成時間グラフ] [エラー率グラフ]    │
├─────────────────────────────────────────────────────────┤
│ 🔴 現在進行中の会話 (3件)                               │
│ • ユーザーA: "教室管理の詳細は..." [検索中] 00:05      │
│ • ユーザーB: "ログイン認証の仕組みは..." [AI生成中] 00:12│
│ • ユーザーC: "パーソナルオファーとは..." [完了] 00:18  │
└─────────────────────────────────────────────────────────┘
```

### 2. 投稿監視画面
```
┌─────────────────────────────────────────────────────────┐
│ 📋 投稿監視                                            │
├─────────────────────────────────────────────────────────┤
│ 🔍 フィルター: [時間範囲] [ユーザー] [ステータス] [検索] │
├─────────────────────────────────────────────────────────┤
│ 質問内容                │ ステータス │ 時間  │ 品質 │ 操作 │
│ 教室管理の詳細は...      │ 完了      │ 17.5s │ 85% │ 詳細 │
│ ログイン認証の仕組みは...│ AI生成中   │ 12.3s │ -   │ 監視 │
│ パーソナルオファーとは...│ 検索中    │ 5.2s  │ -   │ 監視 │
└─────────────────────────────────────────────────────────┘
```

### 3. パフォーマンス分析画面
```
┌─────────────────────────────────────────────────────────┐
│ ⚡ パフォーマンス分析                                   │
├─────────────────────────────────────────────────────────┤
│ 📊 時間範囲選択: [過去1時間] [過去24時間] [過去7日]     │
├─────────────────────────────────────────────────────────┤
│ 📈 検索時間分布                                         │
│ [ヒストグラム] 平均: 2.3s, 95%: 5.1s, 最大: 12.3s      │
├─────────────────────────────────────────────────────────┤
│ 🤖 AI生成時間分布                                       │
│ [ヒストグラム] 平均: 15.2s, 95%: 28.4s, 最大: 45.7s    │
├─────────────────────────────────────────────────────────┤
│ ⚠️ パフォーマンスアラート                               │
│ • 12:34 - 検索時間が5秒を超過 (6.2s)                   │
│ • 12:28 - AI生成時間が30秒を超過 (32.1s)               │
└─────────────────────────────────────────────────────────┘
```

### 4. ログ分析画面
```
┌─────────────────────────────────────────────────────────┐
│ 📝 ログ分析                                            │
├─────────────────────────────────────────────────────────┤
│ 🔍 分析期間: [過去24時間] [過去7日] [過去30日]          │
├─────────────────────────────────────────────────────────┤
│ 📊 質問分析                                             │
│ 頻出質問TOP5:                                           │
│ 1. "教室管理の詳細は..." (45回)                         │
│ 2. "ログイン認証の仕組みは..." (32回)                   │
│ 3. "パーソナルオファーとは..." (28回)                   │
├─────────────────────────────────────────────────────────┤
│ 📈 回答品質分析                                         │
│ 平均回答長: 1,247文字                                   │
│ 平均参照ドキュメント数: 8.3件                           │
│ マークダウン形式適用率: 95%                             │
└─────────────────────────────────────────────────────────┘
```

## 🚀 実装計画

### Phase 1: 基本管理画面（1-2週間）
1. **認証システム**: Firebase認証、管理者権限
2. **ダッシュボード**: リアルタイムメトリクス表示
3. **投稿監視**: 現在進行中の会話表示
4. **基本ログ表示**: 会話履歴の表示・検索

### Phase 2: パフォーマンス分析（2-3週間）
1. **メトリクス収集**: パフォーマンスデータの自動収集
2. **グラフ表示**: 時系列グラフ、分布グラフ
3. **アラート機能**: パフォーマンス警告システム
4. **レポート生成**: 定期レポートの自動生成

### Phase 3: 高度な分析機能（3-4週間）
1. **質問分析**: 頻出質問、カテゴリ分析
2. **品質分析**: 回答品質の評価・分析
3. **エラー分析**: エラーの詳細分析・解決追跡
4. **予測分析**: パフォーマンス予測、需要予測

### Phase 4: 運用機能（2-3週間）
1. **システムメンテナンス**: ログクリーンアップ、キャッシュ管理
2. **設定管理**: アラート閾値、通知設定
3. **バックアップ・復旧**: データバックアップ、災害復旧
4. **API提供**: 外部システム連携用API

## 📋 現在のログ出力状況

### 既存のログシステム
1. **ScreenTestLogger**: コンソール + JSONファイル出力
   - 検索パフォーマンスログ
   - AI生成パフォーマンスログ
   - 総合パフォーマンスログ
   - エラーログ

2. **ErrorHandler**: Firestore + ローカルファイル出力
   - 構造化エラーログ
   - スタックトレース
   - コンテキスト情報

3. **PerformanceMonitor**: メモリ内メトリクス
   - パフォーマンス測定
   - メモリ使用量監視
   - CSV出力機能

### 拡張が必要な項目
1. **リアルタイム監視**: WebSocket/SSE対応
2. **データベース保存**: Firestore構造化データ
3. **分析機能**: 統計計算、グラフ生成
4. **アラート機能**: 閾値監視、通知システム

## 🎯 成功指標

### パフォーマンス指標
- **ダッシュボード読み込み時間**: 3秒以内
- **リアルタイム更新遅延**: 1秒以内
- **データクエリ応答時間**: 2秒以内

### 機能指標
- **監視カバレッジ**: 全投稿の100%監視
- **アラート精度**: 偽陽性率5%以下
- **データ保持期間**: 90日間

### 運用指標
- **システム稼働率**: 99.9%以上
- **エラー検出率**: 95%以上
- **管理者満足度**: 4.5/5.0以上

---

## 📝 次のステップ

1. **技術検証**: リアルタイム監視の技術検証
2. **データベース設計**: Firestoreスキーマの詳細設計
3. **UI/UX設計**: 画面遷移、ユーザビリティの詳細設計
4. **セキュリティ設計**: 認証・認可の詳細仕様
5. **実装開始**: Phase 1の実装開始

この仕様書に基づいて、段階的に管理画面システムを構築していきます。
