# エンベディング生成の代替手段

## 現在の問題

`@xenova/transformers` は、Firebase App Hosting 環境でのローカルファイル読み込みに根本的な問題がある。

試行結果：
- ✅ ファイルは正しく配置されている
- ❌ ライブラリがそのパスを読み込めない
- ❌ パスの解決方法が複雑で一貫性がない
- ❌ デバッグが困難

## 代替アプローチ

### オプション 1: sentence-transformers (Python)

**概要**: Python製のライブラリで、ローカルファイルの扱いが確実

**実装方法**:
1. Cloud Run に Python 実行環境を追加
2. `sentence-transformers` をインストール
3. HTTP API エンドポイントを作成
4. Next.js から HTTP リクエストで呼び出す

**メリット**:
- ローカルファイル読み込みが確実
- ドキュメントが豊富
- コミュニティのサポートが厚い

**デメリット**:
- Python環境が必要
- アーキテクチャが複雑になる（Node.js + Python）
- レイテンシの増加

**実装時間**: 1-2日

### オプション 2: TensorFlow.js

**概要**: TensorFlow.js を使用してモデルを直接読み込む

**実装方法**:
1. ONNX モデルを TensorFlow.js 形式に変換
2. TensorFlow.js を使用してモデルを読み込む
3. ファイルシステムから直接読み込む

**メリット**:
- Node.js環境内で完結
- 細かい制御が可能
- ファイル読み込みを完全に制御できる

**デメリット**:
- コードが複雑になる
- 変換プロセスが必要
- 開発時間が増加

**実装時間**: 2-3日

### オプション 3: Cloud Storage + FUSE

**概要**: モデルファイルを Cloud Storage に保存し、コンテナ内でマウント

**実装方法**:
1. モデルファイルを Cloud Storage にアップロード
2. Cloud Run で FUSE を使用してマウント
3. 通常のファイルシステムとして読み込む

**メリット**:
- ファイルシステムの問題を回避
- モデルの更新が容易
- コンテナサイズが小さくなる

**デメリット**:
- セットアップが複雑
- 起動時間が長くなる可能性
- FUSE の権限問題

**実装時間**: 1-2日

### オプション 4: 外部エンベディングAPIサービス

**概要**: エンベディング生成を別のサービスに移す

**実装方法**:
1. Vertex AI Embeddings API を使用
2. または独自のエンベディング生成APIを構築
3. Next.js から HTTP リクエストで呼び出す

**メリット**:
- アーキテクチャがシンプル
- モデル管理の問題が解決
- スケーラビリティの向上

**デメリット**:
- コストの増加
- レイテンシの増加
- 外部サービスへの依存

**実装時間**: 1日

### オプション 5: モデルをビルドに含めない（cb2ccb10の方法）

**概要**: モデルファイルをビルドに含めず、起動時にダウンロード

**実装方法**:
1. `postbuild` を削除
2. `models/` ディレクトリを参照
3. 起動時にモデルをダウンロード（初回のみ）

**メリット**:
- 最もシンプル
- 過去に動作実績がある（cb2ccb10）
- 実装時間が最短

**デメリット**:
- 起動が遅い（初回）
- レート制限の問題（429エラー）
- ネットワーク依存

**実装時間**: 1時間

## 推奨

### 短期解決策（即座に）
**オプション 5**: モデルをビルドに含めない方法に戻す
- 過去に動作していた
- 実装が最も簡単
- 429エラーは発生するが、動作はする

### 長期解決策（2-3日）
**オプション 1 または 4**: 
- sentence-transformers（確実性重視）
- 外部APIサービス（シンプルさ重視）

## 次のステップ

1. **すぐに**: cb2ccb10の状態に完全に戻す（1時間）
2. **短期**: 動作を確認してパフォーマンス問題を解決（1日）
3. **中期**: 代替アプローチを評価・実装（2-3日）

---

**作成日**: 2025-10-28  
**推奨**: オプション5（即座）+ オプション1または4（長期）
