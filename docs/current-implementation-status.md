# 現在の実装状況

## 概要

Confluence Firebase アプリケーションの現在の実装状況と主要機能について説明します。

## 実装済み機能

### 1. 検索エンジン

#### ハイブリッド検索
- **ベクトル検索**: LanceDB を使用した意味的検索
- **BM25F検索**: タイトルと本文に異なる重みを適用したキーワード検索
- **RRF (Reciprocal Rank Fusion)**: 複数の検索結果を統合
- **MMR (Maximal Marginal Relevance)**: 結果の多様性を確保

#### キーワード抽出
- **Kuromoji**: 日本語形態素解析（優先）
- **Tiny-segmenter**: フォールバック用の軽量分かち書き
- **N-gram**: 最終的なフォールバック
- **LLM拡張**: Gemini 1.5 Flash による同義語・関連語の生成

#### スコアリング
- **重み付け**: ベクトル(0.4) + キーワード(0.5) + ラベル(0.1)
- **ブースト機能**: 重要キーワード、フレーズ近接、見出し一致
- **制約表現検出**: 数値+期間表現、制限語の検出と加点

### 2. RAG (Retrieval Augmented Generation)

#### 検索・要約パイプライン
- **文書検索**: ハイブリッド検索による関連文書の取得
- **重複除去**: タイトルベースでの重複文書の除去
- **LLM要約**: Gemini 2.5 Flash による構造化要約
- **引用管理**: 信頼度別の引用分類（High/Medium/Low）

#### 信頼度分類
- **RRFベース**: 複数検索アルゴリズムの合意度
- **メタデータ考慮**: ソースタイプ、類似度、BM25スコア
- **ドメイン減衰**: メールテンプレート、議事録等の重み調整

### 3. データ管理

#### Confluence 同期
- **バッチ同期**: 全データの一括取得・更新
- **差分同期**: 変更されたページのみの更新
- **エラーハンドリング**: リトライ機能、ログ出力

#### LanceDB 統合
- **ベクトル保存**: 384次元の埋め込みベクトル
- **メタデータ**: タイトル、内容、ラベル、URL等
- **インデックス**: 効率的な近傍検索のためのインデックス

### 4. 認証・セキュリティ

#### Firebase Authentication
- **Google アカウント**: OAuth 2.0 による認証
- **ドメイン制限**: 特定ドメインのユーザーのみアクセス可能
- **セッション管理**: 自動ログイン、セッション有効期限

#### アクセス制御
- **ラベルフィルタリング**: アーカイブ、議事録等の除外
- **権限管理**: 管理者・一般ユーザーの権限分離

## 技術スタック

### フロントエンド
- **Next.js 15.3.3**: React フレームワーク
- **TypeScript**: 型安全な開発
- **Tailwind CSS**: スタイリング
- **Radix UI**: アクセシブルなUIコンポーネント

### バックエンド
- **Firebase Functions**: サーバーレス関数
- **Firestore**: メタデータ保存
- **LanceDB**: ベクトルデータベース
- **GenKit**: AI機能統合

### AI・機械学習
- **@xenova/transformers**: ローカル埋め込み生成
- **Google Gemini**: LLM機能
- **Kuromoji**: 日本語形態素解析
- **Tiny-segmenter**: 軽量分かち書き

## パフォーマンス最適化

### 検索最適化
- **早期ラベルフィルタリング**: 処理速度向上
- **キャッシュ機能**: 頻繁にアクセスされるデータのキャッシュ
- **並列処理**: 複数検索アルゴリズムの並列実行

### メモリ最適化
- **チャンク分割**: 大きな文書の効率的な処理
- **遅延読み込み**: 必要な時のみデータを読み込み
- **ガベージコレクション**: 不要なオブジェクトの適切な解放

## 設定可能なパラメータ

### 検索重み
```typescript
VECTOR_WEIGHT = 0.4      // ベクトル検索の重み
KEYWORD_WEIGHT = 0.5     // キーワード検索の重み
LABEL_WEIGHT = 0.1       // ラベル検索の重み
```

### BM25F パラメータ
```typescript
TITLE_WEIGHT = 1.2       // タイトル重み
BODY_WEIGHT = 0.7        // 本文重み
k1 = 1.2                 // TF正規化パラメータ
b = 0.75                 // 長さ正規化パラメータ
```

### RRF パラメータ
```typescript
kRrf = 60                // RRF正規化定数
vectorWeight = 1.0       // ベクトル検索重み
keywordWeight = 0.25     // キーワード検索重み
titleWeight = 0.8        // タイトル完全一致重み
bm25Weight = 0.5         // BM25検索重み
```

## 制限事項・既知の問題

### 1. データベース
- LanceDB はローカルファイルベースのため、本番環境では永続化が必要
- 大量データでの検索性能は要監視

### 2. LLM機能
- Gemini API のレート制限
- トークン使用量の監視が必要
- ハルシネーションの可能性

### 3. 日本語処理
- Kuromoji 辞書のサイズ（約50MB）
- 初回読み込み時間の影響

### 4. メモリ使用量
- 大量のベクトルデータのメモリ使用量
- 同時接続数による影響

## 今後の改善予定

### 短期（1-2週間）
- [ ] 本番環境でのLanceDB永続化
- [ ] パフォーマンス監視の実装
- [ ] エラーハンドリングの強化

### 中期（1-2ヶ月）
- [ ] 検索結果のキャッシュ機能
- [ ] ユーザー行動分析
- [ ] 検索精度の継続的改善

### 長期（3-6ヶ月）
- [ ] マルチモーダル検索（画像・動画対応）
- [ ] リアルタイム同期
- [ ] 高度なRAG機能（チェーン・エージェント）

## 運用監視

### ログ
- **アプリケーションログ**: 検索クエリ、エラー、パフォーマンス
- **同期ログ**: Confluence データ同期の状況
- **Firebase ログ**: 認証、Firestore アクセス

### メトリクス
- **検索精度**: 関連文書の検出率
- **応答時間**: 検索・RAG処理時間
- **エラー率**: 各種処理のエラー発生率
- **リソース使用量**: CPU、メモリ、ストレージ

## 参考資料

- [実装計画](implementation-plan.md)
- [検索チューニング計画](search-tuning-plan.md)
- [デプロイガイド](deployment-guide.md)
- [API設計](api-design.md)