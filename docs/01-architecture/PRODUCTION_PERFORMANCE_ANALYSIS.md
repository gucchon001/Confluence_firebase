# 本番環境パフォーマンス分析

**作成日**: 2025-11-21  
**対象**: Firebase App Hosting 本番環境

---

## 📊 本番環境設定

### 現在の設定（`setup/apphosting.yaml`）

```yaml
runConfig:
  minInstances: 1      # Cold Start回避
  maxInstances: 2
  memoryMiB: 2048      # 2GB
  cpu: 1
  timeoutSeconds: 300  # 5分（デフォルト60秒から延長）
```

### 環境の特徴

| 項目 | 設定 | 影響 |
|------|------|------|
| **minInstances** | 1 | ✅ Cold Startを回避（常に1インスタンスが起動） |
| **メモリ** | 2GB | ⚠️ 開発環境より少ない（開発: 約3GB使用） |
| **CPU** | 1コア | ⚠️ 並列処理の制約 |
| **リージョン** | us-central1 | ⚠️ データはasia-northeast1（レイテンシ影響） |

---

## 🔍 パフォーマンス予測

### 開発環境 vs 本番環境

| 処理 | 開発環境 | 本番環境（予測） | 理由 |
|------|----------|------------------|------|
| **トークナイザー初期化** | 6秒 | **3-4秒** | メモリが少ないが、CPUは同等 |
| **Lunr初期化** | 1.5秒 | **1.5-2秒** | メモリマップドファイル読み込み（同等） |
| **BM25検索** | 5.9秒 | **4-5秒** | 初期化済みなら短縮可能 |
| **ベクトル検索** | 59ms | **50-100ms** | ネットワークレイテンシ影響 |
| **検索処理全体** | 10.77秒 | **8-10秒** | 初期化済みなら改善 |

---

## ⚡ 本番環境での最適化効果

### 1. Cold Start回避（minInstances: 1）

**効果**:
- ✅ 初回リクエストでも初期化済み
- ✅ トークナイザーとLunrが事前初期化済み
- ✅ 検索開始時に初期化待ちが発生しない

**期待される改善**:
- BM25検索: 5.9秒 → **1.0-1.5秒**（初期化待ち7.5秒を削減）
- 検索処理全体: 10.77秒 → **3-4秒**

### 2. 起動時初期化（StartupOptimizer）

**現在の動作**:
1. キャッシュがある場合: Ultra-fast startup（即座にreturn）
2. バックグラウンドで初期化を実行（1秒後）
3. 初回リクエスト時には初期化済みの可能性が高い

**問題点**:
- ⚠️ バックグラウンド初期化が1秒後に開始
- ⚠️ 初回リクエストが1秒以内に来ると、初期化待ちが発生

**改善案**:
- 起動時に同期で初期化を完了させる（minInstances: 1なので可能）
- または、バックグラウンド初期化を即座に開始

---

## 🎯 本番環境での期待パフォーマンス

### 最適化後の予測

| シナリオ | 検索処理時間 | 備考 |
|----------|--------------|------|
| **初回リクエスト（初期化済み）** | **3-4秒** | minInstances: 1により初期化済み |
| **2回目以降** | **3-4秒** | 初期化済み + キャッシュ有効 |
| **Cold Start（minInstances: 0の場合）** | **10-15秒** | 初期化待ちが発生 |

### ボトルネック

1. **BM25検索**: 1.0-1.5秒（最適化後）
2. **ベクトル検索**: 50-100ms
3. **埋め込み生成**: 1.6秒（Gemini API）
4. **AI生成**: 9.6秒（Gemini API）

**合計**: 約12-15秒（AI生成を含む）

---

## 🔧 推奨される改善

### 1. 起動時初期化の確実な実行

**現在の問題**:
- バックグラウンド初期化が1秒後に開始
- 初回リクエストが早いと初期化待ちが発生

**改善案**:
```typescript
// startup-optimizer.ts
// バックグラウンド初期化を即座に開始（1秒待機を削除）
performInitializationAsync().then(() => {
  console.log('[StartupOptimizer] ✅ Background initialization completed');
});
```

### 2. メモリ使用量の最適化

**現在の問題**:
- 開発環境で約3GB使用
- 本番環境は2GB制限

**改善案**:
- メモリ使用量を削減（不要なデータの削除）
- または、メモリを4GBに増やす（コスト増）

### 3. リージョン最適化

**現在の問題**:
- App Hosting: us-central1（米国）
- Firestore: asia-northeast1（東京）
- レイテンシ影響

**改善案**:
- App Hostingをasia-northeast1に変更（可能な場合）
- または、データをus-central1に複製

---

## 📈 パフォーマンス目標

### 短期目標（現在の最適化後）

- ✅ BM25検索: 5.9秒 → **1.0-1.5秒**
- ✅ 検索処理全体: 10.77秒 → **3-4秒**
- ✅ 初回リクエスト: 初期化待ちなし

### 長期目標

- 🎯 検索処理全体: **2-3秒**
- 🎯 AI生成を含む全体: **10-12秒**

---

## 🔍 監視項目

本番環境で監視すべきメトリクス:

1. **検索処理時間**
   - BM25検索時間
   - ベクトル検索時間
   - 検索処理全体

2. **初期化時間**
   - トークナイザー初期化時間
   - Lunr初期化時間
   - 起動時初期化時間

3. **メモリ使用量**
   - ヒープ使用量
   - RSS使用量
   - メモリ制限エラー

4. **Cold Start発生率**
   - minInstances: 1の効果
   - スケールアウト時のCold Start

---

## 📝 まとめ

### 本番環境での期待パフォーマンス

- **検索処理**: 3-4秒（最適化後）
- **AI生成を含む全体**: 12-15秒
- **Cold Start**: 回避（minInstances: 1）

### 重要な改善点

1. ✅ 起動時初期化の確実な実行
2. ⚠️ メモリ使用量の最適化（2GB制限）
3. ⚠️ リージョン最適化（レイテンシ削減）

### 次のステップ

1. 起動時初期化の改善を実装
2. 本番環境でパフォーマンステストを実施
3. メモリ使用量を監視し、必要に応じて調整

