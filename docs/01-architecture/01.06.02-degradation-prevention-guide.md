# デグレード防止ガイド

**作成日**: 2025年11月24日  
**最終更新**: 2025年11月24日  
**ステータス**: 📋 **整備中**

---

## 📋 目的

本ガイドは、検索システムの最適化を維持し、将来的なデグレードを防止するための指針を提供します。

---

## 🎯 デグレード防止の原則

### 1. 変更前の確認

**必須チェック項目**:
- [ ] 変更が検索品質に影響しないか
- [ ] 変更がパフォーマンスに影響しないか
- [ ] 変更がメモリ使用量に影響しないか
- [ ] ConfluenceとJiraの両方で動作するか

### 2. テストの実行

**必須テスト**:
- [ ] 品質テスト: `npm run test:search-quality-limit-comparison`
- [ ] RRF早期絞り込みテスト: `npm run test:rrf-early-filtering`
- [ ] パフォーマンステスト: `npm run test:memory-analysis:production-data`
- [ ] 統合テスト: ConfluenceとJiraの両方でテスト

### 3. ドキュメントの更新

**必須更新項目**:
- [ ] アーキテクチャドキュメントの更新
- [ ] 変更理由の記録
- [ ] テスト結果の記録

---

## ⚠️ 注意すべき変更パターン

### 1. 検索取得件数の変更

**危険度**: 🔴 高

**影響範囲**:
- 検索品質（関連性の高い結果が除外される可能性）
- パフォーマンス（取得件数に比例して処理時間が増加）

**必須対応**:
- 品質テストの実施（重複率80%以上を維持）
- パフォーマンステストの実施
- 段階的な変更（例: 30倍 → 20倍 → 15倍）

**実装例**:
```typescript
// ❌ 悪い例: テストなしで一気に変更
const searchLimit = topK * 10; // 30倍から10倍に変更

// ✅ 良い例: 段階的に変更し、テストを実施
const searchLimit = topK * 15; // 30倍 → 15倍（テスト済み）
```

---

### 2. RRF_CANDIDATE_LIMITの変更

**危険度**: 🟡 中

**影響範囲**:
- 検索品質（RRF計算対象が減ると、関連性の高い結果が除外される可能性）
- パフォーマンス（RRF計算時間が削減される）

**必須対応**:
- 品質テストの実施（対象ページが10位以内に含まれることを確認）
- パフォーマンステストの実施
- 段階的な変更（例: 150件 → 100件 → 75件）

**実装例**:
```typescript
// ❌ 悪い例: テストなしで変更
const RRF_CANDIDATE_LIMIT = 50;

// ✅ 良い例: テスト済みの値を使用
const RRF_CANDIDATE_LIMIT = 75; // テスト済み（平均順位2.0位）
```

---

### 3. メモリ最適化の変更

**危険度**: 🟡 中

**影響範囲**:
- メモリ使用量（OOMリスク）
- 検索品質（必要なデータが削除されると品質が低下）

**必須対応**:
- メモリ監視ログの確認
- 検索品質テストの実施
- バッチサイズの調整

**実装例**:
```typescript
// ❌ 悪い例: バッチサイズを大きくしすぎる
const BATCH_SIZE = 200; // メモリピークが高くなる

// ✅ 良い例: 適切なバッチサイズを使用
const BATCH_SIZE = 50; // テスト済み（メモリピークを抑制）
```

---

### 4. BM25タイムアウトの変更

**危険度**: 🟡 中

**影響範囲**:
- 検索品質（BM25検索がスキップされると品質が低下）
- パフォーマンス（タイムアウトが長すぎるとユーザーを待たせる）

**必須対応**:
- GCSダウンロード時間の考慮
- 本番環境での動作確認
- ログの監視

**実装例**:
```typescript
// ❌ 悪い例: GCSダウンロード時間を考慮しない
const timeoutMs = 500; // GCSダウンロードに間に合わない

// ✅ 良い例: GCSダウンロード時間を考慮
const timeoutMs = 2000; // GCSダウンロード（300-1000ms）+ 解析（200-500ms）を考慮
```

---

### 5. フィールド削除の変更

**危険度**: 🟡 中

**影響範囲**:
- 検索品質（必要なフィールドが削除されると品質が低下）
- メモリ使用量（不要なフィールドを削除するとメモリが削減）

**必須対応**:
- ランキングロジックの確認（削除するフィールドがランキングに使用されていないか）
- 検索品質テストの実施

**実装例**:
```typescript
// ❌ 悪い例: ランキングに必要なフィールドを削除
const { title, content, ...rest } = r; // titleやcontentはランキングに必要

// ✅ 良い例: ランキングに不要なフィールドのみ削除
const { vector, url, originalTitle, originalContent, content, ...rest } = r;
// vector: _distanceで距離は計算済み
// url: 後で再構築可能
// content: ランキング後に上位結果のみ再取得
```

---

## 📋 チェックリスト

### 変更前

- [ ] 変更の目的を明確にする
- [ ] 影響範囲を特定する
- [ ] テスト計画を立てる
- [ ] ロールバック計画を立てる

### 変更中

- [ ] 段階的に変更する（一度に大きく変更しない）
- [ ] 各段階でテストを実施する
- [ ] ログを確認する

### 変更後

- [ ] 品質テストを実施する
- [ ] パフォーマンステストを実施する
- [ ] 本番環境で動作確認する
- [ ] ドキュメントを更新する

---

## 🔍 デグレード検出方法

### 1. ログ監視

**監視すべきログ**:
- `[BM25 Search] ⚠️ BM25検索が無効化されます` → BM25検索がスキップされている
- `⚠️ [Memory] Search execution ... RSS increased by +XXXMB` → メモリ使用量が増加
- `[PERF] 🔍 検索処理完了... 総時間 XXXms` → 検索時間が増加

### 2. 品質テスト

**定期実行**:
- `npm run test:search-quality-limit-comparison` (週1回推奨)
- `npm run test:rrf-early-filtering` (週1回推奨)

**合格基準**:
- 重複率: 80%以上
- 平均順位: 10位以内

### 3. パフォーマンステスト

**定期実行**:
- `npm run test:memory-analysis:production-data` (週1回推奨)

**合格基準**:
- 平均検索時間: 3秒以内
- メモリ増加: 500MB以内

---

## 📝 コード規約

### 1. マジックナンバーの禁止

**❌ 悪い例**:
```typescript
const searchLimit = topK * 15; // なぜ15倍？
```

**✅ 良い例**:
```typescript
// ★★★ 最適化: 取得件数を削減（メモリ使用量と検索速度の改善） ★★★
// 理由: テスト結果で100%の重複率を確認（topK * 30 vs topK * 15）
// 参考: docs/01-architecture/01.06.01-confluence-optimization-completion-summary.md
const SEARCH_LIMIT_MULTIPLIER = 15; // テスト済み（品質維持）
const searchLimit = topK * SEARCH_LIMIT_MULTIPLIER;
```

### 2. コメントの必須化

**必須コメント項目**:
- 変更理由
- テスト結果
- 参考ドキュメント
- 注意事項

**実装例**:
```typescript
// ★★★ 最適化: RRF早期絞り込み（パフォーマンス改善） ★★★
// 理由: 上位75件のみRRF計算を実行することで、約75-125ms削減
// テスト結果: 平均順位2.0位（合格基準: 10位以内）
// 参考: docs/99-archive/testing/performance-tests-2025-11-22/05.56-step5-rrf-early-filtering-2025-11-22.md
// 注意: 100件以下に削減する場合は、必ず品質テストを実施
const RRF_CANDIDATE_LIMIT = 75;
```

### 3. テストの必須化

**変更時に必須**:
- 品質テストの実施
- パフォーマンステストの実施
- テスト結果の記録

---

## 🔗 関連ドキュメント

- [Confluence最適化完了サマリー](./01.06.01-confluence-optimization-completion-summary.md)
- [LunrキャッシュGCS統合アーキテクチャ](./01.05.01-lunr-cache-gcs-integration.md)
- [パフォーマンステスト結果](../05-testing/05.73-performance-test-results-production-data-2025-11-23.md)

---

## 📚 参考資料

- [AI駆動開発 共通ガイドライン](../README.md#ai駆動開発-共通ガイドライン)
- [検索品質テスト](../05-testing/README.md)
- [パフォーマンステスト](../05-testing/README.md)

