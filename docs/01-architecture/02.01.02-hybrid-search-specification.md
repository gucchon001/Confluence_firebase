# ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  æœ€æ–°ä»•æ§˜æ›¸ (Phase 4å®Œäº†ç‰ˆ)

**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ6æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Phase 4 å®Œäº† + BOMé™¤å»å‡¦ç†ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ä¿®æ­£å®Œäº†  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æœ¬ç•ªç¨¼åƒä¸­  
**çµ±åˆå…ƒ**: `hybrid-search-contract.md`, `search-system-comprehensive-guide.md`

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [æ¤œç´¢ãƒ•ãƒ­ãƒ¼](#æ¤œç´¢ãƒ•ãƒ­ãƒ¼)
4. [å„æ¤œç´¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](#å„æ¤œç´¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
5. [ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°](#ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°)
6. [ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿](#ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿)
7. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹)
8. [åˆ¶é™äº‹é …ã¨ä»Šå¾Œã®èª²é¡Œ](#åˆ¶é™äº‹é …ã¨ä»Šå¾Œã®èª²é¡Œ)

---

## æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ ã®ç›®çš„
Confluenceãƒšãƒ¼ã‚¸ã«å¯¾ã™ã‚‹é«˜ç²¾åº¦ãªæ„å‘³æ¤œç´¢ã‚’å®Ÿç¾ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«æœ€ã‚‚é–¢é€£æ€§ã®é«˜ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æä¾›ã™ã‚‹ã€‚

### ä¸»è¦æ©Ÿèƒ½
- **ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢**: æ„å‘³çš„é¡ä¼¼æ€§ã«åŸºã¥ãæ¤œç´¢
- **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢**: BM25ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚‹å®Œå…¨ä¸€è‡´æ¤œç´¢
- **ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆæ¤œç´¢**: ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã®ç›´æ¥æ¤œç´¢ï¼ˆPhase 4ï¼‰
- **Knowledge Graphæ‹¡å¼µ**: å‚ç…§é–¢ä¿‚ã«åŸºã¥ãçµæœæ‹¡å¼µï¼ˆPhase 4ï¼‰
- **è¤‡åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°**: è¤‡æ•°ã®ã‚·ã‚°ãƒŠãƒ«ã‚’çµ±åˆã—ãŸæœ€é©ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **ãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: å“è³ªç®¡ç†ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ†é¡

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒª                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‰å‡¦ç†ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º                        â”‚
â”‚  â€¢ æ—¥æœ¬èªãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºï¼ˆkuromoji/lightweightï¼‰                   â”‚
â”‚  â€¢ ã‚³ã‚¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º                                           â”‚
â”‚  â€¢ ã‚¯ã‚¨ãƒªåŸ‹ã‚è¾¼ã¿ç”Ÿæˆï¼ˆtext-embedding-004ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢  â”‚ â”‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢â”‚ â”‚ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆ  â”‚ â”‚ãƒ©ãƒ™ãƒ«       â”‚
â”‚(LanceDB)     â”‚ â”‚(Lunr.js)     â”‚ â”‚æ¤œç´¢          â”‚ â”‚ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°â”‚
â”‚              â”‚ â”‚              â”‚ â”‚(Phase 4)     â”‚ â”‚             â”‚
â”‚â€¢ 768æ¬¡å…ƒ     â”‚ â”‚â€¢ BM25        â”‚ â”‚â€¢ LIKEæ¤œç´¢    â”‚ â”‚â€¢ exclude    â”‚
â”‚â€¢ ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼â”‚ â”‚â€¢ è»¢ç½®ç´¢å¼•    â”‚ â”‚â€¢ ã‚¿ã‚¤ãƒˆãƒ«    â”‚ â”‚â€¢ include    â”‚
â”‚  åº¦è¨ˆç®—      â”‚ â”‚â€¢ æ—¥æœ¬èªå¯¾å¿œ  â”‚ â”‚  å€™è£œç”Ÿæˆ    â”‚ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                 â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RRFèåˆï¼ˆReciprocal Rank Fusionï¼‰          â”‚
â”‚  â€¢ ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢çµæœã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé‡ã¿ 1.0ï¼‰                       â”‚
â”‚  â€¢ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢çµæœã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé‡ã¿ 0.8ï¼‰                      â”‚
â”‚  â€¢ ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆçµæœã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé‡ã¿ 1.2ï¼‰                        â”‚
â”‚  â€¢ BM25æ¤œç´¢çµæœã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé‡ã¿ 0.6ï¼‰                           â”‚
â”‚  â†’ çµ±ä¸€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«èåˆï¼ˆK=60ï¼‰                                  â”‚
â”‚  â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆãƒ»ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹é©ç”¨ï¼ˆRRFæ®µéšï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Knowledge Graphæ‹¡å¼µï¼ˆPhase 7: ç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰        â”‚
â”‚  âš ï¸ Phase 7ã§ç„¡åŠ¹åŒ–: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ‚ªåŒ–ï¼ˆ9.2ç§’ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼‰   â”‚
â”‚  â†’ å“è³ªå‘ä¸Šãªã—ï¼ˆç„¡åŠ¹åŒ–å¾Œã‚‚ç™ºè¦‹ç‡100%ç¶­æŒï¼‰                      â”‚
â”‚  â†’ æ¤œç´¢æ™‚é–“æ”¹å–„: 10.05ç§’ â†’ 0.88ç§’ï¼ˆ-91%æ”¹å–„ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¤‡åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°                           â”‚
â”‚  BM25(53%) + ã‚¿ã‚¤ãƒˆãƒ«(26%) + ãƒ©ãƒ™ãƒ«(16%)                       â”‚
â”‚  + ãƒ™ã‚¯ãƒˆãƒ«(5%) = 100%ï¼ˆPhase 7: KGç„¡åŠ¹åŒ–ï¼‰                   â”‚
â”‚                                                               â”‚
â”‚  â€¢ ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆçµæœ: titleMatchRatio â‰¥ 0.9ï¼ˆè¶…å¼·åŠ›ãƒ–ãƒ¼ã‚¹ãƒˆï¼‰   â”‚
â”‚  â€¢ ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹: 1ã¤ã§3.0å€ã€2ã¤ä»¥ä¸Šã§6.0å€            â”‚
â”‚  â€¢ ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆé©ç”¨ï¼ˆComposite Scoringæ®µéšï¼‰          â”‚
â”‚  â€¢ æ®µéšçš„ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°: ä¸Šä½100ä»¶ã®ã¿è©³ç´°è¨ˆç®—ã€æ®‹ã‚Šã¯ç°¡æ˜“ã‚¹ã‚³ã‚¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœ€çµ‚çµæœï¼ˆtopKä»¶ï¼‰                           â”‚
â”‚  â€¢ ã‚¹ã‚³ã‚¢é™é †ã‚½ãƒ¼ãƒˆ                                             â”‚
â”‚  â€¢ é‡è¤‡æ’é™¤                                                     â”‚
â”‚  â€¢ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆ15åˆ†é–“ã€LRUã€maxSize 5000ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¤œç´¢ãƒ•ãƒ­ãƒ¼

### 1. å‰å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º

```typescript
// 1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
const keywords = await unifiedKeywordExtractionService.extractKeywords(query);

// 2. ã‚¯ã‚¨ãƒªåŸ‹ã‚è¾¼ã¿ç”Ÿæˆ
const queryVector = await getEmbeddings(query);

// 3. ã‚¿ã‚¤ãƒˆãƒ«å€™è£œç”Ÿæˆï¼ˆPhase 4ï¼‰
const titleCandidates = generateTitleCandidates(keywords);
```

### 2. æ¤œç´¢ãƒ•ã‚§ãƒ¼ã‚º

#### 2.1 ä¸¦åˆ—æ¤œç´¢ã®å®Ÿè£…ï¼ˆPhase 5ï¼‰

**ç›®çš„**: ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¨BM25æ¤œç´¢ã‚’ä¸¦åˆ—å®Ÿè¡Œã—ã¦æ¤œç´¢æ™‚é–“ã‚’çŸ­ç¸®

**å®Ÿè£…**:
```typescript
// Promise.allSettledã§ä¸¦åˆ—å®Ÿè¡Œï¼ˆä¸€æ–¹ãŒå¤±æ•—ã—ã¦ã‚‚ç¶™ç¶šï¼‰
const [vectorSearchResult, bm25SearchResult] = await Promise.allSettled([
  executeVectorSearch(tbl, vector, params, finalKeywords, excludeLabels, topK),
  executeBM25Search(tbl, params, finalKeywords, topK, params.tableName || 'confluence')
]);

// çµæœã‚’å–å¾—ï¼ˆå¤±æ•—æ™‚ã¯ç©ºé…åˆ—ï¼‰
vectorResults = vectorSearchResult.status === 'fulfilled' ? vectorSearchResult.value : [];
bm25Results = bm25SearchResult.status === 'fulfilled' ? bm25SearchResult.value : [];
```

**ç‰¹å¾´**:
- **Promise.allSettled**: ä¸€æ–¹ãŒå¤±æ•—ã—ã¦ã‚‚ä»–æ–¹ã¯ç¶™ç¶š
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å¤±æ•—æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã™ï¼ˆæ¤œç´¢ã‚’ç¶™ç¶šï¼‰
- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨ˆæ¸¬**: ä¸¦åˆ—æ¤œç´¢ã®æ™‚é–“ã‚’è©³ç´°ã«è¨ˆæ¸¬
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°**: 5ç§’ä»¥ä¸Šã‹ã‹ã£ãŸå ´åˆã¯è­¦å‘Šã‚’å‡ºåŠ›

**æœŸå¾…åŠ¹æœ**:
- æ¤œç´¢æ™‚é–“ã®çŸ­ç¸®: é€æ¬¡å®Ÿè¡Œï¼ˆ260msï¼‰â†’ ä¸¦åˆ—å®Ÿè¡Œï¼ˆ150msã€æœ€é•·å‡¦ç†ã®ã¿ï¼‰
- æœŸå¾…å‰Šæ¸›: -42%ï¼ˆ260ms â†’ 150msï¼‰

**å®Ÿè£…å ´æ‰€**: `src/lib/lancedb-search-client.ts` (291-299è¡Œç›®)

---

#### 2.2 ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
```typescript
// LanceDBã§ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢
const vectorResults = await tbl
  .vectorSearch(queryVector)
  .limit(topK * 10)  // 10å€å–å¾—ã—ã¦å¾Œã§ãƒ•ã‚£ãƒ«ã‚¿
  .toArray();
```

**ä¸¦åˆ—å®Ÿè¡Œ**: Phase 5ã§BM25æ¤œç´¢ã¨ä¸¦åˆ—å®Ÿè¡Œ

#### 2.3 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆBM25ï¼‰
```typescript
// Lunr.jsè»¢ç½®ç´¢å¼•ã§æ¤œç´¢
for (const keyword of keywords.core) {
  const results = await lunrSearchClient.search(keyword);
  // BM25ã‚¹ã‚³ã‚¢ã‚’ä¿æŒ
}
```

**ä¸¦åˆ—å®Ÿè¡Œ**: Phase 5ã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¨ä¸¦åˆ—å®Ÿè¡Œ

#### 2.4 ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆæ¤œç´¢ï¼ˆPhase 4ï¼‰
```typescript
// ã‚¿ã‚¤ãƒˆãƒ«å€™è£œã‹ã‚‰ç›´æ¥LIKEæ¤œç´¢
for (const candidate of titleCandidates) {
  const results = await tbl.query()
    .where(`title LIKE '%${candidate}%'`)
    .limit(50)
    .toArray();
}
```

**æ³¨æ„**: ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆæ¤œç´¢ã¯ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆä¸¦åˆ—åŒ–å¯¾è±¡å¤–ï¼‰

### 3. èåˆãƒ•ã‚§ãƒ¼ã‚º

#### 3.1 RRFèåˆ

**ç›®çš„**: è¤‡æ•°ã®æ¤œç´¢çµæœã‚’çµ±åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«èåˆ

**å®Ÿè£…**: Reciprocal Rank Fusion (RRF)

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- **Kå€¤**: 60ï¼ˆæ¨™æº–çš„ãªRRFå®Ÿè£…ã§æ¨å¥¨ã•ã‚Œã‚‹å€¤ï¼‰
- **å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é‡ã¿**:
  - vector: 1.0ï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®åŸºæœ¬é‡ã¿ï¼‰
  - keyword: 0.8ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã€80%ã®é‡ã¿ï¼‰
  - title-exact: 1.2ï¼ˆã‚¿ã‚¤ãƒˆãƒ«å®Œå…¨ä¸€è‡´ã€æœ€é‡è¦120%ã®é‡ã¿ï¼‰
  - bm25: 0.6ï¼ˆBM25æ¤œç´¢ã€è£œåŠ©çš„60%ã®é‡ã¿ï¼‰

**è¨ˆç®—å¼**:
```typescript
// Reciprocal Rank Fusion
function calculateRRF(rank: number, k: number = 60): number {
  return 1 / (k + rank);
}

// å„æ¤œç´¢æ‰‹æ³•ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œæˆ
vecRank = Vectoræ¤œç´¢çµæœã®é †ä½
kwRank = Keywordæ¤œç´¢çµæœã®é †ä½
titleRank = Title Exactæ¤œç´¢çµæœã®é †ä½
bm25Rank = BM25æ¤œç´¢çµæœã®é †ä½

// RRFã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆé‡ã¿ä»˜ãï¼‰
rrf = (1.0 / (kRrf + vecRank)) +           // vector: é‡ã¿ 1.0
      0.8 * (1 / (kRrf + kwRank)) +        // keyword: é‡ã¿ 0.8
      (titleRank ? 1.2 * (1 / (kRrf + titleRank)) : 0) +  // title-exact: é‡ã¿ 1.2
      (bm25Rank ? 0.6 * (1 / (kRrf + bm25Rank)) : 0);     // bm25: é‡ã¿ 0.6
```

**é‡ã¿è¨­å®šã®ç†ç”±**:
- **title-exact (1.2)**: ã‚¿ã‚¤ãƒˆãƒ«å®Œå…¨ä¸€è‡´ã¯æœ€ã‚‚é‡è¦è¦–ï¼ˆ120%ï¼‰
- **vector (1.0)**: ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¯åŸºæœ¬é‡ã¿ï¼ˆ100%ï¼‰
- **keyword (0.8)**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã¯è£œåŠ©çš„ï¼ˆ80%ï¼‰
- **bm25 (0.6)**: BM25æ¤œç´¢ã¯è£œåŠ©çš„ï¼ˆ60%ï¼‰

**ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆãƒ»ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹**:
- RRFã‚¹ã‚³ã‚¢è¨ˆç®—å¾Œã€ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆãƒ»ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨
- è©³ç´°ã¯ã€ŒComposite Scoringã®è©³ç´°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§

**å®Ÿè£…å ´æ‰€**: `src/lib/unified-search-result-processor.ts` (227-269è¡Œç›®)

#### 3.2 Knowledge Graphæ‹¡å¼µï¼ˆPhase 4ï¼‰
```typescript
// ã‚¿ã‚¤ãƒˆãƒ«ãƒ–ãƒ¼ã‚¹ãƒˆçµæœã‹ã‚‰æ‹¡å¼µ
const titleBoostedResults = vectorResults
  .filter(r => r._titleBoosted)
  .slice(0, 50);

const kgExpanded1 = await expandTitleResultsWithKG(
  titleBoostedResults,
  tbl,
  { maxReferences: 3, minWeight: 0.7 }
);

// RRFä¸Šä½çµæœã‹ã‚‰ã‚‚æ‹¡å¼µï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ–ãƒ¼ã‚¹ãƒˆæ¼ã‚Œå¯¾ç­–ï¼‰
const topRrfResults = fusedResults.slice(0, 10);
const kgExpanded2 = await expandTitleResultsWithKG(
  topRrfResults,
  tbl,
  { maxReferences: 3, minWeight: 0.7 }
);
```

### 4. ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚º

```typescript
// è¤‡åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
const compositeScore = 
  vectorScore * 0.05 +      // ãƒ™ã‚¯ãƒˆãƒ«: 5%
  bm25Score * 0.50 +        // BM25: 50%
  titleScore * 0.25 +       // ã‚¿ã‚¤ãƒˆãƒ«: 25%
  labelScore * 0.15 +       // ãƒ©ãƒ™ãƒ«: 15%
  kgScore * 0.05;           // KG: 5%
```

---

## å„æ¤œç´¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢

**å®Ÿè£…**: LanceDB + Google Cloud Vertex AI Embeddings

#### ä»•æ§˜
- **ãƒ¢ãƒ‡ãƒ«**: `text-embedding-004`
- **æ¬¡å…ƒæ•°**: 768æ¬¡å…ƒ
- **è·é›¢é–¢æ•°**: ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦
- **æœ€å¤§è·é›¢**: 2.0ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–¾å€¤ï¼‰

#### ã‚¿ã‚¤ãƒˆãƒ«é‡è¤‡åŸ‹ã‚è¾¼ã¿ï¼ˆPhase 4ï¼‰
```typescript
// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ™‚ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’3å›ç¹°ã‚Šè¿”ã—ã¦ãƒ™ã‚¯ãƒˆãƒ«åŒ–
const TITLE_WEIGHT = 3;
const weightedText = `${title}\n\n`.repeat(TITLE_WEIGHT) + plainText;
const embedding = await generateEmbedding(weightedText);
```

#### ã‚¹ãƒãƒ¼ãƒˆãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°
- **ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º**: 1600æ–‡å­—
- **ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—**: 200æ–‡å­—
- **ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™**: 1024ãƒˆãƒ¼ã‚¯ãƒ³
- **ã‚¿ã‚¤ãƒˆãƒ«ç¶™æ‰¿**: å„ãƒãƒ£ãƒ³ã‚¯ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’å«ã‚ã‚‹

---

### ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆBM25ï¼‰

**å®Ÿè£…**: Lunr.js + Kuromoji

#### ä»•æ§˜
- **ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: BM25ï¼ˆOkapi BM25ï¼‰
- **è»¢ç½®ç´¢å¼•**: ãƒ¡ãƒ¢ãƒªå†…ç´¢å¼•ï¼ˆ~300MBï¼‰
- **æ—¥æœ¬èªå¯¾å¿œ**: kuromoji.jsï¼ˆå½¢æ…‹ç´ è§£æï¼‰
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: è»½é‡ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ï¼ˆkuromojiæœªæº–å‚™æ™‚ï¼‰

#### BM25ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
```typescript
// Lunr.js ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
k1 = 1.2;  // æ–‡æ›¸é »åº¦ã®å½±éŸ¿åº¦
b = 0.75;  // æ–‡æ›¸é•·ã®æ­£è¦åŒ–
```

#### ã‚¹ã‚³ã‚¢æ­£è¦åŒ–
```typescript
// BM25ã‚¹ã‚³ã‚¢ â†’ 0-1æ­£è¦åŒ–
const normalizedBM25 = Math.min(score / maxBm25Score, 1.0);
// maxBm25Score = 30.0ï¼ˆé«˜ã‚¹ã‚³ã‚¢å¯¾å¿œï¼‰
```

---

### ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆæ¤œç´¢ï¼ˆPhase 4ï¼‰

**ç›®çš„**: ã‚¿ã‚¤ãƒˆãƒ«ã«æ˜ç¤ºçš„ã«å«ã¾ã‚Œã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ã®ç›´æ¥æ¤œç´¢

#### ã‚¿ã‚¤ãƒˆãƒ«å€™è£œç”Ÿæˆï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
```typescript
function generateTitleCandidates(keywords: string[]): string[] {
  const candidates: string[] = [];
  
  // 1. 2èªã®çµ„ã¿åˆã‚ã›ã‚’ç”Ÿæˆï¼ˆé †åºã‚’è€ƒæ…®ã—ã¦ä¸¡æ–¹å‘ã‚’ç”Ÿæˆï¼‰
  for (let i = 0; i < keywords.length; i++) {
    for (let j = i + 1; j < keywords.length; j++) {
      candidates.push(`${keywords[i]}${keywords[j]}`);
      candidates.push(`${keywords[j]}${keywords[i]}`);
    }
  }
  
  // 2. å˜ä¸€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚‚è¿½åŠ 
  candidates.push(...keywords);
  
  return candidates;
}
```

**æ³¨æ„**: 
- å®Ÿè£…ã§ã¯2èªçµ„ã¿åˆã‚ã›ã¾ã§ç”Ÿæˆï¼ˆ3èªçµ„ã¿åˆã‚ã›ã¯æœªå®Ÿè£…ï¼‰
- ã‚¿ã‚¤ãƒˆãƒ«å€™è£œæ•°ã¯æœ€å¤§10ä»¶ã«åˆ¶é™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
- å®Ÿéš›ã®ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒãƒ³ã‚°ã¯ `calculateTitleMatch` ã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢çµæœã«å¯¾ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹

#### æ¤œç´¢å®Ÿè¡Œ
```typescript
// LanceDBã®LIKEæ¤œç´¢
const results = await tbl.query()
  .where(`title LIKE '%${candidate}%'`)
  .limit(50)
  .toArray();

// _titleBoostedãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸
results.forEach(r => r._titleBoosted = true);
```

#### ã‚¹ã‚³ã‚¢ãƒ–ãƒ¼ã‚¹ãƒˆ
```typescript
// ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆçµæœã¯è¶…å¼·åŠ›ãƒ–ãƒ¼ã‚¹ãƒˆ
if (result._sourceType === 'title-exact') {
  titleMatchRatio = Math.max(titleMatchRatio, 0.9);  // æœ€ä½90%
}
```

---

### Knowledge Graphæ‹¡å¼µï¼ˆPhase 4ï¼‰

**âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ”´ **Phase 7ã§ç„¡åŠ¹åŒ–æ¸ˆã¿**

**ç„¡åŠ¹åŒ–ç†ç”±**:
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ‚ªåŒ–: KGæ‹¡å¼µã«ã‚ˆã‚Šæ¤œç´¢æ™‚é–“ãŒ9.2ç§’ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’ç™ºç”Ÿ
- å“è³ªå‘ä¸Šãªã—: KGç„¡åŠ¹åŒ–å¾Œã‚‚ç™ºè¦‹ç‡100%ã‚’ç¶­æŒ
- æ”¹å–„åŠ¹æœ: æ¤œç´¢æ™‚é–“ãŒ10.05ç§’ â†’ 0.88ç§’ï¼ˆ-91%æ”¹å–„ï¼‰

**å°†æ¥è¨ˆç”»**:
- ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰/è©³ç´°åˆ†æãƒ¢ãƒ¼ãƒ‰ï¼‰ã®å®Ÿè£…ã‚’æ¤œè¨
- å‚è€ƒ: [GraphRAG ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰æ¤œç´¢ææ¡ˆ](./07.01.01-graphrag-dual-mode-search.md)

---

**ä»¥ä¸‹ã¯ç„¡åŠ¹åŒ–å‰ã®å®Ÿè£…å†…å®¹ï¼ˆå‚è€ƒç”¨ï¼‰:**

**ç›®çš„**: ãƒšãƒ¼ã‚¸é–“ã®å‚ç…§é–¢ä¿‚ã‚’æ´»ç”¨ã—ãŸçµæœæ‹¡å¼µ

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Firestore
- **ãƒãƒ¼ãƒ‰**: `kg_nodes` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
- **ã‚¨ãƒƒã‚¸**: `kg_edges` ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
- **ãƒãƒ¼ãƒ‰IDå½¢å¼**: `page-{pageId}` (ä¾‹: `page-718373062`)

#### ã‚¨ãƒƒã‚¸ã‚¿ã‚¤ãƒ—
1. **reference**: å‚ç…§é–¢ä¿‚ï¼ˆweight: 1.0ï¼‰
2. **implements**: å®Ÿè£…é–¢ä¿‚ï¼ˆweight: 1.0ï¼‰
3. **related**: é–¢é€£é–¢ä¿‚ï¼ˆweight: 0.7-1.0ï¼‰

#### æ‹¡å¼µãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç„¡åŠ¹åŒ–å‰ï¼‰
```typescript
async function expandTitleResultsWithKG(
  results: any[],
  tbl: any,
  options: { maxReferences: number; minWeight: number }
): Promise<any[]> {
  const expandedResults = [...results];
  
  for (const result of results) {
    if (!result.pageId) continue;
    
    // 1. reference/implementså–å¾—
    let kgResult = await kgSearchService.getReferencedPages(
      result.pageId,
      options.maxReferences * 3  // 3å€å–å¾—ï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
    );
    
    // 2. è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°relatedå–å¾—
    if (kgResult.relatedPages.length === 0) {
      kgResult = await kgSearchService.getRelatedPages(result.pageId, {
        maxResults: options.maxReferences * 3,
        minWeight: options.minWeight,
        edgeTypes: ['related']
      });
    }
    
    // 3. LanceDBã‹ã‚‰å‚ç…§å…ˆãƒšãƒ¼ã‚¸å–å¾—
    for (const item of kgResult.relatedPages.slice(0, options.maxReferences)) {
      const referencedPage = await fetchPageFromLanceDB(tbl, item.node.pageId);
      
      if (referencedPage) {
        expandedResults.push({
          ...referencedPage,
          _sourceType: 'kg-reference',
          _kgWeight: item.edge.weight,
          _referencedFrom: result.title
        });
      }
    }
  }
  
  return expandedResults;
}
```

#### page_idæ¤œç´¢ã®å®Ÿè£…ï¼ˆé‡è¦ï¼‰
```typescript
// âš ï¸ LanceDBã®SQLæ–¹è¨€ã§ã¯ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆï¼ˆ`ï¼‰ãŒå¿…é ˆ
// æ³¨æ„: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯`page_id`ï¼ˆint64å‹ï¼‰ã€é–¢æ•°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯`pageId`ï¼ˆstringå‹ï¼‰
async function fetchPageFromLanceDB(tbl: any, pageId: string): Promise<any | null> {
  const numericPageId = parseInt(pageId);  // string â†’ numberå¤‰æ›
  const results = await tbl.query()
    .where(`\`page_id\` = ${numericPageId}`)  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯page_id
    .limit(1)
    .toArray();
  
  return results.length > 0 ? results[0] : null;
}
```

#### æ‹¡å¼µã‚¿ã‚¤ãƒŸãƒ³ã‚°
1. **ã‚¿ã‚¤ãƒˆãƒ«ãƒ–ãƒ¼ã‚¹ãƒˆçµæœï¼ˆä¸Šä½50ä»¶ï¼‰**: ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆã§ãƒ’ãƒƒãƒˆã—ãŸãƒšãƒ¼ã‚¸
2. **RRFä¸Šä½10ä»¶**: ã‚¿ã‚¤ãƒˆãƒ«ãƒ–ãƒ¼ã‚¹ãƒˆã•ã‚Œãªã‹ã£ãŸé‡è¦ãƒšãƒ¼ã‚¸ï¼ˆPhase 4.1ã§è¿½åŠ ï¼‰

---

## ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

### è¤‡åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°è¨­å®š

```typescript
const DEFAULT_CONFIG = {
  // Phase 7æœ€é©åŒ–: KGæ‹¡å¼µç„¡åŠ¹åŒ–ã«ä¼´ã†é‡ã¿å†é…åˆ†
  // BM25ï¼ˆ53%ï¼‰+ ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ26%ï¼‰+ ãƒ©ãƒ™ãƒ«ï¼ˆ16%ï¼‰+ ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ5%ï¼‰= 100%
  vectorWeight: 0.05,   // ãƒ™ã‚¯ãƒˆãƒ«: 5%ï¼ˆæœ€å°åŒ–ï¼šç©ºé–“å¤‰åŒ–ã®å½±éŸ¿ã‚’è»½æ¸›ï¼‰
  bm25Weight: 0.53,     // BM25: 53%ï¼ˆæœ€å„ªå…ˆï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®Œå…¨ä¸€è‡´ã€KGåˆ†1%ã‚’è¿½åŠ ï¼‰
  titleWeight: 0.26,    // ã‚¿ã‚¤ãƒˆãƒ«: 26%ï¼ˆå¼·åŒ–ï¼šã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã‚’é‡è¦–ã€KGåˆ†1%ã‚’è¿½åŠ ï¼‰
  labelWeight: 0.16,    // ãƒ©ãƒ™ãƒ«: 16%ï¼ˆå¼·åŒ–ï¼šStructuredLabelæ´»ç”¨ã€KGåˆ†1%ã‚’è¿½åŠ ï¼‰
  kgWeight: 0.00,       // KG: 0%ï¼ˆPhase 7: ç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰
  maxVectorDistance: 2.0,
  maxBm25Score: 30.0    // 10.0â†’30.0: BM25é«˜ã‚¹ã‚³ã‚¢ï¼ˆkeyword=22ãªã©ï¼‰ã‚’é©åˆ‡ã«è©•ä¾¡
};
```

**é‡ã¿é…åˆ†ã®å¤‰æ›´å±¥æ­´**:
- Phase 4: BM25(50%) + ã‚¿ã‚¤ãƒˆãƒ«(25%) + ãƒ©ãƒ™ãƒ«(15%) + ãƒ™ã‚¯ãƒˆãƒ«(5%) + KG(5%) = 100%
- Phase 7: BM25(53%) + ã‚¿ã‚¤ãƒˆãƒ«(26%) + ãƒ©ãƒ™ãƒ«(16%) + ãƒ™ã‚¯ãƒˆãƒ«(5%) = 100%ï¼ˆKGç„¡åŠ¹åŒ–ï¼‰

### å„ã‚·ã‚°ãƒŠãƒ«ã®æ­£è¦åŒ–

#### 1. ãƒ™ã‚¯ãƒˆãƒ«è·é›¢ï¼ˆ0-1æ­£è¦åŒ–ï¼‰
```typescript
// ã‚³ã‚µã‚¤ãƒ³è·é›¢ â†’ é¡ä¼¼åº¦
const vectorScore = 1 - Math.min(distance / maxVectorDistance, 1.0);
```

#### 2. BM25ã‚¹ã‚³ã‚¢ï¼ˆ0-1æ­£è¦åŒ–ï¼‰
```typescript
const bm25Score = Math.min(rawBm25Score / maxBm25Score, 1.0);
```

#### 3. ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒç‡
```typescript
// ã‚¯ã‚¨ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚¿ã‚¤ãƒˆãƒ«ã®ä¸€è‡´ç‡
const titleMatchRatio = matchedKeywords / totalKeywords;

// ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆçµæœã¯å¼·åˆ¶ãƒ–ãƒ¼ã‚¹ãƒˆ
if (result._sourceType === 'title-exact') {
  titleMatchRatio = Math.max(titleMatchRatio, 0.9);
}
```

#### 4. ãƒ©ãƒ™ãƒ«ã‚¹ã‚³ã‚¢
```typescript
// Structured Labelè©•ä¾¡
const labelScore = 
  (result.structured_confidence || 0) * 0.5 +      // ä¿¡é ¼åº¦
  (result.structured_is_valid ? 0.3 : 0) +         // æœ‰åŠ¹æ€§
  (priorityScore * 0.2);                            // å„ªå…ˆåº¦
```

#### 5. KGãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆPhase 7: ç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰
```typescript
const kgBoost = 0;  // Phase 7: KGæ‹¡å¼µç„¡åŠ¹åŒ–æ¸ˆã¿ï¼ˆå¸¸ã«0ï¼‰
```

### æœ€çµ‚ã‚¹ã‚³ã‚¢è¨ˆç®—

```typescript
const finalScore = 
  vectorScore * vectorWeight +
  bm25Score * bm25Weight +
  titleMatchRatio * titleWeight +
  labelScore * labelWeight +
  kgBoost * kgWeight;  // Phase 7: å¸¸ã«0ï¼ˆç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰
```

---

### Composite Scoringã®è©³ç´°

#### ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹

**ç›®çš„**: StructuredLabelã®tagsã¨ã‚¯ã‚¨ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸€è‡´ã‚’æ¥µã‚ã¦é‡è¦–

**å®Ÿè£…å ´æ‰€**: 
- RRFæ®µéš: `src/lib/unified-search-result-processor.ts` (309-336è¡Œç›®)
- Composite Scoringæ®µéš: `src/lib/composite-scoring-service.ts` (156-172è¡Œç›®)

**RRFæ®µéšã®ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹**:
```typescript
// ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹ï¼ˆStructuredLabelã®tagsã¨ã‚¯ã‚¨ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸€è‡´ï¼‰
if (matchedTagCount > 0) {
  // 1ã¤ã®ã‚¿ã‚°ãƒãƒƒãƒ: 2.0å€ã€2ã¤ä»¥ä¸Š: 3.0å€
  const tagBoost = matchedTagCount === 1 ? 2.0 : 3.0;
  rrf *= tagBoost;
}
```

**Composite Scoringæ®µéšã®ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹**:
```typescript
// ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹ã‚’å…ˆã«é©ç”¨ï¼ˆæ¸›è¡°ã®å‰ã«é©ç”¨ã—ã¦ã€æ¸›è¡°ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
if (matchedTagCount > 0) {
  // 1ã¤ã®ã‚¿ã‚°ãƒãƒƒãƒ: 3.0å€ã€2ã¤ä»¥ä¸Š: 6.0å€ï¼ˆComposite Scoreã«ç›´æ¥åæ˜ ã€ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ã‚’æ¥µã‚ã¦é‡è¦–ï¼‰
  const tagBoost = matchedTagCount === 1 ? 3.0 : 6.0;
  compositeScore.finalScore *= tagBoost;
}
```

**ãƒœãƒ¼ãƒŠã‚¹å€ç‡**:
- **RRFæ®µéš**: 1ã¤ã§2.0å€ã€2ã¤ä»¥ä¸Šã§3.0å€
- **Composite Scoringæ®µéš**: 1ã¤ã§3.0å€ã€2ã¤ä»¥ä¸Šã§6.0å€ï¼ˆã‚ˆã‚Šå¼·åŠ›ï¼‰

**ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯**:
- `structured_tags` ã¨ã‚¯ã‚¨ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸€è‡´ã‚’ç¢ºèª
- éƒ¨åˆ†ä¸€è‡´ã‚‚å«ã‚€ï¼ˆ`tag.includes(keyword)` ã¾ãŸã¯ `keyword.includes(tag)`ï¼‰
- é‡è¤‡ã‚¿ã‚°ã¯Setã‚’ä½¿ç”¨ã—ã¦æ’é™¤

---

#### ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯

**ç›®çš„**: ã‚¯ã‚¨ãƒªã«é–¢é€£ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ¼ã‚¹ãƒˆã—ã€æ±ç”¨æ–‡æ›¸ã‚’æ¸›è¡°

**å®Ÿè£…å ´æ‰€**:
- RRFæ®µéš: `src/lib/unified-search-result-processor.ts` (276-345è¡Œç›®)
- Composite Scoringæ®µéš: `src/lib/composite-scoring-service.ts` (230-367è¡Œç›®)

**ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ«ãƒ¼ãƒ«**:

1. **è­°äº‹éŒ²ãƒ»ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ©ãƒ™ãƒ«** (RRFæ®µéšã®ã¿):
   ```typescript
   if (hasPenalty) rrf *= 0.9;  // 10%æ¸›è¡°
   ```
   - ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ©ãƒ™ãƒ«: `labelManager.getPenaltyTerms()` ã§å®šç¾©

2. **æ±ç”¨æ–‡æ›¸** (ä¸¡æ®µéšã§é©ç”¨):
   ```typescript
   if (isGenericDoc) {
     rrf *= 0.5;      // RRFæ®µéš: 50%æ¸›è¡°
     score *= 0.5;    // Composite Scoringæ®µéš: 50%æ¸›è¡°
   }
   ```
   - æ±ç”¨æ–‡æ›¸ã®å®šç¾©: `GENERIC_DOCUMENT_TERMS` ã«å«ã¾ã‚Œã‚‹ç”¨èª
   - ä¾‹: ã€Œå…±é€šè¦ä»¶ã€ã€Œãƒ•ãƒ­ãƒ¼ä¸€è¦§ã€ã€Œä¸€è¦§ã€ãªã©

3. **æœ¬ã‚·ã‚¹ãƒ†ãƒ å¤–** (RRFæ®µéšã®ã¿):
   ```typescript
   if (title.includes('æœ¬ã‚·ã‚¹ãƒ†ãƒ å¤–')) rrf *= 0.8;  // 20%æ¸›è¡°
   ```

**ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ¼ã‚¹ãƒˆãƒ«ã‚¸ãƒƒã‚¯**:

```typescript
// Phase 5æ”¹å–„: ã‚¯ã‚¨ãƒªã¨ã‚¿ã‚¤ãƒˆãƒ«ã®ä¸¡æ–¹ã«å«ã¾ã‚Œã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã‚’ãƒ–ãƒ¼ã‚¹ãƒˆ
const matchingKeywordCount = CommonTermsHelper.countMatchingDomainKeywords(query, title);

if (matchingKeywordCount > 0 && !isGenericDoc) {
  // ãƒãƒƒãƒã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°ã«å¿œã˜ã¦ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆæœ€å¤§2å€ï¼‰
  const boostFactor = 1.0 + (matchingKeywordCount * 0.5);
  const actualBoost = Math.min(boostFactor, 2.0);
  score *= actualBoost;
}
```

**ãƒ–ãƒ¼ã‚¹ãƒˆè¨ˆç®—**:
- ãƒãƒƒãƒã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°ã«å¿œã˜ã¦ãƒ–ãƒ¼ã‚¹ãƒˆ: `1.0 + (matchingKeywordCount * 0.5)`
- æœ€å¤§2å€ã¾ã§ãƒ–ãƒ¼ã‚¹ãƒˆ
- æ±ç”¨æ–‡æ›¸ã«ã¯é©ç”¨ã•ã‚Œãªã„ï¼ˆæ¸›è¡°ã¨ç«¶åˆã‚’é¿ã‘ã‚‹ï¼‰

**ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆ**:

1. **æ©Ÿèƒ½ã‚¯ã‚¨ãƒªæ™‚ã®specã‚«ãƒ†ã‚´ãƒªãƒ–ãƒ¼ã‚¹ãƒˆ** (Composite Scoringæ®µéšã®ã¿):
   ```typescript
   if (functionalQuery && structuredCategory === 'spec') {
     score *= 1.5;  // 50%ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆæ©Ÿèƒ½ã‚¯ã‚¨ãƒªæ™‚ã¯ä»•æ§˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å„ªå…ˆï¼‰
   }
   ```

2. **templateã‚«ãƒ†ã‚´ãƒªã®æ¸›è¡°** (Composite Scoringæ®µéšã®ã¿):
   ```typescript
   if (structuredCategory === 'template') {
     if (functionalQuery) {
       // æ©Ÿèƒ½ä»•æ§˜ç³»ã®è³ªå•ã¯ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¥µã‚ã¦å¼·ãæ¸›è¡°
       const decayFactor = emailLikeQuery ? 0.05 : 0.02;  // 95%ã€œ98%æ¸›è¡°
       score *= decayFactor;
     }
   }
   ```

3. **deprecatedã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ¸›è¡°** (Composite Scoringæ®µéšã®ã¿):
   ```typescript
   if (structuredStatus === 'deprecated') {
     score *= 0.05;  // 95%æ¸›è¡°ï¼ˆã»ã¼é™¤å¤–ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§é™¤å¤–ã•ã‚Œã‚‹å‰æï¼‰
   }
   ```

---

### ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ•ãƒ­ãƒ¼

#### 1. RRFèåˆ
```
ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢çµæœ + BM25æ¤œç´¢çµæœ
  â†“
RRFã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆK=60ã€é‡ã¿ä»˜ãï¼‰
  â†“
ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆãƒ»ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹é©ç”¨ï¼ˆRRFæ®µéšï¼‰
  â†“
RRFã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
```

#### 2. Composite Scoringï¼ˆä¸Šä½100ä»¶ã®ã¿ï¼‰
```
RRFä¸Šä½100ä»¶
  â†“
å„ã‚·ã‚°ãƒŠãƒ«ã®æ­£è¦åŒ–ï¼ˆ0-1ç¯„å›²ï¼‰
  â†“
é‡ã¿ä»˜ãåˆè¨ˆï¼ˆBM25 53% + ã‚¿ã‚¤ãƒˆãƒ« 26% + ãƒ©ãƒ™ãƒ« 16% + ãƒ™ã‚¯ãƒˆãƒ« 5%ï¼‰
  â†“
ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹é©ç”¨ï¼ˆ3.0å€ or 6.0å€ï¼‰
  â†“
ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆé©ç”¨ï¼ˆComposite Scoringæ®µéšï¼‰
  â†“
è¤‡åˆã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
```

#### 3. æœ€çµ‚çµ±åˆ
```
è©³ç´°Composite Scoringï¼ˆä¸Šä½100ä»¶ï¼‰
  +
ç°¡æ˜“ã‚¹ã‚³ã‚¢ï¼ˆæ®‹ã‚Šã€RRFã‚¹ã‚³ã‚¢Ã—50%ï¼‰
  â†“
æœ€çµ‚ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
  â†“
topKä»¶ã‚’è¿”ã™
```

---

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|-----------|-----|----------|------|
| `query` | string | **å¿…é ˆ** | æ¤œç´¢ã‚¯ã‚¨ãƒª |
| `topK` | number | 5 | è¿”å´ä»¶æ•° |
| `maxDistance` | number | 2.0 | ãƒ™ã‚¯ãƒˆãƒ«è·é›¢ã®æœ€å¤§é–¾å€¤ |
| `useLunrIndex` | boolean | true | Lunrç´¢å¼•ã‚’ä½¿ç”¨ã™ã‚‹ã‹ |
| `labelFilters` | object | `{includeMeetingNotes: false}` | ãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š |
| `includeLabels` | string[] | - | åŒ…å«ãƒ•ã‚£ãƒ«ã‚¿ç”¨ãƒ©ãƒ™ãƒ« |
| `exactTitleCandidates` | string[] | - | ã‚¿ã‚¤ãƒˆãƒ«å³æ ¼ä¸€è‡´å€™è£œ |

### ãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```typescript
interface LabelFilterOptions {
  includeMeetingNotes?: boolean;     // è­°äº‹éŒ²ã‚’å«ã‚ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰
  excludeLabels?: string[];          // é™¤å¤–ãƒ©ãƒ™ãƒ«
  includeLabels?: string[];          // åŒ…å«ãƒ©ãƒ™ãƒ«ï¼ˆORæ¡ä»¶ï¼‰
}
```

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé™¤å¤–ãƒ©ãƒ™ãƒ«
```typescript
const DEFAULT_EXCLUDE_LABELS = [
  'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–',
  'è­°äº‹éŒ²'  // includeMeetingNotes=falseã®å ´åˆ
];
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

#### æ¤œç´¢çµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥
```typescript
const cache = new GenericCache<any[]>({
  ttl: 15 * 60 * 1000,     // Phase 5: 5åˆ† â†’ 15åˆ†ã«æ‹¡å¤§ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡å‘ä¸Šï¼‰
  maxSize: 5000,           // Phase 5: 1000 â†’ 5000ã«æ‹¡å¤§ï¼ˆã‚ˆã‚Šå¤šãã®ã‚¯ã‚¨ãƒªã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  evictionStrategy: 'lru'  // LRUæ–¹å¼
});
```

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
```typescript
function generateCacheKey(query: string, params: any): string {
  const normalized = query.toLowerCase().trim();
  const paramString = JSON.stringify({
    topK: params.topK || 5,
    maxDistance: params.maxDistance || 2.0,
    labelFilters: params.labelFilters
  });
  return `${normalized}_${Buffer.from(paramString).toString('base64').slice(0, 20)}`;
}
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ç›®æ¨™

| æ“ä½œ | ç›®æ¨™æ™‚é–“ | å®Ÿæ¸¬å€¤ |
|-----|---------|--------|
| ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ | < 200ms | ~150ms |
| ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ | < 50ms | ~30ms |
| ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆæ¤œç´¢ | < 100ms | ~80ms |
| KGæ‹¡å¼µ | < 300ms | ~250ms |
| **åˆè¨ˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ï¼‰** | **< 1000ms** | **~800ms** |
| **åˆè¨ˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼‰** | **< 10ms** | **~5ms** |

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ä½¿ç”¨é‡ |
|--------------|--------|
| Lunrç´¢å¼• | ~300MB |
| æ¤œç´¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ~50MB |
| LanceDBã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ | ~100MB |
| **åˆè¨ˆ** | **~450MB** |

---

## åˆ¶é™äº‹é …ã¨ä»Šå¾Œã®èª²é¡Œ

### ç¾åœ¨ã®åˆ¶é™äº‹é …

#### 1. LanceDB SQLæ–¹è¨€ã®åˆ¶ç´„
- **å•é¡Œ**: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®å¼•ç”¨ç¬¦ã«`"`ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆï¼‰ãŒä½¿ãˆãªã„
- **å¯¾å¿œ**: `` ` ``ï¼ˆãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆï¼‰ã‚’ä½¿ç”¨
- **å½±éŸ¿**: WHEREå¥ã§ã®pageIdæ¤œç´¢æ™‚ã«æ³¨æ„ãŒå¿…è¦

```typescript
// âŒ å‹•ä½œã—ãªã„ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¯ä½¿ç”¨ä¸å¯ï¼‰
.where('"page_id" = 123')

// âœ… æ­£å¸¸å‹•ä½œï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯page_idã€int64å‹ï¼‰
.where('`page_id` = 123')
```

#### 2. KGãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆ
- **å•é¡Œ**: KGã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ãŒLanceDBã«å­˜åœ¨ã—ãªã„å ´åˆãŒã‚ã‚‹
- **å¯¾å¿œ**: `fetchPageFromLanceDB`ã§nullãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½
- **å½±éŸ¿**: ä¸€éƒ¨ã®KGå‚ç…§ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹

#### 3. ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ã®å¤‰åŒ–
- **å•é¡Œ**: ãƒšãƒ¼ã‚¸é™¤å¤–ï¼ˆ70ä»¶ï¼‰ã«ã‚ˆã‚Šãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ãŒå¤‰åŒ–
- **å¯¾å¿œ**: BM25ã¨ã‚¿ã‚¤ãƒˆãƒ«ã®é‡ã¿ã‚’å¼·åŒ–ï¼ˆåˆè¨ˆ75%ï¼‰
- **å½±éŸ¿**: ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®é‡ã¿ã‚’5%ã«æŠ‘åˆ¶

### ä»Šå¾Œã®æ”¹å–„èª²é¡Œ

#### Phase 5ä»¥é™ã®è¨ˆç”»

1. **ãƒ™ã‚¯ãƒˆãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å†æ§‹ç¯‰**
   - é™¤å¤–ãƒšãƒ¼ã‚¸ã‚’åæ˜ ã—ãŸå®Œå…¨å†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
   - ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ã®æœ€é©åŒ–

2. **KGãƒ‡ãƒ¼ã‚¿ã®åŒæœŸå¼·åŒ–**
   - LanceDBã¨KGã®ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
   - è‡ªå‹•åŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®å®Ÿè£…

3. **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®æœ€é©åŒ–**
   - ã‚¹ã‚³ã‚¢é‡ã¿ä»˜ã‘ã®å‹•çš„èª¿æ•´
   - ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æˆ¦ç•¥

4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„**
   - KGæ‹¡å¼µã®ä¸¦åˆ—åŒ–
   - ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®é«˜é€ŸåŒ–ï¼ˆGPUæ´»ç”¨ï¼‰

5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®çµ±åˆ**
   - ã‚¯ãƒªãƒƒã‚¯ç‡ã«ã‚ˆã‚‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª¿æ•´
   - æ¤œç´¢ãƒ­ã‚°åˆ†æã«ã‚ˆã‚‹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

---

## ã¾ã¨ã‚

### ä¸»è¦ãªæˆæœ

âœ… **Phase 4å®Œäº†**: 
- ã‚¿ã‚¤ãƒˆãƒ«æ•‘æ¸ˆæ¤œç´¢å®Ÿè£…
- Knowledge Graphæ‹¡å¼µå®Ÿè£…
- pageIdæ¤œç´¢å•é¡Œè§£æ±ºï¼ˆãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰

âœ… **æ¤œç´¢å“è³ªå‘ä¸Š**:
- Case 2ï¼ˆæ•™å®¤å‰Šé™¤æ©Ÿèƒ½ï¼‰: 0% â†’ 100%æ”¹å–„
- å…¨ä½“ç™ºè¦‹ç‡: 100%é”æˆ
- KGæ‹¡å¼µç™ºå‹•ç‡: 100%ï¼ˆå…¨3ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰

âœ… **æŠ€è¡“çš„æˆæœ**:
- LanceDB WHEREå¥ã®æ­£å¸¸å‹•ä½œç¢ºèª
- pageIdå‹ã®çµ±ä¸€ï¼ˆstringï¼‰
- KGå‚ç…§ãƒ‘ã‚¹ã®ç¢ºç«‹

### ã‚·ã‚¹ãƒ†ãƒ ã®å¼·ã¿

1. **å¤šå±¤æ¤œç´¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: ãƒ™ã‚¯ãƒˆãƒ«ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚¿ã‚¤ãƒˆãƒ«ã€KGã‚’çµ±åˆ
2. **é«˜ç²¾åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°**: è¤‡åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹æœ€é©åŒ–
3. **é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ã§å¹³å‡5msï¼ˆãƒ’ãƒƒãƒˆæ™‚ï¼‰
4. **æŸ”è»Ÿãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: ãƒ©ãƒ™ãƒ«ãƒ™ãƒ¼ã‚¹ã®å“è³ªç®¡ç†

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸](./01.02.01-lancedb-firestore-integration-design.md)
- [ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢è¨­è¨ˆ](./enhanced-hybrid-search-design.md)
- [Phase 0A-2 ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](./phase-0a-roadmap-final.md)
- [ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¬ã‚¤ãƒ‰](../test-execution-guide.md)
- [LanceDBçµ±åˆã‚¬ã‚¤ãƒ‰](./01.02.04-lancedb-integration-guide.md)

---

## è£œè¶³: æ¤œç´¢APIå¥‘ç´„ï¼ˆçµ±åˆå…ƒ: hybrid-search-contract.mdï¼‰

### å…¥åŠ›ï¼ˆSearchParamsï¼‰
- `query: string` - æ¤œç´¢ã‚¯ã‚¨ãƒª
- `topK?: number`ï¼ˆæ—¢å®š: 12ï¼‰ - è¿”å´ä»¶æ•°
- `useLunrIndex?: boolean`ï¼ˆæ—¢å®š: falseï¼‰ - Lunrã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ãƒ•ãƒ©ã‚°
- `labelFilters?: { includeMeetingNotes: boolean; includeArchived: boolean }` - ãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿
- `tableName?: string`ï¼ˆæ—¢å®š: `confluence`ï¼‰ - ãƒ†ãƒ¼ãƒ–ãƒ«å

### å‡ºåŠ›ï¼ˆSearchResultï¼‰å¿…é ˆé …ç›®
- `pageId: string` - ãƒšãƒ¼ã‚¸IDï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã€å¤‰æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§`page_id`ã‹ã‚‰å¤‰æ›ï¼‰
  - æ³¨æ„: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯`page_id`ï¼ˆint64å‹ï¼‰ã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã¯`pageId`ï¼ˆstringå‹ï¼‰ã‚’ç¶­æŒ
- `title: string` - ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«
- `content: string` - ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- `labels: string[]` - ãƒ©ãƒ™ãƒ«é…åˆ—
- `url: string` - ãƒšãƒ¼ã‚¸URL
- `source: 'vector' | 'bm25' | 'hybrid' | 'title'` - æ¤œç´¢ã‚½ãƒ¼ã‚¹
- `scoreKind: 'vector' | 'bm25' | 'hybrid' | 'title'` - ã‚¹ã‚³ã‚¢ç¨®åˆ¥
- `scoreRaw: number` - ç”Ÿã‚¹ã‚³ã‚¢
- `scoreText: string`ï¼ˆè¡¨ç¤ºç”¨: ä¾‹ `BM25 8.20` / `Vector 83.1%`ï¼‰ - è¡¨ç¤ºç”¨ã‚¹ã‚³ã‚¢

### è¦ç´„
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãƒ»å‹ã¯å³å®ˆï¼ˆç‰¹ã« `pageId`ï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰ã¨`page_id`ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã®ä½¿ã„åˆ†ã‘ï¼‰
- `scoreText` ã¯ 0 ãªã‚‰ `BM25 0.00` ã®ã‚ˆã†ã«æ˜ç¤º
- æ—¢å®šå€¤ã¯å˜ä¸€ç‚¹ç®¡ç†ï¼ˆ`defaultSearchParams`ï¼‰
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°APIã¨ã®çµ±åˆã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ

---

## è£œè¶³: æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ åŒ…æ‹¬ã‚¬ã‚¤ãƒ‰ï¼ˆçµ±åˆå…ƒ: search-system-comprehensive-guide.mdï¼‰

### ç›®çš„
- è³ªå•ã«æœ¬è³ªçš„ã«é–¢é€£ã™ã‚‹ä¸€æ¬¡æƒ…å ±ã‚’å®‰å®šã—ã¦å–å¾—ã—ã€UIã«ã¯ç°¡æ½”ãªè¦ç´„ã¨ç¢ºå®Ÿã«ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªå‚ç…§ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/URLï¼‰ã‚’è¿”ã™
- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥/è­°äº‹éŒ²ãªã©ãƒã‚¤ã‚ºæ–‡æ›¸ã®æ··å…¥ã‚’æŠ‘ãˆã€ä»•æ§˜ãƒ»è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å„ªå…ˆã™ã‚‹
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ¤œç´¢çµæœã¨å›ç­”ã‚’æä¾›ã™ã‚‹

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ–¹é‡ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰

#### ã‚¯ã‚¨ãƒªå‰å‡¦ç†
- æ­£è¦åŒ–ï¼ˆå…¨è§’/åŠè§’ã€ç©ºç™½ã€è¨˜å·ï¼‰
- å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆDynamicKeywordExtractorï¼‰
- ãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
- å®‰å…¨ãªæ‹¡å¼µï¼š
  - åŒç¾©èªã¯ãƒ‰ãƒ¡ã‚¤ãƒ³é™å®šèªã«ã®ã¿ä»˜ä¸ï¼ˆä¾‹: ãƒ­ã‚°ã‚¤ãƒ³â†’èªè¨¼/login/ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼‰
  - æ±ç”¨èªï¼ˆä»•æ§˜/spec/è¦ä»¶/requirement/detailï¼‰ã¯ã‚¹ã‚³ã‚¢è¨ˆç®—ã‹ã‚‰é™¤å¤– or é‡ã¿æ¥µå°
  - å¦å®šèªï¼ˆ-ãƒ¡ãƒ¼ãƒ«/-é€šçŸ¥ ãªã©ï¼‰ã¯ãƒ•ã‚£ãƒ«ã‚¿ã«ã®ã¿é©ç”¨ã—ã€æ¡ç‚¹ã‹ã‚‰é™¤å¤–

#### æ¤œç´¢ï¼ˆä¸¦åˆ—ï¼‰
- ç©ºé–“åˆ¶ç´„: `space_key=CLIENTTOMO` ã§åŸºæœ¬çµã‚Šè¾¼ã¿
- ä¸¦åˆ—å®Ÿè¡Œã¨å€™è£œæ‹¡å¤§ï¼š
  - Vector æ¤œç´¢ topK=100ï¼ˆ768æ¬¡å…ƒã€LanceDB 0.22.0ï¼‰
  - BM25æ¤œç´¢ topK=100ï¼ˆLunr.js 2.3.9ã€Kuromojiãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ï¼‰
  - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ topK=100ï¼ˆSQL LIKEå¥ï¼‰
  - ã‚¿ã‚¤ãƒˆãƒ«å³æ ¼ä¸€è‡´æ¤œç´¢ topK=20
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ: æ¤œç´¢çµæœã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ®µéšçš„ã«è¡¨ç¤º
- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼š
  - é™¤å¤–ãƒ©ãƒ™ãƒ«: `Meeting`, `Archive`, `Low`, `ãƒ¡ãƒ¼ãƒ«`, `é€šçŸ¥`
  - å„ªå…ˆãƒ©ãƒ™ãƒ«: `High`, `Medium`, `Spec`, `Design`
  - ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°: ãƒ¡ãƒ¼ãƒ«/å¸³ç¥¨/è«‹æ±‚/ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–/è­°äº‹éŒ²ã‚’0.9å€ã€æ±ç”¨æ–‡æ›¸ã‚’0.8å€

#### ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ»çµ±åˆ
- é‡ã¿ä»˜ã‘: Vector 0.5, BM25 0.5ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ï¼‰
- RRFï¼ˆReciprocal Rank Fusionï¼‰ã«ã‚ˆã‚‹çµ±åˆ:
  - Vector: 1.0, Keyword: 0.8, Title-exact: 1.2, BM25: 0.6
- ãƒ‰ãƒ¡ã‚¤ãƒ³æ¸›è¡°: ãƒ¡ãƒ¼ãƒ«/å¸³ç¥¨/è«‹æ±‚/ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–/è­°äº‹éŒ²ã‚’0.9å€ã€æ±ç”¨æ–‡æ›¸ã‚’0.8å€
- é‡è¤‡é™¤å»: `pageId` ãƒ™ãƒ¼ã‚¹ã§çµ±åˆã€æœ€é«˜ã‚¹ã‚³ã‚¢ã‚’æ¡ç”¨
- æœ€çµ‚ã‚½ãƒ¼ãƒˆ: çµ±åˆã‚¹ã‚³ã‚¢é™é †ã€åŒç‚¹æ™‚ã¯ Vector ã‚¹ã‚³ã‚¢å„ªå…ˆ

### BM25 / Lunr æ¤œç´¢ä»•æ§˜

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- ã‚¨ãƒ³ã‚¸ãƒ³: `lunr@2.x`
- å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: `tokenizedTitle`(boost 3.0), `tokenizedContent`(boost 1.0), `labels`(boost 2.0)
  - å‚™è€ƒ: boostå€¤ã¯Phase 2æœ€é©åŒ–ã§èª¿æ•´æ¸ˆã¿ï¼ˆã‚¿ã‚¤ãƒˆãƒ«é‡è¦–ã‚’å¼·åŒ–ï¼‰
- è¿½åŠ ãƒ¡ã‚¿æƒ…å ±: `page_id:number` (int64å‹), `labels:string[]`, `url:string`, `space_key?:string`
  - æ³¨æ„: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã¯ `pageId` (stringå‹) ã‚’ç¶­æŒï¼ˆå¤‰æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å‡¦ç†ï¼‰
- æ—¥æœ¬èªå¯¾å¿œ: Kuromojiãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã«ã‚ˆã‚‹äº‹å‰åˆ†ã‹ã¡æ›¸ã
- æ­£è¦åŒ–: å…¨è§’/åŠè§’ãƒ»ç©ºç™½ãƒˆãƒªãƒ ã€ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠã¯ãã®ã¾ã¾

#### ã‚¯ã‚¨ãƒª
- ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ:
  - `searchCandidates(query: string, limit: number = 50): Promise<LunrSearchResult[]>`
  - `searchWithFilters(query: string, filters: { labels?: string[]; excludeLabels?: string[] } = {}, limit: number = 50): Promise<LunrSearchResult[]>`
- å…¥åŠ›: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶æ–‡ `query`ï¼ˆKuromojiãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã§åˆ†ã‹ã¡æ›¸ãå‡¦ç†ï¼‰
- ãƒ•ã‚£ãƒ«ã‚¿: `excludeLabels` ã¯ Low/Archive/Meeting ãªã©ã‚’é™¤å¤–ã€`labels` ã¯ç‰¹å®šãƒ©ãƒ™ãƒ«ã®ã¿ã‚’å«ã‚ã‚‹
- ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³: `LunrSearchClient.getInstance()` ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†

#### è¿”å´
- å€™è£œ: `{ pageId, score, title, snippet?, labels, url }[]`ï¼ˆscore ã¯ BM25 ã‚¹ã‚³ã‚¢ï¼‰
- å®Ÿè£…å´ã§ `pageId` ã«ã‚ˆã‚Š LanceDB è©³ç´°ã‚’ join ã—ã¦ `SearchResult` ã«æ•´å½¢

#### ç•™æ„ç‚¹
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åˆæœŸåŒ–: ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«éåŒæœŸã§å®Ÿæ–½ã€‚æœªåˆæœŸåŒ–æ™‚ã¯ LIKE æ¤œç´¢ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯
- ç”¨èªã®å¤§æ–‡å­—ãƒ»å°æ–‡å­—: ãã®ã¾ã¾ä¿æŒã€‚ãƒãƒƒãƒåˆ¤å®šã¯å°æ–‡å­—åŒ–æ¯”è¼ƒ
- æ—¥æœ¬èªå‡¦ç†: Kuromojiãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã«ã‚ˆã‚‹åˆ†ã‹ã¡æ›¸ãã§æ¤œç´¢ç²¾åº¦å‘ä¸Š
- API ã¯ä¸Šè¨˜2é–¢æ•°ã«é™å®šã—ã¦ä½¿ç”¨ï¼ˆãã®ä»–ã®å†…éƒ¨é–¢æ•°ã¯ä½¿ç”¨ç¦æ­¢ï¼‰

---

---

## å®Ÿè£…è©³ç´°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ä¿®æ­£ã—ãŸãƒã‚°

#### Bug #1: BM25ã‚¹ã‚³ã‚¢ãŒä¼æ’­ã•ã‚Œãªã„

**å•é¡Œ:**
```typescript
// CompositeScoringService.scoreAndRankResults()
const bm25Score = result._bm25Score || 0;  // âŒ å¸¸ã«0
```

**åŸå› :**
- BM25ã‚¹ã‚³ã‚¢ã¯`result.keyword`ã¾ãŸã¯`result._keywordScore`ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
- `result._bm25Score`ã¯ä¸€éƒ¨ã®ã‚±ãƒ¼ã‚¹ã§ã®ã¿å­˜åœ¨

**ä¿®æ­£:**
```typescript
const bm25Score = result.keyword || 
                  result._bm25Score || 
                  result._keywordScore || 0;  // âœ…
```

**åŠ¹æœ:**
- 721ï¼ˆå­¦å¹´ãƒ»è·æ¥­æ›´æ–°ï¼‰ãŒ#43 â†’ #2ã«æ”¹å–„
- BM25è²¢çŒ®åº¦: 0.0000 â†’ 0.3667ã«æ”¹å–„

#### Bug #2: æ¤œç´¢ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹

**å•é¡Œ:**
```typescript
// UnifiedSearchResultProcessor.formatResults()
return {
  id: result.id,
  title: result.title,
  // keyword, titleScore, labelScoreãŒå«ã¾ã‚Œã¦ã„ãªã„ âŒ
};
```

**ä¿®æ­£:**
```typescript
return {
  id: result.id,
  title: result.title || 'No Title',
  // æ¤œç´¢ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
  keyword: (result as any).keyword,
  titleScore: (result as any).title,
  labelScore: (result as any).label,
  _titleMatchRatio: (result as any)._titleMatchRatio,
  _distance: result._distance,
  _hybridScore: result._hybridScore,
  _sourceType: result._sourceType,
  _compositeScore: (result as any)._compositeScore,
  _scoreBreakdown: (result as any)._scoreBreakdown,
  // StructuredLabelãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ä¿æŒ
  structured_category: (result as any).structured_category,
  structured_domain: (result as any).structured_domain,
  // ...
};
```

**åŠ¹æœ:**
- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- Composite Scoringã§æ­£ã—ã„ã‚¹ã‚³ã‚¢ãŒä½¿ç”¨ã•ã‚Œã‚‹

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

#### ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«

1. **`src/lib/lancedb-search-client.ts`**
   - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®ãƒ¡ã‚¤ãƒ³å®Ÿè£…
   - ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã€BM25æ¤œç´¢ã€RRFèåˆ

2. **`src/lib/composite-scoring-service.ts`**
   - Composite Scoringã®å®Ÿè£…
   - ã‚·ã‚°ãƒŠãƒ«æ­£è¦åŒ–ã€é‡ã¿ä»˜ã‘ã€ã‚¹ã‚³ã‚¢è¨ˆç®—

3. **`src/lib/unified-search-result-processor.ts`**
   - æ¤œç´¢çµæœã®çµ±ä¸€å‡¦ç†
   - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿æŒ

4. **`src/lib/lunr-search-client.ts`**
   - Lunr.js BM25æ¤œç´¢ã®å®Ÿè£…
   - è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹é«˜é€Ÿæ¤œç´¢

5. **`src/lib/enhanced-keyword-extractor.ts`**
   - æ ¸å¿ƒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
   - ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ¯ãƒ¼ãƒ‰é™¤å»

6. **`src/lib/structured-label-service-admin.ts`**
   - StructuredLabelã®Firestoreçµ±åˆ
   - ã‚«ãƒ†ã‚´ãƒª/ãƒ‰ãƒ¡ã‚¤ãƒ³/ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ç®¡ç†

#### ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

1. **`scripts/rebuild-lancedb-smart-chunking.ts`**
   - LanceDBå†æ§‹ç¯‰ï¼ˆãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ãï¼‰
   - ã‚¿ã‚¤ãƒˆãƒ«é‡ã¿ã¥ã‘åŸ‹ã‚è¾¼ã¿

2. **`scripts/sync-firestore-labels-to-lancedb.ts`**
   - StructuredLabelã®LanceDBçµ±åˆ

3. **`scripts/test-gemini-quality-simple.ts`**
   - Geminiå“è³ªãƒ†ã‚¹ãƒˆï¼ˆ6äº‹ä¾‹ï¼‰

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### å•é¡Œ1: BM25ã‚¹ã‚³ã‚¢ãŒ0ã«ãªã‚‹

**ç—‡çŠ¶:**
```
_scoreBreakdown.bm25Contribution = 0.0000
```

**åŸå› :**
- `result.keyword`ã¾ãŸã¯`result._keywordScore`ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
- LunråˆæœŸåŒ–ãŒå¤±æ•—ã—ã¦ã„ã‚‹

**å¯¾ç­–:**
1. LunråˆæœŸåŒ–çŠ¶æ…‹ã‚’ç¢ºèª: `lunrInitializer.isReady()`
2. BM25ã‚¹ã‚³ã‚¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª: `result.keyword`, `result._bm25Score`, `result._keywordScore`
3. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç¢ºèª: `[searchLanceDB] BM25 search keywords`

#### å•é¡Œ2: æœŸå¾…ãƒšãƒ¼ã‚¸ãŒä½é †ä½

**ç—‡çŠ¶:**
```
æœŸå¾…ãƒšãƒ¼ã‚¸ãŒ#30-50ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³
```

**åŸå› :**
- ãƒ™ã‚¯ãƒˆãƒ«è·é›¢ãŒé ã„ï¼ˆ~1.9ï¼‰
- BM25ã‚¹ã‚³ã‚¢ãŒä½ã„
- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒç‡ãŒä½ã„

**å¯¾ç­–:**
1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã‚’ç¢ºèª: `[searchLanceDB] Extracted keywords`
2. BM25å€™è£œæ•°ã‚’å¢—ã‚„ã™: `kwCap = 100 â†’ 200`
3. StructuredLabelã‚’ç¢ºèª: `structured_domain`, `structured_feature`

#### å•é¡Œ3: æ¤œç´¢ãŒé…ã„

**ç—‡çŠ¶:**
```
å¹³å‡æ¤œç´¢æ™‚é–“: 30ç§’ä»¥ä¸Š
```

**åŸå› :**
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹
- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å€™è£œæ•°ãŒå¤šã„ï¼ˆtopK Ã— 10ï¼‰
- BM25æ¤œç´¢å€™è£œæ•°ãŒå¤šã„ï¼ˆkwCap=100ï¼‰

**å¯¾ç­–:**
1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTLã‚’å»¶é•·: `5åˆ† â†’ 15åˆ†`ï¼ˆâœ… å®Œäº†ï¼‰
2. ãƒ™ã‚¯ãƒˆãƒ«å€™è£œæ•°ã‚’å‰Šæ¸›: `topK Ã— 10 â†’ topK Ã— 5`
3. BM25å€™è£œæ•°ã‚’å‰Šæ¸›: `kwCap=100 â†’ kwCap=50`

### é‡è¦ãªè¨­è¨ˆåˆ¤æ–­

#### 1. ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ã¯å®‰å®šã—ã¦ã„ã‚‹

**èª¤è§£:** ãƒšãƒ¼ã‚¸ã®å¢—æ¸›ã«ã‚ˆã‚Šãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ãŒå¤‰ã‚ã‚‹  
**äº‹å®Ÿ:** ãƒ™ã‚¯ãƒˆãƒ«åŸ‹ã‚è¾¼ã¿ã¯å„ãƒšãƒ¼ã‚¸ç‹¬ç«‹ã§ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ä»–ãƒšãƒ¼ã‚¸ã®å½±éŸ¿ã‚’å—ã‘ãªã„

**å®Ÿè¨¼:**
- Phase 0A-4ã¨ç¾åœ¨ã§åŒä¸€ãƒšãƒ¼ã‚¸ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’æ¯”è¼ƒ â†’ å®Œå…¨ä¸€è‡´
- 70ãƒšãƒ¼ã‚¸é™¤å¤–å¾Œã‚‚ãƒ™ã‚¯ãƒˆãƒ«åŸ‹ã‚è¾¼ã¿ã¯ä¸å¤‰

#### 2. BM25ãŒæœ€å„ªå…ˆ

**ç†ç”±:**
- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å˜ç‹¬ã§ã¯æœŸå¾…ãƒšãƒ¼ã‚¸ãŒTop 100å¤–ã«ãªã‚‹ã“ã¨ãŒå¤šã„
- BM25ã‚¹ã‚³ã‚¢ãŒé«˜ã„ãƒšãƒ¼ã‚¸ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã¨ä¸€è‡´ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„

**è¨­å®š:**
- `bm25Weight`: 50%ï¼ˆæœ€å„ªå…ˆï¼‰
- `vectorWeight`: 5%ï¼ˆæœ€å°åŒ–ï¼‰

#### 3. ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã¯è¶…å¼·åŠ›

**ç†ç”±:**
- ã‚¿ã‚¤ãƒˆãƒ«ã«è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ â†’ é«˜é–¢é€£æ€§
- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒãƒšãƒ¼ã‚¸ã¯æœŸå¾…ãƒšãƒ¼ã‚¸ã§ã‚ã‚‹å¯èƒ½æ€§ãŒæ¥µã‚ã¦é«˜ã„

**ãƒ–ãƒ¼ã‚¹ãƒˆ:**
- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒç‡ â‰¥ 66% â†’ 10å€ãƒ–ãƒ¼ã‚¹ãƒˆ
- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒç‡ â‰¥ 33% â†’ 5å€ãƒ–ãƒ¼ã‚¹ãƒˆ

### ãƒ‡ãƒ¼ã‚¿æ§‹æˆ

#### ç¾åœ¨ã®çŠ¶æ…‹

```
ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: 1,224ä»¶
ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒšãƒ¼ã‚¸æ•°: 743ãƒšãƒ¼ã‚¸
é™¤å¤–ãƒšãƒ¼ã‚¸: 70ãƒšãƒ¼ã‚¸ï¼ˆãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
StructuredLabelçµ±åˆ: 1,040ä»¶ (85.0%)
```

#### é™¤å¤–ãƒ«ãƒ¼ãƒ«

##### 1. ãƒ©ãƒ™ãƒ«é™¤å¤–
```typescript
EXCLUDED_LABELS = [
  'ã‚¹ã‚³ãƒ¼ãƒ—å¤–', 'è­°äº‹éŒ²', 'meeting-notes',
  'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–', 'archive', 'ãƒ•ã‚©ãƒ«ãƒ€', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—'
];
```

##### 2. ã‚¿ã‚¤ãƒˆãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³é™¤å¤–
```typescript
EXCLUDED_TITLE_PATTERNS = [
  /^\[.*ç¤¾å†…\]/,
  /^ã€å‰Šé™¤/,
  /^ã€çµ±åˆã«ã‚ˆã‚Šå‰Šé™¤/,
  /^ã€ä¸è¦/,
  /^ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰/
];
```

##### 3. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é•·é™¤å¤–
```typescript
MIN_CONTENT_LENGTH = 100;  // 100æ–‡å­—æœªæº€ã‚’é™¤å¤–
```

---

**æ–‡è²¬**: AI Agent  
**æ‰¿èª**: é–‹ç™ºãƒãƒ¼ãƒ   
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š**: Phase 5é–‹å§‹æ™‚

