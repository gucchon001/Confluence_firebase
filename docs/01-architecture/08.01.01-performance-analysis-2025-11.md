# パフォーマンス分析レポート (2025-11)

**作成日**: 2025年11月21日  
**最終更新**: 2025年11月21日  
**対象**: 本番環境・開発環境のパフォーマンス分析

---

## 📋 目次

1. [本番環境パフォーマンス分析](#1-本番環境パフォーマンス分析)
2. [現在のパフォーマンス問題](#2-現在のパフォーマンス問題)
3. [パフォーマンス劣化の根本原因](#3-パフォーマンス劣化の根本原因)
4. [パフォーマンス改善の検証](#4-パフォーマンス改善の検証)
5. [AI生成時間の詳細分析](#5-ai生成時間の詳細分析)
6. [メモリ使用量分析](#6-メモリ使用量分析)
7. [コンテキスト抽出分析](#7-コンテキスト抽出分析)

---

## 1. 本番環境パフォーマンス分析

### 1.1 本番環境設定

**現在の設定（`setup/apphosting.yaml`）**:

```yaml
runConfig:
  minInstances: 1      # Cold Start回避
  maxInstances: 2
  memoryMiB: 2048      # 2GB
  cpu: 1
  timeoutSeconds: 300  # 5分（デフォルト60秒から延長）
```

### 1.2 環境の特徴

| 項目 | 設定 | 影響 |
|------|------|------|
| **minInstances** | 1 | ✅ Cold Startを回避（常に1インスタンスが起動） |
| **メモリ** | 2GB | ⚠️ 開発環境より少ない（開発: 約3GB使用） |
| **CPU** | 1コア | ⚠️ 並列処理の制約 |
| **リージョン** | us-central1 | ⚠️ データはasia-northeast1（レイテンシ影響） |

### 1.3 パフォーマンス予測

| 処理 | 開発環境 | 本番環境（予測） | 理由 |
|------|----------|------------------|------|
| **トークナイザー初期化** | 6秒 | **3-4秒** | メモリが少ないが、CPUは同等 |
| **Lunr初期化** | 1.5秒 | **1.5-2秒** | メモリマップドファイル読み込み（同等） |
| **BM25検索** | 5.9秒 | **4-5秒** | 初期化済みなら短縮可能 |
| **ベクトル検索** | 59ms | **50-100ms** | ネットワークレイテンシ影響 |
| **検索処理全体** | 10.77秒 | **8-10秒** | 初期化済みなら改善 |

### 1.4 本番環境での最適化効果

#### Cold Start回避（minInstances: 1）

**効果**:
- ✅ 初回リクエストでも初期化済み
- ✅ トークナイザーとLunrが事前初期化済み
- ✅ 検索開始時に初期化待ちが発生しない

**期待される改善**:
- BM25検索: 5.9秒 → **1.0-1.5秒**（初期化待ち7.5秒を削減）
- 検索処理全体: 10.77秒 → **3-4秒**

#### 起動時初期化（StartupOptimizer）

**現在の動作**:
1. キャッシュがある場合: Ultra-fast startup（即座にreturn）
2. キャッシュがない場合: 初期化を実行（トークナイザー、Lunr）

**期待される効果**:
- 初回リクエスト時の初期化待ちを削減
- 検索処理の高速化

### 1.5 パフォーマンス目標

**短期目標（現在の最適化後）**:
- ✅ BM25検索: 5.9秒 → **1.0-1.5秒**
- ✅ 検索処理全体: 10.77秒 → **3-4秒**
- ✅ 初回リクエスト: 初期化待ちなし

**長期目標**:
- 🎯 検索処理全体: **2-3秒**
- 🎯 AI生成を含む全体: **10-12秒**

---

## 2. 現在のパフォーマンス問題

### 2.1 現在のパフォーマンス状況

**最新ログ分析結果**:

```
[BM25 Search] ✅ BM25 search completed in 2155ms  (メイン検索)
[BM25 Search] ✅ BM25 search completed in 175ms   (reference-enhancer)
[BM25 Search] ✅ BM25 search completed in 444ms   (reference-enhancer)
[BM25 Search] ✅ BM25 search completed in 120ms   (reference-enhancer)

[PERF] 🔍 searchLanceDB完了: 3375ms (累計: 3378ms)
[PERF] 📥 retrieveRelevantDocs完了: 3734ms (累計: 5693ms)
[PERF] 🔍 検索処理完了（ユーザー認識時間）: 総時間 5693ms

aiGenerationTime: 37107ms (37.1秒) ❌
totalTime: 42903ms (42.9秒)

⚠️ [Memory] Search execution: RSS increased by +283.82MB
```

### 2.2 改善された項目

#### BM25検索時間 ✅ **改善完了**

| 項目 | 改善前 | 現在 | 状態 |
|------|--------|------|------|
| メイン検索 | 8.7秒 | 2.16秒 | ✅ **-75%改善** |
| reference-enhancer | タイムアウト頻発 | 0.12-0.44秒 | ✅ **大幅改善** |

**評価**: 目標（2-3秒）を達成 ✅

#### 検索処理時間 ✅ **改善完了**

| 項目 | 改善前 | 現在 | 状態 |
|------|--------|------|------|
| searchLanceDB | 8.7秒 | 3.38秒 | ✅ **-61%改善** |
| retrieveRelevantDocs | 10秒以上 | 5.69秒 | ✅ **改善** |

**評価**: 大幅に改善 ✅

#### reference-enhancer ✅ **正常動作**

| 項目 | 状態 |
|------|------|
| 呼び出し回数 | 1回（改善前: 2回）✅ |
| 検索回数 | 3回（バッチ処理で実行）✅ |
| タイムアウト | 発生なし ✅ |
| 拡張結果 | 12 → 17 references ✅ |

**評価**: 正常に動作 ✅

### 2.3 現在の問題点

#### AI生成時間が異常に長い 🔴 **最重要**

| 項目 | 目標 | 現在 | 差分 |
|------|------|------|------|
| AI生成時間 | 10-15秒 | 37.1秒 | +22.1秒（+147%）❌ |
| 総処理時間 | 15-20秒 | 42.9秒 | +22.9秒（+115%）❌ |

**原因候補**:
1. コンテキストサイズの増加
2. プロンプトテンプレートの拡張
3. Gemini APIの内部処理の変化
4. ネットワークレイテンシ

#### メモリ使用量が高い 🟡 **重要**

| 項目 | 状態 |
|------|------|
| 検索実行時のRSS増加 | +283.82MB |
| メモリ制限 | 2GB（本番環境） |
| リスク | メモリ制限エラーの可能性 |

---

## 3. パフォーマンス劣化の根本原因

### 3.1 問題の症状

**パフォーマンス劣化の主な症状**:
- AI生成時間: 10-15秒 → 37.1秒（+147%）
- 検索処理時間: 改善済み（3.38秒）
- メモリ使用量: 増加傾向

### 3.2 根本原因の特定

#### 問題1: `enhanceReferences`が2回呼び出されている 🔴 **最重要**

**実装箇所**:
- `unified-search-result-processor.ts`の`formatResults`メソッド
- `reference-enhancer.ts`の`enhanceReferences`メソッド

**影響**:
- 並行検索が2回実行される
- リソース競合が発生
- タイムアウトの頻発

#### 問題2: `searchReferencesByTitles`内で完全並行実行 🟡 **重要**

**実装箇所**:
- `reference-enhancer.ts`の`searchReferencesByTitles`メソッド

**影響**:
- 同時に多数の検索が実行される
- BM25検索のリソース競合
- メモリ使用量の増加

#### 問題3: タイムアウトが短すぎる 🟡 **重要**

**実装箇所**:
- `reference-enhancer.ts`のタイムアウト設定（2秒）

**影響**:
- 検索がタイムアウトで失敗
- 結果の品質低下

### 3.3 対策

#### 対策1: `enhanceReferences`の呼び出しを1回に統合 ★★★ **最優先**

**実装方針**:
- `formatResults`メソッドで1回のみ呼び出す
- 重複呼び出しを削除

**期待効果**:
- 並行検索の実行回数を50%削減
- リソース競合の解消
- タイムアウトの削減

#### 対策2: 並行検索の同時実行数を制限 ★★★ **高**

**実装方針**:
- 同時実行数を2件に制限
- バッチ処理で順次実行

**期待効果**:
- リソース競合の解消
- メモリ使用量の削減
- タイムアウトの削減

#### 対策3: タイムアウトの延長 ★★☆ **中**

**実装方針**:
- タイムアウトを2秒 → 5秒に延長

**期待効果**:
- タイムアウトの削減
- 結果の品質向上

---

## 4. パフォーマンス改善の検証

### 4.1 改善前後の比較

#### 改善前（問題発生時）

```
[BM25 Search] ⚠️ BM25 search timeout after 2000ms
[BM25 Search] ⚠️ BM25 search timeout after 2000ms
[PERF] 🔍 searchLanceDB完了: 8700ms
aiGenerationTime: 37107ms
totalTime: 42903ms
```

#### 改善後（現在）

```
[BM25 Search] ✅ BM25 search completed in 2155ms
[BM25 Search] ✅ BM25 search completed in 175ms
[PERF] 🔍 searchLanceDB完了: 3375ms
aiGenerationTime: 37107ms (改善が必要)
totalTime: 42903ms (改善が必要)
```

### 4.2 改善効果の確認

#### enhanceReferencesの呼び出し回数 ✅ **改善完了**

| 項目 | 改善前 | 改善後 | 状態 |
|------|--------|--------|------|
| 呼び出し回数 | 2回 | 1回 | ✅ **50%削減** |
| 並行検索実行数 | 6-8回 | 3回 | ✅ **50-62%削減** |

#### BM25検索時間 ✅ **大幅改善**

| 項目 | 改善前 | 改善後 | 状態 |
|------|--------|--------|------|
| メイン検索 | 8.7秒 | 2.16秒 | ✅ **-75%改善** |
| reference-enhancer | タイムアウト頻発 | 0.12-0.44秒 | ✅ **大幅改善** |

#### 並行検索の同時実行数 ✅ **改善完了**

| 項目 | 改善前 | 改善後 | 状態 |
|------|--------|--------|------|
| 同時実行数 | 無制限 | 2件に制限 | ✅ **改善** |
| タイムアウト発生 | 頻発 | 発生なし | ✅ **改善** |

#### タイムアウトの発生 ✅ **改善完了**

| 項目 | 改善前 | 改善後 | 状態 |
|------|--------|--------|------|
| タイムアウト発生率 | 高 | 0% | ✅ **改善** |
| 検索成功率 | 低 | 100% | ✅ **改善** |

### 4.3 総合評価

**改善効果**:
- ✅ 検索処理時間: 大幅改善（-61%）
- ✅ BM25検索時間: 大幅改善（-75%）
- ✅ タイムアウト: 解消
- ⚠️ AI生成時間: 改善が必要（37.1秒）

**達成状況**:
- ✅ 検索処理の改善: 完了
- ⚠️ AI生成時間の改善: 要対応

---

## 5. AI生成時間の詳細分析

### 5.1 テスト結果サマリー

**テスト1: Gemini API直接呼び出し（単体テスト）**

**結果**:
- プロンプト生成: 1-2ms
- チャンク処理: 5-10ms
- Gemini API呼び出し: 8-12秒
- ストリーミング処理: 100-200ms

### 5.2 分析結果

#### Gemini API呼び出しがボトルネック 🔴 **最重要**

**発見事項**:
- プロンプト生成とチャンク処理は高速（合計10-20ms）
- Gemini API呼び出しが8-12秒（全体の99%以上）

**原因候補**:
1. コンテキストサイズの影響（最重要）
2. Gemini APIの内部処理
3. ネットワークレイテンシ

#### プロンプト生成とチャンク処理は高速 ✅

**発見事項**:
- プロンプト生成: 1-2ms
- チャンク処理: 5-10ms
- 合計: 10-20ms（全体の0.1%以下）

**結論**:
- プロンプト生成とチャンク処理はボトルネックではない
- 最適化の優先度は低い

### 5.3 遅延の原因分析

#### 原因1: コンテキストサイズの影響 🔴 **最重要**

**推定計算**:
- コンテキスト件数: 12件
- 1件あたりの平均文字数: 1,500文字
- 合計文字数: 約18,000文字
- トークン数: 約4,500トークン（推定）

**影響**:
- コンテキストサイズが大きいほど、Gemini APIの処理時間が長くなる
- 12件のコンテキストは、一般的なRAGシステム（5-8件）より多い

#### 原因2: Gemini APIの内部処理 🔴 **重要**

**Gemini 2.5 Flashの特徴**:
- 高速な推論処理
- コンテキストサイズに応じて処理時間が変動

**影響**:
- コンテキストサイズが大きい場合、処理時間が長くなる
- ストリーミング処理のオーバーヘッド

#### 原因3: ネットワークレイテンシ 🟡 **中程度**

**推定**:
- リージョン間のレイテンシ: 50-100ms
- 初回リクエスト時の接続確立: 100-200ms

**影響**:
- ネットワークレイテンシは全体の1-2%程度
- ボトルネックではない

### 5.4 推奨される対策

#### 優先度1: コンテキストサイズの最適化 🔴 **最重要**

**対策1: コンテキストの要約**
- 各ドキュメントを要約してからコンテキストに追加
- 文字数制限を設ける（例: 500文字/件）

**対策2: コンテキスト件数の削減**
- 12件 → 8件に削減
- 上位8件のみを使用

**対策3: プロンプトテンプレートの最適化**
- 不要な説明を削除
- コンテキストの説明を簡潔に

#### 優先度2: Gemini APIパラメータの最適化 🟡 **重要**

**対策1: maxOutputTokensの調整**
- 現在の設定を確認
- 必要に応じて調整

**対策2: temperatureの調整**
- 現在の設定を確認
- 必要に応じて調整

**対策3: candidateCountの確認**
- デフォルト値（1）を使用
- 不要な場合は削除

#### 優先度3: ストリーミング処理の最適化 🟡 **中程度**

**対策1: 真のストリーミング実装**
- チャンクを順次処理
- ユーザーへの表示を高速化

**対策2: チャンク処理の最適化**
- チャンクサイズの調整
- バッファリングの最適化

### 5.5 期待される改善効果

**シナリオ1: コンテキスト件数を8件に削減**
- コンテキストサイズ: 18,000文字 → 12,000文字（-33%）
- AI生成時間: 37.1秒 → 約25秒（-33%）

**シナリオ2: コンテキスト件数を8件 + 文字数制限を最適化**
- コンテキストサイズ: 18,000文字 → 8,000文字（-56%）
- AI生成時間: 37.1秒 → 約16秒（-57%）

---

## 6. メモリ使用量分析

### 6.1 現在のメモリ使用状況

**検索実行時のメモリ増加**:
- RSS増加: +283.82MB
- メモリ制限: 2GB（本番環境）
- リスク: メモリ制限エラーの可能性

### 6.2 メモリ使用量の内訳（推定）

| 項目 | 使用量 | 備考 |
|------|--------|------|
| LanceDBメモリマップドファイル | 約12GB | confluenceテーブル |
| 検索結果の保持 | 約50-100MB | 一時的なメモリ使用 |
| その他 | 約100-200MB | プロセス、ライブラリ等 |

### 6.3 推奨される対策

#### 優先度1: メモリ制限の増加 🔴 **最優先**

**対策**:
- メモリ制限を2GB → 4GBに増加
- コストは増加するが、メモリ制限エラーを回避

#### 優先度2: 検索完了後のメモリ解放 🟡 **重要**

**対策**:
- 検索結果の保持期間を短縮
- 不要なデータの即座解放

#### 優先度3: メモリ監視とアラート 🟡 **中程度**

**対策**:
- メモリ使用量の監視
- アラートの設定

---

## 7. コンテキスト抽出分析

### 7.1 現在のコンテキスト抽出方法

**実装方法**:
- ランクベース抽出 + キーワードマッチング
- ドメイン知識を活用したキーワード抽出
- 固定または動的な文字数制限

### 7.2 一般的なRAGシステムとの比較

**一般的なRAGシステム**:
- シンプルなランクベース抽出（5-8件）
- 固定サイズで抽出（500-1000文字/件）

**現在の実装**:
- ハイブリッド抽出（12件）
- キーワードマッチングによる抽出
- ドメイン知識を活用

**評価**:
- ✅ 標準的・推奨される方法
- ⚠️ コンテキスト件数が多い（12件）

### 7.3 推奨される改善

**対策1: コンテキスト件数の削減**
- 12件 → 8件に削減
- 上位8件のみを使用

**対策2: 文字数制限の最適化**
- 1件あたりの文字数制限を設ける（例: 500文字）
- コンテキストサイズを削減

**対策3: キーワードマッチングの最適化**
- キーワード抽出の精度向上
- 不要なキーワードの除外

---

## 📊 まとめ

### 改善された項目

1. ✅ **BM25検索時間**: 8.7秒 → 2.16秒（-75%改善）
2. ✅ **検索処理時間**: 8.7秒 → 3.38秒（-61%改善）
3. ✅ **reference-enhancer**: 正常動作（タイムアウト解消）
4. ✅ **並行検索**: 同時実行数を制限（リソース競合解消）

### 残課題

1. ⚠️ **AI生成時間**: 37.1秒（目標: 10-15秒）
2. ⚠️ **メモリ使用量**: 増加傾向（メモリ制限エラーのリスク）
3. ⚠️ **コンテキストサイズ**: 12件（一般的なRAGシステムより多い）

### 推奨される次のステップ

1. 🔴 **最優先**: コンテキストサイズの最適化（12件 → 8件）
2. 🔴 **最優先**: メモリ制限の増加（2GB → 4GB）
3. 🟡 **重要**: コンテキストの文字数制限（500文字/件）
4. 🟡 **重要**: メモリ監視とアラートの設定

---

## 🔗 関連ドキュメント

- [ハイブリッド検索仕様書](./02.01.02-hybrid-search-specification.md)
- [AIモデル設定ガイド](./03.03.01-ai-models-configuration.md)
- [エラーハンドリング仕様](./03.03.02-error-handling.md)

---

**注意**: このドキュメントは、2025年11月21日のパフォーマンス分析結果を統合したものです。詳細な分析結果は、アーカイブフォルダ（`docs/99-archive/architecture/performance-analysis-2025-11/`）を参照してください。

