# 環境設定戦略：実行環境別の環境変数管理

**最終更新**: 2025年1月  
**関連ドキュメント**: [環境変数設定ガイド](../04-operations/04.13-environment-variables.md)

---

## 概要

このプロジェクトでは、実行環境（Next.jsアプリケーションコンテキスト vs スクリプト実行）に応じて、環境変数の検証ルールを動的に変更しています。

**設計思想**:
- Next.jsアプリケーション実行時: Firebaseクライアント側の環境変数は必須
- スクリプト実行時: Firebaseクライアント側の環境変数はオプション

この設計により、GitHub ActionsなどのCI/CD環境でバッチスクリプトを実行する際に、Firebaseクライアント側の設定が不要になります。

---

## 実行環境の判別

### 判別方法

実行環境は `process.env.NEXT_RUNTIME` の存在によって判別します：

```typescript
/**
 * スクリプト実行時かどうかを判定
 * Next.jsアプリケーションコンテキスト外（スクリプト実行時）では、
 * Firebaseクライアント側の環境変数は不要
 */
function isScriptContext(): boolean {
  // Next.jsアプリケーションコンテキストでは NEXT_RUNTIME が設定される
  // スクリプト実行時は設定されない
  return !process.env.NEXT_RUNTIME;
}
```

### 環境変数の動作

| 環境変数 | Next.jsアプリケーション | スクリプト実行 |
|---------|----------------------|--------------|
| `NEXT_PUBLIC_FIREBASE_API_KEY` | 必須 | オプション |
| `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` | 必須 | オプション |
| `NEXT_PUBLIC_FIREBASE_PROJECT_ID` | 必須 | オプション |
| `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET` | 必須 | オプション |
| `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID` | 必須 | オプション |
| `NEXT_PUBLIC_FIREBASE_APP_ID` | 必須 | オプション |

その他の環境変数（Confluence、Gemini等）は両方の環境で必須です。

---

## 実装詳細

### スキーマ定義の動的生成

`src/config/app-config.ts` では、実行環境に応じて環境変数スキーマを動的に生成します：

```typescript
const createEnvSchema = () => {
  const baseSchema = {
    // Confluence設定（必須）
    CONFLUENCE_BASE_URL: z.string().url(...),
    CONFLUENCE_USER_EMAIL: z.string().email(...),
    // ... その他の共通設定
  };

  // スクリプト実行時はFirebaseクライアント側の環境変数をオプショナルにする
  if (isScriptContext()) {
    return z.object({
      ...baseSchema,
      // Firebase設定（クライアント側、スクリプト実行時はオプション）
      NEXT_PUBLIC_FIREBASE_API_KEY: z.string().min(1).optional(),
      // ... その他のFirebase設定
    });
  }

  // Next.jsアプリケーションコンテキストではFirebaseクライアント側の環境変数は必須
  return z.object({
    ...baseSchema,
    // Firebase設定（クライアント側、必須）
    NEXT_PUBLIC_FIREBASE_API_KEY: z.string().min(1, 'NEXT_PUBLIC_FIREBASE_API_KEY は必須です'),
    // ... その他のFirebase設定
  });
};
```

### デフォルト値の提供

スクリプト実行時には、Firebaseクライアント側の設定値がundefinedになる可能性があるため、デフォルト値として空文字列を提供します：

```typescript
firebase: {
  apiKey: validatedEnv.NEXT_PUBLIC_FIREBASE_API_KEY || '',
  authDomain: validatedEnv.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || '',
  // ... その他のFirebase設定
}
```

**注意**: スクリプト実行時に `appConfig.firebase` を使用する場合は、値が空文字列である可能性を考慮する必要があります。

---

## Next.js設定

### `next.config.ts` の設定

このプロジェクトのNext.js設定は以下のようになっています：

```typescript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Firebase App Hosting用のスタンドアロン出力設定
  output: 'standalone',
  
  reactStrictMode: true,
  typescript: {
    ignoreBuildErrors: false,
  },
  eslint: {
    ignoreDuringBuilds: false,
  },
  // ... その他の設定
};
```

### 環境変数の扱い

- **ビルド時**: `NEXT_PUBLIC_*` 変数はビルド時にバンドルに含まれます
- **ランタイム時**: すべての環境変数が `app-config.ts` で検証されます
- **スクリプト実行時**: `NEXT_RUNTIME` が設定されないため、Firebaseクライアント側の環境変数はオプションになります

---

## 使用例

### Next.jsアプリケーション内での使用

```typescript
import { appConfig } from '@/config/app-config';

// Firebase設定は常に利用可能（Next.jsアプリケーションコンテキスト）
const firebaseConfig = {
  apiKey: appConfig.firebase.apiKey,
  authDomain: appConfig.firebase.authDomain,
  // ...
};
```

### スクリプト内での使用

```typescript
import { appConfig } from '@/config/app-config';

// Confluence設定は利用可能
const baseUrl = appConfig.confluence.baseUrl;

// Firebase設定は空文字列になる可能性があるため、使用前に確認
if (appConfig.firebase.projectId) {
  // Firebase設定が利用可能な場合のみ使用
}
```

---

## GitHub Actionsでの動作

### ワークフローの設定例

GitHub Actionsワークフローでは、以下のように環境変数を設定します：

```yaml
- name: Run differential sync
  run: npm run sync:confluence:differential
  env:
    CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
    GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    CONFLUENCE_BASE_URL: https://giginc.atlassian.net
    CONFLUENCE_USER_EMAIL: kanri@jukust.jp
    CONFLUENCE_SPACE_KEY: CLIENTTOMO
    # Firebaseクライアント側の環境変数は不要
```

### エラーが発生しない理由

スクリプト実行時（`NEXT_RUNTIME` が未設定）では、Firebaseクライアント側の環境変数がオプションとして扱われるため、GitHub Actionsでこれらの環境変数を設定しなくてもエラーが発生しません。

---

## トラブルシューティング

### エラー: "必須環境変数が設定されていません"

**原因**: Next.jsアプリケーションコンテキストでFirebaseクライアント側の環境変数が設定されていない

**対処方法**:
1. `.env.local` ファイルにFirebaseクライアント側の環境変数を設定
2. または、`setup/apphosting.yaml` で環境変数を設定（本番環境）

詳細は [環境変数設定ガイド](../04-operations/04.13-environment-variables.md) を参照してください。

### スクリプト実行時にFirebase設定が空文字列になる

**原因**: スクリプト実行時にはFirebaseクライアント側の環境変数がオプションのため

**対処方法**: これは正常な動作です。スクリプト実行時にFirebase設定が必要な場合は、環境変数を設定してください。

---

## 設計判断の背景

### なぜこの設計を採用したか

1. **CI/CD環境での柔軟性**: GitHub ActionsなどのCI/CD環境で、Firebaseクライアント側の設定を不要にすることで、設定の簡素化を実現
2. **環境別の要件の違い**: Next.jsアプリケーションではFirebaseクライアント側の設定が必要だが、バッチスクリプトでは不要
3. **型安全性の維持**: Zodによる検証を維持しながら、実行環境に応じた柔軟な検証ルールを提供

### 代替案との比較

| アプローチ | メリット | デメリット |
|---------|---------|-----------|
| **現在の実装**（実行環境別検証） | ✅ 環境別の要件を反映<br>✅ 型安全性を維持 | ❌ 実装が複雑 |
| **すべてオプション化** | ✅ 実装が簡単 | ❌ Next.jsアプリケーションでエラー検出が遅れる |
| **環境変数フラグで制御** | ✅ 明示的な制御 | ❌ 追加の設定が必要 |

---

## 関連ドキュメント

- [環境変数設定ガイド](../04-operations/04.13-environment-variables.md) - 環境変数の詳細な設定方法
- [Next.js Configuration](https://nextjs.org/docs/app/api-reference/next-config-js) - Next.js設定の公式ドキュメント
- [Zod Schema Validation](https://zod.dev/) - 環境変数の検証に使用しているライブラリ

---

## 更新履歴

- **2025年1月**: 初版作成（実行環境別の環境変数管理機能の実装に伴う）

