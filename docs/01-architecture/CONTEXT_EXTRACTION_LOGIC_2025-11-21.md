# コンテキスト取り込みロジックの詳細仕様 (2025-11-21)

**作成日**: 2025年11月21日  
**ステータス**: 📋 現状分析完了

---

## 📊 概要

現在のコンテキスト取り込みロジックは、AI生成時間の分析で判明した**37.1秒の遅延**の主要因の一つです。本ドキュメントでは、現在の実装を詳細に分析し、最適化の方向性を提示します。

---

## 🔍 現在の実装

### 1. コンテキスト件数の制限

**実装場所**: 
- `src/ai/flows/streaming-summarize-confluence-docs.ts:296`
- `src/ai/flows/retrieve-relevant-docs-lancedb.ts:228`
- `src/app/api/streaming-process/route.ts:483`

**現在の設定**:
```typescript
const MAX_CONTEXT_DOCS = 12; // LLMに渡すドキュメント数
const contextDocs = context.slice(0, 12); // 上位12件
```

**説明**:
- 検索結果の上位12件をAI生成に使用
- 参照元として表示される全件をLLMに渡すことで、回答に反映される情報を最大化

---

### 2. 各ドキュメントの文字数制限（ランキングベース）とコンテンツ抽出方式（ハイブリッド方式）

**実装場所**: 
- `src/ai/flows/streaming-summarize-confluence-docs.ts:299-314`（文字数制限の設定）
- `src/ai/flows/content-extraction-utils.ts:143-311`（ハイブリッド方式の実装）

**仕組み**: **両方が組み合わせて使用されています**

#### ステップ1: ランキングベースの文字数制限（最大文字数の設定）

各ドキュメントに対して、ランキングに応じた最大文字数（`maxLength`）を設定します：

```typescript
// ランキングに基づく動的な文字数制限
const maxLength = 
  index === 0 ? 1400 :      // 1位: 1400文字
  index === 1 ? 1260 :      // 2位: 1260文字
  index === 2 ? 1120 :      // 3位: 1120文字
  index < 6 ? 800 :         // 4-6位: 800文字
  index < 10 ? 700 :        // 7-10位: 700文字
  500;                      // 11-12位: 500文字
```

**文字数合計（最大）**:
```
1位: 1400文字
2位: 1260文字
3位: 1120文字
4-5位: 800文字 × 2 = 1600文字
6-8位: 700文字 × 3 = 2100文字
9-10位: 500文字 × 2 = 1000文字
─────────────────────────────
合計: 8460文字（約8,500文字）
```

**変更履歴（2025-11-21）**:
- 12件 → 10件に削減（コンテキスト長を約15%削減）
- 11-12位（500文字）を削除
- 文字数制限の配分を調整

#### ステップ2: ハイブリッド方式によるコンテンツ抽出（maxLengthを超える場合）

ドキュメントのコンテンツが`maxLength`を超える場合、**ハイブリッド方式**で抽出します：

```typescript
const truncatedContent = doc.content && doc.content.length > maxLength
  ? extractRelevantContentMultiKeyword(doc.content, sanitizedQuestion, maxLength, index)
  : doc.content || '内容なし';
```

**ハイブリッド方式の詳細**:

1. **先頭取得範囲**: 固定800文字（ドキュメントの先頭から）
2. **キーワード周辺取得範囲**: 固定600文字（質問のキーワード周辺、前後150文字ずつ）

3. **ランキングに応じた比率でmaxLengthを分配**:
   - **1位（rank=0）**: 先頭:キーワード = **7:3**
     - 例: maxLength=1400 → 先頭980文字、キーワード420文字
   - **10位（rank=9）**: 先頭:キーワード = **3:7**
     - 例: maxLength=700 → 先頭210文字、キーワード490文字
   - **線形補間**: `headRatio = 0.7 - (rank / 9) * 0.4`

4. **抽出ロジック**:
   ```typescript
   // ステップ1: 先頭取得とキーワード周辺取得の固定文字数を定義（ランキングに関係なく）
   const HEAD_FIXED_LENGTH = 800;  // 先頭から固定800文字
   const KEYWORD_FIXED_LENGTH = 600;  // キーワード周辺から固定600文字
   
   // ステップ2: ランキングに応じた比率を計算
   const normalizedRank = Math.max(0, Math.min(9, rank)); // 0-9に正規化
   const headRatio = 0.7 - (normalizedRank / 9) * 0.4; // 0.7 (1位) → 0.3 (10位)
   const keywordRatio = 1.0 - headRatio; // 0.3 (1位) → 0.7 (10位)
   
   // ステップ3: maxLengthを先頭とキーワード周辺に分配（ランキングに応じた比率で）
   const headLength = Math.floor(maxLength * headRatio); // 先頭取得に割り当てる文字数
   const keywordLength = Math.floor(maxLength * keywordRatio); // キーワード周辺取得に割り当てる文字数
   ```

5. **重複処理**: 先頭取得範囲とキーワード周辺範囲が重複する場合、重複部分を1回だけカウントし、最終的に`maxLength`を超えないように調整

**例: 1位のドキュメント（maxLength=1400文字）の場合**:
- 先頭:キーワード = 7:3
- 先頭に割り当て: 1400 × 0.7 = 980文字
- キーワード周辺に割り当て: 1400 × 0.3 = 420文字
- ただし、先頭取得範囲は固定800文字まで、キーワード周辺取得範囲は固定600文字まで
- 実際には、先頭800文字 + キーワード周辺420文字（または重複を除いた範囲）を抽出
- 最終的に1400文字以内に収める

**例: 12位のドキュメント（maxLength=500文字）の場合**:
- 先頭:キーワード = 約3:7（rank=11なので、ほぼキーワード優先）
- 先頭に割り当て: 500 × 0.3 = 150文字
- キーワード周辺に割り当て: 500 × 0.7 = 350文字
- キーワード周辺を優先的に抽出

**説明**:
- **ランキングが高いドキュメント**: 先頭部分を多く取得（概要を重視）
- **ランキングが低いドキュメント**: キーワード周辺を多く取得（関連性を重視）
- 最終的に、各ドキュメントは`maxLength`以内の文字数に収まる

---

### 4. プロンプトテンプレート

**実装場所**: `src/ai/flows/streaming-summarize-confluence-docs.ts:31`

**テンプレート構造**:
```
あなたはConfluence仕様書の質問に答えるAIアシスタントです。

## ルール
1. 提供された参考情報のみを根拠として回答
2. 関連情報がない場合は「詳細な情報は見つかりませんでした」と回答
3. 参照元セクションは生成しない
4. 機能質問には具体的な手順・設定項目を含める
5. マークダウン形式で見出し・箇条書きを使用
6. **重要**: ドキュメントタイトル（【FIX】や【NEW】などのプレフィックス付き）を言及する際は、自然な形で言い換えてください
7. **回答の完全性**: 質問に対して可能な限り詳細で包括的な回答を提供してください。
8. **情報の明確化**: 「詳細な情報は見つかりませんでした」とだけ回答するのではなく、提供された資料に基づいて可能な限り情報を整理して回答してください。

## 項目リスト質問の場合
「項目は」「一覧」「リスト」などのキーワードを含む質問には箇条書きリスト形式で回答：

## 参考情報
{{context}}

## 質問
{{question}}

## 回答形式（必須）
1. **概要**: 質問に対する簡潔な概要から開始
2. **詳細**: 質問に応じたマークダウン形式で具体的な情報を整理
3. **完全性**: 途中で切らず、全ての関連情報を含める
```

**プロンプト長（推定）**:
- テンプレート部分: 約1,500-2,000文字
- コンテキスト部分: 約10,000文字（最大）
- 質問部分: 約50-200文字
- **合計**: 約11,500-12,200文字

---

## 📊 現在のコンテキストサイズ分析

### 実際のログからの推定

**実際のログ**:
- AI生成時間: 37.1秒
- 回答長: 5867文字
- コンテキスト: 12件

**推定コンテキストサイズ**:
- 各ドキュメントの平均文字数: 約800-1,000文字
- 合計コンテキスト長: 約9,600-12,000文字
- プロンプト長（テンプレート含む）: 約11,500-14,000文字

---

## 🎯 パフォーマンスへの影響

### 1. コンテキストサイズと処理時間の関係

**単体テスト結果**:
- コンテキスト: 2件（約290文字）
- AI生成時間: 3.5秒

**実際のログ**:
- コンテキスト: 12件（約10,000文字）
- AI生成時間: 37.1秒

**影響**:
- コンテキストサイズが約35倍 → 処理時間が約10.7倍
- **コンテキストサイズが処理時間に大きく影響**

---

### 2. ボトルネック分析

**時間の内訳（推定）**:
```
総AI生成時間: 37.1秒

内訳（推定）:
- プロンプト生成: 0ms (0.0%)
- Gemini API呼び出し: 37000ms (99.7%)
  - ネットワークレイテンシ: 2000-3000ms (5-8%)
  - コンテキスト解析: 10000-15000ms (27-40%)
  - 回答生成: 20000-25000ms (54-68%)
- チャンク処理: 100ms (0.3%)
```

**主要なボトルネック**:
1. **コンテキスト解析**: 10-15秒（27-40%）🔴 **最重要**
2. **回答生成**: 20-25秒（54-68%）🔴 **重要**
3. **ネットワークレイテンシ**: 2-3秒（5-8%）🟡 **中程度**

---

## 💡 最適化の方向性

### 優先度1: コンテキスト件数の削減 🔴 **最重要**

**現在**: 12件  
**推奨**: 8-10件

**期待効果**:
- プロンプト長を20-30%削減
- 処理時間を30-50%削減（37.1秒 → 18-26秒）

**実装方法**:
```typescript
// 現在
const MAX_CONTEXT_DOCS = 12;

// 推奨
const MAX_CONTEXT_DOCS = 8; // または 10
```

**トレードオフ**:
- 参照元の情報が減る可能性
- 回答の完全性に影響する可能性
- ただし、上位8-10件で十分な情報が得られる可能性が高い

---

### 優先度2: 各ドキュメントの文字数制限の最適化 🔴 **重要**

**現在の文字数制限**:
```
1位: 1400文字
2位: 1260文字
3位: 1120文字
4-6位: 800文字
7-10位: 700文字
11-12位: 500文字
合計: 9980文字
```

**推奨（8件の場合）**:
```
1位: 1200文字（-200文字）
2位: 1000文字（-260文字）
3位: 900文字（-220文字）
4-5位: 700文字（-100文字 × 2）
6-8位: 600文字（-100文字 × 3）
合計: 5700文字（-4280文字、-43%削減）
```

**期待効果**:
- プロンプト長を40-50%削減
- 処理時間を30-40%削減

**トレードオフ**:
- 各ドキュメントの情報量が減る可能性
- ただし、キーワード周辺抽出により重要な情報は保持される

---

### 優先度3: プロンプトテンプレートの最適化 🟡 **中程度**

**現在のテンプレート**:
- 約1,500-2,000文字
- 詳細な説明と例を含む

**推奨**:
- 不要な説明を削除
- 簡潔な指示に変更
- 約1,000-1,200文字に削減

**期待効果**:
- プロンプト長を10-20%削減
- 処理時間を5-10%削減

**トレードオフ**:
- 指示の明確性に影響する可能性
- ただし、AIモデルの理解力により影響は限定的

---

### 優先度4: コンテンツ抽出方式の最適化 🟡 **中程度**

**現在の方式**:
- 先頭取得: 固定800文字
- キーワード周辺取得: 固定600文字
- ランキングに応じた比率調整

**推奨**:
- 先頭取得: 固定600文字（-200文字）
- キーワード周辺取得: 固定400文字（-200文字）
- ランキングに応じた比率調整は維持

**期待効果**:
- 各ドキュメントの文字数を10-20%削減
- 処理時間を5-10%削減

**トレードオフ**:
- 先頭部分の情報が減る可能性
- キーワード周辺の情報が減る可能性
- ただし、重要な情報は保持される

---

## 📊 期待される改善効果（総合）

### シナリオ1: コンテキスト件数を8件に削減

| 項目 | 現在 | 改善後 | 削減 |
|------|------|--------|------|
| **コンテキスト件数** | 12件 | 8件 | -33% |
| **プロンプト長** | 11,500-14,000文字 | 7,500-9,000文字 | -35% |
| **処理時間** | 37.1秒 | 24-26秒 | -30-35% |

---

### シナリオ2: コンテキスト件数を8件 + 文字数制限を最適化

| 項目 | 現在 | 改善後 | 削減 |
|------|------|--------|------|
| **コンテキスト件数** | 12件 | 8件 | -33% |
| **各ドキュメントの文字数** | 9980文字 | 5700文字 | -43% |
| **プロンプト長** | 11,500-14,000文字 | 6,500-7,500文字 | -45-50% |
| **処理時間** | 37.1秒 | 18-22秒 | -40-50% |

---

### シナリオ3: コンテキスト件数を8件 + 文字数制限 + プロンプト最適化

| 項目 | 現在 | 改善後 | 削減 |
|------|------|--------|------|
| **コンテキスト件数** | 12件 | 8件 | -33% |
| **各ドキュメントの文字数** | 9980文字 | 5700文字 | -43% |
| **プロンプトテンプレート** | 1,500-2,000文字 | 1,000-1,200文字 | -30-40% |
| **プロンプト長** | 11,500-14,000文字 | 6,000-7,000文字 | -50-55% |
| **処理時間** | 37.1秒 | 16-20秒 | -45-55% |

---

## 🔍 実装の詳細

### 1. コンテキスト準備のフロー

```typescript
// ステップ1: 検索結果から上位12件を取得
const contextDocs = context.slice(0, 12);

// ステップ2: 各ドキュメントのコンテンツを抽出
const contextParts = contextDocs.map((doc, index) => {
  // ランキングに基づく動的な文字数制限
  const maxLength = index === 0 ? 1400 : index === 1 ? 1260 : ...;
  
  // ハイブリッド方式によるコンテンツ抽出
  const truncatedContent = doc.content && doc.content.length > maxLength
    ? extractRelevantContentMultiKeyword(doc.content, sanitizedQuestion, maxLength, index)
    : doc.content || '内容なし';
  
  return `**${doc.title}**
${truncatedContent}`;
});

// ステップ3: コンテキストテキストを結合
const contextText = contextParts.join('\n\n');
```

---

### 2. コンテンツ抽出の詳細フロー

```typescript
// ステップ1: キーワード抽出
const keywords = extractKeywords(query);

// ステップ2: キーワード位置の検索
const keywordPositions = [];
for (const keyword of keywords) {
  let pos = 0;
  while ((pos = content.indexOf(keyword, pos)) >= 0) {
    keywordPositions.push({ keyword, position: pos });
    pos += keyword.length;
  }
}

// ステップ3: 先頭取得範囲とキーワード周辺範囲を計算
const headStartPos = 0;
const headEndPos = Math.min(content.length, 800);
const keywordStartPos = Math.max(0, firstKeywordPos - 150);
const keywordEndPos = Math.min(content.length, lastKeywordPos + 150);

// ステップ4: ランキングに応じた比率でmaxLengthを分配
const headRatio = 0.7 - (normalizedRank / 9) * 0.4;
const keywordRatio = 1.0 - headRatio;
const headLength = Math.floor(maxLength * headRatio);
const keywordLength = Math.floor(maxLength * keywordRatio);

// ステップ5: 抽出範囲を決定（重複を考慮）
// ... 複雑なロジック ...

// ステップ6: 抽出範囲を確定し、maxLengthを超えないように調整
let extracted = content.substring(startPos, endPos);
if (extracted.length > maxLength) {
  extracted = extracted.substring(0, maxLength);
}
```

---

## ✅ 推奨される実装順序

### Phase 1: コンテキスト件数の削減（即座に実施）

1. `MAX_CONTEXT_DOCS`を12から8に変更
2. パフォーマンステストを実施
3. 回答品質への影響を確認

**期待効果**: 処理時間を30-35%削減

---

### Phase 2: 文字数制限の最適化（Phase 1の後）

1. 各ドキュメントの文字数制限を調整
2. パフォーマンステストを実施
3. 回答品質への影響を確認

**期待効果**: 処理時間を追加で10-15%削減（合計40-50%削減）

---

### Phase 3: プロンプトテンプレートの最適化（Phase 2の後）

1. プロンプトテンプレートを簡潔化
2. パフォーマンステストを実施
3. 回答品質への影響を確認

**期待効果**: 処理時間を追加で5-10%削減（合計45-55%削減）

---

## 📝 まとめ

### 現在の実装

- **コンテキスト件数**: 12件
- **各ドキュメントの文字数**: 500-1400文字（ランキングベース）
- **合計コンテキスト長**: 約10,000文字
- **プロンプト長**: 約11,500-14,000文字

### 主要なボトルネック

1. **コンテキスト解析**: 10-15秒（27-40%）
2. **回答生成**: 20-25秒（54-68%）
3. **ネットワークレイテンシ**: 2-3秒（5-8%）

### 推奨される対策

1. **コンテキスト件数を8件に削減**（優先度: 最高）
2. **各ドキュメントの文字数制限を最適化**（優先度: 高）
3. **プロンプトテンプレートを最適化**（優先度: 中）

### 期待される改善効果

- **処理時間**: 37.1秒 → 16-20秒（-45-55%削減）
- **プロンプト長**: 11,500-14,000文字 → 6,000-7,000文字（-50-55%削減）

---

## 🔗 関連ドキュメント

- [AI生成時間の詳細分析レポート](./AI_GENERATION_PERFORMANCE_ANALYSIS_2025-11-21.md)
- [現在のパフォーマンス問題](./CURRENT_PERFORMANCE_ISSUES_2025-11-21.md)
- [パフォーマンス改善の検証](./PERFORMANCE_IMPROVEMENT_VERIFICATION_2025-11-21.md)

