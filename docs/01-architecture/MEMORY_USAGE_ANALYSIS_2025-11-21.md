# メモリ使用量分析レポート (2025-11-21)

**作成日**: 2025年11月21日  
**ステータス**: 🔍 原因特定完了

---

## 📊 問題の概要

本番環境でメモリ制限エラーが発生しています：

```
Memory limit of 8192 MiB exceeded with 8206 MiB used
```

メモリ制限（8GB）を超えており、インスタンスがクラッシュして再起動しています。

---

## 🔍 根本原因分析

### 1. Lunrインデックスのメモリ使用量 🔴 **最重要**

#### 問題
- **全ドキュメントをメモリに保持**: `lunr-search-client.ts`で全ドキュメント（最大10,000件）を`Map`に保持
- **Lunrインデックス自体**: インデックス構造もメモリに保持
- **ドキュメントデータ**: タイトル、コンテンツ、ラベルなどの全データをメモリに保持

#### コード箇所

```typescript
// src/lib/lunr-search-client.ts (213-224行目)
const tableDocuments = this.documents.get(tableName)!;
tableDocuments.clear();

// 全ドキュメントをMapに保持（メモリに常駐）
for (const doc of data.documents) {
  tableDocuments.set(doc.id, doc);
}
```

#### 推定メモリ使用量

| 項目 | 件数 | 1件あたりのサイズ | 合計 |
|------|------|------------------|------|
| ドキュメントデータ | 1,229件 | 約50KB（タイトル+コンテンツ+ラベル） | **約60MB** |
| Lunrインデックス | 1件 | 約200MB | **約200MB** |
| **合計（Lunr関連）** | - | - | **約260MB** |

### 2. LanceDBデータのメモリ読み込み 🟡 **重要**

#### 問題
- **初期化時の全データ読み込み**: `lunr-initializer.ts`で`limit(10000).toArray()`により全データをメモリに読み込む
- **ベクトルデータ**: 768次元 × 4バイト × 1,229件 = 約3.8MB（ベクトルのみ）
- **メタデータ**: タイトル、コンテンツ、ラベルなど = 約60MB

#### コード箇所

```typescript
// src/lib/lunr-initializer.ts (161行目)
const docs = await tbl.query().limit(10000).toArray();
```

#### 推定メモリ使用量

| 項目 | 件数 | 1件あたりのサイズ | 合計 |
|------|------|------------------|------|
| ベクトルデータ | 1,229件 | 約3KB（768次元 × 4バイト） | **約3.8MB** |
| メタデータ | 1,229件 | 約50KB | **約60MB** |
| **合計（LanceDB読み込み時）** | - | - | **約64MB** |

### 3. キャッシュのメモリ使用量 🟡 **重要**

#### 問題
- **検索結果キャッシュ**: `maxSize: 5000`エントリ
- **チャンクキャッシュ**: `maxCacheSize: 500MB`
- **埋め込みキャッシュ**: `maxSize: 1000`エントリ（サイズ制限なし）
- **回答キャッシュ**: `maxSize: 1000`エントリ

#### 推定メモリ使用量

| キャッシュ | 最大サイズ | 実際の使用量（推定） |
|-----------|-----------|-------------------|
| 検索結果キャッシュ | 5,000エントリ | 約50MB（1エントリ10KB想定） |
| チャンクキャッシュ | 500MB | **最大500MB** |
| 埋め込みキャッシュ | 1,000エントリ | 約3MB（1エントリ3KB想定） |
| 回答キャッシュ | 1,000エントリ | 約10MB（1エントリ10KB想定） |
| **合計（キャッシュ）** | - | **最大約563MB** |

### 4. その他のメモリ使用量 🟢 **通常範囲**

| 項目 | 推定サイズ |
|------|-----------|
| Node.jsランタイム | 約100MB |
| Next.jsフレームワーク | 約200MB |
| その他のライブラリ | 約100MB |
| **合計（その他）** | **約400MB** |

---

## 📊 合計メモリ使用量の推定

| カテゴリ | 推定サイズ |
|---------|-----------|
| Lunrインデックス + ドキュメント | 約260MB |
| LanceDBデータ読み込み時 | 約64MB |
| キャッシュ（最大） | 約563MB |
| その他（ランタイム等） | 約400MB |
| **合計（通常時）** | **約1,287MB** |
| **合計（キャッシュ最大時）** | **約1,787MB** |

**しかし、実際には8GBを超えているため、他の原因が考えられます。**

---

## 🚨 考えられる追加の原因

### 1. **メモリリーク** 🔴 **最有力**

#### 可能性
- キャッシュが適切にクリアされていない
- イベントリスナーが適切に削除されていない
- クロージャーによる参照が保持されている

#### 確認方法
- メモリ使用量のログを追加
- キャッシュのサイズを定期的に監視

### 2. **複数のインスタンスが同時に起動** 🟡 **可能性あり**

#### ログから
```
Starting new instance. Reason: MANUAL_OR_CUSTOMER_MIN_INSTANCE
```

`minInstances: 1`に設定しているが、メモリ不足でクラッシュしたインスタンスが再起動し、複数のインスタンスが同時に存在する可能性があります。

### 3. **LanceDBのインデックスがメモリに読み込まれている** 🟡 **可能性あり**

#### 可能性
- ベクトルインデックス（IVF_PQ）がメモリに読み込まれている
- スカラーインデックス（page_id）がメモリに読み込まれている

#### 推定サイズ
- ベクトルインデックス: 約100-200MB
- スカラーインデックス: 約10-20MB

### 4. **Kuromoji辞書のメモリ使用量** 🟢 **通常範囲**

#### 推定サイズ
- Kuromoji辞書: 約50-100MB

---

## 🎯 推奨される対策

### 即座に実施すべき対策（優先度: ★★★ 高）

1. **メモリ使用量の監視ログを追加**
   - 各コンポーネントのメモリ使用量をログに記録
   - キャッシュのサイズを定期的に監視

2. **キャッシュサイズの削減**
   - チャンクキャッシュ: 500MB → 200MB
   - 検索結果キャッシュ: 5,000エントリ → 2,000エントリ

3. **Lunrインデックスの最適化**
   - ドキュメントデータをメモリに保持しない（必要時のみ取得）
   - インデックスのみをメモリに保持

### 中期的な対策（優先度: ★★☆ 中）

4. **メモリリークの調査**
   - メモリプロファイラーを使用
   - 定期的なガベージコレクション

5. **LanceDBの最適化**
   - インデックスのメモリ使用量を確認
   - 必要に応じてインデックスの最適化

### 長期的な対策（優先度: ★☆☆ 低）

6. **アーキテクチャの見直し**
   - Lunrインデックスを外部ストレージに保存
   - 必要時のみメモリに読み込む

---

## 📈 期待される改善効果

| 対策 | 現在 | 改善後 | 削減量 |
|------|------|--------|--------|
| キャッシュサイズ削減 | 563MB | 200MB | -363MB |
| Lunrインデックス最適化 | 260MB | 200MB | -60MB |
| **合計** | **823MB** | **400MB** | **-423MB** |

---

## 🔗 関連ドキュメント

- [パフォーマンス分析レポート](./PERFORMANCE_ANALYSIS_2025-11-21.md)
- [ハイブリッド検索システム仕様書](./02.01.02-hybrid-search-specification.md)
- [LanceDBデータ構造仕様書](./01.02.02-lancedb-data-structure-specification.md)

---

## 📝 実装メモ

### メモリ使用量の監視ログ追加

```typescript
// メモリ使用量をログに記録
function logMemoryUsage(label: string): void {
  const usage = process.memoryUsage();
  console.log(`[Memory] ${label}:`, {
    heapUsed: `${(usage.heapUsed / 1024 / 1024).toFixed(2)}MB`,
    heapTotal: `${(usage.heapTotal / 1024 / 1024).toFixed(2)}MB`,
    rss: `${(usage.rss / 1024 / 1024).toFixed(2)}MB`,
    external: `${(usage.external / 1024 / 1024).toFixed(2)}MB`
  });
}
```

### キャッシュサイズの削減

```typescript
// src/lib/lancedb-cache.ts
private readonly config = {
  maxCacheSize: 200 * 1024 * 1024, // 500MB → 200MB
  // ...
};

// src/lib/lancedb-search-client.ts
maxSize: 2000, // 5000 → 2000
```

---

## ✅ 次のステップ

1. メモリ使用量の監視ログを追加
2. キャッシュサイズを削減
3. Lunrインデックスの最適化を検討
4. メモリプロファイラーでメモリリークを調査

