# Structured Label System 実装状況と改善ガイド

**作成日**: 2025年1月27日  
**最終更新**: 2025年1月27日  
**Phase**: Phase 0A-1  
**ステータス**: 🟡 部分実装

---

## 📋 目次

1. [概要](#1-概要)
2. [実装状況](#2-実装状況)
3. [現状分析](#3-現状分析)
4. [生成精度向上の方法](#4-生成精度向上の方法)
5. [未同期調査結果](#5-未同期調査結果)

---

## 1. 概要

Structured Label Systemは、Confluenceページのラベルを構造化し、検索の精度向上とカテゴリ管理を実現するシステムです。

---

## 2. 実装状況

### 2.1 実装済みの機能

#### 自動生成機能（Genkit Flow）

**実装ファイル**: `src/ai/flows/auto-label-flow.ts`

**機能**:
- Genkit Flowによる自動ラベル生成
- ルールベース生成（80%のケース、信頼度 0.9）
- LLMベース生成（20%のケース、Gemini 2.0 Flash使用）

**生成フロー**:
```typescript
// Step 1: ルールベースで高速判定（80%のケースに対応）
const ruleBasedLabel = tryRuleBasedLabeling(input);
if (ruleBasedLabel && ruleBasedLabel.confidence >= 0.85) {
  return ruleBasedLabel;  // 高速・高精度
}

// Step 2: LLMベースでラベル生成（20%のケース）
const { text } = await ai.generate({
  model: GeminiConfig.model,
  prompt: buildLLMPrompt(input, domainCandidates, topDomains),
  config: {
    temperature: 0.1,  // 低温度で一貫性を重視
    maxOutputTokens: 500,
  },
});
```

**ルールベース判定の条件**:
- `status !== 'unknown'` AND `category !== 'other'` AND `domain !== 'その他'`
- 信頼度 >= 0.85 の場合、ルールベース結果を返す

**LLM生成の条件**:
- ルールベースで判定できない場合（20%のケース）
- Domain Knowledgeからドメイン候補を抽出
- プロンプトにドメイン候補と上位30件のドメイン一覧を含める

#### Firestore保存・取得機能

**実装ファイル**: `src/lib/structured-label-service.ts`

**機能**:
- StructuredLabelの保存（`saveStructuredLabel`）
- StructuredLabelの取得（`getStructuredLabel`）
- 複数ページの一括取得（`getStructuredLabels`）
- 統計情報の取得（`getStructuredLabelStats`）

**Firestoreコレクション**: `structured_labels`

**スキーマ**:
```typescript
interface StructuredLabelDocument {
  pageId: string;                    // Confluenceページ ID
  structuredLabel: StructuredLabel;  // 構造化ラベル
  generatedAt: Date;                 // 生成日時
  generatedBy: 'rule-based' | 'llm-based';  // 生成方法
}
```

#### 一括生成スクリプト

**実装ファイル**: `scripts/generate-structured-labels.ts`

**機能**:
- 既存のConfluenceページに対してStructuredLabelを一括生成
- Firestoreに保存

**実行方法**:
```bash
npm run generate-structured-labels
```

### 2.2 スキーマ

**StructuredLabel**:
```typescript
interface StructuredLabel {
  category: SystemCategory;      // カテゴリ（spec, guide, template等）
  domain: SystemDomain;          // ドメイン（会員管理、求人管理等）
  feature: string;               // 機能名（タイトルから抽出）
  status?: SystemStatus;         // ステータス（active, deprecated等）
  version?: string;              // バージョン（タイトルから抽出）
  priority?: SystemPriority;     // 優先度（high, medium, low）
  tags?: string[];               // タグ（ラベルから抽出）
  confidence: number;            // 信頼度（0.0-1.0）
  content_length: number;        // コンテンツ長
  is_valid: boolean;             // 有効性（コンテンツ長 >= 100）
}
```

---

## 3. 現状分析

### 3.1 現在の生成精度

- **高信頼度 (>= 0.85)**: 61.5% (1,073件)
- **中信頼度 (0.7-0.85)**: 37.7% (658件)
- **低信頼度 (< 0.7)**: 0.9% (15件)
- **平均信頼度**: 85.3%

### 3.2 生成方法の内訳

- **ルールベース**: 61.5% (1,073件) - 信頼度 0.9
- **LLMベース**: 38.5% (673件) - 信頼度 0.7

### 3.3 目標

- **高信頼度**: 80%以上（現在61.5% → 目標80%）
- **ルールベース割合**: 80%以上（現在61.5% → 目標80%）

---

## 4. 生成精度向上の方法

### 4.1 ルールベース生成の拡張（最重要）

#### 現在の問題点

```typescript
// 現在のルールベース生成条件（厳しすぎる）
if (status !== 'unknown' && category !== 'other' && domain !== 'その他') {
  // confidence: 0.9
}
```

**問題**:
- 条件が厳しすぎて、多くのページがLLMベースに回ってしまう
- `status === 'unknown'` のページが多い
- `category === 'other'` のページが多い
- `domain === 'その他'` のページが多い

#### 改善策 A: 条件を緩和（段階的判定）

```typescript
function tryRuleBasedLabeling(input: z.infer<typeof InputSchema>): StructuredLabel | null {
  const status = StructuredLabelHelper.extractStatusFromTitle(input.title);
  const version = StructuredLabelHelper.extractVersionFromTitle(input.title);
  const category = StructuredLabelHelper.inferCategoryFromLabels(input.labels);
  const domain = StructuredLabelHelper.inferDomainFromContent(input.title, input.content.substring(0, 1000));
  
  // 段階的に信頼度を設定
  let confidence = 0.9;
  let canUseRuleBased = false;
  
  // 高信頼度（0.9）: 全条件が揃っている場合
  if (status !== 'unknown' && category !== 'other' && domain !== 'その他') {
    canUseRuleBased = true;
    confidence = 0.9;
  }
  // 中信頼度（0.85）: categoryとdomainが揃っている場合（statusはunknownでも可）
  else if (category !== 'other' && domain !== 'その他') {
    canUseRuleBased = true;
    confidence = 0.85;
  }
  // 低信頼度（0.8）: categoryまたはdomainが揃っている場合
  else if (category !== 'other' || domain !== 'その他') {
    canUseRuleBased = true;
    confidence = 0.8;
  }
  
  if (canUseRuleBased) {
    const feature = StructuredLabelHelper.cleanTitle(input.title);
    const priority = StructuredLabelHelper.inferPriority(category, status);
    
    // タグ抽出ロジック（既存）
    // ...
    
    return {
      category,
      domain,
      feature,
      status,
      version,
      priority,
      tags: tags.length > 0 ? tags : undefined,
      confidence,  // 段階的な信頼度
      content_length: input.content.length,
      is_valid: input.content.length >= 100
    };
  }
  
  return null;
}
```

**期待される効果**:
- ルールベース生成率: 61.5% → 約75-80%
- 高信頼度率: 61.5% → 約75-80%

#### 改善策 B: ドメイン推測の精度向上

**現在の問題**:
`inferDomainFromContent`が単純なキーワードマッチングのみを使用しています。

**改善案**:
```typescript
static inferDomainFromContent(title: string, content: string): SystemDomain {
  const text = (title + ' ' + content).toLowerCase();
  
  // 重み付きスコアリング
  const domainScores: Record<SystemDomain, number> = {
    '会員管理': 0,
    '求人管理': 0,
    '教室管理': 0,
    'クライアント企業管理': 0,
    '全体管理': 0,
    'オファー管理': 0,
    '採用フロー': 0,
    '口コミ・評価': 0,
    'システム共通': 0,
    'その他': 0,
  };
  
  // タイトルのキーワードを重視（重み: 2.0）
  const titleText = title.toLowerCase();
  for (const [domain, keywords] of Object.entries(DOMAIN_KEYWORDS)) {
    const titleMatches = keywords.filter(kw => titleText.includes(kw)).length;
    domainScores[domain as SystemDomain] += titleMatches * 2.0;
  }
  
  // コンテンツのキーワード（重み: 1.0）
  for (const [domain, keywords] of Object.entries(DOMAIN_KEYWORDS)) {
    const contentMatches = keywords.filter(kw => text.includes(kw)).length;
    domainScores[domain as SystemDomain] += contentMatches * 1.0;
  }
  
  // 最高スコアのドメインを返す
  const maxScore = Math.max(...Object.values(domainScores));
  if (maxScore > 0) {
    const topDomain = Object.entries(domainScores)
      .find(([_, score]) => score === maxScore)?.[0] as SystemDomain;
    return topDomain || 'その他';
  }
  
  return 'その他';
}
```

**期待される効果**:
- ドメイン推測の精度向上
- `domain === 'その他'` の割合を削減

### 4.2 LLM生成の精度向上

#### 改善策: プロンプトの最適化

**現在の問題**:
- プロンプトが長すぎる可能性
- ドメイン候補の選択が不適切

**改善案**:
```typescript
function buildLLMPrompt(
  input: z.infer<typeof InputSchema>,
  domainCandidates: string[],
  topDomains: string[]
): string {
  return `
以下のConfluenceページの情報から、StructuredLabelを生成してください。

タイトル: ${input.title}
ラベル: ${input.labels.join(', ')}
コンテンツ（最初の500文字）: ${input.content.substring(0, 500)}

ドメイン候補（コンテンツから抽出）: ${domainCandidates.join(', ')}
上位ドメイン（頻出）: ${topDomains.slice(0, 10).join(', ')}

以下のJSON形式で返してください:
{
  "category": "spec|guide|template|other",
  "domain": "ドメイン名",
  "feature": "機能名",
  "status": "active|deprecated|unknown",
  "version": "バージョン（あれば）",
  "priority": "high|medium|low",
  "tags": ["タグ1", "タグ2"]
}
`;
}
```

**期待される効果**:
- LLM生成の精度向上
- 一貫性の向上

---

## 5. 未同期調査結果

### 5.1 統計情報

- **Firestore総件数**: 1,746件
- **LanceDB総ページ数**: 152件（ユニーク、ローカル環境）
- **同期済み**: 152件
- **未同期総数**: 1,594件
- **Firestoreのみ**: 1,594件（LanceDBにページが存在しない）
- **LanceDBのみ**: 0件

### 5.2 結論

未同期の1,594件は、**ローカル環境のLanceDBには存在しないページ**です。本番環境には存在する可能性があります。これらのStructuredLabelは本番環境で同期される可能性があります。

---

## 📊 まとめ

### 改善された項目

1. ✅ **自動生成機能**: Genkit Flowによる実装完了
2. ✅ **Firestore保存・取得機能**: 実装完了
3. ✅ **一括生成スクリプト**: 実装完了

### 残課題

1. ⚠️ **生成精度**: 高信頼度率が61.5%（目標: 80%）
2. ⚠️ **ルールベース生成率**: 61.5%（目標: 80%）
3. ⚠️ **ドメイン推測の精度**: 改善の余地あり

### 推奨される次のステップ

1. 🔴 **最優先**: ルールベース生成の条件を緩和（段階的判定）
2. 🔴 **最優先**: ドメイン推測の精度向上（重み付きスコアリング）
3. 🟡 **重要**: LLM生成のプロンプト最適化
4. 🟡 **重要**: 未同期ページの調査（本番環境）

---

## 🔗 関連ドキュメント

- [Structured Label設計](./04.01.01-structured-label-design.md)
- [ラベルシステムAPI仕様](./04.01.02-label-system-api.md)
- [ドメイン知識抽出ガイド](./04.02.01-domain-knowledge-extraction-guide.md)

---

**注意**: このドキュメントは、Structured Label Systemの実装状況と改善ガイドを統合したものです。詳細な分析結果は、アーカイブフォルダ（`docs/99-archive/architecture/structured-label-analysis/`）を参照してください。


