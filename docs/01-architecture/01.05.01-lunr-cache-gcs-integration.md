# LunrキャッシュGCS統合アーキテクチャ

**作成日**: 2025年11月23日  
**最終更新**: 2025年11月23日  
**ステータス**: ✅ 実装完了  
**関連ドキュメント**: 
- [運用ガイド](../04-operations/04.18-lunr-cache-gcs-operation-guide.md)
- [Lunr初期化根本原因分析](../analysis/lunr-initialization-root-cause.md)

---

## 1. 概要

### 1.1 目的

Lunrインデックスの初期化時間を短縮し、Cloud Runのコールドスタート時のパフォーマンスを向上させるため、Google Cloud Storage (GCS) へのキャッシュ自動保存・読み込み機能を実装しました。

### 1.2 背景と問題

**問題**: 本番環境でLunrインデックスの初期化に約35秒かかっていた

**根本原因**:
1. Cloud Runのローカルファイルシステムはインスタンス終了と共に消える
2. インスタンスがスケールダウン（0にスケール）すると、キャッシュファイルが失われる
3. コールドスタート時は毎回再構築が必要（1233件のドキュメントをトークン化）

**影響**:
- 初回リクエスト時にユーザーを35秒待たせる
- サーバーリソース（CPU・メモリ）の無駄な消費
- 複数インスタンス間でキャッシュを共有できない

---

## 2. アーキテクチャ設計

### 2.1 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Cloud Run インスタンス                    │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         LunrInitializer                              │  │
│  │  ┌──────────────────────────────────────────────┐   │  │
│  │  │ 1. ローカルキャッシュをチェック               │   │  │
│  │  │ 2. ない場合、GCSからダウンロード              │   │  │
│  │  │ 3. ローカルキャッシュからロード               │   │  │
│  │  └──────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                  │
│                          ▼                                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         LunrSearchClient                             │  │
│  │  ┌──────────────────────────────────────────────┐   │  │
│  │  │ 1. ローカルファイルシステムに保存             │   │  │
│  │  │ 2. GCSにも自動アップロード                   │   │  │
│  │  └──────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                  │
│                          ▼                                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         GCSCacheHelper                               │  │
│  │  - uploadLunrCacheToGCS()                           │  │
│  │  - downloadLunrCacheFromGCS()                       │  │
│  │  - tryDownloadLunrCacheFromGCS()                    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ GCS API
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              Google Cloud Storage                           │
│                                                             │
│  Bucket: confluence-copilot-data                           │
│  Path: .cache/lunr-index.msgpack                           │
│       .cache/lunr-index.json                               │
│       .cache/lunr-index-{tableName}.msgpack                │
│       .cache/lunr-index-{tableName}.json                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 データフロー

#### 2.2.1 起動時（コールドスタート）

```
1. サーバー起動
   ↓
2. LunrInitializer.initializeAsync()
   ↓
3. ローカルキャッシュをチェック
   ├─ 存在する → ローカルキャッシュからロード（完了）
   └─ 存在しない
      ↓
4. GCSからダウンロードを試みる（本番環境のみ）
   ├─ 成功 → ローカルに保存 → ローカルキャッシュからロード
   └─ 失敗 → 再構築（LanceDBから取得 → トークン化 → インデックス構築）
      ↓
5. 再構築完了後、ローカルに保存 → GCSにもアップロード
```

#### 2.2.2 キャッシュ保存時

```
1. Lunrインデックス構築完了
   ↓
2. LunrSearchClient.saveToDisk()
   ↓
3. ローカルファイルシステムに保存
   ├─ MessagePack形式: .cache/lunr-index.msgpack
   └─ JSON形式: .cache/lunr-index.json（互換性のため）
   ↓
4. GCSにも自動アップロード（本番環境のみ）
   ├─ MessagePack形式: .cache/lunr-index.msgpack
   └─ JSON形式: .cache/lunr-index.json
```

---

## 3. 実装詳細

### 3.1 コンポーネント

#### 3.1.1 GCSCacheHelper (`src/lib/gcs-cache-helper.ts`)

**役割**: GCS操作のヘルパー関数を提供

**主要関数**:

```typescript
// LunrキャッシュをGCSにアップロード
async function uploadLunrCacheToGCS(
  localFilePath: string,
  tableName: string = 'confluence'
): Promise<boolean>

// GCSからLunrキャッシュをダウンロード
async function downloadLunrCacheFromGCS(
  localFilePath: string,
  tableName: string = 'confluence'
): Promise<boolean>

// MessagePack/JSONの両方を試行してダウンロード
async function tryDownloadLunrCacheFromGCS(
  cacheDir: string,
  tableName: string = 'confluence'
): Promise<boolean>
```

**特徴**:
- 本番環境（Cloud Run）でのみ有効化
- エラー時も処理を継続（オプション機能）
- MessagePack形式を優先的に使用（10倍高速、50-70%圧縮）

#### 3.1.2 LunrSearchClient (`src/lib/lunr-search-client.ts`)

**変更点**: `saveToDisk()`メソッドにGCSアップロード機能を追加

```typescript
async saveToDisk(documents: LunrDocument[], cachePath: string, tableName: string): Promise<void> {
  // 1. ローカルファイルシステムに保存
  await fs.writeFile(msgpackPath, buffer);
  await fs.writeFile(jsonPath, jsonPayload, 'utf-8');
  
  // 2. GCSにも自動アップロード（本番環境のみ）
  try {
    const { uploadLunrCacheToGCS } = await import('./gcs-cache-helper');
    await uploadLunrCacheToGCS(msgpackPath, tableName);
    await uploadLunrCacheToGCS(jsonPath, tableName);
  } catch (gcsError) {
    // エラーは警告のみ（オプション機能）
    console.warn(`[LunrSearchClient] GCS upload failed (non-critical): ${gcsError.message}`);
  }
}
```

#### 3.1.3 LunrInitializer (`src/lib/lunr-initializer.ts`)

**変更点**: `_performInitialization()`メソッドにGCSダウンロード機能を追加

```typescript
private async _performInitialization(tableName: string): Promise<void> {
  // 1. ローカルキャッシュをチェック
  let loaded = await lunrSearchClient.loadFromCache(cachePath, tableName);
  
  // 2. ローカルキャッシュがない場合、GCSからダウンロードを試みる
  if (!loaded && isCloudRun) {
    const { tryDownloadLunrCacheFromGCS } = await import('./gcs-cache-helper');
    const downloaded = await tryDownloadLunrCacheFromGCS(cacheDir, tableName);
    if (downloaded) {
      // ダウンロード成功後、再度ローカルキャッシュからロード
      loaded = await lunrSearchClient.loadFromCache(cachePath, tableName);
    }
  }
  
  // 3. キャッシュからロード成功時は完了
  if (loaded) {
    return;
  }
  
  // 4. キャッシュがない場合、再構築
  // ...
}
```

### 3.2 環境判定

**実装**: `appConfig.deployment.isCloudRun`を使用

```typescript
// src/lib/gcs-cache-helper.ts
function getGCSClient(): Storage | null {
  // 本番環境（Cloud Run）でのみ有効化
  if (!appConfig.deployment.isCloudRun) {
    return null;
  }
  // ...
}
```

**判定基準**:
- `K_SERVICE`環境変数が設定されている場合、Cloud Run環境と判定
- 開発環境ではGCS操作をスキップ（正常動作）

### 3.3 ファイル形式

**MessagePack形式（優先）**:
- ファイル名: `lunr-index.msgpack` または `lunr-index-{tableName}.msgpack`
- 利点: 10倍高速、50-70%圧縮
- 使用ライブラリ: `msgpackr`

**JSON形式（互換性）**:
- ファイル名: `lunr-index.json` または `lunr-index-{tableName}.json`
- 利点: 可読性、デバッグ容易
- フォールバック: MessagePackが失敗した場合に使用

### 3.4 GCSパス構造

```
Bucket: confluence-copilot-data
├── .cache/
│   ├── lunr-index.msgpack          # Confluence（MessagePack）
│   ├── lunr-index.json             # Confluence（JSON）
│   ├── lunr-index-jira_issues.msgpack  # Jira（MessagePack）
│   └── lunr-index-jira_issues.json     # Jira（JSON）
└── lancedb/
    └── ...
```

---

## 4. パフォーマンス

### 4.1 期待される効果

| 項目 | 改善前 | 改善後 | 改善率 |
|------|--------|--------|--------|
| コールドスタート時の初期化時間 | 35秒 | 数秒（ダウンロード時間のみ） | **約90%短縮** |
| メモリ使用量 | 再構築時: 高 | キャッシュロード時: 低 | **大幅削減** |
| CPU使用量 | 再構築時: 高 | キャッシュロード時: 低 | **大幅削減** |

### 4.2 キャッシュサイズ

- MessagePack形式: 約10-15MB（圧縮後）
- JSON形式: 約20-30MB（非圧縮）
- ダウンロード時間: 約1-2秒（ネットワーク速度に依存）

---

## 5. エラーハンドリング

### 5.1 設計方針

**オプション機能として実装**: GCS操作が失敗しても、アプリケーションは正常に動作する

**理由**:
- ローカルキャッシュが存在する場合は、それを使用
- GCS操作は最適化のための機能であり、必須ではない
- エラー時も処理を継続することで、可用性を確保

### 5.2 エラーケース

| エラーケース | 動作 | ログレベル |
|-------------|------|-----------|
| GCSクライアント初期化失敗 | スキップ | WARN |
| アップロード失敗 | スキップ | WARN |
| ダウンロード失敗 | 再構築にフォールバック | WARN |
| ファイルが見つからない | 再構築にフォールバック | INFO |

---

## 6. セキュリティ

### 6.1 認証

- Cloud Runのデフォルトサービスアカウントを使用
- GCSバケットへのアクセス権限は、サービスアカウントに付与

### 6.2 アクセス制御

- バケット: `confluence-copilot-data`
- パス: `.cache/`（Lunrキャッシュ専用）
- 公開アクセス: なし（内部アクセスのみ）

---

## 7. 制約事項

### 7.1 既知の制約

1. **Cloud Runのローカルファイルシステム**
   - インスタンス終了と共に消える
   - スケールダウン時にキャッシュが失われる
   - → GCSへの保存により解決

2. **GCS操作のレイテンシ**
   - ダウンロードに1-2秒かかる
   - ネットワーク速度に依存
   - → 再構築時間（35秒）と比較して大幅に短縮

3. **複数インスタンス間の同期**
   - キャッシュ更新時に、他のインスタンスは次回起動時に最新版を取得
   - リアルタイム同期は不要（キャッシュは不変）

### 7.2 今後の改善案

1. **キャッシュの有効期限管理**
   - データ更新時にキャッシュを無効化
   - バージョン管理の導入

2. **インクリメンタル更新**
   - 差分のみを更新して、再構築時間を短縮

3. **CDN経由の配信**
   - GCSからCDN経由で配信し、ダウンロード時間を短縮

---

## 8. 関連ドキュメント

- [運用ガイド](../04-operations/04.18-lunr-cache-gcs-operation-guide.md)
- [Lunr初期化根本原因分析](../analysis/lunr-initialization-root-cause.md)
- [デプロイガイド](../04-operations/04.01-deployment-guide.md)

---

## 9. 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2025-11-23 | 初版作成 | - |

