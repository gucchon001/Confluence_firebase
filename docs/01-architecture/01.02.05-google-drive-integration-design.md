# Google Drive統合設計書

**バージョン**: 1.0  
**作成日**: 2025年1月  
**Phase**: Phase 6  
**ステータス**: ✅ 実装完了

---

## 📋 目次

1. [概要](#概要)
2. [設計原則](#設計原則)
3. [アーキテクチャ](#アーキテクチャ)
4. [データフロー](#データフロー)
5. [データスキーマ](#データスキーマ)
6. [認証設計](#認証設計)
7. [ファイル処理設計](#ファイル処理設計)
8. [インデックス化設計](#インデックス化設計)
9. [検索統合設計](#検索統合設計)
10. [実装詳細](#実装詳細)
11. [エラーハンドリング](#エラーハンドリング)
12. [パフォーマンス最適化](#パフォーマンス最適化)
13. [セキュリティ](#セキュリティ)

---

## 概要

### 目的

Google Driveに保存されているマニュアルや内部資料を検索可能なソースとして統合し、Confluence、Jiraと同様にハイブリッド検索で検索可能にする。サービスアカウント認証により共有ドライブにもアクセス可能とし、多様なファイル形式（PDF、Google Docs、Spreadsheet、Slides、テキスト、Markdown）をサポートする。

### 設計目標

1. **統合性**: Confluence、Jiraと同様の検索体験を提供
2. **拡張性**: 新しいファイル形式の追加が容易
3. **信頼性**: エラーハンドリングとリトライ機構の実装
4. **パフォーマンス**: 効率的なインデックス化と検索
5. **セキュリティ**: 適切な認証とアクセス制御

---

## 設計原則

### 1. 単一責任の原則

- **GoogleDriveService**: Google Drive APIとの通信のみを担当
- **GoogleDriveFirestoreService**: Firestoreへの保存のみを担当
- **GoogleDriveLanceDBService**: LanceDBへのインデックス化のみを担当

### 2. 依存性逆転の原則

- サービス層は抽象化されたインターフェースに依存
- 具体的な実装（Google Drive API、Firestore、LanceDB）は注入可能

### 3. オープン・クローズドの原則

- 新しいファイル形式の追加は既存コードを変更せずに拡張可能
- ファイル処理は戦略パターンで実装

---

## アーキテクチャ

### システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                   管理ダッシュボード                          │
│              (Google DriveインポートUI)                      │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Routes                                │
│  /api/admin/google-drive/import                             │
│  /api/admin/google-drive/list                               │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│ GoogleDriveService│        │ Firebase Admin   │
│  (認証・ファイル取得)      │  (認証チェック)   │
└────────┬─────────┘        └──────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│              ファイル形式別処理                              │
│  - Google Docs → text/plain                                 │
│  - Spreadsheet → text/csv → テキスト変換                    │
│  - Slides → text/plain                                      │
│  - PDF → pdf-parse → テキスト抽出                           │
│  - テキスト/Markdown → 直接取得                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│ Firestore        │        │ LanceDB          │
│ (メタデータ保存)  │        │ (ベクトル検索)   │
└──────────────────┘        └──────────────────┘
```

### レイヤー構造

```
┌─────────────────────────────────────┐
│  Presentation Layer                 │
│  - GoogleDriveImportSection.tsx     │
│  - AdminDashboard.tsx               │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  API Layer                          │
│  - /api/admin/google-drive/import   │
│  - /api/admin/google-drive/list     │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  Service Layer                      │
│  - GoogleDriveService               │
│  - GoogleDriveFirestoreService      │
│  - GoogleDriveLanceDBService        │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  Infrastructure Layer               │
│  - Google Drive API                 │
│  - Firestore                        │
│  - LanceDB                          │
│  - Gemini Embeddings API            │
└─────────────────────────────────────┘
```

---

## データフロー

### インポートフロー

```
1. ユーザーが管理ダッシュボードでファイルID/フォルダIDを指定
   ↓
2. API Routeで認証チェック（Firebase Admin）
   ↓
3. GoogleDriveServiceで認証（サービスアカウント or OAuth2）
   ↓
4. Google Drive APIでファイル情報取得
   ↓
5. ファイル形式に応じて内容を取得・変換
   ├─ Google Docs → export(text/plain)
   ├─ Spreadsheet → export(text/csv) → CSV→テキスト変換
   ├─ Slides → export(text/plain)
   ├─ PDF → get(alt=media) → pdf-parse
   └─ テキスト/Markdown → get(alt=media)
   ↓
6. GoogleDriveFirestoreServiceでFirestoreに保存
   ↓
7. GoogleDriveLanceDBServiceでLanceDBにインデックス化
   ├─ テキストをチャンク分割（1800文字、200文字オーバーラップ）
   ├─ Gemini Embeddings APIで埋め込みベクトル生成（768次元）
   └─ LanceDBに保存
   ↓
8. 結果をクライアントに返却
```

### 検索フロー

```
1. ユーザーがクエリを入力
   ↓
2. Gemini Embeddings APIでクエリをベクトル化（768次元）
   ↓
3. LanceDBでベクトル検索（Confluence/Jira/Google Drive統合）
   ├─ データソースフィルタリング（オプション）
   └─ スコアリング統合
   ↓
4. 検索結果を統合・重複除去
   ↓
5. Gemini APIで回答生成
   ↓
6. 参照元にGoogle DriveファイルURLを表示
```

---

## データスキーマ

### Firestoreスキーマ

#### Collection: `google_drive_documents`

```typescript
interface GoogleDriveDocumentRecord {
  // 基本情報
  fileId: string;                    // Google DriveファイルID（ドキュメントID）
  fileName: string;                  // ファイル名
  mimeType: string;                  // MIMEタイプ
  
  // コンテンツ
  content: string;                   // ファイル内容（テキスト）
  
  // メタデータ
  url: string;                       // Google DriveファイルURL
  lastModified?: string;             // 最終更新日時（ISO文字列）
  size?: number;                     // ファイルサイズ（バイト）
  
  // 管理情報
  importedAt: Timestamp;             // インポート日時
  importedBy: string;                // インポート実行ユーザーID
  lastSyncedAt: Timestamp;           // 最終同期日時
  version: number;                   // バージョン番号（更新回数）
}
```

**インデックス**:
- `importedBy` (単一フィールドインデックス): ユーザー別のドキュメント取得用

### LanceDBスキーマ

#### Table: `google_drive_documents`

```typescript
interface GoogleDriveLanceDBRecord {
  // 識別子
  id: string;                        // チャンクID (fileId-chunkIndex)
  file_id: string;                   // Google DriveファイルID
  
  // コンテンツ
  title: string;                     // ファイル名
  content: string;                   // チャンク内容
  chunkIndex: number;                // チャンク番号（0始まり）
  
  // メタデータ
  lastUpdated: string;               // 最終更新日時（ISO文字列）
  url: string;                       // Google DriveファイルURL
  mime_type: string;                 // MIMEタイプ
  
  // ベクトル
  vector: number[];                  // 768次元の埋め込みベクトル
  
  // データソース識別
  source: 'google_drive';            // データソース識別子（固定値）
}
```

**インデックス**:
- `file_id` (スカラーインデックス): ファイル単位の削除・更新用
- `vector` (ベクトルインデックス): ベクトル検索用

---

## 認証設計

### サービスアカウント認証（推奨）

**実装**: `GoogleDriveService.initializeWithServiceAccount()`

```typescript
// サービスアカウントキーを読み込み
const keyFile = fs.readFileSync(keyPath, 'utf8');
const key = JSON.parse(keyFile);

// JWTクライアントを作成
const auth = new JWT({
  email: key.client_email,
  key: key.private_key,
  scopes: [
    'https://www.googleapis.com/auth/drive.readonly',
    'https://www.googleapis.com/auth/drive',
  ],
});
```

**共有ドライブ対応**:
- `supportsAllDrives: true`: 共有ドライブをサポート
- `includeItemsFromAllDrives: true`: 検索結果に共有ドライブを含める
- `corpora: 'allDrives'`: すべてのドライブを対象

### OAuth2認証（オプション）

**実装**: `GoogleDriveService.initialize()`

```typescript
const auth = new OAuth2Client();
auth.setCredentials({ access_token: accessToken });
```

**用途**: 個人のGoogle Driveへのアクセス

---

## ファイル処理設計

### ファイル形式別処理戦略

```typescript
class GoogleDriveService {
  async getFileContent(fileId: string, mimeType: string): Promise<string> {
    if (mimeType === 'application/vnd.google-apps.document') {
      return await this.exportGoogleDoc(fileId);
    } else if (mimeType === 'application/vnd.google-apps.spreadsheet') {
      return await this.exportGoogleSpreadsheet(fileId);
    } else if (mimeType === 'application/vnd.google-apps.presentation') {
      return await this.exportGoogleSlides(fileId);
    } else if (mimeType === 'application/pdf') {
      return await this.exportPDF(fileId);
    } else if (mimeType === 'text/plain' || mimeType === 'text/markdown') {
      return await this.exportTextFile(fileId);
    } else {
      throw new Error(`サポートされていないファイル形式: ${mimeType}`);
    }
  }
}
```

### PDF処理

**ライブラリ**: `pdf-parse`

```typescript
private async exportPDF(fileId: string): Promise<string> {
  // PDFをダウンロード
  const response = await this.drive.files.get({
    fileId,
    alt: 'media',
    supportsAllDrives: true,
  }, {
    responseType: 'arraybuffer',
  });

  // pdf-parseでテキスト抽出
  const pdfBuffer = Buffer.from(response.data as ArrayBuffer);
  const pdfData = await pdfParse(pdfBuffer);
  return pdfData.text;
}
```

### CSV→テキスト変換

```typescript
private convertCsvToText(csv: string): string {
  const lines = csv.split('\n');
  const rows: string[][] = [];

  // CSVをパース
  for (const line of lines) {
    if (line.trim()) {
      const cells = line.split(',').map(cell => 
        cell.trim().replace(/^"|"$/g, '')
      );
      rows.push(cells);
    }
  }

  // テキスト形式に変換（Markdownテーブル風）
  let text = '';
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    if (i === 0) {
      text += `# ${row.join(' | ')}\n\n`;  // ヘッダー
    } else {
      text += `${row.join(' | ')}\n`;      // データ行
    }
  }

  return text;
}
```

---

## インデックス化設計

### チャンク分割

**実装**: `text-chunking.ts`

```typescript
function chunkText(text: string, options: ChunkOptions = {}): TextChunk[] {
  const maxChunkSize = options.maxChunkSize || 1800;
  const overlap = options.overlap || 200;

  const chunks: TextChunk[] = [];
  let start = 0;

  while (start < text.length) {
    const end = Math.min(start + maxChunkSize, text.length);
    const chunkText = text.substring(start, end).trim();

    if (chunkText.length > 0) {
      chunks.push({
        text: chunkText,
        index: chunks.length,
        start,
        end,
      });
    }

    // オーバーラップ処理
    start = end - overlap;
    if (start + maxChunkSize >= text.length && chunks.length > 0) {
      break;
    }
  }

  return chunks;
}
```

**パラメータ**:
- `maxChunkSize`: 1800文字（Confluenceと同様）
- `overlap`: 200文字（文脈保持のため）

### ベクトル生成

**実装**: `google-drive-lancedb-service.ts`

```typescript
// 各チャンクごとに埋め込みベクトルを生成
for (let i = 0; i < chunks.length; i++) {
  const chunk = chunks[i];
  const vector = await getEmbeddings(chunk.text);  // 768次元

  const record: GoogleDriveLanceDBRecord = {
    id: `${document.fileId}-${i}`,
    file_id: document.fileId,
    title: document.fileName,
    content: chunk.text,
    chunkIndex: i,
    // ...
    vector,
    source: 'google_drive',
  };

  await table.add([record]);
}
```

---

## 検索統合設計

### データソース統合

**実装**: `lancedb-search-client.ts`（既存）

```typescript
// Confluence、Jira、Google Driveを統合して検索
const results = await Promise.all([
  searchConfluence(queryVector),
  searchJira(queryVector),
  searchGoogleDrive(queryVector),  // 新規追加
]);

// 結果を統合・重複除去
const mergedResults = mergeAndDeduplicate(results);
```

### データソース識別

**実装**: `environment-utils.ts`

```typescript
export type DataSource = 
  | 'confluence' 
  | 'jira' 
  | 'google_drive'  // 新規追加
  | 'mixed' 
  | 'unknown';

export function getDataSourceFromSources(
  sources?: Array<SourceReference>
): DataSource {
  // URLからデータソースを判定
  const hasGoogleDrive = sources.some(source =>
    source.url && (
      source.url.includes('drive.google.com') || 
      source.url.includes('docs.google.com')
    )
  );
  
  // ...
}
```

---

## 実装詳細

### 主要クラス

#### GoogleDriveService

**責務**: Google Drive APIとの通信

**主要メソッド**:
- `initialize(accessToken: string)`: OAuth2認証で初期化
- `initializeWithServiceAccount(serviceAccountPath?: string)`: サービスアカウント認証で初期化
- `getFile(fileId: string)`: ファイル情報取得
- `getFileContent(fileId: string, mimeType: string)`: ファイル内容取得
- `listFiles(folderId?: string, mimeTypes?: string[])`: ファイル一覧取得
- `getDocument(fileId: string)`: 完全なドキュメント情報取得

#### GoogleDriveFirestoreService

**責務**: Firestoreへの保存

**主要メソッド**:
- `saveGoogleDriveDocument(document, userId)`: ドキュメント保存
- `getGoogleDriveDocument(fileId)`: ドキュメント取得
- `getAllGoogleDriveDocuments()`: 全ドキュメント取得
- `getGoogleDriveDocumentsByUser(userId)`: ユーザー別ドキュメント取得

#### GoogleDriveLanceDBService

**責務**: LanceDBへのインデックス化

**主要メソッド**:
- `indexGoogleDriveDocumentsToLanceDB(fileIds?: string[])`: ドキュメントをインデックス化
- `removeGoogleDriveDocumentsFromLanceDB(fileIds: string[])`: ドキュメントを削除

---

## エラーハンドリング

### 認証エラー

```typescript
try {
  await driveService.initializeWithServiceAccount();
} catch (error: any) {
  if (error.message.includes('ファイルが見つかりません')) {
    // サービスアカウントキーファイルが見つからない
    return { error: 'サービスアカウントキーファイルが見つかりません' };
  } else if (error.message.includes('権限')) {
    // 権限不足
    return { error: 'Google Driveへのアクセス権限がありません' };
  }
  throw error;
}
```

### ファイル処理エラー

```typescript
try {
  const content = await driveService.getFileContent(fileId, mimeType);
} catch (error: any) {
  if (error.message.includes('サポートされていない')) {
    // サポートされていないファイル形式
    return { success: false, error: error.message };
  } else if (error.message.includes('pdf-parse')) {
    // PDF解析エラー
    return { success: false, error: 'PDFの解析に失敗しました' };
  }
  throw error;
}
```

### インデックス化エラー

```typescript
try {
  await indexGoogleDriveDocumentsToLanceDB(fileIds);
} catch (error: any) {
  console.error('インデックス化エラー:', error);
  // エラーを記録するが、インポート自体は成功とする
  return { indexed: 0, errors: 1 };
}
```

---

## パフォーマンス最適化

### インポート処理

**現状**: 順次処理

**将来の改善**:
- 並列処理: 複数ファイルを並列でインポート
- バッチ処理: 埋め込みベクトル生成をバッチ化
- キャッシュ: 一度取得したファイル内容をキャッシュ

### 検索処理

**統合検索**: Confluence/Jira/Google Driveを統合して検索

**最適化**:
- データソースフィルタリング: 必要に応じてデータソースでフィルタリング
- スコアリング統合: データソースに関係なく統合スコアリング

---

## セキュリティ

### 認証情報の管理

**サービスアカウントキー**:
- `config/boxwood-dynamo-384411-6dec80faabfc.json`に配置
- `.gitignore`に追加推奨
- 本番環境では環境変数またはSecret Managerを使用

**アクセストークン**:
- クライアント側で一時的に保持
- サーバー側には保存しない
- 有効期限をチェック

### アクセス制御

**管理画面アクセス**:
- 管理者権限が必要
- Firebase Authenticationで認証チェック

**APIエンドポイント**:
- Firebase Admin SDKで認証チェック
- 無効なトークンは拒否

### データプライバシー

**ファイル内容**:
- FirestoreとLanceDBに保存
- 適切なアクセス制御が必要
- 機密情報の取り扱いに注意

**メタデータ**:
- インポート実行ユーザー情報を記録
- 監査ログとして使用可能

---

## 関連ドキュメント

- [Google Drive統合仕様書](../02-specifications/02.04-google-drive-spec.md)
- [LanceDB-Firestore統合設計書](./01.02.01-lancedb-firestore-integration-design.md)
- [ハイブリッド検索仕様書](./02.01.02-hybrid-search-specification.md)
- [Confluence統合仕様書](../02-specifications/02.02-confluence-spec.md)
- [Jira統合仕様書](../02-specifications/02.03-jira-spec.md)

---

**更新履歴**:
- 2025年1月: 初版作成（実装完了）

