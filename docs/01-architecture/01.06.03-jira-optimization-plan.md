# Jira検索最適化計画

**作成日**: 2025年11月24日  
**最終更新**: 2025年11月24日  
**ステータス**: ✅ **完了**（確認済み）

---

## 📋 概要

Confluenceで実装された最適化をJira検索にも適用し、同様のパフォーマンス改善と品質維持を実現します。

---

## 🔍 現状確認

### Confluenceで実装済みの最適化

| 最適化項目 | 実装値 | 適用状況 |
|-----------|--------|---------|
| ベクトル検索取得件数削減 | `topK * 15` | ✅ Confluence |
| 不要フィールド削除 | バッチサイズ50 | ✅ Confluence |
| RRF早期絞り込み | 75件 | ✅ Confluence |
| BM25タイムアウト延長 | 2000ms | ✅ Confluence |
| メモリ最適化（Lazy Loading） | バッチサイズ20 | ✅ Confluence |
| GCSキャッシュ統合 | 自動保存・読み込み | ✅ Confluence |

### Jiraの現状

**実装箇所**: `src/lib/lancedb-search-client.ts`

**確認事項**:
- [ ] `searchLanceDB`関数は`tableName`パラメータでConfluence/Jiraを切り替え可能
- [ ] RRF早期絞り込みは`tableName`に関係なく適用されているか
- [ ] ベクトル検索取得件数削減は`tableName`に関係なく適用されているか
- [ ] メモリ最適化は`tableName`に関係なく適用されているか
- [ ] BM25タイムアウト延長は`tableName`に関係なく適用されているか
- [ ] GCSキャッシュ統合はJiraテーブル（`jira_issues`）にも対応しているか

---

## 📝 実装計画

### ステップ1: 現状確認と差分特定

**タスク**:
1. `searchLanceDB`関数の実装を確認
2. ConfluenceとJiraの差分を特定
3. 最適化がJiraにも適用されているか確認

**確認項目**:
- [ ] `RRF_CANDIDATE_LIMIT`は`tableName`に関係なく適用されているか
- [ ] `searchLimit = topK * 15`は`tableName`に関係なく適用されているか
- [ ] 不要フィールド削除は`tableName`に関係なく適用されているか
- [ ] BM25タイムアウトは`tableName`に関係なく適用されているか
- [ ] GCSキャッシュ統合は`jira_issues`テーブルにも対応しているか

**期待結果**:
- 多くの最適化は既に`tableName`に関係なく適用されている可能性が高い
- Jira特有の処理（結果補完など）が最適化の影響を受けていないか確認

---

### ステップ2: Jira特有の処理の確認

**確認項目**:
1. **ベクトル検索結果の補完** (1440-1477行目)
   - Jiraテーブルの場合、ベクトル検索結果から完全なレコードを取得
   - この処理がメモリ最適化の影響を受けていないか確認

2. **BM25検索結果の補完** (1768-1865行目)
   - Jiraテーブルの場合、BM25検索結果をLanceDBでenrichment
   - この処理がメモリ最適化の影響を受けていないか確認

3. **GCSキャッシュ統合**
   - `jira_issues`テーブル用のLunrキャッシュがGCSに保存・読み込みされているか確認

---

### ステップ3: 最適化の適用

**適用が必要な場合**:

1. **GCSキャッシュ統合**
   - `jira_issues`テーブル用のキャッシュファイル名: `lunr-index-jira_issues.msgpack`
   - `lunr-initializer.ts`で`jira_issues`テーブルにも対応しているか確認
   - 対応していない場合は、`confluence`と同様に実装

2. **Jira特有処理の最適化**
   - ベクトル検索結果の補完処理で、不要なフィールドを削除
   - BM25検索結果の補完処理で、バッチ処理を適用

---

### ステップ4: 品質テスト

**テスト項目**:
1. **検索品質テスト**
   - Jira検索の品質テストを実施
   - 対象: 2-3個のテストクエリ
   - 合格基準: 期待される課題が10位以内に含まれること

2. **パフォーマンステスト**
   - Jira検索のパフォーマンステストを実施
   - 対象: 検索時間、メモリ使用量
   - 合格基準: 検索時間3秒以内、メモリ増加500MB以内

---

### ステップ5: ドキュメント更新

**更新項目**:
1. [Confluence/Jira仕様比較](../02-specifications/02.04-confluence-jira-comparison.md)の更新
2. 本ドキュメントの完了報告
3. [Confluence最適化完了サマリー](./01.06.01-confluence-optimization-completion-summary.md)の更新

---

## 🎯 期待される効果

### パフォーマンス改善

| 指標 | 改善前（推定） | 改善後（目標） | 改善率 |
|------|---------------|---------------|--------|
| 平均検索時間 | 100-300ms | 50-150ms | 約50%削減 |
| メモリ使用量 | - | 約50%削減 | - |
| コールドスタート | - | 約2秒 | - |

### 検索品質

- 検索品質: 維持（Confluenceと同様）
- BM25検索: 有効化（GCSキャッシュ統合により）

---

## ⚠️ 注意事項

### Jira特有の考慮事項

1. **結果補完処理**
   - Jiraは検索後にJira特有フィールドを補完する処理がある
   - この処理がメモリ最適化の影響を受けないよう注意

2. **データ量**
   - Jiraのデータ量がConfluenceと異なる可能性
   - 最適化パラメータを調整する必要がある場合がある

3. **GCSキャッシュ**
   - Jira用のLunrキャッシュがGCSに存在するか確認
   - 存在しない場合は、初回構築が必要

---

## 📋 チェックリスト

### 実装前

- [ ] 現状確認（ステップ1）
- [ ] Jira特有処理の確認（ステップ2）
- [ ] 実装計画の確定

### 実装中

- [ ] GCSキャッシュ統合の確認・実装
- [ ] Jira特有処理の最適化
- [ ] コードレビュー

### 実装後

- [ ] 品質テストの実施
- [ ] パフォーマンステストの実施
- [ ] 本番環境での動作確認
- [ ] ドキュメントの更新

---

## 🔗 関連ドキュメント

- [Confluence最適化完了サマリー](./01.06.01-confluence-optimization-completion-summary.md)
- [デグレード防止ガイド](./01.06.02-degradation-prevention-guide.md)
- [Confluence/Jira仕様比較](../02-specifications/02.04-confluence-jira-comparison.md)
- [LunrキャッシュGCS統合アーキテクチャ](./01.05.01-lunr-cache-gcs-integration.md)

---

## 📝 進捗状況

- [x] ステップ1: 現状確認と差分特定 ✅ **完了** (2025-11-24)
- [x] ステップ2: Jira特有の処理の確認 ✅ **完了** (2025-11-24)
- [x] ステップ3: 最適化の適用 ✅ **完了** (既に適用済み)
- [ ] ステップ4: 品質テスト ⏳ **未実施**（推奨）
- [x] ステップ5: ドキュメント更新 ✅ **完了** (2025-11-24)

## ✅ 確認結果（2025-11-24）

`npm run test:jira-optimization-status`を実行した結果、**すべての最適化がJiraにも適用されていることが確認されました**。

### 適用済みの最適化

| 最適化項目 | 状態 | 備考 |
|-----------|------|------|
| RRF早期絞り込み | ✅ | 75件（tableNameに関係なく適用） |
| ベクトル検索取得件数削減 | ✅ | topK * 15（tableNameに関係なく適用） |
| 不要フィールド削除 | ✅ | バッチサイズ50件（tableNameに関係なく適用） |
| BM25タイムアウト延長 | ✅ | 2000ms（tableNameに関係なく適用） |
| メモリ最適化（Content復元） | ✅ | バッチサイズ20件（tableNameに関係なく適用） |
| GCSキャッシュ統合 | ✅ | tableNameパラメータで対応 |

### 結論

**追加の実装は不要です。** `searchLanceDB`関数は`tableName`パラメータでConfluence/Jiraを切り替え可能であり、すべての最適化が`tableName`に関係なく適用されています。

### 推奨事項

1. **品質テストの実施**: Jira検索の品質テストを実施し、最適化の影響を確認することを推奨します。
2. **パフォーマンステストの実施**: Jira検索のパフォーマンステストを実施し、改善効果を確認することを推奨します。

