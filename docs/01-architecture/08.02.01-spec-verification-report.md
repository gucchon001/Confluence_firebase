# 仕様書とコードの整合性確認レポート

**作成日**: 2025年1月27日  
**最終更新**: 2025年1月27日  
**確認範囲**: `docs/01-architecture/` 配下の仕様書とコードベースの照合

---

## 📋 目次

1. [確認結果サマリー](#1-確認結果サマリー)
2. [実行した修正](#2-実行した修正)
3. [不整合レポート](#3-不整合レポート)
4. [詳細確認結果](#4-詳細確認結果)
5. [推奨される追加修正](#5-推奨される追加修正)

---

## 1. 確認結果サマリー

| 項目 | 状態 | 詳細 |
|------|------|------|
| **RRF K値（60）** | ✅ 一致 | 仕様書と実装が一致 |
| **RRF重み配分** | ⚠️ 仕様書に記載不足 | 実装は正しいが、主要仕様書への明記が必要 |
| **ドメイン減衰** | ⚠️ 仕様書に記載不足 | 実装は一貫しているが、仕様書の記載が不足 |
| **ドメインブースト** | ⚠️ 仕様書に記載不足 | 実装は一貫しているが、仕様書の記載が不足 |
| **タグマッチングボーナス** | ⚠️ 仕様書に記載不足 | 実装は一貫しているが、仕様書の記載が不足 |
| **並列検索の実装** | ✅ 実装済み | 実装は適切だが、仕様書の記載が不足 |
| **キャッシュヒット率計測** | ⚠️ 未使用 | 実装されているが使用されていない |
| **キャッシュTTL** | ⚠️ 仕様書に不一致 | 実装は15分だが、仕様書に5分の記載が残っている |

---

## 2. 実行した修正

### 2.1 KG拡張の無効化を仕様書に明記 ✅

**修正内容**:
- `02.01.02-hybrid-search-specification.md`: KG拡張セクションに無効化ステータスを追記
- `README.md`: KG拡張の無効化を明記
- `02.01.01-hybrid-search-quick-reference.md`: KGの重みを削除

**修正箇所**:
- KG拡張セクションに「Phase 7で無効化済み」と記載
- 無効化理由（パフォーマンス悪化）を明記
- 将来計画（デュアルモード検索）への言及を追加

### 2.2 KG重みを削除して100%に再配分 ✅

**コード修正**:
- `src/lib/composite-scoring-service.ts`:
  - `kgWeight: 0.05` → `kgWeight: 0.00` に変更
  - BM25重み: 50% → 53%（+3%）
  - タイトル重み: 25% → 26%（+1%）
  - ラベル重み: 15% → 16%（+1%）
  - ベクトル重み: 5% → 5%（変更なし）

**重み配分**:
- **修正前**: BM25(50%) + タイトル(25%) + ラベル(15%) + ベクトル(5%) + KG(5%) = 100%
- **修正後**: BM25(53%) + タイトル(26%) + ラベル(16%) + ベクトル(5%) = 100%

**仕様書修正**:
- `02.01.02-hybrid-search-specification.md`: 重み配分を更新
- `README.md`: 検索コンポーネントの重みを更新
- `02.01.01-hybrid-search-quick-reference.md`: 複合スコア計算式を更新

### 2.3 タイトル救済検索の実装と仕様の一致確認 ✅

**確認結果**:
- **仕様書の記載**: 3語組み合わせまで生成
- **実装**: 2語組み合わせのみ（単一キーワードも追加）

**修正内容**:
- `02.01.02-hybrid-search-specification.md`: 実装に合わせて仕様書を更新
  - 3語組み合わせの生成を削除
  - 実装内容（2語組み合わせ + 単一キーワード）を記載
  - タイトル候補数の制限（最大10件）を明記

**実装の動作**:
- タイトル候補生成: `generateTitleCandidates` 関数で実装
- タイトルマッチング: `calculateTitleMatch` 関数でベクトル検索結果に対して実行
- スコアブースト: タイトルマッチ比率に応じてブースト（最低90%）

### 2.4 ラベルフィルタリングの実装確認 ✅

**実装状況**:

#### 議事録フィルタリング
- **関数**: `filterMeetingNotesByCategory`
- **実装場所**: `src/lib/lancedb-search-client.ts` (949-1010行目)
- **判定方法**:
  1. `structured_category = 'meeting'` で除外
  2. タイトルパターンマッチ（フォールバック）
- **タイトルパターン**:
  - `ミーティング議事録`
  - `会議議事録`
  - 日付形式 + `議事録`
  - `MTG議事録`
  - `meeting notes` (英語)

#### 非推奨ドキュメントフィルタリング
- **関数**: `filterDeprecatedDocuments`
- **実装場所**: `src/lib/lancedb-search-client.ts` (1012-1042行目)
- **判定方法**: `structured_status = 'deprecated'` で除外

#### アーカイブフィルタリング
- **実装**: `labelManager.buildExcludeLabels` で実装
- **除外ラベル**: `['archive', 'archived', 'アーカイブ']`

**仕様書との整合性**: ✅ 一致

### 2.5 キャッシュ戦略の確認 ✅

**実装状況**:

#### 検索結果キャッシュ
- **TTL**: 15分（900,000ms）
- **最大サイズ**: 5,000エントリー
- **実装場所**: `src/lib/hybrid-search-engine.ts`

#### タイトル検索キャッシュ
- **TTL**: 15分（900,000ms）
- **最大サイズ**: 1,000エントリー
- **実装場所**: `src/lib/lancedb-search-client.ts`

#### 回答キャッシュ
- **TTL**: 30分（1,800,000ms）
- **最大サイズ**: 100エントリー
- **実装場所**: `src/app/api/chat/route.ts`

#### キャッシュキー生成
- **検索結果**: `search:${query}:${filters}`
- **タイトル検索**: `title:${title}`
- **回答**: `answer:${query}:${contextHash}`

**仕様書との整合性**: ⚠️ 仕様書に5分の記載が残っている（実装は15分）

### 2.6 重複コードの確認 ✅

**確認結果**:
- 重複コードは見つからなかった
- 各関数は適切に分離されている

### 2.7 未使用コードの確認 ✅

**非推奨関数**:
- `searchByKeywords` (旧実装、現在は使用されていない)
- `searchByVector` (旧実装、現在は使用されていない)

**KG関連コード**:
- KG拡張ロジックは無効化されているが、コードは残っている（将来のデュアルモード検索用）

---

## 3. 不整合レポート

### 3.1 Knowledge Graph拡張の仕様記載

**不整合内容**:

**仕様書の記載**:
- `02.01.02-hybrid-search-specification.md` の311-365行目で、Knowledge Graph拡張の詳細が説明されている
- Phase 4の機能として、タイトル救済結果からのKG拡張ロジックが記載されている

**実装の状態**:
- コードではPhase 7でKG拡張が無効化されている
- `src/lib/lancedb-search-client.ts` の342-344行目:
  ```typescript
  // Phase 7最適化: KG拡張を無効化（9.2秒→0秒で大幅高速化）
  // KG拡張は高コスト・低効果のため一時的に無効化
  ```
- `src/lib/lancedb-search-client.ts` の731-736行目でもRRF-KG拡張が無効化されている

**README.mdの記載**:
- `01-architecture/README.md` の220-223行目で、KGは「🔴 無効化済み」と明記されている

**推奨対応**:
1. **KG拡張セクションに無効化ステータスを追記** ✅ 完了
   - Phase 7で無効化された旨を明記
   - 無効化理由（パフォーマンス悪化）を記載
   - 将来のデュアルモード検索計画への言及を追加

2. **アーキテクチャ図の更新**
   - KG拡張のフローを「無効化済み」として表示
   - または、将来計画として別セクションに移動

**影響範囲**:
- **低**: コードは正しく無効化されているため、機能への影響はなし
- **中**: 仕様書と実装の不整合により、開発者が混乱する可能性

### 3.2 Composite ScoringのKG重み

**不整合内容**:

**実装の状態**:
- `src/lib/composite-scoring-service.ts` の58行目で `kgWeight: 0.05` (5%) が設定されている
- Composite Scoringの計算式（99行目）では `kgContribution` が計算されている
- しかし、KG拡張が無効化されているため、`signals.kgBoost` は常に0になる

**仕様書の記載**:
- `02.01.02-hybrid-search-specification.md` の87-89行目:
  ```
  BM25(50%) + タイトル(25%) + ラベル(15%)
  + ベクトル(5%) + KG(5%) = 100%
  ```

**分析**:

**実際の動作**:
- KG拡張が無効化されているため、`kgBoost` は常に0
- その結果、実際の重み配分は:
  - BM25: 50%
  - タイトル: 25%
  - ラベル: 15%
  - ベクトル: 5%
  - **KG: 0%** (設定では5%だが、常に0)

**合計**: 95% (KG分が未使用)

**推奨対応**:
1. **コードの改善** ✅ 完了
   - KG拡張が無効化されている間は、KGの5%を他のコンポーネントに再配分
   - または、KG無効化時は重みを正規化（100%に調整）

2. **仕様書の更新** ✅ 完了
   - 現在の実装ではKGが無効化されているため、実際の重み合計は95%であることを明記
   - または、KG無効化時の重み再配分を説明

**影響範囲**:
- **低**: 機能には影響なし（KGが無効化されているため）
- **低**: 重み合計が95%になるが、相対的なランキングには影響なし

### 3.3 検索重み配分の説明

**不整合内容**:

**仕様書の記載**:
- `02.01.02-hybrid-search-specification.md` の87-89行目:
  ```
  BM25(50%) + タイトル(25%) + ラベル(15%)
  + ベクトル(5%) + KG(5%) = 100%
  ```

**実装の状態**:
- KG拡張が無効化されているため、実際の重み合計は95%

**推奨対応**:
1. **仕様書の更新** ✅ 完了
   - KG無効化時の重み再配分を明記
   - 実際の重み配分を更新

**影響範囲**:
- **低**: 機能への影響はなし
- **低**: 仕様書の説明が不明確

---

## 4. 詳細確認結果

### 4.1 RRF融合の詳細

#### RRF K値（60）

**確認結果**: ✅ **仕様書と実装が一致**

- **実装**: `rrfK: 60` が設定されている
- **仕様書**: K値60が記載されている
- **標準的な値**: 標準的なRRF実装で推奨される値

#### RRF重み配分

**確認結果**: ⚠️ **仕様書への明記が必要**

**実装の状態**:
- vector: 1.0（基本重み）
- keyword: 0.8（80%の重み）
- title-exact: 1.2（120%の重み、最重要）
- bm25: 0.6（60%の重み、補助的）

**仕様書の状態**:
- アーカイブドキュメントには記載があるが、主要な仕様書（`02.01.02-hybrid-search-specification.md`）への明記が必要

**修正内容**: ✅ **完了**
- `02.01.02-hybrid-search-specification.md` のRRF融合セクションに重みを明記

### 4.2 Composite Scoringの詳細

#### ドメイン減衰・ブーストロジック

**確認結果**: ⚠️ **仕様書への記載が必要**

**実装の状態**:

**ドメイン減衰**:
- 議事録・ペナルティラベル: 10%減衰（RRF段階のみ）
- 汎用文書: 50%減衰（両段階で適用、0.8 → 0.5に強化）
- 本システム外: 20%減衰（RRF段階のみ）

**ドメインブースト**:
- マッチしたキーワード数に応じてブースト: `1.0 + (matchingKeywordCount * 0.5)`
- 最大2倍までブースト
- 汎用文書には適用されない

**カテゴリ別の減衰・ブースト**:
- 機能クエリ時のspecカテゴリブースト: 50%ブースト（Composite Scoring段階のみ）
- templateカテゴリの減衰: 95%〜98%減衰（機能クエリ時、Composite Scoring段階のみ）
- deprecatedステータスの減衰: 95%減衰（Composite Scoring段階のみ）

**仕様書の状態**:
- 詳細な記載が不足している

**修正内容**: ✅ **完了**
- `02.01.02-hybrid-search-specification.md` にドメイン減衰・ブーストロジックの詳細を追加

#### タグマッチングボーナスの実装

**確認結果**: ⚠️ **仕様書への記載が必要**

**実装の状態**:

**RRF段階のタグマッチング**:
- 1つのタグマッチ: **2.0倍**
- 2つ以上のタグマッチ: **3.0倍**

**Composite Scoring段階のタグマッチング**:
- 1つのタグマッチ: **3.0倍**
- 2つ以上のタグマッチ: **6.0倍**（より強力）

**タグマッチングロジック**:
- `structured_tags` とクエリキーワードの一致を確認
- 部分一致も含む（`tag.includes(keyword)` または `keyword.includes(tag)`）
- 重複タグはSetを使用して排除

**仕様書の状態**:
- 詳細な記載が不足している

**修正内容**: ✅ **完了**
- `02.01.02-hybrid-search-specification.md` にタグマッチングボーナスの詳細を追加

### 4.3 パフォーマンス最適化

#### 並列検索の実装

**確認結果**: ✅ **実装済み**

**実装の状態**:
- ベクトル検索とBM25検索を並列実行
- `Promise.all` を使用して並列化
- タイムアウト処理を実装

**仕様書の状態**:
- 仕様書の記載が不足している

**修正内容**: ✅ **完了**
- `02.01.02-hybrid-search-specification.md` に並列検索の実装を追加

#### キャッシュヒット率の計測

**確認結果**: ⚠️ **未使用**

**実装の状態**:
- キャッシュヒット率の計測機能は実装されている
- しかし、実際には使用されていない

**推奨対応**:
- キャッシュヒット率の計測を有効化
- または、未使用コードとして削除

#### キャッシュTTLの不一致

**確認結果**: ⚠️ **仕様書に不一致**

**実装の状態**:
- 検索結果キャッシュ: 15分（900,000ms）
- タイトル検索キャッシュ: 15分（900,000ms）
- 回答キャッシュ: 30分（1,800,000ms）

**仕様書の状態**:
- 仕様書に5分の記載が残っている

**修正内容**: ✅ **完了**
- `02.01.02-hybrid-search-specification.md` のキャッシュTTLを15分に更新

---

## 5. 推奨される追加修正

### 優先度: 高（必須）

1. **アーキテクチャ図の更新**
   - KG拡張のフローを「無効化済み」として表示
   - または、将来計画として別セクションに移動

### 優先度: 中（推奨）

1. **キャッシュヒット率の計測**
   - キャッシュヒット率の計測を有効化
   - または、未使用コードとして削除

2. **未使用コードの削除**
   - 非推奨関数の削除
   - または、明確に非推奨としてマーク

### 優先度: 低（任意）

1. **ドキュメントの整理**
   - アーカイブドキュメントの整理
   - 重複ドキュメントの統合

---

## 📊 最終確認結果

### ✅ 整合性が確認された項目

1. RRF K値（60）
2. ラベルフィルタリングの実装
3. 並列検索の実装
4. 重複コードの確認
5. 未使用コードの確認

### ⚠️ 改善が必要な項目

1. RRF重み配分の仕様書への明記 ✅ 完了
2. ドメイン減衰・ブーストロジックの仕様書への記載 ✅ 完了
3. タグマッチングボーナスの仕様書への記載 ✅ 完了
4. キャッシュTTLの仕様書への更新 ✅ 完了
5. キャッシュヒット率の計測（未使用）

---

## ✅ 修正完了事項

1. ✅ KG拡張の無効化を仕様書に明記
2. ✅ KG重みを削除して100%に再配分
3. ✅ タイトル救済検索の実装と仕様の一致確認
4. ✅ ラベルフィルタリングの実装確認
5. ✅ キャッシュ戦略の確認
6. ✅ 重複コードの確認
7. ✅ 未使用コードの確認
8. ✅ RRF重み配分の仕様書への明記
9. ✅ ドメイン減衰・ブーストロジックの仕様書への記載
10. ✅ タグマッチングボーナスの仕様書への記載
11. ✅ キャッシュTTLの仕様書への更新

---

**注意**: このドキュメントは、2025年1月27日の仕様検証結果を統合したものです。詳細な分析結果は、アーカイブフォルダ（`docs/99-archive/architecture/spec-verification/`）を参照してください。


