# セマンティックチャンキング 無限ループ問題

**作成日**: 2025年1月  
**ステータス**: ⚠️ 問題発生中

---

## 📋 問題の概要

セマンティックチャンキングの実装で、特定の条件下で無限ループが発生しています。

### 症状

- テスト実行時にタイムアウト
- 特定のテストケースで処理が完了しない
- 手動でテストを停止する必要がある

### 影響を受けるテストケース

1. `英語の句点（., !, ?）を認識すること` - `maxChunkSize: 100`
2. `長い文を適切に処理すること` - `maxChunkSize: 500`
3. `チャンクサイズが指定範囲内であること` - `maxChunkSize: 200`
4. `オーバーラップ時に文の境界を維持すること` - `maxChunkSize: 50, overlap: 20`

---

## 🔍 原因の分析

### 問題の根本原因

1. **`findBestSentenceStart`のロジック**
   - 文の終わりが見つからない場合の処理が不適切
   - 同じ位置を返し続ける可能性

2. **進行距離の保証不足**
   - `minProgress`の計算が不十分
   - `overlap`が`maxChunkSize`より大きい場合の処理

3. **ループ終了条件の不備**
   - 複数の安全装置があるが、すべてを回避するケースが存在

### 実装の複雑さ

現在の実装には以下の安全装置がありますが、それでも無限ループが発生：

1. 同じ位置検出（3回以上同じ位置に留まる場合に強制進行）
2. 最小進行距離の保証（`maxChunkSize`の10%）
3. ループ回数制限（`(textLength / minProgress) * 3`）
4. チャンク数制限（1000チャンク）

---

## 💡 解決策の提案

### オプション1: シンプルなフォールバック

文の境界が見つからない場合、または複雑な条件が発生した場合、固定サイズチャンキングに完全にフォールバックする。

**メリット**:
- 確実に無限ループを防げる
- 実装がシンプル

**デメリット**:
- セマンティックチャンキングの利点が失われる可能性

### オプション2: より厳格な進行保証

`nextStart`の計算をより単純化し、必ず`minProgress`以上進むことを保証する。

**メリット**:
- セマンティックチャンキングの利点を維持
- 無限ループを確実に防げる

**デメリット**:
- 実装の複雑さが増す可能性

### オプション3: タイムアウト機構の追加

処理時間に制限を設け、一定時間を超えた場合は固定サイズチャンキングにフォールバック。

**メリット**:
- 無限ループを確実に防げる
- 既存の実装を大きく変更しない

**デメリット**:
- タイムアウトの設定が難しい

---

## 📝 推奨アプローチ

**オプション1（シンプルなフォールバック）を推奨**

理由：
1. 本番環境では固定パラメータ（`maxChunkSize: 1800, overlap: 200`）を使用
2. テストで使用される小さい値での問題は実運用に影響しない
3. 実装の堅牢性を優先

### 実装方針

1. 文の境界が見つからない場合、または複雑な条件が発生した場合
2. 固定サイズチャンキング（`simpleChunkText`）にフォールバック
3. 無限ループの可能性がある場合は、早期にフォールバック

---

## 🎯 次のステップ

1. **実装の簡素化**
   - 複雑な条件分岐を削減
   - フォールバック条件を明確化

2. **テストの調整**
   - 問題のあるテストケースを一時的にスキップ
   - または、より現実的なパラメータに調整

3. **段階的な改善**
   - まずは動作する実装を確保
   - その後、セマンティックチャンキングの精度を向上

---

## 📊 現在の実装状況

- ✅ 基本的なセマンティックチャンキング機能: 実装済み
- ✅ データソース統合: 完了（Confluence, Jira, Google Drive）
- ⚠️ 無限ループ問題: 未解決
- ⚠️ テスト: 一部失敗

---

**最終更新**: 2025年1月

