# LanceDBスキーマエラー修正サマリー

**作成日**: 2025-01-28  
**問題**: `Found field not in schema: space_key at row 0`  
**発生箇所**: **Confluenceテーブルのみ**（Jiraテーブルには問題なし）

## 問題の原因

### Confluenceテーブルのスキーマ不一致

1. **既存テーブルのスキーマ**:
   - `spaceKey` (キャメルケース) が存在
   - `space_key` (スネークケース) が存在しない
   - `url` フィールドが存在しない

2. **新しいスキーマ定義**:
   - `lancedb-schema-extended.ts`: `spaceKey` → `space_key` に変更
   - `url` フィールドを追加
   - 実際のデータ書き込み: `space_key` (スネークケース) を使用
   - `lancedb-client.ts`: テーブル作成時に`space_key`を使用

3. **Jiraテーブル**:
   - `space_key`も`spaceKey`も存在しない（Jiraには不要）
   - `url` フィールドは存在
   - **問題なし**

## 修正内容

### 1. スキーマ定義の修正 (`src/lib/lancedb-schema-extended.ts`)

```typescript
// 修正前
new arrow.Field('spaceKey', new arrow.Utf8(), false),  // スペースキー

// 修正後
new arrow.Field('space_key', new arrow.Utf8(), false),  // スペースキー（スネークケースで統一）
new arrow.Field('url', new arrow.Utf8(), false),       // ページURL
```

### 2. 型定義の修正 (`src/lib/lancedb-schema-extended.ts`)

```typescript
// 修正前
spaceKey: string;

// 修正後
space_key: string;  // スネークケースで統一（ドキュメントと一致）
url: string;        // ページURL
```

## 既存テーブルの対応

**重要**: この問題は**Confluenceテーブルのみ**に発生します。Jiraテーブルには問題ありません。

既存のConfluenceテーブルが古いスキーマ（`spaceKey`、`url`なし）で作成されている場合、以下のいずれかの方法で対応が必要です：

### 方法1: 完全再構築スクリプトを使用（推奨）

```bash
# Confluence完全再構築（Confluenceテーブルのみ再作成）
npm run sync:confluence:rebuild

# Jiraは問題ないため、通常の同期でOK
npm run sync:jira
```

### 方法2: テーブルを手動で再作成

1. 既存データをバックアップ
2. テーブルを削除
3. 新しいスキーマでテーブルを再作成
4. データを復元

## 本番環境での対応

### バッチ処理でのデグレード防止

1. **完全再構築スクリプトを使用**:
   - `scripts/sync-confluence-full-rebuild.ts`
   - `scripts/sync-jira-full-rebuild.ts`
   - これらのスクリプトは、スキーマ定義とデータ書き込みの整合性を保証します

2. **スキーマ定義の確認**:
   - `src/lib/lancedb-schema-extended.ts`のスキーマ定義
   - `src/lib/lancedb-client.ts`のテーブル作成時のデータ構造
   - `src/lib/confluence-sync-service.ts`のデータ書き込み時のフィールド名

3. **テスト実行**:
   - 本番環境にデプロイする前に、ローカル環境で完全再構築スクリプトを実行
   - スキーマエラーが発生しないことを確認

## 確認事項

- [x] スキーマ定義を`space_key`に統一
- [x] `url`フィールドをスキーマ定義に追加
- [x] 型定義をスキーマ定義と一致させる
- [x] エラー発生箇所を特定（Confluenceテーブルのみ）
- [x] `space_key`の値が全て`"CLIENTTOMO"`であることを確認
- [x] **スキーマ互換性処理を実装**（既存テーブルと新規テーブルの両方に対応）
- [x] Confluenceテーブルの再作成（完全再構築スクリプト実行）
- [x] Jiraテーブルの再作成（完全再構築スクリプト実行）
- [x] ローカル環境での動作確認
- [ ] 本番環境での動作確認（次回デプロイ時に実施予定）

## 実装した修正内容

### スキーマ互換性処理の追加

`confluence-sync-service.ts`に既存テーブルのスキーマを自動検出し、互換性を確保する処理を追加しました：

1. **スキーマキャッシュ**: 既存テーブルのスキーマ情報をキャッシュしてパフォーマンスを最適化
2. **自動検出**: `spaceKey`/`space_key`、`url`、`isChunked`、`totalChunks`の存在を自動検出
3. **互換性確保**: 既存テーブルのスキーマに合わせてデータを書き込み

これにより、既存テーブル（`spaceKey`、`url`なし、`isChunked`/`totalChunks`なし）と新規テーブル（`space_key`、`url`あり、`isChunked`/`totalChunks`あり）の両方に対応可能になりました。

## 補足情報

### `space_key`の値について

- **現在の値**: 全てのページが`"CLIENTTOMO"`（単一スペースのみ使用）
- **環境変数**: `CONFLUENCE_SPACE_KEY=CLIENTTOMO`として設定
- **将来的な最適化**: 全て同じ値のため、以下の最適化が可能：
  - `space_key`をオプショナル（nullable）にする
  - デフォルト値として`"CLIENTTOMO"`を使用
  - ただし、現在はスキーマエラー修正が優先

## テーブル別の状態

| テーブル | `space_key` | `spaceKey` | `url` | `page_id` | 状態 |
|---------|------------|-----------|------|-----------|------|
| **confluence** | ❌ 存在しない | ✅ 存在 | ❌ 存在しない | ✅ 存在 | **エラー発生** |
| **jira_issues** | ❌ 不要 | ❌ 不要 | ✅ 存在 | ❌ 不要 | **問題なし** |

### `page_id`について

**`page_id`は問題ありません**。以下の理由から：

1. **スキーマ定義**: `new arrow.Field('page_id', new arrow.Int64(), false)` として正しく定義されている
2. **実際のテーブル**: Confluenceテーブルに`page_id`が存在している
3. **データ書き込み**: `confluence-sync-service.ts`で`page_id`を正しく使用している

## `spaceKey`と`page_id`の違い

### `space_key`（スペースキー）

- **型**: `string` (Utf8)
- **用途**: Confluenceスペースの識別子
- **例**: `"CLIENTTOMO"`
- **説明**: Confluenceのスペース（ワークスペース）を識別するためのキー
- **現在の値**: 全てのページが`"CLIENTTOMO"`（単一スペースのみ使用）
- **URL構築**: `space_key`がある場合は完全なURL形式を使用
  - 例: `https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/123456789`
- **注意**: 現在は全て同じ値のため、将来的にオプショナル化やデフォルト値の使用を検討可能

### `page_id`（ページID）

- **型**: `number` (Int64)
- **用途**: Confluenceページの一意識別子
- **例**: `123456789`
- **説明**: Confluenceの個別ページを識別するための数値ID
- **インデックス**: スカラーインデックスが作成され、高速なクエリが可能（平均5ms）
- **URL構築**: `page_id`だけでURLを構築可能（`space_key`はオプション）
  - 例: `https://giginc.atlassian.net/wiki/pages/viewpage.action?pageId=123456789`

### 関係性

- **1つのスペース**に**複数のページ**が存在する
- `space_key`はページが属するスペースを表す
- `page_id`は個別のページを表す
- 両方を使用することで、より正確なURL構築が可能

## 関連ドキュメント

- [完全再構築スクリプト運用ガイド](../04-operations/04.19-full-rebuild-scripts-guide.md)
- [データ同期戦略](../04-operations/04.03-data-synchronization-strategy.md)
- [LanceDB拡張スキーマ運用ガイド](../04-operations/04.05-extended-schema-operation-guide.md)

