# 実装・テスト計画: Confluence仕様書要約チャットボット

## 1. 概要

本ドキュメントは、現在の実装状況を踏まえ、残りの機能を実装・テストする順序と計画を定義します。
実装の優先順位、依存関係、テスト方法を明確にし、スムーズな開発進行を目指します。

**最終更新**: 2024-12月（Vector Search実装を優先する方針に基づいて再編成）

## 2. 実装順序と計画

### フェーズ1: プロンプトテンプレート処理の修正（優先度: 最高）✅ 完了

**目的**: ユーザーに正しい回答を表示するための基本機能を修復する

**実施内容**:
1. **Handlebarsテンプレート処理の修正** ✅
   - `summarize-confluence-docs.ts`にHandlebarsライブラリを導入
   - テンプレートをコンパイルしてから使用するよう修正
   - プロンプトが正しくレンダリングされることを確認

**結果**:
- テンプレート構文がユーザーに表示されなくなった
- AIの回答が正しくフォーマットされて表示されるようになった
- UIの問題（入力フィールドの非活性化、初期画面の不具合）も修正済み

### フェーズ2: Firestore実装（優先度: 最高）✅ **完了**

**目的**: 会話履歴を永続化し、ユーザーがセッションをまたいで会話を継続できるようにする

**タスク**:
1. **Firebase ConsoleでのFirestore有効化** (0.5日) ✅
   - Firebase ConsoleでFirestoreを有効化
   - 日本リージョン（asia-northeast1）で作成
   - セキュリティルールの設定

2. **Firestoreデータモデルの実装** (1日) ✅
   - `firestore-design.md`に基づいたデータ構造の実装
   - 現在コメントアウトされているコードの復活
   - ユーザー情報と会話履歴の保存機能

3. **会話履歴UIの連携** (0.5日) ✅
   - 既存のサイドバーの会話履歴UIとFirestoreの連携
   - 会話の読み込み・保存機能の実装
   - セッション管理の実装

4. **データ移行機能の実装** (0.5日) ✅
   - 既存のchatsコレクションから新しいusers/{userId}/conversations/{conversationId}構造への移行機能
   - 設定画面からワンクリックで移行可能な機能
   - 移行ステータスの保存と表示

**テスト方法**:
- **テスト種別**: コンソールテスト + 画面テスト
- **テスト環境**: ローカル開発環境（Firestore Emulatorを初期テストに使用）
- **テストデータ**: テスト用会話データ（5往復程度の会話）
- **テストシナリオ**:
  1. 認証エラーの解消確認（400エラーが発生しないこと）
  2. 会話履歴の保存テスト（新規会話の作成と保存）
  3. 会話履歴の読み込みテスト（ブラウザ再読み込み後の状態確認）
  4. 複数ユーザーでのアクセス制御テスト（異なるアカウントでのアクセス試行）
  5. サイドバーの会話履歴一覧の動作確認

**成功基準**:
- Firestore認証エラー（400エラー）が解消されること ✅
- 会話履歴がFirestoreに正しく保存されること（データ構造が設計通りであること） ✅
- セッションをまたいで会話履歴が完全に読み込まれること（5往復すべてが復元される） ✅
- 他ユーザーの会話履歴にアクセスできないこと（セキュリティルールが正しく機能する） ✅
- サイドバーに会話履歴が正しく表示され、切り替えが可能なこと ✅
- データ移行機能が正常に動作し、既存の会話履歴が新構造に移行されること ✅

### フェーズ3: Vector Search検索実装（優先度: 高）✅ **完了**

**目的**: モックデータではなく、実際のConfluenceデータに基づいた回答を提供する

**タスク**:
1. **Vector Search APIクライアントの実装** (1日) ✅
   - `vector-search-client.ts`の実装
   - `featureVector`フィールドの使用（`embedding`ではなく）
   - エラーハンドリングの強化
   - メタデータフィルタリング（スペースキー、ラベル）の実装

2. **検索パラメータの最適化** (1日) ✅
   - 近傍数（`neighborCount`）を20に設定
   - 距離閾値（`distanceThreshold`）を0.0に設定
   - Firestoreからのメタデータ取得処理の実装

3. **GCSとFirestoreの連携** (1日) ✅
   - Vector Search用JSONファイルのGCS保存
   - 検索結果表示用メタデータのFirestore保存
   - データフローの最適化

**テスト方法**:
- **テスト種別**: コンソールテスト（ログ出力確認）+ 画面テスト
- **テスト環境**: ローカル開発環境
- **テストデータ**: 実データ（Vector Search上の実際のConfluenceデータ）
- **テストシナリオ**:
  1. 特定キーワードを含む質問（「トモノカイ 仕様」など、確実に結果が得られる質問）
  2. 複数の文書に関連する質問（「プロジェクトの課題」など）
  3. エラーケース（接続エラー、認証エラーなど）
  4. ラベルフィルタリングテスト（特定のラベルを持つページのみを検索）

**成功基準**:
- Vector Searchから関連ドキュメントが正しく取得されること（コンソールログで確認） ✅
- 検索結果が質問に関連していること（上位3件中に関連文書が1件以上含まれる） ✅
- エラー時に適切なフォールバックが行われること ✅
- Firestoreからメタデータが正しく取得されること ✅

### フェーズ4: プロンプトチューニング（優先度: 中）← **次の実装対象**

**目的**: AIの回答品質を向上させる

**タスク**:
1. **プロンプトの最適化** (1日)
   - 現在のプロンプトの分析と改善
   - システムプロンプトとユーザープロンプトの調整
   - コンテキスト活用の最適化
   - ラベル情報の活用

2. **RAG評価テストの実施** (1日)
   - 忠実性、関連性、完全性などの評価
   - テスト結果に基づく追加改善
   - 標準的な質問セットの作成と評価

**テスト方法**:
- **テスト種別**: 画面テスト + 品質評価
- **テスト環境**: ローカル開発環境またはステージング環境
- **テストデータ**: 標準的な質問セット（20問程度、様々な難易度・分野を含む）
- **テストシナリオ**:
  1. 基本的な情報取得質問（「プロジェクトXの概要は？」など）
  2. 複雑な分析質問（「プロジェクトXとYの違いを分析して」など）
  3. 要約質問（「この仕様書の要点をまとめて」など）
  4. エッジケース（非常に専門的な質問、曖昧な質問など）

**成功基準**:
- RAG評価テストで以下の指標を達成：
  - 忠実性（Faithfulness）: 4.0/5.0以上（事実の正確さ）
  - 関連性（Relevance）: 4.0/5.0以上（質問との関連度）
  - 情報量（Informativeness）: 3.5/5.0以上（回答の充実度）
  - 一貫性（Coherence）: 4.0/5.0以上（回答の論理的一貫性）
- 標準質問セットの80%以上で「適切」と評価される回答が提供されること

### フェーズ5: システムテスト（優先度: 低）

**目的**: すべての機能が連携して正しく動作することを確認する

**タスク**:
1. **統合テストの実施** (1日)
   - すべての機能を連携させたテスト
   - エンドツーエンドのユーザーシナリオテスト
   - 複数ユーザーの同時アクセステスト

2. **パフォーマンステスト** (0.5日)
   - 応答時間の測定
   - 負荷テスト（必要に応じて）
   - メモリ使用量の監視

3. **セキュリティテスト** (0.5日)
   - 認証・認可のテスト
   - データアクセス制御のテスト
   - APIエンドポイントのセキュリティ確認

**テスト方法**:
- **テスト種別**: 統合テスト + 画面テスト + パフォーマンステスト
- **テスト環境**: ステージング環境（本番相当）
- **テストデータ**: 実データ（本番と同等のデータセット）
- **テストシナリオ**:
  1. エンドツーエンドのユーザーシナリオ（ログイン→質問→回答→会話継続→ログアウト）
  2. 複数ユーザーの同時アクセスシナリオ（5ユーザー程度の同時利用）
  3. エラーケース（ネットワーク切断、API制限到達、不正なリクエストなど）
  4. 長時間利用シナリオ（30分以上の連続利用）

**成功基準**:
- すべてのユーザーシナリオが正常に完了すること（成功率95%以上）
- エラー発生時に適切なエラーメッセージが表示され、リカバリー手段が提供されること
- パフォーマンス指標が以下を満たすこと：
  - 初回応答時間: 3秒以内
  - 質問応答時間: 平均5秒以内（複雑な質問でも最大10秒以内）
  - CPU/メモリ使用率: ピーク時でも80%以下
- 24時間の連続運用テストで障害が発生しないこと

## 3. 環境切り替え計画

各フェーズの実装・テスト後、以下の順序で環境を切り替えていきます：

### 1. ローカル開発環境での切り替え

1. **プロンプトテンプレート処理の修正**
   - ローカル環境で修正・テスト
   - **テスト基準**: 画面上でテンプレート構文が表示されず、基本的な質問に回答できること
   - **合格基準**: 基本シナリオ3件すべてで正しく表示されること
   - 正常動作確認後、次のステップへ

2. **Firestore実装**
   - Firestore Emulatorを使用したローカルテスト（`firebase emulators:start --only firestore`）
   - **テスト基準**: 会話履歴の保存・読み込みが画面上で確認できること
   - **合格基準**: 5往復の会話がすべて保存・復元できること
   - 実装完了後、本番Firestoreへの切り替え

3. **Vector Search検索実装**
   - 開発環境フラグを導入（`.env.local`に`NEXT_PUBLIC_USE_MOCK_DATA=false`など）
   - ローカルでモックとVector Searchを切り替えられるように実装
   - **テスト基準**: コンソールログでVector Search APIの呼び出しと結果取得を確認
   - **合格基準**: 特定キーワードテスト5件中4件以上で関連文書が取得できること
   - 両方のモードでテスト（フラグON/OFF切り替えで動作確認）

### 2. ステージング環境への展開

1. **ステージング環境のセットアップ**
   - Firebase Hostingのプレビューチャネルを使用（`firebase hosting:channel:deploy staging`）
   - 本番と同じ環境変数を設定（Firebaseプロジェクト設定から）
   - **テスト基準**: ステージングURLにアクセスしてアプリが表示されること

2. **機能テスト**
   - すべての機能を統合テスト（認証→検索→会話履歴の一連の流れ）
   - エラーケースのテスト（オフライン状態、タイムアウトなど）
   - **テスト基準**: エンドツーエンドの全フローが正常に完了すること
   - **合格基準**: 10回の質問・回答セッションがすべて正常完了すること

3. **ユーザー受け入れテスト**
   - 限定ユーザー（3名程度）によるテスト
   - フィードバックの収集と修正
   - **テスト基準**: 実際の業務シナリオに基づいた質問と回答
   - **合格基準**: ユーザーの満足度評価4点以上（5点満点）

### 3. 本番環境への展開

1. **段階的デプロイ**
   - まずプロンプトテンプレート処理の修正をデプロイ（`firebase deploy --only hosting`）
   - 次にFirestore実装をデプロイ（セキュリティルール含む）
   - 最後にVector Search検索実装をデプロイ（フラグ制御で切り替え可能に）
   - **テスト基準**: 各デプロイ後に本番環境での動作確認
   - **合格基準**: 各機能がステージング環境と同等に動作すること

2. **モニタリング**
   - エラーログの監視（Firebase Logging, Google Cloud Logging）
   - パフォーマンスの監視（Firebase Performance Monitoring）
   - ユーザーフィードバックの収集（アプリ内フィードバックフォームを設置）
   - **テスト基準**: デプロイ後24時間のログ監視
   - **合格基準**: 重大なエラーが発生しないこと（Errorレベルのログが0）

3. **ロールバック計画**
   - 各デプロイ後に問題が発生した場合のロールバック手順
   - 前バージョンへの切り替え方法（`firebase hosting:clone`を使用）
   - **テスト基準**: ロールバックシミュレーションの実施
   - **合格基準**: 15分以内に前バージョンに復旧できること

## 4. タイムライン（更新版）

| フェーズ | 作業内容 | 期間 | 状態 | 開始日 | 終了日 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | プロンプトテンプレート処理の修正 | 1日 | ✅ 完了 | Day 1 | Day 1 |
| 2 | Firestore実装 | 2日 | ✅ 完了 | Day 2 | Day 3 |
| 2.5 | データ移行機能実装 | 1日 | ✅ 完了 | Day 3 | Day 3 |
| 3 | Vector Search検索実装 | 2日 | ✅ 完了 | Day 4 | Day 5 |
| 4 | プロンプトチューニング | 2日 | 🚀 次の実装 | Day 6 | Day 7 |
| 5 | システムテスト | 2日 | ⏳ 待機中 | Day 8 | Day 9 |
| - | ステージング環境テスト | 1日 | ⏳ 待機中 | Day 10 | Day 10 |
| - | 本番環境デプロイ | 1日 | ⏳ 待機中 | Day 11 | Day 11 |

## 5. リスクと対策

| リスク | 影響度 | 発生可能性 | 対策 |
| :--- | :--- | :--- | :--- |
| テンプレート処理の修正が複雑 | 高 | ✅ 解決済み | Handlebarsライブラリ導入により解決 |
| Firestore認証エラー | 高 | ✅ 解決済み | Firebase Authenticationとの連携確認、セキュリティルールの適切な設定 |
| Vector Search APIのフィールド名不一致 | 高 | ✅ 解決済み | `featureVector`フィールド名の統一、キャメルケースの使用 |
| Firestore設計の不備 | 中 | ✅ 解決済み | 小規模なプロトタイプでの検証、段階的な実装 |
| 本番デプロイ時の問題 | 高 | 中 | 詳細なデプロイ手順の作成、ロールバック計画の準備 |
| GCSとFirestoreの連携不具合 | 中 | 低 | 明確なデータフローの設計、エラーハンドリングの強化 |

## 6. 実装方針の変更理由

### Vector Search実装を優先する理由：

1. **実データに基づく回答の提供**
   - モックデータではなく実際のConfluenceデータを使用することで回答品質が向上
   - ユーザー体験の大幅な改善が期待できる

2. **Firestoreとの連携による効率化**
   - 既に実装済みのFirestoreを活用して検索結果メタデータを効率的に管理
   - GCSとFirestoreの役割分担による最適なデータフロー

3. **ラベル情報の活用**
   - Confluenceのラベル情報をメタデータフィルタリングに活用
   - より関連性の高い検索結果の提供が可能に

4. **フィールド名の統一**
   - `featureVector`フィールド名の統一によるAPIエラーの解消
   - キャメルケースの一貫した使用による安定した実装

## 7. 結論

この更新された実装・テスト計画では、以下の成果を達成しました：

- プロンプトテンプレート処理の修正による基本機能の修復 ✅
- Firestore実装による会話履歴の永続化と認証エラーの解消 ✅
- Vector Search実装による実データに基づいた高品質な回答の提供 ✅

次に、プロンプトチューニングでAIの回答品質を最適化し、最終的にシステムテストで全体の安定性を確保します。GCSとFirestoreの連携による効率的なデータフローが確立され、ユーザー体験の大幅な向上が期待できます。