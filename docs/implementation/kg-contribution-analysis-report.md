# Knowledge Graph 貢献度分析レポート

**作成日**: 2025年10月15日  
**Phase**: Phase 0A-2  
**ステータス**: **KG拡張の無効化を推奨**

---

## 📊 調査結果

### KG構築状況

```
✅ KGは正常に構築されている:
   総ノード数: 679件
   総エッジ数: 24,208件
   平均次数: 35.65本/ノード
```

### 検索結果とKGの関係

```
❌ Top 10の検索結果にKGノード: 0/10件 (0.0%)
   潜在的エッジ数: 0本
   
全6事例で一貫して:
   - KGノード数: 0/10件
   - 潜在的エッジ数: 0本
   - 拡張可能性: なし
```

---

## 🕵️ 問題の分析

### 矛盾点

| 項目 | KG統計 | 検索結果 | 結論 |
|------|--------|---------|------|
| **ノード数** | 679件 | Top 10に0件 | ❌ **不一致** |
| **エッジ数** | 24,208本 | 潜在的0本 | ❌ **不一致** |
| **KG拡張処理** | - | 12ノード、5エッジを走査 | ⚠️ **動作はしている** |

### 考えられる原因

1. **KGノードと検索結果のpageIDが一致していない**
   - KGノードのID: Confluenceの生pageId（数値）
   - 検索結果のpageId: LanceDBのID形式（文字列、チャンク付き）

2. **検索結果のページがKGの対象外**
   - KG構築対象: 特定のページのみ（例: 仕様書のみ）
   - 検索結果: 全ページ（仕様書、議事録、テンプレートなど）

3. **KG拡張ロジックの問題**
   - KG拡張は動作しているが、検索結果に含まれていない

---

## 💰 コスト分析

### 現在のKGコスト

```
平均パフォーマンス（Phase 0A-2）:
   KG拡張時間: 7,183.5ms
   合計時間: 8,550.3ms
   KGオーバーヘッド: 84.0%
```

**KGが合計時間の84%を占めている！**

### KG無効化時の予想

```
予想パフォーマンス（KG無効化後）:
   検索時間: 1,140ms（変わらず）
   チャンク統合: 109ms（変わらず）
   フィルタリング: 118ms（変わらず）
   KG拡張: 0ms（-7,184ms 削減！）
   合計時間: 約1,367ms（-84%削減！）
```

**期待効果**: 合計時間を **8,550ms → 1,367ms（-84%削減）** 🔥

---

## 🎯 推奨アクション

### 優先度1: KG拡張の一時的無効化 ⚡ **最優先**

**理由**:
1. Top 10にKGノードが0件 = 貢献していない
2. 84%のオーバーヘッド = 非常に高コスト
3. 発見率83%はKGなしで達成

**実装**:
```typescript
// scripts/performance-test-phase-0a-2.ts

// Before:
const expandedResults = await expandWithKnowledgeGraph(
  filtered.slice(0, 8),
  kgMetrics
);

// After: 一時的にコメントアウト
// const expandedResults = filtered; // KG拡張を無効化
```

**期待効果**:
- 合計時間: -84%削減（8,550ms → 1,367ms）
- 発見率への影響: 0%（KGがTop 10に貢献していないため）

---

### 優先度2: KG構築対象の調査

**調査項目**:
1. KGノードのpageId形式を確認
2. 検索結果とKGノードのID一致率を測定
3. KG構築対象のページカテゴリを確認

**スクリプト**:
```bash
npm run kg:check-coverage
```

---

### 優先度3: KG拡張ロジックの改善（長期）

**現状の問題**:
- KG拡張が検索結果と無関係なページを追加している可能性
- エッジの選択基準が不適切

**改善案**:
1. 検索結果のTop 10に限定してKG拡張
2. エッジの信頼度（confidence）でフィルタリング
3. 関連性スコアの閾値を設定

---

## 📋 次のステップ

### ステップ1: KG拡張を無効化してテスト

```bash
# 1. パフォーマンステストスクリプトを修正（KG拡張をコメントアウト）
# 2. パフォーマンステストを実行
npm run perf:test

# 3. 結果を比較
#    - 合計時間の変化
#    - 発見率への影響
```

### ステップ2: 結果に基づいて判断

**If 発見率が維持される**:
→ KG拡張を完全に削除（84%のオーバーヘッド削減）

**If 発見率が低下する**:
→ KG拡張ロジックを改善（対象を絞る、閾値を設定）

---

## 💡 結論

### 現状の問題

1. **KGは構築されているが、検索結果に貢献していない**
2. **84%の高いオーバーヘッド**で合計時間を大幅に増加
3. **Top 10の検索結果にKGノードが0件**

### 推奨アクション

✅ **KG拡張を一時的に無効化**
- 期待効果: 合計時間 -84%削減
- リスク: 低（現在貢献していないため）

✅ **パフォーマンステストで効果を測定**
- 発見率への影響を確認
- 合計時間の改善を検証

⚠️ **長期的にはKG拡張ロジックの改善を検討**
- 検索結果とKGノードの一致率向上
- エッジ選択基準の最適化

---

**次のアクション**: KG拡張を無効化して、パフォーマンステストを再実行することを強く推奨します。

