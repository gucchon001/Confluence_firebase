# Phase 0A-4 vs 最新設定（Phase 0A-2改善）比較結果

## 実施日時
2025年10月16日

## 比較目的
Phase 0A-4設定（「1位が多く取得できていた時」の設定）と最新設定を比較し、どちらが優れているか検証する。

## 設定比較

| パラメータ | Phase 0A-4設定 | 最新設定（Phase 0A-2改善） | 差分 |
|-----------|----------------|------------------------|------|
| vectorWeight | 30% (0.30) | 5% (0.05) | -25% |
| bm25Weight | 40% (0.40) | 50% (0.50) | +10% |
| titleWeight | 20% (0.20) | 25% (0.25) | +5% |
| labelWeight | 10% (0.10) | 15% (0.15) | +5% |
| kgWeight | 0% (0.00) | 5% (0.05) | +5% |
| maxBm25Score | 10.0 | 30.0 | +20.0 |
| kwCap | 50 | 100 | +50 |

## パフォーマンス比較

### Gemini品質テスト結果

| 指標 | Phase 0A-4設定 | 最新設定 | 改善率 |
|------|----------------|----------|--------|
| **品質スコア** | 6.0/10.0 | **6.7/10.0** | **+11.7%** ✅ |
| **721ページ順位** | #14 | **#2** | **+12位** ✅ |
| **検索時間** | 8,398ms | **2,110ms** | **-74.9%** ⚡ |
| **Gemini応答時間** | 7,830ms | 3,903ms | -50.2% |
| **総合時間** | 23,060ms | **17,779ms** | **-22.9%** ⚡ |
| **発見率** | 100% (6/6) | 100% (6/6) | 変化なし |

### Top 3結果比較

#### Phase 0A-4設定
1. 014_【FIX】求人応募機能 (Composite: 0.7812)
2. 【作成中】応募完了メール（クライアント企業管理者向け） (Composite: 0.7180)
3. 契約更新促進メール（クライアント企業管理者宛） (Composite: 0.7002)

**期待結果（721_学年自動更新バッチ）**: #14

#### 最新設定（Phase 0A-2改善）
1. 721_【作成中】学年自動更新バッチ (Composite: 0.9144) ✅
2. 043_【FIX】プロフィール編集機能（基本情報タブ） (Composite: 0.8511)
3. 【FIX】会員：プロフィール情報 (Composite: 0.8360)

**期待結果（721_学年自動更新バッチ）**: **#2** ✅

## 結論

### 最新設定（Phase 0A-2改善）が圧倒的に優れている

1. **品質の向上**
   - 品質スコアが6.0から6.7に向上（+11.7%）
   - 期待結果が#14から#2に大幅改善（+12位）

2. **検索速度の劇的改善**
   - 検索時間が8.4秒から2.1秒に短縮（-74.9%）
   - 総合時間が23.1秒から17.8秒に短縮（-22.9%）

3. **設定の妥当性**
   - `maxBm25Score`: 30.0により高BM25スコア（keyword=22など）を適切に評価
   - `kwCap`: 100により十分なBM25候補を確保
   - `bm25Weight`: 50%によりキーワード完全一致を最優先
   - `vectorWeight`: 5%によりベクトル空間変化の影響を軽減

## Phase 0A-4設定が「良かった」という記憶について

### 考察
Phase 0A-4設定が「1位が多く取得できていた」という記憶は、以下の要因による可能性が高い：

1. **BM25スコア伝播バグの影響**
   - バグ修正前は`result._bm25Score`が参照されておらず、異なる挙動をしていた
   - バグ修正後の現在は、正しくBM25スコアが伝播され、より正確な評価が行われている

2. **LanceDBの状態差異**
   - Phase 0A-4当時：StructuredLabel統合前の状態
   - 現在：StructuredLabel統合後の最新状態
   - タイトル重みづけベクトル埋め込み適用済み

3. **キャッシュの影響**
   - 過去のテスト結果がキャッシュされていた可能性

### 検証結果
今回の公平な比較（キャッシュクリア済み、同じLanceDB状態）では、**最新設定が明確に優れている**ことが実証された。

## 推奨事項

### 採用する設定
**最新設定（Phase 0A-2改善）を継続採用**

### 理由
1. ✅ 品質スコアが高い（6.7/10.0）
2. ✅ 検索速度が速い（2.1秒）
3. ✅ 期待結果の順位が高い（#2）
4. ✅ BM25高スコアを適切に評価（maxBm25Score=30.0）
5. ✅ 十分なBM25候補を確保（kwCap=100）

### 今後の改善方向
- Phase 4（KG統合）の実装により、さらなる品質向上が期待される
- 現在のkgWeight=5%は準備済みだが、KG機能が未実装のため実質無効化されている

## 関連ドキュメント
- [Phase 0A-4とCurrentロジック差分](./phase-0a-4-vs-current-logic-diff.md)
- [BM25スコア伝播バグ修正](./bm25-score-propagation-bug-fix.md)
- [ハイブリッド検索ロジック（現在）](../architecture/hybrid-search-logic-current.md)
