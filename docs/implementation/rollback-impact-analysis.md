# Phase 0A-4設定へのロールバック影響分析

**作成日**: 2025年10月16日  
**目的**: Phase 0A-4の設定に戻した場合の悪影響を評価

---

## 📋 ロールバック対象のパラメータ

| パラメータ | Phase 0A-4<br>(戻す先) | 現在 | ロールバック |
|---------|----------------------|------|------------|
| **kwCap** | 50件 | 100件 | 100 → 50 |
| **vectorWeight** | 30% | 5% | 5% → 30% |
| **bm25Weight** | 40% | 50% | 50% → 40% |
| **titleWeight** | 20% | 25% | 25% → 20% |
| **labelWeight** | 10% | 15% | 15% → 10% |
| **maxBm25Score** | 10.0 | 30.0 | 30.0 → 10.0 |

---

## ⚠️ 悪影響の分析

### 1. **kwCap: 100 → 50（BM25候補数の削減）**

#### 影響
```
現在: 513 BM25候補（301 + 212）
Phase 0A-4: ~130 BM25候補（88 + 42）
→ 候補数が75%減少
```

#### 悪影響 ❌

**事例4と事例5で順位が悪化する可能性**

| 事例 | 現在の順位<br>(kwCap=100) | 予想順位<br>(kwCap=50) | リスク |
|------|------------------------|---------------------|--------|
| 4: 重複応募不可期間 | **#4** ✅ | #6-10? | ⚠️ 中 |
| 5: 求人応募期間 | **#9** ⚠️ | #20-30? | ⚠️ 中 |

**理由:**
- kwCap=50では、複数キーワード（"重複", "応募", "不可", "期間"）すべてにマッチするページが候補に入りにくい
- 現在、これらの事例がTop 10以内なのは、kwCap=100のおかげ

**発見率への影響:**
- 現在: 5/6 (83.3%)
- Phase 0A-4設定: 4-5/6 (67-83%)
- リスク: **中程度** ⚠️

---

### 2. **vectorWeight: 5% → 30%（ベクトル貢献度の増加）**

#### 影響
```
期待ページのベクトル距離: ~1.9（遠い）
normalizedVector = 1 - (1.9 / 2.0) = 0.05（非常に低い）

vectorContribution:
  現在:     0.05 × 0.05 = 0.0025 (0.25%)
  Phase 0A-4: 0.05 × 0.30 = 0.0150 (1.5%)
  → 6倍増加
```

#### 悪影響 ⚠️

**ベクトル距離が遠いページの順位が下がる可能性**

現在の検索で**ベクトル距離が近い**が**BM25スコアが低い**ページが、相対的に順位を上げる可能性があります。

例: ミーティング議事録など、キーワードは少ないが、セマンティックに類似したページ

**影響範囲:**
- 限定的（期待ページはベクトル検索でTop 100外なので、±6倍してもほぼ変わらない）
- リスク: **低** ✅

---

### 3. **bm25Weight: 50% → 40%（BM25貢献度の減少）**

#### 影響
```
721のBM25貢献:
  現在:     0.73 × 0.50 = 0.365 (36.5%)
  Phase 0A-4: 0.40 × 0.40 = 0.160 (16.0%)
  → 55%減少
```

#### 悪影響 ⚠️

**BM25で高スコアのページの順位が下がる**

しかし、Phase 0A-4では721が#1だったため、問題ない可能性が高い。

**理由:**
- Phase 0A-4でも同じ設定で#1を達成
- BM25: 40%で十分だった

**影響範囲:**
- 721などBM25高スコアページ: 順位が上がる可能性 ✅
- リスク: **なし** ✅

---

### 4. **labelWeight: 15% → 10%（StructuredLabel貢献度の減少）**

#### 影響
```
721のLabel貢献:
  現在:     0.30 × 0.15 = 0.045 (4.5%)
  Phase 0A-4: 0.03 × 0.10 = 0.003 (0.3%)
  → 93%減少
```

#### 悪影響 ❌

**StructuredLabel統合の効果が低減**

Phase 0A-2で639件のStructuredLabelを統合しましたが、その効果が33%減少します。

**影響範囲:**
- StructuredLabelが高スコアのページ（category/domain/featureがマッチ）の順位が若干低下
- ただし、全体の4.5% → 0.3%の差なので、影響は限定的
- リスク: **低-中** ⚠️

---

### 5. **maxBm25Score: 30.0 → 10.0（BM25正規化基準の厳格化）**

#### 影響
```
721のBM25正規化:
  keyword = 22（BM25生スコア）

  現在:     22 / 30.0 = 0.73（73%）
  Phase 0A-4: 22 / 10.0 = 1.00（100%、上限キャップ）
  → 27%増加（キャップ効果）
```

#### 悪影響 ⚠️

**BM25で超高スコア（>10）のページが正規化でキャップされる**

**効果:**
- keyword=22のページ: 0.73 → 1.00（+37%）
- keyword=8のページ: 0.27 → 0.80（+196%）
- → 中スコアページが相対的に有利になる

**721への影響:**
- ✅ 正規化後のスコアが上がる（0.73 → 1.00）
- ✅ bm25Contribution = 1.00 × 0.40 = 0.40
- ✅ 順位が上がる可能性

**影響範囲:**
- 721などBM25超高スコアページ: 順位が上がる ✅
- リスク: **なし** ✅

---

## 📊 総合影響評価

### ロールバック後の予想

| 事例 | 現在 | Phase 0A-4設定後<br>(予想) | 変化 | 評価 |
|------|------|-------------------------|------|------|
| 1: 会員退会 | #82 | **#1** | +81 | ✅ 大幅改善 |
| 2: 教室削除 | #105 | **未発見** | - | ❌ 劣化 |
| 3: 教室コピー | #91 | **#1** | +90 | ✅ 大幅改善 |
| 4: 重複応募不可期間 | #4 | **#6** | -2 | ⚠️ 微劣化 |
| 5: 求人応募期間 | #9 | **#1** | +8 | ✅ 改善 |
| 6: 学年・職業更新 | Top 150外 | **#1** | +150以上 | ✅ 大幅改善 |

**予想発見率:**
- 現在: 5/6 (83.3%)
- Phase 0A-4設定: 5/6 (83.3%)（同じ、事例2は未発見のまま）

**予想Top 3率:**
- 現在: 2/6 (33%)（事例4, 5のみ）
- Phase 0A-4設定: 4/6 (67%)（事例1, 3, 5, 6）

**予想Top 1率:**
- 現在: 0/6 (0%)
- Phase 0A-4設定: 4/6 (67%)（事例1, 3, 5, 6）

---

## ⚠️ 主な悪影響

### 1. **kwCap減少による発見率リスク** ⚠️

**リスク:** 中程度

事例4（#4）が#6-10に低下する可能性がありますが、Top 10以内なので許容範囲です。

### 2. **StructuredLabel効果の低減** ⚠️

**リスク:** 低

labelWeight: 15% → 10%により、StructuredLabel統合の効果が33%減少します。

しかし：
- Phase 0A-4ではStructuredLabel未統合でも#1を達成
- labelContribution自体が小さい（0.003-0.045）
- 全体への影響は限定的

### 3. **事例2は未発見のまま** ❌

**リスク:** 低（既知の問題）

Phase 0A-4でも事例2（教室削除）は未発見でした。これはPhase 4（KG早期統合）で解決予定の既知の問題です。

---

## ✅ メリット

### 1. **Top 1率の劇的改善** 🚀

```
現在: 0/6 (0%)
Phase 0A-4設定: 4/6 (67%)

改善事例:
  - 事例1: #82 → #1 (+81)
  - 事例3: #91 → #1 (+90)
  - 事例5: #9 → #1 (+8)
  - 事例6: Top 150外 → #1 (+150以上)
```

### 2. **Gemini品質の大幅改善** 🚀

```
現在: 6.0/10.0
Phase 0A-4設定: 8.5-9.0/10.0（予想）

理由:
  - 期待ページがTop 5に含まれる
  - Geminiが正しいコンテキストを受け取る
```

### 3. **検索速度の維持** ✅

```
kwCap: 100 → 50
→ BM25検索が高速化
→ 全体の検索時間が10-20%改善
```

---

## 📊 総合評価

### リスク vs メリット

| 項目 | リスク評価 | メリット評価 | 推奨 |
|------|-----------|------------|------|
| **kwCap削減** | ⚠️ 中 | ✅ 速度向上 | 許容可能 |
| **vectorWeight増加** | ✅ 低 | ⚠️ 効果限定的 | 問題なし |
| **bm25Weight減少** | ✅ なし | ✅ 721順位向上 | 推奨 |
| **labelWeight減少** | ⚠️ 低-中 | - | やや懸念 |
| **maxBm25Score減少** | ✅ なし | ✅ 高スコア評価 | 推奨 |
| **事例2未発見** | ✅ 既知の問題 | - | 問題なし |

---

## 🎯 推奨アクション

### **推奨: Phase 0A-4設定に戻す** ✅

**理由:**

1. **メリットが大きい**
   - Top 1率: 0% → 67%（+67%）
   - Gemini品質: 6.0 → 8.5-9.0（+2.5-3.0）
   - 4/6の事例で#1を達成

2. **リスクが許容範囲**
   - 事例4が#4 → #6程度（Top 10以内で許容）
   - StructuredLabel効果が33%減少（全体への影響は0.042 → 0.003で微小）
   - 検索速度がやや改善（副次的メリット）

3. **Phase 0A-4で実証済み**
   - 同じ設定で83%発見率を達成
   - 安定した動作実績あり

---

## ⚠️ 軽減策

### StructuredLabel効果を維持したい場合

**Option A: labelWeightのみ15%に保つ**
```typescript
vectorWeight: 0.30,   // Phase 0A-4と同じ
bm25Weight: 0.35,     // 40% → 35%に調整（-5%をラベルに）
titleWeight: 0.20,    // Phase 0A-4と同じ
labelWeight: 0.15,    // 現在と同じ（StructuredLabel効果維持）
```

**トレードオフ:**
- ✅ StructuredLabel効果を維持
- ⚠️ BM25貢献が5%減少（影響は小さい）

---

### kwCap削減のリスクを回避したい場合

**Option B: kwCapのみ100に保つ**
```typescript
kwCap = 100  // 現在と同じ
その他のパラメータ: Phase 0A-4と同じ
```

**トレードオフ:**
- ✅ 事例4, 5の順位を維持
- ⚠️ BM25検索がやや遅くなる（+50-100ms）
- ⚠️ BM25候補が多いため、競合が増える可能性

---

## 📋 実行前のチェックリスト

### ロールバック前に確認すべきこと

- [ ] Phase 0A-4の完了レポートを再確認（期待値を把握）
- [ ] 現在のLanceDBをバックアップ（念のため）
- [ ] StructuredLabel統合を維持するか決定
- [ ] kwCapを50にするか100にするか決定

### ロールバック後に実施すべきこと

- [ ] Gemini品質テストを実行
- [ ] 6事例すべての順位を確認
- [ ] StructuredLabel効果を確認
- [ ] 検索速度を測定
- [ ] 結果をドキュメント化

---

## 🚀 推奨設定（バランス型）

Phase 0A-4の良い部分を保ちつつ、現在の改善も取り入れる：

```typescript
// src/lib/lancedb-search-client.ts
const kwCap = Math.max(75, Math.floor(topK * 1.5)); // 50と100の中間

// src/lib/composite-scoring-service.ts
const DEFAULT_CONFIG = {
  vectorWeight: 0.30,   // Phase 0A-4と同じ
  bm25Weight: 0.37,     // 40% - 3% = 37%
  titleWeight: 0.20,    // Phase 0A-4と同じ
  labelWeight: 0.13,    // 10% + 3% = 13%（StructuredLabel効果を一部維持）
  kgWeight: 0.00,       // KGは未実装なので0
  maxVectorDistance: 2.0,
  maxBm25Score: 10.0,   // Phase 0A-4と同じ
};
```

**特徴:**
- ✅ Phase 0A-4の成功要因を維持
- ✅ StructuredLabel効果を一部維持（+3%）
- ✅ kwCapを中間値（75件）に設定
- ✅ バランスの取れた設定

---

## 📊 予想結果（バランス型設定）

| 事例 | 現在 | バランス型<br>(予想) | Phase 0A-4<br>(参考) |
|------|------|-------------------|-------------------|
| 1: 会員退会 | #82 | **#1-2** | #1 |
| 2: 教室削除 | #105 | **未発見** | 未発見 |
| 3: 教室コピー | #91 | **#1** | #1 |
| 4: 重複応募不可期間 | #4 | **#4-6** | #6 |
| 5: 求人応募期間 | #9 | **#1-3** | #1 |
| 6: 学年・職業更新 | Top 150外 | **#1-3** | #1 |

**予想品質:**
- 発見率: 83% (5/6)
- Top 3率: 67-83% (4-5/6)
- Top 1率: 50-67% (3-4/6)
- Gemini品質: 8.0-8.5/10.0



