# 抽出キーワード周辺のコンテンツを取得する仕様

## 概要

現在の実装では「抽出キーワード周辺のコンテンツを取得する」仕様ではなく、「ハイブリッド方式：ランクによる先頭取得 + キーワード検索による補完」という実装になっています。

## 現在の実装

### 処理フロー

1. **ランクに基づく先頭取得**
   - 先頭から`maxLength`文字分を取得（0文字目～maxLength文字目）

2. **範囲内・範囲外のキーワード分類**
   - 範囲内キーワード: `< maxLength` に含まれるキーワード
   - 範囲外キーワード: `>= maxLength` に含まれるキーワード

3. **範囲拡張ロジック**
   - 範囲外キーワードがある場合、それらを含むように範囲を拡張
   - **ただし、先頭範囲内のキーワードを保持することを優先**

### 問題点

現在の実装では、以下の問題があります：

1. **先頭取得が優先される**
   - 先頭から`maxLength`文字を取得した後、範囲外キーワードがあれば範囲を拡張する
   - しかし、先頭範囲内のキーワードを保持することを優先するため、範囲外のキーワードが多数ある場合でも、先頭から`maxLength`文字のみが抽出されることがある

2. **キーワード周辺のコンテンツが取得されない**
   - キーワードが後半にある場合（例: 500文字目以降）、キーワード周辺のコンテンツが取得されない
   - 先頭を優先するため、後半のキーワードを含む範囲が抽出されない

3. **範囲拡張ロジックの制限**
   - 全体の範囲が`maxLength`を超える場合、先頭のキーワードを優先
   - 結果として、範囲外キーワードが多数あっても、先頭から`maxLength`文字のみが抽出される

## 調査結果（「会員情報の学年や現在の職業は自動で更新されますか」）

### キーワード位置

- **範囲内キーワード**: 20個（500文字以内）
- **範囲外キーワード**: 33個（500文字以降）
- **範囲外の最初のキーワード**: 536文字目（"学年"）
- **範囲外の最後のキーワード**: 1438文字目（"学年"）

### 抽出結果

- **抽出範囲**: 0文字目～500文字目（先頭から500文字）
- **理由**: 全体の範囲が`maxLength`を超えるため、先頭のキーワードを優先

### 問題

- 範囲外のキーワードが33個もあるのに、範囲拡張ロジックが先頭を優先して、結果として先頭500文字のみが抽出されている
- **これは「キーワード周辺のコンテンツを取得する」仕様には合っていない**

## 「キーワード周辺のコンテンツを取得する」仕様

### 仕様定義

「抽出キーワード周辺のコンテンツを取得する」仕様とは：

1. **すべてのキーワードを含む範囲を計算**
   - 最初のキーワード位置から最後のキーワード位置までの範囲を計算
   - 各キーワードの前後（例: 前100文字、後100文字）を含める

2. **範囲が`maxLength`以内の場合**
   - すべてのキーワードを含む範囲を抽出
   - 最初のキーワードの前から最後のキーワードの後まで

3. **範囲が`maxLength`を超える場合**
   - `maxLength`を超えない範囲で、できるだけ多くのキーワードを含める
   - キーワードが集中している領域を優先的に抽出
   - 先頭ではなく、キーワードが集中している領域を抽出

### 実装例

```typescript
// すべてのキーワードを含む範囲を計算
const firstKeywordPos = keywordPositions[0].position;
const lastKeywordPos = keywordPositions[keywordPositions.length - 1].position;
const keywordSpan = lastKeywordPos - firstKeywordPos;

// キーワード周辺のコンテンツを取得
const contextBefore = 100; // キーワード前100文字
const contextAfter = 100; // キーワード後100文字

let startPos = Math.max(0, firstKeywordPos - contextBefore);
let endPos = Math.min(content.length, lastKeywordPos + contextAfter);

const totalSpan = endPos - startPos;

if (totalSpan <= maxLength) {
  // すべてのキーワードを含む範囲がmaxLength以内の場合
  // そのまま抽出
} else {
  // 範囲がmaxLengthを超える場合
  // キーワードが集中している領域を優先的に抽出
  // または、キーワード密度が高い領域を抽出
}
```

## 現在の実装との違い

| 項目 | 現在の実装 | 「キーワード周辺」仕様 |
|------|-----------|---------------------|
| **開始位置** | 常に0（先頭） | 最初のキーワード位置 - 前後余白 |
| **優先順位** | 先頭 > キーワード | キーワード > 先頭 |
| **範囲拡張** | 先頭を保持しつつ拡張 | キーワードを含む範囲を優先 |
| **後半のキーワード** | 含まれない可能性がある | 含まれる |

## 推奨される改善

「抽出キーワード周辺のコンテンツを取得する」仕様に合わせて、以下の改善を推奨します：

1. **先頭取得を削除**
   - ランクによる先頭取得を削除
   - キーワード周辺のコンテンツを直接取得

2. **キーワード集中領域の検出**
   - キーワードが集中している領域を検出
   - その領域を優先的に抽出

3. **範囲調整の改善**
   - 先頭を優先するのではなく、キーワードを含む範囲を優先
   - キーワードが後半にある場合でも、キーワード周辺のコンテンツを取得

## まとめ

### 現在の実装

- ❌ 「キーワード周辺のコンテンツを取得する」仕様には合っていない
- ❌ 先頭取得が優先される
- ❌ 後半のキーワードが含まれない可能性がある

### 推奨される仕様

- ✅ すべてのキーワードを含む範囲を計算
- ✅ キーワード周辺のコンテンツを優先的に抽出
- ✅ 先頭ではなく、キーワードが集中している領域を抽出

