# ベクトル空間の安定性分析レポート

**作成日**: 2025年10月16日  
**調査内容**: ページ増減がベクトル検索品質に与える影響

---

## 📋 調査結果サマリー

### ✅ 結論

**ページの増減は、既存ページのベクトル検索品質に影響しません。**

---

## 🔬 検証内容

### 検証1: ベクトル埋め込みの比較

**対象ページ:**
- 046_【FIX】会員退会機能
- 168_【FIX】教室コピー機能
- 721_【作成中】学年自動更新バッチ

**比較:**
- Phase 0A-4時点（813ページ）
- 現在（743ページ、-70ページ）

**結果:**
```
✅ すべてのページでベクトルが完全一致
✅ PageIdも一致
✅ コンテンツも一致
```

**結論:**
- ベクトル埋め込みは各ページ独立で生成される
- 他のページの有無に影響されない
- ページ増減でベクトルは変わらない ✅

---

### 検証2: ベクトル検索順位の比較

**テスト:**
同じクエリで、同じLanceDBに対してベクトル検索を実行

**結果:**
```
✅ すべての期待ページがPhase 0A-4でも現在でも「Top 100外」
→ ベクトル検索の順位は変わっていない
```

**結論:**
- ベクトル検索の結果もページ増減に影響されない
- 安定したベクトル検索が可能 ✅

---

## ❌ 誤っていた説明

### 以前の説明（誤り）

> 70ページ（8.6%）の削除により、**ベクトル空間の分布が変わった**
> → 期待ページのベクトル距離（類似度）が変わった
> → ベクトル検索での順位が#1 → #22-34に劣化

### 真実

**ベクトル検索では、Phase 0A-4でも現在でもTop 100外でした。**

つまり：
- ベクトル検索単体では、期待ページは発見されていなかった
- Phase 0A-4で#1だったのは、**BM25とComposite Scoringの組み合わせ**による
- ベクトル空間の変化は**発生していません**

---

## 🎯 Phase 0A-4で#1だった真の理由

### 実際のスコア内訳（事例6）

```
721_【作成中】学年自動更新バッチ: #1

Composite: 0.9294
├─ V: 0.50  ← normalizedVector（正規化後のベクトル類似度）
├─ B: 0.40  ← normalizedBM25（正規化後のBM25スコア）
├─ T: 0.00  ← タイトルマッチ率
└─ L: 0.03  ← ラベルスコア

これは各信号の正規化後の値を表示している

実際の貢献度:
├─ vectorContribution  = 0.50 × 0.30 = 0.150 (15%)
├─ bm25Contribution    = 0.40 × 0.40 = 0.160 (16%)
├─ titleContribution   = 0.00 × 0.20 = 0.000 (0%)
└─ labelContribution   = 0.03 × 0.10 = 0.003 (0.3%)
                                     ───────
                        合計 ≈ 0.313 (31.3%)

※ 表示されているComposite: 0.9294とは計算が合わない
  → 表記方法が異なる、または他の要因がある
```

### ベクトル距離の逆算

```
normalizedVector = 0.50
= 1.0 - (vectorDistance / maxVectorDistance)
= 1.0 - (vectorDistance / 2.0)

vectorDistance = (1.0 - 0.50) × 2.0 = 1.0
```

**Phase 0A-4時点で、721のベクトル距離は約1.0でした。**

これは「やや遠い」距離で、Top 100外になる可能性があります。

---

## 🔑 Phase 0A-4が成功した本当の理由

### **BM25検索が主役だった**

```
1. ベクトル検索: Top 100外（発見できず）
   ↓
2. BM25検索: keyword=22（非常に高スコア）← ここで発見！
   - タイトル: "学年自動更新バッチ"
   - キーワード: [学年, 更新]
   → 完全マッチ
   ↓
3. Composite Scoring:
   - normalizedBM25 = 0.40（高い）
   - normalizedVector = 0.50（中程度）
   → compositeScore = 0.9294
   → #1にランクイン ✅
```

### **現在の問題**

```
1. ベクトル検索: Top 100外（同じ）
   ↓
2. BM25検索: keyword=22（同じ）← 発見！
   ↓
3. RRF融合: この段階で順位が決まる
   ↓
4. Composite Scoring:
   - normalizedBM25 = 22 / 30.0 = 0.73（高い）
   - normalizedVector = ???（不明）
   → compositeScore = ???
   → Top 150外 ❌

問題: なぜComposite Scoringで順位が低い？
```

---

## 🔍 次の調査ポイント

Phase 0A-4と現在で、**RRFスコアとComposite Scoringの実際の値**を比較する必要があります。

具体的には：
1. Phase 0A-4時点での721のRRFスコア
2. 現在の721のRRFスコア
3. RRF融合後の順位
4. Composite Scoring後の順位

これにより、どの段階で順位が劣化したのかが特定できます。



