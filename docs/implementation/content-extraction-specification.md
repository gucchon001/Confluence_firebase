# キーワード検索によるコンテンツ抽出の仕様

## 概要

LLMに渡すコンテンツを、クエリに関連する部分を優先的に抽出するためのキーワードマッチング方式のコンテンツ抽出仕様です。

## 使用箇所

- `src/ai/flows/streaming-summarize-confluence-docs.ts`: LLMのコンテキスト生成時に使用
- `src/ai/flows/content-extraction-utils.ts`: 抽出ロジックの実装

## 処理フロー

### 1. キーワード抽出 (`extractKeywords`)

クエリからキーワードを抽出します。

#### 優先順位

1. **ドメイン知識連携のキーワード抽出サービス** (`unifiedKeywordExtractionService.extractKeywordsSync`)
   - ドメイン知識ベースからキーワードを抽出
   - カテゴリ別の優先度付け（ドメイン名: 100、機能名: 80、操作名: 60、システムフィールド: 40、システム用語: 30、関連キーワード: 20）
   - キーワードの長さによる調整（2-8文字: +20、9-15文字: +10）
   - 最大8個のキーワードに制限（検索時と同じ）
   - より精度の高いキーワード抽出が可能

2. **フォールバック: 簡易版のキーワード抽出**
   - ストップワード（助詞など）を除外
   - 2文字以上の連続する文字列を抽出
   - ひらがな、カタカナ、漢字、数字、英字を単語として扱う

#### 例

```
クエリ: "会員情報の学年や現在の職業は自動で更新されますか"
抽出キーワード（優先度順）: ["会員情報", "職業", "会員", "更新", "学年", ...]（最大8個）
```

### 2. キーワード位置検索 (`extractRelevantContentMultiKeyword`)

コンテンツ内で各キーワードの出現位置を検索します。

#### 処理

- すべてのキーワードについて、コンテンツ内のすべての出現位置を検索
- 各キーワードの位置（文字インデックス）を記録
- 位置順にソート

#### 例

```
キーワード: ["会員情報", "更新", "学年"]
コンテンツ: "...会員情報...学年...更新..."
位置:
  - "会員情報": 100文字目
  - "学年": 500文字目
  - "更新": 800文字目
```

### 3. ハイブリッド抽出方式

ランクによる先頭取得とキーワード検索による補完を組み合わせます。

#### ステップ1: ランクに基づく先頭取得

- 先頭から`maxLength`文字分を取得
- ランキングに基づく動的な文字数制限：
  - 1位: 1500文字
  - 2位: 1000文字
  - 3位: 800文字
  - 4-6位: 600文字
  - 7-10位: 500文字

#### ステップ2: 範囲内・範囲外のキーワード分類

- **範囲内キーワード**: 先頭取得範囲内（`< maxLength`）に含まれるキーワード
- **範囲外キーワード**: 先頭取得範囲外（`>= maxLength`）に含まれるキーワード

#### ステップ3: 範囲拡張ロジック

範囲外のキーワードがある場合、それらを含むように範囲を拡張します。

##### ケース1: 全体の範囲が`maxLength`以内の場合

- 範囲外のキーワードまで含める
- 最後のキーワードの後50文字まで拡張
- `maxLength`を超えないように調整
- 先頭のキーワードが範囲外にならないように調整

##### ケース2: 全体の範囲が`maxLength`を超える場合

**2-1. 範囲外キーワードを含む範囲が`maxLength`以内の場合**

- 先頭のキーワードを保持しつつ、範囲外のキーワードを含める
- 先頭のキーワードが前半（`< maxLength * 0.5`）にある場合：
  - 先頭範囲を保持したまま、範囲外キーワードを含める
  - または、先頭範囲を少し削減して、範囲外キーワードを含める
- 先頭のキーワードがない、または後半にある場合：
  - 範囲外キーワードを含む範囲を優先

**2-2. 範囲外キーワードを含む範囲が`maxLength`を超える場合**

- 先頭のキーワードを優先的に保持
- 先頭のキーワードが前半（`< maxLength * 0.5`）にある場合：
  - 先頭のキーワードを保持しつつ、範囲外キーワードの一部を含める
- 先頭のキーワードがない、または後半にある場合：
  - 範囲外のキーワードを優先的に含める

#### ステップ4: 最終調整

- 抽出した部分が`maxLength`を超える場合は切り詰める
- 先頭が0でない場合、`...`を先頭に追加
- 末尾がコンテンツの終端でない場合、`...`を末尾に追加

## 重要な特徴

### 1. 検索時と同じキーワード抽出ロジックを使用

- **検索時**: `extractKeywordsConfigured()` (非同期、動的キーワード抽出)
- **コンテンツ抽出時**: `extractKeywordsSync()` (同期、カテゴリ別抽出)

両方とも同じ優先度付けとフィルタリングロジックを使用：
- カテゴリ別の優先度（ドメイン名 > 機能名 > 操作名 > システムフィールド > システム用語 > 関連キーワード）
- キーワードの長さによる調整
- 最大8個のキーワードに制限

### 2. ハードコードされたパターンを使用しない

- ❌ 削除済み: マーカーパターン（`/更新内容/g`, `/学部\d+年生/g`など）
- ❌ 削除済み: 表検出ロジック（`/表\d+/`）
- ✅ 使用: キーワード抽出サービスから取得したキーワードのみ

### 3. すべてのキーワードを同等に扱う

- 以前は「重要なマーカー」を優先的に扱っていましたが、現在はすべてのキーワードを同等に扱います
- 優先度はキーワード抽出段階で反映されるため、抽出時にはすべてのキーワードを同等に扱います

### 4. ハイブリッド方式

- **ランクによる先頭取得**: ランキングに基づいて先頭から`maxLength`文字を取得（重要情報が先頭にある場合に対応）
- **キーワード検索による補完**: 範囲外のキーワードがある場合、それらを含むように範囲を拡張（重要情報が後半にある場合に対応）

## 使用例

### 例1: キーワードが先頭範囲内にある場合

```
コンテンツ長: 2000文字
maxLength: 500文字
キーワード位置: [100, 300, 450]（すべて先頭範囲内）

結果: 先頭500文字を抽出（キーワードはすべて含まれる）
```

### 例2: キーワードが範囲外にある場合

```
コンテンツ長: 2000文字
maxLength: 500文字
キーワード位置: [100, 300, 800, 900]（800, 900は範囲外）

結果: 
- 先頭範囲内のキーワード（100, 300）を保持
- 範囲外のキーワード（800, 900）を含むように拡張
- 最終的に800-950文字目を抽出（100文字目からも開始できる場合は0-500文字目も含める）
```

### 例3: 全体の範囲が`maxLength`を超える場合

```
コンテンツ長: 2000文字
maxLength: 500文字
キーワード位置: [100, 800, 900]（800, 900は範囲外）

結果:
- 先頭のキーワード（100）が前半（< 250文字目）にある場合
  → 先頭のキーワードを保持しつつ、範囲外キーワードの一部を含める（100-600文字目）
- 先頭のキーワードがない、または後半にある場合
  → 範囲外のキーワードを優先的に含める（750-1250文字目）
```

## 制約事項

1. **最大文字数制限**: ランキングに基づく動的な文字数制限が適用される
2. **キーワード数制限**: 最大8個のキーワードに制限される（検索時と同じ）
3. **優先度付け**: キーワード抽出段階で優先度が反映されるが、抽出時にはすべてのキーワードを同等に扱う

## 改善履歴

- **2025-01-XX**: ハードコードされたマーカーパターンを削除し、キーワード抽出サービスに依存するように変更
- **2025-01-XX**: 検索時と同じキーワード抽出ロジックを使用するように変更（`extractKeywordsSync`に優先度付けとフィルタリングを追加）
- **2025-01-XX**: 表検出ロジックを削除し、キーワード抽出サービスが「表」を検出すれば使用

## 参考資料

- `src/lib/unified-keyword-extraction-service.ts`: 統一キーワード抽出サービス
- `src/ai/flows/content-extraction-utils.ts`: コンテンツ抽出ユーティリティ
- `src/ai/flows/streaming-summarize-confluence-docs.ts`: LLMコンテキスト生成
- `docs/implementation/keyword-extraction-module-usage-analysis.md`: キーワード抽出モジュールの使用状況分析

