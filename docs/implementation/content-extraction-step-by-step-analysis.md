# コンテンツ抽出処理のステップバイステップ分析

## 調査概要

クエリ「会員情報の学年や現在の職業は自動で更新されますか」でのコンテンツ抽出処理をステップバイステップで調査しました。

対象ページ: `721_【作成中】学年自動更新バッチ` (pageId: 743473812)

## 調査結果

### ステップ1: キーワード抽出

**使用メソッド**: `unifiedKeywordExtractionService.extractKeywordsSync()`

**抽出されたキーワード**:
```
[会員, 更新, 会員情報, 学年, 情報, 現在の職業, 職業, 自動]
```

**キーワード数**: 8個（最大制限）

**特徴**:
- ✅ 検索時と同じキーワード抽出ロジックを使用
- ✅ 優先度付けとフィルタリングが適用される
- ✅ カテゴリ別の優先度（ドメイン名 > 機能名 > 操作名 > システムフィールド > システム用語 > 関連キーワード）
- ✅ キーワードの長さによる調整（2-8文字: +20、9-15文字: +10）

### ステップ2: キーワード位置検索

**処理**:
- コンテンツ内で各キーワードのすべての出現位置を検索
- 各キーワードの位置（文字インデックス）を記録

**結果**:
- **総キーワード位置数**: 53個

**キーワード別の出現回数**:
- "会員": 6箇所
- "更新": 13箇所
- "会員情報": 0箇所（見つかりませんでした）
- "学年": 23箇所
- "情報": 0箇所（見つかりませんでした）
- "現在の職業": 3箇所
- "職業": 5箇所
- "自動": 3箇所

### ステップ3: 位置でソート

**処理**:
- キーワード位置を文字インデックスの昇順でソート

**結果**:
- 最初のキーワード位置: 25文字目（"会員"）
- 最後のキーワード位置: 1438文字目（"学年"）

### ステップ4: ハイブリッド抽出方式

#### 4-1. ランクによる先頭取得

**設定**: ランク9位を想定、`maxLength = 500`

**処理**:
- 先頭から500文字を取得（0文字目～500文字目）

#### 4-2. 範囲内・範囲外のキーワード分類

**結果**:
- **範囲内キーワード**: 20個（500文字以内）
- **範囲外キーワード**: 33個（500文字以降）

**範囲外の最初のキーワード**: 536文字目（"学年"）
**範囲外の最後のキーワード**: 1438文字目（"学年"）

#### 4-3. 範囲拡張ロジック

**計算**:
- 全体の範囲: 1438文字（maxLength=500文字を超える）
- 範囲外キーワードを含む範囲: 1002文字（536文字目～1438文字目 + 100文字）

**判定**:
- ✅ 全体の範囲が`maxLength`を超える
- ✅ 範囲外キーワードを含む範囲が`maxLength`を超える
- ✅ 先頭のキーワードが前半（25文字目 < 250文字目）にある

**結果**:
- 先頭のキーワードを保持しつつ、範囲外キーワードの一部を含める
- 抽出範囲: **0文字目～500文字目**（先頭から500文字）

### ステップ5: 抽出結果

**抽出されたコンテンツ長**: 503文字（`...`含む）
**元のコンテンツ長**: 1600文字
**抽出率**: 31.44%
**抽出範囲**: 0文字目～500文字目（500文字）

### ステップ6: 重要フレーズの確認

| フレーズ | 元のコンテンツ | 抽出コンテンツ | 位置 |
|---------|--------------|--------------|------|
| "表1" | ✅ 含む | ❌ 含まない | 502文字目 |
| "表2" | ✅ 含む | ❌ 含まない | 555文字目 |
| "学年の更新内容" | ✅ 含む | ❌ 含まない | 936文字目 |
| "入学からの経過年数" | ✅ 含む | ✅ 含む | 490文字目 |
| "更新前" | ✅ 含む | ❌ 含まない | 944文字目 |
| "更新後" | ✅ 含む | ❌ 含まない | 948文字目 |
| "学部1年生" | ✅ 含む | ❌ 含まない | 958文字目 |

## 前回との比較

### 変更点

#### ✅ 改善された点

1. **キーワード抽出ロジックの統一**
   - 検索時と同じロジックを使用（`extractKeywordsSync`）
   - 優先度付けとフィルタリングが適用される
   - 最大8個のキーワードに制限

2. **ハードコードの削除**
   - マーカーパターン（`/更新内容/g`, `/学部\d+年生/g`など）を削除
   - 表検出ロジック（`/表\d+/`）を削除
   - キーワード抽出サービスに依存する汎用的な実装

#### ⚠️ 問題点

1. **重要なフレーズが抽出されない**
   - 「表1」「表2」「更新前」「更新後」「学部1年生」などが抽出されていない
   - これらはキーワード抽出サービスから取得したキーワードに含まれていない
   - 位置が500文字目以降にあるため、範囲拡張ロジックでも含まれない

2. **範囲拡張ロジックの制限**
   - 範囲外キーワードを含む範囲が`maxLength`を超える場合、先頭のキーワードを優先
   - 結果として、先頭から500文字のみが抽出される
   - 範囲外の重要な情報（表1、表2など）が含まれない

### 前回の実装

**前回（ハードコードあり）**:
- マーカーパターン（`/更新内容/g`, `/学部\d+年生/g`など）を使用
- これらのマーカーをキーワードとして扱う
- 「表1」「表2」などのパターンも検出

**現在（ハードコード削除後）**:
- キーワード抽出サービスから取得したキーワードのみを使用
- 「表1」「表2」などのパターンは検出されない

## 考察

### 問題の原因

1. **キーワード抽出サービスが「表1」「表2」などを抽出しない**
   - これらのフレーズは、クエリ「会員情報の学年や現在の職業は自動で更新されますか」には含まれていない
   - キーワード抽出サービスは、クエリに基づいてキーワードを抽出するため、コンテンツ内の重要なフレーズを自動的に検出しない

2. **範囲拡張ロジックの制限**
   - 範囲外キーワードを含む範囲が`maxLength`を超える場合、先頭のキーワードを優先
   - 「表1」「表2」などの重要なフレーズは、キーワード抽出サービスから取得したキーワードに含まれていないため、検出されない

### 改善案

1. **動的な文字数制限の調整**
   - 範囲外キーワードが多数ある場合、`maxLength`を動的に拡張
   - ただし、パフォーマンスへの影響を考慮する必要がある

2. **コンテンツ内の重要なマーカーの検出**
   - キーワード抽出サービスとは別に、コンテンツ内の重要なマーカー（表、図など）を検出
   - これらのマーカーを含む範囲を優先的に抽出

3. **複数チャンクの統合**
   - 対象ページが複数のチャンクに分割されている場合、すべてのチャンクを統合してから抽出
   - これにより、範囲外の重要な情報も含めることができる

## 結論

### 現在の実装

- ✅ キーワード抽出ロジックが統一され、検索時と同じ処理を使用
- ✅ ハードコードが削除され、汎用的な実装になった
- ❌ 重要なフレーズ（表1、表2など）が抽出されない
- ❌ 範囲拡張ロジックの制限により、範囲外の重要な情報が含まれない

### 前回との違い

- **キーワード抽出**: 同じ（検索時と同じロジックを使用）
- **範囲拡張ロジック**: 同じ（範囲外キーワードを含む範囲が`maxLength`を超える場合、先頭を優先）
- **マーカー検出**: **削除された**（ハードコードされたパターンが削除されたため、「表1」「表2」などが検出されない）

### 推奨される改善

1. **動的な文字数制限の調整**: 範囲外キーワードが多数ある場合、`maxLength`を動的に拡張
2. **コンテンツ内の重要なマーカーの検出**: キーワード抽出サービスとは別に、コンテンツ内の重要なマーカーを検出

