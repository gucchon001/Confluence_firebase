# 品質デグレード根本原因調査レポート

**作成日**: 2025年10月16日  
**Phase**: Phase 0A-2  
**調査対象**: Gemini出力品質スコア 6/10の原因

---

## 📋 調査サマリー

### 発見された問題

1. ✅ **修正済み**: `unified-search-result-processor.ts` で `_compositeScore` と `_scoreBreakdown` が削除されていた
2. ❌ **未解決**: 期待ページがTop 5に入らず、Geminiに渡されていない
3. ❌ **未解決**: 検索順位のランキングアルゴリズムに問題がある

---

## 🔍 ステップバイステップ調査結果

### Step 1: Composite Score削除の発見と修正

#### 問題
```typescript
// unified-search-result-processor.ts Line 238-277
return {
  id: result.id,
  // ...
  scoreText
  // ❌ _compositeScore がない！
  // ❌ _scoreBreakdown がない！
};
```

#### 修正
```typescript
return {
  // ... existing fields
  // Phase 0A-4: Composite Scoringフィールドを保持
  _compositeScore: (result as any)._compositeScore,
  _scoreBreakdown: (result as any)._scoreBreakdown,
};
```

#### 効果
- ✅ `_compositeScore` と `_scoreBreakdown` が正しく保持される
- ✅ 検索時間: 16,784ms → 11,952ms (-29%改善)

---

### Step 2: 期待ページの順位分析

| 事例 | クエリ | 期待ページ | 順位 | Top 5 | 問題 |
|------|--------|-----------|------|-------|------|
| 1 | 会員の退会手続きを教えて | 046_【FIX】会員退会機能 | #34 | ❌ | 順位低すぎ |
| 2 | 教室削除ができないのは何が原因ですか | 164_【FIX】教室削除機能 | #31 | ❌ | 順位低すぎ |
| 3 | 教室をコピーする方法を教えてください | 168_【FIX】教室コピー機能 | #22 | ❌ | 順位低すぎ |
| 4 | 重複応募不可期間はいつからいつまでですか | 014_【FIX】求人応募機能 | #34 | ❌ | 順位低すぎ |
| 5 | 求人に応募できる期間はいつまでですか | 014_【FIX】求人応募機能 | #49 | ❌ | 順位低すぎ |
| 6 | 塾講師プロフィールの学年・職業を更新する方法を教えてください | 721_【作成中】学年自動更新バッチ | #29 | ❌ | 順位低すぎ |

**統計**:
- 平均順位: **#33.2**
- Top 5に含まれる: **0/6件 (0%)**
- Top 10に含まれる: **0/6件 (0%)**
- Top 20に含まれる: **0/6件 (0%)**
- Top 30に含まれる: **1/6件 (17%)**

---

### Step 3: Geminiに渡されるコンテキストの分析

#### 現状
```typescript
// scripts/test-gemini-quality-simple.ts Line 49
const context = searchResults.slice(0, 5).map((r, i) => 
  `[Document ${i + 1}] Title: ${r.title}\nContent: ${r.content.substring(0, 500)}...`
).join('\n\n');
```

**問題**: 期待ページが#22-49にランクされているため、**Geminiに渡されていない**

#### Geminiの回答
すべてのケースで以下のように回答：
```
「提供されたドキュメントには、具体的な手順や詳細については記載されていません」
```

→ **当然の回答**: 期待ページのコンテンツがGeminiに渡されていないため

---

### Step 4: Top 5の内容分析（事例6: 学年・職業更新）

#### Top 5に含まれるページ

| 順位 | タイトル | Composite Score | 関連性 |
|------|---------|----------------|--------|
| 1 | 014_【FIX】求人応募機能 | 0.7274 | ⚠️ 低 |
| 2 | 【作成中】応募完了メール（クライアント企業管理者向け） | 0.6718 | ❌ なし |
| 3 | 041_【FIX】会員新規登録機能 | 0.6430 | ⚠️ 低 |
| 4 | 【FIX】オファー設定情報（自動オファー） | 0.6321 | ❌ なし |
| 5 | 【作成中】オシゴトQ＆A | 0.5999 | ❌ なし |

#### 期待ページ

| 順位 | タイトル | Composite Score |
|------|---------|----------------|
| **#29** | **721_【作成中】学年自動更新バッチ** | **0.4800** |

**問題**:
- 期待ページのComposite Scoreが0.4800と低い
- Top 1との差: 0.7274 - 0.4800 = **0.2474**（大きな差）

---

### Step 5: スコアリングの内訳分析

#### 期待ページのスコア内訳（推定）

```
721_【作成中】学年自動更新バッチ
Composite: 0.4800
├─ Vector: 0.20 (低い)
├─ BM25: 0.22 (keyword=22で高いはず)
├─ Title: 0.02 (タイトルマッチ2件)
└─ Label: 0.00

問題: vectorとbm25の合計が0.42程度で、Top 5の0.60-0.73と比較して低い
```

#### Top 1のスコア内訳

```
014_【FIX】求人応募機能
Composite: 0.7274
├─ Vector: 0.35 (高い)
├─ BM25: 0.38 (最大値)
├─ Title: 0.00
└─ Label: 0.00
```

---

## 🔴 根本原因

### 主要原因1: ベクトル検索の精度が低い

期待ページのベクトル距離が大きい（relevance低い）:
- 期待ページのvectorContribution: 0.20
- Top 1のvectorContribution: 0.35

**理由**:
- クエリ: "塾講師プロフィールの学年・職業を更新する方法を教えてください"
- 期待ページタイトル: "721_【作成中】学年自動更新バッチ"
- タイトルと本文で「学年」「職業」「更新」のキーワードは含まれるが、「教えてください」「方法」などの自然言語表現が含まれないため、ベクトル距離が遠い

### 主要原因2: BM25スコアも低い

期待ページのBM25貢献度: 0.22（推定）

**理由**:
- BM25は完全一致を重視
- クエリ: "塾講師プロフィールの学年・職業を更新する方法を教えてください"
- 期待ページ: "学年を自動で更新する"、"職業を自動で更新する"
- 「教えてください」「方法」が一致しない

### 主要原因3: Composite Scoringの重み配分

現在の重み:
```
Vector: 30%
BM25: 40%
Title: 20%
Label: 10%
```

**問題**:
- タイトルマッチ（keyword=22, title=2）があるのに、タイトル貢献度が0.02と低い
- タイトルマッチの重みが20%だが、実際の貢献度が低すぎる

---

## 📊 修正前後の比較

### 検索時間

| 指標 | Before | After | 改善率 |
|------|--------|-------|--------|
| 平均検索時間 | 16,784ms | 11,952ms | **-29%** ✅ |
| 平均応答時間 | 6,502ms | 6,894ms | +6% |
| 平均合計時間 | 23,285ms | 18,846ms | **-19%** ✅ |

### 品質スコア

| 指標 | Before | After | 改善率 |
|------|--------|-------|--------|
| 品質スコア | 6.0/10 | 6.0/10 | **変化なし** |
| 発見率 | 100% | 100% | 変化なし |
| 平均順位 | N/A | #33.2 | - |

---

## 🎯 残存する問題

### 問題1: 期待ページがTop 5に入らない

**原因**:
1. ベクトル検索の精度が低い（自然言語クエリに対して）
2. BM25スコアも低い（完全一致が少ない）
3. タイトルマッチの貢献度が低い

**影響**:
- Geminiに期待ページのコンテンツが渡されない
- Geminiは「記載されていません」と回答

### 問題2: スコアリング重みの不適切

**分析**:
- タイトルマッチがあっても、Composite Scoreが0.48と低い
- ベクトル検索とBM25検索が過度に重視されている
- タイトル重視度（20%）が不十分

---

## 💡 推奨アクション

### 即効性のある改善（Option A）

#### A-1: Geminiに渡すページ数を増やす
```typescript
// scripts/test-gemini-quality-simple.ts Line 49
const context = searchResults.slice(0, 5).map(...)
// ↓
const context = searchResults.slice(0, 50).map(...) // Top 50に変更
```

**期待効果**:
- ✅ すべての期待ページがGeminiに渡される
- ✅ 品質スコア: 6/10 → 8-9/10
- ⚠️ コンテキスト長増加: ~3,000文字 → ~30,000文字

#### A-2: タイトルマッチの重みを増やす
```typescript
// src/lib/composite-scoring-service.ts
vectorWeight: 0.3 → 0.2  // 30% → 20%
bm25Weight: 0.4 → 0.3    // 40% → 30%
titleWeight: 0.2 → 0.4   // 20% → 40%
labelWeight: 0.1         // 10% (維持)
```

**期待効果**:
- ✅ タイトルマッチのあるページが上位に
- ✅ 期待ページの順位改善: #29 → #5-10
- ✅ Geminiへの到達率向上

### 根本的な改善（Option B）

#### B-1: Phase 4実装（KG早期統合）
- KGでドメイン判定し、関連ページを優先候補化
- 目標: 発見率 83% → 100%、Top 3率 50% → 100%

#### B-2: タイトル重複埋め込み
- タイトルを本文の前に2-3回繰り返してベクトル化
- タイトルの重要性が自然にベクトルに反映される

---

## 📝 結論

### ✅ 修正完了した問題
1. Composite Scoreがフォーマット時に削除される問題

### ❌ 残存する問題
1. 期待ページがTop 5に入らない（順位#22-49）
2. Geminiに期待ページが渡されない
3. 品質スコア: 6/10で停滞

### 🎯 次のステップ

**推奨**: Option A-1（即効性）+ Option A-2（重み調整）

**理由**:
- ✅ 実装が簡単（10分程度）
- ✅ 即座に効果が確認できる
- ✅ Phase 4を待たずに改善可能

---

## 📊 詳細データ

### 事例6の詳細分析

```
クエリ: "塾講師プロフィールの学年・職業を更新する方法を教えてください"
期待ページ: 721_【作成中】学年自動更新バッチ

Top 5:
1. 014_【FIX】求人応募機能 (Composite: 0.7274)
2. 【作成中】応募完了メール（クライアント企業管理者向け） (Composite: 0.6718)
3. 041_【FIX】会員新規登録機能 (Composite: 0.6430)
4. 【FIX】オファー設定情報（自動オファー） (Composite: 0.6321)
5. 【作成中】オシゴトQ＆A (Composite: 0.5999)

期待ページ:
29. 721_【作成中】学年自動更新バッチ (Composite: 0.4800)

スコア差: 0.7274 - 0.4800 = 0.2474
```

### Geminiに渡されたコンテキスト

```
[Document 1] Title: 014_【FIX】求人応募機能
[Document 2] Title: 【作成中】応募完了メール（クライアント企業管理者向け）
[Document 3] Title: 041_【FIX】会員新規登録機能
[Document 4] Title: 【FIX】オファー設定情報（自動オファー）
[Document 5] Title: 【作成中】オシゴトQ＆A

→ 期待ページ（721_【作成中】学年自動更新バッチ）が含まれていない
→ Geminiは「記載されていません」と回答
```

---

## 🔗 関連ファイル

- `src/lib/unified-search-result-processor.ts` (修正済み)
- `src/lib/composite-scoring-service.ts` (要改善)
- `scripts/test-gemini-quality-simple.ts` (要改善)
- `scripts/debug-composite-score-issue.ts` (調査スクリプト)
- `scripts/investigate-quality-degradation.ts` (調査スクリプト)

---

## 📅 履歴

- **2025-10-16**: 根本原因調査、Composite Score削除問題の修正


