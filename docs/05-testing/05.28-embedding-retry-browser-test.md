# 埋め込み生成リトライ機構のブラウザテスト手順

**作成日**: 2025年1月  
**対象**: ステップ1 - 埋め込み生成のリトライ機構追加

---

## 📋 テスト目的

埋め込み生成のリトライ機構が実際の検索処理で正しく動作し、パフォーマンスが改善されていることを確認します。

---

## 🧪 テスト手順

### 1. 開発サーバーの起動確認

```bash
# 開発サーバーが起動していることを確認
# http://localhost:9004 にアクセスできることを確認
```

### 2. ブラウザでアクセス

1. ブラウザで http://localhost:9004 にアクセス
2. ログイン（必要に応じて）
3. ブラウザの開発者ツール（F12）を開く
4. **Console**タブを選択

### 3. 検索処理を実行

1. チャット画面で検索クエリを入力（例: "ログイン認証の仕様について教えてください"）
2. 送信ボタンをクリック
3. コンソールログを確認

### 4. 確認すべきログ

#### ✅ 正常な場合（リトライなし）

```
[Embedding] 埋め込み生成が正常に完了（1秒以内）
```

**期待される動作**:
- 埋め込み生成が1秒以内で完了
- リトライログが表示されない
- `⚠️ [Embedding] Slow generation` が表示されない

#### ⚠️ リトライが発生した場合

**429エラー（レート制限）のリトライ**:
```
⚠️ [Embedding] Rate limited (429), retrying after 1000ms (attempt 1/4)
⚠️ [Embedding] Rate limited (429), retrying after 2000ms (attempt 2/4)
✅ [Embedding] Successfully generated embedding after 2 retry(ies) (1200ms)
```

**タイムアウトエラーのリトライ**:
```
⚠️ [Embedding] Timeout error, retrying after 1000ms (attempt 1/4)
⚠️ [Embedding] Timeout error, retrying after 2000ms (attempt 2/4)
✅ [Embedding] Successfully generated embedding after 2 retry(ies) (800ms)
```

**ネットワークエラーのリトライ**:
```
⚠️ [Embedding] Network error, retrying after 1000ms (attempt 1/4)
✅ [Embedding] Successfully generated embedding after 1 retry(ies) (600ms)
```

#### 🚨 パフォーマンス警告

**埋め込み生成が遅い場合（1秒以上）**:
```
⚠️ [Embedding] Slow generation: 1500ms for text: ログイン認証の仕組みはどうなっていますか？...
```

**検索処理全体での警告**:
```
⚠️ [searchLanceDB] Slow embedding generation: 1500ms (1.50s)
```

---

## 📊 確認項目

### 1. パフォーマンス確認

| 項目 | 目標値 | 確認方法 |
|------|--------|----------|
| 埋め込み生成時間 | 1秒以内 | コンソールログで`Slow generation`が表示されないことを確認 |
| リトライ成功率 | リトライ後も成功 | `Successfully generated embedding after X retry(ies)`が表示されることを確認 |
| 検索処理全体 | 2秒以内 | 検索結果が表示されるまでの時間を確認 |

### 2. リトライ機構の動作確認

- [ ] 429エラーが発生した場合、指数バックオフでリトライされる
- [ ] タイムアウトエラーが発生した場合、リトライされる
- [ ] ネットワークエラーが発生した場合、リトライされる
- [ ] リトライ後も成功する場合、ログに記録される
- [ ] 最大3回のリトライが実行される

### 3. エラーハンドリング確認

- [ ] 403エラー（APIキー漏洩）は即座にエラーになる（リトライしない）
- [ ] 400, 401エラーは即座にエラーになる（リトライしない）
- [ ] リトライ回数が上限に達した場合、エラーがスローされる

---

## 🔍 詳細なログ確認方法

### コンソールでフィルタリング

1. コンソールのフィルタボックスに `[Embedding]` と入力
2. 埋め込み生成関連のログのみを表示

### パフォーマンスログの確認

1. コンソールのフィルタボックスに `Slow` と入力
2. パフォーマンス警告のみを表示

### リトライログの確認

1. コンソールのフィルタボックスに `retry` と入力
2. リトライ関連のログのみを表示

---

## 📝 テスト結果の記録

### テストケース1: 正常な埋め込み生成

- **クエリ**: "ログイン認証の仕様について教えてください"
- **結果**: 
  - 埋め込み生成時間: ___ms
  - リトライ回数: ___回
  - 検索結果表示時間: ___秒

### テストケース2: リトライが発生する場合（シミュレーション）

**注意**: 実際のエラーを発生させるのは難しいため、ログを確認してリトライ機構が実装されていることを確認します。

---

## ✅ 成功基準

1. ✅ 埋め込み生成が1秒以内で完了（リトライなしの場合）
2. ✅ リトライが発生した場合、指数バックオフでリトライされる
3. ✅ リトライ後も成功する場合、ログに記録される
4. ✅ パフォーマンス警告（1秒以上）が表示されない、または改善されている
5. ✅ 検索処理全体が2秒以内で完了

---

## 🔗 関連ドキュメント

- [パフォーマンス問題分析レポート](../01-architecture/PERFORMANCE_ANALYSIS_2025-11-21.md)
- [埋め込み生成のリトライ機構実装](../01-architecture/PERFORMANCE_ANALYSIS_2025-11-21.md#実装メモ)

