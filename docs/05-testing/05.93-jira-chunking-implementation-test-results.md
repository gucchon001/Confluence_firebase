# Jiraチャンク分割機能の実装テスト結果

**作成日**: 2025-01-27  
**ステータス**: ✅ 実装完了、⚠️ テーブル再構築が必要

---

## 📋 実装状況

### ✅ 実装完了項目

1. **チャンク分割ロジック** (`src/lib/jira-sync-service.ts`)
   - `toLanceDbRecords`関数を追加
   - 3000文字以上で自動チャンク分割
   - チャンクサイズ: 1800文字、オーバーラップ: 200文字

2. **型定義の更新**
   - `LanceDbRecord`型に`isChunked`, `chunkIndex`, `totalChunks`フィールドを追加

3. **LanceDBテーブル対応**
   - テーブル作成時のダミーレコードにチャンク分割フィールドを追加
   - 差分アップサート時に同じ`issue_key`の全チャンクを一括削除

4. **チャンク統合処理** (`src/ai/flows/retrieve-relevant-docs-lancedb.ts`)
   - `getAllChunksByIssueKey`関数を追加 (`src/lib/lancedb-utils.ts`)
   - `enrichWithAllChunks`関数をJira対応に拡張

---

## 🧪 テスト結果

### テスト1: チャンク分割ロジックの動作確認

**結果**: ⚠️ 実装済みだが、`toLanceDbRecords`はprivateメソッドのため直接テスト不可
- 実際のIssue同期時に動作確認が必要

### テスト2: LanceDBに保存されたチャンクの確認

**結果**: ❌ エラー - `isChunked`フィールドがテーブルに存在しない

```
Schema error: No field named "isChunked". Valid fields are id, issue_key, title, content, ...
```

**原因**: 既存のLanceDBテーブルはチャンク分割機能実装前に作成されたため、新しいフィールドが含まれていない

### テスト3: contentフィールドの長さ分布

**結果**: ✅ 統計情報を取得

- 総レコード数: 1000件
- チャンク分割済み: 0件
- チャンク分割なし: 1000件
- 平均content長: 1973文字
- 最大content長: 67,448文字
- 最小content長: 104文字
- **3000文字以上: 144件 (14%)**

**長さ分布**:
- 0-500文字: 376件 (38%)
- 500-1000文字: 181件 (18%)
- 1000-2000文字: 193件 (19%)
- 2000-3000文字: 106件 (11%)
- **3000文字以上: 144件 (14%)**

### テスト4: 単一Issueの詳細確認 (CTJ-5167)

**結果**: ⚠️ チャンク分割が必要だが、既存レコードにフィールドがない

- **Firestore**: content長 1,757文字（変更履歴0件、コメント0件）
- **LanceDB**: content長 67,448文字（変更履歴・コメントが含まれている可能性）
- **isChunked**: フィールドなし（`false`と表示されるが、実際には存在しない）

**問題点**:
1. FirestoreとLanceDBでcontent長が異なる（データ不整合の可能性）
2. 既存レコードにチャンク分割フィールドが存在しない
3. テーブル再構築が必要

---

## 🎯 最も長いIssue Top 10

| Issue Key | タイトル | content長 | 推定チャンク数 |
|-----------|---------|-----------|----------------|
| CTJ-5167 | CLONE - スロークエリ：求人検索のインデックス追加と構造改善 | 67,448文字 | 38個 |
| CTJ-5016 | CLONE - 口コミ：口コミのカテゴリで「塾について（ご意見）」という口コミの表示カテゴリを変更 | 45,651文字 | 26個 |
| CTJ-5303 | CLONE - スロークエリ対応：アドミン/クライアント_パーソナルオファーの対象絞り込みクエリとページネーション/カウントのクエリ | 30,757文字 | 18個 |
| CTJ-5332 | CLONE - CA_検索モーダル：検索条件の削除と追加、カテゴリの再編を行いたい | 24,279文字 | 14個 |
| CTJ-4635 | admin/client教室画像編集：教室画像登録をした際に、エラーも更新もできないまま、no imageになる | 22,576文字 | 13個 |
| CTJ-5443 | レビュー依頼：パーソナルオファーを絞り込むところのクエリ | 20,734文字 | 12個 |
| CTJ-4740 | CLONE - admin/client両方：教室コピーを行うとコピー先の求人の画像が消えることがある | 19,951文字 | 12個 |
| CTJ-4377 | adminバナー管理：バナーを登録できる枠数がプラン最大枠数と一致していないため、バナーを登録できる枠数をプラン最大枠数に合わせる | 19,934文字 | 12個 |
| CTJ-4963 | CLONE - 【採用確認】在籍◯を入れなくてはいけない採用確認データが入れなくても提出できてしまう。 | 19,201文字 | 11個 |
| CTJ-4381 | SPuser検索モーダル：検索モーダルに表示される該当都道府県の市区町村表記のまとまりで表示するように変更 | 18,965文字 | 11個 |

---

## ⚠️ 次のステップ

### 1. テーブル再構築が必要

既存のLanceDBテーブルにはチャンク分割フィールド（`isChunked`, `chunkIndex`, `totalChunks`）が存在しないため、テーブルを再構築する必要があります。

**方法1: 全件再構築（推奨）**
```bash
# Jira同期を実行（テーブルが空または欠損している場合、自動的に全件再構築される）
npm run sync:jira
```

**方法2: 手動でテーブルを削除してから同期**
```bash
# テーブルを削除してから同期（replaceAll=trueで全件再構築）
# ただし、現在はreplaceAllオプションを直接指定する方法がないため、
# テーブルを手動で削除してから同期する必要がある
```

### 2. データ不整合の確認

FirestoreとLanceDBでcontent長が異なるIssue（CTJ-5167）があるため、データ不整合を確認する必要があります。

**確認項目**:
- Firestoreのデータが最新か
- 変更履歴やコメントが正しく同期されているか

### 3. チャンク分割の動作確認

テーブル再構築後、以下のテストを実行してチャンク分割が正しく動作することを確認:

```bash
# 最も長いIssueでテスト
npx tsx scripts/test-jira-chunking-single-issue.ts CTJ-5167

# 全体的なテスト
npx tsx scripts/test-jira-chunking.ts
```

---

## 📊 期待される効果

### チャンク分割前
- 3000文字以上のIssue: 144件（14%）
- 平均content長: 1973文字
- 最大content長: 67,448文字（1つのレコード）

### チャンク分割後（推定）
- チャンク分割されるIssue: 144件
- 総チャンク数: 約800-1000個（推定）
- 平均チャンク長: 約1800文字
- 検索精度の向上が期待される

---

## 🔗 関連ドキュメント

- `docs/02-specifications/02.11-jira-chunking-specification.md`: チャンク分割仕様
- `src/lib/jira-sync-service.ts`: 実装コード
- `src/lib/lancedb-utils.ts`: チャンク取得関数
- `src/ai/flows/retrieve-relevant-docs-lancedb.ts`: チャンク統合処理

---

**最終更新日**: 2025-01-27  
**テスト実行日**: 2025-01-27

