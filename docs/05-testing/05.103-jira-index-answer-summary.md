# Jira LanceDBインデックスに関する回答まとめ

## 実施日
2025-01-28

## ユーザーの質問

> JiraのLanceDBインデックス等のことです。上がった本番データは正しいパフォーマンスと品質で使われるようになっていますか

## 回答

### ⚠️ 重要な問題

**現在、本番データにインデックスが含まれているかは、アップロード前の処理順序に依存します。**

### 現状の確認が必要

1. **ローカルデータのインデックス状態**
   - インデックスが作成されているか確認が必要
   - 確認方法: `npx tsx scripts/check-jira-index-status.ts`（新規作成）

2. **アップロード前の処理順序**
   - インデックス作成→アップロードの順序が重要
   - 順序を間違えると、インデックス未作成のデータがアップロードされる

### LanceDBインデックスの仕様

- **インデックスはテーブル内に埋め込まれる**
  - テーブルファイルと一緒にアップロードされる
  - インデックスを作成してからアップロードすれば、本番環境でも使用可能

- **インデックス作成が必要**
  - `createIndex()`メソッドで明示的に作成
  - データ追加だけでは自動的に作成されない

### 推奨される解決策

#### ✅ オプション1: 完全再構築スクリプトを使用（推奨）

```bash
# インデックス作成→アップロードまで自動的に実行
npm run sync:jira:rebuild
```

**メリット**:
- 正しい順序が保証される（データ同期→Lunr→インデックス作成→アップロード）
- インデックス作成が自動的に含まれる
- 全ての処理が一括で実行される

#### ✅ オプション2: 手動で順序を守る

```bash
# Step 1: Jiraデータ同期
npm run sync:jira

# Step 2: インデックス作成（アップロード前に必須）
npm run lancedb:create-indexes

# Step 3: GCSへのアップロード（インデックス含む）
npm run upload:jira-production-data
```

**注意**: 順序を間違えないようにしてください。

### 現在の状態の確認方法

#### 1. ローカルデータのインデックス状態を確認

```bash
# 新しく作成した確認スクリプト
npx tsx scripts/check-jira-index-status.ts
```

#### 2. インデックスが無い場合

インデックスを作成してからアップロード：

```bash
# インデックス作成
npm run lancedb:create-indexes

# アップロード（インデックス含む）
npm run upload:jira-production-data
```

### 本番環境でのパフォーマンスへの影響

#### インデックスが無い場合

- **検索パフォーマンスの大幅な低下**
  - ベクトル検索が遅くなる（フルスキャン）
  - スカラー検索（`issue_key`など）が遅くなる
  - レコード数が多い場合、タイムアウトの可能性

#### インデックスがある場合

- **最適な検索パフォーマンス**
  - ベクトル検索が高速（IVF_PQインデックス使用）
  - スカラー検索が高速（スカラーインデックス使用）
  - 本番環境で正しい品質が保証される

### 結論

#### ⚠️ 現在の状況

1. **完全再構築スクリプトを使用した場合**: ✅ インデックス含む
2. **通常のアップロードのみの場合**: ⚠️ インデックス未作成の可能性

#### ✅ 推奨されるアクション

1. **ローカルデータのインデックス状態を確認**
   ```bash
   npx tsx scripts/check-jira-index-status.ts
   ```

2. **インデックスが無い場合、作成してからアップロード**
   - 完全再構築スクリプトを使用（推奨）
   - または、手動でインデックス作成→アップロード

3. **今後は完全再構築スクリプトの使用を推奨**
   - 正しい順序が保証される
   - インデックス作成が自動的に含まれる

### ドキュメント

詳細は以下のドキュメントを参照してください：

- `docs/05-testing/05.101-jira-index-status-investigation.md` - インデックス状態の調査
- `docs/05-testing/05.102-jira-index-before-upload-requirement.md` - アップロード前のインデックス作成の必要性

