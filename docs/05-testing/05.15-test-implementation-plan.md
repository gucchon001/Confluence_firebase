# テスト実装計画

## 📋 概要

テストカバレッジ分析で特定された不足しているテスト項目の実装計画です。

## 🎯 実装優先順位

### 高優先度（即座に実装）

1. **認証・認可テスト** (`src/tests/api/auth.test.ts`)
   - Googleアカウント認証フロー
   - ドメイン制限（@tomonokai-corp.com）
   - セッション管理
   - 認証エラーハンドリング

2. **APIエンドポイントテスト** (`src/tests/api/endpoints.test.ts`)
   - `/api/streaming-process`のエラーハンドリング
   - `/api/admin/*`の認証・認可
   - 不正リクエストの処理
   - レート制限

3. **デプロイ前検証テスト** (`src/tests/deployment/pre-deployment.test.ts`)
   - 環境変数の検証
   - ビルドエラーの検出
   - 本番デプロイ準備

### 中優先度（次期実装）

4. **会話履歴・コンテキスト管理テスト** (`src/tests/integration/conversation-history.test.ts`)
   - 会話履歴の保存・取得
   - 深掘り質問のコンテキスト維持
   - Firestore統合

5. **セキュリティテスト** (`src/tests/security/security.test.ts`)
   - XSS/CSRF対策
   - APIキー管理
   - データ保護

6. **UI/UXテスト** (`src/tests/ui/ux.test.ts`)
   - マークダウン表示の正確性
   - 参照元リンクの動作
   - レスポンシブデザイン

### 低優先度（将来実装）

7. **拡張性テスト** (`src/tests/performance/scalability.test.ts`)
   - 大量データ処理
   - 同時接続数
   - リソース使用量

## 📝 実装ステップ

### ステップ1: テストディレクトリ構造の作成

```
src/tests/
├── api/                    # APIエンドポイントテスト（新規）
│   ├── auth.test.ts
│   ├── endpoints.test.ts
│   └── admin.test.ts
├── security/              # セキュリティテスト（新規）
│   ├── authentication.test.ts
│   ├── authorization.test.ts
│   └── data-protection.test.ts
├── deployment/            # デプロイテスト（新規）
│   ├── pre-deployment.test.ts
│   ├── env-validation.test.ts
│   └── build.test.ts
├── integration/           # 統合テスト（既存、拡張）
│   ├── conversation-history.test.ts
│   └── context-management.test.ts
└── ui/                    # UI/UXテスト（新規）
    ├── markdown.test.ts
    └── responsive.test.ts
```

### ステップ2: テストフレームワークの選定

- **ユニットテスト**: Vitest（既存）
- **統合テスト**: Vitest + カスタムヘルパー
- **E2Eテスト**: Playwright（既存）

### ステップ3: テスト実装

各テストファイルを順次実装します。

## 🔧 実装詳細

### 1. 認証・認可テスト

**ファイル**: `src/tests/api/auth.test.ts`

**テスト項目**:
- [ ] Googleアカウント認証が正常に動作する
- [ ] @tomonokai-corp.comドメインのユーザーのみアクセス可能
- [ ] 他のドメインのユーザーはアクセス拒否される
- [ ] セッションが正しく管理される
- [ ] 認証エラーが適切に処理される

### 2. APIエンドポイントテスト

**ファイル**: `src/tests/api/endpoints.test.ts`

**テスト項目**:
- [ ] `/api/streaming-process`が正常に動作する
- [ ] 不正なリクエストが適切に拒否される
- [ ] エラーハンドリングが正しく動作する
- [ ] タイムアウト処理が正しく動作する

### 3. デプロイ前検証テスト

**ファイル**: `src/tests/deployment/pre-deployment.test.ts`

**テスト項目**:
- [ ] 必須環境変数が設定されている
- [ ] 環境変数の型が正しい
- [ ] ビルドが正常に完了する
- [ ] 本番デプロイ準備が整っている

### 4. 会話履歴・コンテキスト管理テスト

**ファイル**: `src/tests/integration/conversation-history.test.ts`

**テスト項目**:
- [ ] 会話履歴が正しく保存される
- [ ] 会話履歴が正しく取得される
- [ ] 深掘り質問のコンテキストが維持される
- [ ] Firestore統合が正しく動作する

### 5. セキュリティテスト

**ファイル**: `src/tests/security/security.test.ts`

**テスト項目**:
- [ ] XSS攻撃が防がれる
- [ ] CSRF攻撃が防がれる
- [ ] APIキーが適切に管理されている
- [ ] データが適切に保護されている

## 📅 実装スケジュール

1. **Week 1**: 認証・認可テスト、APIエンドポイントテスト
2. **Week 2**: デプロイ前検証テスト、会話履歴テスト
3. **Week 3**: セキュリティテスト、UI/UXテスト

## 🚀 次のステップ

1. テストディレクトリ構造を作成
2. 認証・認可テストを実装
3. APIエンドポイントテストを実装
4. デプロイ前検証テストを実装

