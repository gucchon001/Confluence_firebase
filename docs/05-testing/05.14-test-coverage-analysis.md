# テストカバレッジ分析

## 📊 概要

現在のテストスイートが、システムの機能要件・非機能要件・ファイル・デプロイを適切にカバーしているかを分析した結果です。

## ✅ 現在テストされている項目

### 機能要件

| 要件ID | 機能名 | テスト状況 | テストファイル |
|--------|--------|-----------|---------------|
| USR-003 | 仕様の検索・要約 | ✅ 一部 | `classroom-deletion-issue-search-test.ts`, `keyword-quality-test.ts` |
| USR-008 | ストリーミング回答 | ✅ あり | `test-streaming-direct.ts` |
| SYS-001 | Confluenceデータ同期 | ✅ あり | `test-confluence-sync.ts` |
| SYS-002 | ベクトルデータベース更新 | ✅ あり | `check-lancedb-schema.ts` |
| SYS-003 | メタデータ一元管理 | ✅ あり | `test-firestore-labels-integration.ts` |
| SYS-005 | ハイブリッド検索エンジン | ✅ あり | `real-hybrid-search-test.ts`, `hybrid-search-components-test.ts` |

### 非機能要件

| 要件 | テスト状況 | テストファイル |
|------|-----------|---------------|
| パフォーマンス | ✅ あり | `test-api-performance.ts` |
| データ整合性 | ✅ あり | `check-lancedb-schema.ts`, `test-data-validation-all.ts` |
| デプロイ準備 | ✅ あり | `05.03-deployment-integration.md` |

## ❌ 不足しているテスト項目

### 機能要件（ユーザー向け機能）

| 要件ID | 機能名 | 不足しているテスト | 優先度 |
|--------|--------|-------------------|--------|
| USR-001 | Googleアカウント認証 | 認証フロー、ドメイン制限、セッション管理 | 高 |
| USR-002 | チャットインターフェース | UIコンポーネント、入力検証、エラーハンドリング | 高 |
| USR-004 | 参照元リンク表示 | リンクの正確性、アクセシビリティ、クリック動作 | 中 |
| USR-005 | 深掘り質問 | 会話コンテキストの維持、フォローアップ質問の処理 | 高 |
| USR-006 | 会話履歴の表示 | 履歴の取得、表示、削除、永続化 | 中 |
| USR-007 | 関連ページ表示 | 関連ページの検出、表示、リンク | 低 |
| USR-009 | マークダウン表示 | マークダウンの正規化、テーブル表示、コードブロック | 中 |
| USR-010 | ドメイン制限認証 | ドメイン検証、アクセス拒否、エラーメッセージ | 高 |

### 機能要件（システム・管理機能）

| 要件ID | 機能名 | 不足しているテスト | 優先度 |
|--------|--------|-------------------|--------|
| SYS-004 | ドメイン知識抽出・管理 | 抽出精度、データベース更新、検索への反映 | 中 |
| SYS-007 | Firestore統合 | 会話履歴の保存・取得、ユーザーデータ管理、メトリクス収集 | 高 |

### 非機能要件

| 要件 | 不足しているテスト | 優先度 |
|------|-------------------|--------|
| セキュリティ | 認証・認可、データ保護、APIキー管理、XSS/CSRF対策 | 高 |
| 可用性 | 障害時の動作、リトライ機構、エラーハンドリング | 中 |
| 拡張性 | 大量データ処理、同時接続数、リソース使用量 | 低 |
| UI/UX | レスポンシブデザイン、アクセシビリティ、ユーザビリティ | 中 |

### APIエンドポイント

| エンドポイント | 不足しているテスト | 優先度 |
|---------------|-------------------|--------|
| `/api/streaming-process` | エラーハンドリング、タイムアウト、不正リクエスト | 高 |
| `/api/search` | パラメータ検証、エラーレスポンス、レート制限 | 中 |
| `/api/feedback` | フィードバック保存、バリデーション | 低 |
| `/api/admin/*` | 認証・認可、権限チェック、セキュリティ | 高 |
| `/api/flow/[flow]` | Genkit Flow実行、エラーハンドリング | 中 |

### ファイル・データ整合性

| 項目 | 不足しているテスト | 優先度 |
|------|-------------------|--------|
| LanceDBファイル | ファイルの整合性、破損検出、バックアップ・復元 | 中 |
| Firestoreデータ | データの整合性、同期状態、バックアップ | 中 |
| インデックス | インデックスの整合性、再構築、パフォーマンス | 中 |

### デプロイ関連

| 項目 | 不足しているテスト | 優先度 |
|------|-------------------|--------|
| 環境変数 | 必須変数の検証、型チェック、デフォルト値 | 高 |
| ビルド | ビルドエラー、依存関係、バンドルサイズ | 高 |
| 本番デプロイ | デプロイ前検証、ロールバック、ヘルスチェック | 高 |
| データ移行 | マイグレーション、データ整合性、ロールバック | 中 |

## 🎯 推奨されるテスト追加

### 高優先度

1. **認証・認可テスト**
   - Googleアカウント認証フロー
   - ドメイン制限（@tomonokai-corp.com）
   - セッション管理
   - 認証エラーハンドリング

2. **APIエンドポイントテスト**
   - `/api/streaming-process`のエラーハンドリング
   - `/api/admin/*`の認証・認可
   - 不正リクエストの処理
   - レート制限

3. **会話履歴・コンテキスト管理テスト**
   - 会話履歴の保存・取得
   - 深掘り質問のコンテキスト維持
   - Firestore統合

4. **デプロイ前検証テスト**
   - 環境変数の検証
   - ビルドエラーの検出
   - 本番デプロイ準備

### 中優先度

1. **UI/UXテスト**
   - マークダウン表示の正確性
   - 参照元リンクの動作
   - レスポンシブデザイン

2. **データ整合性テスト**
   - LanceDBファイルの整合性
   - Firestoreデータの同期状態
   - インデックスの整合性

3. **セキュリティテスト**
   - XSS/CSRF対策
   - APIキー管理
   - データ保護

### 低優先度

1. **拡張性テスト**
   - 大量データ処理
   - 同時接続数
   - リソース使用量

2. **関連ページ表示テスト**
   - 関連ページの検出
   - 表示・リンク動作

## 📝 テスト実装の推奨事項

### 1. テストの体系化

現在のテストは個別のスクリプトとして実装されていますが、以下のような体系化を推奨します：

```
src/tests/
├── unit/              # ユニットテスト（既存）
├── integration/       # 統合テスト（既存）
├── e2e/              # E2Eテスト（既存）
├── api/              # APIエンドポイントテスト（新規）
│   ├── auth.test.ts
│   ├── streaming-process.test.ts
│   ├── search.test.ts
│   └── admin.test.ts
├── security/         # セキュリティテスト（新規）
│   ├── authentication.test.ts
│   ├── authorization.test.ts
│   └── data-protection.test.ts
├── deployment/       # デプロイテスト（新規）
│   ├── env-validation.test.ts
│   ├── build.test.ts
│   └── production-readiness.test.ts
└── data-integrity/   # データ整合性テスト（新規）
    ├── lancedb-integrity.test.ts
    ├── firestore-sync.test.ts
    └── index-consistency.test.ts
```

### 2. テストランナーの統合

現在のテストランナーを統合し、カテゴリごとに実行できるようにする：

```bash
# すべてのテストを実行
npm run test:all

# カテゴリごとに実行
npm run test:unit
npm run test:integration
npm run test:e2e
npm run test:api
npm run test:security
npm run test:deployment
npm run test:data-integrity
```

### 3. CI/CD統合

GitHub Actionsなどで自動実行：

```yaml
# .github/workflows/test.yml
- プルリクエスト時: ユニットテスト、統合テスト、型チェック
- マージ前: すべてのテスト、デプロイ前検証
- デプロイ後: 本番環境のヘルスチェック
```

## 🔍 現在のテストの問題点

1. **テストの目的が不明確**
   - 過去の寄せ集めのテストファイルが統合されているだけで、体系的なテスト設計がない
   - テストの目的と期待される結果が明確でない

2. **カバレッジの偏り**
   - 検索機能のテストは充実しているが、認証・認可、UI/UX、セキュリティのテストが不足
   - 非機能要件のテストが不十分

3. **テストの実行方法が統一されていない**
   - 個別のスクリプトとして実行する必要がある
   - テストランナーが複数存在し、どれを使うべきか不明確

4. **デプロイ前検証が不十分**
   - 環境変数の検証、ビルドエラーの検出、本番デプロイ準備のテストが不足

## 💡 改善提案

1. **テスト戦略の明確化**
   - 機能要件・非機能要件ごとにテストを分類
   - テストの目的と期待される結果を明確に定義

2. **テストカバレッジの向上**
   - 不足しているテスト項目を優先順位付けして実装
   - 特に認証・認可、APIエンドポイント、デプロイ前検証を優先

3. **テストの体系化**
   - テストをカテゴリごとに整理
   - テストランナーを統合し、実行方法を統一

4. **CI/CD統合**
   - 自動テスト実行の仕組みを構築
   - デプロイ前の自動検証を実装

## 📚 参考資料

- [システム全体仕様書](../02-specifications/02.01-spec.md)
- [Confluence検索システム仕様](../02-specifications/02.02-confluence-spec.md)
- [デプロイガイド](../04-operations/04.01-deployment-guide.md)

