# minInstances: 2 維持の決定 (2025-11-22)

**作成日**: 2025年11月22日  
**決定**: `minInstances: 2`を維持  
**ステータス**: ✅ **決定完了**

---

## 📋 決定内容

### `minInstances: 2`を維持する

**理由**:
1. **コールドスタート完全回避**（17秒の遅延削減）が最重要
2. **冗長性の向上**（1つのインスタンスがクラッシュしても、もう1つが処理を継続）
3. **パフォーマンスの安定性**（常に2つのインスタンスが起動し、負荷分散）

---

## 📊 現状の設定

```yaml
runConfig:
  minInstances: 2  # 維持（コールドスタート完全回避 + 冗長性向上）
  maxInstances: 4
  memoryMiB: 8192  # 8GB（メモリ制限エラーが発生している場合は増加を検討）
  cpu: 2
  concurrency: 1
  timeoutSeconds: 300
```

---

## 🎯 メモリ対策（`minInstances: 2`を維持する場合）

### 既に実施済みの対策 ✅

1. **キャッシュサイズの削減** ✅
   - 検索結果キャッシュ: `maxSize: 5000` → `maxSize: 2000`（60%削減）
   - タイトル検索キャッシュ: `maxSize: 1000` → `maxSize: 500`（50%削減）
   - 効果: キャッシュ関連のメモリ使用量を削減

2. **Jiraテーブルの遅延初期化** ✅
   - 起動時には`confluence`のみ初期化
   - `jira_issues`は検索リクエストが来た時にオンデマンドで初期化
   - 効果: メモリ使用量を約半分に削減（約12GB → 約6GB）

3. **メモリ警告閾値の調整** ✅
   - RSS増加閾値: 100MB → 500MB
   - Heap増加閾値: 50MB → 200MB
   - 効果: 正常なメモリ増加に対する警告を削減

---

## 🔍 今後の対策案

### 優先度1: **メモリ制限の増加** 🔴 **最優先（メモリ制限エラーが発生している場合）**

#### 現状

- `memoryMiB: 8192`（8GB）
- 実際の使用量: 8.2GB（制限超過）
- エラー: `Memory limit of 8192 MiB exceeded with 8206 MiB used`

#### 対策

- `memoryMiB: 8192` → `memoryMiB: 16384`（16GB）に増加

#### 期待効果

- メモリ制限エラーの解消
- 余裕を持ったメモリ使用が可能

#### リスク

- コストの増加（メモリ使用量に応じて課金される）
- ただし、`minInstances: 2`を維持する場合、メモリ制限を増やすことで安定性が向上

#### 実装場所

- `apphosting.yaml`

---

### 優先度2: **検索完了後のメモリ解放** 🟡 **中優先度**

#### 対策案

1. **明示的なメモリ解放**
   - 検索完了後に不要なデータを明示的に解放
   - 大きな配列を`null`に設定

2. **ガベージコレクションの促進**
   - 定期的にガベージコレクションを実行（開発環境のみ）

3. **定期的なキャッシュクリーンアップ**
   - 定期的に古いキャッシュエントリを削除
   - メモリ使用量が閾値を超えたらクリーンアップ

#### 期待効果

- 検索実行時のメモリ増加を約20-30%削減可能

---

### 優先度3: **メモリ監視とアラート** 🟡 **中優先度**

#### 対策案

1. **メモリ使用量の監視**
   - リアルタイムでメモリ使用量を監視
   - テーブルごとのメモリ使用量を記録

2. **アラート設定**
   - メモリ使用率が80%を超えたらアラート
   - メモリ制限に近づいたら警告

3. **自動スケーリング**
   - メモリ使用率に基づいて自動スケール

#### 期待効果

- 問題の早期発見と対応

---

## 📊 コスト比較

### `minInstances: 2`を維持する場合

| 項目 | 設定 | コスト |
|------|------|--------|
| インスタンス数 | 2 | 2倍 |
| メモリ | 8GB → 16GB（増加を検討） | 2倍 |
| **合計** | - | **約4倍**（メモリ増加時） |

### `minInstances: 1`に削減する場合

| 項目 | 設定 | コスト |
|------|------|--------|
| インスタンス数 | 1 | 1倍 |
| メモリ | 8GB | 1倍 |
| **合計** | - | **約1倍** |

**コスト削減効果**: 約75%削減（`minInstances: 1`の場合）

**ただし**:
- コールドスタートのリスク（17秒の遅延）
- 可用性の低下（冗長性が失われる）
- パフォーマンスの低下（トラフィック増加時のレイテンシ増加）

---

## 🎯 推奨事項

### `minInstances: 2`を維持する場合の推奨対策

1. **メモリ制限の増加**（最優先）
   - `memoryMiB: 8192` → `memoryMiB: 16384`（16GB）
   - メモリ制限エラーの解消

2. **既存の対策の継続**
   - キャッシュサイズの削減（実装済み）
   - Jiraテーブルの遅延初期化（実装済み）

3. **メモリ監視の強化**
   - リアルタイムでメモリ使用量を監視
   - アラート設定

---

## 🔗 関連ドキュメント

- [minInstances削減の影響範囲分析](./05.62-mininstances-impact-analysis-2025-11-22.md)
- [メモリ最適化計画](./05.60-memory-optimization-plan-2025-11-22.md)
- [開発環境メモリ最適化計画](./05.61-development-memory-optimization-2025-11-22.md)
- [緊急デプロイ手順 (2025-10-20)](../04-operations/04.09-emergency-deployment-20251020.md)

