# データ関連テスト

データの整合性、インデックス、ラベルの正確性を確認するテストです。

## 🚀 クイックスタート

### 推奨実行方法

個別テストを順次実行し、全て成功したら一括テストを実行：

```bash
# Windows（推奨）
scripts\run-data-validation-tests.bat

# 直接実行（推奨）
npx tsx src/tests/run-all-individual-tests.ts

# package.json経由（推奨）
npm run test:data-validation:individual
# または
npm run test:data-validation:all
```

このスクリプトは以下の処理を行います：
1. 7個の個別テストを順次実行（Confluenceのみ）
2. 全て成功した場合のみ一括テストを実行
3. 失敗した場合は詳細なエラー情報を表示

詳細な実行方法は [`TEST_EXECUTION_GUIDE.md`](./TEST_EXECUTION_GUIDE.md) を参照してください。

### 一括実行のみ

すべてのテストを一括実行する場合：

```bash
# 直接実行
npx tsx src/tests/test-data-validation-all.ts

# package.json経由
npm run test:data-validation
```

### 個別実行

個別のテストを実行する場合は、各テスト項目の「実行方法」セクションを参照してください。

## 📚 関連ドキュメント

テストを理解するために、以下のドキュメントを参照してください：

- **[LanceDB-Firestore統合設計](../01-architecture/01.02.01-lancedb-firestore-integration-design.md)**: LanceDBとFirestoreの統合設計
- **[構造化ラベル設計](../01-architecture/04.01.01-structured-label-design.md)**: 構造化ラベルの設計仕様
- **[LanceDB統合ガイド](../01-architecture/01.02.04-lancedb-integration-guide.md)**: LanceDBの統合方法と使用方法
- **[データフロー図](../01-architecture/01.01.01-data-flow-diagram-lancedb.md)**: LanceDBデータフロー図
- **[データ同期戦略](../04-operations/04.03-data-synchronization-strategy.md)**: データ同期戦略と定期実行スケジュール

## 📋 テスト項目

### 1. データベース整合性

#### 1.1 LanceDBスキーマ検証

**目的**: LanceDBのスキーマが正しく定義されているか確認

**実行方法**:
```bash
# LanceDBスキーマチェック（package.json経由）
npm run check:lancedb-schema
npm run check:production-lancedb-schema

# 直接スクリプト実行
npx tsx src/tests/check-lancedb-schema.ts
npx tsx scripts/check-lancedb-schema.ts
npx tsx scripts/check-production-lancedb-schema.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] スキーマが正しく定義されている
- [ ] 必須フィールドが存在する
- [ ] データ型が正しい
- [ ] インデックスが作成されている

#### 1.2 Firestoreラベル統合

**目的**: FirestoreからLanceDBへのラベル統合が正しく動作しているか確認

**実行方法**:
```bash
# Firestoreラベル統合チェック（package.json経由）
npm run check:firestore-structured-labels
npm run test:firestore-labels-integration

# 直接スクリプト実行
npx tsx src/tests/test-firestore-labels-integration.ts
npx tsx scripts/archive/check-scripts/check-firestore-structured-labels.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] Firestoreからラベルが取得できる
- [ ] ラベルがLanceDBに正しく統合されている
- [ ] StructuredLabelフィールドが正しく設定されている
- [ ] ラベルの更新が反映されている

### 2. インデックス検証

#### 2.1 LanceDBインデックス

**目的**: ベクトル検索用のインデックスが正しく作成されているか確認

**実行方法**:
```bash
# package.json経由
npm run lancedb:check-indexes
npm run debug:lancedb-index-status

# 直接スクリプト実行
npx tsx src/tests/test-lancedb-indexes.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] IVF_PQインデックスが作成されている
- [ ] インデックスのパラメータが適切
- [ ] インデックスの状態が正常

#### 2.2 Lunrインデックス

**目的**: キーワード検索用のLunrインデックスが正しく作成されているか確認

**実行方法**:
```bash
# package.json経由
npm run rebuild:lunr

# 直接スクリプト実行
npx tsx src/tests/test-lunr-index.ts
npx tsx src/tests/check-lunr-status.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] Lunrインデックスが作成されている
- [ ] インデックスの検索が正常に動作する
- [ ] インデックスの更新が反映されている

### 3. データ同期検証

#### 3.1 Confluence同期

**目的**: ConfluenceからLanceDBへの同期が正しく動作しているか確認

**実行方法**:
```bash
# package.json経由（実際の同期を実行）
npm run sync:confluence:differential

# テストスクリプト実行（読み取り専用確認）
npx tsx src/tests/test-confluence-sync.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] 新規ページが正しく同期される
- [ ] 更新されたページが正しく同期される
- [ ] 削除されたページが正しく処理される
- [ ] BOM文字が除去されている

#### 3.2 Jira同期

**目的**: JiraからLanceDBへの同期が正しく動作しているか確認

**実行方法**:
```bash
# テストスクリプト実行（読み取り専用確認）
npx tsx src/tests/test-jira-sync.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] 新規イシューが正しく同期される
- [ ] 更新されたイシューが正しく同期される
- [ ] イシューのフィールドが正しく保存される

### 4. ラベル管理検証

#### 4.1 ラベル生成

**目的**: 構造化ラベルの生成が正しく動作しているか確認

**実行方法**:
```bash
# package.json経由（実際のラベル生成を実行）
npm run label:generate

# テストスクリプト実行（読み取り専用確認）
npx tsx src/tests/test-label-generation.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] ラベルが正しく生成される
- [ ] ラベルの構造が正しい
- [ ] ラベルがFirestoreに保存される

#### 4.2 ラベルフィルタリング

**目的**: ラベルによるフィルタリングが正しく動作しているか確認

**実行方法**:
```bash
# package.json経由
npm run lancedb:verify

# テストスクリプト実行
npx tsx src/tests/test-label-filtering.ts

# 一括テスト実行
npx tsx src/tests/test-data-validation-all.ts
```

**確認項目**:
- [ ] ラベルフィルタが正しく適用される
- [ ] 会議ノートの除外が正しく動作する
- [ ] ラベルによる検索結果の絞り込みが正しく動作する

## 🔧 トラブルシューティング

テスト実行中に問題が発生した場合は、以下のドキュメントを参照してください：

- **[TEST_EXECUTION_GUIDE.md](./TEST_EXECUTION_GUIDE.md)**: 実行方法とトラブルシューティングの詳細
- **[TROUBLESHOOTING.md](./TROUBLESHOOTING.md)**: よくある問題と解決方法

## 📊 テスト結果

テスト結果は各テスト実行時に記録されます。重要な問題が発見された場合は、[`05.03-deployment-integration.md`](./05.03-deployment-integration.md)に記録してください。

### ベクトル検索テスト

ベクトル検索の詳細なテスト方法については、実装コードを参照してください。主な確認項目：

- [ ] ベクトル検索が正常に実行される
- [ ] 検索結果の距離が正しく計算される
- [ ] 検索結果の順位が適切

## 🔄 定期的な実行

以下のテストは定期的に実行することを推奨します：

- **データ整合性**: デプロイ前、データ更新後
- **インデックス検証**: インデックス再構築後
- **データ同期**: 同期処理実行後
- **ラベル管理**: ラベル更新後

