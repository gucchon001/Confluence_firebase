# Jira検索実装状況の分析結果

**作成日**: 2025年1月  
**ステータス**: 📋 分析完了

---

## 📋 概要

Jira検索時の実装状況を分析し、最低限の実装ができていない部分と、参照元が1件になる問題の原因を特定しました。

---

## 🔍 実装状況の確認結果

### ✅ 実装済み

1. **会話履歴管理**
   - ✅ `issue_key`と`dataSource`が保存される
   - ✅ 会話一覧でデータソースバッジが表示される

2. **基本的な検索機能**
   - ✅ ベクトル検索が動作する
   - ✅ BM25検索が動作する（Lunrインデックスが初期化済みの場合）
   - ✅ Jira特有フィールドが含まれる

---

### ❌ 最低限の実装ができていない部分

#### 1. タイトル救済検索（LIKE検索）

**現状**: ❌ 未実装

**確認方法**:
- `src/lib/lancedb-search-client.ts`の448-599行目を確認
- `tableName === 'jira_issues'`の場合のタイトル救済検索ロジックが存在しない

**影響**:
- タイトルが完全一致する課題が検索結果に含まれない可能性がある
- 検索精度が低下する

**実装箇所**:
- `src/lib/lancedb-search-client.ts`: 448-599行目付近
- `generateTitleCandidates`関数のJira対応

---

#### 2. 動的キーワード抽出

**現状**: ⚠️ 部分的に実装済み

**確認方法**:
- `src/lib/lancedb-search-client.ts`の247-257行目を確認
- `unifiedKeywordExtractionService.extractKeywordsConfigured`が呼ばれている

**問題点**:
- Jira特有のキーワード（ステータス、優先度、担当者など）の優先度が設定されていない
- ドメイン知識データベースからの抽出は動作しているが、Jira特有のキーワードが考慮されていない

**影響**:
- 検索精度が低下する可能性がある

**実装箇所**:
- `src/lib/unified-keyword-extraction-service.ts`
- Jira特有キーワードの優先度設定

---

#### 3. ラベルフィルタリング

**現状**: ⚠️ 部分的に実装済み

**確認方法**:
- `src/lib/lancedb-search-client.ts`の1426-1432行目（ベクトル検索）
- `src/lib/lancedb-search-client.ts`の707-717行目（BM25検索）

**問題点**:
- ラベルフィルタリングは実装されているが、Jira特有のラベル（ステータス、優先度など）のフィルタリングが考慮されていない
- 早期ラベルフィルタリングがJiraテーブルで動作していない可能性がある

**影響**:
- 不要な課題が検索結果に含まれる可能性がある

**実装箇所**:
- `src/lib/label-manager.ts`
- Jira特有ラベルのフィルタリングロジック

---

## 🐛 参照元が1件になる問題

### 原因1: 検索結果が1件しか返ってこない

**現状**:
- ベクトル検索: 1件
- BM25検索: 0件（Lunrインデックスが初期化中だったため）

**確認方法**:
```bash
npm run test:jira-reference-analysis
```

**ログ出力**:
```
[HybridSearchEngine] Vector results: 1, BM25 results: 0
[HybridSearchEngine] Final results: 1
✅ 検索結果: 1件
```

**原因**:
- Lunrインデックスの初期化が完了していない
- BM25検索がスキップされている

**影響**:
- 検索結果が少ないため、参照元も少なくなる

---

### 原因2: extractUsedReferenceIndicesが厳格すぎる

**現状**:
- 括弧内にタイトルが含まれている場合のみ抽出される
- Issue Keyのみが言及されている場合は抽出されない

**確認方法**:
```bash
npx tsx scripts/test-reference-extraction-logic.ts
```

**テスト結果**:
- テストケース1: 括弧内にタイトルがない → 0件抽出
- テストケース2: 括弧内にタイトルがある → 1件抽出
- テストケース4: Issue Keyのみ → 0件抽出

**原因**:
- `extractUsedReferenceIndices`のマッチングロジックが厳格
- 回答テキスト内の「（タイトル）」形式のパターンのみを検出

**影響**:
- LLMが括弧内にタイトルを明示的に言及しない場合、参照元が抽出されない
- その結果、`finalReferences`が1件（または0件）になる

---

### 原因3: finalReferencesのフィルタリングが厳格すぎる

**現状**:
- `extractUsedReferenceIndices`で抽出された参照元のみが`finalReferences`になる
- `enhanceReferences`で拡張された参照元も、`finalReferenceIds`でフィルタリングされる

**確認方法**:
- `src/ai/flows/streaming-summarize-confluence-docs.ts`の532-536行目を確認

**コード**:
```typescript
const finalReferenceIds = new Set(finalReferences.map((ref: any) => ref.id || ref.title));
const enhancedFinalRefs = enhanced.immediateReferences.filter((ref: any) => 
  finalReferenceIds.has(ref.id || ref.title)
);
```

**問題点**:
- `enhancedFinalRefs`が`finalReferenceIds`でフィルタリングされているため、`finalReferences`に含まれていない参照元は除外される
- `finalReferences`が1件の場合、`enhancedFinalRefs`も1件になる

**影響**:
- 検索結果が複数件あっても、表示される参照元が1件になる

---

## 🔧 解決策

### 優先度1: 検索結果を増やす（最優先）

**実装内容**:
1. Lunrインデックスの初期化を確実に完了させる
2. BM25検索が動作することを確認
3. 検索結果が少ない場合のフォールバックを追加

**実装箇所**:
- `src/lib/hybrid-search-engine.ts`: BM25検索の初期化待機ロジック
- `src/lib/lunr-initializer.ts`: 初期化完了の確認

**期待効果**:
- 検索結果が10件程度返ってくる
- 参照元も10件程度表示される

---

### 優先度2: extractUsedReferenceIndicesを改善

**実装内容**:
1. Issue Key（CTJ-XXXX形式）も検出できるようにする
2. 部分一致のマッチングを改善
3. タイトルが完全一致しない場合でも、キーワードベースでマッチング

**実装箇所**:
- `src/lib/markdown-utils.tsx`: `extractUsedReferenceIndices`関数

**期待効果**:
- 回答テキスト内のIssue Keyや部分一致でも参照元が抽出される
- 参照元が複数件抽出される

---

### 優先度3: finalReferencesのフォールバックを追加

**実装内容**:
1. `finalReferences`が1件以下の場合、上位N件（例: 3件）を強制的に残す
2. `allReferences`を表示に使用する（現在は`_allReferences`として保存されているが、表示には使用されていない）

**実装箇所**:
- `src/ai/flows/streaming-summarize-confluence-docs.ts`: 503-505行目付近

**期待効果**:
- 最低でも3件の参照元が表示される

---

### 優先度4: タイトル救済検索の実装

**実装内容**:
1. Jiraテーブル用のタイトル救済検索ロジックを実装
2. Issue Key（`id`フィールド）での検索に対応
3. タイトル（`title`フィールド）でのLIKE検索

**実装箇所**:
- `src/lib/lancedb-search-client.ts`: 448-599行目付近

**期待効果**:
- タイトルが完全一致する課題が検索結果に含まれる
- 検索精度が向上する

---

## 📊 実装チェックリスト

### 最低限の実装

- [ ] **タイトル救済検索**: Jiraテーブル用のLIKE検索を実装
- [ ] **動的キーワード抽出**: Jira特有キーワードの優先度設定
- [ ] **ラベルフィルタリング**: Jira特有ラベルのフィルタリング

### 参照元が1件になる問題の解決

- [ ] **検索結果を増やす**: BM25検索の動作確認と初期化待機ロジックの改善
- [ ] **extractUsedReferenceIndicesを改善**: Issue Key検出、部分一致改善
- [ ] **finalReferencesのフォールバック**: 1件以下の場合、上位N件を強制的に残す

---

## 🧪 次のステップ

1. **最優先**: 検索結果が1件しか返ってこない問題の調査と修正
2. **高**: extractUsedReferenceIndicesの改善（Issue Key検出、部分一致改善）
3. **中**: finalReferencesのフォールバック追加
4. **中**: タイトル救済検索の実装

---

## 🔗 関連ドキュメント

- [Jira品質向上実装計画](../02-specifications/02.05-jira-quality-improvement-plan.md)
- [参照元抽出ロジックの詳細分析](./05.76-jira-reference-analysis-results.md)
- [Confluence / Jira 仕様比較](../02-specifications/02.04-confluence-jira-comparison.md)

---

**最終更新**: 2025年1月  
**作成者**: AI Assistant  
**レビュー**: 未実施

