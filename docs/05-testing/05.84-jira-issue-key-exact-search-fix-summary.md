# Jira Issue Key完全一致検索の問題修正 - まとめ

**作成日**: 2025-01-27  
**ステータス**: 🔧 修正中

---

## 📋 問題の概要

Issue Key（例: `CTJ-5439`）で検索した場合、Issue Key完全一致の結果が最終的な検索結果に含まれない問題が発生していました。

---

## 🔍 調査結果

### 1. デバッグログが出力されない原因

**原因**: `NODE_ENV`が`undefined`だったため、`DEBUG_TITLE_SEARCH`が`false`になっていました。

**修正**: `DEBUG_TITLE_SEARCH`の条件を修正し、`NODE_ENV === undefined`の場合もデバッグログを有効化しました。

### 2. Issue Key完全一致の結果が失われる問題

**確認できたこと**:
1. ✅ Issue Key検出・検索は正常に動作
2. ✅ Issue Key完全一致の結果は追加されている（`Added 1 Issue Key exact match results`）
3. ✅ 先頭に配置されている（`1. CTJ-5439 - Issue Key Exact: true`）
4. ❌ しかし、Composite Scoring処理に入る前に失われている

**デバッグログから分かったこと**:
- タイトル救済検索でIssue Key完全一致の結果が追加される
- しかし、RRF Sort処理の前に失われている可能性がある
- Composite Scoring処理に入る時点で既に0件になっている

---

## 🔧 実装済みの修正

1. ✅ `DEBUG_TITLE_SEARCH`の条件修正（`NODE_ENV === undefined`の場合も有効化）
2. ✅ Issue Key完全一致を最優先にするソート処理を追加
   - Composite Scoring処理
   - 最終ソート処理
   - 重複除去処理（`deduplicateByPageId`関数）
3. ✅ Issue Key完全一致の結果を必ず含める処理を追加（上位50件への絞り込み時）
4. ✅ Composite Scoring処理でIssue Key完全一致のフラグを保持

---

## 📝 次のステップ

1. ⏳ RRF Sort処理前の処理でIssue Key完全一致の結果が失われていないか確認
2. ⏳ タイトル救済検索の結果が追加された後の処理フローを追跡
3. ⏳ Issue Key完全一致の結果が最終的な検索結果に含まれるようにする

---

## 🔗 関連ファイル

- `src/lib/lancedb-search-client.ts`: タイトル救済検索の実装（448-760行目）
- `src/lib/composite-scoring-service.ts`: Composite Scoring処理
- `scripts/test-jira-issue-key-exact-match.ts`: Issue Key完全一致検索テストスクリプト

