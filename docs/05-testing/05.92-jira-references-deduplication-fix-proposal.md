# Jiraå‚ç…§å…ƒé‡è¤‡å•é¡Œã®ä¿®æ­£æ¡ˆ

**ä½œæˆæ—¥**: 2025-01-27  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†

---

## ğŸ“‹ å•é¡Œã®æ¦‚è¦

Jiraæ¤œç´¢ã§å‚ç…§å…ƒãŒé‡è¤‡ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚åŸå› ã¯ã€`enhanceReferences`é–¢æ•°ã§æ—¢å­˜ã®å‚ç…§å…ƒã¨æ–°ã—ã„æ¤œç´¢çµæœã‚’çµåˆã™ã‚‹éš›ã«ã€é‡è¤‡é™¤å»ãƒ­ã‚¸ãƒƒã‚¯ãŒãªã„ã“ã¨ã§ã™ã€‚

---

## ğŸ” åŸå› åˆ†æ

### ç¾åœ¨ã®å®Ÿè£…

```typescript:301:301:src/lib/reference-enhancer.ts
  const immediateReferences = [...existingReferences, ...immediateResults];
```

ã“ã®å‡¦ç†ã¯å˜ç´”ã«é…åˆ—ã‚’çµåˆã—ã¦ã„ã‚‹ã ã‘ã§ã€é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã›ã‚“ã€‚

### é‡è¤‡ãŒç™ºç”Ÿã™ã‚‹ã‚±ãƒ¼ã‚¹

1. **åŒã˜Issue KeyãŒè¤‡æ•°ã®å½¢å¼ã§æ¤œå‡ºã•ã‚Œã‚‹**
   - æ‹¬å¼§å†…ã®ã‚¿ã‚¤ãƒˆãƒ«: ã€Œï¼ˆCTJ-4683: indeedã‚¨ãƒ³ãƒˆãƒªãƒ¼å¯¾å¿œï¼‰ã€
   - Issue Key: ã€ŒCTJ-4683ã€
   - ã©ã¡ã‚‰ã‚‚åŒã˜ãƒã‚±ãƒƒãƒˆã‚’æŒ‡ã—ã¦ã„ã‚‹ãŒã€ç•°ãªã‚‹å½¢å¼ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹

2. **`searchReferencesByTitles`ãŒè¤‡æ•°ä»¶è¿”ã™å¯èƒ½æ€§**
   - 1ã¤ã®ã‚¿ã‚¤ãƒˆãƒ«ã«å¯¾ã—ã¦æœ€å¤§3ä»¶ã®æ¤œç´¢çµæœã‚’è¿”ã™
   - åŒã˜å‚ç…§å…ƒãŒè¤‡æ•°ã®æ¤œç´¢çµæœã«å«ã¾ã‚Œã‚‹å¯èƒ½æ€§

3. **`findMissingTitles`ã®ãƒãƒƒãƒãƒ³ã‚°ãŒä¸å®Œå…¨**
   - ç•°ãªã‚‹å½¢å¼ã§åŒã˜å‚ç…§å…ƒãŒè¡¨ç¾ã•ã‚Œã¦ã„ã‚‹å ´åˆã€é‡è¤‡ã¨ã—ã¦æ¤œå‡ºã•ã‚Œãªã„

---

## ğŸ’¡ ä¿®æ­£æ¡ˆ

### 1. é‡è¤‡åˆ¤å®šé–¢æ•°ã®è¿½åŠ 

å‚ç…§å…ƒã®é‡è¤‡ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚æ—¢å­˜ã®`deduplicateByPageId`é–¢æ•°ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### 2. `enhanceReferences`é–¢æ•°ã®ä¿®æ­£

æ—¢å­˜ã®å‚ç…§å…ƒã¨æ–°ã—ã„æ¤œç´¢çµæœã‚’çµåˆã™ã‚‹å‰ã«ã€é‡è¤‡é™¤å»å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

---

## ğŸ”§ å®Ÿè£…å†…å®¹

### ã‚¹ãƒ†ãƒƒãƒ—1: é‡è¤‡åˆ¤å®šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®è¿½åŠ 

`src/lib/reference-enhancer.ts`ã«æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ ï¼š

```typescript
/**
 * å‚ç…§å…ƒã®é‡è¤‡åˆ¤å®šã‚­ãƒ¼ã‚’ç”Ÿæˆ
 * @param ref å‚ç…§å…ƒ
 * @param tableName ãƒ†ãƒ¼ãƒ–ãƒ«åï¼ˆ'confluence' ã¾ãŸã¯ 'jira_issues'ï¼‰
 * @returns é‡è¤‡åˆ¤å®šã‚­ãƒ¼
 */
function getReferenceDedupKey(ref: Reference, tableName: string): string {
  const isJira = tableName === 'jira_issues';
  
  if (isJira) {
    // Jiraã®å ´åˆ: issue_keyã§é‡è¤‡åˆ¤å®š
    const issueKey = (ref as any).issue_key || ref.id || '';
    return `jira:${issueKey}`;
  } else {
    // Confluenceã®å ´åˆ: idã¾ãŸã¯pageIdã§é‡è¤‡åˆ¤å®š
    const id = ref.id || (ref as any).pageId || '';
    return id || `url:${ref.url || ''}`;
  }
}

/**
 * å‚ç…§å…ƒãƒªã‚¹ãƒˆã‹ã‚‰é‡è¤‡ã‚’é™¤å»
 * @param references å‚ç…§å…ƒãƒªã‚¹ãƒˆ
 * @param tableName ãƒ†ãƒ¼ãƒ–ãƒ«åï¼ˆ'confluence' ã¾ãŸã¯ 'jira_issues'ï¼‰
 * @returns é‡è¤‡é™¤å»å¾Œã®å‚ç…§å…ƒãƒªã‚¹ãƒˆ
 */
function deduplicateReferences(
  references: Reference[],
  tableName: string = 'confluence'
): Reference[] {
  const dedupMap = new Map<string, Reference>();
  
  for (const ref of references) {
    const key = getReferenceDedupKey(ref, tableName);
    const existing = dedupMap.get(key);
    
    if (!existing) {
      // åˆå‡ºã®å‚ç…§å…ƒ
      dedupMap.set(key, ref);
    } else {
      // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€ã‚ˆã‚Šè‰¯ã„ã‚¹ã‚³ã‚¢ï¼ˆè·é›¢ãŒå°ã•ã„ï¼‰ã‚’å„ªå…ˆ
      const currentDistance = (ref as any).distance || 999;
      const existingDistance = (existing as any).distance || 999;
      
      if (currentDistance < existingDistance) {
        // ã‚ˆã‚Šè‰¯ã„ã‚¹ã‚³ã‚¢ã§ç½®ãæ›ãˆ
        dedupMap.set(key, ref);
      }
    }
  }
  
  const deduplicated = Array.from(dedupMap.values());
  
  // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
  if (process.env.NODE_ENV === 'development' && process.env.DEBUG_SEARCH === 'true') {
    if (deduplicated.length < references.length) {
      console.log(`[reference-enhancer] Deduplicated references: ${references.length} â†’ ${deduplicated.length} (removed ${references.length - deduplicated.length} duplicates)`);
    }
  }
  
  return deduplicated;
}
```

### ã‚¹ãƒ†ãƒƒãƒ—2: `enhanceReferences`é–¢æ•°ã®ä¿®æ­£

`enhanceReferences`é–¢æ•°å†…ã§é‡è¤‡é™¤å»ã‚’å®Ÿè¡Œï¼š

```typescript
export async function enhanceReferences(
  answer: string,
  existingReferences: Reference[],
  tableName: string = 'confluence',
  options: {
    maxSearches?: number;
    timeout?: number;
    enableBackgroundSearch?: boolean;
  } = {}
): Promise<{
  immediateReferences: Reference[];
  backgroundSearchTitles: string[];
}> {
  const {
    maxSearches = 5,
    timeout = 500,
    enableBackgroundSearch = true
  } = options;
  
  // å›ç­”å†…ã®å‚ç…§å…ƒè¨€åŠã‚’æŠ½å‡º
  const referencedTitles = extractReferencedTitles(answer);
  
  if (referencedTitles.length === 0) {
    return {
      immediateReferences: existingReferences,
      backgroundSearchTitles: []
    };
  }
  
  // ãƒãƒƒãƒãƒ³ã‚°ã§ããªã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
  const missingTitles = findMissingTitles(referencedTitles, existingReferences);
  
  if (missingTitles.length === 0) {
    return {
      immediateReferences: existingReferences,
      backgroundSearchTitles: []
    };
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã™ã‚‹å‚ç…§å…ƒã‚’å³åº§ã«æ¤œç´¢
  const immediateResults = await searchReferencesByTitles(
    missingTitles,
    tableName,
    maxSearches,
    timeout
  );
  
  // â˜…â˜…â˜… ä¿®æ­£: é‡è¤‡é™¤å»ã‚’è¿½åŠ  â˜…â˜…â˜…
  // æ—¢å­˜ã®å‚ç…§å…ƒã¨æ–°ã—ã„æ¤œç´¢çµæœã‚’çµåˆ
  const combinedReferences = [...existingReferences, ...immediateResults];
  
  // é‡è¤‡é™¤å»ã‚’å®Ÿè¡Œ
  const immediateReferences = deduplicateReferences(combinedReferences, tableName);
  
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ¤œç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹åˆ†ï¼‰
  // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã®ãƒªã‚¹ãƒˆã‚’è¿”ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ¤œç´¢ã‚’å®Ÿè¡Œ
  const backgroundSearchTitles: string[] = []; // ç¾åœ¨ã¯ç©ºï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
  
  return {
    immediateReferences,
    backgroundSearchTitles
  };
}
```

---

## âœ… æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

1. **é‡è¤‡é™¤å»**: åŒã˜å‚ç…§å…ƒãŒè¤‡æ•°å›è¡¨ç¤ºã•ã‚Œãªããªã‚‹
2. **å“è³ªå‘ä¸Š**: ã‚ˆã‚Šæ­£ç¢ºãªå‚ç…§å…ƒãƒªã‚¹ãƒˆã‚’æä¾›
3. **ä¸€è²«æ€§**: æ—¢å­˜ã®`deduplicateByPageId`é–¢æ•°ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: Jiraå‚ç…§å…ƒã®é‡è¤‡é™¤å»

```typescript
const references = [
  { title: 'CTJ-4683: indeedã‚¨ãƒ³ãƒˆãƒªãƒ¼å¯¾å¿œ', issue_key: 'CTJ-4683', url: '...', id: 'CTJ-4683' },
  { title: 'indeedã‚¨ãƒ³ãƒˆãƒªãƒ¼å¯¾å¿œ', issue_key: 'CTJ-4683', url: '...', id: 'CTJ-4683' },
  { title: 'CTJ-4683', issue_key: 'CTJ-4683', url: '...', id: 'CTJ-4683' }
];

const deduplicated = deduplicateReferences(references, 'jira_issues');
// æœŸå¾…çµæœ: 1ä»¶ï¼ˆåŒã˜issue_keyã¯1ã¤ã«çµ±åˆï¼‰
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: Confluenceå‚ç…§å…ƒã®é‡è¤‡é™¤å»

```typescript
const references = [
  { title: 'ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸', id: '12345', pageId: 12345, url: '...' },
  { title: 'ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ï¼ˆåˆ¥å½¢å¼ï¼‰', id: '12345', pageId: 12345, url: '...' }
];

const deduplicated = deduplicateReferences(references, 'confluence');
// æœŸå¾…çµæœ: 1ä»¶ï¼ˆåŒã˜idã¯1ã¤ã«çµ±åˆï¼‰
```

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `src/lib/reference-enhancer.ts`: ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `src/lib/lancedb-search-client.ts`: å‚è€ƒå®Ÿè£…ï¼ˆ`deduplicateByPageId`é–¢æ•°ï¼‰

---

## ğŸ“ å®Ÿè£…å¾Œã®ç¢ºèªäº‹é …

1. âœ… é‡è¤‡é™¤å»ãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹
2. âœ… Jiraã¨Confluenceã®ä¸¡æ–¹ã§æ­£ã—ãå‹•ä½œã™ã‚‹ã‹
3. âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ï¼ˆé‡è¤‡é™¤å»å‡¦ç†ã®ã‚³ã‚¹ãƒˆï¼‰
4. âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒé©åˆ‡ã«å‡ºåŠ›ã•ã‚Œã‚‹ã‹

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… ä¿®æ­£æ¡ˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. âœ… å®Ÿè£…
3. â³ ãƒ†ã‚¹ãƒˆ
4. â³ æœ¬ç•ªç’°å¢ƒã¸ã®åæ˜ 

---

## âœ… å®Ÿè£…å®Œäº†ï¼ˆ2025-01-27ï¼‰

### å®Ÿè£…å†…å®¹

ä»¥ä¸‹ã®ä¿®æ­£ã‚’`src/lib/reference-enhancer.ts`ã«å®Ÿè£…ã—ã¾ã—ãŸï¼š

1. **`getReferenceDedupKey`é–¢æ•°ã‚’è¿½åŠ **
   - Jiraã®å ´åˆ: `issue_key`ã§é‡è¤‡åˆ¤å®š
   - Confluenceã®å ´åˆ: `id`ã¾ãŸã¯`pageId`ã§é‡è¤‡åˆ¤å®š

2. **`deduplicateReferences`é–¢æ•°ã‚’è¿½åŠ **
   - å‚ç…§å…ƒãƒªã‚¹ãƒˆã‹ã‚‰é‡è¤‡ã‚’é™¤å»
   - ã‚ˆã‚Šè‰¯ã„ã‚¹ã‚³ã‚¢ï¼ˆè·é›¢ãŒå°ã•ã„ï¼‰ã‚’å„ªå…ˆçš„ã«ä¿æŒ
   - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’å‡ºåŠ›ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

3. **`searchReferencesByTitles`é–¢æ•°ã‚’ä¿®æ­£**
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµæœã®é‡è¤‡é™¤å»ã‚’è¿½åŠ ï¼ˆ209è¡Œç›®ï¼‰
   - æ¤œç´¢çµæœã®é‡è¤‡é™¤å»ã‚’è¿½åŠ ï¼ˆ308è¡Œç›®ï¼‰

4. **`enhanceReferences`é–¢æ•°ã‚’ä¿®æ­£**
   - æ—¢å­˜ã®å‚ç…§å…ƒã¨æ–°ã—ã„æ¤œç´¢çµæœã‚’çµåˆã—ãŸå¾Œã€é‡è¤‡é™¤å»ã‚’å®Ÿè¡Œï¼ˆ371è¡Œç›®ï¼‰

### ä¿®æ­£ç®‡æ‰€ã®è©³ç´°

```typescript:38:93:src/lib/reference-enhancer.ts
// é‡è¤‡åˆ¤å®šã‚­ãƒ¼ç”Ÿæˆé–¢æ•°ã¨é‡è¤‡é™¤å»é–¢æ•°ã‚’è¿½åŠ 
```

```typescript:209:210:src/lib/reference-enhancer.ts
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµæœã®é‡è¤‡é™¤å»
```

```typescript:307:308:src/lib/reference-enhancer.ts
// æ¤œç´¢çµæœã®é‡è¤‡é™¤å»
```

```typescript:366:371:src/lib/reference-enhancer.ts
// enhanceReferencesé–¢æ•°ã§ã®é‡è¤‡é™¤å»
```

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- âœ… åŒã˜å‚ç…§å…ƒãŒè¤‡æ•°å›è¡¨ç¤ºã•ã‚Œãªããªã‚‹
- âœ… Jiraã¨Confluenceã®ä¸¡æ–¹ã§æ­£ã—ãå‹•ä½œ
- âœ… æ—¢å­˜ã®`deduplicateByPageId`é–¢æ•°ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã€ä¸€è²«æ€§ã‚’ä¿æŒ

