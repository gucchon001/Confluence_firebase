# Jira検索時の会話履歴管理 動作確認手順

**作成日**: 2025年1月  
**ステータス**: ✅ 実装完了・動作確認待ち

---

## 📋 概要

Jira検索時の会話履歴管理機能が正しく動作することを確認する手順です。

---

## ✅ 実装状況

### 実装完了項目

1. ✅ **会話履歴保存**: `conversation-service.ts`で`issue_key`と`dataSource`が保存される
2. ✅ **フロントエンド**: `chat-page.tsx`で`searchSource`が`startStreaming`に渡される
3. ✅ **API**: `api/streaming-process/route.ts`で`dataSource`が設定される
4. ✅ **検索エンジン**: `hybrid-search-engine.ts`でJira検索結果に`issue_key`が含まれる

### 実装箇所

| ファイル | 行数 | 実装内容 |
|---------|------|---------|
| `src/lib/conversation-service.ts` | 94-99 | `issue_key`と`dataSource`の保存 |
| `src/components/chat-page.tsx` | 240, 614 | `searchSource`の管理と渡し |
| `src/app/api/streaming-process/route.ts` | 426-427, 655-656 | `dataSource`の設定 |
| `src/lib/hybrid-search-engine.ts` | 140-147, 243-250 | Jira特有フィールドの追加 |

---

## 🧪 動作確認手順

### 手順1: 開発環境の準備

```bash
# 開発サーバーを起動
npm run dev

# ブラウザで http://localhost:3000 を開く
# ログイン（Googleアカウント）
```

---

### 手順2: Jira検索の実行

1. **Jiraタブを選択**
   - チャット画面の上部で「Jira」タブをクリック
   - タブがアクティブ（青色）になることを確認

2. **検索クエリを入力**
   - 例: 「池田担当でステータスがまだ完了していないものは」
   - 入力フィールドにクエリを入力

3. **検索を実行**
   - Enterキーを押すか、送信ボタンをクリック
   - ストリーミングで回答が生成されることを確認

4. **検索結果を確認**
   - アシスタントメッセージが表示される
   - 参照元リンクにIssue Key（例: CTJ-1234）が表示される
   - 参照元リンクをクリックするとJiraの課題ページが開く

---

### 手順3: 会話履歴の確認

1. **会話履歴サイドバーを開く**
   - 画面左側のサイドバーを確認
   - 新しい会話が追加されていることを確認

2. **データソースバッジを確認**
   - 会話一覧で各会話にデータソースバッジが表示される
   - Jira検索の会話には「Jira」バッジが表示される

3. **会話を選択**
   - 会話をクリックして選択
   - 会話の内容が表示される

---

### 手順4: Firestoreデータの確認

1. **Firebase Consoleを開く**
   - https://console.firebase.google.com/ にアクセス
   - プロジェクトを選択

2. **Firestore Databaseを開く**
   - 左メニューから「Firestore Database」を選択

3. **会話データを確認**
   - `users/{userId}/conversations/{conversationId}` を開く
   - `messages`配列を確認

4. **アシスタントメッセージを確認**
   - `messages`配列から`role: 'assistant'`のメッセージを探す
   - `sources`配列を確認

5. **期待されるデータ構造**
   ```json
   {
     "role": "assistant",
     "content": "Jiraの課題を検索しました...",
     "sources": [
       {
         "title": "CTJ-1234: 応募移管機能の開発",
         "url": "https://giginc.atlassian.net/browse/CTJ-1234",
         "distance": 0.5,
         "source": "vector",
         "dataSource": "jira",
         "issue_key": "CTJ-1234"
       }
     ]
   }
   ```

---

### 手順5: 会話履歴からの再表示

1. **会話履歴から会話を選択**
   - サイドバーから先ほど作成した会話を選択
   - 会話の内容が表示される

2. **参照元リンクを確認**
   - アシスタントメッセージの参照元リンクを確認
   - Issue Keyが正しく表示される
   - リンクをクリックするとJiraの課題ページが開く

3. **データソースバッジを確認**
   - 各参照元リンクにデータソースバッジが表示される
   - Jiraの参照元には「Jira」バッジが表示される

---

### 手順6: 混合検索の確認

1. **Confluenceタブで検索**
   - 「Confluence」タブを選択
   - 検索クエリを入力して検索を実行

2. **同じ会話でJiraタブに切り替え**
   - 「Jira」タブを選択
   - 別の検索クエリを入力して検索を実行

3. **データソースバッジを確認**
   - 会話一覧でデータソースバッジが「Mixed」と表示される
   - 会話内の参照元リンクにConfluenceとJiraの両方が表示される

---

## 🔍 確認ポイント

### 必須確認項目

- [ ] Jira検索時に会話履歴が保存される
- [ ] 会話一覧にデータソースバッジ「Jira」が表示される
- [ ] アシスタントメッセージの参照元にIssue Keyが表示される
- [ ] 参照元リンクをクリックするとJiraの課題ページが開く
- [ ] Firestoreに`issue_key`と`dataSource: 'jira'`が保存される
- [ ] 会話履歴から会話を再表示できる
- [ ] 混合検索時にデータソースバッジが「Mixed」と表示される

### オプション確認項目

- [ ] 会話履歴のページネーションが正常に動作する
- [ ] 会話履歴の削除が正常に動作する
- [ ] 会話履歴のタイトル更新が正常に動作する

---

## 🐛 トラブルシューティング

### 問題1: 会話履歴が保存されない

**原因**:
- Firestoreのセキュリティルールが正しく設定されていない
- ユーザー認証が正しく行われていない

**対処法**:
1. Firebase Consoleでセキュリティルールを確認
2. ブラウザの開発者ツールでエラーを確認
3. ネットワークタブでFirestoreへのリクエストを確認

---

### 問題2: Issue Keyが表示されない

**原因**:
- Jira検索結果に`issue_key`が含まれていない
- フロントエンドで`issue_key`が正しく表示されていない

**対処法**:
1. ブラウザの開発者ツールで検索結果を確認
2. `api/streaming-process/route.ts`のログを確認
3. `hybrid-search-engine.ts`のログを確認

---

### 問題3: データソースバッジが表示されない

**原因**:
- `dataSource`が正しく設定されていない
- フロントエンドで`dataSource`が正しく表示されていない

**対処法**:
1. Firestoreで`dataSource`が保存されているか確認
2. `getDataSourceFromSources`関数の動作を確認
3. ブラウザの開発者ツールでエラーを確認

---

## 📝 テスト結果記録

### 実施日時
- **実施日**: 未実施
- **実施者**: 未実施
- **環境**: 開発環境 / 本番環境

### テスト結果

| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| Jira検索時に会話履歴が保存される | ⬜ 未実施 | |
| 会話一覧にデータソースバッジ「Jira」が表示される | ⬜ 未実施 | |
| アシスタントメッセージの参照元にIssue Keyが表示される | ⬜ 未実施 | |
| 参照元リンクをクリックするとJiraの課題ページが開く | ⬜ 未実施 | |
| Firestoreに`issue_key`と`dataSource: 'jira'`が保存される | ⬜ 未実施 | |
| 会話履歴から会話を再表示できる | ⬜ 未実施 | |
| 混合検索時にデータソースバッジが「Mixed」と表示される | ⬜ 未実施 | |

---

## 🔗 関連ドキュメント

- [Jira品質向上実装計画](../02-specifications/02.05-jira-quality-improvement-plan.md)
- [Jira検索時の会話履歴管理テスト](./05.74-jira-conversation-history-test.md)
- [Confluence / Jira 仕様比較](../02-specifications/02.04-confluence-jira-comparison.md)

---

**最終更新**: 2025年1月  
**作成者**: AI Assistant  
**レビュー**: 未実施

