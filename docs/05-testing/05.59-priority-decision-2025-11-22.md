# 優先度判断: パフォーマンス改善 vs メモリ対策 (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: 次のステップとして、パフォーマンス改善をさらに進めるか、メモリ消費対策を行うかの判断

---

## 📊 現状分析

### 1. パフォーマンス改善の現状 ✅

#### 達成状況

| 項目 | 改善前 | 改善後 | 改善率 | 目標 | 状態 |
|------|--------|--------|--------|------|------|
| 検索時間 | 2436ms | 382ms | **約84%削減** | 2000ms以下 | ✅ **目標達成** |
| 品質（順位） | 6位 | 4位 | **2位向上** | 10位以内 | ✅ **改善** |
| 総処理時間 | 2436ms | 943ms | **約61%削減** | - | ✅ **大幅改善** |

#### 評価

- ✅ **目標を大幅に上回る改善を達成**
- ✅ **品質も向上**（順位6位→4位）
- ✅ **ユーザー体験が大幅に改善**

#### さらなる改善の余地

- 検索時間: 382ms → さらに削減可能（推定: 300ms以下）
- AI生成時間: 13ms（改善後）→ 変動あり（3回目実行: 24720ms）
- 初回チャンク時間: 580ms → さらに削減可能

**期待効果**: 検索時間をさらに20-30%削減可能（推定）

---

### 2. メモリ使用量の現状 ⚠️

#### 問題の深刻度

| 項目 | 現状 | 影響 | 緊急度 |
|------|------|------|--------|
| 本番環境メモリ制限 | **8GB制限を超過** | 🔴 **クラッシュ・再起動** | 🔴 **高** |
| メモリ使用率（p99） | **52%**（11月19日） | ⚠️ 制限に近づいている | 🟡 **中** |
| 検索実行時のRSS増加 | **+283.82MB** | ⚠️ リクエストごとに増加 | 🟡 **中** |
| LanceDBメモリマップドファイル | **約12GB/テーブル** | 🔴 主要な問題 | 🔴 **高** |

#### メモリ使用量の内訳

```
1テーブル（confluence）: 約12GB
2テーブル（confluence + jira_issues）: 約24GB
2インスタンス × 2テーブル: 約48GB
```

#### 本番環境での問題

- **メモリ制限エラー**: `Memory limit of 8192 MiB exceeded with 8206 MiB used`
- **インスタンスクラッシュ**: メモリ制限超過により再起動
- **可用性への影響**: サービス停止のリスク

#### 対策の必要性

- 🔴 **緊急性**: 本番環境でクラッシュが発生している
- 🔴 **影響範囲**: 全ユーザーに影響
- 🔴 **リスク**: サービス停止の可能性

---

## 🎯 推奨事項

### 推奨: **メモリ消費対策を優先** 🔴

#### 理由

1. **緊急性が高い**
   - 本番環境でメモリ制限エラーが発生
   - インスタンスクラッシュのリスク
   - サービス停止の可能性

2. **影響範囲が広い**
   - 全ユーザーに影響
   - パフォーマンス改善は既に目標達成

3. **パフォーマンス改善は既に十分**
   - 検索時間: 2436ms → 382ms（約84%削減）✅
   - 目標（2000ms以下）を大幅に上回る改善
   - さらなる改善の優先度は低い

4. **メモリ対策の効果が大きい**
   - メモリ制限エラーの解消
   - サービス安定性の向上
   - コスト削減の可能性（インスタンス数の削減）

---

## 📋 メモリ対策の優先順位

### 優先度1: **LanceDBメモリマップドファイルの最適化** 🔴 **最優先**

**問題**:
- LanceDBメモリマップドファイル: 約12GB/テーブル
- 2テーブル: 約24GB
- 2インスタンス × 2テーブル: 約48GB

**対策案**:
1. **テーブル数の削減**: 不要なテーブルの初期化を避ける（既に実装済み）
2. **インスタンス数の削減**: `minInstances: 2` → `minInstances: 1`
3. **メモリマップドファイルの最適化**: 必要時のみ読み込む

**期待効果**: メモリ使用量を約50%削減可能

---

### 優先度2: **検索実行時のメモリ増加の最適化** 🟡 **中優先度**

**問題**:
- 検索実行時のRSS増加: +283.82MB
- リクエストごとにメモリが増加

**対策案**:
1. **キャッシュサイズの制限**: メモリ使用量を制限
2. **不要なデータの解放**: 検索完了後にメモリを解放
3. **バッチ処理の最適化**: メモリ使用量を削減

**期待効果**: 検索実行時のメモリ増加を約30-50%削減可能

---

### 優先度3: **メモリ監視とアラート** 🟡 **中優先度**

**対策案**:
1. **メモリ使用量の監視**: リアルタイムで監視
2. **アラート設定**: メモリ使用率が80%を超えたらアラート
3. **自動スケーリング**: メモリ使用率に基づいて自動スケール

**期待効果**: 問題の早期発見と対応

---

## 📊 比較表

| 項目 | パフォーマンス改善 | メモリ対策 |
|------|-------------------|-----------|
| **緊急度** | 🟡 低（目標達成済み） | 🔴 **高（クラッシュ発生）** |
| **影響範囲** | 🟡 中（ユーザー体験） | 🔴 **高（全ユーザー）** |
| **リスク** | 🟢 低 | 🔴 **高（サービス停止）** |
| **効果** | 🟡 中（20-30%削減） | 🔴 **大（50%削減可能）** |
| **実装難易度** | 🟡 中 | 🟡 中 |
| **推奨度** | 🟡 中 | 🔴 **高** |

---

## ✅ 結論

### 推奨: **メモリ消費対策を優先** 🔴

**理由**:
1. 本番環境でメモリ制限エラーが発生しており、緊急性が高い
2. パフォーマンス改善は既に目標を達成している
3. メモリ対策の効果が大きく、サービス安定性が向上する

**次のステップ**:
1. **LanceDBメモリマップドファイルの最適化**（優先度1）
2. **検索実行時のメモリ増加の最適化**（優先度2）
3. **メモリ監視とアラート**（優先度3）

---

## 🔗 関連ドキュメント

- [メモリ使用量分析レポート](../01-architecture/MEMORY_USAGE_ANALYSIS_2025-11-21.md)
- [現在のパフォーマンス問題分析](../01-architecture/CURRENT_PERFORMANCE_ISSUES_2025-11-21.md)
- [パフォーマンス改善効果の検証](./05.58-performance-improvement-verification-2025-11-22.md)

