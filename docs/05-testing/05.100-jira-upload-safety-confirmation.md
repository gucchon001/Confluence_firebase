# Jiraアップロード時の安全性確認

## 実施日
2025-01-28

## 確認項目と回答

### 1. インデックス作成への影響

#### ✅ 影響なし
- `upload-production-data.ts`は**インデックス作成を行いません**
- インデックス作成は別スクリプト `create-lancedb-indexes.ts` で実行
- `upload-production-data.ts`を実行しても、インデックス作成は自動実行されません

#### ⚠️ 注意点
- アップロード後、手動でインデックス作成が必要な場合があります
- `create-lancedb-indexes.ts`は全テーブル対象ですが、既存インデックスはスキップされるため安全です

### 2. Confluence同期への影響

#### ✅ 影響なし
- `upload-production-data.ts`は**Confluenceの同期を行いません**
- Confluence同期は別プロセス（`ConfluenceSyncService`、`sync-confluence.yml`）で実行
- `upload-production-data.ts`は既存のローカルデータをGCSにアップロードするのみ

### 3. ラベル処理への影響

#### ✅ 影響なし
- `upload-production-data.ts`は**ラベル処理を行いません**
- ラベル処理は別プロセス（`generate-jira-structured-labels.ts`、`generate-structured-labels.ts`）で実行
- `upload-production-data.ts`は既存のローカルデータをGCSにアップロードするのみ

### 4. Lunrキャッシュのアップロード

#### ✅ 改善済み
- **修正完了**: テーブルフィルターに対応しました
- `UPLOAD_TABLE_FILTER=jira_issues`の場合、Jira用のLunrキャッシュのみアップロード
- Confluence用のLunrキャッシュはアップロードされません

## upload-production-data.tsの動作

### 実行される処理
1. ✅ LanceDBテーブルをGCSにアップロード（フィルター対応）
2. ✅ LunrキャッシュをGCSにアップロード（フィルター対応）
3. ✅ 古いバージョンのファイルを削除（対象テーブルのみ）

### 実行されない処理
1. ❌ Confluence同期（別プロセス）
2. ❌ ラベル処理（別プロセス）
3. ❌ インデックス作成（別スクリプト）
4. ❌ データ同期（既存のローカルデータを使用）

## 結論

### ✅ 安全性の確認

1. **Confluence同期**: ✅ 影響なし
   - `upload-production-data.ts`はConfluence同期を実行しません
   - 別プロセスで実行されるため、完全に分離されています

2. **ラベル処理**: ✅ 影響なし
   - `upload-production-data.ts`はラベル処理を実行しません
   - 別プロセスで実行されるため、完全に分離されています

3. **インデックス作成**: ✅ 影響なし
   - `upload-production-data.ts`はインデックス作成を実行しません
   - 別スクリプトで実行されるため、分離されています
   - 手動実行が必要な場合は、`create-lancedb-indexes.ts`で全テーブル対象（既存インデックスはスキップ）

4. **Lunrキャッシュ**: ✅ フィルター対応済み
   - テーブルフィルターに応じて、該当するキャッシュのみアップロード
   - Confluence用のキャッシュはアップロードされません

## 実行手順（推奨）

### Jiraのみをアップロードする場合

```bash
# Step 1: JiraテーブルとJira用Lunrキャッシュをアップロード
npm run upload:jira-production-data

# Step 2（オプション）: インデックスを作成（全テーブル対象、既存インデックスはスキップ）
npm run lancedb:create-indexes
```

### 安全性の確保

1. ✅ Confluenceテーブルはアップロードされない（テーブルフィルターにより）
2. ✅ Confluence用Lunrキャッシュはアップロードされない（フィルター対応済み）
3. ✅ Confluence同期は影響を受けない（別プロセス）
4. ✅ ラベル処理は影響を受けない（別プロセス）
5. ✅ インデックス作成は既存インデックスをスキップ（安全）
