# Jira Issue Key完全一致検索 - 根本原因分析

**作成日**: 2025-01-27  
**ステータス**: 🔍 根本原因特定中

---

## 📋 問題の概要

Issue Key（例: `CTJ-5439`）で検索した場合、Issue Key完全一致の結果が最終的な検索結果に含まれない問題が発生しています。

---

## 🔍 ステップバイステップの追跡結果

### ステップ1: タイトル救済検索
- ✅ Issue Key完全一致の結果が追加される（`Added 1 Issue Key exact match results`）
- ✅ 先頭に配置される（`1. CTJ-5439 - Issue Key Exact: true`）
- ✅ `vectorResults`に追加される

**状態**: ✅ Issue Key完全一致の結果が存在（1件）

### ステップ2: ハイブリッドスコア処理
- ✅ Issue Key完全一致の結果が保持される（`After hybrid score processing: 30 results, Issue Key exact: 1`）
- ✅ `_issueKeyExact`フラグが保持される

**状態**: ✅ Issue Key完全一致の結果が存在（1件）

### ステップ3: BM25結果のマージ処理
- ❓ Issue Key完全一致の結果が失われる可能性がある
- ⚠️ BM25結果とマージする際に、`_issueKeyExact`フラグが失われている可能性

**確認が必要**: BM25結果のマージ処理（918-996行目）

### ステップ4: RRF処理前の絞り込み処理
- ❌ Issue Key完全一致の結果が失われる（`Before RRF sort: 42 results, Issue Key exact: 0`）
- ⚠️ RRF処理前の絞り込み処理（985-1006行目）で、Issue Key完全一致の結果が除外されている可能性

**状態**: ❌ Issue Key完全一致の結果が消失（0件）

### ステップ5: RRF処理
- ❌ Issue Key完全一致の結果が存在しない（`After RRF sort: 42 results, Issue Key exact: 0`）

**状態**: ❌ Issue Key完全一致の結果が存在しない（0件）

---

## 🎯 根本原因（推測）

Issue Key完全一致の結果は、**BM25結果のマージ処理（918-996行目）またはRRF処理前の絞り込み処理（985-1006行目）で失われています**。

特に、以下の可能性が高い：
1. **BM25結果のマージ処理**: BM25結果とマージする際に、Issue Key完全一致の結果が重複除去される可能性
2. **RRF処理前の絞り込み処理**: `slice(0, RRF_CANDIDATE_LIMIT)`で、Issue Key完全一致の結果が含まれていない可能性

---

## 🔧 次のステップ

1. ⏳ BM25結果のマージ処理でIssue Key完全一致の結果が失われていないか確認
2. ⏳ RRF処理前の絞り込み処理でIssue Key完全一致の結果が優先的に含まれるように修正

---

## 🔗 関連ファイル

- `src/lib/lancedb-search-client.ts`: 検索処理の実装（810-1006行目）

