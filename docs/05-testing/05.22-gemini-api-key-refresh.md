# Gemini APIキー更新後の反映確認

## 🚨 問題

Secret Managerに新しいGemini APIキーを追加しましたが、本番環境でまだエラーが発生しています。

## 確認事項

### 1. Secret Managerの最新バージョン確認

```powershell
gcloud secrets versions list gemini_api_key --project=confluence-copilot-ppjye --limit=5
```

最新バージョン（バージョン3）が2025-11-18T04:48:01に作成されていることを確認済み。

### 2. アプリケーションの再起動

Firebase App Hostingでは、Secret Managerの新しいバージョンは通常自動的に反映されますが、場合によってはインスタンスの再起動が必要です。

#### 方法1: Firebase Consoleから再デプロイ

1. [Firebase Console](https://console.firebase.google.com/project/confluence-copilot-ppjye/apphosting)にアクセス
2. 「App Hosting」を選択
3. 「再デプロイ」または「新しいビルドをトリガー」をクリック

#### 方法2: Git pushで再デプロイ

```powershell
# 空のコミットを作成して再デプロイをトリガー
git commit --allow-empty -m "trigger: 再デプロイ（Secret Manager更新反映）"
git push
```

#### 方法3: Firebase CLIから再デプロイ

```powershell
firebase deploy --only hosting
```

### 3. インスタンスの手動再起動

Firebase App Hostingのインスタンスを手動で再起動する方法：

1. [Google Cloud Console](https://console.cloud.google.com/run?project=confluence-copilot-ppjye)にアクセス
2. 「Cloud Run」を選択
3. `confluence-chat`サービスを選択
4. 「リビジョン」タブを選択
5. 最新のリビジョンを選択
6. 「再起動」をクリック

### 4. ログの確認

新しいAPIキーが使用されているか確認：

```powershell
# 最新のログを確認
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=confluence-chat" --project=confluence-copilot-ppjye --limit=50 --format=json
```

エラーメッセージに「API key expired」が含まれていないことを確認してください。

## トラブルシューティング

### エラーが続く場合

1. **Secret Managerの最新バージョンが正しく設定されているか確認**
   ```powershell
   gcloud secrets versions list gemini_api_key --project=confluence-copilot-ppjye
   ```

2. **新しいAPIキーが有効か確認**
   - [Google AI Studio](https://makersuite.google.com/app/apikey)でAPIキーの状態を確認
   - 新しいAPIキーが有効であることを確認

3. **アプリケーションの環境変数を確認**
   - Firebase Consoleで環境変数が正しく設定されているか確認
   - `GEMINI_API_KEY`が`secret: gemini_api_key`として設定されているか確認

4. **再デプロイを実行**
   - 上記の方法1、2、3のいずれかで再デプロイを実行

## 注意事項

- Secret Managerの新しいバージョンは、通常数分以内に自動的に反映されます
- ただし、既存のインスタンスが古いバージョンをキャッシュしている場合、再起動が必要です
- 新しいインスタンス（コールドスタート）では、常に最新のシークレットバージョンが使用されます

