# Jira検索時の参照元分析結果

**作成日**: 2025年1月  
**ステータス**: 📋 分析完了

---

## 📋 概要

Jira検索時に参照元が1件になる問題の原因を特定するため、詳細な分析を実施しました。

---

## 🔍 テスト結果

### テスト1: 検索結果が何件返ってくるか確認

**結果**: 
- ✅ 検索結果: **1件**
- ⚠️ ベクトル検索: 1件
- ⚠️ BM25検索: 0件（Lunrインデックスが初期化中だったため）

**問題点**:
- BM25検索が動作していない（Lunrインデックスの初期化が完了していない）
- ベクトル検索のみで1件しか返ってこない

---

### テスト2: extractUsedReferenceIndicesの動作確認

**テストケース1**: 回答内に参照元が明示的に言及されている場合
- ✅ 使用された参照元数: **2件**
- ✅ 正常に動作

**テストケース2**: 回答内に参照元が言及されていない場合
- ⚠️ 使用された参照元数: **0件**
- ⚠️ 括弧内にタイトルがないため、参照元が抽出されない

**テストケース3**: Issue Keyのみが言及されている場合
- ⚠️ 使用された参照元数: **0件**
- ⚠️ Issue Keyのみでは抽出されない（括弧内にタイトルが必要）

**問題点**:
- `extractUsedReferenceIndices`が厳格すぎて、括弧内にタイトルがないと参照元が抽出されない
- Issue Keyのみが言及されている場合も抽出されない

---

### テスト3: enhanceReferencesの動作確認

**結果**:
- ✅ 既存参照元数: 2件
- ✅ 拡張後参照元数: 2件
- ✅ 追加された参照元数: 0件

**問題点**:
- `enhanceReferences`は正常に動作しているが、既存の参照元が少ないため拡張されない

---

### テスト4: 参照元が1件になる問題の再現

**結果**:
- ✅ allReferences数: 3件
- ⚠️ 使用された参照元インデックス: [0]（1件のみ）
- ⚠️ 使用された参照元数: **1件**
- ⚠️ finalReferences数（extractUsedReferenceIndices後）: **1件**
- ✅ enhanced.immediateReferences数: 3件
- ⚠️ enhancedFinalRefs数: **1件**

**問題点**:
- `extractUsedReferenceIndices`が1件しか抽出しない
- `finalReferences`が1件になる
- `enhancedFinalRefs`も`finalReferenceIds`でフィルタリングされるため、1件になる

---

## 🐛 問題の原因

### 原因1: 検索結果が1件しか返ってこない

**現状**:
- ベクトル検索: 1件
- BM25検索: 0件（Lunrインデックスが初期化中）

**原因**:
- Lunrインデックスの初期化が完了していない
- BM25検索がスキップされている

**影響**:
- 検索結果が少ないため、参照元も少なくなる

---

### 原因2: extractUsedReferenceIndicesが厳格すぎる

**現状**:
- 括弧内にタイトルが含まれている場合のみ抽出される
- Issue Keyのみが言及されている場合は抽出されない

**原因**:
- `extractUsedReferenceIndices`のマッチングロジックが厳格
- 回答テキスト内の「（タイトル）」形式のパターンのみを検出

**影響**:
- LLMが括弧内にタイトルを明示的に言及しない場合、参照元が抽出されない
- その結果、`finalReferences`が1件（または0件）になる

---

### 原因3: finalReferencesのフィルタリングが厳格すぎる

**現状**:
- `extractUsedReferenceIndices`で抽出された参照元のみが`finalReferences`になる
- `enhanceReferences`で拡張された参照元も、`finalReferenceIds`でフィルタリングされる

**原因**:
- `enhancedFinalRefs`が`finalReferenceIds`でフィルタリングされているため、`finalReferences`に含まれていない参照元は除外される

**影響**:
- `finalReferences`が1件の場合、`enhancedFinalRefs`も1件になる

---

## 🔧 解決策

### 解決策1: 検索結果を増やす

**実装内容**:
1. Lunrインデックスの初期化を確実に完了させる
2. BM25検索が動作することを確認
3. 検索結果が少ない場合のフォールバックを追加

**優先度**: 高

---

### 解決策2: extractUsedReferenceIndicesを改善

**実装内容**:
1. Issue Key（CTJ-XXXX形式）も検出できるようにする
2. 部分一致のマッチングを改善
3. タイトルが完全一致しない場合でも、キーワードベースでマッチング

**優先度**: 高

---

### 解決策3: finalReferencesのフォールバックを追加

**実装内容**:
1. `finalReferences`が1件以下の場合、上位N件（例: 3件）を強制的に残す
2. `allReferences`を表示に使用する（現在は`_allReferences`として保存されているが、表示には使用されていない）

**優先度**: 中

---

### 解決策4: LLMプロンプトを改善

**実装内容**:
1. LLMプロンプトに「複数の参照元を括弧付きで明示的に言及する」ルールを追加
2. 回答生成時に、使用した参照元を必ず括弧付きで言及させる

**優先度**: 中

---

## 📊 実装優先順位

1. **最優先**: 検索結果を増やす（BM25検索の動作確認）
2. **高**: extractUsedReferenceIndicesを改善（Issue Key検出、部分一致改善）
3. **中**: finalReferencesのフォールバックを追加
4. **中**: LLMプロンプトを改善

---

## 🧪 次のステップ

1. **検索結果が1件しか返ってこない問題の調査**
   - BM25検索が動作しているか確認
   - Lunrインデックスの初期化が完了しているか確認

2. **extractUsedReferenceIndicesの改善**
   - Issue Key検出機能の追加
   - 部分一致のマッチング改善

3. **finalReferencesのフォールバック追加**
   - 1件以下の場合、上位N件を強制的に残す

4. **統合テスト**
   - 改善後の動作確認

---

## 🔗 関連ドキュメント

- [Jira品質向上実装計画](../02-specifications/02.05-jira-quality-improvement-plan.md)
- [参照元抽出ロジックの詳細分析](./test-reference-extraction-logic.md)

---

**最終更新**: 2025年1月  
**作成者**: AI Assistant  
**レビュー**: 未実施

