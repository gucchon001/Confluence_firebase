# パフォーマンステスト

応答速度、スループット、リソース使用率を測定するテストです。

## 📚 関連ドキュメント

テストを理解するために、以下のドキュメントを参照してください：

- **[TTFB最適化分析](./05.11-ttfb-optimization-analysis.md)**: 初回チャンク時間の最適化分析
- **[UI/UXパフォーマンス戦略](../01-architecture/05.01.01-ui-ux-performance-strategy.md)**: UI/UXパフォーマンス戦略
- **[ハイブリッド検索システム仕様](../01-architecture/02.01.02-hybrid-search-specification.md)**: ハイブリッド検索の完全仕様書
- **[データフロー図](../01-architecture/01.01.01-data-flow-diagram-lancedb.md)**: LanceDBデータフロー図

## 📋 テスト項目

### 1. APIパフォーマンステスト

#### 1.1 ストリーミング処理パフォーマンス

**目的**: ストリーミング処理のパフォーマンスを測定

**実行方法**:
```bash
npx tsx src/tests/test-api-performance.ts
```

**推奨実行方法**:
```bash
# パフォーマンステスト全体を実行（通常モード: キャッシュ有効）
npm run test:api-performance
# または
scripts\run-api-performance-tests.bat

# キャッシュ無効モードで実行（キャッシュをクリアしてから実行）
npm run test:api-performance -- --no-cache
```

**実行モード**:
1. **通常モード（デフォルト）**: キャッシュが有効な状態でテストを実行
   - 実際の運用環境に近い状態での測定
   - キャッシュヒットによる高速化が反映される

2. **キャッシュ無効モード（`--no-cache`）**: テスト開始前にキャッシュをクリアして実行
   - **キャッシュの影響を除外した真のパフォーマンスを測定**
   - コールドスタート時の性能評価に適している
   - 各クエリの前にキャッシュをクリアするため、常にキャッシュミス状態

**注意**: 以前の優秀な結果（検索時間215ms、AI生成時間206.60ms）は、**キャッシュが効いていた可能性が高い**ため、キャッシュ無効モードで再測定することを推奨します。

**前提条件**:
1. **開発サーバーが起動している必要があります**:
   ```bash
   npm run dev
   ```
   開発サーバーは `http://localhost:9004` で起動します。
   
   **重要**: サーバーが完全に起動し、"Ready in ..." が表示された後、さらに**10-20秒待機**してからテストを実行してください。初回ビルド後はウォームアップが必要です。

2. **推奨: ウォームアップリクエストを実行**:
   
   初回テストが遅くなるのを避けるため、パフォーマンステスト前に1-2回の検索リクエストを実行してキャッシュを構築することを推奨します：
   ```bash
   # ブラウザで http://localhost:9004 にアクセスし、簡単な検索を1-2回実行
   # または、curl でウォームアップリクエストを送信
   curl -X POST http://localhost:9004/api/streaming-process \
     -H "Content-Type: application/json" \
     -d '{"question":"テスト","chatHistory":[],"labelFilters":{"includeMeetingNotes":false}}'
   ```

3. **エラーが発生する場合の対処法**:
   - `Cannot find module './447.js'` などのエラーが発生した場合、Next.jsのビルドキャッシュが壊れている可能性があります
   - `.next` フォルダを削除して再起動してください:
     ```bash
     # Windows
     rmdir /s /q .next
     npm run dev
     
     # またはPowerShell
     Remove-Item -Recurse -Force .next
     npm run dev
     ```

**測定項目**:
- 検索時間
- AI生成時間
- ストリーミング時間
- 初回チャンク時間（TTFB）
- 総処理時間
- チャンク数
- 参照元数（フィルタリング前後）

**目標値**:
- 検索時間: 2秒以下
- AI生成時間: 15秒以下
- 初回チャンク時間: 5秒以下（現実的には8-10秒）
- 総処理時間: 20秒以下

**主要クエリ**:
1. 学年自動更新バッチの実行日時はいつですか？
2. 教室管理の詳細は
3. 会員登録機能について
4. 求人削除機能の手順
5. 応募管理の一覧閲覧機能

#### 1.2 検索パフォーマンス

**目的**: 検索処理のパフォーマンスを測定

**実行方法**:
```bash
npm run test:local-search-performance
npm run check:local-performance
```

**測定項目**:
- ベクトル検索時間
- BM25検索時間
- ハイブリッド検索時間
- 検索結果数

**目標値**:
- ベクトル検索: 1秒以下
- BM25検索: 500ms以下
- ハイブリッド検索: 2秒以下

### 2. 初回チャンク時間（TTFB）最適化

**詳細**: [`05.11-ttfb-optimization-analysis.md`](./05.11-ttfb-optimization-analysis.md)を参照

**現状**（最新テスト結果）:
- 平均初回チャンク時間: 16.0秒（目標: 5秒以下、超過: 11.0秒）
- 平均検索時間: 463.8ms（目標: 2000ms以下）✅
- 平均AI生成時間: 15736.6ms（目標: 15000ms以下、超過: 736.6ms）
- 主なボトルネック: **AI生成時間（97.1%）**

**根本原因**:
1. **非ストリーミング生成の使用**: `ai.generate()`が完全な回答が生成されるまで待機（約15-16秒）
2. **手動チャンク分割**: 完全な回答が生成された後、手動でチャンク分割して配信
3. **真のストリーミングではない**: ユーザーは完全な回答が生成されるまで待たなければならない

**最適化案**:
1. **真のストリーミング生成への移行**（最優先、高効果）
   - `ai.generateStream()`を使用してリアルタイムでチャンクを配信
   - 期待効果: 初回チャンク時間を3-5秒に短縮可能
2. プロンプトの最適化（コンテキスト削減）
3. ストリーミング生成の早期開始
4. キャッシュの活用

### 3. パフォーマンス改善計画

**詳細**: [`10-chatbot-performance-improvement-plan.md`](./10-chatbot-performance-improvement-plan.md)を参照

**改善策の優先順位**:
1. **LanceDBのインデックス最適化**（優先度：最高）
   - IVF_PQインデックスの作成
   - 期待効果: 検索時間の大幅短縮

2. **検索結果数の最適化**（優先度：高）
   - 取得件数の最適化
   - 期待効果: 処理時間の削減

3. **検索結果のキャッシュ**（優先度：中）
   - キャッシュヒット率の向上
   - 期待効果: 繰り返しクエリの高速化

4. **並列検索の実装**（優先度：中）
   - ベクトル検索とBM25検索の並列実行
   - 期待効果: 検索時間の短縮

5. **埋め込み生成の最適化**（優先度：中）
   - 埋め込み生成のキャッシュ
   - 期待効果: 検索時間の短縮

## 📊 テスト結果

### 最新のパフォーマンステスト結果（キャッシュ無効モード）

**実施日**: 2025-01-XX（キャッシュ無効モード: `--no-cache`）

**⚠️ 重要**: 2025-01-XXにテストコードの計測方法を修正しました。以前の結果は、サーバー初期化時間やTTFB（Time To First Byte）の時間も含まれていたため、検索時間が過大評価されていました。

**修正内容**:
- **修正前**: `searchTime = searchEndTime - totalStartTime`（リクエスト開始から検索完了まで）
- **修正後**: `searchTime = searchEndTime - searchStartTime`（検索開始から検索完了まで）
- これにより、サーバー初期化やTTFBの時間を除外し、純粋な検索処理時間のみを計測するようになりました

**平均値**（**真のパフォーマンス測定値**）:
- 検索時間: 276.60ms（目標: 2000ms以下）✅ **目標の約7.2倍高速**（修正後の計測方法）
- AI生成時間: 17620.80ms（目標: 15000ms以下、超過: 2620.80ms）⚠️ **目標の約17%超過**
- 初回チャンク時間: 17679.20ms（目標: 5000ms以下、超過: 12679.20ms）⚠️ **目標の約3.5倍**
- 総処理時間: 17907.60ms（目標: 20000ms以下）✅ **ぎりぎりクリア**

**注意**: 修正前の結果（検索時間: 3740.40ms）は、サーバー初期化やTTFBの時間が含まれていたため、実際の検索処理時間よりも大幅に長く計測されていました。

**時間内訳**:
- 検索時間: 276.60ms（1.5%）
- AI生成時間: 17620.80ms（98.4%）

**最大値**:
- 最大検索時間: 325ms ✅
- 最大AI生成時間: 30313ms ⚠️ **約30秒**
- 最大総処理時間: 30573ms ⚠️ **約31秒**

**評価**: ⚠️ **要改善** - AI生成時間と初回チャンク時間が目標値を超過

**チューニングが必要な項目**:
1. **AI生成時間**: 17620.80ms（目標: 15000ms以下、超過: 2620.80ms）
2. **初回チャンク時間**: 17679.20ms（目標: 5000ms以下、超過: 12679.20ms）

### チューニング方針

**決定**: **パフォーマンスは現状維持とする**

**理由**:
- 回答の品質を最優先に維持する
- MAX_CONTEXT_DOCSを15件に維持することで、包括的な回答が可能
- 現状のパフォーマンス（検索時間276.60ms、総処理時間17907.60ms）は許容範囲内

**現状のパフォーマンス評価**:
- ✅ 検索時間: 276.60ms（目標: 2000ms以下）✅ **優秀**
- ⚠️ AI生成時間: 17620.80ms（目標: 15000ms以下、超過: 2620.80ms）
- ⚠️ 初回チャンク時間: 17679.20ms（目標: 5000ms以下、超過: 12679.20ms）
- ✅ 総処理時間: 17907.60ms（目標: 20000ms以下）✅ **ぎりぎりクリア**

**結論**: 品質を優先し、パフォーマンスチューニングは将来の改善案として検討する

### 将来のチューニング案（参考）

**根本原因**: 現在の実装は**非ストリーミング生成**（`ai.generate()`）を使用しており、完全な回答が生成されるまで待機している（約17.6秒）。その後、手動でチャンク分割して配信しているため、初回チャンク時間が必然的に長くなる。

#### 優先度1（将来の改善案）: 真のストリーミング生成への移行 ⭐

**実装**: `ai.generateStream()`を使用してリアルタイムでチャンクを配信

**期待効果**:
- 初回チャンク時間: 17679.20ms → **3000-5000ms**（約70-80%改善）
- AI生成時間: 初回チャンクが早く到着するため、ユーザー体験が大幅に向上
- 目標値達成: 初回チャンク時間が5秒以下になる可能性が高い
- **品質への影響なし**（同じプロンプトとコンテキストを使用）

**実装難易度**: 中（ストリーミング処理の変更が必要）

**詳細**: [`05.11-ttfb-optimization-analysis.md`](./05.11-ttfb-optimization-analysis.md)を参照

#### 優先度2: プロンプトの最適化（コンテキスト削減）❌ **見送り**

**検討内容**: MAX_CONTEXT_DOCSを15件→8件に削減する案を検討

**見送り理由**:
- 回答の品質が低下する懸念がある
- 15件のドキュメントを使用することで、より包括的な回答が可能
- パフォーマンスよりも品質を優先

#### 優先度3: 検索結果数の最適化 ❌ **見送り**

**現状**: 検索結果15件を使用

**提案**: 上位8-10件に削減（検討のみ）

**トレードオフ**: 検索精度が若干低下する可能性がある

### 以前のパフォーマンステスト結果（参考）

#### キャッシュ有効状態の結果

**実施日**: 2025-01-XX（ウォームアップ後、**キャッシュ有効状態**）

**⚠️ 重要**: この結果は**キャッシュが効いている状態**での測定値です。キャッシュの影響を除外した真のパフォーマンスを測定する場合は、`--no-cache`オプションを使用してください。

**平均値**（**全ての目標値をクリア**）:
- 検索時間: 215.00ms（目標: 2000ms以下）✅ **目標の約9.3倍高速**
- AI生成時間: 206.60ms（目標: 15000ms以下）✅ **目標の約72.6倍高速** ⚠️ **キャッシュヒットの可能性**
- 初回チャンク時間: 215.20ms（目標: 5000ms以下）✅ **目標の約23.2倍高速** ⚠️ **キャッシュヒットの可能性**
- 総処理時間: 425.60ms（目標: 20000ms以下）✅ **目標の約47倍高速**

**評価**: 🎉 **優秀** - 全ての目標値を大幅に上回る性能を達成

**備考**: 
- ウォームアップリクエスト実行後、キャッシュが有効に機能している状態での測定結果
- AI生成時間が206.60msという異常に短い値は、**回答キャッシュ（AnswerCache）が効いている可能性が高い**
- **キャッシュ無効モードでの測定を推奨**: `npm run test:api-performance -- --no-cache`
- 実際の運用環境では初回アクセス時はやや遅くなる可能性があるが、2回目以降はこのレベルを維持できる

#### コールドスタート時の結果（.nextフォルダ削除後、ウォームアップ前）

**実施日**: 2025-01-XX（.nextフォルダ削除後）

**平均値**:
- 検索時間: 3463.60ms（目標: 2000ms以下、超過: 1463.60ms）⚠️
- AI生成時間: 16329.60ms（目標: 15000ms以下、超過: 1329.60ms）⚠️
- 初回チャンク時間: 19589.80ms（目標: 5000ms以下、超過: 14589.80ms）⚠️
- 総処理時間: 19797.20ms（目標: 20000ms以下）✅

**最大値**:
- 最大検索時間: 12574ms ⚠️
- 最大AI生成時間: 24213ms
- 最大総処理時間: 25253ms

**備考**: コールドスタート時（ウォームアップ前）の結果。キャッシュが効いていない状態。

#### 初期測定結果（.nextフォルダ削除前）

**実施日**: 2025-01-XX（.nextフォルダ削除前）

**平均値**:
- 検索時間: 463.8ms（目標: 2000ms以下）✅
- AI生成時間: 15736.6ms（目標: 15000ms以下、超過: 736.6ms）⚠️
- 初回チャンク時間: 16002.4ms（目標: 5000ms以下、超過: 11002.4ms）⚠️
- 総処理時間: 16206.2ms（目標: 20000ms以下）✅

**最大値**:
- 最大検索時間: 888ms
- 最大AI生成時間: 29721ms
- 最大総処理時間: 30342ms

### パフォーマンス改善の分析

**改善の要点**:
1. **ウォームアップ後の劇的な改善**:
   - 検索時間: 3463.60ms → 215.00ms（**約16倍高速化**）
   - AI生成時間: 16329.60ms → 206.60ms（**約79倍高速化**）
   - 初回チャンク時間: 19589.80ms → 215.20ms（**約91倍高速化**）
   - 総処理時間: 19797.20ms → 425.60ms（**約46倍高速化**）

2. **キャッシュの効果**:
   - ウォームアップリクエストにより、検索キャッシュやインデックスがメモリにロードされる
   - 2回目以降のリクエストは大幅に高速化される

3. **コールドスタート vs ウォームアップ**:
   - **コールドスタート**: 初回アクセス時は遅い（約20秒）
   - **ウォームアップ後**: 非常に高速（約0.4秒）
   - 実際の運用では、継続的に使用している限り、ウォームアップ後の性能を維持できる

**結論**: ウォームアップリクエストを実行することで、全ての目標値を大幅に上回る性能を達成できることが確認された。

## 🔄 定期的な実行

以下のテストは定期的に実行することを推奨します：

- **APIパフォーマンス**: パフォーマンス改善後、デプロイ後
- **検索パフォーマンス**: 検索アルゴリズム変更後、インデックス再構築後
- **TTFB最適化**: 初回チャンク時間の改善後

## 📈 パフォーマンス改善の追跡

パフォーマンス改善の進捗は、各テスト実行時に記録してください。重要な改善は [`05.11-ttfb-optimization-analysis.md`](./05.11-ttfb-optimization-analysis.md) に記録します。

## 🔍 パフォーマンス計測方法の改善

### ユーザー認識時間に基づく計測方法（2025-01-XX修正）

**方針**: ユーザーが質問を投げてから回答が返ってくるまでの認識時間に近い時間を計測

**計測方法**:
- **検索時間**: リクエスト送信開始（`totalStartTime`）から検索完了までの時間
  - サーバー初期化時間、TTFB、検索処理時間を含む
  - ユーザーが「検索中...」と表示されてから検索完了までの待機時間に相当
- **AI生成時間**: 検索完了からAI生成完了までの時間
  - 純粋なAI生成処理時間
  - ユーザーが「AIが回答を生成中...」と表示されてから完了までの時間に相当
- **初回チャンク時間**: リクエスト送信開始から最初のチャンク受信までの時間
  - ユーザーが最初の回答テキストを見るまでの待機時間
- **総処理時間**: リクエスト送信開始から完全な回答受信までの時間
  - ユーザーが質問を送信してから完全な回答を受け取るまでの総時間

**修正履歴**:
1. **初回修正**: サーバー側の処理時間のみを計測（TTFBを除外）
   - 問題: ユーザーが実際に感じる待機時間と乖離
2. **現在の修正**: ユーザー認識時間に基づく計測
   - リクエスト送信開始を起点として、各イベントまでの経過時間を計測
   - ユーザーが実際に感じる待機時間に近い値を提供

**詳細分析**: 初回アクセス時のパフォーマンス劣化の原因と改善方法については、[`05.12-performance-degradation-analysis.md`](./05.12-performance-degradation-analysis.md)を参照してください。

## 🔧 トラブルシューティング

### よくあるエラーと対処法

#### 1. HTTP 500エラー - `Cannot find module './447.js'` / `'./548.js'`

**症状**:
```
❌ 詳細エラー: HTTP error! status: 500 - Next.js Error Page: Cannot find module './447.js'
❌ 詳細エラー: HTTP error! status: 500 - Next.js Error Page: Cannot find module './548.js'
```

**原因**:
Next.jsのビルドキャッシュ（`.next`フォルダ）が壊れている、または古くなっている。Webpackチャンクファイルが見つからない。

**対処法**:
```bash
# Windows (PowerShell) - 推奨
Remove-Item -Recurse -Force .next
npm run dev

# Windows (コマンドプロンプト)
rmdir /s /q .next
npm run dev

# その後、別のターミナルでパフォーマンステストを実行
npm run test:api-performance
```

#### 1-2. HTTP 500エラー - `ENOENT: no such file or directory, open '...app-paths-manifest.json'`

**症状**:
```
❌ 詳細エラー: HTTP error! status: 500 - Next.js Error Page: ENOENT: no such file or directory, 
   open 'C:\\dev\\CODE\\Confluence_firebase\\.next\\server\\app-paths-manifest.json'
❌ 詳細エラー: HTTP error! status: 500 - Next.js Error Page: ENOENT: no such file or directory, 
   open 'C:\\dev\\CODE\\Confluence_firebase\\.next\\server\\app\\api\\streaming-process\\route.js'
```

**原因**:
Next.jsのビルドが不完全で、必要なファイルが生成されていない。開発サーバーが起動中にコードが変更された、またはビルドが中断された可能性がある。

**対処法**:
```bash
# 1. 開発サーバーを停止（Ctrl+C）

# 2. .nextフォルダを完全に削除
Remove-Item -Recurse -Force .next

# 3. 開発サーバーを再起動（ビルドが完了するまで待機）
npm run dev

# 4. ビルド完了を確認（"Ready in ..." が表示されるまで待つ）

# 5. 別のターミナルでパフォーマンステストを実行
npm run test:api-performance
```

**注意**: 開発サーバーが完全に起動する前にテストを実行すると、このエラーが発生します。ビルドが完了するまで待ってください。

#### 2. 開発サーバーが起動していない警告

**症状**:
```
⚠️  開発サーバーが起動していない可能性があります
   npm run dev を実行して開発サーバーを起動してください
```

**対処法**:
1. 別のターミナルで開発サーバーを起動:
   ```bash
   npm run dev
   ```
2. サーバーが完全に起動するまで待機（数秒〜数十秒）
3. `http://localhost:9004` にアクセスできることを確認
4. パフォーマンステストを再実行

#### 3. 一部のテストが成功し、一部が失敗する場合

**症状**:
- 最初の1-2つのテストは成功する
- その後のテストでエラーが発生する（`Cannot find module './XXX.js'` や `ENOENT`エラー）

**原因**:
開発サーバーのビルドが進行中で、必要なファイルがまだ生成されていない。または、開発サーバーが再ビルドをトリガーしている途中。

**対処法**:
1. 開発サーバーが完全に起動していることを確認（"Ready in ..." が表示されている）
2. 開発サーバーのログを確認し、ビルドエラーがないか確認
3. テストの実行間隔を空ける（各テストの間に数秒待機）
4. それでも解決しない場合は、`.next`フォルダを削除して再起動

#### 4. パフォーマンスが遅い / 以前より遅くなった場合

**症状**:
- 検索時間が異常に長い（例: 10秒以上）
- 以前のテスト結果と比較して大幅に遅化している

**原因**:
1. **コールドスタート**: `.next`フォルダ削除後の初回ビルドや、初回アクセス時のウォームアップ不足
2. **キャッシュがクリアされた**: 検索キャッシュやLunrインデックスが再構築されている
3. **開発サーバーのビルド最適化未適用**: 初回ビルドは最適化されていない

**対処法**:
```bash
# 1. ウォームアップリクエストを実行（パフォーマンステスト前）
# ブラウザで http://localhost:9004 にアクセスし、1-2回検索を実行

# または、curl でウォームアップリクエストを送信
curl -X POST http://localhost:9004/api/streaming-process \
  -H "Content-Type: application/json" \
  -d '{"question":"テスト","chatHistory":[],"labelFilters":{"includeMeetingNotes":false}}'

# 2. 開発サーバーの完全起動を待つ
# "Ready in ..." 表示後、さらに10-20秒待機

# 3. パフォーマンステストを実行（初回結果は除外可能）
npm run test:api-performance

# 4. 2回目以降のテスト結果を使用（より正確な測定値）
npm run test:api-performance
```

**注意**: `.next`フォルダを削除した直後の初回テストは、ウォームアップが完了していないため遅くなる可能性があります。

#### 5. すべてのテストが失敗する場合

**確認項目**:
1. **開発サーバーが起動しているか**: `http://localhost:9004` にアクセスできるか確認
2. **ポート9004でリッスンしているか**: `netstat -ano | findstr :9004` で確認
3. **`.next`フォルダを削除して再ビルドしたか**: ビルドエラーがないか確認
4. **環境変数が正しく設定されているか**: `.env.local` ファイルを確認
5. **開発サーバーのビルドが完了しているか**: サーバーログで "Ready in ..." を確認

**完全なリセット手順**:
```bash
# 1. 開発サーバーを停止（Ctrl+C）

# 2. .nextフォルダを削除
Remove-Item -Recurse -Force .next

# 3. node_modules/.cacheも削除（必要に応じて）
Remove-Item -Recurse -Force node_modules/.cache -ErrorAction SilentlyContinue

# 4. 開発サーバーを起動
npm run dev

# 5. ビルドが完全に完了するまで待機（"Ready in ..." が表示される）

# 6. 別のターミナルでパフォーマンステストを実行
npm run test:api-performance
```

