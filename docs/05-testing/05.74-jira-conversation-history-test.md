# Jira検索時の会話履歴管理テスト

**作成日**: 2025年1月  
**ステータス**: 📋 テスト実施中

---

## 📋 概要

Jira検索時に会話履歴が正しく保存され、再表示できることを確認するテストです。

---

## ✅ 実装確認

### 1. 会話履歴保存の実装

**ファイル**: `src/lib/conversation-service.ts`

- ✅ `issue_key`フィールドが保存される（97-99行目）
- ✅ `dataSource`フィールドが保存される（94-96行目）
- ✅ `getConversations`で`dataSource`が判定される（179行目）

### 2. フロントエンド実装

**ファイル**: `src/components/chat-page.tsx`

- ✅ `searchSource`が`'confluence' | 'jira'`として定義されている（240行目）
- ✅ `startStreaming`に`searchSource`が渡されている（614行目）
- ✅ `sources`に`issue_key`と`dataSource`が含まれている（498-503行目）

### 3. API実装

**ファイル**: `src/app/api/streaming-process/route.ts`

- ✅ `source`パラメータを受け取る（190行目）
- ✅ `dataSource`が設定される（427行目、656行目）
- ✅ Jira検索結果に`issue_key`が含まれる

---

## 🧪 テスト項目

### テスト1: Jira検索時に会話履歴が保存されること

**手順**:
1. チャット画面でJiraタブを選択
2. 「池田担当でステータスがまだ完了していないものは」と入力
3. 検索結果が表示されることを確認
4. 会話履歴サイドバーで会話が保存されていることを確認

**期待結果**:
- 会話履歴に新しい会話が追加される
- 会話タイトルが正しく表示される
- データソースバッジが「Jira」と表示される

---

### テスト2: issue_keyが正しく保存されること

**手順**:
1. テスト1で作成した会話を選択
2. アシスタントメッセージの参照元リンクを確認
3. Issue Key（例: CTJ-1234）が表示されることを確認

**期待結果**:
- 各参照元にIssue Keyが表示される
- Issue KeyをクリックするとJiraの課題ページが開く

---

### 测试3: dataSourceが"jira"として保存されること

**手順**:
1. テスト1で作成した会話を選択
2. ブラウザの開発者ツールでFirestoreを確認
3. `users/{userId}/conversations/{conversationId}`の`messages`配列を確認
4. アシスタントメッセージの`sources`配列を確認

**期待結果**:
- 各`source`オブジェクトに`dataSource: 'jira'`が含まれる
- 各`source`オブジェクトに`issue_key`が含まれる

---

### テスト4: 会話履歴からJira検索結果を再表示できること

**手順**:
1. テスト1で作成した会話を選択
2. 会話履歴から会話を再表示
3. 参照元リンクが正しく表示されることを確認
4. Issue Keyが正しく表示されることを確認

**期待結果**:
- 会話履歴から会話を再表示できる
- 参照元リンクが正しく表示される
- Issue Keyが正しく表示される
- リンクをクリックするとJiraの課題ページが開く

---

### テスト5: ConfluenceとJiraの混合検索結果が正しく保存されること

**手順**:
1. Confluenceタブで検索を実行
2. 同じ会話でJiraタブに切り替えて検索を実行
3. 会話履歴でデータソースバッジを確認

**期待結果**:
- データソースバッジが「Mixed」と表示される
- 各参照元に正しい`dataSource`が設定される
- Confluenceの参照元には`dataSource: 'confluence'`が設定される
- Jiraの参照元には`dataSource: 'jira'`と`issue_key`が設定される

---

## 🔍 実装確認チェックリスト

### コードレビュー

- [x] `conversation-service.ts`で`issue_key`が保存される
- [x] `conversation-service.ts`で`dataSource`が保存される
- [x] `chat-page.tsx`で`searchSource`が`startStreaming`に渡される
- [x] `api/streaming-process/route.ts`で`dataSource`が設定される
- [x] `api/streaming-process/route.ts`でJira検索結果に`issue_key`が含まれる

### 動作確認

- [ ] Jira検索時に会話履歴が保存される
- [ ] `issue_key`が正しく保存される
- [ ] `dataSource`が`'jira'`として保存される
- [ ] 会話履歴からJira検索結果を再表示できる
- [ ] ConfluenceとJiraの混合検索結果が正しく保存される

---

## 🐛 既知の問題

現在、既知の問題はありません。

---

## 📝 テスト結果

### 自動テスト

```bash
npm test -- conversation-history-jira.test.ts
```

**結果**: 未実施

### 手動テスト

**実施日**: 未実施  
**実施者**: 未実施  
**結果**: 未実施

---

## 🔗 関連ドキュメント

- [Jira品質向上実装計画](../02-specifications/02.05-jira-quality-improvement-plan.md)
- [Confluence / Jira 仕様比較](../02-specifications/02.04-confluence-jira-comparison.md)
- [会話履歴管理仕様](../01-architecture/01.02.03-firestore-integration-guide.md)

---

**最終更新**: 2025年1月  
**作成者**: AI Assistant  
**レビュー**: 未実施

