# Jiraタイトル救済検索実装報告

**作成日**: 2025-01-27  
**ステータス**: ✅ 実装完了

---

## 📋 実装概要

Jiraテーブル用のタイトル救済検索を実装しました。Confluenceで実装済みのタイトル救済検索機能をJiraにも適用し、検索精度の向上を図りました。

---

## 🔧 実装内容

### 1. タイトル救済検索の追加

**ファイル**: `src/lib/lancedb-search-client.ts`

**実装箇所**:
- 448-599行目: タイトル救済検索のロジック
- Jiraテーブル（`tableName === 'jira_issues'`）の場合の処理を追加

**機能**:
1. **Issue Key完全一致検索**:
   - クエリからIssue Keyパターン（`CTJ-XXXX`）を検出
   - Issue Keyが検出された場合、完全一致検索を実行
   - 結果を最優先（距離0.0）で返す

2. **タイトル（Summary）検索**:
   - キーワードからタイトル候補を自動生成
   - Lunr検索またはLIKE検索でタイトルマッチング
   - 結果を距離0.2で返す

### 2. Issue Key検出機能

- クエリからIssue Keyパターン（`CTJ-\d+`）を自動検出
- 検出されたIssue Keyをタイトル候補の先頭に追加
- Issue Keyは他のタイトル候補より優先的に処理

### 3. Jiraテーブル専用の処理分岐

- ConfluenceテーブルとJiraテーブルで処理を分岐
- Jiraテーブルでは`issue_key`（`id`フィールド）を使用
- Confluenceテーブルでは`page_id`を使用（既存ロジック）

---

## 🧪 テスト結果

### テストクエリ1: "indeed 対応の進捗はどうなっていますか"

**結果**:
- ✅ 検索結果: 30件
- ✅ タイトル救済検索の結果: **19件**
- ✅ ベクトル/BM25検索の結果: 11件
- ✅ 検索時間: 6264ms

**分析**:
- タイトル救済検索が正常に動作し、検索結果の63%（19/30件）を救済
- タイトル救済検索で見つかった課題には`_sourceType: 'title-exact'`が設定されている

### テストクエリ2: "応募者移管の進捗はどうなっていますか"

**結果**:
- ✅ 検索結果: 30件
- ✅ タイトル救済検索が正常に動作

### テストクエリ3: "CTJ-5439" (Issue Key)

**結果**:
- ⚠️  Issue Key完全一致検索は実装されているが、結果が他の検索結果と混ざってしまう問題
- 今後の改善が必要

### テストクエリ4: "最低賃金を下回る給与でも掲載できてしまう" (タイトル部分一致)

**結果**:
- ✅ 検索結果: 30件
- ✅ タイトル救済検索が正常に動作

---

## ✅ 実装完了項目

1. ✅ Jiraテーブル用のタイトル救済検索ロジックの実装
2. ✅ Issue Keyパターンの自動検出
3. ✅ Issue Key完全一致検索の実装
4. ✅ タイトル（Summary）検索の実装
5. ✅ Confluenceテーブルとの分岐処理

---

## ⚠️ 既知の課題

### Issue Key完全一致検索の問題

**問題**: Issue Keyで検索した場合、完全一致の結果が他の検索結果と混ざってしまい、正しいIssue Keyが返されない場合がある

**原因**:
- Issue Key検索の結果がタイトル救済検索の結果に追加されているが、最終的なソート時に優先順位が正しく反映されていない可能性
- ベクトル検索とBM25検索の結果が混ざってしまう

**対策**:
- Issue Key完全一致の結果を最優先（距離0.0）で設定済み
- 最終的な結果ソート時に、Issue Key完全一致の結果が最上位に来ることを確認

---

## 📊 パフォーマンス

- **検索時間**: 検索クエリによって異なる（600ms〜6000ms）
- **タイトル救済検索の効果**: 検索結果の約60%がタイトル救済検索で見つかっている

---

## 🔄 次のステップ

1. Issue Key完全一致検索の改善（優先順位の問題を解決）
2. Phase 2: 動的キーワード抽出の改善
3. Phase 3: ステータスベースのフィルタリング

---

## 📝 関連ファイル

- `src/lib/lancedb-search-client.ts`: タイトル救済検索の実装
- `scripts/test-jira-title-rescue-search.ts`: テストスクリプト
- `scripts/test-jira-issue-key-search.ts`: Issue Key検索テストスクリプト

