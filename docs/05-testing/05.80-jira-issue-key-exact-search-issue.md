# Jira Issue Key完全一致検索の問題と修正方針

**作成日**: 2025-01-27  
**ステータス**: ⚠️ 修正中

---

## 📋 問題の概要

Issue Key（例: `CTJ-5439`）で検索した場合、完全一致検索が実行されず、他の検索結果が返される問題が発生しています。

---

## 🔍 問題の詳細

### 現状

1. **Issue Key検出ロジック**: 実装済み（`src/lib/lancedb-search-client.ts` 461-476行目）
2. **Issue Key完全一致検索**: 実装済み（`src/lib/lancedb-search-client.ts` 505-527行目）
3. **RRFスコア設定**: 実装済み（Issue Key完全一致には`_rrfScore: 1.0`を設定）
4. **優先順位設定**: 実装済み（ソート時にIssue Key完全一致を最優先）

### 問題点

- Issue Key検出ログ（`Detected Issue Keys`）が表示されない
- Issue Key完全一致検索のログ（`Searching by Issue Key`）が表示されない
- 検索結果にIssue Key完全一致の結果が含まれていない

---

## 🧪 テスト結果

### テストクエリ: `CTJ-5439`

**期待される動作**:
- Issue Key `CTJ-5439` が検出される
- Issue Key完全一致検索が実行される
- Issue Key `CTJ-5439` の課題が最優先で返される

**実際の結果**:
- Issue Key検出ログが表示されない
- 検索結果に `CTJ-4901` などの他の課題が返される
- Issue Key完全一致の結果が含まれていない

---

## 🔧 原因分析

### 可能性1: タイトル候補生成がスキップされている

Issue Keyだけのクエリ（`CTJ-5439`）の場合：
- キーワード抽出が空になる可能性
- `generateTitleCandidates(finalKeywords)` が空配列を返す
- タイトル候補が空になり、タイトル救済検索がスキップされる

### 可能性2: Issue Key検出ロジックが実行されていない

Issue Key検出ロジックは、タイトル候補生成の**後**に実行されているため、タイトル候補が空の場合、Issue Key検出もスキップされる可能性がある。

---

## 💡 修正方針

### 修正案1: Issue Key検出をタイトル候補生成と独立させる

Issue Key検出をタイトル候補生成とは独立して実行し、Issue Keyが検出された場合、必ずタイトル救済検索を実行する。

```typescript
// 修正前: タイトル候補生成後にIssue Key検出
let titles = [...];
// Issue Key検出
if (isJiraTable) {
  const issueKeyMatches = params.query.match(/CTJ-\d+/i);
  // ...
}

// 修正後: Issue Key検出を先に実行
let detectedIssueKeys: string[] = [];
if (isJiraTable) {
  const issueKeyMatches = params.query.match(/CTJ-\d+/i);
  if (issueKeyMatches) {
    detectedIssueKeys = issueKeyMatches.map(m => m.toUpperCase());
  }
}

// タイトル候補生成
let titles = [...];

// Issue Keyを優先的に追加
if (detectedIssueKeys.length > 0) {
  titles = [...detectedIssueKeys, ...titles];
}

// Issue Keyが検出された場合、タイトル候補が空でも検索を実行
if (titles.length > 0 || detectedIssueKeys.length > 0) {
  // タイトル救済検索を実行
}
```

### 修正案2: Issue Key検索を別処理として分離

Issue Key検索をタイトル救済検索とは別の処理として実行し、結果を確実に最優先で返す。

```typescript
// Issue Key検索を別処理として実行
if (isJiraTable) {
  const issueKeyPattern = /^CTJ-\d+$/i;
  if (issueKeyPattern.test(params.query.trim())) {
    const issueKey = params.query.trim().toUpperCase();
    const issueRows = await tbl.query()
      .where(`\`id\` = '${issueKey}'`)
      .limit(1)
      .toArray();
    
    if (issueRows.length > 0) {
      // Issue Key完全一致の結果を最優先で返す
      return issueRows.map(row => ({
        ...row,
        _distance: 0.0,
        _rrfScore: 1.0,
        _sourceType: 'title-exact',
        _issueKeyExact: true
      }));
    }
  }
}
```

---

## ✅ 実装済みの修正

1. ✅ Issue Key検出をタイトル候補生成の前に実行
2. ✅ Issue Key完全一致検索の結果に`_rrfScore: 1.0`を設定
3. ✅ RRF融合処理でIssue Key完全一致の結果を保持
4. ✅ 最終的なソート時にIssue Key完全一致を最優先

---

## 📝 次のステップ

1. Issue Key検出ロジックの実行を確認
2. Issue Key検索が実際に実行されているかをデバッグログで確認
3. Issue Key検索の結果が正しくマージされているかを確認
4. 最終的なソート時にIssue Key完全一致が最優先になっているかを確認

---

## 🔗 関連ファイル

- `src/lib/lancedb-search-client.ts`: タイトル救済検索の実装
- `src/lib/unified-search-result-processor.ts`: RRF融合処理
- `scripts/test-jira-issue-key-search.ts`: Issue Key検索テストスクリプト
- `scripts/debug-jira-issue-key-search.ts`: Issue Key検索デバッグスクリプト

