# クエリ3 詳細分析 (2025-11-22)

**作成日**: 2025年11月22日  
**クエリ**: "会員登録機能について"  
**実行時刻**: 2025-11-22T10:22:24.262Z  
**ステータス**: ✅ **正常に動作**

---

## 📊 検索処理の時間内訳

### メイン検索処理

| 段階 | 時間 | 評価 |
|------|------|------|
| リクエスト受信から検索開始 | **27ms** | ✅ **正常** |
| ベクトル検索 | **198ms** | ✅ **正常** |
| BM25検索 | **473ms** | ✅ **正常** |
| 並列検索完了 | **475ms** | ✅ **正常** |
| searchLanceDB完了 | **1707ms** | ⚠️ **やや長い** |
| retrieveRelevantDocs完了 | **2408ms** | ⚠️ **やや長い** |
| 検索処理完了（ユーザー認識時間） | **2436ms** | ⚠️ **やや長い** |

### 検索パフォーマンスの内訳

```
[PERF] 🔍 Search performance breakdown: {
  searchLanceDB: '1707ms',
  enrichWithAllChunks: '319ms',
  filterInvalidPages: '354ms',
  total: '2397ms',
  query: '会員登録機能について'
}
```

**分析**:
- `searchLanceDB`: 1707ms
  - ベクトル検索: 198ms
  - BM25検索: 473ms
  - 並列検索完了: 475ms
  - その他（RRF、スコアリングなど）: 約1232ms
- `enrichWithAllChunks`: 319ms ✅ **正常**
- `filterInvalidPages`: 354ms ✅ **正常**
- 合計: 2397ms

---

## 🔍 詳細分析

### 1. **ベクトル検索** ✅ **正常**

```
[PERF] 🔍 Vector search completed in 198ms
```

**評価**: 目標1000ms以下 ✅ **正常**

---

### 2. **BM25検索** ✅ **正常**

```
[BM25 Search] ✅ BM25 search completed in 473ms, returning 30 results
```

**評価**: 目標2000ms以下 ✅ **正常**

**注意**: BM25初期化待機時間のログが表示されていないため、既に初期化済みの状態で実行されたと推測されます。

---

### 3. **並列検索** ✅ **正常**

```
[PERF] ⏱️ Phase 5 parallel search completed in 475ms (0.47s)
```

**評価**: 目標3000ms以下 ✅ **正常**

**分析**: ベクトル検索（198ms）とBM25検索（473ms）が並列実行され、最大値の473msで完了。

---

### 4. **searchLanceDB完了** ⚠️ **やや長い**

```
[PERF] 🔍 searchLanceDB完了: 1707ms (累計: 1712ms)
```

**分析**:
- 並列検索完了: 475ms
- その他の処理（RRF、スコアリング、フィルタリングなど）: 約1232ms
- 合計: 1707ms

**ボトルネック**: 並列検索後の処理（RRF、スコアリング、フィルタリング）に約1232msかかっている。

---

### 5. **enrichWithAllChunks** ✅ **正常**

```
enrichWithAllChunks: '319ms'
```

**評価**: 目標1000ms以下 ✅ **正常**

---

### 6. **filterInvalidPages** ✅ **正常**

```
filterInvalidPages: '354ms'
```

**評価**: 目標2000ms以下 ✅ **正常**

---

### 7. **検索処理完了** ⚠️ **やや長い**

```
[PERF] 🔍 検索処理完了（ユーザー認識時間）: 総時間 2436ms (リクエスト受信から検索完了まで)
```

**評価**: 目標2000ms以下、実際2436ms ⚠️ **やや長い（約22%超過）**

**内訳**:
- searchLanceDB: 1707ms
- enrichWithAllChunks: 319ms
- filterInvalidPages: 354ms
- その他: 56ms

---

## 🔍 reference-enhancerの処理

### 参照元拡張

```
[reference-enhancer] Enhancing allReferences (10 references)
[reference-enhancer] Enhanced allReferences: 10 → 15 references
```

**分析**:
- 参照元が10件から15件に拡張
- 複数の検索が実行されている：
  - 55ms（0件）
  - 607ms（30件）
  - 414ms（30件）
  - 640ms（30件）
  - 530ms（30件）

**合計時間**: 約2246ms（並列実行のため、実際の時間は最大値の640ms程度）

---

## 📊 メモリ使用量

```
⚠️ [Memory] Search execution (【FIX】会員：プロフィール情報...): RSS increased by +302.65MB
```

**分析**:
- RSS: +302.65MB ⚠️ **大幅な増加**
- reference-enhancerの検索処理でメモリが増加

---

## 🎯 ボトルネックの特定

### ボトルネック1: **searchLanceDB内の処理** ⚠️ **中程度**

**症状**:
- 並列検索完了: 475ms
- searchLanceDB完了: 1707ms
- 差分: 約1232ms

**原因**:
- RRF（Reciprocal Rank Fusion）処理
- スコアリング処理
- フィルタリング処理

**対策**:
- RRF処理の最適化
- スコアリング処理の最適化
- フィルタリング処理の最適化

---

### ボトルネック2: **メモリ使用量** ⚠️ **中程度**

**症状**:
- RSS: +302.65MB

**原因**:
- reference-enhancerの検索処理で大量のデータをメモリに保持

**対策**:
- メモリ使用量の最適化
- キャッシュサイズの制限

---

## ✅ 結論

### 正常に動作している項目

1. ✅ **ベクトル検索**: 198ms（目標: 1000ms以下）
2. ✅ **BM25検索**: 473ms（目標: 2000ms以下）
3. ✅ **並列検索**: 475ms（目標: 3000ms以下）
4. ✅ **enrichWithAllChunks**: 319ms（目標: 1000ms以下）
5. ✅ **filterInvalidPages**: 354ms（目標: 2000ms以下）

### 改善が必要な項目

1. ⚠️ **searchLanceDB内の処理**: 約1232ms（RRF、スコアリング、フィルタリング）
2. ⚠️ **検索処理完了**: 2436ms（目標: 2000ms以下、約22%超過）
3. ⚠️ **メモリ使用量**: +302.65MB

---

## 🔗 関連ドキュメント

- [サーバー側ログ分析ガイド](./05.41-server-log-analysis-guide-2025-11-22.md)
- [クエリ3 ステップバイステップ分析](./05.43-query3-step-by-step-analysis-2025-11-22.md)
- [サーバー側ログ分析](./05.46-server-log-analysis-2025-11-22.md)

