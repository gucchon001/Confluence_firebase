# Google APIキー漏洩対応

## 🚨 緊急対応

**日付**: 2025年1月  
**漏洩箇所**: `setup/apphosting.yaml` (65行目)

Google APIキー（`AIzaSyAyW-nOH2DQu-5GdHqALhGp264jiSjAJ1k`）が`setup/apphosting.yaml`に直接記載されており、Gitリポジトリにコミットされていました。

## 漏洩箇所の詳細

### `setup/apphosting.yaml` (65行目)
- **問題**: Google APIキーが直接記載されていた
- **影響**: このファイルはGitリポジトリにコミットされているため、公開リポジトリであれば誰でも見ることができる
- **修正**: プレースホルダー（`your-google-api-key-here`）に置き換え済み

## 対応手順

### 1. 新しいGoogle APIキーの生成

1. [Google Cloud Console](https://console.cloud.google.com/apis/credentials)にアクセス
2. プロジェクト `boxwood-dynamo-384411` を選択
3. 「認証情報」→「認証情報を作成」→「APIキー」
4. 新しいAPIキーを生成
5. **重要**: 生成したAPIキーを安全に保管してください（Gitにコミットしない）

### 2. 古いAPIキーの無効化

1. [Google Cloud Console](https://console.cloud.google.com/apis/credentials)にアクセス
2. 漏洩したAPIキー（`AIzaSyAyW-nOH2DQu-5GdHqALhGp264jiSjAJ1k`）を選択
3. 「削除」または「制限を追加」で無効化

### 3. Firebase Consoleで環境変数を設定

Firebase App Hostingの環境変数は、Firebase Consoleから設定する必要があります。

#### 方法1: Firebase Consoleから設定

1. [Firebase Console](https://console.firebase.google.com/)にアクセス
2. プロジェクト `confluence-copilot-ppjye` を選択
3. App Hosting → `confluence-chat` を開く
4. 「環境変数」タブを開く
5. 以下の環境変数を追加/更新：
   - `NEXT_PUBLIC_GOOGLE_API_KEY`: 新しいAPIキー
   - `NEXT_PUBLIC_GOOGLE_CLIENT_ID`: `122015916118-erbk5824ul8aenq5unpknhpu0aenkr7f.apps.googleusercontent.com`
6. 可用性（Availability）を `BUILD` と `RUNTIME` の両方に設定

#### 方法2: Firebase CLIを使用（推奨）

```bash
# Firebase CLIで環境変数を設定
firebase apphosting:backends:set-env confluence-chat \
  --variable NEXT_PUBLIC_GOOGLE_API_KEY="your-new-api-key" \
  --variable NEXT_PUBLIC_GOOGLE_CLIENT_ID="122015916118-erbk5824ul8aenq5unpknhpu0aenkr7f.apps.googleusercontent.com"
```

### 4. ローカル環境の更新

`.env.local`を更新：

```bash
# .env.local
NEXT_PUBLIC_GOOGLE_API_KEY=your-new-api-key
NEXT_PUBLIC_GOOGLE_CLIENT_ID=122015916118-erbk5824ul8aenq5unpknhpu0aenkr7f.apps.googleusercontent.com
```

### 5. Git履歴からの削除（オプション）

既にコミットされているAPIキーをGit履歴から削除する場合：

```bash
# Git履歴からAPIキーを検索
git log --all --full-history -S "AIzaSyAyW-nOH2DQu-5GdHqALhGp264jiSjAJ1k" -- setup/apphosting.yaml

# BFG Repo-Cleanerを使用して削除（推奨）
# または git filter-branch を使用
```

**注意**: Git履歴の書き換えは、チーム全体で調整が必要です。

## 今後の対策

### 1. 環境変数の管理方針

- **`NEXT_PUBLIC_*`変数**: クライアントサイドで使用されるため、ブラウザに公開されますが、Gitリポジトリには直接記載しない
- **実際の値**: Firebase ConsoleまたはSecret Managerで管理
- **設定ファイル**: プレースホルダーのみを記載

### 2. コードレビューの強化

- コミット前にAPIキーが含まれていないか確認
- `.env.local`や`apphosting.yaml`の変更をレビュー時に重点的に確認

### 3. 自動検出の導入

GitHub Actionsやpre-commitフックでAPIキーのパターンを検出：

```yaml
# .github/workflows/check-api-keys.yml
- name: Check for API keys
  run: |
    if grep -r "AIzaSy" --include="*.yaml" --include="*.yml" --include="*.md" .; then
      echo "❌ API key detected in files!"
      exit 1
    fi
```

## 参考資料

- [APIキー漏洩防止ガイド](./05.19-api-key-leakage-prevention.md)
- [APIキー漏洩の根本原因分析](./05.26-api-key-leakage-root-cause.md)
- [Firebase App Hosting環境変数設定](https://firebase.google.com/docs/app-hosting/configure)

