# テスト実行ガイド

## 概要

このガイドでは、実装されたシステム機能の包括的なテスト実行方法を説明します。

**注意**: テスト実行結果の詳細は [`TEST_EXECUTION_RESULTS.md`](./TEST_EXECUTION_RESULTS.md) を参照してください。

## テスト環境

- **実行環境**: ローカル開発環境
- **データベース**: 本番Firestore（読み取り専用推奨）
- **認証**: 本番Firebase Auth
- **Node.js**: v18以上推奨

## テストスクリプト一覧

### 実際に実行可能なテストスクリプト

`src/tests/` ディレクトリには以下のテストスクリプトが含まれています：

#### 包括的テストランナー
- **`comprehensive-test-runner.ts`**: 包括的なテストを実行
  - 実行方法: `npx tsx src/tests/comprehensive-test-runner.ts`
  - 内容: ユニットテスト、統合テスト、E2Eテスト、パフォーマンステスト、セキュリティテスト

#### クイックバリデーションテスト
- **`quick-validation-test.ts`**: 基本的な機能の動作確認
  - 実行方法: `npx tsx src/tests/quick-validation-test.ts`
  - 内容: サービスのインポート、型定義、Firebase接続の確認

#### コード品質チェック
- **`code-quality-checker.ts`**: コード品質のチェック
  - 実行方法: `npx tsx src/tests/code-quality-checker.ts`
  - 内容: 重複コード、機能干渉、仕様準拠性の確認

#### パフォーマンステスト
- **`test-api-performance.ts`**: APIパフォーマンステスト
  - 実行方法: `npx tsx src/tests/test-api-performance.ts`
  - 内容: 検索時間、AI生成時間、総処理時間の測定

- **`performance-analysis.ts`**: パフォーマンス分析
  - 実行方法: `npx tsx src/tests/performance-analysis.ts`

- **`performance-optimization-test.ts`**: パフォーマンス最適化テスト
  - 実行方法: `npx tsx src/tests/performance-optimization-test.ts`

#### 検索品質テスト
- **`classroom-management-search-test.ts`**: 教室管理検索テスト
  - 実行方法: `npx tsx src/tests/classroom-management-search-test.ts`

- **`classroom-deletion-issue-search-test.ts`**: 教室削除問題検索テスト
  - 実行方法: `npx tsx src/tests/classroom-deletion-issue-search-test.ts`

- **`classroom-deletion-keyword-quality-test.ts`**: 教室削除キーワード品質テスト
  - 実行方法: `npx tsx src/tests/classroom-deletion-keyword-quality-test.ts`

- **`classroom-copy-keyword-quality-test.ts`**: 教室コピーキーワード品質テスト
  - 実行方法: `npx tsx src/tests/classroom-copy-keyword-quality-test.ts`

- **`offer-function-search-test.ts`**: 応募機能検索テスト
  - 実行方法: `npx tsx src/tests/offer-function-search-test.ts`

- **`member-login-keyword-quality-test.ts`**: 会員ログインキーワード品質テスト
  - 実行方法: `npx tsx src/tests/member-login-keyword-quality-test.ts`

#### ベクトル検索テスト
- **`vector-search-quality-test.ts`**: ベクトル検索品質テスト
  - 実行方法: `npx tsx src/tests/vector-search-quality-test.ts`

- **`vector-search-precision-recall-test.ts`**: ベクトル検索精度・再現率テスト
  - 実行方法: `npx tsx src/tests/vector-search-precision-recall-test.ts`

- **`vector-search-consistency-test.ts`**: ベクトル検索一貫性テスト
  - 実行方法: `npx tsx src/tests/vector-search-consistency-test.ts`

- **`vector-search-report-generator.ts`**: ベクトル検索レポート生成
  - 実行方法: `npx tsx src/tests/vector-search-report-generator.ts`

- **`run-all-vector-search-tests.ts`**: 全ベクトル検索テスト実行
  - 実行方法: `npx tsx src/tests/run-all-vector-search-tests.ts`

#### Genkitテスト
- **`genkit-integration-test.ts`**: Genkit統合テスト
  - 実行方法: `npx tsx src/tests/genkit-integration-test.ts`

- **`genkit-quality-test.ts`**: Genkit品質テスト
  - 実行方法: `npx tsx src/tests/genkit-quality-test.ts`

- **`genkit-performance-test.ts`**: Genkitパフォーマンステスト
  - 実行方法: `npx tsx src/tests/genkit-performance-test.ts`

#### データフロー統合テスト
- **`data-flow-integration-tests.ts`**: データフロー統合テスト
  - 実行方法: `npx tsx src/tests/data-flow-integration-tests.ts`

- **`run-data-flow-integration-tests.ts`**: データフロー統合テスト実行
  - 実行方法: `npx tsx src/tests/run-data-flow-integration-tests.ts`

#### 統合テストフレームワーク
- **`integration-test-framework.ts`**: 統合テストフレームワーク
- **`integration-test-runner.ts`**: 統合テストランナー
  - 実行方法: `npx tsx src/tests/integration-test-runner.ts`

#### チェックスクリプト
- **`check-lancedb-schema.ts`**: LanceDBスキーマチェック
  - 実行方法: `npx tsx src/tests/check-lancedb-schema.ts`

- **`check-lunr-status.ts`**: Lunrインデックスステータスチェック
  - 実行方法: `npx tsx src/tests/check-lunr-status.ts`

- **`check-reference-urls.ts`**: 参照URLチェック
  - 実行方法: `npx tsx src/tests/check-reference-urls.ts`

- **`check-search-result-formatting.ts`**: 検索結果フォーマットチェック
  - 実行方法: `npx tsx src/tests/check-search-result-formatting.ts`

#### 分析スクリプト
- **`analyze-classroom-scoring.ts`**: 教室スコアリング分析
  - 実行方法: `npx tsx src/tests/analyze-classroom-scoring.ts`

- **`analyze-keyword-extraction.ts`**: キーワード抽出分析
  - 実行方法: `npx tsx src/tests/analyze-keyword-extraction.ts`

- **`analyze-offer-search-precision.ts`**: 応募検索精度分析
  - 実行方法: `npx tsx src/tests/analyze-offer-search-precision.ts`

- **`analyze-scoring.ts`**: スコアリング分析
  - 実行方法: `npx tsx src/tests/analyze-scoring.ts`

- **`analyze-search-results.ts`**: 検索結果分析
  - 実行方法: `npx tsx src/tests/analyze-search-results.ts`

## テスト実行手順

### 1. 環境準備

```bash
# 依存関係のインストール
npm install

# 環境変数の確認
# .env.local ファイルにFirebase設定が正しく設定されていることを確認
```

### 2. クイックバリデーションテスト

基本的な機能が正常に動作することを確認します。

```bash
# クイックテスト実行
npx tsx src/tests/quick-validation-test.ts
```

**期待される結果:**
- すべてのサービスとコンポーネントが正常にインポートされる
- 型定義が正しくエクスポートされる
- Firebase接続が確立される

### 3. 包括的テスト

詳細な機能テストを実行します。

```bash
# 包括的テスト実行
npx tsx src/tests/comprehensive-test-runner.ts
```

**テスト項目:**
- ユニットテスト（各サービスの個別機能）
- 統合テスト（コンポーネント間の連携）
- エンドツーエンドテスト（ユーザーフロー）
- パフォーマンステスト（レスポンス時間、メモリ使用量）
- セキュリティテスト（認証、データ保護）

### 4. コード品質チェック

重複コード、干渉、仕様準拠性をチェックします。

```bash
# コード品質チェック実行
npx tsx src/tests/code-quality-checker.ts
```

**チェック項目:**
- 重複コードの検出
- インポート重複の検出
- 機能干渉の検出
- 仕様準拠性の確認
- 型定義整合性の確認
- サービス間依存関係の確認

### 5. カテゴリ別テスト

#### データ関連テスト

```bash
# LanceDBスキーマチェック
npm run check:lancedb-schema

# Firestoreラベル統合チェック
npm run check:firestore-structured-labels

# LanceDBスキーマチェック（本番環境）
npm run check:production-lancedb-schema

# データ整合性テスト（ローカル環境）
npm run test:data-integrity:local

# データ整合性テスト（本番環境）
npm run test:data-integrity:production

# データ整合性テスト（両方）推奨
npm run test:data-integrity:both

# 本番環境アップロード前検証
npm run verify:production-readiness

# 特定ページの確認（本番環境）
npm run check:production-page703594590
```

#### 検索品質テスト

```bash
# 教室削除検索ランキングテスト
npm run test:search-ranking-classroom-deletion

# ラベル・タイトルマッチングテスト
npm run test:label-and-title-matching

# 機能名マッチングテスト
npm run test:feature-name-matching
```

#### パフォーマンステスト

```bash
# APIパフォーマンステスト
npx tsx src/tests/test-api-performance.ts

# ローカル検索パフォーマンステスト
npm run test:local-search-performance

# パフォーマンス最適化テスト
npx tsx src/tests/performance-optimization-test.ts
```

#### ベクトル検索テスト

```bash
# 全ベクトル検索テスト実行
npx tsx src/tests/run-all-vector-search-tests.ts

# ベクトル検索品質テスト
npx tsx src/tests/vector-search-quality-test.ts

# ベクトル検索精度・再現率テスト
npx tsx src/tests/vector-search-precision-recall-test.ts
```

#### Genkitテスト

```bash
# Genkit統合テスト
npx tsx src/tests/genkit-integration-test.ts

# Genkit品質テスト
npx tsx src/tests/genkit-quality-test.ts

# Genkitパフォーマンステスト
npx tsx src/tests/genkit-performance-test.ts
```

#### 統合テスト

```bash
# 統合テスト実行
npm run test:integration

# データフロー統合テスト
npx tsx src/tests/run-data-flow-integration-tests.ts

# 統合テストランナー
npx tsx src/tests/integration-test-runner.ts
```

#### E2Eテスト

```bash
# E2Eテスト実行
npm run test:e2e

# E2Eテスト（UIモード）
npm run test:e2e:ui
```

## テスト結果の解釈

### 成功パターン

```
🎉 ALL TESTS PASSED!
✅ Basic functionality is working correctly.
✅ All services and components can be imported.
✅ Type definitions are properly exported.
✅ No code quality issues found.
```

### 失敗パターンと対処法

#### 1. インポートエラー

```
❌ Error Monitoring Service Import: Module not found
```

**対処法:**
- ファイルパスの確認
- 依存関係のインストール確認
- TypeScript設定の確認

#### 2. Firebase接続エラー

```
❌ Firebase Connection: Connection failed
```

**対処法:**
- 環境変数の確認
- ネットワーク接続の確認
- Firebase設定の確認

#### 3. 重複コード検出

```
⚠️ Duplicate function signature found in 2 files
```

**対処法:**
- 共通関数の抽出
- ユーティリティファイルの作成
- インポートの整理

#### 4. 機能干渉検出

```
⚠️ Function name collision detected
```

**対処法:**
- 関数名の変更
- 名前空間の導入
- モジュール構造の見直し

## トラブルシューティング

### よくある問題と解決方法

#### 1. TypeScriptコンパイルエラー

```bash
# TypeScript設定の確認
npm run typecheck
```

#### 2. 依存関係の問題

```bash
# 依存関係の再インストール
rm -rf node_modules package-lock.json
npm install
```

#### 3. Firebase認証エラー

```bash
# Firebase設定の確認
# .env.local ファイルの内容を確認
# Firebase Console での設定確認
```

#### 4. メモリ不足エラー

```bash
# Node.js のメモリ制限を増加
node --max-old-space-size=4096 npx tsx src/tests/comprehensive-test-runner.ts
```

## テスト結果の活用

### 1. 品質改善

- 重複コードの削除
- 関数名の統一
- エラーハンドリングの強化
- 型定義の追加

### 2. パフォーマンス改善

- レスポンス時間の最適化
- メモリ使用量の削減
- 同時接続の最適化

### 3. セキュリティ強化

- 認証・認可の強化
- データ保護の改善
- ログ出力の最適化

## 継続的テスト

### 開発時のテスト実行

```bash
# 開発中のクイックチェック
npx tsx src/tests/quick-validation-test.ts

# 変更後の品質チェック
npx tsx src/tests/code-quality-checker.ts
```

### リリース前のテスト実行

```bash
# リリース前の全テスト実行
npx tsx src/tests/comprehensive-test-runner.ts
```

## テスト結果の記録

### 結果ファイルの保存

```bash
# テスト結果をファイルに保存
npx tsx src/tests/comprehensive-test-runner.ts > test-results-$(date +%Y%m%d-%H%M%S).log 2>&1
```

### 継続的改善

- テスト結果の定期レビュー
- 失敗パターンの分析
- テストケースの追加・改善
- 品質基準の更新

## 注意事項

### 本番データへの影響

- Firestoreは読み取り専用でのテスト実行を推奨
- 書き込みテストは開発環境で実行
- 重要なデータのバックアップを事前に取得

### テスト実行時間

- クイックテスト: 約30秒
- 包括的テスト: 約5-10分
- コード品質チェック: 約1-2分
- 全テスト: 約10-15分

### リソース使用量

- メモリ使用量: 最大500MB
- CPU使用率: 最大80%
- ネットワーク帯域: 最小限

## サポート

テスト実行で問題が発生した場合：

1. エラーメッセージの詳細確認
2. 環境設定の確認
3. 依存関係の確認
4. ログファイルの確認
5. 必要に応じて開発チームに連絡
