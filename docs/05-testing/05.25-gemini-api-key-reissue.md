# Gemini APIキー再発行手順

## 🚨 緊急対応

新しいGemini APIキー（`AIzaSyD6h4V0PENM6YiGHwlW3uq3hQB2JzwUAZM`）も漏洩として報告されました。新しいAPIキーを再発行する必要があります。

## 手順

### 1. 新しいAPIキーの生成

1. [Google AI Studio](https://makersuite.google.com/app/apikey)にアクセス
2. 新しいAPIキーを生成
3. **重要**: 生成したAPIキーを安全に保管してください

### 2. 古いAPIキーの無効化

1. [Google AI Studio](https://makersuite.google.com/app/apikey)で以下のAPIキーを無効化：
   - `AIzaSyD6h4V0PENM6YiGHwlW3uq3hQB2JzwUAZM`（最新のキー、漏洩報告済み）
   - `AIzaSyDgbOANBYpo-H5V9-HLwJR36fhNonSz4h4`（以前のキー、漏洩報告済み）

### 3. 環境変数の更新

#### 3.1 ローカル環境（.env.local）

```bash
# .env.local
GEMINI_API_KEY=新しいAPIキーをここに設定
```

#### 3.2 GitHub Secrets

```powershell
# 新しいAPIキーをGitHub Secretsに設定
gh secret set GEMINI_API_KEY --body "新しいAPIキー"
```

#### 3.3 Firebase Secret Manager

```powershell
# 新しいAPIキーをSecret Managerに追加
echo -n "新しいAPIキー" | gcloud secrets versions add gemini_api_key --project=confluence-copilot-ppjye --data-file=-
```

### 4. 動作確認

#### 4.1 ローカル環境での確認

```powershell
# テストを実行してAPIキーが正しく動作するか確認
npm run test -- src/tests/api/endpoints.test.ts
```

#### 4.2 本番環境での確認

デプロイ後、実行時ログで以下のエラーが表示されないことを確認：

```
❌ Gemini API エラー: [403 Forbidden] Your API key was reported as leaked
```

## 注意事項

1. **APIキーの安全な管理**
   - APIキーは絶対にGitリポジトリにコミットしない
   - ドキュメントや設定ファイルにハードコードしない
   - 環境変数やSecret Managerで管理する

2. **漏洩の原因調査**
   - 以前のAPIキーがどこで漏洩したか調査する必要があります
   - ログ、ドキュメント、設定ファイルを確認してください

3. **定期的な更新**
   - APIキーは定期的に更新することを推奨します
   - 漏洩が疑われる場合は、すぐに新しいキーを発行してください

## クイックリファレンス

### すべての環境で更新するコマンド

```powershell
# 1. .env.localを編集（手動）
# GEMINI_API_KEY=新しいAPIキー

# 2. GitHub Secretsを更新
gh secret set GEMINI_API_KEY --body "新しいAPIキー"

# 3. Firebase Secret Managerを更新
echo -n "新しいAPIキー" | gcloud secrets versions add gemini_api_key --project=confluence-copilot-ppjye --data-file=-

# 4. 確認
gh secret list
gcloud secrets versions list gemini_api_key --project=confluence-copilot-ppjye --limit=3
```

