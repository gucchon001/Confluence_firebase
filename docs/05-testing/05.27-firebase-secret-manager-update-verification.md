# Firebase Secret Manager更新後の確認手順

## 問題

Firebase Secret Managerに新しいGemini APIキーを追加したにもかかわらず、本番環境で`API key expired`エラーが発生している場合があります。

## 原因

Firebase App Hostingは、ビルド時にSecret Managerのバージョンをピン留めします。新しいバージョンを追加しても、既存のビルドは古いバージョンを使用し続けます。

## 解決方法

### 1. 新しいAPIキーが正しく動作するか確認

```powershell
# ローカル環境でテスト
$env:GEMINI_API_KEY="新しいAPIキー"
node scripts/test-gemini-api.js
```

### 2. Firebase Secret Managerのバージョンを確認

```powershell
# 最新のバージョンを確認
gcloud secrets versions list gemini_api_key --project=confluence-copilot-ppjye --limit=5
```

### 3. 新しいデプロイをトリガー

Firebase App Hostingは、新しいコミットをプッシュすると自動的に新しいビルドを開始します。新しいビルドでは、Secret Managerの`latest`エイリアスが最新バージョンを指すため、新しいAPIキーが使用されます。

```powershell
# 空のコミットを作成してデプロイをトリガー
git commit --allow-empty -m "trigger: 新しいGemini APIキーを使用するために再デプロイ"
git push
```

または、Firebase Consoleから手動で再デプロイをトリガーすることもできます。

### 4. ビルドログでSecret Managerバージョンを確認

新しいビルドのログで、以下のようなメッセージを確認してください：

```
Pinned secret projects/confluence-copilot-ppjye/secrets/gemini_api_key/versions/latest to projects/122015916118/secrets/gemini_api_key/versions/4
```

バージョン4が使用されていることを確認してください。

### 5. 実行時ログでエラーが解消されたか確認

デプロイ後、実行時ログで以下のエラーが表示されないことを確認してください：

```
❌ Gemini API エラー: [400 Bad Request] API key expired
```

## トラブルシューティング

### 問題: 新しいバージョンが使用されない

**原因**: ビルド時に古いバージョンがピン留めされている

**解決方法**:
1. 新しいコミットをプッシュして再デプロイ
2. または、Firebase Consoleから手動で再デプロイ

### 問題: 新しいAPIキーも期限切れエラーが発生する

**原因**: 新しいAPIキーが正しく生成されていない、または無効化されている

**解決方法**:
1. [Google AI Studio](https://makersuite.google.com/app/apikey)でAPIキーの状態を確認
2. 必要に応じて新しいAPIキーを再生成
3. すべての環境（`.env.local`、GitHub Secrets、Firebase Secret Manager）で更新

## 参考

- [Firebase App Hosting - Manage Secrets](https://firebase.google.com/docs/app-hosting/manage-secrets)
- [Google Cloud Secret Manager - Version Management](https://cloud.google.com/secret-manager/docs/versioning)

