# パフォーマンステスト結果レポート（本番データ使用）(2025-11-23)

**作成日**: 2025年11月23日  
**最終更新**: 2025年11月23日  
**テスト環境**: 開発環境（本番データ使用）  
**テストデータ**: 本番環境のLanceDBデータとLunrキャッシュ

---

## 📋 目次

1. [テスト環境](#1-テスト環境)
2. [テスト結果](#2-テスト結果)
3. [パフォーマンス分析](#3-パフォーマンス分析)
4. [メモリ使用量分析](#4-メモリ使用量分析)
5. [改善効果の確認](#5-改善効果の確認)

---

## 1. テスト環境

### 1.1 テスト設定

- **テストスクリプト**: `scripts/test-memory-analysis-with-production-data.ts`
- **実行コマンド**: `npm run test:memory-analysis:production-data`
- **データソース**: 本番環境のLanceDBデータ（`.lancedb`ディレクトリ）
- **Lunrキャッシュ**: 本番環境のLunrキャッシュ（`.cache`ディレクトリ）

### 1.2 テストクエリ

1. ユーザー登録・退会フロー
2. 契約状態ごとに可能な操作
3. カテゴリ編集機能
4. 求人詳細画面の仕様
5. 自動オファー機能

---

## 2. テスト結果

### 2.1 検索時間

| 項目 | 値 | 目標 | 評価 |
|------|-----|------|------|
| **平均検索時間** | **2148ms** | 3000ms以下 | ✅ **達成** |
| **最小検索時間** | 1077ms | - | ✅ **良好** |
| **最大検索時間** | 5976ms | 3000ms以下 | ⚠️ **目標超過** |

**分析**:
- 平均検索時間は目標値（3000ms）を下回っており、良好な結果
- 最大検索時間が5976msと目標値を超過しているが、これは初回検索時のLunr初期化やEmbedding生成の影響と考えられる
- 2回目以降の検索は高速化している（最小1077ms）

### 2.2 メモリ使用量（RSS）

| 項目 | 値 | 目標 | 評価 |
|------|-----|------|------|
| **平均増加** | **92.27MB** | 500MB以下 | ✅ **達成** |
| **最大増加** | **438.81MB** | 500MB以下 | ✅ **達成** |
| **総増加** | 459.59MB | - | ✅ **良好** |

**分析**:
- 平均メモリ増加は92.27MBと、目標値（500MB）を大幅に下回っている
- 最大メモリ増加も438.81MBと目標値以下
- 以前の+950MBと比較して、**約50%削減**を達成

### 2.3 検索結果の品質

| 項目 | 結果 | 評価 |
|------|------|------|
| **すべての検索結果にcontentが存在** | Yes | ✅ **正常** |
| **すべての上位結果にcontentが復元済み** | Yes | ✅ **正常** |

**分析**:
- バッチ処理によるcontent削除・復元が正常に動作している
- 検索結果の品質は維持されている

### 2.4 Lunr初期化状態

| 項目 | 結果 | 評価 |
|------|------|------|
| **初期化中だった検索** | 0/5回 | ✅ **正常** |

**分析**:
- すべての検索でLunrインデックスが初期化済み
- 検索処理とインデックス構築が重なっていない
- メモリ増加の原因がインデックス構築ではないことを確認

---

## 3. パフォーマンス分析

### 3.1 検索時間の内訳（推定）

**平均検索時間: 2148ms**

| 処理 | 推定時間 | 備考 |
|------|---------|------|
| キーワード抽出 | 100-200ms | キーワードリストの読み込み |
| Embedding生成 | 500-1000ms | Gemini API呼び出し |
| ベクトル検索 | 100-200ms | LanceDB検索 |
| BM25検索 | 200-500ms | Lunr検索（初期化済み） |
| スコアリング・ランキング | 500-1000ms | RRF、キーワードスコア計算 |
| その他 | 200-500ms | フィルタリング、フォーマット |

### 3.2 最大検索時間（5976ms）の分析

**原因の可能性**:
1. **初回検索時の初期化**: 初回検索時にLunrインデックスのロードやキャッシュの構築
2. **Embedding生成の遅延**: Gemini APIの応答時間の変動
3. **メモリ確保**: 大量のデータをメモリに読み込む際の時間

**対策**:
- 初回検索時の初期化をバックグラウンドで実行（既に実装済み）
- Embedding生成のキャッシュを活用
- メモリ確保の最適化（バッチ処理の効果を確認）

---

## 4. メモリ使用量分析

### 4.1 メモリ増加の内訳（推定）

**平均メモリ増加: 92.27MB**

| 項目 | 推定増加 | 備考 |
|------|---------|------|
| LanceDBメモリマップドファイル | 50-100MB | テーブルの読み込み |
| 検索結果オブジェクト | 20-50MB | 検索結果の配列 |
| Embedding生成 | 10-20MB | 一時的なデータ |
| その他 | 10-20MB | キャッシュ、中間データ |

### 4.2 最大メモリ増加（438.81MB）の分析

**原因の可能性**:
1. **大量の検索結果**: 検索結果が多かった場合のメモリ使用
2. **Embedding生成**: 複数のEmbedding生成による一時的なメモリ増加
3. **キャッシュの構築**: 検索結果キャッシュの構築

**対策**:
- バッチ処理によるcontent削除（既に実装済み）
- 検索結果の上限を適切に設定
- キャッシュサイズの制限

### 4.3 改善効果の確認

**以前のメモリ増加**: +950MB  
**現在のメモリ増加**: 平均92.27MB、最大438.81MB

**改善効果**:
- **平均**: 約90%削減（950MB → 92.27MB）
- **最大**: 約54%削減（950MB → 438.81MB）

**要因**:
1. ✅ バッチ処理によるcontent削除（50件ずつ処理）
2. ✅ ランキング後のcontent復元（20件ずつ処理）
3. ✅ 検索処理とインデックス構築の分離

---

## 5. 改善効果の確認

### 5.1 実装した最適化

1. ✅ **BM25検索のタイムアウト処理**: 36秒待機 → 500msでタイムアウト
2. ✅ **メモリ最適化のバッチ処理**: content削除（50件ずつ）、content復元（20件ずつ）
3. ✅ **メモリ分析の強化**: インデックス構築と検索処理の分離

### 5.2 改善効果

| 項目 | 改善前 | 改善後 | 改善率 |
|------|--------|--------|--------|
| **平均メモリ増加** | +950MB | +92.27MB | **約90%削減** |
| **最大メモリ増加** | +950MB | +438.81MB | **約54%削減** |
| **平均検索時間** | 不明 | 2148ms | - |
| **Lunr初期化待機** | 36秒 | 0秒（初期化済み） | **100%削減** |

### 5.3 残課題

1. ⚠️ **最大検索時間**: 5976ms（目標: 3000ms以下）
   - 初回検索時の初期化やEmbedding生成の遅延が原因
   - 対策: 初回検索時の初期化をバックグラウンドで実行（既に実装済み）

2. ⚠️ **最大メモリ増加**: 438.81MB（目標: 500MB以下）
   - 目標値は達成しているが、さらなる削減の余地あり
   - 対策: バッチサイズのさらなる調整（50 → 20など）

---

## 6. まとめ

### 6.1 達成した改善

1. ✅ **メモリ使用量の大幅削減**: 平均90%削減、最大54%削減
2. ✅ **検索時間の最適化**: 平均2148ms（目標3000ms以下）
3. ✅ **検索結果の品質維持**: contentの削除・復元が正常に動作
4. ✅ **インデックス構築と検索処理の分離**: メモリ増加の原因を明確化

### 6.2 推奨される次のステップ

1. **最大検索時間の改善**: 初回検索時の初期化をバックグラウンドで実行
2. **バッチサイズの調整**: さらなるメモリ削減のため、バッチサイズを調整（50 → 20など）
3. **本番環境での確認**: 本番環境での実際のメモリ使用量を確認

---

## 7. 関連ドキュメント

- [パフォーマンス最適化テスト結果レポート](./05.72-performance-optimization-test-2025-11-23.md)
- [メモリ最適化の動作確認結果](../analysis/memory-optimization-verification.md)
- [バッチサイズ調整とメモリ分析強化](../analysis/memory-optimization-batch-size-adjustment.md)

---

## 8. 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2025-11-23 | 初版作成 | - |

