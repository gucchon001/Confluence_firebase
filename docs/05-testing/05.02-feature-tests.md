# 主要機能関連テスト

検索、要約、ストリーミング等の主要機能の動作確認を行うテストです。

## 📚 関連ドキュメント

テストを理解するために、以下のドキュメントを参照してください：

- **[ハイブリッド検索システム仕様](../../architecture/02.01.02-hybrid-search-specification.md)**: ハイブリッド検索の完全仕様書
- **[ハイブリッド検索クイックリファレンス](../../architecture/02.01.01-hybrid-search-quick-reference.md)**: ハイブリッド検索のクイックリファレンス
- **[プロンプト設計](../../architecture/03.02.01-prompt-design.md)**: AIプロンプトの設計仕様
- **[Confluence検索システム仕様](../../specifications/confluence-spec.md)**: Confluenceページの検索・要約機能の詳細仕様
- **[Jira検索システム仕様](../../specifications/jira-spec.md)**: Jira課題の検索・要約機能の詳細仕様
- **[システム全体仕様書](../../specifications/spec.md)**: システム全体の機能要件と技術スタック

## 🚀 テスト実行方法

### 一括実行（推奨）

すべての機能テストを一括で実行します：

```bash
# 直接実行（推奨）
npx tsx src/tests/runners/feature-tests-runner.ts

# Windows（スクリプトが存在する場合）
scripts\run-feature-tests.bat

# npm script（利用可能な場合）
npm run test:feature
```

**実行されるテスト**:
1. 教室削除検索 (`classroom-deletion-issue-search-test.ts`)
2. 教室削除キーワード品質 (`keyword-quality-test.ts` - 統合版、教室削除問題テストケース)
3. ストリーミング要約 (`test-streaming-direct.ts`)
4. ハイブリッド検索 (`real-hybrid-search-test.ts`)
5. ベクトル検索一貫性 (`vector-search-consistency-test.ts`)
6. キーワード品質 (`keyword-quality-test.ts` - 統合版、全テストケース)

### 個別実行

各テストは個別に実行することもできます。詳細は各テストの説明を参照してください。

### 環境変数の設定

すべてのテストは`.env.local`ファイルから環境変数を読み込みます。テスト実行前に以下を確認してください：

- `GEMINI_API_KEY`: Gemini APIキー（必須）
- `CONFLUENCE_BASE_URL`: ConfluenceベースURL
- `CONFLUENCE_USER_EMAIL`: ConfluenceユーザーEmail
- `CONFLUENCE_API_TOKEN`: Confluence APIトークン
- `CONFLUENCE_SPACE_KEY`: Confluenceスペースキー

テストは`loadTestEnv()`を使用して環境変数を読み込むため、`app-config`のインポート前に実行されます。

## 📋 テスト項目

### 1. 検索品質テスト

#### 1.1.1 教室削除検索テスト

**目的**: 教室削除ができない原因を特定するための検索品質を検証

**テストファイル**: `classroom-deletion-issue-search-test.ts`

**テストクエリ**: `教室削除ができないのは何が原因ですか`

**期待されるページ**: `164_【FIX】教室削除機能` が検索結果の上位に表示される

**実行方法**:
```bash
# 一括実行（推奨）
npx tsx src/tests/runners/feature-tests-runner.ts

# 個別実行
npx tsx src/tests/classroom-deletion-issue-search-test.ts
```

**確認項目**:
- [ ] 期待されるページ（`164_【FIX】教室削除機能`）が検索結果の上位に表示される
- [ ] 検索時間が目標値以内（10秒以下）
- [ ] 検索結果のスコアが正しく表示される（0.0以上）
- [ ] 検索結果の関連性が高い

#### 1.1.2 教室削除キーワード品質テスト

**目的**: 教室削除検索におけるキーワード抽出の品質を検証

**テストファイル**: `keyword-quality-test.ts`（統合版）

**実行方法**:
```bash
# 一括実行（推奨）
npx tsx src/tests/runners/feature-tests-runner.ts

# 個別実行（全テストケース）
npx tsx src/tests/keyword-quality-test.ts

# 特定のテストケースのみ実行（教室削除問題）
npx tsx src/tests/keyword-quality-test.ts 教室削除問題
```

**確認項目**:
- [ ] キーワードが正しく抽出される
- [ ] 抽出されたキーワードが検索に有効である
- [ ] キーワード抽出の処理時間が適切

#### 1.2 Jira検索品質テスト

**詳細**: [`jira-quality-testcases.md`](./jira-quality-testcases.md)を参照

**確認項目**:
- [ ] Jiraイシューが正しく検索される
- [ ] イシューのフィールドが正しく表示される
- [ ] Jira固有の検索が正しく動作する

**注意**: このテストは`feature-tests-runner.ts`には含まれていません。個別に実行してください。

### 2. 回答生成テスト

#### 2.1 ストリーミング要約テスト

**目的**: ストリーミング要約が正しく動作しているか確認（API経由ではなく直接関数を呼び出す）

**テストファイル**: `test-streaming-direct.ts`

**実行方法**:
```bash
# 一括実行（推奨）
npx tsx src/tests/runners/feature-tests-runner.ts

# 個別実行
npx tsx src/tests/test-streaming-direct.ts
```

**テストクエリ例**:
- `学年自動更新バッチの実行日時はいつですか？`
- `教室管理の詳細は`
- `会員登録機能について`

**確認項目**:
- [ ] ストリーミングが正常に開始される
- [ ] チャンクが順次配信される
- [ ] 回答が完全に生成される
- [ ] 参照元が正しく表示される
- [ ] 検索時間、AI生成時間、総時間が計測される
- [ ] 最初のチャンク時間が計測される

**注意**: このテストは環境変数の読み込み順序に注意が必要です。`loadTestEnv()`が実行された後に`retrieveRelevantDocs`と`streamingSummarizeConfluenceDocs`を動的インポートしています。

#### 2.2 参照元フィルタリング

**目的**: 実際に使用された参照元のみが表示されるか確認

**確認項目**:
- [ ] 参照元が正しく抽出される
- [ ] 使用されていない参照元が除外される
- [ ] 参照元のURLが正しい

**注意**: この機能は`test-streaming-direct.ts`で間接的にテストされます。

### 3. ハイブリッド検索テスト

#### 3.1 ベクトル検索一貫性テスト

**目的**: 複数のクエリでベクトル検索の一貫性を検証

**テストファイル**: `vector-search-consistency-test.ts`

**実行方法**:
```bash
# 一括実行（推奨）
npx tsx src/tests/runners/feature-tests-runner.ts

# 個別実行
npx tsx src/tests/vector-search-consistency-test.ts
```

**確認項目**:
- [ ] ベクトル検索が実行される
- [ ] 複数クエリでの検索結果の一貫性が保たれる
- [ ] スコア分布の一貫性が確認できる
- [ ] ランキングの一貫性が確認できる
- [ ] 検索結果のスコアが正しく表示される（0.0以上）

**注意**: このテストは環境変数の読み込み順序に注意が必要です。`loadTestEnv()`が実行された後に`searchLanceDB`を動的インポートしています。

#### 3.2 BM25検索

**目的**: キーワード検索（BM25）が正しく動作しているか確認

**確認項目**:
- [ ] Lunrインデックスが使用される
- [ ] キーワードマッチングが正しく動作する
- [ ] 検索結果のスコアが適切

**注意**: BM25検索は`real-hybrid-search-test.ts`で統合的にテストされます。

#### 3.3 ハイブリッド統合テスト

**目的**: ベクトル検索とBM25検索の統合が正しく動作しているか確認

**テストファイル**: `real-hybrid-search-test.ts`

**実行方法**:
```bash
# 一括実行（推奨）
npx tsx src/tests/runners/feature-tests-runner.ts

# 個別実行
npx tsx src/tests/real-hybrid-search-test.ts
```

**確認項目**:
- [ ] 両方の検索結果が統合される
- [ ] RRF（Reciprocal Rank Fusion）が正しく適用される
- [ ] 最終的な検索結果の順位が適切
- [ ] 検索結果のスコアが正しく表示される（平均スコア >= 0.8で優秀と評価）
- [ ] 検索品質が「優秀」「良好」「改善が必要」「要最適化」のいずれかで評価される
- [ ] 検索時間が適切（平均検索時間が表示される）

**テストクエリ例**:
- `教室管理の詳細について教えてください`
- `システムの認証機能について説明してください`
- `データベースの構造について教えてください`
- `APIの設計原則について説明してください`
- `検索機能の仕組みについて教えてください`

### 4. ラベル・タイトルマッチングテスト

#### 4.1 キーワード品質テスト

**目的**: キーワード抽出の品質を検証（教室管理検索品質テスト仕様書に基づく）

**テストファイル**: `keyword-quality-test.ts`

**実行方法**:
```bash
# 一括実行（推奨）
npx tsx src/tests/runners/feature-tests-runner.ts

# 個別実行
npx tsx src/tests/keyword-quality-test.ts
```

**テストクエリ**: `教室管理の詳細は`

**確認項目**:
- [ ] キーワードが正しく抽出される
- [ ] 抽出されたキーワードが理想的なキーワードと比較される
- [ ] 精度（Precision）、再現率（Recall）、F1スコアが計算される
- [ ] キーワード抽出の処理時間が適切
- [ ] 抽出されたキーワードの詳細が表示される

**注意**: このテストは環境変数の読み込み順序に注意が必要です。`loadTestEnv()`が実行された後に`unifiedKeywordExtractionService`を動的インポートしています。

## 📊 テスト結果の確認

### テスト結果の見方

各テストは以下の形式で結果を出力します：

- ✅ **成功**: テストが正常に完了し、期待される結果が得られた
- ❌ **失敗**: テストが失敗した、または期待される結果が得られなかった
- ⚠️ **警告**: テストは完了したが、パフォーマンスや品質に問題がある

### 検索品質評価基準

`real-hybrid-search-test.ts`では、以下の基準で検索品質を評価します：

- 🚀 **優秀**: 平均スコア >= 0.8
- ✅ **良好**: 平均スコア >= 0.6
- ⚠️ **改善が必要**: 平均スコア >= 0.4
- ❌ **要最適化**: 平均スコア < 0.4

### スコア表示

すべての検索結果には`score`プロパティが含まれます。スコアは以下の優先順位で設定されます：

1. `_compositeScore`: 複合スコア（最優先）
2. `_rrfScore`: RRF（Reciprocal Rank Fusion）スコア
3. `distance`: ベクトル距離

### 過去のテスト結果

詳細なテスト基準と結果は以下のドキュメントを参照してください：

- **[Phase 0A-4 テスト基準](./05-phase-0a-4-test-criteria.md)**: 詳細なテスト基準と結果
- **[Phase 4 テスト実行結果](./06-phase-4-test-execution.md)**: Phase 4の実行結果
- **[教室管理検索品質テスト](./07-case-classroom-management-search-quality-test.md)**: 教室管理検索の詳細仕様
- **[Jira品質テストケース](./08-jira-quality-testcases.md)**: Jira検索のテストケース

## 🔄 定期的な実行

以下のテストは定期的に実行することを推奨します：

- **検索品質**: 検索アルゴリズム変更後、データ更新後
- **回答生成**: AIモデル変更後、プロンプト変更後
- **ハイブリッド検索**: 検索ロジック変更後、スコアリングアルゴリズム変更後

## ⚠️ 注意事項

### 環境変数の読み込み順序

すべてのテストは`loadTestEnv()`を使用して環境変数を読み込みます。これは`app-config`のインポート前に実行される必要があります。

テストファイルでは以下のパターンを使用しています：

```typescript
// テスト用の環境変数を事前に読み込む（app-configのインポート前に）
import { loadTestEnv } from './test-helpers/env-loader';
loadTestEnv();

// その後、動的インポートを使用してapp-configに依存するモジュールを読み込む
const { retrieveRelevantDocs } = await import('../ai/flows/retrieve-relevant-docs-lancedb.js');
```

### 統合されたテスト

以下のキーワード品質テストは`keyword-quality-test.ts`に統合されました：

- ✅ `keyword-quality-test.ts` - 統合版（5つのテストケースを含む）
  - 教室管理
  - 教室削除問題
  - オファー機能
  - 会員ログイン機能
  - 教室コピー機能

統合前の個別ファイルは削除されました：
- ❌ `classroom-deletion-keyword-quality-test.ts` - 統合済み
- ❌ `offer-keyword-quality-test.ts` - 統合済み
- ❌ `member-login-keyword-quality-test.ts` - 統合済み
- ❌ `classroom-copy-keyword-quality-test.ts` - 統合済み

### 削除されたテスト

以下のテストは削除されました（非現実的な基準や存在しないページを期待していたため、または分析スクリプトでテストではないため）：

- ❌ `classroom-management-search-test.ts` - 削除済み（非現実的な基準）
- ❌ `vector-search-quality-test.ts` - 削除済み（非現実的な基準）
- ❌ `vector-search-precision-recall-test.ts` - 削除済み（存在しないページを期待、分析スクリプト）
- ❌ `vector-distance-analysis-test.ts` - 削除済み（分析スクリプト、テストではない）
- ❌ `vector-search-report-generator.ts` - 削除済み（レポート生成スクリプト、テストではない）
- ❌ `run-all-vector-search-tests.ts` - 削除済み（分析スクリプトを実行するだけ）
- ❌ `all-quality-tests-runner.ts` - 削除済み（`feature-tests-runner.ts`と重複）

これらのテストは`feature-tests-runner.ts`からも削除されています。

### テストの実行時間

一部のテストは実行に時間がかかります：

- **ハイブリッド検索テスト**: 約10-20秒（5つのクエリを実行）
- **ベクトル検索一貫性テスト**: 約30-60秒（13のクエリを実行）
- **ストリーミング要約テスト**: 約5-10秒（3つのクエリを実行）

初回実行時はLunrインデックスの初期化に時間がかかる場合があります。

## ⚠️ テストカバレッジの現状

現在のテストスイートは、**過去の寄せ集めのテストファイルを統合しているだけで、本来テストすべき機能・非機能要件・ファイル・デプロイのテストが十分にカバーされていません**。

詳細な分析については、**[テストカバレッジ分析](./05.14-test-coverage-analysis.md)**を参照してください。

### 主な不足項目

1. **認証・認可テスト**（高優先度）
   - Googleアカウント認証フロー
   - ドメイン制限（@tomonokai-corp.com）
   - セッション管理

2. **APIエンドポイントテスト**（高優先度）
   - `/api/streaming-process`のエラーハンドリング
   - `/api/admin/*`の認証・認可
   - 不正リクエストの処理

3. **会話履歴・コンテキスト管理テスト**（高優先度）
   - 会話履歴の保存・取得
   - 深掘り質問のコンテキスト維持
   - Firestore統合

4. **デプロイ前検証テスト**（高優先度）
   - 環境変数の検証
   - ビルドエラーの検出
   - 本番デプロイ準備

5. **セキュリティテスト**（高優先度）
   - XSS/CSRF対策
   - APIキー管理
   - データ保護

6. **UI/UXテスト**（中優先度）
   - マークダウン表示の正確性
   - 参照元リンクの動作
   - レスポンシブデザイン

7. **データ整合性テスト**（中優先度）
   - LanceDBファイルの整合性
   - Firestoreデータの同期状態
   - インデックスの整合性

### 改善の方向性

1. **テスト戦略の明確化**: 機能要件・非機能要件ごとにテストを分類
2. **テストカバレッジの向上**: 不足しているテスト項目を優先順位付けして実装
3. **テストの体系化**: テストをカテゴリごとに整理
4. **CI/CD統合**: 自動テスト実行の仕組みを構築

