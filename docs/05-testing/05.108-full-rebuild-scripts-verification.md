# 完全再構築スクリプトの動作確認

## 実施日
2025-01-28

## 確認項目

### ✅ 1. 構文チェック

#### Confluence完全再構築スクリプト
- ✅ **リンターエラー**: なし
- ✅ **インポートパス**: 正しい
  - `import 'dotenv/config'`
  - `import { exec } from 'child_process'`
  - `import { promisify } from 'util'`

#### Jira完全再構築スクリプト
- ✅ **リンターエラー**: なし
- ✅ **インポートパス**: 正しい
  - `import 'dotenv/config'`
  - `import { JiraSyncService } from '@/lib/jira-sync-service'`
  - `import { lunrInitializer } from '@/lib/lunr-initializer'`
  - `import { exec } from 'child_process'`
  - `import { promisify } from 'util'`

---

### ✅ 2. 依存スクリプトの存在確認

#### Confluence完全再構築スクリプト

| 依存スクリプト | パス | 状態 |
|--------------|------|------|
| `batch-sync-confluence.ts` | `src/scripts/batch-sync-confluence.ts` | ✅ 存在 |
| `sync-firestore-labels-to-lancedb.ts` | `scripts/sync-firestore-labels-to-lancedb.ts` | ✅ 存在 |
| `rebuild-lunr-msgpack.ts` | `scripts/rebuild-lunr-msgpack.ts` | ✅ 存在（`rebuild:lunr`経由） |
| `create-lancedb-indexes.ts` | `scripts/create-lancedb-indexes.ts` | ✅ 存在 |
| `upload-production-data.ts` | `scripts/upload-production-data.ts` | ✅ 存在 |

#### Jira完全再構築スクリプト

| 依存スクリプト/クラス | パス | 状態 |
|---------------------|------|------|
| `JiraSyncService` | `src/lib/jira-sync-service.ts` | ✅ 存在 |
| `lunrInitializer` | `src/lib/lunr-initializer.ts` | ✅ 存在 |
| `sync-firestore-jira-labels-to-lancedb.ts` | `scripts/sync-firestore-jira-labels-to-lancedb.ts` | ✅ 存在 |
| `create-lancedb-indexes.ts` | `scripts/create-lancedb-indexes.ts` | ✅ 存在 |
| `upload-production-data.ts` | `scripts/upload-production-data.ts` | ✅ 存在 |

---

### ✅ 3. package.jsonコマンドの確認

#### 必要なコマンドが定義されている

| コマンド | 定義 | 状態 |
|---------|------|------|
| `sync:confluence:batch` | `tsx src/scripts/batch-sync-confluence.ts` | ✅ 定義済み |
| `sync:confluence:differential` | `tsx src/scripts/batch-sync-confluence.ts --differential` | ✅ 定義済み |
| `sync:confluence:rebuild` | `tsx scripts/sync-confluence-full-rebuild.ts` | ✅ 定義済み |
| `sync:jira:rebuild` | `tsx scripts/sync-jira-full-rebuild.ts` | ✅ 定義済み |
| `rebuild:lunr` | `tsx scripts/rebuild-lunr-msgpack.ts` | ✅ 定義済み |
| `lancedb:create-indexes` | `tsx scripts/create-lancedb-indexes.ts` | ✅ 定義済み |

---

### ✅ 4. 処理フローの確認

#### Confluence完全再構築スクリプト

```typescript
Step 1: sync:confluence:batch または sync:confluence:differential
  ↓
Step 2: sync-firestore-labels-to-lancedb.ts
  ↓
Step 3: rebuild:lunr (全テーブル対象)
  ↓
Step 4: create-lancedb-indexes.ts (全テーブル対象)
  ↓
Step 5: upload-production-data.ts (UPLOAD_TABLE_FILTER=confluence)
```

**注意点**:
- Step 3とStep 4は全テーブルを対象にしますが、問題ありません（Confluenceテーブルが更新されれば、他のテーブルは変更されないため）
- Step 5では`UPLOAD_TABLE_FILTER=confluence`でConfluenceテーブルのみがアップロードされます

#### Jira完全再構築スクリプト

```typescript
Step 1: JiraSyncService.syncAllIssues() (直接呼び出し)
  ↓
Step 2: sync-firestore-jira-labels-to-lancedb.ts
  ↓
Step 3: lunrInitializer.initializeAsync('jira_issues') (直接呼び出し)
  ↓
Step 4: create-lancedb-indexes.ts (全テーブル対象)
  ↓
Step 5: upload-production-data.ts (UPLOAD_TABLE_FILTER=jira_issues)
```

**注意点**:
- Step 3は直接`lunrInitializer.initializeAsync('jira_issues')`を呼び出し、Jiraテーブルのみを対象にします
- Step 4は全テーブルを対象にしますが、問題ありません（Jiraテーブルが更新されれば、他のテーブルは変更されないため）
- Step 5では`UPLOAD_TABLE_FILTER=jira_issues`でJiraテーブルのみがアップロードされます

---

### ✅ 5. 環境変数の使用

#### Confluence完全再構築スクリプト

| 環境変数 | 用途 | デフォルト値 |
|---------|------|------------|
| `SYNC_TYPE` | 同期タイプ（'differential' または 'batch'） | 'batch' |
| `SKIP_STRUCTURED_LABELS` | StructuredLabel同期をスキップ | 'false' |
| `SKIP_GCS_UPLOAD` | GCSアップロードをスキップ | 'false' |

#### Jira完全再構築スクリプト

| 環境変数 | 用途 | デフォルト値 |
|---------|------|------------|
| `JIRA_MAX_ISSUES` | 最大取得件数（0で全件取得） | 1000 |
| `SKIP_STRUCTURED_LABELS` | StructuredLabel同期をスキップ | 'false' |
| `SKIP_GCS_UPLOAD` | GCSアップロードをスキップ | 'false' |

---

### ✅ 6. エラーハンドリング

#### Confluence完全再構築スクリプト

- ✅ Step 1: エラー時は処理を停止（`throw error`）
- ✅ Step 2: エラー時は警告を出力して処理を継続（`return false`）
- ✅ Step 3: エラー時は処理を停止（`throw error`）
- ✅ Step 4: エラー時は処理を停止（`throw error`）
- ✅ Step 5: エラー時は警告を出力して処理を継続（`return false`）

#### Jira完全再構築スクリプト

- ✅ Step 1: エラー時は処理を停止（`throw error`）
- ✅ Step 2: エラー時は警告を出力して処理を継続（`return false`）
- ✅ Step 3: エラー時は処理を停止（`throw error`）
- ✅ Step 4: エラー時は処理を停止（`throw error`）
- ✅ Step 5: エラー時は警告を出力して処理を継続（`return false`）

---

## 動作確認手順

### 1. ドライラン（実際には実行しない）

#### Confluence完全再構築スクリプト

```bash
# GCSアップロードをスキップして実行
SKIP_GCS_UPLOAD=true npm run sync:confluence:rebuild
```

#### Jira完全再構築スクリプト

```bash
# GCSアップロードをスキップして実行（最大10件でテスト）
JIRA_MAX_ISSUES=10 SKIP_GCS_UPLOAD=true npm run sync:jira:rebuild
```

### 2. 本番環境での実行

#### Confluence完全再構築スクリプト

```bash
# 完全再構築（全ての処理を実行）
npm run sync:confluence:rebuild
```

#### Jira完全再構築スクリプト

```bash
# 完全再構築（全ての処理を実行）
npm run sync:jira:rebuild

# または、全件取得モード
JIRA_MAX_ISSUES=0 npm run sync:jira:rebuild
```

---

## 確認すべきポイント

### ✅ スクリプト実行前

1. **環境変数の確認**
   - `.env.local`ファイルが存在する
   - 必要な環境変数が設定されている

2. **依存スクリプトの存在確認**
   - 上記の依存スクリプトが全て存在する
   - package.jsonに必要なコマンドが定義されている

### ✅ スクリプト実行中

1. **各ステップの正常終了確認**
   - 各ステップが正常に完了する
   - エラーメッセージが表示されない

2. **ログ出力の確認**
   - 処理の進行状況が表示される
   - エラーメッセージが適切に表示される

### ✅ スクリプト実行後

1. **データの確認**
   - Firestoreにデータが保存されている
   - LanceDBにデータが保存されている
   - インデックスが作成されている

2. **GCSアップロードの確認**
   - GCSにデータがアップロードされている（`SKIP_GCS_UPLOAD=false`の場合）
   - アップロードされたデータが正しい

---

## 結論

### ✅ スクリプトは正しく動作する準備が整っています

1. **✅ 構文エラー**: なし
2. **✅ 依存スクリプト**: 全て存在
3. **✅ package.jsonコマンド**: 全て定義済み
4. **✅ 処理フロー**: 正しく実装されている
5. **✅ エラーハンドリング**: 適切に実装されている
6. **✅ 環境変数**: 適切に使用されている

**次は実際にドライランで動作確認を行ってください。**

