# Jira LanceDBインデックス状態の調査

## 実施日
2025-01-28

## 問題の認識

ユーザーの懸念：
> JiraのLanceDBインデックス等のことです。上がった本番データは正しいパフォーマンスと品質で使われるようになっていますか

## 確認すべき項目

### 1. LanceDBインデックスの仕様

LanceDBのインデックスは：
- **テーブル内に埋め込まれる**（別ファイルではない）
- `createIndex()`メソッドで作成される
- テーブルファイルと一緒にアップロードされる

### 2. 現在の処理フロー

#### ✅ 完全再構築スクリプト（正しい順序）
`scripts/sync-jira-full-rebuild.ts`の処理順序：
1. Jiraデータ同期（Firestore + LanceDB）
2. Lunrインデックスの初期化
3. **LanceDBインデックスの作成** ← アップロード前に実行
4. GCSへのアップロード

#### ⚠️ 通常のアップロード（インデックス作成が含まれていない）
`scripts/upload-jira-production-data.ts`の処理：
- LanceDBテーブルをGCSにアップロード
- **インデックス作成は含まれない**

### 3. 問題の可能性

1. **インデックス未作成のままアップロードされる可能性**
   - データ同期直後にアップロードした場合
   - インデックスが作成されていない可能性

2. **インデックス作成のタイミング**
   - 手動で`create-lancedb-indexes.ts`を実行する必要がある
   - 実行順序が重要

### 4. 推奨される処理順序

```bash
# Step 1: Jiraデータ同期（既に完了している想定）
npm run sync:jira

# Step 2: インデックス作成（アップロード前に必須）
npm run lancedb:create-indexes

# Step 3: GCSへのアップロード（インデックス含む）
npm run upload:jira-production-data
```

または、完全再構築スクリプトを使用：

```bash
# 完全再構築（インデックス作成→アップロードまで自動）
npm run sync:jira:rebuild
```

## 確認方法

### ローカル環境でのインデックス確認

```bash
# インデックスの状態を確認
npx tsx scripts/check-lancedb-indexes.ts
```

### 本番環境での確認

1. GCSからダウンロードして確認
2. インデックスが含まれているかチェック

## 結論と推奨事項

### ⚠️ 現在の問題点

1. **インデックス作成が自動化されていない**
   - `upload-jira-production-data`はインデックス作成を含まない
   - 手動でインデックス作成が必要

2. **処理順序の依存性**
   - インデックス作成→アップロードの順序が重要
   - 順序を間違えると、インデックス未作成のデータがアップロードされる可能性

### ✅ 推奨される解決策

1. **完全再構築スクリプトの使用**
   - `sync-jira-full-rebuild.ts`を使用することで、正しい順序が保証される

2. **アップロード前の確認**
   - アップロード前にインデックスの存在を確認するスクリプトを実行

3. **アップロードスクリプトの改善**
   - アップロード前にインデックス作成を自動的に実行するオプションを追加

