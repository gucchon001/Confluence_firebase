# Jira Issue Key完全一致検索 - 根本原因と解決策

**作成日**: 2025-01-27  
**ステータス**: ✅ 解決済み

---

## 📋 問題の概要

Issue Key（例: `CTJ-5439`）で検索した場合、Issue Key完全一致の結果が最終的な検索結果に含まれない問題が発生していました。

---

## 🔍 根本原因の特定（ステップバイステップ）

### ステップ1: タイトル救済検索
- ✅ Issue Key完全一致の結果が追加される（`Added 1 Issue Key exact match results`）
- ✅ 先頭に配置される（`1. CTJ-5439 - Issue Key Exact: true`）
- ✅ `vectorResults`に追加される

**状態**: ✅ Issue Key完全一致の結果が存在（1件）

### ステップ2: ハイブリッドスコア処理
- ✅ Issue Key完全一致の結果が保持される（`After hybrid score processing: 30 results, Issue Key exact: 1`）
- ✅ `_issueKeyExact`フラグが保持される

**状態**: ✅ Issue Key完全一致の結果が存在（1件）

### ステップ3: BM25結果のマージ処理
- ✅ Issue Key完全一致の結果が保持される（`After BM25 merge: 42 results, Issue Key exact: 1`）

**状態**: ✅ Issue Key完全一致の結果が存在（1件）

### ステップ4: RRF処理前の絞り込み処理
- ✅ Issue Key完全一致の結果が保持される（`After slice for RRF: 42 results, Issue Key exact: 1`）

**状態**: ✅ Issue Key完全一致の結果が存在（1件）

### ステップ5: RRF処理（`unifiedSearchResultProcessor.processSearchResults`）
- ❌ Issue Key完全一致の結果が失われる（`Before RRF sort: 42 results, Issue Key exact: 0`）

**問題箇所**: `formatResults`関数で、`_issueKeyExact`フラグが返されるオブジェクトに含まれていなかった

---

## 🎯 根本原因

**`formatResults`関数（`src/lib/unified-search-result-processor.ts`）で、Issue Key完全一致のフラグ（`_issueKeyExact`）が返されるオブジェクトに含まれていなかったため、後続の処理でIssue Key完全一致の結果が識別できなくなっていました。**

---

## 🔧 実装した修正

### 1. `formatResults`関数で`_issueKeyExact`フラグを保持
- `formatResults`関数で返されるオブジェクトに`_issueKeyExact`フラグを追加

### 2. `applyRRFFusion`関数で`_issueKeyExact`フラグを保持
- RRF処理中に`_issueKeyExact`フラグを明示的に保持

### 3. その他の修正
- ハイブリッドスコア処理で`_issueKeyExact`フラグを保持
- RRF処理前の絞り込み処理でIssue Key完全一致の結果を優先的に含める
- Composite Scoring処理で`_issueKeyExact`フラグを保持
- 最終ソート処理でIssue Key完全一致の結果を最優先に配置

---

## ✅ 修正後の確認

デバッグログから、Issue Key完全一致の結果が各処理段階で保持されていることが確認できました：

1. ✅ RRF Sort前: `Issue Key exact: 1`
2. ✅ RRF Sort後: `Issue Key exact: 1`
3. ✅ Composite Scoring前: `Issue Key exact: 1`
4. ✅ Composite Scoring後: `Issue Key exact: 1`
5. ✅ 最終検索結果: `Issue Key exact: 1`

**テスト結果**: ✅ 成功 - Issue Key CTJ-5439 が最優先で返されました（位置: 1位）

---

## 🔗 関連ファイル

- `src/lib/lancedb-search-client.ts`: タイトル救済検索の実装
- `src/lib/unified-search-result-processor.ts`: RRF処理と結果フォーマット
- `src/lib/composite-scoring-service.ts`: Composite Scoring処理
- `scripts/trace-issue-key-flow.ts`: Issue Key完全一致検索結果の追跡スクリプト

