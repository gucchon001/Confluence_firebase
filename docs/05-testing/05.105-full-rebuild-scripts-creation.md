# ConfluenceとJiraの完全再構築スクリプト作成

## 実施日
2025-01-28

## 作成内容

### 1. Confluence完全再構築スクリプト

**ファイル**: `scripts/sync-confluence-full-rebuild.ts`

#### 処理フロー

```bash
1. Confluenceデータ同期（Firestore + LanceDB）
   ↓
2. StructuredLabel同期（Firestore → LanceDB）
   ↓
3. Lunrインデックスの再構築
   ↓
4. LanceDBインデックスの作成
   ↓
5. GCSへのアップロード（オプション）
```

#### 使用方法

```bash
# 完全再構築（全ての処理を実行）
npm run sync:confluence:rebuild

# 差分同期で再構築
SYNC_TYPE=differential npm run sync:confluence:rebuild

# StructuredLabel同期をスキップ
SKIP_STRUCTURED_LABELS=true npm run sync:confluence:rebuild

# GCSアップロードをスキップ
SKIP_GCS_UPLOAD=true npm run sync:confluence:rebuild
```

#### 環境変数

- `SYNC_TYPE`: 同期タイプ（`'differential'` または `'batch'`、デフォルト: `'batch'`）
- `SKIP_STRUCTURED_LABELS`: StructuredLabel同期をスキップ（`true`でスキップ）
- `SKIP_GCS_UPLOAD`: GCSアップロードをスキップ（`true`でスキップ）

#### 特徴

- **正しい順序が保証される**
- **全ての処理が一括で実行される**
- **Confluenceテーブルのみをアップロード**（テーブルフィルター対応）
- エラー時は処理が停止する（部分的な完了を防ぐ）

### 2. Jira完全再構築スクリプト（改善版）

**ファイル**: `scripts/sync-jira-full-rebuild.ts`（既存、改善）

#### 改善点

- **StructuredLabel同期を追加**（Step 2として追加）
- **Jiraテーブルのみをアップロード**（テーブルフィルター対応）

#### 処理フロー

```bash
1. Jiraデータ同期（Firestore + LanceDB）
   ↓
2. StructuredLabel同期（Firestore → LanceDB）
   ↓
3. Lunrインデックスの初期化
   ↓
4. LanceDBインデックスの作成
   ↓
5. GCSへのアップロード（オプション）
```

#### 使用方法

```bash
# 完全再構築（全ての処理を実行）
npm run sync:jira:rebuild

# 最大取得件数を指定
JIRA_MAX_ISSUES=500 npm run sync:jira:rebuild

# StructuredLabel同期をスキップ
SKIP_STRUCTURED_LABELS=true npm run sync:jira:rebuild

# GCSアップロードをスキップ
SKIP_GCS_UPLOAD=true npm run sync:jira:rebuild
```

#### 環境変数

- `JIRA_MAX_ISSUES`: 最大取得件数（デフォルト: 1000、0で全件取得）
- `SKIP_STRUCTURED_LABELS`: StructuredLabel同期をスキップ（`true`でスキップ）
- `SKIP_GCS_UPLOAD`: GCSアップロードをスキップ（`true`でスキップ）

## 比較表

| 項目 | Confluence | Jira |
|-----|-----------|------|
| **スクリプトファイル** | `sync-confluence-full-rebuild.ts` | `sync-jira-full-rebuild.ts` |
| **npmコマンド** | `npm run sync:confluence:rebuild` | `npm run sync:jira:rebuild` |
| **データ同期** | ✅ 差分または完全同期 | ✅ 最大件数指定可能 |
| **StructuredLabel同期** | ✅ 含まれる（オプション） | ✅ 含まれる（オプション） |
| **Lunrインデックス** | ✅ 再構築 | ✅ 初期化 |
| **LanceDBインデックス** | ✅ 作成 | ✅ 作成 |
| **GCSアップロード** | ✅ 含まれる（オプション、Confluenceテーブルのみ） | ✅ 含まれる（オプション、Jiraテーブルのみ） |

## 利点

### ✅ 処理順序の保証

- 全ての処理が正しい順序で実行される
- エラー時は処理が停止する（部分的な完了を防ぐ）

### ✅ 一括実行

- 複数のコマンドを実行する必要がない
- 全ての処理が1つのスクリプトで完結

### ✅ テーブル分離

- ConfluenceとJiraのテーブルが分離されている
- 互いに影響を与えない

### ✅ オプション対応

- StructuredLabel同期をスキップ可能
- GCSアップロードをスキップ可能

## 推奨される使用シーン

### Confluence完全再構築スクリプト

1. **初回セットアップ時**
   - 全てのデータを同期
   - インデックスを作成
   - 本番環境にデプロイ

2. **大規模変更後**
   - スキーマ変更後
   - データ不整合時

3. **定期メンテナンス**
   - 週次または月次の完全再構築

### Jira完全再構築スクリプト

1. **初回セットアップ時**
   - 全てのデータを同期
   - インデックスを作成
   - 本番環境にデプロイ

2. **チャンク分割機能追加後**
   - スキーマ変更後
   - データ不整合時

3. **定期メンテナンス**
   - 週次または月次の完全再構築

## 注意事項

### ⚠️ 処理時間

- 完全再構築には時間がかかる場合があります
- Confluence: 約30〜60分（全ページ同期の場合）
- Jira: 約10〜30分（全件取得の場合）

### ⚠️ APIレート制限

- Confluence APIとJira APIのレート制限に注意
- 429エラーが発生する可能性があります（Jiraではリトライ処理済み）

### ⚠️ 本番環境への影響

- GCSアップロードを実行すると、本番環境のデータが更新されます
- テスト環境で実行する場合は`SKIP_GCS_UPLOAD=true`を使用してください

## 次のステップ

1. **テスト実行**
   - ローカル環境で完全再構築スクリプトをテスト
   - 各ステップが正常に実行されることを確認

2. **本番環境デプロイ**
   - テスト完了後、本番環境で実行
   - インデックスとキャッシュが正しく作成されることを確認

3. **ドキュメント更新**
   - 運用ガイドに完全再構築スクリプトの使用方法を追加

