# メモリ監視付きパフォーマンステスト結果 (2025-11-22)

**作成日**: 2025年11月22日  
**ステータス**: 🔍 分析完了

---

## 📊 テスト結果サマリー

**実施日**: 2025-11-22  
**テスト方法**: 実際のAPIエンドポイント（`/api/streaming-process`）  
**テストモード**: キャッシュ無効（`--no-cache`）+ ウォームアップリクエスト自動実行 + メモリ監視有効

**平均値**:
- 検索時間: **32159.60ms**（約32秒、目標: 2000ms以下、超過: 30159.60ms）⚠️
- AI生成時間: **16758.60ms**（約17秒、目標: 15000ms以下、超過: 1758.60ms）⚠️
- 初回チャンク時間: **46102.00ms**（約46秒、目標: 5000ms以下、超過: 41102.00ms）⚠️
- 総処理時間: **48918.20ms**（約49秒、目標: 20000ms以下、超過: 28918.20ms）⚠️

**最大値**:
- 最大検索時間: **55694ms**（約56秒）⚠️
- 最大AI生成時間: **26251ms**（約26秒）⚠️
- 最大総処理時間: **72342ms**（約72秒）⚠️

---

## 📊 メモリ監視結果

### メモリ使用量の推移

| クエリ | 開始時RSS | 完了時RSS | RSS差分 | 開始時Heap | 完了時Heap | Heap差分 | 評価 |
|--------|----------|----------|---------|-----------|-----------|----------|------|
| 1. 学年自動更新バッチ | 88.81MB | 85.30MB | **-3.51MB** | 10.11MB | 10.50MB | +0.39MB | ✅ **正常** |
| 2. 教室管理の詳細 | 86.11MB | 87.15MB | **+1.04MB** | 10.33MB | 11.04MB | +0.70MB | ✅ **正常** |
| 3. 会員登録機能 | 87.55MB | 88.05MB | **+0.50MB** | 10.97MB | 11.05MB | +0.08MB | ✅ **正常** |
| 4. 求人削除機能 | 88.27MB | 87.23MB | **-1.03MB** | 11.47MB | 11.43MB | -0.05MB | ✅ **正常** |
| 5. 応募管理の一覧 | 87.35MB | 84.40MB | **-2.95MB** | 11.22MB | 11.64MB | +0.42MB | ✅ **正常** |

### メモリ分析結果

**結論**: ✅ **メモリリークは発生していない**

**理由**:
1. **メモリ増加が小さい**: 各クエリでRSSの増加は最大でも+1.04MB（警告閾値100MBを大幅に下回る）
2. **メモリが解放されている**: 一部のクエリでRSSが減少しており、ガベージコレクションが正常に動作している
3. **ヒープ使用量の増加が小さい**: ヒープ使用量の増加は最大でも+0.70MB（警告閾値50MBを大幅に下回る）

---

## 🔍 パフォーマンス分析

### クエリ別の詳細結果

| クエリ | 検索時間 | AI生成時間 | 総処理時間 | メモリ差分（RSS） | 評価 |
|--------|---------|-----------|-----------|------------------|------|
| 1. 学年自動更新バッチ | 908ms | 4536ms | 5444ms | -3.51MB | ✅ **正常** |
| 2. 教室管理の詳細 | 46091ms | 26251ms | 72342ms | +1.04MB | ❌ **検索が異常に遅い** |
| 3. 会員登録機能 | 34055ms | 23596ms | 57651ms | +0.50MB | ❌ **検索が異常に遅い** |
| 4. 求人削除機能 | 24050ms | 17854ms | 41904ms | -1.03MB | ❌ **検索が異常に遅い** |
| 5. 応募管理の一覧 | 55694ms | 11556ms | 67250ms | -2.95MB | ❌ **検索が異常に遅い** |

---

## 🎯 問題の特定

### 問題1: **検索時間が異常に長い** 🔴 **最重要**

**症状**:
- クエリ1: 908ms ✅ **正常**
- クエリ2-5: 24-56秒 ❌ **異常に遅い**

**原因分析**:

#### 原因1: **キャッシュクリア後のウォームアップリクエストのコスト** 🔴 **最有力**

**処理フロー**:
1. キャッシュをクリア（Lunrインデックス、トークナイザー、埋め込み生成を削除）
2. ウォームアップリクエストを実行（初期化をトリガー）
3. 5秒待機
4. 実際のテストクエリを実行

**問題**:
- ウォームアップリクエスト自体に時間がかかる（371-865ms）
- しかし、実際のテストクエリで検索時間が24-56秒かかっている
- これは、ウォームアップリクエストが完全に初期化を完了していない可能性がある

**ウォームアップリクエストの実行時間**:
- クエリ1の前: 77442ms（約77秒）⚠️ **異常に長い**
- クエリ2の前: 371ms ✅ **正常**
- クエリ3の前: 401ms ✅ **正常**
- クエリ4の前: 326ms ✅ **正常**
- クエリ5の前: 865ms ✅ **正常**

**結論**: **初回のウォームアップリクエストが77秒かかっており、その後のクエリでも検索が遅い**

---

#### 原因2: **Lunrインデックスの再読み込み** 🔴 **最有力**

**問題**:
- 各クエリの前にキャッシュをクリアしている
- Lunrインデックスがメモリから削除される
- 次のリクエストでLunrインデックスを再読み込みする必要がある
- しかし、ウォームアップリクエストが完全に初期化を完了していない可能性がある

**検証**:
- クエリ1: 検索時間 908ms（ウォームアップ後、正常）
- クエリ2-5: 検索時間 24-56秒（キャッシュクリア後のウォームアップ後に異常に遅い）

**結論**: **キャッシュクリア後のウォームアップリクエストが不完全な初期化しか行っていない可能性がある**

---

### 問題2: **ウォームアップリクエストの待機時間が不十分** 🟡 **中程度**

**現在の実装**:
- ウォームアップリクエスト完了後、5秒待機
- しかし、Lunrインデックスの再読み込みには10-40秒かかる可能性がある

**検証**:
- クエリ1の前のウォームアップ: 77442ms（約77秒）
- これは、Lunrインデックスの再読み込みに時間がかかっていることを示している

**結論**: **5秒の待機時間では不十分な可能性がある**

---

## 📊 メモリとパフォーマンスの関係

### メモリリークは発生していない ✅

**証拠**:
1. メモリ使用量の増加が小さい（±3MB程度）
2. 一部のクエリでメモリが解放されている
3. RSSの増加が警告閾値（100MB）を大幅に下回る

**結論**: **メモリリークやリソース競合が原因ではない**

---

### パフォーマンスの問題は別の原因 🔴

**証拠**:
1. メモリ使用量は正常
2. 検索時間が異常に長い（24-56秒）
3. クエリ1だけが正常（908ms）

**原因候補**:
1. **Lunrインデックスの再読み込み**: キャッシュクリア後のウォームアップリクエストが不完全
2. **初期化の完了待ち**: 5秒の待機時間が不十分
3. **非同期処理の競合**: 前のリクエストが完全に終了していない状態で次のリクエストが実行される

---

## ✅ 結論

### メモリ監視の結果

1. ✅ **メモリリークは発生していない**
   - メモリ使用量の増加が小さい（±3MB程度）
   - ガベージコレクションが正常に動作している
   - RSSの増加が警告閾値を大幅に下回る

2. ✅ **リソース競合は発生していない**
   - メモリ使用量が安定している
   - リクエスト間の待機時間（2秒）でメモリが適切に解放されている

---

### パフォーマンス問題の原因

1. 🔴 **Lunrインデックスの再読み込み**: キャッシュクリア後のウォームアップリクエストが不完全な初期化しか行っていない
2. 🔴 **初期化の完了待ち**: 5秒の待機時間が不十分な可能性がある
3. 🟡 **非同期処理の競合**: 前のリクエストが完全に終了していない状態で次のリクエストが実行される可能性がある

---

### 推奨事項

1. **ウォームアップリクエストの完了を確実に待つ**
   - Lunrインデックスの初期化完了をポーリングで確認
   - 初期化完了まで待機（タイムアウト: 60秒）

2. **待機時間の動的調整**
   - ウォームアップリクエストの実行時間に応じて待機時間を調整
   - 例: ウォームアップが10秒かかった場合、追加で10秒待機

3. **キャッシュクリアの見直し**
   - 各クエリの前にキャッシュをクリアするのではなく、テスト開始前に1回だけクリア
   - または、キャッシュクリアをスキップしてウォームアップリクエストのみ実行

---

## 🔗 関連ドキュメント

- [パフォーマンスデグレード分析](./05.38-performance-regression-analysis-2025-11-22.md)
- [コールドスタート発生原因の分析](./05.36-cold-start-analysis-2025-11-22.md)
- [メモリ使用量分析](../01-architecture/MEMORY_USAGE_ANALYSIS_2025-11-21.md)
- [パフォーマンステスト](./05.04-performance-tests.md)

