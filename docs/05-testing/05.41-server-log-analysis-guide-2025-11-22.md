# サーバー側ログ分析ガイド (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: パフォーマンス問題の原因を特定するために、サーバー側のログを確認する方法

---

## 📊 現在の状況

### クライアント側のテスト結果

| クエリ | 検索時間 | ウォームアップ時間 | 評価 |
|--------|---------|------------------|------|
| 1. 学年自動更新バッチ | **908ms** | 77442ms（約77秒） | ✅ **正常** |
| 2. 教室管理の詳細 | **46091ms** (約46秒) | 371ms | ❌ **異常** |
| 3. 会員登録機能 | **34055ms** (約34秒) | 401ms | ❌ **異常** |
| 4. 求人削除機能 | **24050ms** (約24秒) | 326ms | ❌ **異常** |
| 5. 応募管理の一覧 | **55694ms** (約56秒) | 865ms | ❌ **異常** |

**問題**: クエリ2-5の検索時間が24-56秒と異常に長い（目標: 2000ms以下）

---

## 🔍 サーバー側ログの確認方法

### ステップ1: 開発サーバーのターミナルを確認

テストを実行している間、**開発サーバーを起動している別のターミナル**で以下のログを確認してください。

---

### ステップ2: 確認すべきログ

#### 1. **検索処理の開始**

```
[PERF] 🔍 検索処理開始（ユーザー認識時間）: <timestamp>
```

**確認ポイント**: リクエストがサーバーに到達した時刻

---

#### 2. **retrieveRelevantDocsの呼び出し**

```
[PERF] 📥 retrieveRelevantDocs呼び出し開始: <time>ms (リクエスト受信からの経過時間)
[PERF] 📥 retrieveRelevantDocs完了: <time>ms (累計: <time>ms)
```

**確認ポイント**: 
- `retrieveRelevantDocs`の実行時間
- 目標: 5000ms以下

---

#### 3. **実際の検索処理開始**

```
[PERF] 🔍 実際の検索処理開始: <time>ms (初期化時間を除外)
```

**確認ポイント**: 初期化時間を除外した実際の検索処理の開始時刻

---

#### 4. **並列検索の完了**

```
[PERF] ⏱️ Phase 5 parallel search completed in <time>ms (<time>s)
```

**確認ポイント**: 
- ベクトル検索とBM25検索の並列実行時間
- 目標: 3000ms以下

---

#### 5. **ベクトル検索の完了**

```
[PERF] 🔍 Vector search completed in <time>ms
```

**確認ポイント**: 
- ベクトル検索の実行時間
- 目標: 1000ms以下
- **5秒以上かかっている場合、これがボトルネック**

---

#### 6. **BM25検索の完了**

```
[BM25 Search] ✅ BM25 search completed in <time>ms
```

**確認ポイント**: 
- BM25検索の実行時間
- 目標: 2000ms以下
- **5秒以上かかっている場合、これがボトルネック**

---

#### 7. **BM25初期化待機時間**

```
[BM25 Search] Lunr not ready for <table>, initializing...
[BM25 Search] ✅ Lunr initialization completed for <table>
または
[BM25 Search] ⏳ Lunr initialization timeout for <table> after 60s, polling for readiness...
[BM25 Search] ✅ Lunr ready for <table> after <time>ms total wait time
```

**確認ポイント**: 
- Lunrインデックスの初期化待機時間
- 目標: 5000ms以下
- **20秒以上かかっている場合、これがボトルネック**

---

#### 8. **検索処理の完了**

```
[PERF] 🔍 検索処理完了（ユーザー認識時間）: 総時間 <time>ms (リクエスト受信から検索完了まで)
```

**確認ポイント**: 検索処理全体の時間（クライアント側の計測と一致するはず）

---

#### 9. **検索パフォーマンスの内訳**

```
[PERF] 🔍 Search performance breakdown: {
  searchLanceDB: '<time>ms',
  enrichWithAllChunks: '<time>ms',
  filterInvalidPages: '<time>ms',
  total: '<time>ms',
  query: '<query>'
}
```

**確認ポイント**: 
- `searchLanceDB`: ベクトル検索とBM25検索の時間
- `enrichWithAllChunks`: チャンク統合の時間
- `filterInvalidPages`: フィルタリングの時間
- 目標: 合計5000ms以下

---

## 📋 ログ分析の手順

### クエリ2の例（検索時間: 46091ms）

1. **検索処理の開始時刻を記録**
   ```
   [PERF] 🔍 検索処理開始（ユーザー認識時間）: 2025-11-22T10:00:00.000Z
   ```

2. **retrieveRelevantDocsの時間を確認**
   ```
   [PERF] 📥 retrieveRelevantDocs呼び出し開始: 5ms
   [PERF] 📥 retrieveRelevantDocs完了: 46000ms (累計: 46005ms)
   ```
   → **retrieveRelevantDocsが46000msかかっている**（これがボトルネック）

3. **検索処理の内訳を確認**
   ```
   [PERF] 🔍 実際の検索処理開始: 10ms
   [PERF] ⏱️ Phase 5 parallel search completed in 45000ms
   [PERF] 🔍 Vector search completed in 500ms
   [BM25 Search] ✅ BM25 search completed in 44500ms
   ```
   → **BM25検索が44500msかかっている**（これがボトルネック）

4. **BM25初期化待機時間を確認**
   ```
   [BM25 Search] Lunr not ready for confluence, initializing...
   [BM25 Search] ⏳ Lunr initialization timeout for confluence after 60s, polling for readiness...
   [BM25 Search] ✅ Lunr ready for confluence after 44000ms total wait time
   ```
   → **Lunrインデックスの初期化待機が44000msかかっている**（これがボトルネック）

---

## 🎯 ボトルネックの特定

### パターン1: **Lunrインデックスの初期化待機が長い** 🔴 **最有力**

**症状**:
- `[BM25 Search] ✅ Lunr ready for <table> after <time>ms` が20秒以上
- ウォームアップリクエストが371-865msで完了しているが、実際のテストクエリで検索が遅い

**原因**:
- ウォームアップリクエストが完了したと思っているが、Lunrインデックスの再読み込みがバックグラウンドで継続している
- 5秒の待機時間が不十分

**対策**:
- Lunrインデックスの初期化完了をポーリングで確認
- 待機時間を動的に調整

---

### パターン2: **ベクトル検索が遅い** 🟡 **中程度**

**症状**:
- `[PERF] 🔍 Vector search completed in <time>ms` が5秒以上

**原因**:
- LanceDBのメモリマップドファイルの読み込みに時間がかかっている
- ベクトル検索のクエリ実行に時間がかかっている

**対策**:
- LanceDBのメモリマップドファイルを事前に読み込む
- ベクトル検索のクエリを最適化

---

### パターン3: **BM25検索が遅い** 🟡 **中程度**

**症状**:
- `[BM25 Search] ✅ BM25 search completed in <time>ms` が5秒以上（初期化待機時間を除く）

**原因**:
- キーワード検索の実行に時間がかかっている
- トークナイザーの初期化に時間がかかっている

**対策**:
- キーワード検索の最適化
- トークナイザーの事前初期化

---

## 📊 ログの記録方法

### 方法1: ターミナルのログをコピー

開発サーバーのターミナルで、テスト実行中のログをコピーして共有してください。

---

### 方法2: ログファイルに出力（将来の改善）

サーバー側のログをファイルに出力する機能を追加する予定です。

---

## ✅ 次のステップ

1. **開発サーバーのターミナルでログを確認**
   - テスト実行中に、上記のログが表示されるか確認
   - 特に、クエリ2-5の検索処理中のログを確認

2. **ボトルネックを特定**
   - どの段階で時間がかかっているか確認
   - 上記のパターンに当てはまるか確認

3. **ログを共有**
   - ボトルネックが特定できたら、ログを共有してください
   - 対策を実装します

---

## 🔗 関連ドキュメント

- [検索パフォーマンス詳細分析](./05.40-search-performance-detailed-analysis-2025-11-22.md)
- [メモリ監視付きパフォーマンステスト結果](./05.39-memory-monitoring-test-results-2025-11-22.md)
- [コールドスタート発生原因の分析](./05.36-cold-start-analysis-2025-11-22.md)

