# 回答品質テスト仕様書

## 概要

検索システムが適切なページを抽出し、それらに基づいてAIが正確で包括的な回答を生成できるかを評価する品質テスト仕様書です。

## 実装状況

- ✅ **テストスクリプト**: `src/tests/answer-quality-test.ts` で実装完了
  - 実行方法: `npm run test:answer-quality`
  - または: `npx tsx src/tests/answer-quality-test.ts`
- ✅ **自動評価機能**: 検索結果とAI回答の自動評価を実装
- ✅ **パフォーマンス測定**: 検索時間、AI生成時間、初回チャンク時間の測定
- ✅ **詳細レポート**: テスト結果の詳細な表示と合格/不合格の自動判定

## テスト対象クエリ

### クエリ1: 退会済み会員のメールアドレス再利用
**クエリ:** `退会した会員が同じアドレス使ったらどんな表示がでますか`

### クエリ2: 教室削除条件
**クエリ:** `教室削除ができる条件は？`

---

## テストケース1: 退会済み会員のメールアドレス再利用

### クエリ
`退会した会員が同じアドレス使ったらどんな表示がでますか`

### 期待される検索結果ページ

#### 必須ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `045_会員退会機能` | 80+ | `["機能要件"]` | 会員退会機能の詳細 |
| `046_会員新規登録機能` | 75+ | `["機能要件"]` | 新規会員登録時の処理 |
| `009_パスワード再設定機能` | 75+ | `["機能要件"]` | パスワード再設定時の処理 |

#### 関連ページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `会員管理機能` | 60+ | `["機能要件"]` | 会員管理全般 |
| `会員情報編集機能` | 50+ | `["機能要件"]` | 会員情報編集 |

### 期待される回答内容

#### 必須要素

1. **新規会員登録時の挙動**
   - ✅ `046_会員新規登録機能` の内容に基づく説明
   - ✅ 退会済みメールアドレスで新規登録が可能であること
   - ✅ 新しいアカウントとして登録されること
   - ✅ 特段のエラーメッセージは表示されないこと

2. **パスワード再設定時の挙動**
   - ✅ `009_パスワード再設定機能` の内容に基づく説明
   - ✅ 退会済みメールアドレスに対してエラーメッセージが表示されること
   - ✅ エラーメッセージの内容: 「お使いのメールアドレスは退会済みです。別のメールアドレスでの再登録をしてください。」

3. **ページ参照の明示**
   - ✅ **必須**: 回答内に「045」または「045_会員退会機能」が含まれていること
   - ✅ 046、009のページ番号が含まれていること

### 合格基準

#### 検索結果の品質
- [ ] `045_会員退会機能` が検索結果の上位5件に含まれる
- [ ] `046_会員新規登録機能` が検索結果に含まれる
- [ ] `009_パスワード再設定機能` が検索結果に含まれる
- [ ] 上位3件のスコアが60以上

#### 回答の品質
- [ ] 回答内に「045」または「045_会員退会機能」が明示的に含まれている
- [ ] 新規会員登録時の挙動が正確に説明されている
- [ ] パスワード再設定時の挙動が正確に説明されている
- [ ] エラーメッセージの内容が正確に記載されている
- [ ] 機能によって挙動が異なることが明確に説明されている

---

## テストケース2: 教室削除条件

### クエリ
`教室削除ができる条件は？`

### 期待される検索結果ページ

#### 必須ページ（優先度：高）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `164_【FIX】教室削除機能` | 85+ | `["機能要件"]` | 教室削除機能の詳細 |
| `177_【FIX】教室削除時...` | 80+ | `["機能要件"]` | 教室削除時の関連処理 |
| `161_【FIX】教室一覧閲覧機能` | 70+ | `["機能要件"]` | 教室一覧閲覧 |

#### 関連ページ（優先度：中）

| ページタイトル | 期待スコア | ラベル | 説明 |
|---|---|---|---|
| `応募情報` 関連ページ | 60+ | `["機能要件"]` | 応募情報の状態確認 |
| `求人管理` 関連ページ | 60+ | `["機能要件"]` | 求人の掲載状態確認 |

### 期待される回答内容

#### 必須要素

1. **権限に関する条件**
   - ✅ `164_【FIX】教室削除機能` の内容に基づく説明
   - ✅ システム管理者、塾講師ステーション管理者、ゲスト管理者のみが削除可能
   - ✅ ギフト券担当者、記事管理者、記事担当者は削除不可

2. **教室および求人の状態に関する条件（実行条件）**
   - ✅ **必須**: 回答内に「164」または「164_【FIX】教室削除機能」が含まれていること
   - ✅ **必須**: 回答内に「177」または「177_【FIX】教室削除時...」が含まれていること
   - ✅ 求人の掲載状態: 対象教室に紐づく求人がすべて「非掲載」状態であること
   - ✅ 応募情報の状態:
     - 応募情報が存在しない、または
     - 「採用ステータス（クライアント企業）」が「未登録」または「保留」のものが存在しない、または
     - 「採用」ステータスで「採用決定日」から1年以内のものが存在しない

3. **削除実行時の動作**
   - ✅ 教室情報の論理削除
   - ✅ 関連する帳票データの論理削除（求人情報、急募オプション、オシゴトQ&A、応募情報など）
   - ✅ 削除完了後のポップアップ表示と教室一覧ページへの遷移

4. **ページ参照の明示**
   - ✅ 164、177のページ番号が含まれていること
   - ✅ 161のページ番号が含まれていること（削除後の遷移先として）

### 合格基準

#### 検索結果の品質
- [ ] `164_【FIX】教室削除機能` が検索結果の上位3件に含まれる
- [ ] `177_【FIX】教室削除時...` が検索結果の上位5件に含まれる
- [ ] `161_【FIX】教室一覧閲覧機能` が検索結果に含まれる
- [ ] 上位3件のスコアが70以上

#### 回答の品質
- [ ] 回答内に「164」または「164_【FIX】教室削除機能」が明示的に含まれている
- [ ] 回答内に「177」または「177_【FIX】教室削除時...」が明示的に含まれている
- [ ] 権限に関する条件が正確に説明されている
- [ ] 教室および求人の状態に関する条件が正確に説明されている
- [ ] 応募情報の状態に関する詳細な条件が正確に説明されている
- [ ] 削除実行時の動作が正確に説明されている
- [ ] 条件がすべて満たされている必要があることが明確に説明されている

---

## 品質メトリクス

### 1. ページ抽出精度（Precision）

```
Precision = 関連するページ数 / 検索結果総数
```

**目標値:** 0.8以上

### 2. 必須ページ再現率（Recall）

```
Recall = 検索結果に含まれる必須ページ数 / 必須ページ総数
```

**目標値:** 1.0（すべての必須ページが検索結果に含まれる）

### 3. 回答完全性スコア

```
回答完全性 = (含まれる必須要素数 / 必須要素総数) × 100
```

**目標値:** 90%以上

### 4. ページ参照スコア

```
ページ参照スコア = (回答内に含まれる必須ページ番号数 / 必須ページ番号総数) × 100
```

**目標値:** 100%（すべての必須ページ番号が回答に含まれる）

---

## テスト実行手順

### 1. 事前準備

**開発サーバーの起動**:
```bash
npm run dev
```

**アクセスURL**: `http://localhost:9004`

**重要**: サーバーが完全に起動し、"Ready in ..." が表示された後、さらに**10-20秒待機**してからテストを実行してください。初回ビルド後はウォームアップが必要です。

**推奨: ウォームアップリクエストを実行**:

初回テストが遅くなるのを避けるため、パフォーマンステスト前に1-2回の検索リクエストを実行してキャッシュを構築することを推奨します：
```bash
# ブラウザで http://localhost:9004 にアクセスし、簡単な検索を1-2回実行
# または、curl でウォームアップリクエストを送信
curl -X POST http://localhost:9004/api/streaming-process \
  -H "Content-Type: application/json" \
  -d '{"question":"テスト","chatHistory":[],"labelFilters":{"includeMeetingNotes":false}}'
```

### 2. テスト実行

#### 自動テストスクリプト（推奨）

**実行方法**:
```bash
npm run test:answer-quality
```

**または**:
```bash
npx tsx src/tests/answer-quality-test.ts
```

**テストスクリプトの機能**:
- ✅ 開発サーバーの起動確認
- ✅ 2つのクエリを自動実行
- ✅ 検索結果の自動評価（必須ページの検出、順位、スコア）
- ✅ AI回答の自動評価（必須ページ番号の検出、必須コンテンツの検出）
- ✅ パフォーマンス測定（検索時間、AI生成時間、初回チャンク時間）
- ✅ 詳細な結果レポートの表示
- ✅ 合格/不合格の自動判定

**テスト結果の表示**:
- 各テストケースの詳細な評価結果
- 検索結果の一覧（上位10件）
- 必須ページの検出状況
- 回答内のページ番号の検出状況
- 回答内の必須コンテンツの検出状況
- パフォーマンス情報
- 最終的な合格/不合格判定

#### 手動テスト（ブラウザ経由）

**クエリ1のテスト**:

1. ブラウザで検索システムにアクセス（`http://localhost:9004`）
2. クエリ「退会した会員が同じアドレス使ったらどんな表示がでますか」を入力
3. 検索結果を確認
4. AI回答を確認

**クエリ2のテスト**:

1. クエリ「教室削除ができる条件は？」を入力
2. 検索結果を確認
3. AI回答を確認

### 3. 結果評価

#### 検索結果の評価

1. 必須ページが検索結果に含まれているか確認
2. 必須ページの順位を記録
3. スコアを記録

#### 回答の評価

1. 必須要素がすべて含まれているか確認
2. 必須ページ番号が回答に含まれているか確認
3. 回答の正確性を確認
4. 回答の完全性を確認

---

## テスト結果記録テンプレート

### テスト実行日時

```
日時: YYYY-MM-DD HH:MM
環境: ローカル開発環境 / 本番環境
ブランチ: _____________
コミット: _____________
```

### クエリ1: 退会済み会員のメールアドレス再利用

```
クエリ: "退会した会員が同じアドレス使ったらどんな表示がでますか"

検索結果:
□ 045_会員退会機能: [ ] あり [ ] なし - 順位: ___
□ 046_会員新規登録機能: [ ] あり [ ] なし - 順位: ___
□ 009_パスワード再設定機能: [ ] あり [ ] なし - 順位: ___

回答品質:
□ 回答内に「045」が含まれる: [ ] あり [ ] なし
□ 新規会員登録時の挙動が説明されている: [ ] あり [ ] なし
□ パスワード再設定時の挙動が説明されている: [ ] あり [ ] なし
□ エラーメッセージの内容が記載されている: [ ] あり [ ] なし

判定: [ ] ✅ 合格 [ ] ❌ 不合格
```

### クエリ2: 教室削除条件

```
クエリ: "教室削除ができる条件は？"

検索結果:
□ 164_【FIX】教室削除機能: [ ] あり [ ] なし - 順位: ___
□ 177_【FIX】教室削除時...: [ ] あり [ ] なし - 順位: ___
□ 161_【FIX】教室一覧閲覧機能: [ ] あり [ ] なし - 順位: ___

回答品質:
□ 回答内に「164」が含まれる: [ ] あり [ ] なし
□ 回答内に「177」が含まれる: [ ] あり [ ] なし
□ 権限に関する条件が説明されている: [ ] あり [ ] なし
□ 教室および求人の状態に関する条件が説明されている: [ ] あり [ ] なし
□ 応募情報の状態に関する詳細な条件が説明されている: [ ] あり [ ] なし
□ 削除実行時の動作が説明されている: [ ] あり [ ] なし

判定: [ ] ✅ 合格 [ ] ❌ 不合格
```

---

## 品質改善の指針

### 1. 検索精度の改善

- キーワード抽出の精度向上
- タイトルマッチングの重み調整
- コンテンツマッチングの精度向上

### 2. 回答品質の改善

- プロンプトエンジニアリングの最適化
- 必須ページの優先度付け
- 回答生成時のページ参照の強化

### 3. ページ参照の改善

- 回答生成時にページ番号を明示的に含める
- ページタイトルとページ番号の両方を参照
- 参照元ページの明確化

---

## 継続的改善

### 1. 定期的なテスト実行

- 週次での品質テスト実行
- 月次でのメトリクス分析
- 新機能追加時の回帰テスト

### 2. フィードバックの収集

- ユーザーフィードバックの収集
- 回答品質の評価
- 検索結果の品質評価

### 3. アルゴリズムの改善

- テスト結果に基づくパラメータ調整
- 新しい検索手法の導入
- 回答生成ロジックの改善

---

## 🔧 トラブルシューティング

### よくあるエラーと対処法

#### 1. 開発サーバーが起動していない警告

**症状**:
```
❌ 開発サーバーが起動していない可能性があります
   npm run dev を実行して開発サーバーを起動してください
```

**対処法**:
1. 別のターミナルで開発サーバーを起動:
   ```bash
   npm run dev
   ```
2. サーバーが完全に起動するまで待機（数秒〜数十秒）
3. `http://localhost:9004` にアクセスできることを確認
4. テストを再実行

#### 2. HTTP 500エラー - `Cannot find module './447.js'` / `'./548.js'`

**症状**:
```
❌ 詳細エラー: HTTP error! status: 500 - Next.js Error Page: Cannot find module './447.js'
```

**原因**:
Next.jsのビルドキャッシュ（`.next`フォルダ）が壊れている、または古くなっている。

**対処法**:
```bash
# Windows (PowerShell) - 推奨
Remove-Item -Recurse -Force .next
npm run dev

# Windows (コマンドプロンプト)
rmdir /s /q .next
npm run dev

# その後、別のターミナルでテストを実行
npm run test:answer-quality
```

#### 3. HTTP 500エラー - `ENOENT: no such file or directory`

**症状**:
```
❌ 詳細エラー: HTTP error! status: 500 - Next.js Error Page: ENOENT: no such file or directory
```

**原因**:
Next.jsのビルドが不完全で、必要なファイルが生成されていない。

**対処法**:
```bash
# 1. 開発サーバーを停止（Ctrl+C）

# 2. .nextフォルダを完全に削除
Remove-Item -Recurse -Force .next

# 3. 開発サーバーを再起動（ビルドが完了するまで待機）
npm run dev

# 4. ビルド完了を確認（"Ready in ..." が表示されるまで待つ）

# 5. 別のターミナルでテストを実行
npm run test:answer-quality
```

#### 4. テストが遅い / タイムアウトする場合

**症状**:
- テストの実行に非常に時間がかかる
- タイムアウトエラーが発生する

**原因**:
1. **コールドスタート**: 初回ビルドや、初回アクセス時のウォームアップ不足
2. **キャッシュがクリアされた**: 検索キャッシュやLunrインデックスが再構築されている

**対処法**:
```bash
# 1. ウォームアップリクエストを実行（テスト前）
# ブラウザで http://localhost:9004 にアクセスし、1-2回検索を実行

# または、curl でウォームアップリクエストを送信
curl -X POST http://localhost:9004/api/streaming-process \
  -H "Content-Type: application/json" \
  -d '{"question":"テスト","chatHistory":[],"labelFilters":{"includeMeetingNotes":false}}'

# 2. 開発サーバーの完全起動を待つ
# "Ready in ..." 表示後、さらに10-20秒待機

# 3. テストを実行
npm run test:answer-quality
```

#### 5. 必須ページが検出されない場合

**症状**:
- テスト結果で必須ページが「見つかりませんでした」と表示される

**原因**:
1. 検索アルゴリズムの精度が低い
2. ページタイトルが変更されている
3. データが同期されていない

**対処法**:
1. 検索結果を確認し、実際にどのページが検出されているか確認
2. ページタイトルが正しいか確認
3. データ同期を実行（必要に応じて）
4. 検索アルゴリズムのパラメータを調整

#### 6. 回答内に必須ページ番号が含まれない場合

**症状**:
- テスト結果で「回答内のページ番号」が「含まれていません」と表示される

**原因**:
1. AI回答生成時にページ番号が参照されていない
2. プロンプトエンジニアリングの改善が必要

**対処法**:
1. 実際の回答を確認し、ページ番号が含まれているか確認
2. プロンプトエンジニアリングを改善
3. 回答生成ロジックを確認

---

**作成日**: YYYY-MM-DD  
**作成者**: AI Assistant  
**最終更新日**: YYYY-MM-DD
