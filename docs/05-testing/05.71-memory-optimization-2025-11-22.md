# メモリ最適化レポート (2025-11-22)

**作成日**: 2025年11月22日  
**最終更新**: 2025年11月22日  
**対象**: メモリ最適化計画、開発環境メモリ最適化、minInstances影響分析

---

## 📋 目次

1. [メモリ最適化計画](#1-メモリ最適化計画)
2. [開発環境メモリ最適化](#2-開発環境メモリ最適化)
3. [minInstances影響分析](#3-mininstances影響分析)
4. [メモリ監視テスト結果](#4-メモリ監視テスト結果)
5. [現在すべきこと](#5-現在すべきこと)

---

## 1. メモリ最適化計画

### 1.1 現状の問題

**メモリ制限エラー**:
```
Memory limit of 8192 MiB exceeded with 8206 MiB used
```

- **メモリ制限**: 8GB
- **実際の使用量**: 8.2GB（制限超過）
- **影響**: インスタンスクラッシュ・再起動

### 1.2 メモリ使用量の内訳

| 項目 | 使用量 | 備考 |
|------|--------|------|
| LanceDBメモリマップドファイル（1テーブル） | 約12GB | confluenceテーブル |
| LanceDBメモリマップドファイル（2テーブル） | 約24GB | confluence + jira_issues |
| 2インスタンス × 2テーブル | 約48GB | メモリマップドファイルが共有されない場合 |

### 1.3 対策計画

#### 優先度1: **インスタンス数の削減** 🔴 **最優先**

**現状**:
- `minInstances: 2`（2つのインスタンスが常時起動）
- 各インスタンスがメモリマップドファイルを読み込む

**対策**:
- `minInstances: 2` → `minInstances: 1`に削減

**期待効果**:
- **メモリ使用量**: 約50%削減（2インスタンス → 1インスタンス）
- **コスト**: 約50%削減
- **リスク**: Cold Startの可能性（ただし、起動時初期化により影響を最小化）

---

## 2. 開発環境メモリ最適化

### 2.1 開発環境でのメモリ使用状況

**検索実行時のメモリ増加**:
- RSS増加: +283.82MB
- メモリ制限: 開発環境では制限なし
- リスク: メモリリークの可能性

### 2.2 開発環境での対策

**対策1: ガベージコレクションの有効化**
- `--expose-gc` フラグを有効化
- 検索完了後に明示的にGCを実行

**対策2: メモリ監視の有効化**
- メモリ使用量の監視
- メモリリークの検出

---

## 3. minInstances影響分析

### 3.1 minInstances: 1 vs 2

| 項目 | minInstances: 1 | minInstances: 2 |
|------|-----------------|-----------------|
| **メモリ使用量** | 約24GB | 約48GB |
| **コスト** | 低 | 高（2倍） |
| **Cold Start** | 可能性あり | 回避 |
| **可用性** | 中 | 高 |

### 3.2 推奨設定

**本番環境**:
- `minInstances: 1`（メモリ制限を考慮）
- 起動時初期化によりCold Startの影響を最小化

**開発環境**:
- `minInstances: 0`（コスト削減）
- 必要に応じて手動で起動

---

## 4. メモリ監視テスト結果

### 4.1 テスト結果

**検索実行時のメモリ増加**:
- RSS増加: +283.82MB
- ヒープ増加: +150MB（推定）

**メモリ解放の効果**:
- ガベージコレクション実行後: -100MB（推定）
- メモリリーク: 検出されず

### 4.2 メモリ監視の推奨事項

**監視項目**:
1. RSS使用量
2. ヒープ使用量
3. メモリリークの検出

**アラート設定**:
- RSS使用量が2GBを超えた場合
- メモリリークが検出された場合

---

## 5. 現在すべきこと

### 5.1 完了済みの対策 ✅

1. ✅ **minInstances: 2 → 1に削減**
2. ✅ **起動時初期化の実装**
3. ✅ **メモリ監視の有効化**

### 5.2 最優先: メモリ制限の増加 🔴

**現状の問題**:
- メモリ制限: 8GB
- 実際の使用量: 8.2GB（制限超過）

**対策**:
- メモリ制限を8GB → 16GBに増加
- または、インスタンス数を1に削減

**期待効果**:
- メモリ制限エラーの解消
- インスタンスクラッシュの回避

### 5.3 優先度2: 検索完了後のメモリ解放 🟡

**現状**:
- 検索完了後もメモリが解放されない
- メモリリークの可能性

**対策案**:
- 検索完了後に明示的にメモリを解放
- ガベージコレクションを実行

**期待効果**:
- メモリ使用量の削減
- メモリリークの防止

### 5.4 優先度3: メモリ監視とアラート 🟡

**対策案**:
- メモリ使用量の監視
- アラートの設定

**期待効果**:
- メモリ問題の早期検出
- メモリ制限エラーの予防

---

## 📊 まとめ

### 改善された項目

1. ✅ **minInstances: 2 → 1に削減**（メモリ使用量50%削減）
2. ✅ **起動時初期化の実装**（Cold Startの影響を最小化）
3. ✅ **メモリ監視の有効化**（メモリ問題の早期検出）

### 残課題

1. ⚠️ **メモリ制限エラー**: 8.2GB使用（制限: 8GB）
2. ⚠️ **検索完了後のメモリ解放**: 改善の余地あり
3. ⚠️ **メモリ監視とアラート**: 改善の余地あり

### 推奨される次のステップ

1. 🔴 **最優先**: メモリ制限の増加（8GB → 16GB）
2. 🟡 **優先度2**: 検索完了後のメモリ解放
3. 🟡 **優先度3**: メモリ監視とアラートの設定

---

**注意**: このドキュメントは、2025年11月22日のメモリ最適化レポートを統合したものです。詳細な分析結果は、アーカイブフォルダ（`docs/99-archive/testing/memory-optimization-2025-11-22/`）を参照してください。


