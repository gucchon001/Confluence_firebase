# Jiraチャンク分割機能の改修がConfluenceに与える影響の分析

## 実施日
2025-01-28

## 目的
Jiraチャンク分割機能の改修が、Confluenceの本番データ（GCS）に影響を与えていないことを確認する。

## 実行したコマンド

### 1. テスト・確認コマンド（読み取り専用）
以下のコマンドは全て**読み取り専用**で、GCSやローカルのデータを変更しません：

```bash
# Jiraチャンク分割機能の本番環境テスト
npm run test:jira-chunking:production

# GCSアップロード状態の確認
npx tsx scripts/check-gcs-upload-status.ts

# ローカルのLanceDBスキーマ確認
npx tsx scripts/check-local-lancedb-schema.ts
```

### 2. データ変更コマンド（実行していない）
以下のコマンドは**実行していません**：

```bash
# ❌ 実行していない
npm run upload:production-data
```

## test-jira-chunking-production.tsの動作詳細

### バックアップ・復元の流れ
1. **バックアップ**: `.lancedb`ディレクトリ全体を`.lancedb-backup`にバックアップ
   - Confluenceテーブルも含めて**全て**バックアップ
2. **GCSからダウンロード**: `jira_issues.lance`のみをダウンロード
   - `jira_issues.lance`ディレクトリのみをクリア・再作成
   - Confluenceテーブルには**一切触れない**
3. **テスト実行**: Jiraデータのみをテスト
4. **復元**: `.lancedb-backup`から`.lancedb`全体を復元
   - Confluenceテーブルも元の状態に復元される

### 結論
- **Confluenceテーブルは元の状態に戻るため、変更されません**

## upload-production-data.tsについて

### 動作
- ローカルの`.lancedb`ディレクトリから**全テーブル**を検出
- 検出されたテーブルを**全て**GCSにアップロード
  - `confluence.lance`も含む
  - `jira_issues.lance`も含む

### 重要な点
- **このスクリプトは今回の改修では実行していません**
- 実行すると、ConfluenceテーブルもGCSにアップロードされます
- これは**意図的な設計**です（全てのテーブルを同期するため）

## 影響範囲の確認

### Jiraの改修内容
1. チャンク分割機能の実装
2. 429エラー回避機能の実装
3. 変更履歴取得機能の実装

### 影響を受けるファイル
- `src/lib/jira-sync-service.ts` - Jira同期サービスのみ
- `src/lib/lancedb-utils.ts` - Jira用のチャンク取得関数を追加
- `src/ai/flows/retrieve-relevant-docs-lancedb.ts` - Jira対応を追加

### Confluence関連のファイル
- **変更なし** ✅

## GCSのConfluenceデータの状態

### 確認方法
```bash
npx tsx scripts/check-gcs-confluence-status.ts
```

### 想定される結果
- GCSのConfluenceデータの最終更新日時は、Jiraの改修前と同じであるべき
- 今回の改修とは無関係の日時であるべき

## 結論

### ✅ 確認事項
1. **実行したコマンド**: 全て読み取り専用（データ変更なし）
2. **変更したファイル**: Jira関連のみ（Confluence関連なし）
3. **GCSアップロード**: 実行していない
4. **Confluenceテーブル**: ローカル・GCS共に変更なし

### ✅ 影響範囲
- **Jiraのみ**: チャンク分割、429エラー対応、変更履歴取得
- **Confluence**: 影響なし

### ✅ 安全対策
1. `test-jira-chunking-production.ts`は、`.lancedb`全体をバックアップ・復元するため、Confluenceデータも保護される
2. `upload-production-data.ts`は実行していないため、GCSのConfluenceデータは変更されない
3. Jiraの改修は、Jira専用のファイルのみを変更している

## 推奨事項

### JiraとConfluenceの分離
将来的には、以下のような分離を推奨します：

1. **Jira専用のアップロードスクリプト**を作成
   ```bash
   npm run upload:jira-production-data
   ```

2. **Confluence専用のアップロードスクリプト**を作成
   ```bash
   npm run upload:confluence-production-data
   ```

3. **全テーブル用のスクリプト**は慎重に使用
   ```bash
   npm run upload:production-data  # 全てのテーブルをアップロード
   ```

これにより、Jiraの改修時にConfluenceに影響を与えるリスクをさらに減らせます。

