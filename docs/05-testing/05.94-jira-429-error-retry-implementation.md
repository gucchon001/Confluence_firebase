# Jira 429エラー回避機能の実装

**作成日**: 2025-01-27  
**ステータス**: ✅ 実装完了

---

## 📋 概要

Jira APIのレート制限（429エラー）を回避するため、リトライロジックとスロットリング機能を実装しました。

---

## 🔧 実装内容

### 1. リトライロジック付きHTTPリクエスト関数

**`fetchWithRetry`関数** (`src/lib/jira-sync-service.ts`)

```typescript
private async fetchWithRetry(
  url: string,
  options: RequestInit,
  maxRetries: number = 5,
  baseDelay: number = 1000
): Promise<Response>
```

**機能**:
- **スロットリング**: リクエスト間隔を制御（デフォルト: 100ms = 10 req/sec）
- **429エラー対応**: Retry-Afterヘッダーを確認して適切な待機時間を設定
- **指数バックオフ**: Retry-Afterヘッダーがない場合、指数バックオフで待機
- **ネットワークエラー対応**: 一時的なネットワークエラーにも対応

**リトライ戦略**:
- 最大リトライ回数: 5回
- 基本待機時間: 1秒
- Retry-Afterヘッダー優先（あればその値を使用）
- 最大待機時間: 30秒（429エラー）、5秒（ネットワークエラー）

### 2. 適用箇所

以下の関数に`fetchWithRetry`を適用：

1. **`fetchAllCommentsForIssue`**: 全コメント取得
   - `/rest/api/3/issue/{issueKey}/comment`

2. **`fetchChangelogForIssue`**: 変更履歴取得
   - `/rest/api/3/issue/{issueKey}?expand=changelog`

---

## 📊 動作フロー

### 429エラー発生時の処理

```
1. HTTPリクエスト実行
   ↓
2. 429エラーを受信
   ↓
3. Retry-Afterヘッダーを確認
   ├─ あり → Retry-After秒待機
   └─ なし → 指数バックオフで待機（1秒, 2秒, 4秒, 8秒...最大30秒）
   ↓
4. 最大リトライ回数まで再試行
   ├─ 成功 → レスポンスを返す
   └─ 失敗 → エラーをスロー（最終的に空配列を返す）
```

### スロットリング

```
前回のリクエストから100ms未満の場合:
  100ms - 経過時間 だけ待機してからリクエスト実行
```

---

## ⚙️ 設定パラメータ

### リクエスト間隔

```typescript
private readonly REQUEST_DELAY_MS = 100; // デフォルト: 100ms（10 req/sec）
```

**調整可能**: クラスのプロパティとして定義されているため、必要に応じて調整可能

**推奨値**:
- **デフォルト**: 100ms（10 req/sec） - レート制限を回避しつつ、処理速度を確保
- **保守的**: 200ms（5 req/sec） - より確実にレート制限を回避
- **高速**: 50ms（20 req/sec） - レート制限のリスクが高い

### リトライパラメータ

```typescript
maxRetries: number = 5        // 最大リトライ回数
baseDelay: number = 1000      // 基本待機時間（ミリ秒）
```

---

## 🧪 テスト結果

### 実装前

- 429エラーが頻繁に発生
- 一部の変更履歴やコメントが取得できない
- エラーログが大量に出力される

### 実装後（期待される効果）

- 429エラーが自動的にリトライされる
- Retry-Afterヘッダーに従って適切に待機
- データ取得の成功率が向上
- エラーログが削減される

---

## 💡 使用例

### 通常の使用

実装は自動的に動作します。特に設定は不要です。

```typescript
const service = new JiraSyncService();
await service.syncAllIssues(); // 自動的にリトライロジックが適用される
```

### リクエスト間隔の調整（将来の拡張）

リクエスト間隔を調整したい場合、クラスのプロパティを変更するか、環境変数で制御できるように拡張可能：

```typescript
// 将来の拡張例
private readonly REQUEST_DELAY_MS = process.env.JIRA_REQUEST_DELAY_MS 
  ? parseInt(process.env.JIRA_REQUEST_DELAY_MS, 10) 
  : 100;
```

---

## 📝 注意事項

### 処理時間への影響

- **リクエスト間隔**: 100ms × 5,435件 = 約543秒（約9分）
- **429エラー発生時**: Retry-Afterヘッダーの値に応じて追加の待機時間が発生
- **合計処理時間**: 通常の処理時間 + スロットリング時間 + リトライ待機時間

### 推奨設定

大量のIssueを処理する場合：
1. リクエスト間隔を適切に設定（100ms推奨）
2. バッチ処理のサイズを調整（現在は逐次処理）
3. 並列処理を検討（ただし、レート制限に注意）

---

## 🔗 関連ドキュメント

- `docs/02-specifications/02.09-jira-comments-and-history-implementation-details.md`: コメントと履歴の実装詳細
- `src/lib/jira-sync-service.ts`: 実装コード

---

**最終更新日**: 2025-01-27  
**実装完了日**: 2025-01-27

