# JiraとConfluenceのデータ管理の分離推奨

## 問題点の認識

現在、`upload-production-data.ts`は**全テーブル**をGCSにアップロードする設計になっています：

```typescript:scripts/upload-production-data.ts
// 各テーブルをアップロード
for (const tableName of tableNames) {
  const localTablePath = path.join(LOCAL_LANCEDB_PATH, `${tableName}.lance`);
  const count = await uploadTable(bucket, tableName, localTablePath);
  totalUploaded += count;
}
```

これは、Jiraの改修時に誤ってConfluenceもアップロードしてしまう可能性があります。

## 今回の改修での影響

### ✅ 確認済み：影響なし
1. **実行したコマンド**: 全て読み取り専用
   - `npm run test:jira-chunking:production` - ローカルテストのみ
   - `npx tsx scripts/check-gcs-upload-status.ts` - 状態確認のみ
   - `npx tsx scripts/check-local-lancedb-schema.ts` - スキーマ確認のみ

2. **GCSアップロード**: **実行していない** ✅
   - `npm run upload:production-data` は実行していない
   - したがって、Confluenceの本番データ（GCS）は**変更されていません**

3. **変更したファイル**: Jira関連のみ
   - `src/lib/jira-sync-service.ts`
   - `src/lib/lancedb-utils.ts`
   - `src/ai/flows/retrieve-relevant-docs-lancedb.ts`

## 推奨される改善

### オプション1: テーブル指定オプションを追加（推奨）

`upload-production-data.ts`にテーブル指定オプションを追加：

```typescript
// 環境変数で指定
const TABLE_FILTER = process.env.UPLOAD_TABLE_FILTER; // 例: "jira_issues" または "confluence"

if (TABLE_FILTER) {
  tableNames = tableNames.filter(name => name === TABLE_FILTER);
}
```

使用方法：
```bash
# Jiraのみアップロード
UPLOAD_TABLE_FILTER=jira_issues npm run upload:production-data

# Confluenceのみアップロード
UPLOAD_TABLE_FILTER=confluence npm run upload:production-data

# 全テーブルアップロード（明示的）
npm run upload:production-data  # フィルターなし
```

### オプション2: 専用スクリプトを作成

Jira専用とConfluence専用のスクリプトを分離：

```bash
# Jira専用
npm run upload:jira-production-data

# Confluence専用
npm run upload:confluence-production-data

# 全テーブル（既存）
npm run upload:production-data
```

## 今回の改修での安全性

### ✅ 安全性の確認

1. **GCSアップロード未実行**
   - `upload-production-data.ts`は実行していない
   - Confluenceの本番データは変更されていない

2. **ローカルテストの安全性**
   - `test-jira-chunking-production.ts`はバックアップ・復元を使用
   - Confluenceテーブルも元の状態に復元される

3. **コード変更の範囲**
   - Jira関連のファイルのみ変更
   - Confluence関連のファイルは変更なし

## 結論

### 今回の改修
- **Confluenceの本番データ（GCS）は変更されていません** ✅
- 全て読み取り専用のコマンドのみ実行
- GCSアップロードは実行していない

### 今後の推奨
- JiraとConfluenceのデータアップロードを分離する
- テーブル指定オプションを追加して、誤アップロードを防ぐ

