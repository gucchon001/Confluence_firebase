# Jira Issue Key完全一致検索の問題 - 原因分析まとめ

**作成日**: 2025-01-27  
**ステータス**: 🔍 原因調査完了

---

## 📋 問題の概要

Issue Key（例: `CTJ-5439`）で検索した場合、Issue Keyは見つかるが、完全一致検索のマーカー（`_issueKeyExact: true`）が付いていない問題が発生しています。

---

## 🔍 調査結果

### 1. Issue Key検出ロジック

**実装状況**:
- ✅ Issue Keyパターン検出: 実装済み（`/CTJ-\d+/i`）
- ✅ Issue Key完全一致検索: 実装済み（LanceDBで`id = 'CTJ-XXXX'`で検索）
- ✅ RRFスコア設定: 実装済み（`_rrfScore: 1.0`）

**動作確認**:
- ✅ スタンドアロンでのIssue Key検出: 正常動作（`scripts/debug-jira-issue-key-detection-flow.ts`）
- ❌ 検索処理内でのIssue Key検出: 未確認（デバッグログが出力されていない）

### 2. テスト結果

**検索結果**:
- ✅ Issue Keyは見つかっている（`Issue Key一致の結果: 1件`）
- ❌ 完全一致検索のマーカーが付いていない（`Issue Key完全一致検索の結果: 0件`）

**デバッグログ**:
- ❌ `[Title Rescue Search] tableName: ...` が出力されない
- ❌ `[Title Rescue Search] Jira: Starting Issue Key detection for query: ...` が出力されない
- ❌ `[Title Rescue Search] Jira: Detected Issue Keys in query: ...` が出力されない

### 3. 問題の原因

**仮説1: タイトル救済検索のセクションが実行されていない**

タイトル救済検索のセクション（`src/lib/lancedb-search-client.ts` 448行目以降）が実行されていない可能性があります。

**確認ポイント**:
- `tableName`の値が正しく設定されているか
- `isJiraTable`が`true`になっているか
- タイトル救済検索のセクションが実行される条件を満たしているか

**仮説2: Issue Keyがタイトル候補に追加されていない**

Issue Key検出ロジックは実行されているが、タイトル候補に追加されていない可能性があります。

**確認ポイント**:
- `detectedIssueKeys`が正しく設定されているか
- `titles`配列にIssue Keyが含まれているか
- タイトル候補の制限処理（最大5個）でIssue Keyが除外されていないか

**仮説3: Issue Key検索が実行されていない**

Issue Keyがタイトル候補に含まれているが、検索が実行されていない可能性があります。

**確認ポイント**:
- `titleSearchPromises`にIssue Key検索が含まれているか
- Issue Key検索の結果が正しく取得されているか
- 検索結果に`_issueKeyExact: true`マーカーが付いているか

---

## 🔧 実装済みの修正

1. ✅ Issue Key検出ロジックの追加
2. ✅ Issue Key完全一致検索の実装
3. ✅ RRFスコア設定（`_rrfScore: 1.0`）
4. ✅ 優先順位設定（ソート時にIssue Key完全一致を最優先）
5. ✅ デバッグログの追加（`DEBUG_TITLE_SEARCH`）

---

## 📝 次のステップ

1. ⏳ タイトル救済検索のセクションが実行されているかを確認
2. ⏳ `tableName`と`isJiraTable`の値を確認
3. ⏳ Issue Keyがタイトル候補に追加されているかを確認
4. ⏳ Issue Key検索が実行されているかを確認

---

## 🔗 関連ファイル

- `src/lib/lancedb-search-client.ts`: タイトル救済検索の実装（448-760行目）
- `scripts/test-jira-issue-key-search.ts`: Issue Key検索テストスクリプト
- `scripts/debug-jira-issue-key-detection-in-search.ts`: Issue Key検出デバッグスクリプト
- `docs/05-testing/05.81-jira-issue-key-detection-cause-analysis.md`: 原因分析ドキュメント

