# 過去のテスト実行方法の分析 (2025-11-22)

**作成日**: 2025年11月22日  
**ステータス**: 🔍 分析完了

---

## 📊 問題の概要

ユーザーからの質問: 「これまで、ここに問題がなかったのですが、昔のテストのときはどうしてたんですか」

過去のテストではコールドスタートの問題が発生していなかったのに、今回発生した理由を分析します。

---

## 🔍 過去のテスト実行方法

### 1. **通常モード（デフォルト）で実行** ✅ **主な理由**

**実装場所**: `docs/05-testing/05.04-performance-tests.md:38-41`

**過去の実行方法**:
```bash
# 通常モード（デフォルト）: キャッシュが有効な状態
npm run test:api-performance
```

**特徴**:
- **キャッシュが有効**: Lunrインデックス、トークナイザー、埋め込み生成が既にメモリにロードされている
- **ウォームスタート**: 初回リクエストではないため、初期化処理が不要
- **高速**: 検索時間が3-5秒程度で完了

**結果例**（過去のテスト結果）:
- 検索時間: 215.00ms ✅
- AI生成時間: 206.60ms ✅
- 初回チャンク時間: 215.20ms ✅
- 総処理時間: 425.60ms ✅

**結論**: **キャッシュが有効な状態で実行されていたため、コールドスタートが発生していなかった**

---

### 2. **手動でウォームアップリクエストを実行** ✅ **補助的な理由**

**実装場所**: `docs/05-testing/05.04-performance-tests.md:59-68`

**過去の実行手順**:
1. **開発サーバーを起動**:
   ```bash
   npm run dev
   ```

2. **サーバー起動後に10-20秒待機**:
   - "Ready in ..." が表示された後、さらに待機
   - 初回ビルド後はウォームアップが必要

3. **手動でウォームアップリクエストを実行**:
   ```bash
   # ブラウザで http://localhost:9004 にアクセスし、簡単な検索を1-2回実行
   # または、curl でウォームアップリクエストを送信
   curl -X POST http://localhost:9004/api/streaming-process \
     -H "Content-Type: application/json" \
     -d '{"question":"テスト","chatHistory":[],"labelFilters":{"includeMeetingNotes":false}}'
   ```

4. **その後、パフォーマンステストを実行**:
   ```bash
   npm run test:api-performance
   ```

**効果**:
- Lunrインデックスがメモリにロードされる
- トークナイザーが初期化される
- 埋め込み生成が初期化される
- **結果**: コールドスタートが発生しない

**結論**: **手動でウォームアップリクエストを実行していたため、コールドスタートが発生していなかった**

---

### 3. **`.next`フォルダを削除していなかった** ✅ **補助的な理由**

**過去のテスト実行時**:
- `.next`フォルダを削除せずにテストを実行
- ビルドキャッシュが残っている
- Next.jsの最適化が有効

**現在のテスト実行時**（今回の問題）:
- `.next`フォルダを削除してからテストを実行する場合がある
- ビルドキャッシュが失われる
- 初回ビルドに時間がかかる

**結論**: **`.next`フォルダを削除していなかったため、ビルドキャッシュが有効で、コールドスタートが発生していなかった**

---

## 🆚 過去 vs 現在の比較

### 過去のテスト実行方法（コールドスタートなし）

| 項目 | 過去の実行方法 | 効果 |
|------|--------------|------|
| **実行モード** | 通常モード（デフォルト、キャッシュ有効） | ✅ キャッシュが有効 |
| **ウォームアップ** | 手動で実行（ブラウザまたはcurl） | ✅ 事前に初期化済み |
| **キャッシュクリア** | クリアしない | ✅ キャッシュが有効 |
| **`.next`フォルダ** | 削除しない | ✅ ビルドキャッシュが有効 |
| **結果** | **コールドスタートが発生しない** | ✅ 検索時間: 215ms |

---

### 現在のテスト実行方法（コールドスタート発生）

| 項目 | 現在の実行方法 | 効果 |
|------|--------------|------|
| **実行モード** | `--no-cache`モード（キャッシュ無効） | ❌ キャッシュが無効 |
| **ウォームアップ** | 自動実行なし（手動で実行する必要がある） | ❌ 事前に初期化されていない |
| **キャッシュクリア** | 各クエリの前にクリア | ❌ 常にコールドスタート |
| **`.next`フォルダ** | 削除する場合がある | ❌ ビルドキャッシュが無効 |
| **結果** | **コールドスタートが発生する** | ❌ 検索時間: 72.7秒 |

---

## 🔍 なぜ過去に問題がなかったのか？

### 理由1: **キャッシュが有効な状態で実行していた** 🔴 **主な理由**

**過去のテスト**:
- `npm run test:api-performance`（`--no-cache`フラグなし）
- キャッシュが有効な状態で実行
- Lunrインデックス、トークナイザー、埋め込み生成が既にメモリにロードされている

**結果**:
- 検索時間: 215.00ms ✅
- コールドスタートが発生しない

---

### 理由2: **手動でウォームアップリクエストを実行していた** 🟡 **補助的な理由**

**過去のテスト**:
- テスト前にブラウザやcurlでウォームアップリクエストを実行
- Lunrインデックス、トークナイザー、埋め込み生成を事前に初期化

**結果**:
- 初回リクエストでもコールドスタートが発生しない
- 検索時間: 215.00ms ✅

---

### 理由3: **`.next`フォルダを削除していなかった** 🟡 **補助的な理由**

**過去のテスト**:
- `.next`フォルダを削除せずにテストを実行
- Next.jsのビルドキャッシュが有効

**結果**:
- ビルドが高速
- サーバー起動が高速

---

## 🎯 現在の問題が発生した理由

### 1. `--no-cache`フラグを使用した 🔴 **主な原因**

**現在のテスト**:
```bash
npm run test:api-performance -- --no-cache
```

**問題**:
- キャッシュがクリアされる
- Lunrインデックス、トークナイザー、埋め込み生成がメモリから削除される
- **結果**: コールドスタートが発生

---

### 2. ウォームアップリクエストを自動実行していなかった 🔴 **主な原因**

**現在のテスト**:
- キャッシュクリア後にウォームアップリクエストを自動実行していなかった
- 手動で実行する必要があったが、実行されていなかった

**問題**:
- Lunrインデックスが再読み込みされていない
- トークナイザーが初期化されていない
- 埋め込み生成が初期化されていない
- **結果**: コールドスタートが発生

---

### 3. 各クエリの前にキャッシュをクリアしている 🔴 **主な原因**

**現在のテスト**:
```typescript
// キャッシュ無効モードの場合、各クエリ前にキャッシュをクリア
if (NO_CACHE && i > 0) {
  await clearCache(); // 2回目以降のクエリの前にクリア
}
```

**問題**:
- 各クエリの前にキャッシュがクリアされる
- 常にコールドスタート状態
- **結果**: 検索時間が72.7秒になる

---

## ✅ 修正内容（2025-11-22）

### 修正前の問題

**問題**:
- `--no-cache`フラグを使用
- ウォームアップリクエストを自動実行していない
- 各クエリの前にキャッシュをクリア

**結果**:
- 検索時間: 72.7秒（コールドスタート）

---

### 修正後の改善

**修正内容**:
1. **ウォームアップリクエストの自動実行**: キャッシュクリア後に自動的にウォームアップリクエストを実行
2. **初期化の完了を待機**: ウォームアップリクエスト完了後、3秒待機して初期化の完了を確実にする
3. **各クエリ前のウォームアップ**: `--no-cache`モードで各クエリの前にキャッシュをクリアする場合、ウォームアップリクエストを実行

**期待結果**:
- 検索時間: 3-5秒（ウォームスタート）
- コールドスタートの影響を排除

---

## 📝 まとめ

### なぜ過去に問題がなかったのか？

1. **キャッシュが有効な状態で実行していた** 🔴 **主な理由**
   - `--no-cache`フラグを使用していなかった
   - Lunrインデックス、トークナイザー、埋め込み生成が既にメモリにロードされている

2. **手動でウォームアップリクエストを実行していた** 🟡 **補助的な理由**
   - テスト前にブラウザやcurlでウォームアップリクエストを実行
   - 事前に初期化済み

3. **`.next`フォルダを削除していなかった** 🟡 **補助的な理由**
   - Next.jsのビルドキャッシュが有効
   - サーバー起動が高速

---

### なぜ今回問題が発生したのか？

1. **`--no-cache`フラグを使用した** 🔴 **主な原因**
   - キャッシュがクリアされる
   - 常にコールドスタート状態

2. **ウォームアップリクエストを自動実行していなかった** 🔴 **主な原因**
   - 手動で実行する必要があったが、実行されていなかった
   - 初期化されていない

3. **各クエリの前にキャッシュをクリアしている** 🔴 **主な原因**
   - 常にコールドスタート状態

---

### ✅ 修正内容

**実装**: `src/tests/test-api-performance.ts`

**修正内容**:
1. **ウォームアップリクエストの自動実行**: キャッシュクリア後に自動的にウォームアップリクエストを実行
2. **初期化の完了を待機**: ウォームアップリクエスト完了後、3秒待機
3. **各クエリ前のウォームアップ**: `--no-cache`モードで各クエリの前にキャッシュをクリアする場合、ウォームアップリクエストを実行

**期待効果**:
- 検索時間: 72.7秒 → **3-5秒**（コールドスタートの影響を排除）
- 過去のテスト実行方法に近い結果が得られる

---

## 🔗 関連ドキュメント

- [コールドスタート発生原因の分析](./05.36-cold-start-analysis-2025-11-22.md)
- [パフォーマンステスト](./05.04-performance-tests.md)
- [パフォーマンス劣化分析](./05.12-performance-degradation-analysis.md)

