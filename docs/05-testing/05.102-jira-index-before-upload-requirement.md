# Jiraアップロード前のインデックス作成の必要性

## 実施日
2025-01-28

## 問題の認識

ユーザーの質問：
> JiraのLanceDBインデックス等のことです。上がった本番データは正しいパフォーマンスと品質で使われるようになっていますか

## 重要なポイント

### 1. LanceDBインデックスの仕様

- **インデックスはテーブル内に埋め込まれる**
  - インデックスは別ファイルではなく、テーブルファイルの一部として保存される
  - テーブルをアップロードすると、インデックスも一緒にアップロードされる

- **インデックス作成のタイミング**
  - `createIndex()`メソッドで明示的に作成する必要がある
  - データ追加だけでは自動的にインデックスは作成されない

### 2. 現在の処理フロー

#### ✅ 完全再構築スクリプト（推奨）
`scripts/sync-jira-full-rebuild.ts`の処理順序：
1. Jiraデータ同期（Firestore + LanceDB）
2. Lunrインデックスの初期化
3. **LanceDBインデックスの作成** ← 重要！
4. GCSへのアップロード（インデックス含む）

#### ⚠️ 通常のアップロード（注意が必要）
`scripts/upload-jira-production-data.ts`の処理：
- LanceDBテーブルをGCSにアップロード
- **インデックス作成は含まれない**

## 問題の可能性

### インデックス未作成のままアップロードされる可能性

以下のような場合に問題が発生する可能性があります：

1. **データ同期直後にアップロード**
   ```bash
   npm run sync:jira
   npm run upload:jira-production-data  # インデックス未作成！
   ```

2. **インデックス作成を忘れた場合**
   - データ同期後に手動でアップロード
   - インデックス作成をスキップ

### 影響

- **検索パフォーマンスの低下**
  - ベクトル検索が遅くなる（インデックス未使用）
  - スカラー検索（`issue_key`など）が遅くなる

- **本番環境での品質問題**
  - ユーザーが検索を実行した際にタイムアウト
  - レスポンス時間の増加

## 解決策

### 推奨される処理順序

#### オプション1: 完全再構築スクリプトを使用（推奨）

```bash
# インデックス作成→アップロードまで自動的に実行
npm run sync:jira:rebuild
```

**メリット**:
- 正しい順序が保証される
- インデックス作成が含まれる
- 全ての処理が一括で実行される

#### オプション2: 手動で順序を守る

```bash
# Step 1: Jiraデータ同期
npm run sync:jira

# Step 2: インデックス作成（アップロード前に必須）
npm run lancedb:create-indexes

# Step 3: GCSへのアップロード（インデックス含む）
npm run upload:jira-production-data
```

### インデックス状態の確認

新しく作成したスクリプトで確認：

```bash
# ローカルデータのインデックス状態を確認
npx tsx scripts/check-jira-index-status.ts
```

## 結論

### ⚠️ 重要な注意事項

1. **アップロード前にインデックス作成が必要**
   - `upload-jira-production-data`だけでは不十分
   - インデックス作成→アップロードの順序が重要

2. **完全再構築スクリプトの使用を推奨**
   - 正しい順序が保証される
   - インデックス作成が自動的に含まれる

3. **現在の本番データの確認が必要**
   - 既にアップロード済みのデータにインデックスが含まれているか確認
   - インデックスが無い場合は、再アップロードが必要

### ✅ 推奨されるアクション

1. **ローカルデータのインデックス状態を確認**
   ```bash
   npx tsx scripts/check-jira-index-status.ts
   ```

2. **インデックスが無い場合、作成してからアップロード**
   ```bash
   npm run lancedb:create-indexes
   npm run upload:jira-production-data
   ```

3. **または、完全再構築スクリプトを使用**
   ```bash
   npm run sync:jira:rebuild
   ```

