# Jira Issue Key検出問題の原因分析

**作成日**: 2025-01-27  
**ステータス**: 🔍 原因調査中

---

## 📋 問題の概要

Issue Key（例: `CTJ-5439`）で検索した場合、Issue Key完全一致検索が実行されず、他の検索結果が返される問題が発生しています。

---

## 🔍 調査結果

### 1. Issue Keyパターン検出の確認

**テスト結果**:
- ✅ Issue Keyパターン（`/CTJ-\d+/i`）は正しく動作している
- ✅ クエリ `CTJ-5439` からIssue Keyが正しく検出される

**確認方法**:
- `scripts/debug-jira-issue-key-detection-flow.ts` で確認
- ステップ1でIssue Key検出が成功

### 2. searchLanceDB関数内での実行状況

**デバッグログの状況**:
- ❌ `[Title Rescue Search] tableName: ...` のログが出力されない
- ❌ `[Title Rescue Search] Jira: Detected Issue Keys in query: ...` のログが出力されない
- ❌ `[Title Rescue Search] Jira: Searching by Issue Key: ...` のログが出力されない

**コードの流れ**:
1. `tableName`は226行目で定義: `const tableName = params.tableName || 'confluence';`
2. `isJiraTable`は450行目で定義: `const isJiraTable = tableName === 'jira_issues';`
3. Issue Key検出は456-467行目で実行される（`isJiraTable`が`true`の場合）

**問題の可能性**:
1. `tableName`が`'jira_issues'`と一致していない（別の値になっている）
2. `isJiraTable`が`false`になっている
3. Issue Key検出のコードが実行されていない

---

## 🧪 追加調査が必要な項目

### 調査項目1: tableNameの値確認

**確認方法**:
- デバッグログを追加して`tableName`の値を確認
- `isJiraTable`の値を確認

**実装済み**:
- ✅ デバッグログを追加（`src/lib/lancedb-search-client.ts` 453-455行目）

### 調査項目2: Issue Key検出ロジックの実行確認

**確認方法**:
- Issue Key検出の各ステップでデバッグログを追加
- パターンマッチの結果を確認

**実装済み**:
- ✅ デバッグログを追加（`src/lib/lancedb-search-client.ts` 456-467行目）

### 調査項目3: タイトル候補生成の確認

**確認方法**:
- キーワード抽出の結果を確認
- タイトル候補生成の結果を確認
- Issue Keyがタイトル候補に含まれているかを確認

**未実装**:
- ⚠️ タイトル候補生成のデバッグログを追加する必要がある

---

## 🔧 次のステップ

1. ✅ デバッグログを追加（`tableName`、`isJiraTable`の値を確認）
2. ⏳ デバッグログの出力を確認
3. ⏳ 問題の原因を特定
4. ⏳ 修正を実装

---

## 📝 関連ファイル

- `src/lib/lancedb-search-client.ts`: タイトル救済検索の実装
- `scripts/debug-jira-issue-key-detection-in-search.ts`: Issue Key検出デバッグスクリプト
- `scripts/debug-jira-issue-key-detection-flow.ts`: Issue Key検出フローデバッグスクリプト

