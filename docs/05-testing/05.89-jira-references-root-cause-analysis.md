# Jira検索 - 参照元が1件しか返ってこない根本原因分析

**作成日**: 2025-01-27  
**ステータス**: 🔍 原因調査中

---

## 📋 問題の概要

ユーザーからの報告: 「参照元が1件しか返ってこない」

---

## 🔍 ステップバイステップでの確認結果

### ステップ1: 検索結果の取得
- ✅ **正常**: 30件の検索結果が取得できています

### ステップ2: allReferencesの準備
- ✅ **正常**: 30件のallReferencesが準備できています

### ステップ3: extractUsedReferenceIndicesの実行
- ⚠️ **問題**: 0件を返しています（模擬的なAI回答では参照元を抽出できていない）

### ステップ4: finalReferencesの決定
- ✅ **正常**: `extractUsedReferenceIndices`が0件の場合、`allReferences`（30件）を使用

### ステップ5: enhanceReferencesの実行
- ✅ **正常**: 30件のimmediateReferencesが返されています

### ステップ6: finalReferencesへの拡張結果の適用
- ✅ **正常**: 30件のenhancedFinalRefsが取得できています

### ステップ7: finalReferencesの最終的な決定
- ✅ **正常**: 30件のfinalReferencesが決定されています

---

## 💡 根本原因の仮説

### 仮説1: `extractUsedReferenceIndices`が1件だけを返している

**可能性**: 実際のAI回答では、`extractUsedReferenceIndices`が1件だけを返している可能性があります。

**確認方法**: 実際のAI回答を確認し、`extractUsedReferenceIndices`が何件を返しているかを確認する必要があります。

### 仮説2: クライアント側でのフィルタリング

**可能性**: `chat-page.tsx`の486行目で`references`をフィルタリングしていますが、これは`finalReferences`（使用された参照元のみ）です。

**確認方法**: 実際のAPIレスポンスで`result.references`が何件含まれているかを確認する必要があります。

### 仮説3: `enhanceReferences`のフィルタリング

**可能性**: `enhanceReferences`の処理で、`finalReferenceIds`と`enhanced.immediateReferences`のIDが一致しない可能性があります。

**確認方法**: `finalReferenceIds`と`enhanced.immediateReferences`のIDを比較する必要があります。

---

## 🎯 次のステップ

1. **実際のAPIエンドポイントを使ったテスト**: 実際のAI回答がどのような形式で返ってくるかを確認
2. **`extractUsedReferenceIndices`の改善**: Issue Key検出と部分一致の改善
3. **ログの追加**: 各ステップで参照元の数をログに記録

---

## 🔗 関連ファイル

- `src/ai/flows/streaming-summarize-confluence-docs.ts`: 参照元抽出の実装
- `src/lib/markdown-utils.tsx`: `extractUsedReferenceIndices`関数
- `src/app/api/streaming-process/route.ts`: APIエンドポイント
- `src/components/chat-page.tsx`: クライアント側の表示処理

