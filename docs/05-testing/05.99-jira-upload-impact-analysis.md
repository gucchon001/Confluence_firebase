# Jiraアップロードが他の処理に与える影響の分析

## 実施日
2025-01-28

## 確認項目

### 1. インデックス作成への影響

#### ❌ 問題点
`upload-production-data.ts`は**インデックス作成を行いません**。
- インデックス作成は別スクリプト `create-lancedb-indexes.ts` で実行
- `upload-production-data.ts`実行後、手動でインデックス作成が必要

#### ✅ 対策
Jiraアップロード後に、Jiraテーブルのインデックス作成が必要です：

```bash
# 1. Jiraテーブルをアップロード
npm run upload:jira-production-data

# 2. インデックスを作成（全テーブル対象）
npm run lancedb:create-indexes
```

**注意**: `create-lancedb-indexes.ts`は**全テーブル**のインデックスを作成します。
- Confluenceテーブルも対象になります
- しかし、既存のインデックスはスキップされるため、安全です

### 2. Confluence同期への影響

#### ✅ 影響なし
`upload-production-data.ts`は**Confluenceの同期を行いません**。
- Confluence同期は別プロセス（`ConfluenceSyncService`）で実行
- `upload-production-data.ts`は既存のローカルデータをGCSにアップロードするのみ

### 3. ラベル処理への影響

#### ✅ 影響なし
`upload-production-data.ts`は**ラベル処理を行いません**。
- ラベル処理は別プロセス（`generate-jira-structured-labels.ts`）で実行
- `upload-production-data.ts`は既存のローカルデータをGCSにアップロードするのみ

### 4. Lunrキャッシュのアップロード

#### ⚠️ 問題点
`uploadLunrCache`は**全Lunrキャッシュファイル**をアップロードします：
- `lunr-index-confluence.msgpack` (Confluence用)
- `lunr-index-jira_issues.msgpack` (Jira用)

Jiraのみをアップロードする場合でも、Confluence用のLunrキャッシュもアップロードされてしまいます。

#### 🔧 対策が必要
テーブルフィルターに応じて、Lunrキャッシュもフィルターする必要があります。

## 推奨される改善

### 改善1: Lunrキャッシュのフィルター対応

`uploadLunrCache`関数を修正して、テーブルフィルターに対応させる：

```typescript
async function uploadLunrCache(bucket: any, tableFilter?: string): Promise<number> {
  // ...
  
  // テーブルフィルターが指定されている場合、該当するキャッシュのみアップロード
  let filteredFiles = cacheFiles;
  if (tableFilter) {
    filteredFiles = cacheFiles.filter(file => {
      if (tableFilter === 'jira_issues') {
        return file.includes('jira_issues');
      } else if (tableFilter === 'confluence') {
        return file.includes('confluence') || (!file.includes('jira_issues'));
      }
      return true;
    });
  }
  
  // ...
}
```

### 改善2: インデックス作成のテーブルフィルター対応

`create-lancedb-indexes.ts`にテーブルフィルターオプションを追加：

```typescript
const tableFilter = process.env.CREATE_INDEX_TABLE_FILTER;
if (tableFilter) {
  tableNames = tableNames.filter(name => name === tableFilter);
}
```

## 現在の安全対策

### ✅ 安全な点

1. **テーブルフィルター実装済み**
   - `UPLOAD_TABLE_FILTER`でJiraのみをアップロード可能

2. **既存データの保護**
   - インデックス作成は既存インデックスをスキップ
   - GCSの既存ファイルは上書きされるが、バージョン管理されている

3. **分離された処理**
   - Confluence同期、ラベル処理は別プロセス
   - `upload-production-data.ts`実行のみでは影響しない

### ⚠️ 注意が必要な点

1. **Lunrキャッシュのアップロード**
   - 現在は全キャッシュファイルをアップロード
   - Confluence用のLunrキャッシュもアップロードされる可能性

2. **インデックス作成**
   - 手動で実行する必要がある
   - 全テーブル対象（Confluenceも含む）

## 推奨される実行手順

### Jiraのみをアップロードする場合

```bash
# Step 1: Jiraテーブルをアップロード（Confluenceテーブルは影響なし）
npm run upload:jira-production-data

# Step 2: インデックスを作成（全テーブル対象、既存インデックスはスキップ）
npm run lancedb:create-indexes

# Step 3: Lunrキャッシュは自動的にアップロードされる（全キャッシュ）
# → Confluence用のLunrキャッシュもアップロードされる
# → ただし、既存のキャッシュを上書きするだけなので、問題ない可能性が高い
```

## 結論

### ✅ 安全な点
1. Confluenceテーブルはアップロードされない（テーブルフィルターにより）
2. Confluence同期は影響を受けない（別プロセス）
3. ラベル処理は影響を受けない（別プロセス）

### ⚠️ 注意が必要な点
1. Lunrキャッシュは全ファイルがアップロードされる（Confluence用も含む）
2. インデックス作成は手動実行が必要（全テーブル対象）

### 🔧 改善提案
1. Lunrキャッシュのフィルター対応
2. インデックス作成のテーブルフィルター対応

