# APIã‚­ãƒ¼æ¼æ´©é˜²æ­¢ã‚¬ã‚¤ãƒ‰

## ğŸš¨ é‡è¦ãªæ³¨æ„äº‹é …

**APIã‚­ãƒ¼ï¼ˆç‰¹ã«Gemini APIã‚­ãƒ¼ï¼‰ã¯çµ¶å¯¾ã«Gitãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚**

## æ¼æ´©ã®å¯èƒ½æ€§ãŒã‚ã‚‹ç®‡æ‰€

### 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
- âœ… **ä¿®æ­£æ¸ˆã¿**: `docs/04-operations/04.15-jira-production-deployment-guide.md`
  - Gemini APIã‚­ãƒ¼ã‚’ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«ç½®ãæ›ãˆ

### 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- âœ… **ä¿®æ­£æ¸ˆã¿**: `apphosting.yaml`ã¨`setup/apphosting.yaml`
  - `NEXT_PUBLIC_FIREBASE_API_KEY`ã‚’ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«ç½®ãæ›ãˆ
  - å®Ÿéš›ã®å€¤ã¯Firebase Consoleã¾ãŸã¯Secret Managerã§ç®¡ç†

### 3. ãƒ­ã‚°å‡ºåŠ›
- âœ… **å•é¡Œãªã—**: `src/tests/test-helpers/env-loader.ts`
  - APIã‚­ãƒ¼ã®æœ€åˆã®10æ–‡å­—ã®ã¿ã‚’å‡ºåŠ›ï¼ˆå®Œå…¨ãªã‚­ãƒ¼ã¯å‡ºåŠ›ã•ã‚Œãªã„ï¼‰

## å¯¾å¿œæ‰‹é †

### 1. æ–°ã—ã„Gemini APIã‚­ãƒ¼ã®ç”Ÿæˆ

1. [Google AI Studio](https://makersuite.google.com/app/apikey)ã«ã‚¢ã‚¯ã‚»ã‚¹
2. æ–°ã—ã„APIã‚­ãƒ¼ã‚’ç”Ÿæˆ
3. **é‡è¦**: ç”Ÿæˆã—ãŸAPIã‚­ãƒ¼ã‚’å®‰å…¨ã«ä¿ç®¡ã—ã¦ãã ã•ã„ï¼ˆGitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
4. å¤ã„APIã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–

### 2. ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°

#### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
```bash
# .env.local
GEMINI_API_KEY=your-new-gemini-api-key
```

#### GitHub Secrets
```bash
gh secret set GEMINI_API_KEY --body "your-new-gemini-api-key"
```

#### Firebase Secret Manager
```bash
echo -n "your-new-gemini-api-key" | gcloud secrets create gemini_api_key --data-file=-
# ã¾ãŸã¯æ—¢å­˜ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ›´æ–°
echo -n "your-new-gemini-api-key" | gcloud secrets versions add gemini_api_key --data-file=-
```

### 3. Gitå±¥æ­´ã®ç¢ºèª

æ—¢ã«ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯ã€Gitå±¥æ­´ã‚’ç¢ºèªï¼š

```bash
# APIã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
git log --all --full-history --source -- "**/*.md" "**/*.yaml" | grep -i "AIzaSy"

# ç‰¹å®šã®APIã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’æ¤œç´¢
git log --all -S "AIzaSyDgbOANBYpo-H5V9-HLwJR36fhNonSz4h4" --source --all
```

### 4. Gitå±¥æ­´ã‹ã‚‰ã®å‰Šé™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

**æ³¨æ„**: ã“ã®æ“ä½œã¯æ…é‡ã«è¡Œã£ã¦ãã ã•ã„ã€‚Gitå±¥æ­´ã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¨èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚

```bash
# BFG Repo-Cleanerã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
# https://rtyley.github.io/bfg-repo-cleaner/

# ã¾ãŸã¯ git filter-branch ã‚’ä½¿ç”¨
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch docs/04-operations/04.15-jira-production-deployment-guide.md" \
  --prune-empty --tag-name-filter cat -- --all
```

## apphosting.yamlã®è¨­å®šæ–¹æ³•

### å®Ÿéš›ã®APIã‚­ãƒ¼ã®è¨­å®š

`apphosting.yaml`ã«ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã¯ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§å®Ÿéš›ã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

#### æ–¹æ³•1: Firebase Consoleã‹ã‚‰è¨­å®šï¼ˆæ¨å¥¨ï¼‰

1. [Firebase Console](https://console.firebase.google.com/)ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. App Hosting â†’ Settings â†’ Environment variables
4. `NEXT_PUBLIC_FIREBASE_API_KEY`ã‚’è¿½åŠ ãƒ»ç·¨é›†

#### æ–¹æ³•2: ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export NEXT_PUBLIC_FIREBASE_API_KEY="your-actual-api-key"
firebase deploy --only hosting
```

#### æ–¹æ³•3: ãƒ­ãƒ¼ã‚«ãƒ«ã§apphosting.yamlã‚’ç·¨é›†ï¼ˆéæ¨å¥¨ï¼‰

**æ³¨æ„**: ã“ã®æ–¹æ³•ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```yaml
# apphosting.yamlï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã€Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
- variable: NEXT_PUBLIC_FIREBASE_API_KEY
  value: your-actual-api-key  # å®Ÿéš›ã®å€¤ï¼ˆGitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
```

## ä»Šå¾Œã®å¯¾ç­–

### 1. ãƒ—ãƒ¬ã‚³ãƒŸãƒƒãƒˆãƒ•ãƒƒã‚¯ã®è¨­å®š

`.git/hooks/pre-commit`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```bash
#!/bin/bash
# APIã‚­ãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
if git diff --cached --name-only | xargs grep -E "AIzaSy[A-Za-z0-9_-]{35}" 2>/dev/null; then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã‚³ãƒŸãƒƒãƒˆã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
  exit 1
fi
```

### 2. GitHub Actionsã§ã®æ¤œè¨¼

`.github/workflows/security-check.yml`ã‚’ä½œæˆï¼š

```yaml
name: Security Check

on: [push, pull_request]

jobs:
  check-api-keys:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Check for API keys
        run: |
          if grep -r "AIzaSy[A-Za-z0-9_-]{35}" --include="*.md" --include="*.yaml" --include="*.ts" --include="*.js" .; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi
```

### 3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½¿ç”¨

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯å¸¸ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨ï¼š

```markdown
# âŒ æ‚ªã„ä¾‹
GEMINI_API_KEY=AIzaSyDgbOANBYpo-H5V9-HLwJR36fhNonSz4h4

# âœ… è‰¯ã„ä¾‹
GEMINI_API_KEY=your-gemini-api-key
```

## å‚è€ƒãƒªãƒ³ã‚¯

- [Google AI Studio - API Keys](https://makersuite.google.com/app/apikey)
- [GitHub Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [Firebase Secret Manager](https://firebase.google.com/docs/app-hosting/manage-secrets)

