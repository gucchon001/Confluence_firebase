# Jira検索 - 参照元抽出ロジックのテスト結果

**作成日**: 2025-01-27  
**ステータス**: ⚠️ 問題確認

---

## 📋 テスト概要

元々の問題「参照元が1件しか返ってこない」を確認するため、参照元抽出ロジックをテストしました。

---

## 📊 テスト結果

### テストケース

| クエリ | 検索結果 | 抽出された参照元 | 評価 |
|--------|----------|------------------|------|
| indeed 対応の進捗はどうなっていますか | 30件 ✅ | 0件 ⚠️ | 検索結果は正常だが、参照元抽出が失敗 |
| 応募者移管の進捗はどうなっていますか | 30件 ✅ | 0件 ⚠️ | 検索結果は正常だが、参照元抽出が失敗 |
| リリース予定日の確認 | 30件 ✅ | 0件 ⚠️ | 検索結果は正常だが、参照元抽出が失敗 |

### 問題の詳細

1. **検索結果は正常**: すべてのクエリで30件の検索結果が取得できています
2. **参照元抽出が失敗**: `extractUsedReferenceIndices`関数が参照元を抽出できていません（0件）

---

## 🔍 原因分析

### `extractUsedReferenceIndices`関数の動作

`extractUsedReferenceIndices`関数は、AIの回答内で以下の形式で言及されている参照元を抽出します：

1. **括弧内のタイトル**: 「（XXX_【FIX】...）」のようなパターン
2. **マークダウンリンク**: `[1](url)`のような形式

### 問題点

1. **AI回答の形式依存**: `extractUsedReferenceIndices`関数は、AIの回答が特定の形式（括弧内にタイトルを含む）で参照元を言及していることを前提としています
2. **タイトル一致の厳格性**: タイトルの完全一致または部分一致を要求しており、柔軟性が低い可能性があります
3. **Issue Keyの検出不足**: JiraのIssue Key（例: `CTJ-4483`）が回答内に含まれていても、タイトルとして認識されない可能性があります

---

## 💡 解決策の提案

### 1. フォールバック機能の強化

現在のコードでは、`usedIndices.size > 0`の場合のみ抽出された参照元を使用し、それ以外は`allReferences`を使用しています。しかし、実際のAI回答では、参照元が正しく抽出されない場合があります。

**提案**: 抽出された参照元が1件以下の場合、上位N件（例: 3-5件）を強制的に残すフォールバックを追加

```typescript
// 使用された参照元のみをフィルタリング
let finalReferences = usedIndices.size > 0
  ? Array.from(usedIndices).map(index => allReferences[index]).filter(Boolean)
  : allReferences;

// ★★★ 追加: 抽出された参照元が1件以下の場合、上位N件を強制的に残す ★★★
if (finalReferences.length <= 1 && allReferences.length > 1) {
  finalReferences = allReferences.slice(0, Math.min(5, allReferences.length));
  console.log(`[reference-extraction] Fallback: Using top ${finalReferences.length} references (extracted: ${usedIndices.size})`);
}
```

### 2. `extractUsedReferenceIndices`関数の改善

**提案**: Issue Keyの検出と部分一致の改善

- Issue Keyパターン（`CTJ-XXXX`）を検出して参照元を抽出
- タイトルの部分一致をより柔軟にする
- キーワードベースのマッチングを強化

### 3. LLMプロンプトの改善

**提案**: AI回答に複数の参照元を明示的に言及するようプロンプトを改善

- 参照元のタイトルを括弧内に明示的に記載するよう指示
- 複数の参照元を言及するよう強調

---

## 🎯 次のステップ

1. **フォールバック機能の実装**: 抽出された参照元が1件以下の場合、上位N件を強制的に残す
2. **`extractUsedReferenceIndices`関数の改善**: Issue Key検出と部分一致の改善
3. **実際のAI回答の確認**: 実際のAI回答がどのような形式で参照元を言及しているかを確認

---

## 🔗 関連ファイル

- `src/lib/markdown-utils.tsx`: `extractUsedReferenceIndices`関数の実装
- `src/ai/flows/streaming-summarize-confluence-docs.ts`: 参照元抽出の使用箇所
- `scripts/test-jira-references-extraction.ts`: テストスクリプト

