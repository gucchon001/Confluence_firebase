# ハイブリッド抽出方式の問題点分析

## 概要

現在の「ハイブリッド方式」は、**ランクによる先頭取得**と**キーワード周辺のコンテンツ取得**を組み合わせているとされていますが、実際には`maxLength`がランキングに基づいて動的に設定されているため、真のハイブリッドとして機能していない可能性があります。

## 現在の実装

### ステップ2: ランクに基づく先頭取得

```typescript
// ステップ2: ランクに基づいて先頭からmaxLength分の文字数を取得（ランクによる重要性を保持）
const headStartPos = 0;
const headEndPos = Math.min(content.length, maxLength);
const headSpan = headEndPos - headStartPos;
```

**問題点**:
- `maxLength`自体がランキングに基づいて動的に設定されている（1位: 1500文字、2位: 1000文字など）
- つまり、「ランクに基づいて先頭からmaxLength分の文字数を取得」というのは、実質的に「ランキングに基づく文字数制限内で先頭から取得」しているだけ
- これは「ランクによる先頭取得」という独立したステップではなく、単に「ランキングに基づく文字数制限」を適用しているだけ

### ユーザーの指摘

> maxLengthはランキングによる最初の文字数を動的に取得する文字数である場合、必ずその取得文字数でmaxになるので、ハイブリッドとして機能しなくないですか

**分析**:
- `maxLength`がランキングに基づいて動的に設定されている
- つまり、「ランクによる先頭取得」の結果が必ず`maxLength`文字になる
- これは「ランクによる先頭取得」と「キーワード周辺のコンテンツ取得」のハイブリッドではなく、実質的には「ランキングに基づく文字数制限内でキーワード周辺のコンテンツを優先的に取得」しているだけ

## 問題の詳細

### 1. ハイブリッドとして機能していない

**現在の実装**:
1. `maxLength`をランキングに基づいて設定（1位: 1500文字、2位: 1000文字など）
2. 先頭から`maxLength`分の文字数を取得（`headEndPos = Math.min(content.length, maxLength)`）
3. キーワード周辺のコンテンツを取得（`keywordSpan`）
4. 両者を組み合わせる（ハイブリッド）

**問題**:
- ステップ2で「先頭から`maxLength`分の文字数を取得」しているが、これは単に「ランキングに基づく文字数制限内で先頭から取得」しているだけ
- つまり、「ランクによる先頭取得」という独立したステップではなく、単に`maxLength`という制約を適用しているだけ
- 実際の抽出ロジックでは、キーワード周辺のコンテンツを優先的に取得し、`maxLength`を超えないように調整している

### 2. 実質的な動作

**実際の動作**:
1. `maxLength`をランキングに基づいて設定
2. キーワード周辺のコンテンツを取得（`keywordSpan`）
3. `keywordSpan`が`maxLength`以内の場合: キーワード周辺のコンテンツを優先的に取得
4. `keywordSpan`が`maxLength`を超える場合: キーワード周辺のコンテンツを含む範囲を`maxLength`内に収めるように調整

**結論**:
- 実質的には「ランキングに基づく文字数制限内でキーワード周辺のコンテンツを優先的に取得」しているだけ
- 「ランクによる先頭取得」と「キーワード周辺のコンテンツ取得」のハイブリッドではなく、単に「キーワード周辺のコンテンツを優先的に取得し、ランキングに基づく文字数制限を適用」しているだけ

## 真のハイブリッド方式とは

### 理想的なハイブリッド方式

1. **ランクによる先頭取得**（固定文字数）:
   - ランキングに関係なく、先頭から固定の文字数（例: 500文字）を取得
   - これは「ランキングに基づく文字数制限」とは独立している

2. **キーワード周辺のコンテンツ取得**（固定文字数）:
   - キーワード周辺から固定の文字数（例: 300文字）を取得
   - これは「ランキングに基づく文字数制限」とは独立している

3. **ハイブリッド**:
   - 両者を組み合わせて、合計が`maxLength`を超えないように調整
   - ランキングに基づいて、先頭取得とキーワード周辺取得の比率を調整

### 現在の実装との違い

**現在の実装**:
- `maxLength`がランキングに基づいて動的に設定される
- 先頭取得は`maxLength`を超えないように制限される
- キーワード周辺のコンテンツ取得も`maxLength`を超えないように制限される
- 実質的には「ランキングに基づく文字数制限内でキーワード周辺のコンテンツを優先的に取得」しているだけ

**理想的なハイブリッド方式**:
- 先頭取得とキーワード周辺取得は独立した固定文字数
- ランキングに基づいて、両者の比率を調整（例: 1位は先頭:キーワード=7:3、10位は先頭:キーワード=3:7）
- 合計が`maxLength`を超えないように調整

## 推奨事項

### 1. 実装の見直し

現在の実装は「ハイブリッド方式」というよりも、「ランキングに基づく文字数制限内でキーワード周辺のコンテンツを優先的に取得」する方式です。

### 2. 命名の見直し

- 「ハイブリッド方式」という命名は誤解を招く可能性がある
- より正確な命名: 「ランキングベースのキーワード優先抽出方式」

### 3. ドキュメントの更新

- 現在の実装の実際の動作を正確に文書化
- 「ハイブリッド方式」という名称を使う場合は、実際の動作との関係を明確にする

## 参考資料

- `src/ai/flows/content-extraction-utils.ts`: 実装
- `docs/implementation/content-extraction-specification.md`: 仕様
- `docs/implementation/keyword-surrounding-extraction-specification.md`: キーワード周辺抽出の仕様

