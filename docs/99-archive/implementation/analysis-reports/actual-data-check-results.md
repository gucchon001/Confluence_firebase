# 実際のデータ確認結果

## 概要

LanceDBに保存されている実際のデータを確認し、特に表を含むドキュメント（学年自動更新バッチ）のデータ構造を調査しました。

## 確認したデータ

### 対象ドキュメント

- **ページID**: 743473812
- **タイトル**: 721_【作成中】学年自動更新バッチ
- **総チャンク数**: 1
- **総文字数**: 1600文字

## 発見事項

### 1. 表の構造が失われている ✅ 確認済み

#### 表の構造確認

- **HTMLタグ（<table>, <tr>, <td>）**: ❌ なし（テキスト化済み）
- **セル区切り（ | ）**: ❌ なし（構造が失われている）
- **改行（\n）**: ❌ なし

#### 表の内容例

```
表2 学年の更新内容 更新前 更新後 入学見込み 学部1年生 学部1年生 学部2年生 学部2年生 学部3年生 学部3年生 学部4年生 学部4年生 学部5年生 学部5年生 学部6年生 学部6年生 卒業 修士1年生 修士2年生 修士2年生 卒業 博士1年生 博士2年生 博士2年生 博士3年生 博士3年生 卒業
```

**問題**:
- セル間の区切りが空白になっている
- 行の区切りが失われている
- 表の構造が単なる文字列として扱われている
- 「更新前」「更新後」が表のヘッダーであることが分からない

### 2. 表の内容は存在する ✅

#### キーワードの位置

| キーワード | 位置 | 状態 |
|-----------|------|------|
| 「表1」 | 502文字目 | ✅ あり |
| 「表2」 | 555文字目 | ✅ あり |
| 「更新前」 | 944文字目 | ✅ あり |
| 「更新後」 | 948文字目 | ✅ あり |
| 「学部1年生」 | 958文字目 | ✅ あり |
| 「学部2年生」 | 846文字目（複数箇所） | ✅ あり |
| 「現在の職業の更新」 | 1092文字目 | ✅ あり |

#### 表1の周辺（502文字目から200文字）

```
表1の条件 を満たしている。 入学からの経過年数 = 当年 - 「入学年・月：年」 抽出した会員において、表2の 学年更新処理 を行う。 「大学：学年」を下記表の通り更新する。 「学年更新日」に実行日を入れる。 「学年更新ステータス」に 2 を入れる。 表1 「入学からの経過年数」ごとの対象判定条件 入学からの経過 年数 対象となる条件 7 以上 対象外 6 「大学：学年」が「学部6年生」 5 「大...
```

#### 表2の周辺（555文字目から200文字）

```
表2の 学年更新処理 を行う。 「大学：学年」を下記表の通り更新する。 「学年更新日」に実行日を入れる 。 「学年更新ステータス」に 2 を入れる。 表1 「入学からの経過年数」ごとの対象判定条件 入学からの経過年数 対象となる条件 7 以上 対象外 6 「大学：学年」が「学部6年生」 5 「大学：学年」が「学部6年生 」ではない 4 「大学：学年」が「学部5年生」「学部6年生」ではない 3 「大学：...
```

#### 「現在の職業の更新」の周辺（1092文字目から200文字）

```
現在の職業の更新 下記の条件を全て満たす会員は、「現在職業」を「大学生」にする。 「現在の職業」が「高校生（卒業見込み）」 「大学：学年」に「中退」「卒業」以外の値が設定されている 「入学年・月：年」「入学年・月：月」を組み合わせた入学年月が当月以前 2.4. メールテンプレート なし 2.5. ワークフロー なし 3. 要件定義 3.1. 入力 3.2. 出力 3.3. 処理 バッチ処理を開始し...
```

### 3. コンテンツ抽出ロジックへの影響

#### 現在の抽出ロジック（600文字制限、6位の場合）

**先頭から600文字を取得**:
- 「表1」（502文字目）: ✅ 含まれる
- 「表2」（555文字目）: ✅ 含まれる
- 「更新前」「更新後」（944-948文字目）: ❌ 範囲外
- 「学部1年生」（958文字目）: ❌ 範囲外
- 「現在の職業の更新」（1092文字目）: ❌ 範囲外

**問題**:
1. 表の構造が失われているため、表の中身が先頭から600文字の範囲外にある
2. キーワードマッチングで「更新前」「更新後」を検出できない可能性
3. 範囲外のキーワードを含める際の調整ロジックが正しく動作していない可能性

#### ハイブリッド抽出ロジックの動作

**ステップ1: ランクによる先頭取得**
- 先頭から600文字を取得
- 「表1」「表2」は含まれる ✅

**ステップ2: キーワード範囲の確認**
- 「更新前」「更新後」は範囲外
- 「現在の職業の更新」は範囲外

**ステップ3: 範囲外キーワードの補完**
- 範囲外のキーワードを含めるために範囲を拡張
- ただし、先頭の重要マーカー（「表1」「表2」）を保持することを優先

**問題**:
- 範囲外キーワードを含める際の調整ロジックが複雑すぎる
- 先頭の重要マーカーを保持しつつ、範囲外キーワードを含めるのが難しい

## 改善案

### 案1: 表の構造を考慮したHTML処理（推奨）

HTMLからテキストを抽出する際に、表の構造を考慮する。

**メリット**:
- 表の構造が保持される
- セル間の区切りが明確になる
- 行の区切りが明確になる

**期待される結果**:
```
表1 「入学からの経過年数」ごとの対象判定条件
入学からの経過年数 | 対象となる条件
7以上 | 対象外
6 | 「大学：学年」が「学部6年生」
5 | 「大学：学年」が「学部6年生」ではない
...

表2 学年の更新内容
更新前 | 更新後
入学見込み | 学部1年生
学部1年生 | 学部2年生
学部2年生 | 学部3年生
...
```

### 案2: コンテンツ抽出ロジックの改善

範囲外キーワードを含める際の調整ロジックを簡素化する。

**改善点**:
1. 先頭範囲内の重要マーカーを優先的に保持
2. 範囲外キーワードを含める際も、先頭範囲内の重要マーカーを確実に保持
3. 範囲外キーワードを含む最小範囲を計算し、それを先頭範囲に追加

## 次のステップ

1. ✅ **問題の確認**: 表の構造が失われていることを確認
2. ✅ **実際のデータ確認**: 表の内容が正しく保存されていることを確認
3. ⏳ **改善案の実装**: 表の構造を考慮したHTML処理を実装
4. ⏳ **コンテンツ抽出ロジックの改善**: 範囲外キーワードを含める際の調整ロジックを改善
5. ⏳ **テスト**: 表を含むドキュメントでテスト
6. ⏳ **検証**: コンテンツ抽出ロジックが正しく動作するか確認

