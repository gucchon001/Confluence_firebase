# ConfluenceとJiraの同期処理の完全な状態調査

## 実施日
2025-01-28

## 調査目的

ConfluenceとJiraの両方について、インデックス、キャッシュ、ラベル等の同期が確実に行われるような処理が現在どうなっているかを確認する。

---

## 1. Confluenceの同期処理

### 1.1 自動同期（GitHub Actions）

**ワークフロー**: `.github/workflows/sync-confluence.yml`

#### 実行頻度
- **自動実行**: 毎日午前2時（JST = UTC 17:00前日）
- **手動実行**: GitHub Actions UIから実行可能（差分同期または完全同期を選択）

#### 処理フロー（順序保証あり）

```bash
1. Confluenceデータ同期（差分または完全）
   ↓
2. LanceDBインデックス作成
   ↓
3. Lunrインデックス再構築
   ↓
4. GCSへのアップロード
```

#### 各ステップの詳細

| ステップ | スクリプト/コマンド | 自動実行 | 失敗時の挙動 |
|---------|-------------------|---------|------------|
| 1. データ同期 | `npm run sync:confluence:differential` または `npm run sync:confluence:batch` | ✅ | ❌ エラーで停止 |
| 2. LanceDBインデックス作成 | `npm run lancedb:create-indexes` | ✅ | ⚠️ 継続（continue-on-error: true） |
| 3. Lunrインデックス再構築 | `npm run rebuild:lunr` | ✅ | ⚠️ 継続（continue-on-error: true） |
| 4. GCSアップロード | `npm run upload:production-data` | ✅ | ❌ エラーで停止 |

#### ✅ 確実に実行される処理

1. **データ同期**: ✅ 確実に実行される
2. **LanceDBインデックス作成**: ✅ 確実に実行される（失敗しても継続）
3. **Lunrインデックス再構築**: ✅ 確実に実行される（失敗しても継続）
4. **GCSアップロード**: ✅ 確実に実行される（同期成功時のみ）

#### ⚠️ 注意点

- **LanceDBインデックス作成とLunrインデックス再構築は失敗しても継続**される（`continue-on-error: true`）
- これらのステップが失敗した場合、ログで確認する必要がある
- GCSアップロードは、同期が成功した場合のみ実行される

### 1.2 StructuredLabelの同期

#### 自動統合

**ConfluenceSyncService**が自動的に以下を実行：

1. Confluenceからページを取得
2. **FirestoreからStructuredLabelを取得**（ページ単位で1回のみ）
3. StructuredLabelをフラット化
4. LanceDBに統合して保存

#### 実行タイミング

- **データ同期時**: 自動的に統合される
- **新しいページ追加時**: 自動的に統合される（FirestoreにStructuredLabelが存在する場合）

#### ⚠️ StructuredLabel生成

- StructuredLabelの**生成**は別プロセス（`generate-structured-labels.ts`）
- 生成後、Firestoreに保存される
- 次回のデータ同期時に自動的にLanceDBに統合される

---

## 2. Jiraの同期処理

### 2.1 自動同期（GitHub Actions）

**ワークフロー**: `.github/workflows/sync-jira.yml`

#### 実行頻度
- **自動実行**: 30分おき（UTC時間）
- **手動実行**: GitHub Actions UIから実行可能（最大取得件数を指定可能）

#### 処理フロー（順序保証あり）

```bash
1. Jiraデータ同期（Firestore + LanceDB）
   ↓
2. Jira Lunrインデックス初期化
   ↓
3. LanceDBインデックス作成
   ↓
4. GCSへのアップロード
```

#### 各ステップの詳細

| ステップ | スクリプト/コマンド | 自動実行 | 失敗時の挙動 |
|---------|-------------------|---------|------------|
| 1. データ同期 | `npm run sync:jira` | ✅ | ❌ エラーで停止 |
| 2. Lunrインデックス初期化 | `npm run init:jira-lunr` | ✅ | ⚠️ 継続（continue-on-error: true） |
| 3. LanceDBインデックス作成 | `npm run lancedb:create-indexes` | ✅ | ⚠️ 継続（continue-on-error: true） |
| 4. GCSアップロード | `npm run upload:production-data` | ✅ | ❌ エラーで停止 |

#### ✅ 確実に実行される処理

1. **データ同期**: ✅ 確実に実行される
2. **Lunrインデックス初期化**: ✅ 確実に実行される（失敗しても継続）
3. **LanceDBインデックス作成**: ✅ 確実に実行される（失敗しても継続）
4. **GCSアップロード**: ✅ 確実に実行される（同期成功時のみ）

#### ⚠️ 注意点

- **Lunrインデックス初期化とLanceDBインデックス作成は失敗しても継続**される（`continue-on-error: true`）
- これらのステップが失敗した場合、ログで確認する必要がある
- GCSアップロードは、同期が成功した場合のみ実行される

### 2.2 完全再構築スクリプト（推奨）

**スクリプト**: `scripts/sync-jira-full-rebuild.ts`

#### 処理フロー（順序保証あり）

```bash
1. Jiraデータ同期（Firestore + LanceDB）
   ↓
2. Lunrインデックスの初期化
   ↓
3. LanceDBインデックスの作成
   ↓
4. GCSへのアップロード（オプション）
```

#### 特徴

- **正しい順序が保証される**
- **全ての処理が一括で実行される**
- エラー時は処理が停止する（部分的な完了を防ぐ）

#### 使用方法

```bash
# 完全再構築（全ての処理を実行）
npm run sync:jira:rebuild

# GCSアップロードをスキップ
SKIP_GCS_UPLOAD=true npm run sync:jira:rebuild

# 最大取得件数を指定
JIRA_MAX_ISSUES=500 npm run sync:jira:rebuild
```

### 2.3 StructuredLabelの同期

#### 現在の状態

- **Jira StructuredLabel生成**: `generate-jira-structured-labels.ts`（別プロセス）
- **手動統合**: `sync-firestore-jira-labels-to-lancedb.ts`（別スクリプト）
- **Firestore保存**: 生成後、Firestoreに保存される

#### ⚠️ 課題

- Jira StructuredLabelのLanceDBへの統合は、**手動スクリプト**で実行する必要がある
- Confluenceとは異なり、**自動統合は実装されていない**
- GitHub Actionsワークフローには含まれていない

#### 手動統合手順

```bash
# Step 1: StructuredLabelを生成（Firestoreに保存）
npx tsx scripts/generate-jira-structured-labels.ts

# Step 2: FirestoreからLanceDBに統合
npx tsx scripts/sync-firestore-jira-labels-to-lancedb.ts

# Step 3: インデックス作成
npm run lancedb:create-indexes

# Step 4: GCSアップロード
npm run upload:jira-production-data
```

---

## 3. 比較表

### 3.1 同期処理の比較

| 項目 | Confluence | Jira |
|-----|-----------|------|
| **自動同期頻度** | 毎日2時（JST） | 30分おき |
| **データ同期** | ✅ 自動実行 | ✅ 自動実行 |
| **LanceDBインデックス作成** | ✅ 自動実行 | ✅ 自動実行 |
| **Lunrインデックス再構築** | ✅ 自動実行 | ✅ 自動実行 |
| **GCSアップロード** | ✅ 自動実行 | ✅ 自動実行 |
| **完全再構築スクリプト** | ❌ なし | ✅ あり（推奨） |
| **StructuredLabel自動統合** | ✅ あり | ❌ なし（手動スクリプト） |

### 3.2 インデックス作成の比較

| 項目 | Confluence | Jira |
|-----|-----------|------|
| **ベクトルインデックス** | ✅ 自動作成 | ✅ 自動作成 |
| **スカラーインデックス** | ✅ `page_id` | ✅ `issue_key` |
| **作成タイミング** | 同期後 | 同期後 |
| **失敗時の挙動** | 継続 | 継続 |

### 3.3 キャッシュの比較

| 項目 | Confluence | Jira |
|-----|-----------|------|
| **Lunrキャッシュ** | ✅ 自動再構築 | ✅ 自動初期化 |
| **保存場所** | `.cache/lunr-index-*.msgpack` | `.cache/lunr-index-jira_issues.msgpack` |
| **GCSアップロード** | ✅ 自動アップロード | ✅ 自動アップロード |
| **フィルター対応** | ✅ あり | ✅ あり（テーブルフィルター） |

---

## 4. 確実に同期されるための要件

### 4.1 Confluence

#### ✅ 現在の状態: 良好

- GitHub Actionsワークフローで自動実行
- 全ての処理が順序通りに実行される
- StructuredLabelは自動的に統合される

#### 推奨事項

1. **通常運用**: 何もする必要はない（自動実行される）
2. **StructuredLabel更新**: `generate-structured-labels.ts`を実行後、次回の自動同期で統合される

### 4.2 Jira

#### ✅ 現在の状態: 良好（ただし、完全再構築スクリプトの使用を推奨）

- GitHub Actionsワークフローで自動実行
- 全ての処理が順序通りに実行される
- ただし、完全再構築スクリプトの方が確実

#### 推奨事項

1. **通常運用**: GitHub Actionsの自動実行に任せる
2. **完全再構築時**: `npm run sync:jira:rebuild`を使用（推奨）
3. **StructuredLabel更新**: 
   - `generate-jira-structured-labels.ts`を実行
   - `sync-firestore-jira-labels-to-lancedb.ts`を実行（手動）
   - インデックス作成とGCSアップロードを実行

---

## 5. 問題点と改善提案

### 5.1 現在の問題点

1. **インデックス作成とLunrインデックス再構築が失敗しても継続される**
   - 問題が発生しても気づきにくい
   - ログの確認が必要

2. **Jira StructuredLabelの自動統合がない**
   - Confluenceとは異なり、手動スクリプトで実行する必要がある
   - GitHub Actionsワークフローに含まれていない

3. **完全再構築スクリプトがConfluenceにない**
   - Jiraにはあるが、Confluenceにはない

### 5.2 改善提案

1. **エラー通知の強化**
   - インデックス作成やLunrインデックス再構築が失敗した場合、通知を送信

2. **Jira StructuredLabel自動統合の実装**
   - Confluenceと同様に自動統合を実装
   - GitHub Actionsワークフローに統合スクリプトを追加

3. **Confluence完全再構築スクリプトの作成**
   - Jiraと同様に、Confluence用の完全再構築スクリプトを作成

---

## 6. 結論

### ✅ 確実に同期される処理

#### Confluence
- ✅ データ同期
- ✅ LanceDBインデックス作成
- ✅ Lunrインデックス再構築
- ✅ GCSアップロード
- ✅ StructuredLabel自動統合

#### Jira
- ✅ データ同期
- ✅ LanceDBインデックス作成
- ✅ Lunrインデックス初期化
- ✅ GCSアップロード
- ❌ StructuredLabel自動統合（手動スクリプトで実行が必要）

### 📊 処理順序の保証

両方とも、GitHub Actionsワークフローで**正しい順序が保証**されています：

1. データ同期
2. インデックス作成/再構築
3. GCSアップロード

### 🔧 推奨される運用

- **Confluence**: 自動実行に任せる（何もする必要はない）
- **Jira**: 通常は自動実行に任せる、完全再構築時は`npm run sync:jira:rebuild`を使用

