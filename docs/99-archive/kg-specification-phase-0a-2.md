# Knowledge Graphä»•æ§˜ï¼ˆPhase 0A-2ï¼‰

**ä½œæˆæ—¥**: 2025-10-15  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…å®Œäº†  
**ãƒ–ãƒ©ãƒ³ãƒ**: `phase-0a-2`

---

## ğŸ“Š æ¦‚è¦

### ç›®çš„

Confluenceãƒšãƒ¼ã‚¸é–“ã®é–¢ä¿‚æ€§ã‚’æ˜ç¤ºçš„ã«ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã€æ¤œç´¢çµæœã®æ‹¡å¼µã«æ´»ç”¨ã™ã‚‹ã€‚

### æœŸå¾…åŠ¹æœ

- **æ¤œç´¢ç²¾åº¦å‘ä¸Š**: ç›´æ¥ãƒãƒƒãƒã—ãªã„ãŒé–¢é€£ã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’ç™ºè¦‹
- **å›ç­”å“è³ªå‘ä¸Š**: ã‚ˆã‚Šå¤šãã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’LLMã«æä¾›
- **Phase 0A-1.5**: 83% â†’ **Phase 0A-2**: 85-90%ï¼ˆç›®æ¨™ï¼‰

---

## ğŸ—ï¸ Knowledge Graphæ§‹é€ 

### ãƒãƒ¼ãƒ‰ï¼ˆ679ä»¶ï¼‰

#### ãƒšãƒ¼ã‚¸ãƒãƒ¼ãƒ‰ï¼ˆ639ä»¶ï¼‰
```typescript
{
  id: "page-718373062",
  type: "page",
  name: "164_ã€FIXã€‘æ•™å®¤å‰Šé™¤æ©Ÿèƒ½",
  pageId: "718373062",
  structuredLabel: { ... },
  importance: 1.0
}
```

#### æ¦‚å¿µãƒãƒ¼ãƒ‰ï¼ˆ40ä»¶ï¼‰
- **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ï¼ˆ34ä»¶ï¼‰**: ä¼šå“¡ç®¡ç†ã€æ±‚äººç®¡ç†ã€æ•™å®¤ç®¡ç†ãªã©
- **ã‚«ãƒ†ã‚´ãƒªãƒãƒ¼ãƒ‰ï¼ˆ6ä»¶ï¼‰**: spec, data, template, workflow, meeting, other

---

## ğŸ”— ã‚¨ãƒƒã‚¸ã‚¿ã‚¤ãƒ—ã¨æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯

### 1. URLãƒªãƒ³ã‚¯ï¼ˆweight: 1.0ï¼‰âœ… **æœ€é«˜ä¿¡é ¼åº¦**

**ãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
/\/pages\/(\d+)/g
```

**ä¾‹**:
```
https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/772014210
â†’ 164 â†’ 772014210
```

**ç‰¹å¾´**:
- Confluenceå†…éƒ¨ãƒªãƒ³ã‚¯ã®ã¿ï¼ˆFigmaãƒªãƒ³ã‚¯ã¯é™¤å¤–ï¼‰
- æœ€ã‚‚ä¿¡é ¼æ€§ãŒé«˜ã„å‚ç…§é–¢ä¿‚
- è‡ªå·±å‚ç…§ã¯é™¤å¤–

---

### 2. ãƒšãƒ¼ã‚¸ç•ªå·å‚ç…§ï¼ˆweight: 0.7ï¼‰âœ… **ä¸­ä¿¡é ¼åº¦**

**ãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
/(\d{3})_/g
```

**ä¾‹**:
```
"177_ã€FIXã€‘æ±‚äººå‰Šé™¤æ©Ÿèƒ½"
â†’ 164 â†’ 177
```

**ç‰¹å¾´**:
- ã™ã¹ã¦ã®ã€ŒNNN_ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
- ã‚·ãƒ³ãƒ—ãƒ«ã§èª¤æ¤œå‡ºãŒå°‘ãªã„
- é‡è¤‡ã¯è‡ªå‹•é™¤å¤–

---

### 3. ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢ä¿‚ï¼ˆweight: 0.5-0.7ï¼‰

**æ§‹ç¯‰æ–¹æ³•**:
```typescript
// åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã®ãƒšãƒ¼ã‚¸ã‚’ç›¸äº’ãƒªãƒ³ã‚¯
if (label1.domain === label2.domain) {
  weight = 0.5 (åŸºæœ¬)
  weight = 0.7 (categoryä¸€è‡´æ™‚)
}
```

**ä¾‹**:
```
164_æ•™å®¤å‰Šé™¤æ©Ÿèƒ½ [domain: æ±‚äººç®¡ç†]
âŸ· 155_æ•™å®¤ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤æ©Ÿèƒ½ [domain: æ±‚äººç®¡ç†]
```

---

### 4. ã‚¿ã‚°é–¢ä¿‚ï¼ˆweight: 0.3-1.0ï¼‰

**æ§‹ç¯‰æ–¹æ³•**:
```typescript
// Jaccardé¡ä¼¼åº¦ >= 0.3
similarity = |tags1 âˆ© tags2| / |tags1 âˆª tags2|
```

**ä¾‹**:
```
164_æ•™å®¤å‰Šé™¤æ©Ÿèƒ½ [tags: ["å‰Šé™¤", "æ•™å®¤ç®¡ç†"]]
âŸ· 124_ä¼æ¥­å‰Šé™¤æ©Ÿèƒ½ [tags: ["å‰Šé™¤", "ä¼æ¥­ç®¡ç†"]]
similarity: 0.5 â†’ weight: 0.5
```

---

## ğŸ” æ¤œç´¢çµ±åˆãƒ­ã‚¸ãƒƒã‚¯

### æ¤œç´¢ãƒ•ãƒ­ãƒ¼

```
1. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆVector + BM25ï¼‰
   â†“ åˆæœŸçµæœ: 6-8ä»¶
   
2. Knowledge Graphæ‹¡å¼µ
   â”œâ”€ URLãƒªãƒ³ã‚¯ãƒ»ãƒšãƒ¼ã‚¸ç•ªå·å‚ç…§: æœ€å¤§2ä»¶
   â”‚   â””â”€ weight >= 0.7
   â”‚
   â””â”€ ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢ä¿‚: æœ€å¤§1ä»¶
       â””â”€ weight >= 0.5ã€åˆè¨ˆ12ä»¶æœªæº€ã®å ´åˆã®ã¿
   
3. æœ€çµ‚çµæœ: 8-12ä»¶
```

### å®Ÿè£…ï¼ˆ`retrieve-relevant-docs-lancedb.ts`ï¼‰

```typescript
// å„æ¤œç´¢çµæœã«ã¤ã„ã¦é–¢é€£ãƒšãƒ¼ã‚¸ã‚’å–å¾—
for (const result of results) {
  const pageId = result.pageId;
  
  // å‚ç…§é–¢ä¿‚ï¼ˆé«˜é‡ã¿ï¼‰ã‚’å„ªå…ˆ
  const referenced = await kgSearchService.getReferencedPages(pageId, 2);
  
  for (const { node, edge } of referenced.relatedPages) {
    if (addedPageIds.has(node.pageId)) continue;
    
    const relatedContent = await getPageContent(node.pageId);
    
    expanded.push({
      ...node,
      content: relatedContent,
      source: 'knowledge-graph',
      kgWeight: edge.weight
    });
    
    addedPageIds.add(node.pageId);
  }
  
  // ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢é€£ï¼ˆä¸­é‡ã¿ï¼‰ã‚‚è¿½åŠ ï¼ˆæœ€å¤§1ä»¶ã€12ä»¶æœªæº€ã®å ´åˆã®ã¿ï¼‰
  if (expanded.length < 12) {
    const domainRelated = await kgSearchService.getRelatedPagesInDomain(pageId, 1);
    // ...
  }
}
```

---

## ğŸ“ˆ çµ±è¨ˆæƒ…å ±

### æ§‹ç¯‰è¦æ¨¡

```
ãƒãƒ¼ãƒ‰ç·æ•°: 679ä»¶
  - ãƒšãƒ¼ã‚¸ãƒãƒ¼ãƒ‰: 639ä»¶
  - æ¦‚å¿µãƒãƒ¼ãƒ‰: 40ä»¶

ã‚¨ãƒƒã‚¸ç·æ•°: ~4,000-5,000ä»¶ï¼ˆäºˆæƒ³ï¼‰
  - URLãƒªãƒ³ã‚¯: ~500-1,000ä»¶
  - ãƒšãƒ¼ã‚¸ç•ªå·å‚ç…§: ~500-1,000ä»¶
  - ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢ä¿‚: 20,720ä»¶
  - ã‚¿ã‚°é–¢ä¿‚: 2,140ä»¶
```

### ã‚¨ãƒƒã‚¸å¯†åº¦

- **å¹³å‡å‡ºæ¬¡æ•°**: ~6-8ã‚¨ãƒƒã‚¸/ãƒšãƒ¼ã‚¸
- **å‚ç…§é–¢ä¿‚**: ~1-2ã‚¨ãƒƒã‚¸/ãƒšãƒ¼ã‚¸ï¼ˆURLãƒªãƒ³ã‚¯+ãƒšãƒ¼ã‚¸ç•ªå·ï¼‰

---

## ğŸ› ï¸ ç®¡ç†ã‚³ãƒãƒ³ãƒ‰

```bash
# Knowledge Graphæ§‹ç¯‰
npm run kg:build

# ãƒãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º
npm run kg:list

# ç‰¹å®šãƒšãƒ¼ã‚¸ã®å¯è¦–åŒ–
npm run kg:visualize <pageId>
npm run kg:visualize 718373062  # 164_æ•™å®¤å‰Šé™¤æ©Ÿèƒ½

# Graphviz DOTå½¢å¼
npm run kg:visualize:dot <pageId>
```

---

## ğŸ¯ è¨­è¨ˆæ€æƒ³

### ã‚·ãƒ³ãƒ—ãƒ«æ€§é‡è¦–

- **URLãƒªãƒ³ã‚¯**: æœ€ã‚‚ä¿¡é ¼æ€§ãŒé«˜ã„ï¼ˆweight: 1.0ï¼‰
- **ãƒšãƒ¼ã‚¸ç•ªå·å‚ç…§**: ã‚·ãƒ³ãƒ—ãƒ«ã§èª¤æ¤œå‡ºãŒå°‘ãªã„ï¼ˆweight: 0.7ï¼‰
- **è¤‡é›‘ãªãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³**: é™¤å¤–ï¼ˆèª¤æ¤œå‡ºãŒå¤šã„ãŸã‚ï¼‰

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- Firestore batchå‡¦ç†ã§500ä»¶ãšã¤ä¿å­˜
- ã‚¨ãƒƒã‚¸ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»˜ãï¼ˆ`from`, `to`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
- æ¤œç´¢æ™‚ã®å–å¾—ã¯10ä»¶ãšã¤ã®ãƒãƒƒãƒå‡¦ç†

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- æ¤œç´¢çµæœæ‹¡å¼µ: 1ã‚¯ã‚¨ãƒªã‚ãŸã‚Š1-3å›ã®Firestoreèª­ã¿å–ã‚Š
- ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°: LanceDBã®ãƒãƒ£ãƒ³ã‚¯å–å¾—çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- æ‹¡å¼µã¯æœ€å¤§12ä»¶ã¾ã§ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·ã®åˆ¶ç´„ï¼‰

---

## ğŸ“ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `src/types/knowledge-graph.ts` | å‹å®šç¾© |
| `src/lib/kg-reference-extractor.ts` | å‚ç…§é–¢ä¿‚æŠ½å‡º |
| `src/lib/kg-label-builder.ts` | StructuredLabelé–¢ä¿‚æ§‹ç¯‰ |
| `src/lib/kg-storage-service.ts` | Firestoreä¿å­˜ãƒ»å–å¾— |
| `src/lib/kg-search-service.ts` | KGæ¤œç´¢ |
| `src/ai/flows/retrieve-relevant-docs-lancedb.ts` | æ¤œç´¢çµ±åˆ |
| `scripts/build-knowledge-graph.ts` | KGæ§‹ç¯‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| `scripts/visualize-kg.ts` | å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ« |

---

## âœ… Phase 0A-2 å®Œäº†

- [x] KGå‹å®šç¾©
- [x] å‚ç…§é–¢ä¿‚æŠ½å‡ºï¼ˆURLãƒªãƒ³ã‚¯ + ãƒšãƒ¼ã‚¸ç•ªå·ï¼‰
- [x] StructuredLabelé–¢ä¿‚æ§‹ç¯‰
- [x] Firestoreä¿å­˜
- [x] KGæ¤œç´¢ã‚µãƒ¼ãƒ“ã‚¹
- [x] æ¤œç´¢çµæœæ‹¡å¼µ
- [x] KGæ§‹ç¯‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- [x] å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«

