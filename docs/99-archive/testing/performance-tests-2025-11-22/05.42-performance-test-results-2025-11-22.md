# パフォーマンステスト結果 (2025-11-22 詳細ログ有効)

**作成日**: 2025年11月22日  
**テストモード**: キャッシュ無効 + メモリ監視 + 詳細ログ有効  
**ステータス**: 🔴 **重大なパフォーマンス問題を確認**

---

## 📊 テスト結果サマリー

### 検索時間の推移

| クエリ | 検索時間 | ウォームアップ時間 | 評価 |
|--------|---------|------------------|------|
| 1. 学年自動更新バッチ | **2824ms** | 118120ms（約118秒） | ✅ **正常** |
| 2. 教室管理の詳細 | **61970ms** (約62秒) | 448ms | ❌ **異常** |
| 3. 会員登録機能 | **197951ms** (約198秒) | 384ms | 🔴 **異常に長い** |
| 4. 求人削除機能 | **96743ms** (約97秒) | 1532ms | ❌ **異常** |
| 5. 応募管理の一覧 | **96925ms** (約97秒) | 458ms | ❌ **異常** |

**平均検索時間**: **91282.60ms**（約91秒、目標: 2000ms以下、超過: 89282.60ms）⚠️

---

## 🔍 問題の分析

### 問題1: **検索時間が異常に長い** 🔴 **最重要**

**症状**:
- クエリ1: 2824ms ✅ **正常**
- クエリ2-5: 62-198秒 ❌ **異常に長い**
- 特にクエリ3が197秒と異常に長い

**前回のテスト結果との比較**:
- 前回: クエリ2-5が24-56秒
- 今回: クエリ2-5が62-198秒
- **さらに悪化している**

---

### 問題2: **ウォームアップリクエストの時間が長い** 🟡 **中程度**

**症状**:
- クエリ1の前: 118120ms（約118秒）⚠️ **異常に長い**
- クエリ2-5の前: 384-1532ms ✅ **正常**

**原因**:
- 初回のLunrインデックス読み込みに時間がかかっている
- しかし、ウォームアップが完了しても、実際のテストクエリで検索が遅い

---

### 問題3: **クエリ3が特に遅い** 🔴 **最重要**

**症状**:
- クエリ3: 197951ms（約198秒）
- 他のクエリ（2, 4, 5）: 62-97秒

**仮説**:
- 何らかのリソース競合が発生している
- Lunrインデックスの初期化が完了していない状態で検索が実行されている
- タイムアウトやリトライが発生している可能性

---

## 🎯 原因の仮説

### 仮説1: **Lunrインデックスの初期化待機が不完全** 🔴 **最有力**

**証拠**:
1. ウォームアップリクエストが384-1532msで完了している
2. しかし、実際のテストクエリで検索が62-198秒かかっている
3. 5秒の待機時間が不十分な可能性

**対策**:
- Lunrインデックスの初期化完了をポーリングで確認
- 待機時間を動的に調整

---

### 仮説2: **ベクトル検索の遅延** 🟡 **中程度**

**可能性**:
- LanceDBのメモリマップドファイルの読み込みに時間がかかっている
- ベクトル検索のクエリ実行に時間がかかっている

**確認方法**:
- サーバー側のログで`[PERF] 🔍 Vector search completed`の時間を確認

---

### 仮説3: **BM25検索の初期化待機が長い** 🔴 **最有力**

**可能性**:
- BM25検索の初期化待機時間が長い（最大180秒まで待機可能）
- タイムアウト（60秒）後にポーリング（最大120秒）で待機している

**確認方法**:
- サーバー側のログで`[BM25 Search] ✅ Lunr ready for <table> after <time>ms`の時間を確認

---

## 📋 次のステップ

### ステップ1: **サーバー側のログを確認** 🔴 **最優先**

開発サーバーのターミナルで、以下のログを確認してください：

1. **ベクトル検索の時間**
   ```
   [PERF] 🔍 Vector search completed in <time>ms
   ```

2. **BM25検索の時間**
   ```
   [BM25 Search] ✅ BM25 search completed in <time>ms
   ```

3. **BM25初期化待機時間**
   ```
   [BM25 Search] ✅ Lunr ready for <table> after <time>ms total wait time
   ```

4. **検索処理の内訳**
   ```
   [PERF] 🔍 Search performance breakdown: {
     searchLanceDB: '<time>ms',
     enrichWithAllChunks: '<time>ms',
     filterInvalidPages: '<time>ms',
     total: '<time>ms'
   }
   ```

---

### ステップ2: **ウォームアップリクエストの完了判定を改善** 🔴 **最優先**

**現在の実装**:
- ウォームアップリクエスト完了後、5秒待機
- しかし、Lunrインデックスの再読み込みには10-40秒かかる可能性がある

**改善案**:
1. Lunrインデックスの初期化完了をポーリングで確認
2. 待機時間を動的に調整（ウォームアップ時間の1.5倍、最低5秒）

---

### ステップ3: **キャッシュクリアの見直し** 🟡 **中優先度**

**現在の実装**:
- 各クエリの前にキャッシュをクリア
- Lunrインデックスがメモリから削除される

**改善案**:
- テスト開始前に1回だけクリア
- または、キャッシュクリアをスキップしてウォームアップリクエストのみ実行

---

## 📊 メモリ監視結果

### メモリ使用量の推移

| クエリ | 開始時RSS | 完了時RSS | RSS差分 | 評価 |
|--------|----------|----------|---------|------|
| 1. 学年自動更新バッチ | 66.15MB | 65.18MB | **-0.97MB** | ✅ **正常** |
| 2. 教室管理の詳細 | 65.90MB | 66.13MB | **+0.23MB** | ✅ **正常** |
| 3. 会員登録機能 | 66.56MB | 66.95MB | **+0.39MB** | ✅ **正常** |
| 4. 求人削除機能 | 66.95MB | 66.94MB | **-0.01MB** | ✅ **正常** |
| 5. 応募管理の一覧 | 66.41MB | 66.69MB | **+0.28MB** | ✅ **正常** |

**結論**: ✅ **メモリリークは発生していない**

---

## ✅ 結論

1. ✅ **メモリリークは発生していない**
2. ❌ **検索時間が異常に長い（62-198秒）**
3. ❌ **クエリ3が特に遅い（197秒）**
4. 🔴 **サーバー側のログを確認して、ボトルネックを特定する必要がある**

---

## 🔗 関連ドキュメント

- [サーバー側ログ分析ガイド](./05.41-server-log-analysis-guide-2025-11-22.md)
- [検索パフォーマンス詳細分析](./05.40-search-performance-detailed-analysis-2025-11-22.md)
- [メモリ監視付きパフォーマンステスト結果](./05.39-memory-monitoring-test-results-2025-11-22.md)

