# クエリ3 テストチェックリスト (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: クエリ3のテスト実行時に確認すべきポイント

---

## 📋 テスト実行前の準備

### 1. 開発サーバーが起動していることを確認

```bash
# VSCodeのターミナルで確認
# 開発サーバーが起動しているターミナルを開く
# 以下のような出力が表示されていることを確認：
# > next dev -p 9004 -H 0.0.0.0
# - Local:        http://localhost:9004
```

---

### 2. テストスクリプトを実行

```bash
# 別のターミナルで実行
cd c:\dev\CODE\Confluence_firebase
$env:DEBUG_MEMORY='true'; $env:DEBUG_SEARCH='true'; $env:DEBUG_BM25='true'; npm run test:api-performance-single -- --query=3 --no-cache
```

---

## 🔍 確認すべきログ

### クエリ3実行時の時刻を記録

テストスクリプトの出力から、以下の時刻を記録してください：
- **リクエスト送信時刻**: `2025-11-22T08:57:20.656Z`（例）

---

### 開発サーバーのターミナルで確認すべきログ

クエリ3実行時の時刻の前後で、以下のログを探してください：

#### 1. **検索処理の開始**
```
[PERF] 🔍 検索処理開始（ユーザー認識時間）: <timestamp>
```
**確認ポイント**: リクエストがサーバーに到達した時刻

---

#### 2. **retrieveRelevantDocsの呼び出し**
```
[PERF] 📥 retrieveRelevantDocs呼び出し開始: <time>ms (リクエスト受信からの経過時間)
[PERF] 📥 retrieveRelevantDocs完了: <time>ms (累計: <time>ms)
```
**確認ポイント**: 
- `retrieveRelevantDocs`の実行時間
- 目標: 5000ms以下

---

#### 3. **実際の検索処理開始**
```
[PERF] 🔍 実際の検索処理開始: <time>ms (初期化時間を除外)
```
**確認ポイント**: 初期化時間を除外した実際の検索処理の開始時刻

---

#### 4. **並列検索の完了**
```
[PERF] ⏱️ Phase 5 parallel search completed in <time>ms (<time>s)
```
**確認ポイント**: 
- ベクトル検索とBM25検索の並列実行時間
- 目標: 3000ms以下

---

#### 5. **ベクトル検索の完了**
```
[PERF] 🔍 Vector search completed in <time>ms
```
**確認ポイント**: 
- ベクトル検索の実行時間
- 目標: 1000ms以下
- **5秒以上かかっている場合、これがボトルネック**

---

#### 6. **BM25検索の完了**
```
[BM25 Search] ✅ BM25 search completed in <time>ms
```
**確認ポイント**: 
- BM25検索の実行時間
- 目標: 2000ms以下
- **5秒以上かかっている場合、これがボトルネック**

---

#### 7. **BM25初期化待機時間**
```
[BM25 Search] Lunr not ready for <table>, initializing...
[BM25 Search] ✅ Lunr initialization completed for <table>
または
[BM25 Search] ⏳ Lunr initialization timeout for <table> after 60s, polling for readiness...
[BM25 Search] ✅ Lunr ready for <table> after <time>ms total wait time
```
**確認ポイント**: 
- Lunrインデックスの初期化待機時間
- 目標: 5000ms以下（0msが理想）
- **20秒以上かかっている場合、これがボトルネック**

---

#### 8. **検索処理の完了**
```
[PERF] 🔍 検索処理完了（ユーザー認識時間）: 総時間 <time>ms (リクエスト受信から検索完了まで)
```
**確認ポイント**: 検索処理全体の時間（クライアント側の計測と一致するはず）

---

#### 9. **検索パフォーマンスの内訳**
```
[PERF] 🔍 Search performance breakdown: {
  searchLanceDB: '<time>ms',
  enrichWithAllChunks: '<time>ms',
  filterInvalidPages: '<time>ms',
  total: '<time>ms',
  query: '会員登録機能について'
}
```
**確認ポイント**: 
- `searchLanceDB`: ベクトル検索とBM25検索の時間
- `enrichWithAllChunks`: チャンク統合の時間
- `filterInvalidPages`: フィルタリングの時間
- 目標: 合計5000ms以下

---

## 📊 ログの記録方法

### 方法1: ログをコピー＆ペースト

開発サーバーのターミナルで、クエリ3実行時のログをコピーして共有してください。

---

### 方法2: ログをファイルに保存

開発サーバーを起動する際に、出力をファイルにリダイレクト：

```powershell
# 開発サーバーを起動するターミナルで実行
npm run dev 2>&1 | Tee-Object -FilePath logs\dev-server.log
```

---

## ✅ 確認チェックリスト

- [ ] 開発サーバーが起動していることを確認
- [ ] テストスクリプトを実行
- [ ] クエリ3実行時の時刻を記録
- [ ] 開発サーバーのターミナルでログを確認
- [ ] 各段階での処理時間を記録
- [ ] ボトルネックを特定

---

## 🎯 分析のポイント

### 正常な場合

- 検索時間: 500ms以下
- ベクトル検索: 500ms以下
- BM25検索: 1000ms以下
- BM25初期化待機: 0ms（既に初期化済み）

### 問題がある場合

- 検索時間: 5秒以上
- ベクトル検索: 5秒以上 → **ベクトル検索がボトルネック**
- BM25検索: 5秒以上 → **BM25検索がボトルネック**
- BM25初期化待機: 20秒以上 → **Lunrインデックスの初期化待機がボトルネック**

---

## 🔗 関連ドキュメント

- [サーバー側ログ分析ガイド](./05.41-server-log-analysis-guide-2025-11-22.md)
- [サーバー側ログの場所と確認方法](./05.44-server-log-location-guide-2025-11-22.md)
- [クエリ3 ステップバイステップ分析](./05.43-query3-step-by-step-analysis-2025-11-22.md)

