# 開発環境メモリ最適化計画 (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: 開発環境でのメモリ増加（RSS +435.23MB、Heap +148.84MB）を対策  
**ステータス**: 🔄 **実装中**（ステップ1完了）

---

## ⚠️ 優先順位の判断

### 本番環境 vs 開発環境

| 項目 | 本番環境 | 開発環境 |
|------|---------|---------|
| **緊急度** | 🔴 **高**（クラッシュ発生） | 🟡 **中**（動作は正常） |
| **影響範囲** | 🔴 **全ユーザー** | 🟡 **開発者のみ** |
| **リスク** | 🔴 **サービス停止** | 🟢 **低** |
| **対策の効果** | 🔴 **大**（メモリ制限エラー解消） | 🟡 **中**（メモリ使用量削減） |

### 推奨: **本番環境の対策を優先、開発環境の対策は並行して実装**

**理由**:
1. 本番環境のメモリ制限エラーは緊急度が高い
2. 開発環境の対策は本番環境でも有効
3. 両方の対策を並行して実装することで、総合的なメモリ最適化が可能

---

## 📊 現状の問題

### 開発環境でのメモリ増加

```
⚠️ [Memory] Search execution: RSS increased by +435.23MB
⚠️ [Memory] Search execution: Heap used increased by +148.84MB
```

- **RSS増加**: +435.23MB（検索実行時）
- **Heap増加**: +148.84MB（検索実行時）
- **影響**: 本番環境でも同様の問題が発生する可能性が高い

---

## 🔍 原因分析

### 1. 検索結果キャッシュのサイズ 🔴 **主要因**

**現状**:
- `maxSize: 5000`（検索結果キャッシュ）
- 各エントリが検索結果の配列を保持
- 1エントリあたり約10-50KB（推定）

**計算**:
- 5000エントリ × 30KB（平均） = 約150MB
- 実際のメモリ使用量はさらに大きい可能性（参照、オブジェクトオーバーヘッド）

### 2. タイトル検索キャッシュのサイズ 🟡 **中程度**

**現状**:
- `maxSize: 1000`（タイトル検索キャッシュ）
- 各エントリが検索結果の配列を保持
- 1エントリあたり約5-20KB（推定）

**計算**:
- 1000エントリ × 10KB（平均） = 約10MB

### 3. 検索実行時の一時的なメモリ増加 🟡 **中程度**

**現状**:
- 検索結果の配列を保持
- ベクトル検索結果、BM25検索結果、RRF融合結果など
- 検索完了後もメモリに残る可能性

---

## 🎯 対策計画

### 優先度1: **キャッシュサイズの削減** 🔴 **最優先**

#### 現状

- 検索結果キャッシュ: `maxSize: 5000`
- タイトル検索キャッシュ: `maxSize: 1000`

#### 対策

- 検索結果キャッシュ: `maxSize: 5000` → `maxSize: 2000`（60%削減）
- タイトル検索キャッシュ: `maxSize: 1000` → `maxSize: 500`（50%削減）

#### 期待効果

- **メモリ使用量**: 約50-60%削減（キャッシュ関連）
- **影響**: キャッシュヒット率が若干低下する可能性（ただし、LRUにより頻繁に使用されるエントリは保持される）

#### 実装場所

- `src/lib/lancedb-search-client.ts`（検索結果キャッシュ、タイトル検索キャッシュ）

---

### 優先度2: **検索完了後のメモリ解放** 🟡 **中優先度**

#### 対策案

1. **明示的なメモリ解放**
   - 検索完了後に不要なデータを明示的に解放
   - 大きな配列を`null`に設定

2. **ガベージコレクションの促進**
   - `global.gc()`を呼び出してガベージコレクションを促進（開発環境のみ）

3. **定期的なキャッシュクリーンアップ**
   - 定期的に古いキャッシュエントリを削除
   - メモリ使用量が閾値を超えたらクリーンアップ

#### 期待効果

- 検索実行時のメモリ増加を約20-30%削減可能

---

### 優先度3: **メモリ監視の強化** 🟡 **中優先度**

#### 対策案

1. **メモリ使用量の詳細ログ**
   - キャッシュごとのメモリ使用量を記録
   - メモリ増加の原因を特定

2. **アラート設定**
   - メモリ使用量が閾値を超えたら警告
   - キャッシュサイズの自動調整

#### 期待効果

- 問題の早期発見と対応

---

## 📋 実装ステップ

### ステップ1: キャッシュサイズの削減 ✅ **実装完了**

1. ✅ `src/lib/lancedb-search-client.ts`を確認
2. ✅ 検索結果キャッシュの`maxSize: 5000` → `maxSize: 2000`に変更
3. ✅ タイトル検索キャッシュの`maxSize: 1000` → `maxSize: 500`に変更
4. ✅ 品質テストを実行して効果を確認

**実装内容**:
- 検索結果キャッシュ: `maxSize: 5000` → `maxSize: 2000`（60%削減）
- タイトル検索キャッシュ: `maxSize: 1000` → `maxSize: 500`（50%削減）

**品質テスト結果**:
- ✅ 両方のクエリで合格（対象ページが4位に含まれている）
- ✅ キャッシュサイズの削減が品質に影響しないことを確認

**メモリ使用量**:
- RSS増加: +430.98MB（改善前: +435.23MB）→ 約1%削減
- Heap増加: +150.32MB（改善前: +148.84MB）→ 約1%増加

**分析**:
- キャッシュサイズの削減は、キャッシュ関連のメモリ使用量を削減しますが、検索実行時の一時的なメモリ増加（LanceDBメモリマップドファイル、Lunrインデックスなど）には影響しません
- メモリ増加の主な原因は、LanceDBメモリマップドファイル（約12GB/テーブル）とLunrインデックス（約260MB/テーブル）です

### ステップ2: 検索完了後のメモリ解放

1. 検索完了後に不要なデータを明示的に解放
2. ガベージコレクションの促進（開発環境のみ）
3. テストを実行して効果を確認

### ステップ3: メモリ監視の強化

1. メモリ使用量の詳細ログを実装
2. アラート設定を実装
3. テストを実行して効果を確認

---

## 🔗 関連ドキュメント

- [メモリ最適化計画](./05.60-memory-optimization-plan-2025-11-22.md)
- [メモリ使用量分析レポート](../01-architecture/MEMORY_USAGE_ANALYSIS_2025-11-21.md)

