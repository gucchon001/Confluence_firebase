# メモリ最適化の現在すべきこと (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: メモリ最適化のために現在すべきことを明確化  
**ステータス**: 📋 **アクションアイテム**

---

## 📊 現状の整理

### 完了済みの対策 ✅

1. **キャッシュサイズの削減** ✅
   - 検索結果キャッシュ: `maxSize: 5000` → `maxSize: 2000`（60%削減）
   - タイトル検索キャッシュ: `maxSize: 1000` → `maxSize: 500`（50%削減）
   - 効果: キャッシュ関連のメモリ使用量を削減

2. **Jiraテーブルの遅延初期化** ✅
   - 起動時には`confluence`のみ初期化
   - `jira_issues`は検索リクエストが来た時にオンデマンドで初期化
   - 効果: メモリ使用量を約半分に削減（約12GB → 約6GB）

3. **メモリ警告閾値の調整** ✅
   - RSS増加閾値: 100MB → 500MB
   - Heap増加閾値: 50MB → 200MB
   - 効果: 正常なメモリ増加に対する警告を削減

4. **`minInstances: 2`を維持する決定** ✅
   - コールドスタート完全回避（17秒の遅延削減）
   - 冗長性の向上
   - パフォーマンスの安定性

---

## 🔴 最優先: メモリ制限の増加

### 現状の問題

```
Memory limit of 8192 MiB exceeded with 8206 MiB used
```

- **メモリ制限**: 8GB
- **実際の使用量**: 8.2GB（制限超過）
- **影響**: インスタンスクラッシュ・再起動
- **緊急度**: 🔴 **高**（本番環境でクラッシュ発生）

### 対策

**`apphosting.yaml`の`memoryMiB`を増加**:

```yaml
runConfig:
  memoryMiB: 16384  # 8GB → 16GBに増加
```

### 期待効果

- ✅ メモリ制限エラーの解消
- ✅ 余裕を持ったメモリ使用が可能
- ✅ インスタンスクラッシュの防止

### リスク

- ⚠️ コストの増加（メモリ使用量に応じて課金される）
- ⚠️ ただし、`minInstances: 2`を維持する場合、メモリ制限を増やすことで安定性が向上

### 実装手順

1. `apphosting.yaml`を編集
2. `memoryMiB: 8192` → `memoryMiB: 16384`に変更
3. 変更をコミット・プッシュ
4. デプロイ後のメモリ使用量を監視

---

## 🟡 優先度2: 検索完了後のメモリ解放

### 現状

- 検索実行時のRSS増加: +430.98MB
- 検索完了後もメモリに残る可能性

### 対策案

1. **明示的なメモリ解放**
   - 検索完了後に不要なデータを明示的に解放
   - 大きな配列を`null`に設定

2. **ガベージコレクションの促進**
   - 定期的にガベージコレクションを実行（開発環境のみ）

3. **定期的なキャッシュクリーンアップ**
   - 定期的に古いキャッシュエントリを削除
   - メモリ使用量が閾値を超えたらクリーンアップ

### 期待効果

- 検索実行時のメモリ増加を約20-30%削減可能

### 実装場所

- `src/lib/lancedb-search-client.ts`
- `src/lib/unified-search-result-processor.ts`

---

## 🟡 優先度3: メモリ監視とアラート

### 対策案

1. **メモリ使用量の監視**
   - リアルタイムでメモリ使用量を監視
   - テーブルごとのメモリ使用量を記録

2. **アラート設定**
   - メモリ使用率が80%を超えたらアラート
   - メモリ制限に近づいたら警告

3. **自動スケーリング**
   - メモリ使用率に基づいて自動スケール

### 期待効果

- 問題の早期発見と対応

---

## 📋 アクションアイテム（優先順位順）

### 🔴 最優先（今すぐ実施）

- [ ] **メモリ制限の増加**: `apphosting.yaml`の`memoryMiB: 8192` → `memoryMiB: 16384`に変更
  - 理由: 本番環境でメモリ制限エラーが発生しており、インスタンスクラッシュが発生している
  - 影響: メモリ制限エラーの解消、インスタンスクラッシュの防止
  - リスク: コストの増加（ただし、安定性向上のため必要）

### 🟡 優先度2（次に実施）

- [ ] **検索完了後のメモリ解放**: 検索完了後に不要なデータを明示的に解放
  - 理由: 検索実行時のメモリ増加を削減
  - 影響: メモリ使用量の削減（約20-30%）
  - リスク: 低

### 🟡 優先度3（今後検討）

- [ ] **メモリ監視とアラート**: リアルタイムでメモリ使用量を監視し、アラートを設定
  - 理由: 問題の早期発見と対応
  - 影響: 問題の早期発見
  - リスク: 低

---

## 🎯 推奨される実施順序

1. **ステップ1**: メモリ制限の増加（最優先）
   - `apphosting.yaml`を編集
   - コミット・プッシュ・デプロイ
   - メモリ使用量を監視

2. **ステップ2**: 検索完了後のメモリ解放（優先度2）
   - コードを実装
   - テストを実行
   - 効果を確認

3. **ステップ3**: メモリ監視とアラート（優先度3）
   - 監視機能を実装
   - アラートを設定
   - 運用を開始

---

## 🔗 関連ドキュメント

- [メモリ最適化計画](./05.60-memory-optimization-plan-2025-11-22.md)
- [minInstances: 2 維持の決定](./05.63-mininstances-2-maintenance-decision-2025-11-22.md)
- [開発環境メモリ最適化計画](./05.61-development-memory-optimization-2025-11-22.md)
- [メモリ使用量分析レポート](../01-architecture/MEMORY_USAGE_ANALYSIS_2025-11-21.md)

