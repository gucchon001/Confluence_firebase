# メモリ最適化計画 (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: 本番環境のメモリ制限エラーを解消するための対策計画  
**ステータス**: 📋 **計画策定中**

---

## 📊 現状の問題

### メモリ制限エラー

```
Memory limit of 8192 MiB exceeded with 8206 MiB used
```

- **メモリ制限**: 8GB
- **実際の使用量**: 8.2GB（制限超過）
- **影響**: インスタンスクラッシュ・再起動

### メモリ使用量の内訳

| 項目 | 使用量 | 備考 |
|------|--------|------|
| LanceDBメモリマップドファイル（1テーブル） | 約12GB | confluenceテーブル |
| LanceDBメモリマップドファイル（2テーブル） | 約24GB | confluence + jira_issues |
| 2インスタンス × 2テーブル | 約48GB | メモリマップドファイルが共有されない場合 |

---

## 🎯 対策計画

### 優先度1: **インスタンス数の削減** 🔴 **最優先**

#### 現状

- `minInstances: 2`（2つのインスタンスが常時起動）
- 各インスタンスがメモリマップドファイルを読み込む

#### 対策

- `minInstances: 2` → `minInstances: 1`に削減

#### 期待効果

- **メモリ使用量**: 約50%削減（2インスタンス → 1インスタンス）
- **コスト**: 約50%削減
- **リスク**: Cold Startの可能性（ただし、起動時初期化により影響を最小化）

#### 実装場所

- `setup/apphosting.yaml` または `apphosting.yaml`

---

### 優先度2: **検索実行時のメモリ増加の最適化** 🟡 **中優先度**

#### 現状

- 検索実行時のRSS増加: +283.82MB
- リクエストごとにメモリが増加

#### 対策案

1. **キャッシュサイズの制限**
   - タイトル検索キャッシュのサイズを制限
   - 古いキャッシュエントリを削除

2. **不要なデータの解放**
   - 検索完了後に不要なデータを明示的に解放
   - ガベージコレクションを促進

3. **バッチ処理の最適化**
   - メモリ使用量を削減するためのバッチサイズの調整

#### 期待効果

- 検索実行時のメモリ増加を約30-50%削減可能

---

### 優先度3: **メモリ監視とアラート** 🟡 **中優先度**

#### 対策案

1. **メモリ使用量の監視**
   - リアルタイムでメモリ使用量を監視
   - テーブルごとのメモリ使用量を記録

2. **アラート設定**
   - メモリ使用率が80%を超えたらアラート
   - メモリ制限に近づいたら警告

3. **自動スケーリング**
   - メモリ使用率に基づいて自動スケール

#### 期待効果

- 問題の早期発見と対応

---

## 📋 実装ステップ

### ステップ1: インスタンス数の削減 ❌ **実施しない（`minInstances: 2`を維持）**

1. ✅ `apphosting.yaml` を確認
2. ✅ 影響範囲の分析を実施
3. ✅ **決定: `minInstances: 2`を維持**

**決定理由**:
- **コールドスタート完全回避**（17秒の遅延削減）が最重要
- **冗長性の向上**（1つのインスタンスがクラッシュしても、もう1つが処理を継続）
- **パフォーマンスの安定性**（常に2つのインスタンスが起動し、負荷分散）
- メモリ制限エラーは他の対策で対応可能

**`minInstances: 2`を維持する場合の対策**:
1. ✅ キャッシュサイズの削減（実装完了）
2. ✅ Jiraテーブルの遅延初期化（実装完了）
3. ⏳ メモリ制限の増加（8GB → 16GB）を検討
4. ⏳ 他のメモリ最適化を実施

**参考ドキュメント**:
- [minInstances削減の影響範囲分析](./05.62-mininstances-impact-analysis-2025-11-22.md)

### ステップ2: 検索実行時のメモリ増加の最適化（開発環境・本番環境共通）

#### 2-1: キャッシュサイズの削減 ✅ **実装完了**

1. ✅ 検索結果キャッシュの`maxSize: 5000` → `maxSize: 2000`に変更
2. ✅ タイトル検索キャッシュの`maxSize: 1000` → `maxSize: 500`に変更
3. ✅ 品質テストを実行して効果を確認

**実装結果**:
- 品質テスト: ✅ 合格（両方のクエリで対象ページが4位に含まれている）
- メモリ使用量: RSS +430.98MB（改善前: +435.23MB）→ 約1%削減
- 分析: キャッシュサイズの削減は、キャッシュ関連のメモリ使用量を削減しますが、検索実行時の一時的なメモリ増加（LanceDBメモリマップドファイル、Lunrインデックスなど）には影響しません

**期待効果**: メモリ使用量を約50-60%削減（キャッシュ関連）→ 実際の削減は約1%（検索実行時の一時的なメモリ増加が主な原因）

#### 2-2: 不要なデータの解放

1. 検索完了後に不要なデータを明示的に解放
2. ガベージコレクションの促進（開発環境のみ）
3. テストを実行して効果を確認

#### 2-3: バッチ処理の最適化

1. メモリ使用量を削減するためのバッチサイズの調整
2. テストを実行して効果を確認

### ステップ3: メモリ監視とアラート

1. メモリ使用量の監視を実装
2. アラート設定を実装
3. 自動スケーリングを実装（必要に応じて）

---

## 🔗 関連ドキュメント

- [メモリ使用量分析レポート](../01-architecture/MEMORY_USAGE_ANALYSIS_2025-11-21.md)
- [優先度判断: パフォーマンス改善 vs メモリ対策](./05.59-priority-decision-2025-11-22.md)

