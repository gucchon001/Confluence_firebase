# サーバー側ログ分析 (2025-11-22)

**作成日**: 2025年11月22日  
**分析対象**: 開発サーバーのターミナルログ

---

## 📊 ログから確認できた情報

### クエリ: "ログイン認証の仕組みはどうなっていますか？"

#### 検索処理の時間内訳

| 段階 | 時間 | 評価 |
|------|------|------|
| ベクトル検索 | **71ms** | ✅ **正常** |
| BM25検索 | **1166ms** | ✅ **正常** |
| 並列検索完了 | **1172ms** | ✅ **正常** |
| searchLanceDB完了 | **3245ms** | ⚠️ **やや長い** |
| retrieveRelevantDocs完了 | **4301ms** | ⚠️ **やや長い** |
| 検索処理完了（ユーザー認識時間） | **5527ms** | ⚠️ **やや長い** |

#### 検索パフォーマンスの内訳

```
[PERF] 🔍 Search performance breakdown: {
  searchLanceDB: '3245ms',
  enrichWithAllChunks: '60ms',
  filterInvalidPages: '982ms',
  total: '4296ms',
  query: 'ログイン認証の仕組みはどうなっていますか？'
}
```

**分析**:
- `searchLanceDB`: 3245ms（ベクトル検索71ms + BM25検索1166ms + その他2008ms）
- `enrichWithAllChunks`: 60ms ✅ **正常**
- `filterInvalidPages`: 982ms ⚠️ **やや長い**
- 合計: 4296ms

---

### メモリ使用量

```
⚠️ [Memory] Search execution: RSS increased by +288.18MB
⚠️ [Memory] Search execution: Heap used increased by +132.09MB
```

**分析**:
- RSS: +288.18MB ⚠️ **大幅な増加**
- Heap: +132.09MB ⚠️ **大幅な増加**

---

### reference-enhancerの処理

```
[reference-enhancer] Enhancing allReferences (10 references)
[reference-enhancer] Enhanced allReferences: 10 → 15 references
```

**分析**:
- 参照元が10件から15件に拡張
- 複数の検索が実行されている（196ms, 269ms, 175ms, 120ms）

---

## 🔍 クエリ3のログを探す

### クエリ3実行時刻

**クエリ3実行時刻**: `2025-11-22T09:23:38.278Z`

開発サーバーのターミナルで、この時刻の前後のログを探してください。

---

### 検索方法

1. **ターミナルで `Ctrl+F` を押す**
2. **以下のキーワードで検索**:
   - `会員登録機能について`
   - `2025-11-22T09:23:38`
   - `[PERF] 🔍 検索処理開始`（クエリ3実行時刻付近）

---

## 📋 確認すべきログ（クエリ3用）

クエリ3実行時のログで、以下の情報を確認してください：

1. **検索処理の開始**
   ```
   [PERF] 🔍 検索処理開始（ユーザー認識時間）: 2025-11-22T09:23:38.XXX
   ```

2. **retrieveRelevantDocsの呼び出し**
   ```
   [PERF] 📥 retrieveRelevantDocs呼び出し開始: Xms
   [PERF] 📥 retrieveRelevantDocs完了: Xms
   ```

3. **ベクトル検索の完了**
   ```
   [PERF] 🔍 Vector search completed in Xms
   ```

4. **BM25検索の完了**
   ```
   [BM25 Search] ✅ BM25 search completed in Xms
   ```

5. **BM25初期化待機時間**
   ```
   [BM25 Search] ✅ Lunr ready for <table> after Xms total wait time
   ```

6. **並列検索の完了**
   ```
   [PERF] ⏱️ Phase 5 parallel search completed in Xms
   ```

7. **検索処理の完了**
   ```
   [PERF] 🔍 検索処理完了（ユーザー認識時間）: 総時間 Xms
   ```

8. **検索パフォーマンスの内訳**
   ```
   [PERF] 🔍 Search performance breakdown: { ... }
   ```

---

## 🎯 分析のポイント

### 正常な場合

- ベクトル検索: 100ms以下
- BM25検索: 2000ms以下
- BM25初期化待機: 0ms（既に初期化済み）
- 検索処理完了: 5000ms以下

### 問題がある場合

- ベクトル検索: 5秒以上 → **ベクトル検索がボトルネック**
- BM25検索: 5秒以上 → **BM25検索がボトルネック**
- BM25初期化待機: 20秒以上 → **Lunrインデックスの初期化待機がボトルネック**
- 検索処理完了: 10秒以上 → **全体の処理が遅い**

---

## ✅ 次のステップ

1. **クエリ3のログを探す**
   - ターミナルで `Ctrl+F` を押して「`会員登録機能について`」で検索
   - または「`2025-11-22T09:23:38`」で検索

2. **ログを共有**
   - クエリ3実行時のログをコピーして共有してください

3. **分析**
   - 各段階での処理時間を分析
   - ボトルネックを特定

---

## 🔗 関連ドキュメント

- [サーバー側ログ分析ガイド](./05.41-server-log-analysis-guide-2025-11-22.md)
- [サーバー側ログの場所と確認方法](./05.44-server-log-location-guide-2025-11-22.md)
- [クエリ3 ステップバイステップ分析](./05.43-query3-step-by-step-analysis-2025-11-22.md)

