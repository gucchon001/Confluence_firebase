# パフォーマンスデグレード分析 (2025-11-22)

**作成日**: 2025年11月22日  
**ステータス**: 🔍 分析完了

---

## 📊 問題の概要

ウォームアップリクエストの自動実行を実装した後のパフォーマンステストで、大幅なデグレードが発生しました。

### テスト結果サマリー

**実施日**: 2025-11-22  
**テスト方法**: 実際のAPIエンドポイント（`/api/streaming-process`）  
**テストモード**: キャッシュ無効（`--no-cache`）+ ウォームアップリクエスト自動実行

**平均値**（**全クエリの平均**）:
- 検索時間: **6005.20ms**（目標: 2000ms以下、超過: 4005.20ms）⚠️ **目標の約3倍**
- AI生成時間: **31546.60ms**（目標: 15000ms以下、超過: 16546.60ms）⚠️ **目標の約2.1倍**
- 初回チャンク時間: **11696.40ms**（目標: 5000ms以下、超過: 6696.40ms）⚠️ **目標の約2.3倍**
- 総処理時間: **37552.00ms**（目標: 20000ms以下、超過: 17552.00ms）⚠️ **目標の約1.9倍**

**最大値**:
- 最大検索時間: **29269ms**（約29秒）⚠️
- 最大AI生成時間: **140294ms**（約140秒）⚠️
- 最大総処理時間: **140442ms**（約140秒）⚠️

---

## 🔍 詳細分析

### クエリ別の結果

| クエリ | 検索時間 | AI生成時間 | 総処理時間 | 評価 |
|--------|---------|-----------|-----------|------|
| 1. 学年自動更新バッチの実行日時はいつですか？ | 241ms | 180ms | 422ms | ✅ **優秀** |
| 2. 教室管理の詳細は | 148ms | **140294ms**（約140秒） | 140442ms | ❌ **異常** |
| 3. 会員登録機能について | 165ms | 179ms | 344ms | ✅ **優秀** |
| 4. 求人削除機能の手順 | **29269ms**（約29秒） | 16900ms | 46169ms | ❌ **異常** |
| 5. 応募管理の一覧閲覧機能 | 203ms | 180ms | 383ms | ✅ **優秀** |

---

## 🎯 問題の特定

### 問題1: **異常に遅いクエリが含まれている** 🔴 **最重要**

**クエリ2（教室管理の詳細は）**:
- 検索時間: 148ms ✅
- **AI生成時間: 140294ms（約140秒）** ❌ **異常**
- 参照元数（フィルタリング前）: 12件
- 参照元数（フィルタリング後）: 8件
- 回答長: 3447文字

**クエリ4（求人削除機能の手順）**:
- **検索時間: 29269ms（約29秒）** ❌ **異常**
- AI生成時間: 16900ms（約17秒）
- 参照元数（フィルタリング前）: 15件
- 参照元数（フィルタリング後）: 2件
- 回答長: 2742文字

**他のクエリ（1, 3, 5）**:
- 検索時間: 165-241ms ✅ **目標値内**
- AI生成時間: 179-180ms ✅ **目標値内**
- 総処理時間: 344-422ms ✅ **目標値内**

**結論**: **一部のクエリで異常な遅延が発生しているが、他のクエリは正常**

---

### 問題2: **ウォームアップリクエストの実行時間が長い** 🟡 **中程度**

**ウォームアップリクエストの実行時間**:
- 初回: 1460ms ✅ **正常**
- 2回目: **44262ms（約44秒）** ❌ **異常に長い**
- 3回目: 306ms ✅ **正常**
- 4回目: 352ms ✅ **正常**
- 5回目: 370ms ✅ **正常**

**結論**: **2回目のウォームアップリクエストが異常に長い（約44秒）**

**原因候補**:
1. **Lunrインデックスの再読み込み**: キャッシュクリア後にLunrインデックスを再読み込みする必要がある
2. **サーバーのリソース競合**: 前のリクエストが完了していない状態で次のリクエストが実行される
3. **メモリ不足**: メモリが圧迫されている状態で処理が遅延

---

### 問題3: **平均値が異常値に引きずられている** 🟡 **中程度**

**平均値の計算方法の問題**:
- 5クエリの平均値を計算
- 異常に遅いクエリ（クエリ2、クエリ4）が平均値を押し上げている
- 正常なクエリ（クエリ1, 3, 5）は目標値内

**正常なクエリの平均値（クエリ1, 3, 5のみ）**:
- 検索時間: **203ms**（目標: 2000ms以下）✅ **目標の約9.9倍高速**
- AI生成時間: **180ms**（目標: 15000ms以下）✅ **目標の約83.3倍高速**
- 初回チャンク時間: **203ms**（目標: 5000ms以下）✅ **目標の約24.6倍高速**
- 総処理時間: **383ms**（目標: 20000ms以下）✅ **目標の約52.2倍高速**

**結論**: **正常なクエリは非常に高速で、異常値が平均値を歪めている**

---

## 🔍 ドキュメントとの差分分析

### 目標値との比較

| 項目 | 目標値（ドキュメント） | 現在の平均値 | 正常クエリの平均値 | 差分 |
|------|---------------------|------------|------------------|------|
| **検索時間** | 2000ms以下 | 6005.20ms | **203ms** | 異常値に引きずられる |
| **AI生成時間** | 15000ms以下 | 31546.60ms | **180ms** | 異常値に引きずられる |
| **初回チャンク時間** | 5000ms以下 | 11696.40ms | **203ms** | 異常値に引きずられる |
| **総処理時間** | 20000ms以下 | 37552.00ms | **383ms** | 異常値に引きずられる |

**結論**: **正常なクエリは目標値を大幅に下回っており、ドキュメントと一致**

---

### 過去のテスト結果との比較

**過去のテスト結果**（キャッシュ無効モード、コールドスタート）:
- 検索時間: 72.7秒（クエリ1）、34.4秒（クエリ2）
- AI生成時間: 7.2秒（クエリ1）、22.1秒（クエリ2）

**現在のテスト結果**（ウォームアップリクエスト自動実行）:
- 正常クエリの平均検索時間: **203ms** ✅ **大幅改善**（72.7秒 → 0.2秒）
- 正常クエリの平均AI生成時間: **180ms** ✅ **大幅改善**（7.2秒 → 0.2秒）

**結論**: **ウォームアップリクエストの自動実行により、正常なクエリは大幅に改善されている**

---

## 🎯 異常値の原因分析

### クエリ2のAI生成時間が140秒の原因

**可能性**:
1. **Gemini APIのレート制限**: 大量のリクエストが短時間に送信され、レート制限に達した
2. **Gemini APIのタイムアウト/リトライ**: API呼び出しがタイムアウトし、リトライが発生した
3. **ネットワークレイテンシ**: ネットワークの遅延が発生した
4. **サーバーのリソース競合**: 前のリクエストが完了していない状態で処理が競合した
5. **プロンプトサイズの違い**: 参照元数が12件と多く、プロンプトが大きい可能性がある

**参照元数の違い**:
- クエリ2: フィルタリング後 8件（多い）
- クエリ1, 3, 5: フィルタリング後 1-10件（標準的）

**結論**: **参照元数が多いクエリでAI生成時間が長くなる可能性があるが、140秒は異常**

---

### クエリ4の検索時間が29秒の原因

**可能性**:
1. **Lunrインデックスの再読み込み**: キャッシュクリア後にLunrインデックスを再読み込みする必要がある
2. **サーバーのリソース競合**: 前のリクエスト（クエリ3）が完了していない状態で処理が競合した
3. **メモリ不足**: メモリが圧迫されている状態で処理が遅延
4. **BM25検索のタイムアウト**: BM25検索がタイムアウトし、リトライが発生した

**ウォームアップリクエストの実行時間**:
- クエリ4の前のウォームアップ: 352ms ✅ **正常**
- クエリ4の検索時間: 29269ms ❌ **異常**

**結論**: **ウォームアップは正常に完了しているが、検索処理が異常に遅い**

---

## 📝 ドキュメントとコードの差分

### ドキュメントに記載されている目標値

**実装場所**: `docs/05-testing/05.04-performance-tests.md:92-96`

**目標値**:
- 検索時間: 2秒以下
- AI生成時間: 15秒以下
- 初回チャンク時間: 5秒以下（現実的には8-10秒）
- 総処理時間: 20秒以下

---

### 現在のコードの実装

**実装場所**: `src/tests/test-api-performance.ts:397-426`

**目標値の設定**:
```typescript
const searchTarget = 2000; // 2秒
const aiTarget = 15000; // 15秒
const totalTarget = 20000; // 20秒
const firstChunkTarget = 5000; // 5秒（TTFB）
```

**結論**: **コードとドキュメントの目標値は一致している**

---

### 過去のテスト結果との比較

**過去のテスト結果**（`docs/05-testing/05.04-performance-tests.md:187-191`）:
- 検索時間: 276.60ms（目標: 2000ms以下）✅
- AI生成時間: 17620.80ms（目標: 15000ms以下、超過: 2620.80ms）⚠️
- 初回チャンク時間: 17679.20ms（目標: 5000ms以下、超過: 12679.20ms）⚠️
- 総処理時間: 17907.60ms（目標: 20000ms以下）✅

**現在のテスト結果**（正常クエリの平均値）:
- 検索時間: **203ms**（目標: 2000ms以下）✅ **過去より改善**
- AI生成時間: **180ms**（目標: 15000ms以下）✅ **過去より大幅改善**
- 初回チャンク時間: **203ms**（目標: 5000ms以下）✅ **過去より大幅改善**
- 総処理時間: **383ms**（目標: 20000ms以下）✅ **過去より大幅改善**

**結論**: **正常なクエリは過去の結果よりも大幅に改善されている**

---

## ✅ 結論

### パフォーマンスデグレードの真実

1. **正常なクエリは大幅に改善されている** ✅
   - 検索時間: 203ms（過去: 276.60ms）✅
   - AI生成時間: 180ms（過去: 17620.80ms）✅ **大幅改善**
   - 初回チャンク時間: 203ms（過去: 17679.20ms）✅ **大幅改善**
   - 総処理時間: 383ms（過去: 17907.60ms）✅ **大幅改善**

2. **異常に遅いクエリが含まれている** ❌
   - クエリ2: AI生成時間 140秒（異常）
   - クエリ4: 検索時間 29秒（異常）
   - これらの異常値が平均値を押し上げている

3. **ウォームアップリクエストの効果** ✅
   - 正常なクエリは目標値を大幅に下回る
   - ウォームアップリクエストの自動実行により、コールドスタートが排除されている

---

### ドキュメントとの差分

**ドキュメントとの差分**: **なし** ✅

**理由**:
1. **目標値**: コードとドキュメントの目標値は一致している
2. **正常なクエリ**: 目標値を大幅に下回っている
3. **異常なクエリ**: 一時的な問題（レート制限、リソース競合など）の可能性が高い

---

### 推奨事項

1. ✅ **修正完了**: リクエスト間の待機時間を追加（2秒）
   - メモリ解放の時間を確保
   - リソース競合を回避
   - 前のリクエストが完全に終了するのを待つ

2. ✅ **修正完了**: ウォームアップリクエスト後の待機時間を延長（3秒 → 5秒）
   - 初期化の完了を確実にする
   - メモリ解放の時間を確保

3. **異常値の再調査**: クエリ2とクエリ4の異常な遅延の原因を特定する
4. **統計処理の改善**: 異常値を除外した統計値（中央値、パーセンタイル）を追加する
5. **レート制限対策**: Gemini APIのレート制限を考慮したリトライ機構を実装する
6. **メモリ監視**: リクエスト間のメモリ使用量を監視して、メモリリークを検出する

---

## 🔗 関連ドキュメント

- [パフォーマンステスト](./05.04-performance-tests.md)
- [コールドスタート発生原因の分析](./05.36-cold-start-analysis-2025-11-22.md)
- [過去のテスト実行方法の分析](./05.37-past-test-execution-method-analysis-2025-11-22.md)
- [コンテキスト件数削減パフォーマンステスト](./05.35-context-docs-reduction-test.md)
- [現在のパフォーマンス問題分析](../01-architecture/CURRENT_PERFORMANCE_ISSUES_2025-11-21.md)

