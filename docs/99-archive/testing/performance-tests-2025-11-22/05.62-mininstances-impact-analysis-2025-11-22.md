# minInstances削減の影響範囲分析 (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: `minInstances: 2` → `minInstances: 1`への削減による影響範囲を分析  
**ステータス**: 📋 **分析中**

---

## 📊 現状

### 現在の設定

- `minInstances: 2`（2つのインスタンスが常時起動）
- `maxInstances: 4`
- `memoryMiB: 8192`（8GB）
- `cpu: 2`
- `concurrency: 1`（1インスタンスで1リクエスト処理）

---

## 📜 過去の変更経緯

### minInstancesを2に増やした理由（2025-10-20）

**変更内容**:
- `minInstances: 1` → `minInstances: 2`（2倍に増加）
- 変更時期: 2025年10月20日（緊急対応）

**変更理由**:
1. **コールドスタート完全回避** 🔴 **最重要**
   - 本番環境で検索時間が105.9秒と異常に遅い問題が発生
   - コールドスタート（Embedding モデル）による17秒の遅延を削減
   - `minInstances: 2`により、常に2つのインスタンスが起動し、コールドスタートを完全に回避
   - **効果: -17秒削減**

2. **冗長性の向上** 🟡 **重要**
   - 1つのインスタンスがクラッシュしても、もう1つが処理を継続
   - サービス可用性の向上

**参考ドキュメント**:
- [緊急デプロイ手順 (2025-10-20)](../04-operations/04.09-emergency-deployment-20251020.md)
- [本番環境パフォーマンス緊急対応](../99-archive/operations/emergency-reports/production-performance-emergency-2025-10-20.md)

**変更前の問題**:
- 検索時間: 105.9秒（目標: 10秒以内）
- コールドスタート: 17秒の遅延
- 総処理時間: 117.2秒

**変更後の効果**:
- 検索時間: 46.9秒（-59秒改善）
- コールドスタート: 0秒（完全回避）
- 総処理時間: 58.2秒（-59秒改善）

---

## 🔍 影響範囲の分析

### 1. メモリ使用量への影響 🔴 **主要な改善効果**

#### 現状

- 2インスタンス × 約12GB（LanceDBメモリマップドファイル） = 約24GB
- 各インスタンスが独立してメモリマップドファイルを読み込む

#### 削減後の影響

- 1インスタンス × 約12GB = 約12GB
- **メモリ使用量: 約50%削減**

#### 評価

- ✅ **メモリ制限エラーの解消に有効**
- ✅ **コスト削減にも有効**

---

### 2. Cold Startへの影響 ⚠️ **リスク**

#### 現状

- `minInstances: 2`により、常に2つのインスタンスが起動
- Cold Startが発生しない（既に起動済み）

#### 削減後の影響

- `minInstances: 1`により、1つのインスタンスのみが常時起動
- トラフィックが増加した場合、2つ目のインスタンスが起動する必要がある
- **2つ目のインスタンスの起動時にCold Startが発生する可能性**

#### 評価

- ⚠️ **Cold Startのリスクがある**
- ⚠️ **起動時初期化により影響を最小化できるが、完全には回避できない**

---

### 3. 可用性への影響 ⚠️ **リスク**

#### 現状

- 2つのインスタンスが常時起動
- 1つのインスタンスがクラッシュしても、もう1つが処理を継続
- **冗長性が確保されている**

#### 削減後の影響

- 1つのインスタンスのみが常時起動
- インスタンスがクラッシュした場合、新しいインスタンスの起動が必要
- **冗長性が低下する**

#### 評価

- ⚠️ **可用性が低下する可能性がある**
- ⚠️ **インスタンスのクラッシュ時にサービス停止のリスクがある**

---

### 4. パフォーマンスへの影響 🟡 **中程度**

#### 現状

- 2つのインスタンスで負荷分散
- 1インスタンスあたりの負荷が軽い

#### 削減後の影響

- 1つのインスタンスで処理
- トラフィックが増加した場合、2つ目のインスタンスが起動するまで待機が必要
- **初回リクエストのレイテンシが増加する可能性**

#### 評価

- 🟡 **通常時は影響なし**
- ⚠️ **トラフィック増加時にレイテンシが増加する可能性**

---

### 5. コストへの影響 ✅ **改善効果**

#### 現状

- 2インスタンス × 8GB × 2CPU = 常時起動コスト

#### 削減後の影響

- 1インスタンス × 8GB × 2CPU = 約50%削減
- **コスト: 約50%削減**

#### 評価

- ✅ **コスト削減に有効**

---

## 📋 分析結果まとめ

| 項目 | 影響 | 評価 | 対策 |
|------|------|------|------|
| **メモリ使用量** | 約50%削減 | ✅ **改善** | メモリ制限エラーの解消に有効 |
| **Cold Start** | 発生する可能性 | ⚠️ **リスク** | 起動時初期化により影響を最小化 |
| **可用性** | 低下する可能性 | ⚠️ **リスク** | インスタンスのクラッシュ時にサービス停止のリスク |
| **パフォーマンス** | 通常時は影響なし | 🟡 **中程度** | トラフィック増加時にレイテンシが増加する可能性 |
| **コスト** | 約50%削減 | ✅ **改善** | コスト削減に有効 |

---

## 🎯 推奨事項

### 推奨: **段階的なアプローチ**

#### Phase 1: 影響範囲の詳細分析

1. **現在のトラフィックパターンを分析**
   - 同時リクエスト数
   - ピーク時のトラフィック
   - インスタンスの使用率

2. **Cold Startの影響を測定**
   - 2つ目のインスタンス起動時間
   - 起動時初期化の完了時間
   - 初回リクエストのレイテンシ

3. **可用性への影響を評価**
   - インスタンスのクラッシュ頻度
   - クラッシュ時の復旧時間
   - サービス停止のリスク

#### Phase 2: 段階的な削減

1. **監視を強化**
   - メモリ使用量の監視
   - Cold Startの監視
   - 可用性の監視

2. **段階的な削減**
   - まずは`minInstances: 2` → `minInstances: 1.5`（不可能な場合は1に）
   - 監視しながら段階的に削減

3. **ロールバック計画**
   - 問題が発生した場合のロールバック手順を準備

---

## 🔗 関連ドキュメント

- [メモリ最適化計画](./05.60-memory-optimization-plan-2025-11-22.md)
- [メモリ使用量分析レポート](../01-architecture/MEMORY_USAGE_ANALYSIS_2025-11-21.md)

