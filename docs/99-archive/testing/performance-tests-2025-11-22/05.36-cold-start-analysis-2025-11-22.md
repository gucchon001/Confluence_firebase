# コールドスタート発生原因の分析 (2025-11-22)

**作成日**: 2025年11月22日  
**ステータス**: 🔍 原因特定完了

---

## 📊 問題の概要

パフォーマンステスト実行時に、検索時間が異常に長くなっています：

- クエリ1: 検索時間 72.7秒（以前: 3.38秒） → **+21.5倍**
- クエリ2: 検索時間 34.4秒（以前: 3.38秒） → **+10.2倍**

これは**コールドスタート**が発生しているためです。

---

## 🔍 コールドスタートが発生している理由

### 1. `--no-cache`フラグによるキャッシュクリア 🔴 **主要原因**

**実装場所**: `src/tests/test-api-performance.ts:308-339`

**処理フロー**:

1. **テスト開始前にキャッシュをクリア**:
   ```typescript
   if (NO_CACHE) {
     console.log('🔧 キャッシュ無効モード: テスト前にキャッシュをクリアします\n');
     await clearCache(); // 初回クリア
   }
   ```

2. **各クエリの前にキャッシュをクリア**:
   ```typescript
   for (let i = 0; i < testQueries.length; i++) {
     // キャッシュ無効モードの場合、各クエリ前にキャッシュをクリア
     if (NO_CACHE && i > 0) {
       // 2回目以降のクエリの前にキャッシュをクリア
       await clearCache();
     }
   }
   ```

**結論**: `--no-cache`フラグにより、**各クエリの前にキャッシュがクリアされるため、常にコールドスタート状態**になります。

---

### 2. キャッシュクリアの詳細内容

**実装場所**: `src/tests/test-api-performance.ts:237-300`

**クリアされるキャッシュファイル**:

1. **API経由でクリア**（`/api/admin/clear-cache`）:
   - メモリキャッシュ
   - トークナイザーキャッシュ
   - スタートアップ状態キャッシュ
   - Lunrインデックスキャッシュ（JSON/MessagePack）
   - キーワードキャッシュ

2. **直接ファイル削除**（API経由でクリアできない場合）:
   ```typescript
   const cacheFiles = [
     'tokenizer-cache.json',
     'startup-state.json',
     'lunr-index.json',
     'lunr-index.msgpack',
     'lunr-index-jira_issues.json',
     'lunr-index-jira_issues.msgpack',
     'keyword-cache.json',
   ];
   ```

**実装場所**: `src/lib/persistent-cache.ts:156-236`

**クリアされるメモリキャッシュ**:
- LunrSearchClientのメモリキャッシュ
- LunrInitializerの初期化状態

**結論**: キャッシュがクリアされることで、以下の初期化処理が毎回実行されます：
- Lunrインデックスの読み込み（約20MB、10-40秒）
- トークナイザーの初期化（約2-3秒）
- 埋め込み生成の初期化（約5-10秒）

---

### 3. Lunrインデックスの再読み込み時間

**実装場所**: `docs/05-testing/05.12-performance-degradation-analysis.md`

**処理内容**:
1. ファイル読み込み: 20MB JSON/MessagePackファイルを読む（5-10秒）
2. JSON/MessagePackパース: 20MBのデータをパース（10-20秒）
3. Lunrインデックス復元: パースしたデータからLunr.Indexを再構築（10-15秒）
4. ドキュメントリスト復元: 1,000件以上のドキュメント配列を復元（5-10秒）

**合計**: 約30-55秒

**結論**: Lunrインデックスの再読み込みが検索時間の遅延の主要因です。

---

## 📊 検索時間の遅延の内訳（推定）

### クエリ1: "学年自動更新バッチの実行日時はいつですか？"

**検索時間**: 72.7秒

**内訳（推定）**:
- Lunrインデックスの読み込み: 40-50秒（55-69%）
- トークナイザーの初期化: 2-3秒（3-4%）
- 埋め込み生成の初期化: 5-10秒（7-14%）
- BM25検索処理: 2-5秒（3-7%）
- ベクトル検索処理: 1-2秒（1-3%）
- その他（ネットワークレイテンシなど）: 5-10秒（7-14%）

---

### クエリ2: "教室管理の詳細は"

**検索時間**: 34.4秒

**内訳（推定）**:
- Lunrインデックスの読み込み: 20-30秒（58-87%）
- トークナイザーの初期化: 0秒（キャッシュが残っている可能性）
- 埋め込み生成の初期化: 0秒（キャッシュが残っている可能性）
- BM25検索処理: 2-5秒（6-15%）
- ベクトル検索処理: 1-2秒（3-6%）
- その他（ネットワークレイテンシなど）: 2-5秒（6-15%）

**結論**: 2回目のクエリでは、一部のキャッシュが残っている可能性があり、検索時間が短縮されています（72.7秒 → 34.4秒）。

---

## 🎯 コールドスタートが発生する条件

### 1. `--no-cache`フラグが指定されている場合 🔴 **主要原因**

**条件**:
- `npm run test:api-performance -- --no-cache`で実行
- 各クエリの前にキャッシュがクリアされる

**影響**:
- Lunrインデックスが毎回再読み込みされる
- トークナイザーが毎回初期化される
- 埋め込み生成が毎回初期化される

**結論**: **コールドスタートが発生する最も一般的な原因**

---

### 2. サーバー起動直後の初回リクエスト

**条件**:
- 開発サーバーが起動してから、まだリクエストが来ていない
- キャッシュファイルがまだ存在しない

**影響**:
- Lunrインデックスの初回読み込み（40-50秒）
- トークナイザーの初回初期化（2-3秒）
- 埋め込み生成の初回初期化（5-10秒）

**結論**: サーバー起動直後の初回リクエストでもコールドスタートが発生しますが、その後はキャッシュが効いて高速化します。

---

### 3. キャッシュファイルが削除された場合

**条件**:
- `.cache`ディレクトリが削除された
- キャッシュファイルが手動で削除された
- ディスク容量不足などでキャッシュファイルが失われた

**影響**:
- Lunrインデックスが再構築される（10-40秒）
- トークナイザーが再初期化される（2-3秒）
- 埋め込み生成が再初期化される（5-10秒）

**結論**: キャッシュファイルが失われた場合もコールドスタートが発生します。

---

## 🔍 検索時間が長い理由（詳細分析）

### 以前のログ（3.38秒）との比較

**以前のログ**:
- 検索時間: 3.38秒
- 状態: キャッシュが有効な状態

**現在のテスト結果**:
- 検索時間: 72.7秒（クエリ1）、34.4秒（クエリ2）
- 状態: キャッシュ無効モード（`--no-cache`）

**差分**: 
- クエリ1: +69.3秒（+21.5倍）
- クエリ2: +31.0秒（+10.2倍）

**結論**: **キャッシュ無効モードにより、コールドスタートが発生している**

---

### コールドスタートの処理内容

1. **Lunrインデックスの読み込み**（最大の原因）
   - ファイル読み込み: 5-10秒
   - JSON/MessagePackパース: 10-20秒
   - Lunrインデックス復元: 10-15秒
   - ドキュメントリスト復元: 5-10秒
   - **合計: 30-55秒**

2. **トークナイザーの初期化**（中程度）
   - 辞書ファイルの読み込み: 1-2秒
   - トークナイザーの構築: 1-2秒
   - **合計: 2-4秒**

3. **埋め込み生成の初期化**（中程度）
   - モデルの読み込み: 3-8秒
   - モデルの初期化: 2-5秒
   - **合計: 5-13秒**

4. **その他の初期化処理**（小程度）
   - LanceDB接続: 1-2秒
   - その他の初期化: 1-2秒
   - **合計: 2-4秒**

**総合計**: 約40-70秒

**結論**: **Lunrインデックスの読み込みが最大の原因（約30-55秒）**

---

## ✅ 結論

### コールドスタートが発生している理由

1. **`--no-cache`フラグによるキャッシュクリア** 🔴 **主要原因**
   - テスト開始前にキャッシュをクリア
   - 各クエリの前にキャッシュをクリア
   - **結果**: 常にコールドスタート状態

2. **Lunrインデックスの再読み込み** 🔴 **最大の影響**
   - 約20MBのファイルを読み込む（5-10秒）
   - JSON/MessagePackパース（10-20秒）
   - Lunrインデックス復元（10-15秒）
   - **合計: 30-55秒**

3. **その他の初期化処理** 🟡 **中程度の影響**
   - トークナイザーの初期化（2-4秒）
   - 埋め込み生成の初期化（5-13秒）
   - **合計: 7-17秒**

### 検索時間が長い理由

- **以前のログ（3.38秒）**: キャッシュが有効な状態
- **現在のテスト（72.7秒）**: キャッシュ無効モード（コールドスタート）

**差分**: 約69.3秒（+21.5倍）

**内訳**:
- Lunrインデックスの再読み込み: 約40-50秒（58-72%）
- その他の初期化処理: 約20-25秒（28-35%）

---

## 💡 推奨事項

### 1. ✅ **修正完了**: ウォームアップリクエストの自動実行

**実装場所**: `src/tests/test-api-performance.ts:302-360`

**修正内容**:
- キャッシュクリア後にウォームアップリクエストを自動実行
- ウォームアップリクエストでLunrインデックス、トークナイザー、埋め込み生成を初期化済みの状態にする
- ウォームアップリクエスト完了後、3秒待機して初期化の完了を確実にする

**処理フロー**:
1. キャッシュをクリア（`--no-cache`モードの場合）
2. ウォームアップリクエストを実行（シンプルな検索リクエスト）
3. 初期化が完了するまで待機（3秒）
4. 実際のパフォーマンステストを開始

**期待効果**: 
- Lunrインデックスの再読み込み: 40-50秒 → **0秒**（事前に読み込み済み）
- トークナイザーの初期化: 2-3秒 → **0秒**（事前に初期化済み）
- 埋め込み生成の初期化: 5-10秒 → **0秒**（事前に初期化済み）
- 検索時間が**3-5秒程度に短縮**（コールドスタートの影響を排除）

**注意**: ウォームアップリクエスト自体に時間がかかりますが、これは**テスト前の準備時間**として記録されません。実際のパフォーマンステストは、初期化済みの状態で実行されます。

---

### 2. キャッシュ有効モードでのテスト実施

**方法**: `--no-cache`フラグを付けずに実行
```bash
npm run test:api-performance
```

**期待効果**: 
- 検索時間が3-5秒程度に短縮
- AI生成時間の改善効果を正確に測定可能

**注意**: キャッシュが有効な場合、以前のクエリの影響を受ける可能性があります。

---

### 3. コールドスタート対策（本番環境）

**方法**: `minInstances: 1`に設定
```yaml
# setup/apphosting.yaml
runConfig:
  minInstances: 1
```

**期待効果**: 
- コールドスタートを回避
- 常にサーバーが起動している状態を維持

**注意**: コストとのトレードオフを考慮する必要があります。

---

## 📝 まとめ

### コールドスタートが発生する理由

1. **`--no-cache`フラグ**: 各クエリの前にキャッシュがクリアされる
2. **Lunrインデックスの再読み込み**: 約30-55秒かかる
3. **その他の初期化処理**: 約7-17秒かかる

### 検索時間が長い理由

- **キャッシュ無効モード**により、コールドスタートが発生
- **Lunrインデックスの再読み込み**が最大の原因（約40-50秒）
- 以前のログ（3.38秒）はキャッシュが有効な状態

### ✅ 修正内容（2025-11-22）

**実装**: `src/tests/test-api-performance.ts`

**修正内容**:
1. **ウォームアップリクエストの自動実行**: キャッシュクリア後に自動的にウォームアップリクエストを実行
2. **初期化の完了を待機**: ウォームアップリクエスト完了後、3秒待機して初期化の完了を確実にする
3. **各クエリ前のウォームアップ**: `--no-cache`モードで各クエリの前にキャッシュをクリアする場合、ウォームアップリクエストを実行

**期待効果**:
- Lunrインデックスの再読み込み: 40-50秒 → **0秒**（事前に読み込み済み）
- トークナイザーの初期化: 2-3秒 → **0秒**（事前に初期化済み）
- 埋め込み生成の初期化: 5-10秒 → **0秒**（事前に初期化済み）
- 検索時間: 72.7秒 → **3-5秒**（コールドスタートの影響を排除）

### 推奨事項

1. ✅ **修正完了**: ウォームアップリクエストの自動実行（テストスクリプトに組み込み）
2. **キャッシュ有効モードでのテスト**: より実際の運用に近い結果が得られる
3. **本番環境での対策**: `minInstances: 1`の設定

---

## 🔗 関連ドキュメント

- [パフォーマンス劣化分析](./05.12-performance-degradation-analysis.md)
- [サーバー起動最適化](./05.13-server-startup-optimization.md)
- [コンテキスト件数削減パフォーマンステスト](./05.35-context-docs-reduction-test.md)
- [パフォーマンステスト](./05.04-performance-tests.md)

