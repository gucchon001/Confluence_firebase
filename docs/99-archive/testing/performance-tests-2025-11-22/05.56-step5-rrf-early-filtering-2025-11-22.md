# ステップ5: RRF融合処理の早期絞り込み (2025-11-22)

**作成日**: 2025年11月22日  
**目的**: RRF融合処理の早期絞り込みでパフォーマンスを改善  
**ステータス**: 📋 **実装前**

---

## 📋 改善内容

### 変更内容

- **RRF計算対象**: 全件 → 上位150件 → 上位100件に段階的削減

### 実装場所

`src/lib/lancedb-search-client.ts` (747行目付近)

```typescript
// 変更前
const rrfProcessedResults = unifiedSearchResultProcessor.processSearchResults(resultsWithHybridScore, {...});

// 変更後（段階的削減）
const RRF_CANDIDATE_LIMIT = 150;
const topCandidatesForRRF = resultsWithHybridScore.slice(0, RRF_CANDIDATE_LIMIT);
const remainingCandidates = resultsWithHybridScore.slice(RRF_CANDIDATE_LIMIT);

const rrfProcessedResults = unifiedSearchResultProcessor.processSearchResults(topCandidatesForRRF, {...});

// 残りの候補には簡易RRFスコアを設定
const remainingWithSimpleRRF = remainingCandidates.map(r => ({
  ...r,
  _rrfScore: (r._hybridScore ?? r._distance ?? 1.0) * 0.1
}));

resultsWithHybridScore = [...rrfProcessedResults, ...remainingWithSimpleRRF];
```

---

## 📊 期待効果

- **削減時間**: 約75-125ms（25%削減）
- **品質への影響**: 中程度（RRF計算前に結果を絞り込むことで、関連性の高いページが除外される可能性）

---

## ⚠️ 注意点

- 品質への影響が中程度のため、品質テストで合格基準を満たすことを必ず確認
- 不合格の場合は、パラメータを調整（例: 150件 → 200件）する必要がある

---

## ✅ 実装後の検証

### 1. 品質テスト

```bash
npm run test:search-quality -- --all
```

**合格基準**: 両方のテストクエリで対象ページが10位以内に含まれること

### 2. パフォーマンステスト

検索時間が改善されているか確認

---

## 📝 テスト結果

### 品質テスト結果

#### テストクエリ1
- ✅ **合格**: 対象ページが4位に含まれている（ベースライン6位から改善！）
- **対象ページ**: `045_【FIX】パスワード再設定機能`
- **順位**: 4位（ベースライン: 6位）
- **合格基準**: 10位以内 ✅

#### テストクエリ2
- ✅ **合格**: 対象ページが4位に含まれている（ベースライン6位から改善！）
- **対象ページ**: `014_【FIX】求人応募機能`
- **順位**: 4位（ベースライン: 6位）
- **合格基準**: 10位以内 ✅

### パフォーマンステスト結果

#### テストクエリ1
- **検索時間**: 2424ms (約2.4秒)
- **ステップ4後**: 12830ms (約12.8秒)
- **変化**: -10406ms (約10.4秒削減) ✅

#### テストクエリ2
- **検索時間**: 581ms (約0.6秒)
- **ステップ4後**: 1633ms (約1.6秒)
- **変化**: -1052ms (約1.1秒削減) ✅

### 分析

- **品質への影響**: 改善（両方のクエリで順位が6位→4位に向上）
- **パフォーマンス**: 大幅改善（クエリ1で約10.4秒削減、クエリ2で約1.1秒削減）
- **結論**: 品質を向上させながらパフォーマンスも大幅に改善 ✅

### 次のステップ

100件に削減しても品質テストは合格（両方のクエリで対象ページが4位を維持）

---

## 📊 100件削減後のテスト結果

### 品質テスト結果（100件）

#### テストクエリ1
- ✅ **合格**: 対象ページが4位に含まれている（150件時と同じ）
- **対象ページ**: `045_【FIX】パスワード再設定機能`
- **順位**: 4位（150件時: 4位、ベースライン: 6位）
- **合格基準**: 10位以内 ✅

#### テストクエリ2
- ✅ **合格**: 対象ページが4位に含まれている（150件時と同じ）
- **対象ページ**: `014_【FIX】求人応募機能`
- **順位**: 4位（150件時: 4位、ベースライン: 6位）
- **合格基準**: 10位以内 ✅

### パフォーマンステスト結果（100件）

#### テストクエリ1
- **検索時間**: 7806ms (約7.8秒)
- **150件時**: 2424ms (約2.4秒)
- **変化**: +5382ms（遅延が発生）
- **注意**: 初回実行のため、Lunr初期化時間が含まれている可能性

#### テストクエリ2
- **検索時間**: 2645ms (約2.6秒)
- **150件時**: 581ms (約0.6秒)
- **変化**: +2064ms（遅延が発生）
- **注意**: 初回実行のため、Lunr初期化時間が含まれている可能性

### 分析

- **品質への影響**: なし（両方のクエリで対象ページが4位を維持）
- **パフォーマンス**: 初回実行のため、Lunr初期化時間が含まれており、正確な比較が困難
- **結論**: 100件に削減しても品質は維持される ✅

### 推奨

- **100件を採用**: 品質を維持しながら、RRF計算対象を削減できる
- **さらなる削減は慎重に**: 100件以下に削減する場合は、再度品質テストを実施する必要がある

---

## 📊 75件削減後のテスト結果

### 品質テスト結果（75件）

#### テストクエリ1
- ✅ **合格**: 対象ページが4位に含まれている（100件時と同じ）
- **対象ページ**: `045_【FIX】パスワード再設定機能`
- **順位**: 4位（100件時: 4位、150件時: 4位、ベースライン: 6位）
- **合格基準**: 10位以内 ✅

#### テストクエリ2
- ✅ **合格**: 対象ページが4位に含まれている（100件時と同じ）
- **対象ページ**: `014_【FIX】求人応募機能`
- **順位**: 4位（100件時: 4位、150件時: 4位、ベースライン: 6位）
- **合格基準**: 10位以内 ✅

### パフォーマンステスト結果（75件）

#### テストクエリ1
- **検索時間**: 4737ms (約4.7秒)
- **100件時**: 7806ms (約7.8秒)
- **変化**: -3069ms（改善）
- **注意**: 初回実行のため、Lunr初期化時間が含まれている可能性

#### テストクエリ2
- **検索時間**: 1530ms (約1.5秒)
- **100件時**: 2645ms (約2.6秒)
- **変化**: -1115ms（改善）
- **注意**: 初回実行のため、Lunr初期化時間が含まれている可能性

### 分析

- **品質への影響**: なし（両方のクエリで対象ページが4位を維持）
- **パフォーマンス**: 改善（クエリ1で約3秒削減、クエリ2で約1.1秒削減）
- **結論**: 75件に削減しても品質は維持され、パフォーマンスも改善 ✅

### 推奨

- **75件を採用**: 品質を維持しながら、RRF計算対象をさらに削減でき、パフォーマンスも改善
- **さらなる削減は慎重に**: 75件以下に削減する場合は、再度品質テストを実施する必要がある

---

## 📊 50件削減後のテスト結果

### 品質テスト結果（50件）

#### テストクエリ1
- ✅ **合格**: 対象ページが5位に含まれている（75件時: 4位から1位下降）
- **対象ページ**: `045_【FIX】パスワード再設定機能`
- **順位**: 5位（75件時: 4位、100件時: 4位、150件時: 4位、ベースライン: 6位）
- **合格基準**: 10位以内 ✅

#### テストクエリ2
- ✅ **合格**: 対象ページが5位に含まれている（75件時: 4位から1位下降）
- **対象ページ**: `014_【FIX】求人応募機能`
- **順位**: 5位（75件時: 4位、100件時: 4位、150件時: 4位、ベースライン: 6位）
- **合格基準**: 10位以内 ✅

### パフォーマンステスト結果（50件）

#### テストクエリ1
- **検索時間**: 10406ms (約10.4秒)
- **75件時**: 4737ms (約4.7秒)
- **変化**: +5669ms（遅延が発生）
- **注意**: 初回実行のため、Lunr初期化時間とBM25検索の遅延（6647ms）が含まれている

#### テストクエリ2
- **検索時間**: 1159ms (約1.2秒)
- **75件時**: 1530ms (約1.5秒)
- **変化**: -371ms（改善）
- **注意**: 2回目の実行のため、Lunr初期化時間が含まれていない

### 分析

- **品質への影響**: 軽微（両方のクエリで対象ページが4位→5位に1位下降、ただし合格基準は満たしている）
- **パフォーマンス**: クエリ1で遅延が発生（初回実行のため、Lunr初期化時間とBM25検索の遅延が含まれている）、クエリ2で改善
- **結論**: 50件に削減しても品質テストは合格するが、順位が1位下降しているため、75件の方が品質面で優れている

### 推奨

- **75件を採用**: 50件に削減すると順位が1位下降するため、品質とパフォーマンスのバランスを考慮すると75件が最適
- **50件も選択肢**: 合格基準は満たしているため、パフォーマンスを優先する場合は50件も選択肢
- **さらなる削減は非推奨**: 50件以下に削減すると、品質がさらに低下する可能性が高い

---

## 🔗 関連ドキュメント

- [ステップ4: Composite Scoringの結果数削減](./05.55-step4-composite-scoring-reduction-2025-11-22.md)
- [ベースライン品質テスト](./05.51-baseline-quality-test-2025-11-22.md)
- [クエリ3 パフォーマンス改善計画](./05.48-query3-performance-improvement-plan-2025-11-22.md)

