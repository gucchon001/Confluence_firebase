# pageId ã¨ page_id ã®å½¹å‰²ã¨å‡¦ç†ã®æ¤œè¨¼ (2025-11-22)

**ä½œæˆæ—¥**: 2025å¹´11æœˆ22æ—¥  
**ç›®çš„**: `pageId`ã¨`page_id`ã®å½¹å‰²ã¨å‡¦ç†ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **æ¤œè¨¼å®Œäº†ãƒ»ä¿®æ­£å®Œäº†**

---

## ğŸ“‹ å½¹å‰²ã®å®šç¾©

### `page_id`ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ï¼‰

- **ç”¨é€”**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆLanceDBï¼‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
- **å‹**: `number`ï¼ˆint64ï¼‰
- **ä½¿ç”¨ç®‡æ‰€**:
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªï¼ˆ`.where(\`page_id\` = ...)`ï¼‰
  - ã‚¹ã‚«ãƒ©ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé«˜é€Ÿã‚¯ã‚¨ãƒªç”¨ï¼‰
- **å½¹å‰²**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã§ã®ä¸€æ„ã®ãƒšãƒ¼ã‚¸IDã‚’ä¿æŒ

### `pageId`ï¼ˆAPIç”¨ï¼‰

- **ç”¨é€”**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
- **å‹**: `number`
- **ä½¿ç”¨ç®‡æ‰€**:
  - APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®å‡¦ç†
- **å½¹å‰²**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”ã™ãƒšãƒ¼ã‚¸ID

---

## ğŸ”„ å¤‰æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼

### `mapLanceDBRecordToAPI`ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ â†’ APIï¼‰

**å½¹å‰²**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«å¤‰æ›

**å‡¦ç†**:
1. `page_id` â†’ `pageId`ã«å¤‰æ›
2. `page_id`ã‚‚æ®‹ã™ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ï¼‰
3. `spaceKey` â†’ `space_key`ã«å¤‰æ›
4. BOMæ–‡å­—ã‚’é™¤å»

**å®Ÿè£…å ´æ‰€**: `src/lib/pageid-migration-helper.ts`

```typescript
export function mapLanceDBRecordToAPI(record: any): any {
  if (record.page_id !== undefined) {
    const numericPageId = Number(record.page_id);
    return {
      ...rest,
      pageId: Number.isFinite(numericPageId) ? numericPageId : page_id,  // page_idã‚’pageIdã«å¤‰æ›
      page_id: Number.isFinite(numericPageId) ? numericPageId : page_id, // page_idã‚‚æ®‹ã™ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ï¼‰
      space_key: record.space_key ?? spaceKey ?? ''
    };
  }
  // ...
}
```

### `getPageIdFromRecord`ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰page_idå–å¾—ï¼‰

**å½¹å‰²**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰`page_id`ã‚’å–å¾—ï¼ˆå”¯ä¸€ã®ä¿¡é ¼ã§ãã‚‹æƒ…å ±æºï¼‰

**å‡¦ç†**:
- `page_id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãªã—ï¼‰
- `pageId`ã¯ä½¿ç”¨ã—ãªã„ï¼ˆAPIç”¨ã®ãŸã‚ï¼‰

**å®Ÿè£…å ´æ‰€**: `src/lib/pageid-migration-helper.ts`

```typescript
export function getPageIdFromRecord(record: any): number | string | undefined {
  // page_idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’ä½¿ç”¨ï¼ˆå”¯ä¸€ã®ä¿¡é ¼ã§ãã‚‹æƒ…å ±æºï¼‰
  if (record.page_id !== undefined) {
    const numericPageId = Number(record.page_id);
    return Number.isFinite(numericPageId) ? numericPageId : record.page_id;
  }
  // page_idãŒå­˜åœ¨ã—ãªã„å ´åˆã¯undefinedã‚’è¿”ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„ï¼‰
  return undefined;
}
```

---

## ğŸ” ç¾åœ¨ã®å®Ÿè£…ã®å•é¡Œç‚¹

### `unified-search-result-processor.ts`ã®`formatResults`ãƒ¡ã‚½ãƒƒãƒ‰

**å•é¡Œç‚¹**:
```typescript
const pageIdFromRecord = getPageIdFromRecord(result);
const rawPageId = pageIdFromRecord ?? result.pageId ?? result.page_id;  // âš ï¸ å•é¡Œ: result.pageIdã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
```

**å•é¡Œ**:
1. `getPageIdFromRecord`ã¯`page_id`ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã¹ãï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãªã—ï¼‰
2. `result.pageId`ã¯APIç”¨ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ã™ã‚‹éš›ã«ã¯ä½¿ç”¨ã™ã¹ãã§ã¯ãªã„
3. `result.page_id`ãŒå­˜åœ¨ã—ãªã„å ´åˆã€`result.pageId`ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯æ­£ã—ããªã„

**æ­£ã—ã„å‡¦ç†**:
- `getPageIdFromRecord(result)`ã§`page_id`ã‚’å–å¾—
- `page_id`ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯`undefined`ã‚’è¿”ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„ï¼‰
- `pageId`ã¯`mapLanceDBRecordToAPI`ã§å¤‰æ›ã•ã‚ŒãŸå¾Œã«è¨­å®šã•ã‚Œã‚‹

---

## âœ… æ­£ã—ã„å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—

```typescript
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒª
const results = await tbl.query()
  .where(`\`page_id\` = ${numericPageId}`)
  .toArray();

// çµæœ: { page_id: 123, title: "...", ... }
```

### 2. å¤‰æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼é©ç”¨

```typescript
// mapLanceDBRecordToAPIã§å¤‰æ›
const mappedResult = mapLanceDBRecordToAPI(results[0]);

// çµæœ: { page_id: 123, pageId: 123, title: "...", ... }
```

### 3. APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®å‡¦ç†

```typescript
// ProcessedSearchResultã«å¤‰æ›
const processed: ProcessedSearchResult = {
  pageId: mappedResult.pageId,  // APIç”¨
  page_id: mappedResult.page_id, // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ï¼‰
  // ...
};
```

---

## ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€

### `src/lib/unified-search-result-processor.ts`

**ç¾åœ¨ã®å®Ÿè£…**:
```typescript
const pageIdFromRecord = getPageIdFromRecord(result);
const rawPageId = pageIdFromRecord ?? result.pageId ?? result.page_id;  // âš ï¸ å•é¡Œ
```

**ä¿®æ­£å¾Œ**:
```typescript
// page_idã®ã¿ã‚’ä½¿ç”¨ï¼ˆgetPageIdFromRecordã¯page_idã®ã¿ã‚’è¿”ã™ï¼‰
const pageIdFromRecord = getPageIdFromRecord(result);
// pageIdã¯APIç”¨ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ã™ã‚‹éš›ã«ã¯ä½¿ç”¨ã—ãªã„
// page_idãŒå­˜åœ¨ã—ãªã„å ´åˆã¯undefinedã‚’è¿”ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„ï¼‰
const pageId: number | undefined = typeof pageIdFromRecord === 'number' 
  ? pageIdFromRecord 
  : (typeof pageIdFromRecord === 'string' ? (Number.isFinite(Number(pageIdFromRecord)) ? Number(pageIdFromRecord) : undefined) : undefined);
```

**ã¾ãŸã¯ã€ã‚ˆã‚Šç°¡æ½”ã«**:
```typescript
// getPageIdFromRecordã¯page_idã®ã¿ã‚’è¿”ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãªã—ï¼‰
const pageIdFromRecord = getPageIdFromRecord(result);
// pageIdã‚’numberå‹ã«å¤‰æ›
const pageId: number | undefined = typeof pageIdFromRecord === 'number' 
  ? pageIdFromRecord 
  : undefined;
```

---

## ğŸ“Š æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] `getPageIdFromRecord`ã¯`page_id`ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ âœ…
- [x] `mapLanceDBRecordToAPI`ã§`page_id`â†’`pageId`ã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹ã‹ âœ…
- [x] `unified-search-result-processor.ts`ã§`result.pageId`ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ âœ… **ä¿®æ­£å®Œäº†**
- [x] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã§ã¯`page_id`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ âœ…
- [x] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã¯`pageId`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ âœ…

---

## âœ… ä¿®æ­£å†…å®¹

### `src/lib/unified-search-result-processor.ts`ã®`formatResults`ãƒ¡ã‚½ãƒƒãƒ‰

**ä¿®æ­£å‰**:
```typescript
const pageIdFromRecord = getPageIdFromRecord(result);
const rawPageId = pageIdFromRecord ?? result.pageId ?? result.page_id;  // âš ï¸ å•é¡Œ: result.pageIdã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
```

**ä¿®æ­£å¾Œ**:
```typescript
// â˜…â˜…â˜… é‡è¦: getPageIdFromRecordã¯page_idã®ã¿ã‚’ä½¿ç”¨ï¼ˆå”¯ä¸€ã®ä¿¡é ¼ã§ãã‚‹æƒ…å ±æºï¼‰ â˜…â˜…â˜…
// pageIdã¯APIç”¨ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ã™ã‚‹éš›ã«ã¯ä½¿ç”¨ã—ãªã„
const pageIdFromRecord = getPageIdFromRecord(result);
// pageIdã‚’numberå‹ã«å¤‰æ›
const pageId: number | undefined = typeof pageIdFromRecord === 'number' 
  ? pageIdFromRecord 
  : (typeof pageIdFromRecord === 'string' ? (Number.isFinite(Number(pageIdFromRecord)) ? Number(pageIdFromRecord) : undefined) : undefined);
// page_idã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ã«ä¿æŒï¼‰
const page_id: number | undefined = typeof result.page_id === 'number' 
  ? result.page_id 
  : (typeof result.page_id === 'string' ? (Number.isFinite(Number(result.page_id)) ? Number(result.page_id) : undefined) : undefined);
```

**å¤‰æ›´ç‚¹**:
1. `result.pageId`ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨ã—ãªã„ã‚ˆã†ã«ä¿®æ­£
2. `getPageIdFromRecord`ã§å–å¾—ã—ãŸ`page_id`ã®ã¿ã‚’ä½¿ç”¨
3. `page_id`ã¨`pageId`ã®å½¹å‰²ã‚’æ˜ç¢ºã«åˆ†é›¢

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [pageId â†’ page_id ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ã‚µãƒãƒªãƒ¼](../99-archive/migration/migration-summary.md)
- [APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿åˆ†æ](../99-archive/migration/api-response-impact-analysis.md)
- [pageid-migration-helper.ts](../../src/lib/pageid-migration-helper.ts)

