# NotebookLM出力結果との詳細差異分析

**作成日**: 2025年11月4日  
**最終更新**: 2025年11月6日  
**統合元**: `notebooklm-output-comparison.md`  
**クエリ**: 「教室削除ができないのは何が原因ですか」

## 📊 検索結果の現状（最新: 2025-11-04T02:44:43）

### ✅ 検索ランキング（改善済み）

1. **164_【FIX】教室削除機能** (compositeScore: 1.6239) ✅ **1位**
   - page_id: 718373062
   - BM25: 0.5, Title: 0.2, Label: 0.064
   - StructuredLabel: feature="教室削除機能"
   
2. **514_【レビュー中】教室管理-求人削除機能** (compositeScore: 1.5126)
   
3. **505_【FIX】教室削除 機能** (compositeScore: 1.4900)
   
4. **155_【FIX】教室グループ削除機能** (compositeScore: 1.4863) ✅ **4位に降下**

### ✅ 検索品質の改善確認

- ✅ **ランキング**: 「164_【FIX】教室削除機能」が1位
- ✅ **BM25スコア**: 両方の結果に設定されている
- ✅ **タイトルマッチング**: ペナルティが適用されている
- ✅ **StructuredLabel**: 機能名マッチングが機能している

---

## 🎯 NotebookLMの理想的な出力結果

### 理想的な回答の構造

```
1. 導入（お問い合わせへの感謝）
   - 提供された資料に基づき、教室の削除ができない原因（削除が実行されるための条件）についてご説明いたします。

2. 機能の特定と権限の説明
   - 教室の削除機能（164__【FIX】教室削除機能）を実行できるのは、システム管理者、塾講師ステーション管理者、ゲスト管理者といった権限を持つ全体管理者のみです。

3. 削除条件の説明（構造化）
   - 教室を論理削除し、それに紐づく求人情報を削除するためには、以下の全ての条件を満たしている必要があります。
   - 教室削除を妨げる主な原因（満たすべき条件の不成立）
   - 1. 求人の掲載状態に関する条件
   - 2. 応募情報のステータスに関する条件

4. 削除が実行された場合の動作
   - 上記の条件が満たされた場合、対象の教室情報（基本情報、応募情報転送連絡先、塾チャート、ロゴ・スライド画像など）は論理削除されます。
   - また、削除対象の教室に紐づく全ての求人について177__【FIX】求人削除機能が実施されます。

5. 補足事項（操作手順など）
   - 削除操作は、161__【FIX】教室一覧閲覧機能の画面にあるレコードの削除ボタンから実行できます。
```

### 理想的な回答の特徴

1. **構造化された説明**
   - 明確なセクション分け
   - 番号付きの条件説明
   - 階層的な情報整理

2. **機能名の明示**
   - 「164__【FIX】教室削除機能」を明示
   - タイトル中の機能名を正確に引用
   - プレフィックス（164__）を含めて引用

3. **関連機能への参照**
   - 177__【FIX】求人削除機能
   - 161__【FIX】教室一覧閲覧機能
   - 関連する帳票のデータ

4. **条件の明確な分類**
   - 「満たすべき条件の不成立」として構造化
   - 各条件を番号付きで明確に説明
   - 具体例を含む

5. **操作手順の説明**
   - 補足事項として操作手順を説明
   - 画面遷移やポップアップの説明

---

## 📊 現在のシステムとの差異分析

### ✅ 検索結果の品質（改善済み）

| 項目 | 状態 | 説明 |
|------|------|------|
| ランキング | ✅ 改善 | 「164_【FIX】教室削除機能」が1位 |
| BM25スコア | ✅ 改善 | 両方の結果に設定されている |
| タイトルマッチング | ✅ 改善 | ペナルティが適用されている |
| StructuredLabel | ✅ 動作 | 機能名マッチングが機能している |

### ⚠️ AI回答生成の品質（要確認）

#### 1. プロンプトの構造化

**NotebookLMの特徴**:
- 構造化された詳細な説明
- 明確なセクション分け
- 階層的な情報整理

**現在のプロンプト** (`summarize-confluence-docs.ts`):
- 基本的なルールは含まれている
- 構造化された出力の具体的な指示は限定的
- セクション分けの指示はあるが、NotebookLMほど詳細ではない

**差異**:
- プロンプトに「構造化された回答」の具体的な指示が必要
- セクション分けの形式をより明確に指示する必要がある

#### 2. 機能名の明示

**NotebookLMの特徴**:
- 「164__【FIX】教室削除機能」を明示
- タイトル中の機能名を正確に引用
- プレフィックス（164__）を含めて引用

**現在のプロンプト**:
- ドキュメントタイトルを言及する際の指示はあるが、機能名の明示に関する具体的な指示は限定的

**差異**:
- 機能名を明示する具体的な指示が必要
- タイトル中の機能名を正確に引用する指示が必要

#### 3. 関連機能の検出

**NotebookLMの特徴**:
- 177__【FIX】求人削除機能
- 161__【FIX】教室一覧閲覧機能
- 関連する帳票のデータ

**現在の検索結果**:
- 「177_【FIX】求人削除機能」が8位に含まれている
- 「161_【FIX】教室一覧閲覧機能」は検索結果に含まれていない可能性

**差異**:
- 関連機能を自動的に検出・参照する仕組みが必要
- 同じドメイン（求人管理）の機能を優先的に参照する仕組みが必要

#### 4. 条件の明確な分類

**NotebookLMの特徴**:
- 「満たすべき条件の不成立」として構造化
- 各条件を番号付きで明確に説明
- 具体例を含む

**現在のプロンプト**:
- 番号付きリストのルールはあるが、条件の分類に関する具体的な指示は限定的

**差異**:
- 条件を分類して構造化する具体的な指示が必要
- 「満たすべき条件の不成立」のような構造化された説明の指示が必要

#### 5. 操作手順の説明

**NotebookLMの特徴**:
- 補足事項として操作手順を説明
- 画面遷移やポップアップの説明

**現在のプロンプト**:
- 操作手順に関する具体的な指示は限定的

**差異**:
- 補足事項として操作手順を説明する指示が必要

---

## 💡 改善提案

### 1. プロンプトの改善（優先度：高）

#### 1.1 構造化された回答の指示を追加

```typescript
// プロンプトテンプレートに追加
const PROMPT_IMPROVEMENT = `
# 回答構造の要件

以下の構造で回答してください：

1. **導入（お問い合わせへの感謝）**
   - 提供された資料に基づき、[質問内容]についてご説明いたします。

2. **機能の特定と権限の説明**
   - 機能名を明示（タイトルから正確に引用：例「164_【FIX】教室削除機能」）
   - 権限や実行可能なユーザーについて説明

3. **削除条件の説明（構造化）**
   - 主な原因（満たすべき条件の不成立）
   - 条件1: [具体的な条件]
   - 条件2: [具体的な条件]

4. **削除が実行された場合の動作**
   - 条件が満たされた場合の動作を説明

5. **補足事項（操作手順など）**
   - 操作手順や画面遷移について説明
`;
```

#### 1.2 機能名の明示の指示を追加

```typescript
// プロンプトテンプレートに追加
const FUNCTION_NAME_IMPROVEMENT = `
# 機能名の明示

- 機能を言及する際は、タイトルから正確に引用してください
- プレフィックス（164__、177__など）を含めて引用してください
- 例：「164_【FIX】教室削除機能」「177_【FIX】求人削除機能」
`;
```

#### 1.3 関連機能の参照の指示を追加

```typescript
// プロンプトテンプレートに追加
const RELATED_FUNCTION_IMPROVEMENT = `
# 関連機能の参照

- 参考情報に含まれる関連機能がある場合は、その機能名も明示してください
- 同じドメイン（求人管理、教室管理など）の機能を優先的に参照してください
- 例：「また、削除対象の教室に紐づく全ての求人について177_【FIX】求人削除機能が実施されます」
`;
```

### 2. 検索結果の品質（✅ 改善済み）

- BM25スコアの保持: ✅ 完了
- タイトルマッチングのペナルティ: ✅ 完了
- StructuredLabelの活用: ✅ 完了

### 3. 関連機能の自動検出（優先度：中）

- 検索結果から関連機能を自動的に検出
- 同じドメイン（求人管理）の機能を優先
- 関連機能への参照を自動的に追加

---

## 📝 次のステップ

### 1. 実際のブラウザテストの確認

1. ブラウザで実際の出力結果を確認
2. NotebookLMの理想的な出力と比較
3. 差異を特定して改善

### 2. プロンプトの改善

1. 構造化された回答の指示を追加
2. 機能名の明示の指示を追加
3. 関連機能の参照の指示を追加

### 3. テストと検証

1. 改善後のプロンプトでテスト
2. 回答の品質を評価
3. NotebookLMの理想的な出力との差異を再評価

---

## 📊 まとめ

### 検索結果の品質
- ✅ **改善済み**: 「164_【FIX】教室削除機能」が1位に表示
- ✅ **改善済み**: BM25スコアとタイトルマッチングが正しく動作

### AI回答生成の品質
- ❓ **要確認**: 実際のブラウザテストで出力結果を確認
- 💡 **改善提案**: プロンプトの構造化と機能名の明示の指示を追加

### 優先度
1. **高**: 実際のブラウザテストの確認
2. **高**: プロンプトの構造化と機能名の明示の指示を追加
3. **中**: 関連機能の自動検出（追加機能）

