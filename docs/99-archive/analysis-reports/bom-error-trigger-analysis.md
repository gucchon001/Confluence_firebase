# BOM文字エラーが起きた原因の特定

## エラー発生のタイムライン

1. **2025-10-28**: `@xenova/transformers`から`@google/generative-ai`に移行（コミット `848cc783`）
   - この時点ではBOM文字の問題は表面化していなかった

2. **2025-11-03 02:39:44**: `pageId`から`page_id`への移行（コミット `6ddb2eae`）
   - データベースの再構築が行われた
   - データの再同期が行われた可能性
   - **重要**: この時点でBOM文字を含むデータがデータベースに保存された可能性

3. **2025-11-05 10:33:14**: Lunr migration（コミット `96996246`）
   - タイトル検索の最適化
   - この時点ではまだ動いていた

4. **2025-11-05 16:46:45**: **最後に動いていた時点**
   - この時点では正常に動作していた

5. **2025-11-06 03:53:48**: **エラー発生**
   - 「ログイン認証の仕組みはどうなっていますか？」というクエリでBOM文字エラーが発生

## 原因の特定

### 直接的な原因

**2025/11/5 16:46:45から2025/11/6 08:44:33までの間のコード変更は、ドキュメントファイルのみでした。**

つまり、**コードの変更が原因ではなく、データベースに保存されているデータにBOM文字が含まれていたことが原因**です。

### 根本的な原因

1. **データベース移行時のBOM文字混入**
   - `6ddb2eae`（2025-11-03）のコミットで`pageId`から`page_id`への移行が行われた
   - この移行で、データベースの再構築やデータの再同期が行われた
   - **Confluence APIから取得したデータや、データ同期処理でBOM文字が混入した可能性**

2. **ライブラリの変更による影響**
   - `@google/generative-ai`は`@xenova/transformers`と異なり、protobufのByteStringを期待する
   - BOM文字が含まれると、ByteStringへの変換時にエラーが発生する
   - `@xenova/transformers`ではBOM文字があっても問題なく処理されていた

3. **エラーが表面化したタイミング**
   - データベースにBOM文字を含むデータが保存されていたが、特定のクエリで初めて問題が表面化
   - 「ログイン認証の仕組みはどうなっていますか？」というクエリで、BOM文字を含むデータが検索結果に含まれ、埋め込み生成時にエラーが発生

## なぜ2025/11/5 16:46:45まで動いていたのか

**重要**: ユーザーは「ログイン認証の仕組みはどうなっていますか？」というクエリでずっとテストしていたとのこと。つまり、クエリは同じで、2025/11/5 16:46:45の時点までは動いていた。

### 考えられる原因

1. **デプロイ（212881ef）が原因**
   - 2025-11-06 08:42:20にデプロイが完了
   - デプロイ時に、データベースの状態が変わった可能性
   - デプロイ後に、インデックスの再構築が行われた可能性

2. **インデックス再構築が原因**
   - 2025年11月5日にLunrインデックスとベクトルインデックスの再構築が行われた
   - 再構築時に、データベースからデータを読み込んで処理する際に、BOM文字を含むデータが検索結果に含まれるようになった可能性

3. **データベースの状態変化**
   - デプロイ後に、データベースの状態が変わった可能性
   - インデックスの再構築により、以前は検索結果に含まれていなかったBOM文字を含むデータが検索結果に含まれるようになった可能性

## 解決策

### 実装済みの対策

1. **データベース保存時のBOM除去**（コミット `bafa9e1c`）
   - `confluence-sync-service.ts`でデータ保存時にBOM文字を除去

2. **埋め込み生成時のBOM除去**（コミット `067dc65d`）
   - `embeddings.ts`で埋め込み生成時にBOM文字を除去

3. **検索処理時のBOM除去**（コミット `867a947d`）
   - `lancedb-search-client.ts`で検索処理時にBOM文字を除去

4. **クエリ前処理時のBOM除去**（コミット `6a52f320`）
   - `query-preprocessor.ts`でクエリ前処理時にBOM文字を除去

### 推奨される追加対策

1. **既存データのクリーンアップ**
   - データベースに保存されている既存データからBOM文字を除去するスクリプトを実行
   - データの再同期を実行して、BOM文字を含まないデータに置き換える

2. **データ取得時のBOM除去**
   - Confluence APIからデータを取得する際に、BOM文字を除去する処理を追加
   - データ同期処理でBOM文字を除去する処理を追加

## 結論

**エラーの原因は、2025-11-03の`pageId`から`page_id`への移行時に、データベースにBOM文字を含むデータが保存されたことです。**

コードの変更が原因ではなく、データベースに保存されているデータにBOM文字が含まれていたことが原因でした。

現在のBOM除去処理で、今後同様のエラーが発生しないように対策されていますが、既存データのクリーンアップも推奨されます。

