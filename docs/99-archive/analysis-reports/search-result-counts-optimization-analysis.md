# 検索システムの取得件数最適化分析

## 📊 現在の取得件数設定（段階的最適化後）

### 1. ベクトル検索（フェーズ1最適化）
- **設定**: `topK * 15`
- **例（topK=20）**: 300件
- **変更前**: `topK * 30` (600件)
- **削減率**: 50%削減（300件削減）

### 2. BM25検索（フェーズ2最適化）
- **設定**: `kwCap = Math.max(150, Math.floor(topK * 2.5))`
- **例（topK=20）**: 150件/キーワード
- **キーワード数**: 最大5キーワード
- **合計**: 最大750件（重複除去後）
- **変更前**: `Math.max(200, Math.floor(topK * 3))` (200件/キーワード、最大1000件)
- **削減率**: 25%削減（250件削減）

### 3. タイトル検索（フェーズ3最適化）
- **設定**: 候補ごとに最大15件、最大10候補
- **合計**: 最大150件
- **変更前**: 候補ごとに最大20件、最大10候補（最大200件）
- **削減率**: 25%削減（50件削減）

### 4. KG拡張後のベクトル
- **設定**: `topK * 5`
- **例（topK=20）**: 100件
- **変更**: なし

### 5. Composite Scoring対象
- **設定**: 上位100件
- **変更**: なし

### 6. 最終返却
- **設定**: `topK * 3`
- **例（topK=20）**: 60件
- **変更**: なし

## 📈 パフォーマンス改善予測

### データ取得量の削減（topK=20の場合）

| 段階 | 変更前 | 変更後 | 削減量 | 削減率 |
|------|--------|--------|--------|--------|
| ベクトル検索 | 600件 | 300件 | 300件 | 50.0% |
| BM25検索（合計） | 1000件 | 750件 | 250件 | 25.0% |
| タイトル検索 | 200件 | 150件 | 50件 | 25.0% |
| **合計** | **1800件** | **1200件** | **600件** | **33.3%** |

### 処理時間改善予測

1. **ベクトル検索（フェーズ1）**
   - 取得件数: 50%削減
   - 予測改善: 25-40%の時間短縮
   - 理由: LanceDBからのデータ取得時間が短縮

2. **BM25検索（フェーズ2）**
   - 取得件数: 25%削減
   - 予測改善: 15-25%の時間短縮
   - 理由: Lunr検索結果の処理時間が短縮

3. **タイトル検索（フェーズ3）**
   - 取得件数: 25%削減
   - 予測改善: 15-25%の時間短縮
   - 理由: LIKEクエリの実行回数と結果処理時間が短縮

4. **LanceDB補完処理**
   - BM25結果の補完: 25%削減
   - 予測改善: 20-30%の時間短縮
   - 理由: pageIdベースのLanceDB取得処理が削減

### メモリ使用量改善

- **削減量**: 約600件分のデータ構造
- **予測改善**: 20-35%のメモリ使用量削減
- **理由**: 処理するデータ量が33.3%削減

## 🔍 影響範囲分析

### 検索精度への影響

#### 低リスク（影響が小さい）
1. **ベクトル検索（フェーズ1）**: topK * 15でも十分
   - 理由: 近似検索の誤差を考慮しても、15倍で上位結果は十分カバー
   - リスク: 低い（上位結果は保持される）

2. **タイトル検索（フェーズ3）**: 15件/候補で十分
   - 理由: タイトル検索は救済的な役割、15件で十分
   - リスク: 極めて低い（タイトルマッチは上位に来る）

#### 中リスク（注意が必要）
1. **BM25検索（フェーズ2）**: 150件/キーワード
   - リスク: 低い
   - 理由: 複数キーワードでマッチする場合、統合処理でカバー可能
   - 対策: 複数キーワードマッチのスコア統合ロジックが機能しているため、影響は限定的

### 検出漏れの可能性

#### ベクトル検索（フェーズ1）
- **リスク**: 低い
- **理由**: topK * 15でも、上位20件は確実に含まれる
- **影響**: 距離が非常に遠いドキュメントのみ影響（通常は検索結果に含まれない）

#### BM25検索（フェーズ2）
- **リスク**: 低い
- **理由**: 150件/キーワードで、複数キーワードマッチの統合により上位結果は保持される
- **影響**: 単一キーワードのみでマッチする低スコアドキュメントが影響（通常は検索結果に含まれない）

#### タイトル検索（フェーズ3）
- **リスク**: 極めて低い
- **理由**: タイトルマッチは上位に来るため、15件で十分
- **影響**: ほとんどなし

## 💰 トークン使用量改善

### 埋め込み生成（Embedding）
- **変更**: なし（クエリは1回のみ）
- **改善**: なし

### LLM呼び出し
- **変更**: なし（検索結果の処理は同じ）
- **改善**: なし

### データ転送
- **削減**: 約600件分のデータ構造
- **予測改善**: 20-35%のデータ転送量削減
- **理由**: LanceDBからのデータ取得量が33.3%削減

## 📋 実装済み最適化

### 段階的な最適化アプローチ（実装済み）

#### ✅ フェーズ1: ベクトル検索の削減（実装済み）
- **変更**: `topK * 30` → `topK * 15`（中間値）
- **削減率**: 50%削減
- **リスク**: 低い
- **効果**: 中程度のパフォーマンス改善
- **実装日**: 2025-01-XX

#### ✅ フェーズ2: BM25検索の削減（実装済み）
- **変更**: `Math.max(200, Math.floor(topK * 3))` → `Math.max(150, Math.floor(topK * 2.5))`（中間値）
- **削減率**: 25%削減
- **リスク**: 低い
- **効果**: 中程度のパフォーマンス改善
- **実装日**: 2025-01-XX

#### ✅ フェーズ3: タイトル検索の削減（実装済み）
- **変更**: 20件/候補 → 15件/候補（中間値）
- **削減率**: 25%削減
- **リスク**: 極めて低い
- **効果**: 小程度のパフォーマンス改善
- **実装日**: 2025-01-XX

### 監視項目

1. **検索精度**: 上位10件の検出率を監視
2. **パフォーマンス**: 検索時間の改善を測定
3. **メモリ使用量**: メモリ使用量の削減を確認
4. **エラー率**: 検出漏れによるエラーを監視

## ⚠️ 注意事項

1. **段階的な適用**: 一度に大幅な削減は避け、段階的に適用
2. **A/Bテスト**: 本番環境では段階的に適用し、影響を測定
3. **ロールバック準備**: 問題が発生した場合のロールバック手順を準備
4. **監視強化**: 検索精度とパフォーマンスの両方を監視

