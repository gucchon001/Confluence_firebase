# クエリ7デグレード分析：045_パスワード再設定機能（9位 → 12位以下）

**作成日**: 2025年1月  
**目的**: クエリ7「退会した会員が同じアドレス使ったらどんな表示がでますか」で、045ページが9位から12位以下にデグレードした原因を特定

---

## 📊 現状

| 項目 | Phase 0A-4（過去） | 現在 | 差分 |
|------|------------------|------|------|
| **順位** | **9位** | **12位以下** | **-3位以上** ⚠️ |
| ページID | 703594590 | 703594590 | 同じ |
| タイトル | 045_【FIX】パスワード再設定機能 | 045_【FIX】パスワード再設定機能 | 同じ |

---

## 🔍 調査結果

### 1. **BM25検索での順位**

```
[DEBUG BM25] 045ページが見つかりました:
  - rank=1/412
  - score=8.4700（非常に高い）
  - pageId=703594590（正しく取得）
```

**評価**: ✅ **BM25検索では1位**であり、キーワードマッチングは正常に機能している

### 2. **ベクトル検索での順位**

```
[DEBUG Vector] 045ページはベクトル検索結果に含まれていません（45件中、51件中など）
```

**評価**: ❌ **ベクトル検索結果に含まれていない**（少なくとも上位150件以内に含まれていない）

### 3. **RRF段階での順位**

```
[DEBUG] 045ページは検索結果に含まれていません（RRF段階、50件中）
```

**評価**: ❌ **RRF段階で50件以内に含まれていない**

### 4. **タグマッチングの状況**

```
045ページのタグ: 退会, 再登録, メールアドレス, パスワード再設定, ログイン, アカウント
クエリキーワード: 会員, 退会, 表示, アドレス

マッチ状況:
  ✅ 「退会」タグ ↔ 「退会」キーワード: 完全一致
  ✅ 「メールアドレス」タグ ↔ 「アドレス」キーワード: 部分一致
```

**評価**: ✅ **タグマッチングの条件は満たしている**が、045ページが検索結果に含まれていないため、タグマッチングボーナスが適用される機会がない

---

## 🔴 デグレードの根本原因

### **主要原因1: ベクトル検索の取得件数削減**

**Phase 0A-4の設定:**
```typescript
const searchLimit = topK * 30;  // topK=10 → 300件
```

**現在の設定:**
```typescript
const searchLimit = topK * 15;  // topK=10 → 150件（50%削減）
```

**影響:**
- 045ページのベクトル距離が比較的遠い可能性
- ベクトル検索の取得件数が削減されたため、045ページが検索結果に含まれなくなった
- **Phase 0A-4では300件中に含まれていたが、現在は150件に削減され、外れた可能性が高い**

---

### **主要原因2: Composite Scoring重みの変更**

**Phase 0A-4の設定:**
```typescript
vectorWeight: 0.30,  // 30%（ベクトル重視）
bm25Weight: 0.40,    // 40%
```

**現在の設定:**
```typescript
vectorWeight: 0.05,  // 5%（ベクトル軽視、6倍減少）⚠️
bm25Weight: 0.53,    // 53%（BM25重視）
```

**影響:**
- **vectorWeightが6倍減少**（30% → 5%）
- ベクトル距離が近いページが不利になった
- しかし、045ページはベクトル検索結果に含まれていないため、この変更は直接的な影響は少ない
- **問題は、ベクトル検索結果に含まれていないこと自体**

---

### **主要原因3: RRF段階での結果数制限**

**Phase 0A-4の状態（推定）:**
```
ベクトル検索: 300件
BM25検索: 412件
RRF統合後: 50-100件程度
Composite Scoring対象: 上位50件程度
```

**現在の状態:**
```
ベクトル検索: 150件（50%削減）⚠️
BM25検索: 412件
RRF統合後: 50件
Composite Scoring対象: 上位100件（拡大）
```

**影響:**
- 045ページは**BM25検索で1位**だが、**ベクトル検索結果に含まれていない**
- RRF段階で統合される際、ベクトルスコアが低い（またはゼロ）ため、RRFスコアが低下
- **RRF段階で50件以内に含まれない可能性が高い**

---

### **主要原因4: ベクトル検索結果に含まれない理由**

**考えられる理由:**

1. **ベクトル距離が遠い**
   - クエリ「退会した会員が同じアドレス使ったらどんな表示がでますか」と、045ページの内容「パスワード再設定機能」の意味的距離が遠い
   - ベクトルエンベディングでは「退会」と「パスワード再設定」の関連性が低く評価されている可能性

2. **取得件数削減の影響**
   - Phase 0A-4では300件中に含まれていたが、現在は150件に削減
   - 045ページがベクトル検索の150位以下になった可能性

3. **ベクトルエンベディングの変更**
   - エンベディングモデルの変更や、エンベディングデータの再生成により、045ページのベクトル距離が変わった可能性

---

## 📊 過去の記録との比較

### Phase 0A-4の成功要因（他の事例から）

| 事例 | Phase 0A-4 | 現在 | 差分 |
|------|-----------|------|------|
| 046_会員退会機能 | #1 | #7 | -6 |
| 168_教室コピー機能 | #1 | #22 | -21 |
| 721_学年自動更新バッチ | #1 | #2 | -1 |

**共通の変更点:**
1. **vectorWeight削減**: 30% → 5%（6倍減少）
2. **ベクトル検索取得件数削減**: 30倍 → 15倍（50%削減）
3. **BM25検索取得件数増加**: kwCap 50 → 150（3倍増加）

**045ページの場合:**
- BM25検索では1位を維持している（優秀）
- しかし、**ベクトル検索結果に含まれていない**ため、RRF段階で統合されない
- **Phase 0A-4では、ベクトル検索で取得されていた可能性が高い**

---

## 🎯 デグレードの要因まとめ

### **最優先の要因**

1. **ベクトル検索の取得件数削減（50%削減）**
   - `topK * 30` → `topK * 15`
   - **045ページがベクトル検索結果に含まれなくなった**

### **二次的な要因**

2. **vectorWeight削減（6倍減少）**
   - 30% → 5%
   - ベクトル検索結果に含まれている場合でも、スコアへの寄与が大幅に減少

3. **RRF段階での結果数制限**
   - RRF統合後の50件以内に045ページが含まれない
   - タグマッチングボーナスが適用される機会がない

---

## 💡 推奨される対応

### **対応1: ベクトル検索の取得件数を拡大**

```typescript
// src/lib/lancedb-search-client.ts
const searchLimit = topK * 20;  // 15倍 → 20倍（中間値）
// または
const searchLimit = topK * 30;  // Phase 0A-4設定に復帰
```

**期待効果:**
- 045ページがベクトル検索結果に含まれる可能性が高まる
- RRF段階で統合される機会が増える

### **対応2: vectorWeightを中間値に調整**

```typescript
// src/lib/composite-scoring-service.ts
vectorWeight: 0.15,  // 5% → 15%（Phase 0A-4: 30%, 現在: 5%の中間値）
bm25Weight: 0.48,    // 53% → 48%（調整）
```

**期待効果:**
- ベクトル距離が近いページへの評価が改善
- ベクトル検索結果に含まれている場合のスコア寄与が向上

### **対応3: RRF段階での結果数制限を拡大**

現在、RRF段階で50件に制限されているが、タグマッチングボーナスが適用される前に除外されている可能性がある。

```typescript
// RRF統合後の結果数を100件に拡大
const TOP_N_FOR_COMPOSITE = 100;  // 現在: 100件（既に拡大済み）
```

**評価:**
- 既に100件に拡大されているが、045ページが含まれていない
- **問題は、RRF段階で統合される前（ベクトル検索段階）で除外されていること**

---

## 🔧 即座に実施すべき修正

### **修正1: ベクトル検索の取得件数を拡大（最優先）**

```typescript
// src/lib/lancedb-search-client.ts (1161行目)
const searchLimit = topK * 20;  // 15倍 → 20倍
```

**理由:**
- 045ページがベクトル検索結果に含まれていないことが最大の原因
- ベクトル検索結果に含まれれば、RRF段階で統合され、タグマッチングボーナスが適用される可能性が高まる

### **修正2: デバッグログの追加**

045ページがベクトル検索結果に含まれない理由を特定するため、ベクトル距離を確認：

```typescript
// ベクトル検索結果に045ページが含まれない場合、距離を確認
if (pageId === 703594590 && !vectorResults.includes(page045)) {
  console.log(`[DEBUG Vector] 045ページのベクトル距離を確認: ${page045._distance}`);
}
```

---

## 📋 確認事項

1. ✅ BM25検索で045ページが1位であることを確認
2. ❌ ベクトル検索結果に045ページが含まれていないことを確認
3. ❌ RRF段階で045ページが50件以内に含まれていないことを確認
4. ✅ タグマッチングの条件は満たしているが、適用されていない

---

## 🎯 結論

**045ページが9位から12位以下にデグレードした主な原因:**

1. **ベクトル検索の取得件数削減（最優先）**
   - Phase 0A-4: `topK * 30`（300件）
   - 現在: `topK * 15`（150件、50%削減）
   - **045ページがベクトル検索結果に含まれなくなった**

2. **ベクトル検索結果に含まれないことによる連鎖**
   - RRF段階で統合されない
   - タグマッチングボーナスが適用されない
   - 最終的な順位が低下

**推奨される対応:**
- **ベクトル検索の取得件数を拡大**（15倍 → 20-30倍）
- これにより、045ページが検索結果に含まれ、タグマッチングボーナスが適用される可能性が高まる

