# Confluence / Jira æ¨ªæ–­æ¤œç´¢å®Ÿè£…æ–¹é‡ï¼ˆGenkit Flowæ´»ç”¨ç‰ˆï¼‰

**ä½œæˆæ—¥**: 2025å¹´1æœˆ  
**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ“‹ è¨­è¨ˆå®Œäº†ï¼ˆå®Ÿè£…å¾…ã¡ï¼‰  
**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: 
- [Confluence / Jira çµ±åˆè¨ˆç”»](./06.01.01-confluence-jira-integration-plan.md)
- [Genkitåˆ©ç”¨æ–¹é‡](./03.01.01-genkit-design.md)
- [Jiraæ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸](../02-specifications/02.03-jira-spec.md)

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [Genkit Flowæ´»ç”¨ã®ãƒ¡ãƒªãƒƒãƒˆ](#genkit-flowæ´»ç”¨ã®ãƒ¡ãƒªãƒƒãƒˆ)
3. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ)
4. [å®Ÿè£…ä»•æ§˜](#å®Ÿè£…ä»•æ§˜)
5. [ã‚¹ã‚³ã‚¢æ­£è¦åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](#ã‚¹ã‚³ã‚¢æ­£è¦åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
6. [APIä»•æ§˜](#apiä»•æ§˜)
7. [UI/UXä»•æ§˜](#uiuxä»•æ§˜)
8. [å®Ÿè£…æ‰‹é †](#å®Ÿè£…æ‰‹é †)
9. [ãƒ†ã‚¹ãƒˆæ–¹é‡](#ãƒ†ã‚¹ãƒˆæ–¹é‡)
10. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™)

---

## æ¦‚è¦

### ç›®çš„

Confluenceã¨Jiraã®ä¸¡æ–¹ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰åŒæ™‚ã«æ¤œç´¢ã—ã€çµ±åˆã•ã‚ŒãŸçµæœã‚’è¿”ã™æ¨ªæ–­æ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚Genkit Flowã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ä¸¦åˆ—æ¤œç´¢ã®ç®¡ç†ã€ã‚¹ã‚³ã‚¢æ­£è¦åŒ–ã€ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’çµ±ä¸€çš„ãªæ–¹æ³•ã§å®Ÿç¾ã™ã‚‹ã€‚

### ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³

- âœ… **Phase 1å®Œäº†**: Confluenceã¨Jiraã®å€‹åˆ¥æ¤œç´¢ãŒå®Ÿè£…æ¸ˆã¿
  - ã‚½ãƒ¼ã‚¹åˆ‡æ›¿UIï¼ˆã‚¿ãƒ–ï¼‰å®Ÿè£…æ¸ˆã¿
  - å€‹åˆ¥æ¤œç´¢APIå®Ÿè£…æ¸ˆã¿
  - ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰å®Œäº†
- ğŸ“‹ **Phase 2ï¼ˆæœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰**: æ¨ªæ–­æ¤œç´¢ã®å®Ÿè£…æ–¹é‡

### å®Ÿè£…æ–¹é‡ã®é¸æŠ

**Genkit Flowã‚’æ´»ç”¨ã™ã‚‹ç†ç”±**:

1. **æ—¢å­˜å®Ÿè£…ã¨ã®æ•´åˆæ€§**: `auto-label-flow.ts`ã§æ—¢ã«`ai.defineFlow()`ã‚’ä½¿ç”¨æ¸ˆã¿
2. **ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼**: è‡ªå‹•ã§ãƒ­ã‚®ãƒ³ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã‚‹
3. **Dev UI**: Genkit Dev UIã§å¯è¦–åŒ–ãƒ»ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå¯èƒ½
5. **æ‹¡å¼µæ€§**: å°†æ¥ã®æ©Ÿèƒ½è¿½åŠ ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚½ãƒ¼ãƒˆãªã©ï¼‰ã«å¯¾å¿œã—ã‚„ã™ã„

---

## Genkit Flowæ´»ç”¨ã®ãƒ¡ãƒªãƒƒãƒˆ

### 1. ä¸¦åˆ—æ¤œç´¢ã®ç®¡ç†

è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ï¼ˆConfluenceã€Jiraï¼‰ã‹ã‚‰ã®æ¤œç´¢ã‚’Flowå†…ã§ä¸¦åˆ—å®Ÿè¡Œã—ã€çµæœã‚’çµ±åˆç®¡ç†ã§ãã‚‹ã€‚

```typescript
// Flowå†…ã§ä¸¦åˆ—æ¤œç´¢ã‚’å®Ÿè¡Œ
const searchPromises = sources.map(source => 
  hybridSearchEngine.search({ query, tableName: getTableName(source) })
);
const results = await Promise.all(searchPromises);
```

### 2. è‡ªå‹•ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼

Genkit Flowã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãŒè‡ªå‹•çš„ã«æœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ï¼š

- **ãƒ­ã‚®ãƒ³ã‚°**: å„ã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè¡Œãƒ­ã‚°
- **ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°**: å®Ÿè¡Œæ™‚é–“ã€ã‚¨ãƒ©ãƒ¼ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**: Cloud Monitoringã¸ã®è‡ªå‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

### 3. Dev UIã§ã®å¯è¦–åŒ–

Genkit Dev UI (`http://localhost:4000`) ã§ä»¥ä¸‹ãŒå¯èƒ½ï¼š

- Flowã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚’å¯è¦–åŒ–
- å„ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ãƒ»å‡ºåŠ›ã‚’ç¢ºèª
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç‰¹å®š
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ‡ãƒãƒƒã‚°

### 4. çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

Flowå†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€GenkitãŒè‡ªå‹•çš„ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¨˜éŒ²ã—ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã€‚

### 5. å‹å®‰å…¨æ€§

Zodã‚¹ã‚­ãƒ¼ãƒã«ã‚ˆã‚‹å…¥å‡ºåŠ›ã®å‹å®‰å…¨æ€§ãŒä¿è¨¼ã•ã‚Œã‚‹ã€‚

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### å…¨ä½“æ§‹æˆå›³

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼
  â†“
Next.js UI (æ¨ªæ–­æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰é¸æŠ)
  â†“
API Route: /api/flow/hybridCrossSourceSearchFlow
  â†“
Genkit Flow: hybridCrossSourceSearchFlow
  â”œâ”€â†’ ä¸¦åˆ—æ¤œç´¢å®Ÿè¡Œ
  â”‚   â”œâ”€â†’ Confluenceæ¤œç´¢ (hybridSearchEngine)
  â”‚   â”‚   â”œâ”€â†’ LanceDB (confluenceãƒ†ãƒ¼ãƒ–ãƒ«)
  â”‚   â”‚   â””â”€â†’ Lunr.js (confluenceã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹)
  â”‚   â””â”€â†’ Jiraæ¤œç´¢ (hybridSearchEngine)
  â”‚       â”œâ”€â†’ LanceDB (jira_issuesãƒ†ãƒ¼ãƒ–ãƒ«)
  â”‚       â””â”€â†’ Lunr.js (jira_issuesã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹)
  â”œâ”€â†’ ã‚¹ã‚³ã‚¢æ­£è¦åŒ–
  â”œâ”€â†’ çµæœãƒãƒ¼ã‚¸ãƒ»å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  â””â”€â†’ çµ±åˆçµæœè¿”å´
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ã‚¯ã‚¨ãƒªå—ä¿¡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’å—ã‘å–ã‚‹
2. **ä¸¦åˆ—æ¤œç´¢**: Confluenceã¨Jiraã®ä¸¡æ–¹ã‹ã‚‰ä¸¦åˆ—ã«æ¤œç´¢ã‚’å®Ÿè¡Œ
3. **ã‚¹ã‚³ã‚¢æ­£è¦åŒ–**: å„ã‚½ãƒ¼ã‚¹ã®ã‚¹ã‚³ã‚¢ã‚’çµ±ä¸€ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ0-1ï¼‰ã«æ­£è¦åŒ–
4. **çµæœãƒãƒ¼ã‚¸**: æ­£è¦åŒ–ã•ã‚ŒãŸã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆã—ã€é‡è¤‡ã‚’é™¤å»
5. **Source-aware Diversification**: å„ã‚½ãƒ¼ã‚¹ã‹ã‚‰æœ€ä½1ä»¶ã‚’ç¢ºä¿
6. **çµæœè¿”å´**: çµ±åˆã•ã‚ŒãŸçµæœã‚’è¿”å´

---

## å®Ÿè£…ä»•æ§˜

### Flowå®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ai/flows/hybrid-cross-source-search-flow.ts`

```typescript
import { ai } from '../genkit';
import { z } from 'zod';
import { hybridSearchEngine } from '@/lib/hybrid-search-engine';

// å…¥åŠ›ã‚¹ã‚­ãƒ¼ãƒ
const InputSchema = z.object({
  query: z.string().min(1, 'Query is required'),
  sources: z.array(z.enum(['confluence', 'jira']))
    .default(['confluence', 'jira'])
    .refine(arr => arr.length > 0, 'At least one source is required'),
  topK: z.number().int().min(1).max(50).default(10),
  labelFilters: z.object({
    includeMeetingNotes: z.boolean().optional(),
    excludeArchived: z.boolean().optional(),
  }).optional(),
});

// å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒ
const OutputSchema = z.object({
  results: z.array(z.object({
    id: z.string(),
    title: z.string(),
    content: z.string(),
    url: z.string(),
    source: z.enum(['confluence', 'jira']),
    score: z.number(),
    normalizedScore: z.number(),
    // Confluenceç‰¹æœ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    pageId: z.string().optional(),
    space_key: z.string().optional(),
    labels: z.array(z.string()).optional(),
    // Jiraç‰¹æœ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    issue_key: z.string().optional(),
    status: z.string().optional(),
    status_category: z.string().optional(),
    priority: z.string().optional(),
    assignee: z.string().optional(),
    issue_type: z.string().optional(),
  })),
  searchTime: z.number(),
  sourceBreakdown: z.object({
    confluence: z.number(),
    jira: z.number(),
  }),
  metadata: z.object({
    totalResults: z.number(),
    normalizedScores: z.object({
      confluence: z.object({
        min: z.number(),
        max: z.number(),
        mean: z.number(),
      }).optional(),
      jira: z.object({
        min: z.number(),
        max: z.number(),
        mean: z.number(),
      }).optional(),
    }).optional(),
  }).optional(),
});

// Flowå®šç¾©
export const hybridCrossSourceSearchFlow = ai.defineFlow(
  {
    name: 'hybridCrossSourceSearchFlow',
    inputSchema: InputSchema,
    outputSchema: OutputSchema,
  },
  async (input) => {
    const startTime = Date.now();
    
    // 1. ä¸¦åˆ—æ¤œç´¢å®Ÿè¡Œ
    const searchResults = await executeParallelSearches(input);
    
    // 2. ã‚¹ã‚³ã‚¢æ­£è¦åŒ–
    const normalizedResults = normalizeScoresAcrossSources(searchResults);
    
    // 3. çµæœãƒãƒ¼ã‚¸ã¨å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    const mergedResults = mergeAndRerankResults(normalizedResults, input.topK);
    
    // 4. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    const metadata = generateMetadata(searchResults, normalizedResults);
    
    // 5. ã‚½ãƒ¼ã‚¹åˆ¥çµ±è¨ˆ
    const sourceBreakdown = {
      confluence: mergedResults.filter(r => r.source === 'confluence').length,
      jira: mergedResults.filter(r => r.source === 'jira').length,
    };
    
    const searchTime = Date.now() - startTime;
    
    return {
      results: mergedResults,
      searchTime,
      sourceBreakdown,
      metadata,
    };
  }
);
```

### ä¸»è¦é–¢æ•°ã®å®Ÿè£…

#### 1. ä¸¦åˆ—æ¤œç´¢å®Ÿè¡Œ

```typescript
async function executeParallelSearches(input: z.infer<typeof InputSchema>) {
  const searchPromises = input.sources.map(async (source) => {
    const tableName = source === 'jira' ? 'jira_issues' : 'confluence';
    
    // Lunrã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–çŠ¶æ…‹ã‚’ç¢ºèª
    const { lunrInitializer } = await import('@/lib/lunr-initializer');
    const lunrReady = lunrInitializer.isReady(tableName);
    
    const results = await hybridSearchEngine.search({
      query: input.query,
      topK: input.topK * 2, // ãƒãƒ¼ã‚¸å‰ã«å¤šã‚ã«å–å¾—
      useLunrIndex: lunrReady,
      tableName,
      labelFilters: input.labelFilters || {
        includeMeetingNotes: false,
        excludeArchived: true,
      },
    });
    
    return {
      source,
      results: results.map(r => ({
        ...r,
        dataSource: source, // ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’è¿½åŠ 
      })),
    };
  });
  
  return await Promise.all(searchPromises);
}
```

#### 2. ã‚¹ã‚³ã‚¢æ­£è¦åŒ–

```typescript
function normalizeScoresAcrossSources(searchResults: any[]) {
  // å„ã‚½ãƒ¼ã‚¹ã®ã‚¹ã‚³ã‚¢çµ±è¨ˆã‚’è¨ˆç®—
  const sourceStats = searchResults.map(({ source, results }) => {
    const scores = results.map(r => r.score || r._compositeScore || r._rrfScore || (1 - (r.distance || 0)) || 0);
    
    if (scores.length === 0) {
      return { source, minScore: 0, maxScore: 1, meanScore: 0.5, stdDev: 0 };
    }
    
    const maxScore = Math.max(...scores, 1);
    const minScore = Math.min(...scores, 0);
    const meanScore = scores.reduce((a, b) => a + b, 0) / scores.length;
    const variance = scores.reduce((sum, score) => sum + Math.pow(score - meanScore, 2), 0) / scores.length;
    const stdDev = Math.sqrt(variance);
    
    return { source, maxScore, minScore, meanScore, stdDev };
  });
  
  // æ­£è¦åŒ–ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆMin-Maxæ­£è¦åŒ–ï¼‰
  return searchResults.flatMap(({ source, results }) => {
    const stats = sourceStats.find(s => s.source === source);
    if (!stats || stats.maxScore === stats.minScore) {
      // ã‚¹ã‚³ã‚¢ãŒå…¨ã¦åŒã˜å ´åˆã¯0.5ã«æ­£è¦åŒ–
      return results.map(r => ({
        ...r,
        normalizedScore: 0.5,
        rawScore: r.score || r._compositeScore || r._rrfScore || (1 - (r.distance || 0)) || 0,
      }));
    }
    
    return results.map(r => {
      const rawScore = r.score || r._compositeScore || r._rrfScore || (1 - (r.distance || 0)) || 0;
      // Min-Maxæ­£è¦åŒ–: (score - min) / (max - min)
      const normalizedScore = (rawScore - stats.minScore) / (stats.maxScore - stats.minScore);
      
      return {
        ...r,
        normalizedScore: Math.max(0, Math.min(1, normalizedScore)), // 0-1ã«ã‚¯ãƒ©ãƒ³ãƒ—
        rawScore,
      };
    });
  });
}
```

#### 3. çµæœãƒãƒ¼ã‚¸ã¨å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°

```typescript
function mergeAndRerankResults(normalizedResults: any[], topK: number): any[] {
  // æ­£è¦åŒ–ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
  const sorted = normalizedResults.sort((a, b) => 
    (b.normalizedScore || 0) - (a.normalizedScore || 0)
  );
  
  // é‡è¤‡é™¤å»ï¼ˆåŒã˜IDã®å ´åˆã¯é«˜ã‚¹ã‚³ã‚¢ã‚’å„ªå…ˆï¼‰
  const seen = new Map<string, any>();
  for (const result of sorted) {
    const key = `${result.source}:${result.id || result.pageId || result.issue_key}`;
    if (!seen.has(key) || (seen.get(key).normalizedScore || 0) < (result.normalizedScore || 0)) {
      seen.set(key, result);
    }
  }
  
  const unique = Array.from(seen.values());
  
  // Source-aware Diversification: å„ã‚½ãƒ¼ã‚¹ã‹ã‚‰æœ€ä½1ä»¶ç¢ºä¿
  const sourceCounts = { confluence: 0, jira: 0 };
  const diversified: any[] = [];
  
  // ã¾ãšå„ã‚½ãƒ¼ã‚¹ã‹ã‚‰1ä»¶ãšã¤å–å¾—ï¼ˆã‚¹ã‚³ã‚¢é †ï¼‰
  for (const result of unique) {
    const source = result.source as 'confluence' | 'jira';
    if (sourceCounts[source] === 0) {
      diversified.push(result);
      sourceCounts[source]++;
    }
  }
  
  // æ®‹ã‚Šã‚’ã‚¹ã‚³ã‚¢é †ã«è¿½åŠ 
  for (const result of unique) {
    if (diversified.length >= topK) break;
    if (!diversified.includes(result)) {
      diversified.push(result);
    }
  }
  
  // æœ€çµ‚çš„ã«ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
  return diversified
    .sort((a, b) => (b.normalizedScore || 0) - (a.normalizedScore || 0))
    .slice(0, topK);
}
```

---

## ã‚¹ã‚³ã‚¢æ­£è¦åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### å•é¡Œç‚¹

Confluenceã¨Jiraã§ã¯ã€æ¤œç´¢çµæœã®ã‚¹ã‚³ã‚¢åˆ†å¸ƒãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼š

- **Confluence**: ãƒ™ã‚¯ãƒˆãƒ«è·é›¢ã€BM25ã‚¹ã‚³ã‚¢ã€ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã‚¹ã‚³ã‚¢ã®è¤‡åˆ
- **Jira**: åŒæ§˜ã®è¤‡åˆã‚¹ã‚³ã‚¢ã ãŒã€åˆ†å¸ƒãŒç•°ãªã‚‹å¯èƒ½æ€§

### è§£æ±ºç­–: Min-Maxæ­£è¦åŒ–

å„ã‚½ãƒ¼ã‚¹ã®ã‚¹ã‚³ã‚¢ã‚’0-1ã®ç¯„å›²ã«æ­£è¦åŒ–ã™ã‚‹ã“ã¨ã§ã€ã‚½ãƒ¼ã‚¹é–“ã§å…¬å¹³ã«æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

**å¼**: `normalizedScore = (rawScore - minScore) / (maxScore - minScore)`

### ä»£æ›¿æ¡ˆ: Z-scoreæ­£è¦åŒ–

ã‚ˆã‚Šé«˜åº¦ãªæ­£è¦åŒ–ãŒå¿…è¦ãªå ´åˆã¯ã€Z-scoreæ­£è¦åŒ–ã‚‚æ¤œè¨å¯èƒ½ï¼š

**å¼**: `normalizedScore = (rawScore - meanScore) / stdDev`

ãŸã ã—ã€åˆæœŸå®Ÿè£…ã§ã¯Min-Maxæ­£è¦åŒ–ã‚’æ¨å¥¨ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„ï¼‰ã€‚

---

## APIä»•æ§˜

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**POST** `/api/flow/hybridCrossSourceSearchFlow`

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```json
{
  "query": "ä¼šå“¡ç®¡ç†ã®ãƒã‚°ä¿®æ­£çŠ¶æ³ã¯ï¼Ÿ",
  "sources": ["confluence", "jira"],
  "topK": 10,
  "labelFilters": {
    "includeMeetingNotes": false,
    "excludeArchived": true
  }
}
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹

```json
{
  "results": [
    {
      "id": "CTJ-1234",
      "title": "ä¼šå“¡ç®¡ç†ã®ãƒã‚°ä¿®æ­£",
      "content": "...",
      "url": "https://giginc.atlassian.net/browse/CTJ-1234",
      "source": "jira",
      "score": 0.95,
      "normalizedScore": 0.92,
      "issue_key": "CTJ-1234",
      "status": "é€²è¡Œä¸­",
      "priority": "High",
      "assignee": "æ± ç”°åºƒå¤§"
    },
    {
      "id": "123456789",
      "title": "ä¼šå“¡ç®¡ç†ä»•æ§˜æ›¸",
      "content": "...",
      "url": "https://confluence.example.com/pages/viewpage.action?pageId=123456789",
      "source": "confluence",
      "score": 0.88,
      "normalizedScore": 0.85,
      "pageId": "123456789",
      "space_key": "SPEC",
      "labels": ["æ©Ÿèƒ½è¦ä»¶", "ä¼šå“¡ç®¡ç†"]
    }
  ],
  "searchTime": 1234,
  "sourceBreakdown": {
    "confluence": 5,
    "jira": 5
  },
  "metadata": {
    "totalResults": 10,
    "normalizedScores": {
      "confluence": {
        "min": 0.65,
        "max": 0.95,
        "mean": 0.80
      },
      "jira": {
        "min": 0.70,
        "max": 0.98,
        "mean": 0.84
      }
    }
  }
}
```

### API Routeå®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/api/flow/[flow]/route.ts`

```typescript
case 'hybridCrossSourceSearchFlow': {
  const { hybridCrossSourceSearchFlow } = await import('@/ai/flows/hybrid-cross-source-search-flow');
  const result = await hybridCrossSourceSearchFlow(input);
  return NextResponse.json(result);
}
```

---

## UI/UXä»•æ§˜

### æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿

ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«ã€Œæ¨ªæ–­æ¤œç´¢ã€ãƒ¢ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼š

```
[â— Confluence] [â—‹ Jira] [â—‹ æ¨ªæ–­æ¤œç´¢]
```

### æ¤œç´¢çµæœè¡¨ç¤º

æ¨ªæ–­æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºï¼š

1. **çµ±åˆçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³**: ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸçµ±åˆçµæœ
2. **ã‚½ãƒ¼ã‚¹åˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**: æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã€Confluence/Jiraåˆ¥ã«è¡¨ç¤º

### çµæœã‚«ãƒ¼ãƒ‰

å„çµæœã‚«ãƒ¼ãƒ‰ã«ã¯ä»¥ä¸‹ã‚’è¡¨ç¤ºï¼š

- **ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚¸**: Confluence / Jira ã®ãƒãƒƒã‚¸
- **ã‚¿ã‚¤ãƒˆãƒ«**: ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« / Issue Summary
- **ã‚¹ã‚³ã‚¢**: æ­£è¦åŒ–ã‚¹ã‚³ã‚¢ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼‰
- **ãƒ¡ã‚¿æƒ…å ±**: 
  - Confluence: ã‚¹ãƒšãƒ¼ã‚¹ã€ãƒ©ãƒ™ãƒ«ã€æ›´æ–°æ—¥
  - Jira: Issue Keyã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€å„ªå…ˆåº¦ã€æ‹…å½“è€…ã€æ›´æ–°æ—¥
- **ãƒªãƒ³ã‚¯**: å…ƒã®ãƒšãƒ¼ã‚¸ / Issue ã¸ã®ãƒªãƒ³ã‚¯

---

## å®Ÿè£…æ‰‹é †

### Phase 1: Flowå®šç¾©ã¨åŸºæœ¬å®Ÿè£…ï¼ˆ1-2æ—¥ï¼‰

1. **Flowå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**
   - `src/ai/flows/hybrid-cross-source-search-flow.ts` ã‚’ä½œæˆ
   - å…¥åŠ›ãƒ»å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
   - åŸºæœ¬çš„ãªä¸¦åˆ—æ¤œç´¢ã‚’å®Ÿè£…

2. **API Routeæ‹¡å¼µ**
   - `/api/flow/[flow]/route.ts` ã« `hybridCrossSourceSearchFlow` ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ 

3. **åŸºæœ¬ãƒ†ã‚¹ãƒˆ**
   - Genkit Dev UIã§å‹•ä½œç¢ºèª
   - å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ

### Phase 2: ã‚¹ã‚³ã‚¢æ­£è¦åŒ–å®Ÿè£…ï¼ˆ1æ—¥ï¼‰

1. **æ­£è¦åŒ–é–¢æ•°å®Ÿè£…**
   - `normalizeScoresAcrossSources` é–¢æ•°ã‚’å®Ÿè£…
   - Min-Maxæ­£è¦åŒ–ã‚’å®Ÿè£…

2. **ãƒ†ã‚¹ãƒˆ**
   - ç•°ãªã‚‹ã‚¹ã‚³ã‚¢åˆ†å¸ƒã§ã®æ­£è¦åŒ–ã‚’ãƒ†ã‚¹ãƒˆ
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼ˆå…¨ã¦åŒã˜ã‚¹ã‚³ã‚¢ãªã©ï¼‰ã‚’ãƒ†ã‚¹ãƒˆ

### Phase 3: çµæœãƒãƒ¼ã‚¸ã¨å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆ1æ—¥ï¼‰

1. **ãƒãƒ¼ã‚¸é–¢æ•°å®Ÿè£…**
   - `mergeAndRerankResults` é–¢æ•°ã‚’å®Ÿè£…
   - Source-aware Diversificationã‚’å®Ÿè£…

2. **ãƒ†ã‚¹ãƒˆ**
   - é‡è¤‡é™¤å»ã®ãƒ†ã‚¹ãƒˆ
   - å„ã‚½ãƒ¼ã‚¹ã‹ã‚‰æœ€ä½1ä»¶ç¢ºä¿ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 4: UIçµ±åˆï¼ˆ1-2æ—¥ï¼‰

1. **UIæ‹¡å¼µ**
   - ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«ã€Œæ¨ªæ–­æ¤œç´¢ã€ãƒ¢ãƒ¼ãƒ‰ã‚’è¿½åŠ 
   - çµæœè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ‹¡å¼µ

2. **çµ±åˆãƒ†ã‚¹ãƒˆ**
   - E2Eãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’ç¢ºèª

### Phase 5: æœ€é©åŒ–ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆ1æ—¥ï¼‰

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - ä¸¦åˆ—æ¤œç´¢ã®æœ€é©åŒ–
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨

2. **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**
   - ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã®ç¢ºèª
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç›£è¦–

---

## ãƒ†ã‚¹ãƒˆæ–¹é‡

### å˜ä½“ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ai/flows/__tests__/hybrid-cross-source-search-flow.test.ts`

```typescript
describe('hybridCrossSourceSearchFlow', () => {
  it('should search both sources in parallel', async () => {
    const result = await hybridCrossSourceSearchFlow({
      query: 'test query',
      sources: ['confluence', 'jira'],
      topK: 10,
    });
    
    expect(result.results.length).toBeGreaterThan(0);
    expect(result.sourceBreakdown.confluence).toBeGreaterThan(0);
    expect(result.sourceBreakdown.jira).toBeGreaterThan(0);
  });
  
  it('should normalize scores across sources', async () => {
    // ã‚¹ã‚³ã‚¢æ­£è¦åŒ–ã®ãƒ†ã‚¹ãƒˆ
  });
  
  it('should ensure at least one result from each source', async () => {
    // Source-aware Diversificationã®ãƒ†ã‚¹ãƒˆ
  });
});
```

### çµ±åˆãƒ†ã‚¹ãƒˆ

Genkit Dev UIã‚’ä½¿ç”¨ã—ã¦ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆï¼š

1. æ§˜ã€…ãªã‚¯ã‚¨ãƒªã§æ¨ªæ–­æ¤œç´¢ã‚’å®Ÿè¡Œ
2. çµæœã®å“è³ªã‚’ç¢ºèª
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®š

### E2Eãƒ†ã‚¹ãƒˆ

Playwrightã‚’ä½¿ç”¨ã—ã¦ã€UIã‹ã‚‰ã®æ¨ªæ–­æ¤œç´¢ã‚’ãƒ†ã‚¹ãƒˆï¼š

```typescript
test('should display cross-source search results', async ({ page }) => {
  await page.goto('/chat');
  await page.click('text=æ¨ªæ–­æ¤œç´¢');
  await page.fill('input[placeholder*="è³ªå•"]', 'ä¼šå“¡ç®¡ç†ã®ãƒã‚°ä¿®æ­£çŠ¶æ³ã¯ï¼Ÿ');
  await page.click('button[type="submit"]');
  
  // çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  await expect(page.locator('.search-result')).toHaveCount(10);
  
  // Confluenceã¨Jiraã®ä¸¡æ–¹ã®çµæœãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  const sources = await page.locator('.source-badge').allTextContents();
  expect(sources).toContain('Confluence');
  expect(sources).toContain('Jira');
});
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

### æ¤œç´¢æ™‚é–“

- **ç›®æ¨™**: P95 < 2ç§’ï¼ˆå€‹åˆ¥æ¤œç´¢ã®2å€ä»¥å†…ï¼‰
- **ä¸¦åˆ—æ¤œç´¢**: ä¸¡æ–¹ã®ã‚½ãƒ¼ã‚¹ã‚’ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ç›´åˆ—å®Ÿè¡Œã®2å€ã®æ™‚é–“ã‚’é¿ã‘ã‚‹

### ã‚¹ã‚³ã‚¢æ­£è¦åŒ–

- **ç›®æ¨™**: æ­£è¦åŒ–å‡¦ç†æ™‚é–“ < 100ms
- **æœ€é©åŒ–**: å¤§é‡çµæœã®å ´åˆã§ã‚‚é«˜é€Ÿã«å‡¦ç†

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

- **ç›®æ¨™**: æ¤œç´¢çµæœã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ < 10MBï¼ˆtopK=10ã®å ´åˆï¼‰

---

## å°†æ¥ã®æ‹¡å¼µ

### 1. é«˜åº¦ãªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

- Z-scoreæ­£è¦åŒ–ã®å®Ÿè£…
- ã‚½ãƒ¼ã‚¹åˆ¥ã®é‡ã¿ä»˜ã‘ï¼ˆä¾‹: Confluence 60%, Jira 40%ï¼‰

### 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ‹¡å¼µ

- æ—¥ä»˜ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆJiraï¼‰
- ãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆConfluenceï¼‰

### 3. ã‚½ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³

- ã‚¹ã‚³ã‚¢é †ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- æ›´æ–°æ—¥é †
- ä½œæˆæ—¥é †

### 4. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

- å¤§é‡çµæœã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Confluence / Jira çµ±åˆè¨ˆç”»](./06.01.01-confluence-jira-integration-plan.md)
- [Genkitåˆ©ç”¨æ–¹é‡](./03.01.01-genkit-design.md)
- [Jiraæ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸](../02-specifications/02.03-jira-spec.md)
- [ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ä»•æ§˜](./02.01.02-hybrid-search-specification.md)

---

## æ›´æ–°å±¥æ­´

- **2025å¹´1æœˆ**: åˆç‰ˆä½œæˆï¼ˆGenkit Flowæ´»ç”¨ç‰ˆã®å®Ÿè£…æ–¹é‡ã‚’æ•´ç†ï¼‰

