# アーキテクチャ仕様と実装コードの不整合レポート

**作成日**: 2025年1月27日  
**確認範囲**: `docs/01-architecture/` 配下の仕様書とコードベースの照合

---

## 📋 不整合サマリー

| # | 不整合項目 | 重大度 | 状態 | 詳細 |
|---|-----------|--------|------|------|
| 1 | Knowledge Graph拡張の仕様記載 | 中 | 要修正 | 仕様書に詳細が残っているが、コードでは無効化済み |
| 2 | Composite ScoringのKG重み | 低 | 注意 | KG拡張が無効だが、kgWeight=5%が設定されている |
| 3 | 検索重み配分の説明 | 低 | 注意 | 仕様書と実装は一致しているが、KG無効化の影響が不明確 |

---

## 1. Knowledge Graph拡張の仕様記載

### 不整合内容

**仕様書の記載**:
- `02.01.02-hybrid-search-specification.md` の311-365行目で、Knowledge Graph拡張の詳細が説明されている
- Phase 4の機能として、タイトル救済結果からのKG拡張ロジックが記載されている

**実装の状態**:
- コードではPhase 7でKG拡張が無効化されている
- `src/lib/lancedb-search-client.ts` の342-344行目:
  ```typescript
  // Phase 7最適化: KG拡張を無効化（9.2秒→0秒で大幅高速化）
  // KG拡張は高コスト・低効果のため一時的に無効化
  ```
- `src/lib/lancedb-search-client.ts` の731-736行目でもRRF-KG拡張が無効化されている

**README.mdの記載**:
- `01-architecture/README.md` の220-223行目で、KGは「🔴 無効化済み」と明記されている

### 推奨対応

**仕様書を更新**して以下を明確化する必要があります:

1. **KG拡張セクションに無効化ステータスを追記**
   - Phase 7で無効化された旨を明記
   - 無効化理由（パフォーマンス悪化）を記載
   - 将来のデュアルモード検索計画への言及を追加

2. **アーキテクチャ図の更新**
   - KG拡張のフローを「無効化済み」として表示
   - または、将来計画として別セクションに移動

### 影響範囲

- **低**: コードは正しく無効化されているため、機能への影響はなし
- **中**: 仕様書と実装の不整合により、開発者が混乱する可能性

---

## 2. Composite ScoringのKG重み

### 不整合内容

**実装の状態**:
- `src/lib/composite-scoring-service.ts` の58行目で `kgWeight: 0.05` (5%) が設定されている
- Composite Scoringの計算式（99行目）では `kgContribution` が計算されている
- しかし、KG拡張が無効化されているため、`signals.kgBoost` は常に0になる

**仕様書の記載**:
- `02.01.02-hybrid-search-specification.md` の87-89行目:
  ```
  BM25(50%) + タイトル(25%) + ラベル(15%)
  + ベクトル(5%) + KG(5%) = 100%
  ```

### 分析

**実際の動作**:
- KG拡張が無効化されているため、`kgBoost` は常に0
- その結果、実際の重み配分は:
  - BM25: 50%
  - タイトル: 25%
  - ラベル: 15%
  - ベクトル: 5%
  - **KG: 0%** (設定では5%だが、常に0)

**合計**: 95% (KG分が未使用)

### 推奨対応

1. **コードの改善**（オプション）:
   - KG拡張が無効化されている間は、KGの5%を他のコンポーネントに再配分
   - または、KG無効化時は重みを正規化（100%に調整）

2. **仕様書の更新**:
   - 現在の実装ではKGが無効化されているため、実際の重み合計は95%であることを明記
   - または、KG無効化時の重み再配分を説明

### 影響範囲

- **低**: 機能には影響なし（KGが無効化されているため）
- **低**: 重み合計が95%になるが、相対的なランキングには影響なし

---

## 3. 検索重み配分の説明

### 不整合内容

**仕様書の記載**:
- `README.md` の34-36行目:
  ```
  - BM25検索: Lunr.js + Kuromoji（最優先、50%）
  - タイトル救済検索: LanceDB LIKE検索（25%）
  - ラベルスコア: カテゴリ、ドメイン、優先度（15%）
  ```
- ベクトル検索とKGの重みが明示されていない（含まれているが明確ではない）

**実装の状態**:
- `composite-scoring-service.ts` の54-58行目:
  ```typescript
  vectorWeight: 0.05,   // ベクトル: 5%
  bm25Weight: 0.50,     // BM25: 50%
  titleWeight: 0.25,    // タイトル: 25%
  labelWeight: 0.15,    // ラベル: 15%
  kgWeight: 0.05,       // KG: 5%（無効化されているが設定は残っている）
  ```

### 推奨対応

**README.mdを更新**して、完全な重み配分を明記:

```
- ベクトル検索: Gemini Embedding 768次元（5%）
- BM25検索: Lunr.js + Kuromoji（最優先、50%）
- タイトル救済検索: LanceDB LIKE検索（25%）
- ラベルスコア: カテゴリ、ドメイン、優先度（15%）
- Knowledge Graph拡張: 🔴 無効化済み（設定値5%だが未使用）
```

### 影響範囲

- **低**: 実装は正しいが、説明が不完全

---

## 4. RRF融合の実装

### 確認結果

**仕様書の記載**:
- `02.01.02-hybrid-search-specification.md` の69-73行目で説明されている

**実装の状態**:
- `src/lib/lancedb-search-client.ts` の675行目で `enableRRF: true` が設定されている
- `src/lib/unified-search-result-processor.ts` でRRF融合が実装されている
- **✅ 不整合なし**: 仕様書と実装が一致している

---

## 5. Composite Scoringの実装

### 確認結果

**仕様書の記載**:
- `02.01.02-hybrid-search-specification.md` の87-93行目で説明されている

**実装の状態**:
- `src/lib/composite-scoring-service.ts` で実装されている
- `src/lib/lancedb-search-client.ts` の743-799行目で使用されている
- **✅ 不整合なし**: 仕様書と実装が一致している

---

## 📝 推奨される修正事項（優先度順）

### 優先度: 高（必須）

なし

### 優先度: 中（推奨）

1. **`02.01.02-hybrid-search-specification.md` の更新**
   - Knowledge Graph拡張セクション（311-365行目）に無効化ステータスを追記
   - 無効化理由と将来計画を明記

2. **`README.md` の更新**
   - 検索エンジンの重み配分セクションに、ベクトル検索とKGの重みを明記
   - KG無効化の注記を追加

### 優先度: 低（任意）

1. **`composite-scoring-service.ts` の改善**（オプション）
   - KG無効化時に重みを再配分するか、正規化する
   - または、KG無効化時はkgWeightを0に設定するロジックを追加

---

## 📊 不整合の統計

- **重大な不整合**: 0件
- **中程度の不整合**: 1件（KG拡張の仕様記載）
- **軽微な不整合**: 2件（重み配分の説明、KG重みの設定）
- **不整合なし（確認済み）**: 2件（RRF融合、Composite Scoring）

---

## 🔍 追加確認事項

以下の項目は、今回の確認範囲外ですが、将来的に確認することを推奨します:

1. **タイトル救済検索の実装**
   - 仕様書の説明と実装が一致しているか
   - タイトル候補生成ロジックの動作確認

2. **ラベルフィルタリング**
   - アーカイブ除外、議事録除外の実装確認
   - StructuredLabelとの統合状況

3. **キャッシュ戦略**
   - キャッシュのTTLとサイズが仕様と一致しているか
   - キャッシュキーの生成ロジック

---

**レポート作成者**: AI Assistant  
**確認日**: 2025年1月27日  
**次のレビュー推奨日**: 機能追加または仕様変更時

