# コンテキスト抽出方法の比較分析 (2025-11-21)

**作成日**: 2025年11月21日  
**ステータス**: 📋 比較分析完了

---

## 📊 概要

現在のコンテキスト抽出方法が、一般的なRAGシステムと比較してどの程度標準的か、または特殊かを分析します。

---

## 🔍 一般的なRAGシステムのコンテンツ抽出方法

### 1. シンプルなランクベース抽出 ✅ **基本的・最も一般的**

**説明**:
- 検索結果の上位N件から、固定サイズで抽出
- シンプルで実装が容易

**実装例**:
```typescript
const topResults = searchResults.slice(0, 5);
const context = topResults.map(result => result.content.substring(0, 500)).join('\n\n');
```

**特徴**:
- すべてのドキュメントに同じ文字数制限を適用
- ドキュメントの先頭から固定文字数を取得
- 実装が簡単でパフォーマンスが良い

**使用ケース**:
- シンプルなRAGシステム
- プロトタイプ
- パフォーマンスが重要な場合

**評価**: ✅ **標準的・一般的**

---

### 2. キーワードマッチング抽出 ✅ **標準的**

**説明**:
- クエリのキーワードに基づいて、関連する部分を抽出
- ドメイン知識を活用

**実装例**:
```typescript
const keywords = extractKeywords(query);
const extractedContent = extractRelevantContent(content, keywords, maxLength);
```

**特徴**:
- キーワード周辺のテキストを抽出
- ドメイン知識を活用したキーワード抽出
- 固定または動的な文字数制限

**使用ケース**:
- ドメイン特化型RAGシステム
- 専門用語が多い場合
- キーワード検索が重要な場合

**評価**: ✅ **標準的・一般的**

---

### 3. ハイブリッド抽出 ✅ **標準的・推奨**

**説明**:
- ランクベース抽出 + キーワードマッチング
- 複数のアプローチを組み合わせる

**実装例**:
```typescript
// 先頭から固定文字数を取得
let extracted = content.substring(0, maxLength);

// キーワード周辺を追加
const keywords = extractKeywords(query);
if (hasOutOfRangeKeywords(content, keywords, maxLength)) {
  const keywordContent = extractKeywordContent(content, keywords);
  extracted = combineHeadAndKeyword(headContent, keywordContent, maxLength);
}
```

**特徴**:
- 先頭部分とキーワード周辺を組み合わせ
- 固定または動的な文字数制限
- ランキングに関係なく同じ方法を適用

**使用ケース**:
- 本番環境のRAGシステム
- バランスの取れた情報抽出が必要な場合
- パフォーマンスと精度のバランスが重要な場合

**評価**: ✅ **標準的・推奨**

---

### 4. ランキングベースの動的文字数制限 ✅ **一般的・高度**

**説明**:
- 検索結果のランキングに応じて、各ドキュメントの文字数制限を動的に設定
- 上位のドキュメントにより多くの文字数を割り当て

**実装例**:
```typescript
const maxLength = index === 0 ? 2000 : index === 1 ? 1500 : index === 2 ? 1000 : 500;
const extracted = content.substring(0, maxLength);
```

**特徴**:
- ランキングが高いドキュメントに多くの文字数を割り当て
- 固定または動的な文字数制限
- 一般的には先頭から取得

**使用ケース**:
- 本番環境のRAGシステム
- 重要度に応じた情報抽出が必要な場合
- パフォーマンスと精度のバランスが重要な場合

**評価**: ✅ **一般的・高度な実装**

---

## 🔍 現在の実装の特徴

### 現在の実装

**実装場所**: 
- `src/ai/flows/streaming-summarize-confluence-docs.ts:299-314`
- `src/ai/flows/content-extraction-utils.ts:143-311`

**特徴**:

1. **ランキングベースの動的文字数制限** ✅ **一般的**
   ```typescript
   const maxLength = 
     index === 0 ? 1400 :      // 1位: 1400文字
     index === 1 ? 1260 :      // 2位: 1260文字
     index === 2 ? 1120 :      // 3位: 1120文字
     index < 6 ? 800 :         // 4-6位: 800文字
     index < 10 ? 700 :        // 7-10位: 700文字
     500;                      // 11-12位: 500文字
   ```

2. **ハイブリッド方式によるコンテンツ抽出** ✅ **標準的**
   - 先頭取得: 固定800文字
   - キーワード周辺取得: 固定600文字
   - ランキングに応じた比率で`maxLength`を分配

3. **ランキングに応じた比率の動的調整** ⚠️ **やや特殊**
   - 1位（rank=0）: 先頭:キーワード = **7:3**
   - 10位（rank=9）: 先頭:キーワード = **3:7**
   - 線形補間: `headRatio = 0.7 - (rank / 9) * 0.4`

---

## 📊 比較分析

### 現在の実装 vs 一般的な実装

| 項目 | 一般的な実装 | 現在の実装 | 評価 |
|------|------------|-----------|------|
| **ランキングベースの文字数制限** | 固定文字数（例: 500文字）または動的（例: 1位2000文字、2位1500文字） | 動的（1位1400文字、2位1260文字、...） | ✅ **一般的** |
| **コンテンツ抽出方式** | 先頭から取得、またはキーワード周辺取得 | ハイブリッド方式（先頭 + キーワード周辺） | ✅ **標準的・推奨** |
| **ランキングに応じた比率** | 一般的には固定比率 | 動的比率（1位は先頭優先、12位はキーワード優先） | ⚠️ **やや特殊** |
| **固定範囲と動的比率の組み合わせ** | 一般的には固定範囲または固定比率 | 固定範囲（先頭800文字、キーワード600文字）+ 動的比率 | ⚠️ **やや特殊** |

---

## 🎯 評価結果

### 1. ランキングベースの文字数制限 ✅ **一般的**

**評価**: 一般的な実装です。

**理由**:
- 多くのRAGシステムで採用されている手法
- 上位のドキュメントに多くの文字数を割り当てることは標準的
- 実装の複雑さも標準的

**参考**: TextRankアルゴリズムなど、ランキングベースの情報抽出は一般的です。

---

### 2. ハイブリッド方式によるコンテンツ抽出 ✅ **標準的・推奨**

**評価**: 標準的で推奨される実装です。

**理由**:
- 先頭取得とキーワード周辺取得の組み合わせは一般的
- 多くの本番環境のRAGシステムで採用されている
- バランスの取れた情報抽出が可能

**参考**: 
- 多くのRAGシステムで採用されている手法
- 先頭部分（概要）とキーワード周辺（関連情報）の両方を取得することで、情報の完全性が向上

---

### 3. ランキングに応じた比率の動的調整 ⚠️ **やや特殊・高度**

**評価**: やや特殊ですが、合理的な実装です。

**特徴**:
- **1位（rank=0）**: 先頭:キーワード = **7:3**（先頭優先）
  - 理由: 上位ドキュメントは概要が重要
  - 実装: `headRatio = 0.7`

- **10位（rank=9）**: 先頭:キーワード = **3:7**（キーワード優先）
  - 理由: 下位ドキュメントは関連性が重要
  - 実装: `headRatio = 0.3`

- **線形補間**: ランキングに応じて比率を調整
  - 実装: `headRatio = 0.7 - (rank / 9) * 0.4`

**評価**:
- ✅ **合理的**: ランキングが高いドキュメントは概要を重視し、低いドキュメントは関連性を重視するのは合理的
- ⚠️ **やや特殊**: 一般的な実装では、比率が固定（例: 5:5）の場合が多い
- ✅ **高度**: ランキングに応じた動的調整により、より洗練された情報抽出が可能

---

### 4. 固定範囲と動的比率の組み合わせ ⚠️ **やや特殊・複雑**

**評価**: やや特殊で複雑ですが、効果的な実装です。

**特徴**:
- **固定範囲**: 先頭800文字、キーワード周辺600文字（ランキングに関係なく）
- **動的比率**: ランキングに応じて`maxLength`を先頭とキーワード周辺に分配

**問題点**:
- 実装が複雑（固定範囲と動的比率の両方を考慮）
- 理解しにくい（固定範囲と動的比率が混在）

**利点**:
- 先頭部分とキーワード周辺の範囲を保証（固定範囲）
- ランキングに応じた最適な配分（動的比率）

**評価**:
- ⚠️ **やや特殊**: 一般的な実装では、固定範囲または固定比率のいずれかを使用
- ✅ **効果的**: 先頭部分とキーワード周辺の両方を適切に取得可能
- ⚠️ **複雑**: 実装と理解の複雑さが増加

---

## 🔍 一般的な実装との比較

### 一般的な実装（パターン1: シンプル）

```typescript
// すべてのドキュメントに同じ文字数制限
const maxLength = 800;
const extracted = content.substring(0, maxLength);
```

**特徴**: シンプル、実装が容易、パフォーマンスが良い

---

### 一般的な実装（パターン2: ランキングベース）

```typescript
// ランキングに応じた動的文字数制限
const maxLength = index === 0 ? 2000 : index === 1 ? 1500 : 1000;
const extracted = content.substring(0, maxLength);
```

**特徴**: ランキングベースの文字数制限、先頭から取得

---

### 一般的な実装（パターン3: ハイブリッド）

```typescript
// 先頭とキーワード周辺を組み合わせ
const headContent = content.substring(0, 600);
const keywordContent = extractKeywordContent(content, keywords, 400);
const extracted = combineHeadAndKeyword(headContent, keywordContent, 800);
```

**特徴**: ハイブリッド方式、固定比率（例: 6:4）

---

### 現在の実装（パターン4: 高度なハイブリッド）

```typescript
// ランキングに応じた動的文字数制限
const maxLength = index === 0 ? 1400 : index === 1 ? 1260 : ...;

// ランキングに応じた動的比率で先頭とキーワード周辺を分配
const headRatio = 0.7 - (normalizedRank / 9) * 0.4;
const keywordRatio = 1.0 - headRatio;
const headLength = Math.floor(maxLength * headRatio);
const keywordLength = Math.floor(maxLength * keywordRatio);

// 固定範囲（先頭800文字、キーワード600文字）を考慮して抽出
const extracted = extractRelevantContentMultiKeyword(content, query, maxLength, index);
```

**特徴**: 
- ランキングベースの動的文字数制限 ✅ 一般的
- ハイブリッド方式 ✅ 標準的
- ランキングに応じた動的比率 ⚠️ やや特殊
- 固定範囲と動的比率の組み合わせ ⚠️ やや特殊・複雑

---

## ✅ 総合評価

### 現在の実装の評価

| 項目 | 評価 | 詳細 |
|------|------|------|
| **ランキングベースの文字数制限** | ✅ **一般的** | 多くのRAGシステムで採用されている |
| **ハイブリッド方式** | ✅ **標準的・推奨** | 先頭とキーワード周辺の組み合わせは標準的 |
| **ランキングに応じた動的比率** | ⚠️ **やや特殊・高度** | 一般的には固定比率だが、合理的な実装 |
| **固定範囲と動的比率の組み合わせ** | ⚠️ **やや特殊・複雑** | 一般的ではないが、効果的な実装 |

**総合評価**: 
- **基本的な部分**: ✅ **一般的・標準的**
- **高度な部分**: ⚠️ **やや特殊だが合理的・効果的**

---

## 🎯 結論

### 1. 基本的な部分は一般的 ✅

- **ランキングベースの文字数制限**: 一般的な実装
- **ハイブリッド方式**: 標準的で推奨される実装

### 2. 高度な部分はやや特殊だが合理的 ⚠️

- **ランキングに応じた動的比率**: 一般的ではないが、合理的な実装
- **固定範囲と動的比率の組み合わせ**: やや特殊だが、効果的な実装

### 3. 実装の複雑さ

- **一般的な実装**: シンプルで理解しやすい
- **現在の実装**: 複雑だが、より洗練された情報抽出が可能

### 4. 推奨事項

**現在の実装を維持する場合**:
- ✅ 効果的な情報抽出が可能
- ⚠️ 実装の複雑さを理解する必要がある

**シンプル化する場合**:
- ✅ 実装が簡単で理解しやすい
- ⚠️ 情報抽出の精度が若干低下する可能性

---

## 📝 参考資料

- [RAGにおけるコンテンツ抽出のベストプラクティス](./../99-archive/implementation/analysis-reports/rag-content-extraction-best-practices.md)
- [コンテキスト取り込みロジックの詳細仕様](./CONTEXT_EXTRACTION_LOGIC_2025-11-21.md)
- [ハイブリッド検索システム仕様](./02.01.02-hybrid-search-specification.md)

