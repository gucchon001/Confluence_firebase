# 最終クリーンアップと再アップロードガイド

## 問題の概要

### ビルドエラーの原因
- **エラー**: `ApiError: No such object: confluence-copilot-data/lancedb/confluence.lance/_transactions/237-71a65126-f505-42bf-b798-31665b0a59b7.txn`
- **原因**: ローカルで作成されたLanceDBデータベースのトランザクションファイルがCloud Storageに存在しない
- **影響**: prebuildスクリプトが失敗し、ビルド全体が停止

### 根本原因
- ローカルでインデックス作成後に生成されたトランザクションファイルがCloud Storageにアップロードされていない
- ローカルのデータベース構造とCloud Storage上のデータが不一致

## 解決手順

### Phase 1: ローカルデータベースの確認

```bash
# ローカルデータベースの状態を確認
npm run prepare:production
```

**確認ポイント**:
- ✅ `page_id`フィールドが存在する
- ✅ `pageId`フィールドが存在しない
- ✅ クエリが高速（< 100ms）
- ✅ すべてのファイルが存在する

### Phase 2: Cloud Storageの完全クリーンアップ

#### ステップ1: 削除対象の確認（DRY RUN）

```bash
# 削除対象を確認（実際の削除は行わない）
npm run cleanup:lancedb-completely
```

**確認ポイント**:
- 削除対象のファイル数
- 削除対象のサイズ
- カテゴリ別の内訳

#### ステップ2: 完全削除の実行

```bash
# 実際に削除を実行
npm run cleanup:lancedb-completely -- --execute
```

**⚠️ 警告**: この操作は不可逆です。実行前に以下を確認してください：
1. ローカルに最新のデータベースがあること
2. 最新のデータベースを再アップロードする準備ができていること
3. 必要に応じてバックアップを取得していること

### Phase 3: 最新データベースの完全再アップロード

#### ステップ1: ローカルデータベースの再確認

```bash
# 再確認
npm run prepare:production
```

#### ステップ2: Cloud Storageへの完全アップロード

```bash
# すべてのファイルをアップロード（差分ではなく完全同期）
npm run upload:production-data
```

**確認ポイント**:
- アップロードが成功した
- エラーが発生していない
- ファイル数が想定通り（約20-30ファイル）
- すべてのトランザクションファイルが含まれている

### Phase 4: 再デプロイ

```bash
# コードをコミット・プッシュ（必要に応じて）
git add .
git commit -m "fix: clean up Cloud Storage and reupload latest database"
git push
```

## 注意事項

### ⚠️ 重要な警告

1. **完全削除は不可逆**
   - 一度削除したファイルは復元できない
   - 必ずローカルに最新データベースがあることを確認

2. **ダウンタイムの可能性**
   - クリーンアップ中はビルドが失敗する可能性がある
   - アップロード完了後、正常にビルドできるようになる

3. **バックアップの推奨**
   - Cloud Storageのスナップショットを取得することを推奨
   - または、ローカルバックアップを確認

## 成功基準

以下の条件がすべて満たされれば成功：

1. ✅ Cloud Storage上の古いファイルが完全に削除された
2. ✅ 最新のデータベースがCloud Storageに完全にアップロードされた
3. ✅ ビルドが成功した（404エラーが発生しない）
4. ✅ 本番環境で正常に動作している

## トラブルシューティング

### エラー: ファイルが見つからない

**原因**: ローカルのファイルとCloud Storageのファイルが不一致

**解決策**:
1. ローカルでデータベースを再構築
2. すべてのファイルを再アップロード

### エラー: 削除に失敗

**原因**: 権限の問題やネットワークエラー

**解決策**:
1. gcloudの認証を確認
2. Cloud Consoleから手動で削除

## 参考資料

- [Cloud Storageクリーンアップガイド](./cloud-storage-cleanup-guide.md)
- [本番環境への適用準備計画](./production-deployment-plan.md)

