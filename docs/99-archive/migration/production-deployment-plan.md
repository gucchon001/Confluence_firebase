# 本番環境への適用準備計画

## 概要

`pageId` → `page_id`マイグレーションを本番環境に適用するための手順書です。

## 前提条件

### ✅ 完了項目
- [x] ローカル環境でのマイグレーション成功
- [x] ローカル環境でのテスト成功
- [x] ログ分析完了（エラーなし）
- [x] パフォーマンステスト成功（平均5.40ms）

## 本番環境への適用手順

### Phase 1: 準備（推奨: 事前に実施）

#### 1.1 本番データベースのバックアップ確認
```bash
# 本番環境のデータベースをCloud Storageからダウンロード
npm run download:production-data
```

#### 1.2 本番データベースの状態確認
```bash
# ローカルにダウンロードした本番データベースの状態を確認
npm run lancedb:check-indexes
```

**確認ポイント**:
- 総行数が想定通りか
- 現在のスキーマ（pageIdフィールド）を確認
- インデックスの状態を確認

### Phase 2: 本番データベースのマイグレーション

#### 2.1 本番データベースをローカルにダウンロード（オプション）
```bash
# 安全のため、本番データベースをローカルにダウンロード
npm run download:production-data
```

#### 2.2 ローカル環境で本番データベースをマイグレーション（オプション）
```bash
# ダウンロードした本番データベースをマイグレーション
# 注意: この場合、ローカル環境の.lancedbを本番データで置き換える必要がある
```

**または、本番環境で直接マイグレーションを実行**:
- Cloud Buildでマイグレーションスクリプトを実行
- または、本番環境に一時的にアクセスしてマイグレーションを実行

#### 2.3 マイグレーション後の確認
```bash
# マイグレーション後の状態を確認
npm run lancedb:check-indexes
```

**確認ポイント**:
- `page_id`フィールドが存在する
- `pageId`フィールドが存在しない
- `page_id`スカラーインデックスが作成されている

### Phase 3: データの再構築とアップロード

#### 3.1 マイグレーション済みデータベースの確認
```bash
# ローカル環境でマイグレーション済みデータベースを確認
npm run test:get-all-chunks-page-id
```

#### 3.2 マイグレーション済みデータベースをCloud Storageにアップロード
```bash
# マイグレーション済みデータベースをCloud Storageにアップロード
npm run upload:production-data
```

**確認ポイント**:
- アップロードが成功した
- Cloud Storage上のファイルサイズが想定通りか
- ファイル数が想定通りか

### Phase 4: アプリケーションのデプロイ

#### 4.1 コードのコミットとプッシュ
```bash
# 変更をコミット
git add .
git commit -m "feat: migrate pageId to page_id for scalar index support"

# リモートにプッシュ
git push
```

#### 4.2 Firebase App Hostingへのデプロイ
```bash
# Firebase App Hostingにデプロイ
firebase deploy --only hosting:app
```

または、GitHub連携を使用している場合:
- 変更をpushすると自動デプロイが開始されます

#### 4.3 デプロイ後の確認
- [ ] デプロイが成功した
- [ ] アプリケーションが正常に起動した
- [ ] エラーログがない

### Phase 5: 本番環境での動作確認

#### 5.1 パフォーマンス確認
- ベクトル検索のレスポンス時間
- `getAllChunksByPageId`のレスポンス時間
- 期待値: < 100ms

#### 5.2 機能確認
- [ ] 検索機能が正常に動作する
- [ ] チャンク取得が正常に動作する
- [ ] エラーが発生していない

#### 5.3 ログ確認
- Cloud Loggingでエラーログを確認
- `page_id`関連のエラーがないことを確認
- パフォーマンスログを確認

## 注意事項

### ⚠️ 重要な警告

1. **本番データベースのバックアップ**
   - マイグレーション前に必ずバックアップを取得
   - Cloud Storage上のデータもバックアップを推奨

2. **ダウンタイム**
   - マイグレーション中はダウンタイムが発生する可能性があります
   - メンテナンスウィンドウを設定することを推奨

3. **ロールバック計画**
   - 問題が発生した場合のロールバック手順を準備
   - バックアップからの復元手順を確認

### 🔄 ロールバック手順

問題が発生した場合:

1. **コードのロールバック**
   ```bash
   git revert <commit-hash>
   git push
   ```

2. **データベースの復元**
   - Cloud Storageのバックアップから復元
   - または、ローカルバックアップから復元

## チェックリスト

### デプロイ前
- [ ] ローカル環境でのテスト完了
- [ ] ログ分析完了（エラーなし）
- [ ] 本番データベースのバックアップ取得
- [ ] マイグレーションスクリプトの確認
- [ ] デプロイ手順の確認

### デプロイ中
- [ ] 本番データベースのマイグレーション実行
- [ ] マイグレーション後の確認
- [ ] データベースのアップロード
- [ ] アプリケーションのデプロイ

### デプロイ後
- [ ] 本番環境での動作確認
- [ ] パフォーマンス確認
- [ ] エラーログの確認
- [ ] 問題がないことを確認

## 成功基準

以下の条件がすべて満たされれば成功とみなします：

1. ✅ マイグレーションが完了した
2. ✅ 本番環境でエラーが発生していない
3. ✅ パフォーマンスが改善されている（< 100ms）
4. ✅ すべての機能が正常に動作している

## 次のステップ

本番環境への適用準備が完了したら、実際のデプロイを実行します。

