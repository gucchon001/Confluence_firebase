# プロンプト設計書: Confluence仕様書要約チャットボット

## 更新履歴
- **2025年1月**: 現在の実装状況を反映
  - ストリーミング機能との統合
  - マークダウン表示の要件追加
  - Gemini 2.5 Flashモデル対応

## 1. 概要

本ドキュメントは、LLM (大規模言語モデル) に与えるプロンプト（指示文）の設計を定義する。
AIの回答の品質、一貫性、安全性を確保し、継続的な改善を可能にすることを目的とする。

### 現在の実装状況（2025年1月）
- **LLM**: Google AI Gemini API (gemini-2.5-flash)
- **ストリーミング**: リアルタイム回答生成とプログレス表示
- **マークダウン**: 高度な正規化とテーブル表示機能
- **認証**: Firebase Authentication + @tomonokai-corp.com ドメイン制限

## 2. 設計方針

* **役割の明確化**: AIに「社内アシスタント」としての役割を明確に与える。
* **情報源の限定**: 回答は、提供されたConfluenceの文書（コンテキスト）のみを根拠とするよう厳しく指示し、憶測による回答を防ぐ。
* **出典の明記**: 回答には、根拠となった情報の参照元URLを必ず含めるよう義務付ける。
* **簡潔な回答**: ユーザーが求める情報を簡潔に要約して提示することを基本とする。
* **メタデータの活用**: ラベル情報やスペース情報などのメタデータを活用して回答の質を向上させる。
* **マークダウン形式**: 回答は適切なマークダウン形式で構造化し、見出し、箇条書き、テーブルなどを活用する。
* **ストリーミング対応**: リアルタイムでの回答生成を考慮した設計。

## 3. プロンプトテンプレート

実際にLLMに送信するプロンプトは、以下のテンプレートに基づいて動的に生成する。

```handlebars
# 指示 (Instructions)
あなたは、社内のConfluenceに書かれた仕様書に関する質問に答える、優秀なAIアシスタントです。
以下のルールを厳格に守って、ユーザーの質問に回答してください。

# ルール (Rules)
1. 回答は、必ず「提供された参考情報」セクションの記述のみを根拠としてください。
2. 「提供された参考情報」に質問と関連する記述がない場合は、情報をでっち上げたりせず、正直に「参考情報の中に関連する記述が見つかりませんでした。」と回答してください。
3. 回答は、ユーザーの質問に対して簡潔かつ明確に要約してください。
4. 回答の最後には、根拠として利用した情報の出典を「参照元」として、タイトル、スペース名、最終更新日、URLのリスト形式で必ず記載してください。
5. ユーザーからの挨拶や感謝には、フレンドリーに返答してください。
6. 提供された参考情報にあるラベルやスペース情報も活用して、より関連性の高い回答を提供してください。

# 提供された参考情報 (Context)
{{context}}

# 会話履歴 (Chat History)
{{chat_history}}

# ユーザーの質問 (Question)
{{question}}
```

### 3.1 テンプレート変数

| 変数名           | 内容                                                                                                                               |
| :--------------- | :--------------------------------------------------------------------------------------------------------------------------------- |
| `{{context}}`      | ベクトルデータベースから検索してきた、ユーザーの質問に関連性の高い仕様書の内容（チャンク）。複数のチャンクを改行で区切って挿入する。<br>例: `[Title: {title}, URL: {url}, Space: {spaceName}, Updated: {lastUpdated}, Labels: {labels}]\n{content}` |
| `{{chat_history}}` | 現在の会話の直近のやり取りの履歴。文脈を理解した深掘り質問に答えるために使用する。<br>例: `User: ...\nAI: ...`                            |
| `{{question}}`     | ユーザーが入力した最新の質問文。                                                                                                   |

### 3.2 コンテキスト形式

各チャンクのコンテキストは以下の形式で提供される：

```
[Title: ページタイトル, URL: ページURL, Space: スペース名, Updated: 更新日時, Labels: ラベル1, ラベル2]
チャンクのテキスト内容
```

## 4. プロンプトチューニングの方針

### 4.1 最適化ポイント

1. **関連性の向上**
   - ラベル情報を活用したフィルタリング
   - スペース情報に基づく文脈理解
   - 更新日時を考慮した情報の鮮度評価

2. **回答品質の向上**
   - 簡潔さと情報量のバランス調整
   - 専門用語の適切な説明
   - 回答構造の一貫性確保

3. **出典表示の改善**
   - 複数の参照元がある場合の表示方法
   - 参照元の重要度に基づく順序付け
   - スペース名と更新日時の表示形式

### 4.2 評価指標

| 指標 | 説明 | 目標値 |
|------|------|--------|
| 忠実性 (Faithfulness) | 回答が提供されたコンテキストに忠実か | 4.5/5.0以上 |
| 関連性 (Relevance) | 回答が質問に関連しているか | 4.5/5.0以上 |
| 情報量 (Informativeness) | 回答の充実度 | 4.0/5.0以上 |
| 一貫性 (Coherence) | 回答の論理的一貫性 | 4.5/5.0以上 |
| 簡潔性 (Conciseness) | 回答の簡潔さ | 4.0/5.0以上 |

## 5. プロンプトの例

### 例1: 初回の質問

* **ユーザー質問**: `求人詳細機能の仕様を知りたい`
* **検索されたコンテキスト**: 
  ```
  [Title: 求人詳細画面仕様書, URL: https://your-confluence.atlassian.net/wiki/spaces/PROJ/pages/123, Space: プロジェクト仕様, Updated: 2023-12-01, Labels: 機能要件, 画面仕様]
  求人詳細機能は、主に求人情報の表示エリアと応募ボタンで構成されています。表示されるデータ項目には、職種名、給与、勤務地などが含まれます。
  
  [Title: 求人データモデル定義, URL: https://your-confluence.atlassian.net/wiki/spaces/ARCH/pages/45, Space: アーキテクチャ, Updated: 2023-11-15, Labels: データモデル, 設計]
  求人データは、JobPostingテーブルで管理され、title（職種名）、salary（給与）、location（勤務地）、description（詳細）などのフィールドを持ちます。
  ```
* **生成されるAIの回答 (期待値)**:
  > 求人詳細機能は、主に求人情報の表示エリアと応募ボタンで構成されています。表示されるデータ項目には、職種名、給与、勤務地などが含まれます。これらのデータはJobPostingテーブルで管理されており、title（職種名）、salary（給与）、location（勤務地）、description（詳細）などのフィールドを持っています。
  > 
  > **参照元:**
  > 
  > * [求人詳細画面仕様書](https://your-confluence.atlassian.net/wiki/spaces/PROJ/pages/123) - プロジェクト仕様, 2023-12-01
  > * [求人データモデル定義](https://your-confluence.atlassian.net/wiki/spaces/ARCH/pages/45) - アーキテクチャ, 2023-11-15

### 例2: 関連情報がない場合

* **ユーザー質問**: `このサービスのマーケティング戦略は？`
* **検索されたコンテキスト**: (関連する仕様書が見つからなかったため、空)
* **生成されるAIの回答 (期待値)**:
  > 申し訳ありませんが、提供された参考情報の中に関連する記述が見つかりませんでした。仕様書に関する質問をお試しください。

### 例3: ラベル情報を活用した回答

* **ユーザー質問**: `非機能要件について教えて`
* **検索されたコンテキスト**:
  ```
  [Title: システム非機能要件, URL: https://your-confluence.atlassian.net/wiki/spaces/ARCH/pages/789, Space: アーキテクチャ, Updated: 2023-12-10, Labels: 非機能要件, セキュリティ]
  本システムの非機能要件として、セキュリティ、パフォーマンス、可用性の3つの観点から定義します。セキュリティ要件としては、すべての通信をHTTPSで行うこと、ユーザー認証にはOAuth2.0を使用することが定められています。
  
  [Title: パフォーマンス要件, URL: https://your-confluence.atlassian.net/wiki/spaces/ARCH/pages/790, Space: アーキテクチャ, Updated: 2023-12-15, Labels: 非機能要件, パフォーマンス]
  パフォーマンス要件として、ページ表示は3秒以内、API応答は1秒以内を目標とします。ピーク時のユーザー数は1000人を想定し、それに耐えうるシステム構成とします。
  ```
* **生成されるAIの回答 (期待値)**:
  > 本システムの非機能要件は、主に以下の3つの観点から定義されています：
  > 
  > 1. セキュリティ要件：すべての通信をHTTPSで行い、ユーザー認証にはOAuth2.0を使用します。
  > 
  > 2. パフォーマンス要件：ページ表示は3秒以内、API応答は1秒以内を目標としています。ピーク時のユーザー数は1000人を想定した構成になっています。
  > 
  > 3. 可用性要件：詳細は参考情報に含まれていませんでした。
  > 
  > **参照元:**
  > 
  > * [システム非機能要件](https://your-confluence.atlassian.net/wiki/spaces/ARCH/pages/789) - アーキテクチャ, 2023-12-10
  > * [パフォーマンス要件](https://your-confluence.atlassian.net/wiki/spaces/ARCH/pages/790) - アーキテクチャ, 2023-12-15

## 6. 今後の改善計画

1. **ラベルベースのフィルタリング強化**
   - ユーザーが特定のラベルに関する情報を求めている場合、そのラベルを持つドキュメントを優先的に使用

2. **スペース情報の活用**
   - 特定のスペースに関する質問の場合、そのスペースのドキュメントを優先

3. **更新日時の考慮**
   - 最新の情報を優先的に使用
   - 古い情報がある場合はその旨を明示

4. **回答形式の最適化**
   - 表形式データの適切な表示
   - コードブロックの適切なフォーマット
   - 箇条書きリストの活用