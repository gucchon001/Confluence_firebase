# ハイブリッド検索 クイックリファレンス

**最終更新**: 2025-10-17 | **Phase**: 4完了

---

## 🔍 検索コンポーネント

### 1️⃣ ベクトル検索
```
モデル: text-embedding-004 (768次元)
距離: コサイン類似度
閾値: maxDistance = 2.0
重み: 5%（ベクトル空間変化対策で最小化）
```

**特徴**:
- タイトル重複埋め込み（3回繰り返し）
- スマートチャンキング（1600文字、200文字オーバーラップ）

---

### 2️⃣ キーワード検索（BM25）
```
エンジン: Lunr.js + Kuromoji
アルゴリズム: Okapi BM25
索引サイズ: ~300MB
重み: 50%（最優先）
```

**特徴**:
- 転置索引による高速検索
- 日本語形態素解析対応
- スコア正規化（maxBm25Score = 30.0）

---

### 3️⃣ タイトル救済検索（Phase 4）
```
方式: LanceDB LIKE検索
候補生成: 1語、2語、3語組み合わせ
上限: 50件/候補
重み: 25%（タイトルマッチ）
```

**特徴**:
- タイトル候補自動生成
- 超強力スコアブースト（titleMatchRatio ≥ 0.9）
- `_titleBoosted`フラグ付与

---

### 4️⃣ Knowledge Graph拡張（Phase 4）
```
ストレージ: Firestore
ノードID: page-{pageId}
エッジ: reference/implements/related
重み: 5%
```

**拡張タイミング**:
1. タイトルブースト上位50件から
2. RRF上位10件から（漏れ対策）

**拡張パラメータ**:
- maxReferences: 3件/ページ
- minWeight: 0.7

---

## 📊 スコアリング

### 複合スコア計算式

```
最終スコア = 
  BM25スコア      × 50% +
  タイトルマッチ  × 25% +
  ラベルスコア    × 15% +
  ベクトルスコア  × 5% +
  KGブースト      × 5%
```

### 重み設定の理由

| コンポーネント | 重み | 理由 |
|--------------|------|------|
| BM25 | 50% | キーワード完全一致を最優先 |
| タイトル | 25% | タイトルマッチを強く評価 |
| ラベル | 15% | StructuredLabel品質管理 |
| ベクトル | 5% | 空間変化の影響を最小化 |
| KG | 5% | 参照関係による補完 |

---

## 🔄 検索フロー（簡略版）

```
1. 前処理
   ├─ キーワード抽出
   ├─ クエリ埋め込み生成
   └─ タイトル候補生成

2. 並列検索
   ├─ ベクトル検索（LanceDB）
   ├─ キーワード検索（Lunr）
   └─ タイトル救済検索（LIKE）

3. RRF融合
   └─ ランキング統合（k=60）

4. KG拡張（Phase 4）
   ├─ タイトルブースト上位50件 → KG参照追加
   └─ RRF上位10件 → KG参照追加（漏れ対策）

5. 複合スコアリング
   └─ 5つのシグナルを統合

6. 最終結果
   ├─ スコア降順ソート
   ├─ 重複排除
   └─ topK件返却
```

---

## ⚡ パフォーマンス

### レスポンス時間

| 状態 | 時間 |
|------|------|
| キャッシュヒット | ~5ms |
| キャッシュミス | ~800ms |

### 内訳（キャッシュミス時）

| フェーズ | 時間 |
|---------|------|
| ベクトル検索 | ~150ms |
| キーワード検索 | ~30ms |
| タイトル救済 | ~80ms |
| KG拡張 | ~250ms |
| スコアリング | ~50ms |
| その他 | ~240ms |

---

## 🎛️ 主要パラメータ

### 検索パラメータ

```typescript
interface LanceDBSearchParams {
  query: string;              // 必須
  topK?: number;              // デフォルト: 5
  maxDistance?: number;       // デフォルト: 2.0
  useLunrIndex?: boolean;     // デフォルト: true
  labelFilters?: {
    includeMeetingNotes?: boolean;  // デフォルト: false
    excludeLabels?: string[];
    includeLabels?: string[];
  };
}
```

### キャッシュ設定

```typescript
{
  ttl: 5 * 60 * 1000,         // 5分
  maxSize: 1000,              // 1000エントリ
  evictionStrategy: 'lru'     // LRU方式
}
```

---

## 🚨 重要な注意事項

### 1. LanceDB WHERE句の制約

```typescript
// ❌ ダブルクォートは動作しない
.where('"pageId" = \'123\'')

// ✅ バッククォートを使用
.where('`pageId` = \'123\'')
```

### 2. pageIdの型

```typescript
// LanceDBのint64はJavaScriptではstring
pageId: string  // "718373062"
```

### 3. KGノードID形式

```typescript
// Firestoreのノード
nodeId: "page-718373062"  // "page-"プレフィックス必須
```

---

## 📈 Phase 4の成果

### 改善結果

| 指標 | Phase 0A-4 | Phase 4 | 改善 |
|------|-----------|---------|------|
| Case 2発見率 | 0% | 100% | **+100%** |
| 全体発見率 | 75% | 100% | **+25%** |
| KG拡張発動 | - | 100% | **新機能** |

### テスト結果サマリー

```
✅ Case 1（教室コピー）:    100% (1/1) [KG: +13件]
✅ Case 2（教室削除）⭐:   100% (2/2) [KG: +16件]
✅ Case 3（会員退会）:      100% (1/1) [KG: +9件]

🎯 総合発見率: 100% (4/4)
🕸️  KG追加ページ合計: 38件
```

---

## 🔗 関連ドキュメント

- 📘 [完全版仕様書](./hybrid-search-specification-latest.md)
- 🏗️ [アーキテクチャ設計](./lancedb-firestore-integration-design.md)
- 🧪 [テスト実行ガイド](../test-execution-guide.md)
- 📊 [Phase 0A-2ロードマップ](./phase-0a-roadmap-final.md)

---

## 💡 よくある質問

### Q1: なぜベクトル検索の重みが5%と低いのか？

**A**: Phase 0A-2で70ページを除外したことでベクトル空間が変化し、ベクトル検索の精度が一時的に低下しました。再インデックス完了までBM25（50%）とタイトル（25%）を優先する戦略です。

### Q2: タイトル救済検索とは？

**A**: クエリからキーワードを抽出し、それらをタイトルに含むページを直接検索する機能です。「教室削除」というクエリから「教室」「削除」「教室削除」などの候補を生成し、タイトルのLIKE検索を実行します。

### Q3: KG拡張が2回実行されるのはなぜ？

**A**: 
1. **1回目**: タイトルブースト結果（上位50件）から拡張
2. **2回目**: RRF上位10件から拡張（タイトルブーストされなかった重要ページ対策）

これにより、ベクトル検索で低順位でも重要なページ（例: 164_教室削除機能）のKG参照を取得できます。

### Q4: RRFのk=60の意味は？

**A**: Reciprocal Rank Fusionの定数で、低順位結果の影響を調整します。`score = 1/(k + rank)`の式で、k=60は標準的な値です。

---

**最終更新日**: 2025-10-17  
**次回レビュー**: Phase 5開始時

