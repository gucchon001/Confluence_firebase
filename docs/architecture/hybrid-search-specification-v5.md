# ハイブリッド検索 仕様書 (Phase 5版)

## 📋 概要

本システムは、ベクトル検索・BM25検索・Knowledge Graph拡張を組み合わせた高精度なハイブリッド検索を実装しています。

**バージョン**: Phase 5  
**最終更新**: 2025-10-18  
**主要ファイル**: `src/lib/lancedb-search-client.ts`

---

## 🎯 設計目標

1. **高品質**: 発見率100%、Top 10発見率100%を達成
2. **高速**: キャッシュヒット時1-3秒、初回検索時5秒以内（目標）
3. **高精度**: クエリ関連ドメインキーワードの優先的ブースト

---

## 🔄 検索フロー全体図

```
┌─────────────────────────────────────────────────────────────┐
│ 1. キャッシュチェック (15分TTL, 最大5000件)                │
└─────────────────┬───────────────────────────────────────────┘
                  │ ヒット → 即座に返却 (1-3秒)
                  │ ミス → 検索実行
┌─────────────────┴───────────────────────────────────────────┐
│ 2. クエリ前処理                                              │
│    - キーワード抽出 (統一サービス使用)                       │
│    - ネガティブワード除去 (「について」「方法」等)           │
│    - 優先キーワード選定 (上位3個)                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 3. 【Phase 5】並列検索 (Promise.allSettled)                 │
│    ├─ ベクトル検索 (topK×10件)                              │
│    │   - 埋め込みベクトル生成                                │
│    │   - 距離閾値フィルタリング                              │
│    │   - ラベルフィルタリング                                │
│    │   - タイトルマッチブースト                              │
│    │                                                          │
│    └─ BM25検索 (Lunr.js使用)                                │
│        - 日本語トークナイズ                                  │
│        - TF-IDFスコア計算                                    │
│        - ラベルフィルタリング                                │
└─────────────────┬───────────────────────────────────────────┘
                  │ 並列実行完了 (平均50ms)
┌─────────────────┴───────────────────────────────────────────┐
│ 4. 【Phase 4】Knowledge Graph拡張 (第1段階)                 │
│    - タイトルマッチ結果の参照先を取得                        │
│    - バッチクエリで最大2件の参照先を追加                     │
│    - 重み付け: 直接参照1.0, 間接参照0.7                      │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 5. タイトル厳格一致候補の合流                                │
│    - ユーザー指定 + 自動生成タイトル候補                     │
│    - LIKE検索で部分一致を拾い上げ（救済検索）               │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 6. RRF (Reciprocal Rank Fusion) 融合                        │
│    - ベクトル順位 × 1.0                                      │
│    - BM25順位 × 0.8                                          │
│    - タイトル順位 × 1.2                                      │
│    - ラベル順位 × 0.6                                        │
│    - k=60で融合 (rrf = 1/(k+rank))                           │
│                                                              │
│    【Phase 5改善】ドメイン減衰・ブースト適用                 │
│    - 汎用文書減衰: ×0.5                                      │
│    - クエリ関連ドメインKWブースト: ×1.5～×2.0                │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 7. 【Phase 4】Knowledge Graph拡張 (第2段階)                 │
│    - RRF上位10件の参照先を取得                               │
│    - タイトルブースト漏れ対策                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 8. 【Phase 0A-4】Composite Scoring                          │
│    - ベクトルスコア × 0.4                                    │
│    - キーワードスコア × 0.4                                  │
│    - ラベルスコア × 0.2                                      │
│    - 構造化ラベルスコア                                      │
│    - タイトルマッチブースト                                  │
│                                                              │
│    【Phase 5改善】再度ドメイン減衰・ブースト適用             │
│    - クエリ関連ドメインKWのみブースト                        │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 9. 【Phase 0A-1.5】品質フィルタリング                        │
│    ├─ ページ単位重複排除                                     │
│    │   - 同一pageIdのベストチャンクのみ選択                  │
│    │                                                          │
│    └─ 空ページフィルター                                     │
│        - 最小50文字のコンテンツ要求                          │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 10. 統一検索結果処理                                         │
│     - 最終スコア正規化                                       │
│     - ソート                                                 │
│     - Top K×3件を選択                                        │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│ 11. キャッシュ保存 & 返却                                    │
│     - 結果をキャッシュに保存 (15分TTL)                       │
│     - ユーザーに返却                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 主要コンポーネント

### 1. キャッシュシステム

**実装**: `GenericCache` (LRU)

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| TTL | 15分 | Phase 5で5分→15分に拡大 |
| maxSize | 5000件 | Phase 5で1000→5000に拡大 |
| 戦略 | LRU | 最長未使用を削除 |

**効果**:
- キャッシュヒット時: 1-3秒
- ヒット率向上: TTL延長により同一クエリの再利用性向上

---

### 2. キーワード抽出

**実装**: `unified-keyword-extraction-service.ts` + `enhanced-keyword-extractor.ts`

**処理フロー**:
1. 基本キーワード抽出（統一サービス）
2. ネガティブワード除去（「について」「方法」「教えて」等）
3. 優先キーワード選定（上位3個）
4. コアキーワード識別

**ネガティブワードリスト**: `common-terms-config.ts`
```typescript
NEGATIVE_WORDS_SET = [
  'について', 'に関して', '方法', 'やり方', 
  '手順', '仕方', '教えて', 'ください', ...
]
```

---

### 3. 並列検索 (Phase 5最適化)

**実装**: `Promise.allSettled` による並列実行

#### 3.1 ベクトル検索

**エンジン**: LanceDB  
**取得件数**: topK × 10件

**処理**:
1. `getEmbeddings(query)` でベクトル生成
2. `tbl.search(vector)` でコサイン類似度検索
3. 距離閾値フィルタリング (デフォルト: ≤2.0)
4. ラベルフィルタリング（議事録除外等）
5. タイトルマッチ検出・ブースト

**パフォーマンス**:
- 平均: 30-40ms
- 埋め込み生成: キャッシュ利用時10ms、初回2000ms

#### 3.2 BM25検索

**エンジン**: Lunr.js (日本語対応)  
**取得件数**: topK × 10件

**処理**:
1. 日本語トークナイズ（kuromoji軽量版）
2. TF-IDF計算
3. BM25スコア算出
4. ラベルフィルタリング

**パフォーマンス**:
- 平均: 10-20ms
- インデックスロード: 初回500ms、以降即座

---

### 4. Knowledge Graph拡張 (Phase 4)

**実装**: `kg-search-service.ts` + Firestore

**2段階拡張**:

#### 第1段階: タイトルマッチ結果から拡張
- **対象**: タイトルにキーワードが含まれる結果
- **参照深度**: 最大2件
- **重み**: 直接参照1.0, 間接参照0.7

#### 第2段階: RRF上位10件から拡張
- **対象**: RRF融合後の上位10件
- **目的**: タイトルブースト漏れの救済
- **参照深度**: 最大2件

**バッチクエリ最適化 (Phase 5)**:
- 逐次クエリ → バッチクエリ
- タイムアウト防止
- パフォーマンス改善: 10件で平均500ms

---

### 5. RRF融合 + ドメイン調整 (Phase 5)

**Reciprocal Rank Fusion**:
```
rrf = 1/(k + vector_rank) × 1.0
    + 1/(k + bm25_rank) × 0.8
    + 1/(k + title_rank) × 1.2
    + 1/(k + label_rank) × 0.6

k = 60
```

**Phase 5 ドメイン調整**:

| 条件 | 係数 | 説明 |
|------|------|------|
| 汎用文書 | ×0.5 | 「詳細閲覧」「一覧」等 |
| ペナルティ | ×0.9 | 議事録等 |
| 本システム外 | ×0.8 | 外部参照 |
| クエリ関連ドメインKW | ×1.5～×2.0 | クエリとタイトル両方に含まれるKWのみ |

**汎用文書判定**: `common-terms-config.ts`
```typescript
GENERIC_DOCUMENT_TERMS = [
  '詳細', '詳細閲覧', '一覧', '管理', 
  '共通要件', '非機能要件', ...
]
```

**ドメイン固有KW**: `common-terms-config.ts`
```typescript
DOMAIN_SPECIFIC_KEYWORDS = [
  '急募', '教室', '求人', '会員', '応募', 
  '契約', '請求', '採用', '退会', ...
]
```

**Phase 5重要改善点**:
- **クエリ関連のみブースト**: タイトルに「教室」があってもクエリに「教室」がなければブーストしない
- **無差別ブースト防止**: 関連性の低いページの過剰ランクアップを防止

---

### 6. Composite Scoring (Phase 0A-4)

**重み付け**:
```
final_score = vector_score × 0.4
            + keyword_score × 0.4
            + label_score × 0.2
            + structured_label_score
            + title_match_boost
```

**Phase 5 再調整**:
- RRF段階で適用したドメイン減衰・ブーストを再度適用
- RRFスコアが上書きされるのを防止
- 一貫性のあるスコアリング

---

### 7. 品質フィルタリング (Phase 0A-1.5)

#### 7.1 ページ単位重複排除

**目的**: 同一ページの複数チャンクから最良チャンクのみ選択

**ロジック**:
```typescript
pageMap[pageId] = bestChunk  // 最高スコアのチャンク
```

#### 7.2 空ページフィルター

**条件**: 
- content.length < 50文字 → 除外
- コンテンツなし → 除外

**理由**: フォールバック文章や無意味な結果の排除

---

## 🚀 パフォーマンス特性

### 現状パフォーマンス (2025-10-18測定)

| シナリオ | 実行時間 | 評価 |
|----------|----------|------|
| **キャッシュヒット** | 1-3秒 | ✅ 優秀 |
| **初回検索（ウォームアップ後）** | 平均19.8秒 | ❌ 要改善 |
| **最速ケース** | 4.2秒 | ✅ 良好 |
| **最遅ケース** | 61.7秒 | ❌ 大幅改善必要 |

### ボトルネック分析

| コンポーネント | 所要時間 | 割合 |
|---------------|----------|------|
| 埋め込みベクトル生成 | 2-3秒（初回） | ~15% |
| ベクトル検索 | 0.5-1秒 | ~5% |
| BM25検索 | 0.1-0.2秒 | ~1% |
| KG拡張（第1段階） | 0.5-1秒 | ~5% |
| RRF融合 | 0.1秒 | ~1% |
| KG拡張（第2段階） | 0.5-1秒 | ~5% |
| Composite Scoring | 10-15秒 | **~70%** ⚠️ |
| その他 | 0.5秒 | ~3% |

**最大ボトルネック**: **Composite Scoring (70%)**

---

## 📈 品質メトリクス (2025-10-18測定)

| メトリクス | 値 | 目標 |
|-----------|-----|------|
| **発見率** | 100% (7/7) | ✅ 100% |
| **Top 10発見率** | 100% (7/7) | ✅ 100% |
| **フォールバック率** | 0% (0/70) | ✅ <5% |
| **平均コンテンツ長** | 1332文字 | ✅ >500文字 |
| **平均ターゲット文字数** | 1600文字 | ✅ >1000文字 |

**総合品質スコア**: **100点/100点** 🎉

---

## 🔧 設定パラメータ

### 検索パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| `topK` | 5 | 最終返却件数 |
| `maxDistance` | 2.0 | ベクトル距離閾値 |
| `useLunrIndex` | true | Lunr BM25使用 |
| `useStructuredLabels` | true | 構造化ラベル使用 |
| `enableCompositeScoringV2` | true | 複合スコアリング有効化 |

### RRF融合パラメータ

| パラメータ | 値 |
|-----------|-----|
| `k` | 60 |
| ベクトル重み | 1.0 |
| BM25重み | 0.8 |
| タイトル重み | 1.2 |
| ラベル重み | 0.6 |

### Composite Scoring重み

| 要素 | 重み |
|------|------|
| Vector | 0.4 |
| Keyword | 0.4 |
| Label | 0.2 |

---

## 🐛 既知の問題と制約

### 1. パフォーマンス問題

**問題**: Composite Scoringが全体の70%の時間を消費

**影響**: 平均19.8秒（目標5秒）

**対策**: 後述の最適化案を参照

### 2. 広範なクエリの低速化

**問題**: 「会員」「退会」等の広範なキーワードで61.7秒

**原因**: 候補が多すぎてComposite Scoring負荷大

**対策**: 早期結果絞り込み

### 3. KG拡張タイムアウト

**問題**: 大量のページに対するKG拡張でタイムアウト

**対策**: Phase 5でバッチクエリ化済み（改善済み）

---

## 📚 関連ファイル

### コア検索

- `src/lib/lancedb-search-client.ts` - メイン検索ロジック
- `src/lib/unified-search-result-processor.ts` - 統一結果処理
- `src/lib/composite-scoring-service.ts` - 複合スコアリング

### キーワード抽出

- `src/lib/unified-keyword-extraction-service.ts` - 統一キーワード抽出
- `src/lib/enhanced-keyword-extractor.ts` - 強化版キーワード抽出
- `src/lib/common-terms-config.ts` - 共通用語定義

### Knowledge Graph

- `src/lib/kg-search-service.ts` - KG検索サービス
- `src/lib/kg-storage.ts` - KGストレージ

### BM25検索

- `src/lib/lunr-search-client.ts` - Lunr検索クライアント
- `src/lib/optimized-lunr-initializer.ts` - 最適化Lunr初期化

### スコアリング

- `src/lib/search-weights.ts` - 検索重み設定
- `src/lib/structured-label-scorer.ts` - 構造化ラベルスコアリング

---

## 🔄 バージョン履歴

### Phase 5 (2025-10-18)

**最適化**:
- ✅ 並列検索（Vector + BM25）
- ✅ KG拡張バッチクエリ化
- ✅ キャッシュ拡大（TTL 15分、5000件）
- ✅ クエリ関連ドメインKWのみブースト

**品質改善**:
- ✅ 汎用文書減衰強化（0.8 → 0.5）
- ✅ 無差別ブースト防止
- ✅ 発見率100%達成

### Phase 4 (以前)

- KG統合
- 2段階KG拡張
- タイトルマッチブースト

### Phase 0A-4

- Composite Scoring導入
- 構造化ラベルスコアリング

### Phase 0A-1.5

- ページ単位重複排除
- 空ページフィルター

---

## 📞 サポート

**問題報告**: プロジェクトIssueトラッカー  
**質問**: 開発チーム Slack #search-quality

---

*このドキュメントは検索システムの現状を正確に反映しています。*  
*パフォーマンス改善提案は別ドキュメント `hybrid-search-optimization-proposals.md` を参照してください。*

