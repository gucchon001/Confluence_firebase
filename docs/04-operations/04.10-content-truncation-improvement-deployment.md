# コンテンツ切り詰め改善の本番環境適用ガイド

**作成日**: 2025年11月4日  
**変更内容**: ランキングに基づく動的な文字数制限の実装

## 📋 変更内容

### 1. `summarize-confluence-docs.ts`
- **1位**: 2000文字（以前800文字）→ **+1200文字**
- **2位**: 1500文字（以前800文字）→ **+700文字**
- **3位**: 1200文字（以前800文字）→ **+400文字**
- **4位以降**: 800文字（変更なし）

### 2. `streaming-summarize-confluence-docs.ts`
- **1位**: 1500文字（以前530文字）→ **+970文字**
- **2位**: 1000文字（以前530文字）→ **+470文字**
- **3位**: 800文字（以前530文字）→ **+270文字**
- **4位以降**: 530文字（変更なし）

## ✅ 設定変更の確認

### 環境変数の変更
- **不要**: 環境変数の変更は不要です

### 設定ファイルの変更
- **不要**: `src/config/ai-models-config.ts` の変更は不要です
- 現在の設定:
  - `maxOutputTokens: 8192` （十分な余裕があります）
  - `timeout: 60000` （60秒）

### コード変更のみ
- `src/ai/flows/summarize-confluence-docs.ts`
- `src/ai/flows/streaming-summarize-confluence-docs.ts`

## 📊 トークン使用量の影響

### 概算計算

**通常版（summarize-confluence-docs.ts）**:
- 上位3件の合計増加: 約2300文字
- トークン換算（日本語: 約0.5-1.5トークン/文字）: 約2300-3450トークンの増加

**ストリーミング版（streaming-summarize-confluence-docs.ts）**:
- 上位3件の合計増加: 約1710文字
- トークン換算: 約1710-2565トークンの増加

### Gemini APIの制限

- **入力トークン制限**: 32,000トークン以上（問題なし）
- **出力トークン制限**: 8,192トークン（現在の設定で十分）
- **合計トークン制限**: 約100,000トークン以上（問題なし）

### コストへの影響

- **入力トークン数の増加**: 約5-10%の増加見込み
- **コスト増加**: 月間のコストが5-10%増加する可能性があります
- **監視**: 本番環境適用後、コスト使用量を監視してください

## ⚠️ 注意事項

### 1. パフォーマンスへの影響

- **処理時間**: 文字数が増えることで、わずかに処理時間が増加する可能性があります
- **監視**: 本番環境適用後、レスポンス時間を監視してください
- **期待される影響**: 通常は1-2秒程度の増加のみ

### 2. メモリ使用量

- **影響**: プロンプトサイズが増えることで、メモリ使用量がわずかに増加する可能性があります
- **監視**: 本番環境適用後、メモリ使用量を監視してください

### 3. エラーハンドリング

- **既存のエラーハンドリング**: 変更なし（既存のエラーハンドリングが有効）
- **タイムアウト**: 60秒のタイムアウト設定が維持されています

## 🚀 デプロイ手順

### 1. コードのコミットとプッシュ

```bash
git add src/ai/flows/summarize-confluence-docs.ts
git add src/ai/flows/streaming-summarize-confluence-docs.ts
git commit -m "feat: ランキングに基づく動的な文字数制限を実装（1位2000文字、2位1500文字、3位1200文字）"
git push
```

### 2. ビルドの確認

- Firebase App Hostingのビルドが成功することを確認
- ビルドログにエラーがないことを確認

### 3. デプロイ後の確認

1. **機能確認**
   - 「教室削除ができないのは何が原因ですか」クエリでテスト
   - 「164_【FIX】教室削除機能」の詳細情報が表示されるか確認
   - 求人の掲載状態に関する条件、応募情報・採用ステータスに関する条件が表示されるか確認

2. **パフォーマンス監視**
   - レスポンス時間を監視（通常は1-2秒程度の増加のみ）
   - エラーレートを監視（エラーが増加していないか確認）

3. **コスト監視**
   - Gemini APIのコスト使用量を監視（5-10%の増加見込み）
   - 異常な増加がないか確認

## 📝 ロールバック手順

もし問題が発生した場合のロールバック手順：

### 1. コードのロールバック

```bash
git revert <commit-hash>
git push
```

### 2. 以前の設定に戻す

```typescript
// summarize-confluence-docs.ts
const truncatedContent = doc.content && doc.content.length > 800 
  ? doc.content.substring(0, 800) + '...' 
  : doc.content || '内容なし';

// streaming-summarize-confluence-docs.ts
const truncatedContent = doc.content && doc.content.length > 530 
  ? doc.content.substring(0, 530) + '...' 
  : doc.content || '内容なし';
```

## ✅ チェックリスト

### デプロイ前
- [ ] コードレビュー完了
- [ ] ローカルテスト完了
- [ ] 変更内容の確認完了

### デプロイ後
- [ ] 機能確認完了
- [ ] パフォーマンス監視開始
- [ ] コスト監視開始
- [ ] エラーログの確認

## 📊 まとめ

### 変更の影響
- **設定変更**: 不要
- **環境変数**: 不要
- **コード変更**: 2ファイルのみ
- **トークン使用量**: 約5-10%の増加見込み
- **コスト**: 月間で5-10%の増加見込み
- **パフォーマンス**: 通常は1-2秒程度の増加のみ

### 推奨事項
1. デプロイ後、パフォーマンスとコストを監視
2. 問題があればロールバック手順を実行
3. 1週間程度監視してから、必要に応じて調整

