# LunrキャッシュGCS運用ガイド

**作成日**: 2025年11月23日  
**最終更新**: 2025年11月23日  
**ステータス**: ✅ 実装完了  
**関連ドキュメント**: 
- [アーキテクチャ設計](../01-architecture/01.05.01-lunr-cache-gcs-integration.md)
- [Lunr初期化根本原因分析](../analysis/lunr-initialization-root-cause.md)

---

## 1. 概要

本ガイドでは、LunrキャッシュのGCS統合機能の運用方法を説明します。

### 1.1 機能の目的

- **コールドスタート時の高速化**: インスタンス再起動時にGCSからキャッシュを読み込み、再構築時間（35秒）を短縮
- **複数インスタンス間でのキャッシュ共有**: GCSを使用してキャッシュを共有
- **自動化**: 手動操作不要で、自動的に保存・読み込み

### 1.2 動作環境

- **本番環境（Cloud Run）**: 自動的に有効化
- **開発環境**: GCS操作はスキップ（ローカルキャッシュのみ使用）

---

## 2. 動作確認

### 2.1 デプロイ後の確認

デプロイ後、本番環境のログで以下のメッセージが表示されることを確認してください。

#### 起動時（コールドスタート）

**成功時のログ**:
```
[GCSCacheHelper] ✅ Downloaded Lunr cache from GCS: .cache/lunr-index.msgpack
[LunrInitializer] ✅ Loaded confluence Lunr from cache in XXXms
```

**GCSにキャッシュがない場合（初回のみ）**:
```
[GCSCacheHelper] No cache found in GCS for table: confluence
[LunrInitializer] Cache not found or failed to load, will rebuild from LanceDB
[LunrInitializer] ✅ confluence index built
[GCSCacheHelper] ✅ Uploaded Lunr cache to GCS: .cache/lunr-index.msgpack
```

#### キャッシュ保存時

**成功時のログ**:
```
[Phase 6 LunrCache] ✅ MessagePack形式で保存: .cache/lunr-index.msgpack (XX.XXMB, XXXms)
[GCSCacheHelper] ✅ Uploaded Lunr cache to GCS: .cache/lunr-index.msgpack
[LunrSearchClient] Saved JSON cache for compatibility: .cache/lunr-index.json
[GCSCacheHelper] ✅ Uploaded Lunr cache to GCS: .cache/lunr-index.json
```

### 2.2 ログの確認方法

#### Firebase Console

1. [Firebase Console](https://console.firebase.google.com/) を開く
2. プロジェクト `confluence-copilot-ppjye` を選択
3. **App Hosting** → `confluence-chat` バックエンド
4. **ログ** タブでログを確認

#### Cloud Logging

```bash
# GCS操作のログを確認
gcloud logging read "resource.type=cloud_run_revision AND textPayload=~'GCSCacheHelper'" --limit 50 --format json
```

### 2.3 動作確認スクリプト

#### 開発環境での確認

```bash
# GCSヘルパー関数の動作確認
npm run test:gcs-cache-helper

# Lunr初期化とGCS統合の確認
npm run test:lunr-gcs-integration
```

**注意**: 開発環境ではGCS操作はスキップされます（正常動作）

---

## 3. 手動操作

### 3.1 キャッシュの手動アップロード

既存のローカルキャッシュをGCSにアップロードする場合:

```bash
# 本番データをアップロード（Lunrキャッシュも含む）
npm run upload:production-data
```

**実行内容**:
- LanceDBテーブルのアップロード
- Lunrキャッシュファイル（`.cache/lunr-index*.msgpack`, `.cache/lunr-index*.json`）のアップロード

### 3.2 キャッシュの手動ダウンロード

GCSからキャッシュをダウンロードする場合:

```bash
# 本番データをダウンロード（Lunrキャッシュも含む）
npm run download:production-data
```

**実行内容**:
- LanceDBテーブルのダウンロード
- Lunrキャッシュファイルのダウンロード

### 3.3 GCSバケットの確認

```bash
# GCSバケット内のLunrキャッシュファイルを確認
gsutil ls gs://confluence-copilot-data/.cache/lunr-index*
```

**期待される出力**:
```
gs://confluence-copilot-data/.cache/lunr-index.json
gs://confluence-copilot-data/.cache/lunr-index.msgpack
gs://confluence-copilot-data/.cache/lunr-index-jira_issues.json
gs://confluence-copilot-data/.cache/lunr-index-jira_issues.msgpack
```

---

## 4. トラブルシューティング

### 4.1 よくある問題

#### 問題1: GCSからキャッシュがダウンロードされない

**症状**:
```
[GCSCacheHelper] No cache found in GCS for table: confluence
[LunrInitializer] Cache not found or failed to load, will rebuild from LanceDB
```

**原因**:
- GCSにキャッシュファイルが存在しない（初回デプロイ時など）
- バケット名またはパスが間違っている
- サービスアカウントにアクセス権限がない

**解決方法**:
1. GCSバケットを確認:
   ```bash
   gsutil ls gs://confluence-copilot-data/.cache/lunr-index*
   ```
2. キャッシュが存在しない場合、手動でアップロード:
   ```bash
   npm run upload:production-data
   ```
3. サービスアカウントの権限を確認:
   - Cloud Runのデフォルトサービスアカウントに `Storage Object Viewer` と `Storage Object Creator` の権限が必要

#### 問題2: GCSへのアップロードが失敗する

**症状**:
```
[GCSCacheHelper] Failed to upload Lunr cache to GCS: ...
```

**原因**:
- サービスアカウントに書き込み権限がない
- ネットワークエラー
- バケットが存在しない

**解決方法**:
1. サービスアカウントの権限を確認:
   - `Storage Object Creator` の権限が必要
2. ネットワーク接続を確認
3. バケットの存在を確認:
   ```bash
   gsutil ls gs://confluence-copilot-data
   ```

**注意**: GCSアップロードはオプション機能のため、失敗してもアプリケーションは正常に動作します。ただし、次回のコールドスタート時に再構築が必要になります。

#### 問題3: キャッシュが古いまま

**症状**: データを更新したが、検索結果が古い

**原因**:
- GCSのキャッシュが古い
- ローカルキャッシュが古い

**解決方法**:
1. ローカルキャッシュを削除:
   ```bash
   rm -rf .cache/lunr-index*
   ```
2. GCSのキャッシュを削除:
   ```bash
   gsutil rm gs://confluence-copilot-data/.cache/lunr-index*
   ```
3. アプリケーションを再起動（次回起動時に再構築される）

#### 問題4: 開発環境でGCS操作が実行される

**症状**: 開発環境でGCS操作のログが表示される

**原因**: 環境判定が正しく動作していない

**確認方法**:
```bash
# 環境変数を確認
echo $K_SERVICE

# 未設定の場合、開発環境として正しく判定される
```

**解決方法**: 開発環境では`K_SERVICE`が設定されていないため、GCS操作はスキップされます。ログに「アップロードスキップ（開発環境）」と表示される場合は正常動作です。

### 4.2 ログの確認

#### 重要なログメッセージ

| ログメッセージ | 意味 | アクション |
|--------------|------|-----------|
| `✅ Downloaded Lunr cache from GCS` | GCSからダウンロード成功 | 正常動作 |
| `✅ Uploaded Lunr cache to GCS` | GCSへのアップロード成功 | 正常動作 |
| `No cache found in GCS` | GCSにキャッシュがない | 初回のみ正常、2回目以降は要確認 |
| `GCS upload failed (non-critical)` | アップロード失敗 | 警告のみ、アプリケーションは正常動作 |
| `GCS download failed (non-critical)` | ダウンロード失敗 | 警告のみ、再構築にフォールバック |

---

## 5. メンテナンス

### 5.1 定期的な確認

#### 週次確認

1. GCSバケットのキャッシュファイルを確認:
   ```bash
   gsutil ls -lh gs://confluence-copilot-data/.cache/lunr-index*
   ```

2. ファイルサイズが異常に大きい場合、調査:
   - 通常: MessagePack形式で10-15MB、JSON形式で20-30MB
   - 異常: 50MB以上の場合、データの重複や不整合の可能性

#### 月次確認

1. キャッシュの有効期限を確認:
   - データ更新後、キャッシュが更新されているか確認
   - 更新されていない場合、手動で再構築

### 5.2 キャッシュの再構築

データを大幅に更新した場合、キャッシュを再構築することを推奨します。

#### 手動手順

1. ローカルでキャッシュを再構築:
   ```bash
   npm run rebuild:lunr
   ```

2. GCSにアップロード:
   ```bash
   npm run upload:production-data
   ```

3. 本番環境を再起動（次回起動時に新しいキャッシュが読み込まれる）

---

## 6. パフォーマンス監視

### 6.1 メトリクス

以下のメトリクスを監視してください:

| メトリクス | 正常値 | 異常値 | アクション |
|----------|--------|--------|-----------|
| コールドスタート時の初期化時間 | 1-3秒 | 30秒以上 | GCSキャッシュの確認 |
| GCSダウンロード時間 | 1-2秒 | 10秒以上 | ネットワーク確認 |
| GCSアップロード時間 | 2-5秒 | 30秒以上 | ネットワーク確認 |
| キャッシュファイルサイズ | 10-30MB | 50MB以上 | データの確認 |

### 6.2 アラート設定

以下のアラートを設定することを推奨します:

1. **コールドスタート時の初期化時間が30秒以上**
   - 原因: GCSキャッシュが読み込まれていない可能性
   - アクション: GCSバケットとサービスアカウントの権限を確認

2. **GCS操作のエラー率が高い**
   - 原因: ネットワーク問題または権限問題
   - アクション: ログを確認して原因を特定

---

## 7. 関連コマンド

### 7.1 開発環境

```bash
# GCSヘルパー関数の動作確認
npm run test:gcs-cache-helper

# Lunr初期化とGCS統合の確認
npm run test:lunr-gcs-integration
```

### 7.2 本番環境

```bash
# 本番データをアップロード（Lunrキャッシュも含む）
npm run upload:production-data

# 本番データをダウンロード（Lunrキャッシュも含む）
npm run download:production-data

# Lunrキャッシュを再構築
npm run rebuild:lunr
```

### 7.3 GCS操作

```bash
# GCSバケット内のLunrキャッシュファイルを確認
gsutil ls gs://confluence-copilot-data/.cache/lunr-index*

# GCSバケット内のLunrキャッシュファイルを削除
gsutil rm gs://confluence-copilot-data/.cache/lunr-index*

# GCSバケット内のLunrキャッシュファイルのサイズを確認
gsutil ls -lh gs://confluence-copilot-data/.cache/lunr-index*
```

---

## 8. 関連ドキュメント

- [アーキテクチャ設計](../01-architecture/01.05.01-lunr-cache-gcs-integration.md)
- [Lunr初期化根本原因分析](../analysis/lunr-initialization-root-cause.md)
- [デプロイガイド](./04.01-deployment-guide.md)

---

## 9. 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2025-11-23 | 初版作成 | - |

