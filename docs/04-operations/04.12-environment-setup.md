# 環境別設定ガイド

## 概要

このプロジェクトでは、ローカル環境と本番環境で異なる設定方法を使用しています。それぞれの環境での設定方法を説明します。

---

## ローカル環境（開発環境）

### 設定ファイル

**`.env.local`** - ローカル環境用の環境変数ファイル（`.gitignore` に含まれる）

### 設定手順

1. `.env.example` を `.env.local` にコピー
   ```bash
   cp .env.example .env.local
   ```

2. `.env.local` を編集して、必要な環境変数を設定
   ```bash
   # Confluence設定
   CONFLUENCE_BASE_URL=https://giginc.atlassian.net
   CONFLUENCE_USER_EMAIL=kanri@jukust.jp
   CONFLUENCE_API_TOKEN=your_api_token
   CONFLUENCE_SPACE_KEY=CLIENTTOMO
   
   # Gemini設定
   GEMINI_API_KEY=your_gemini_api_key
   
   # Firebase設定（クライアント側）
   NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyAgaGihnyshajIN2YC7CdJR_H0bJMg_hkI
   # ... その他の環境変数
   ```

3. アプリケーションを起動
   ```bash
   npm run dev
   ```

### 環境変数の読み込み順序

Next.jsでは、以下の順序で環境変数が読み込まれます：

1. `.env.local` （ローカル環境用、全環境で優先）
2. `.env.development` （開発環境用、`NODE_ENV=development` の場合）
3. `.env.production` （本番環境用、`NODE_ENV=production` の場合）
4. `.env` （デフォルト）

**注意**: `.env.local` は `.gitignore` に含まれるため、Gitにコミットされません。

---

## 本番環境（Firebase App Hosting）

### 設定ファイル

**`setup/apphosting.yaml`** - Firebase App Hosting用の設定ファイル

### 設定手順

1. `setup/apphosting.yaml` を編集
   ```yaml
   env:
     # 通常の環境変数
     - variable: CONFLUENCE_BASE_URL
       value: https://giginc.atlassian.net
       availability:
         - RUNTIME
     
     # Secret Manager から取得（機密情報）
     - variable: CONFLUENCE_API_TOKEN
       secret: confluence_api_token
       availability:
         - RUNTIME
   ```

2. Secret Manager にシークレットを作成
   ```bash
   # Gemini APIキー
   gcloud secrets create gemini_api_key --data-file=- <<< "your_api_key"
   
   # Confluence APIトークン
   gcloud secrets create confluence_api_token --data-file=- <<< "your_api_token"
   ```

3. Firebase App Hosting にデプロイ
   ```bash
   firebase deploy --only hosting
   ```

### Secret Manager の使用方法

機密情報（APIキー、トークンなど）は Secret Manager で管理します。

#### シークレットの作成

```bash
# テキストから直接作成
echo -n "your_secret_value" | gcloud secrets create secret_name --data-file=-

# ファイルから作成
gcloud secrets create secret_name --data-file=path/to/secret.txt
```

#### シークレットの更新

```bash
# テキストから直接更新
echo -n "new_secret_value" | gcloud secrets versions add secret_name --data-file=-

# ファイルから更新
gcloud secrets versions add secret_name --data-file=path/to/secret.txt
```

#### シークレットの参照

`setup/apphosting.yaml` で Secret Manager のシークレットを参照：

```yaml
env:
  - variable: GEMINI_API_KEY
    secret: gemini_api_key  # Secret Manager のシークレット名
    availability:
      - BUILD
      - RUNTIME
```

---

## 環境変数の優先順位

### ローカル環境

1. `.env.local` （最優先）
2. `.env.development` （`NODE_ENV=development` の場合）
3. `.env` （デフォルト）

### 本番環境

1. `setup/apphosting.yaml` の環境変数設定
2. Secret Manager のシークレット（`secret:` で参照）
3. Firebase App Hosting の環境変数設定（コンソールから設定）

---

## 環境変数の可用性設定

Firebase App Hosting では、環境変数の可用性（`availability`）を設定できます：

- **BUILD**: ビルド時のみ利用可能
- **RUNTIME**: ランタイム時のみ利用可能
- **BUILD + RUNTIME**: ビルド時とランタイム時の両方で利用可能

### 設定例

```yaml
env:
  # Next.js Public環境変数（ビルド時とランタイム時に必要）
  - variable: NEXT_PUBLIC_FIREBASE_API_KEY
    value: AIzaSyAgaGihnyshajIN2YC7CdJR_H0bJMg_hkI
    availability:
      - BUILD
      - RUNTIME
  
  # Confluence API（ランタイムのみ）
  - variable: CONFLUENCE_BASE_URL
    value: https://giginc.atlassian.net
    availability:
      - RUNTIME
```

---

## 環境別の推奨設定

### 開発環境（ローカル）

- **NODE_ENV**: `development`
- **USE_LLM_EXPANSION**: `true` （開発時のLLM機能テスト用）
- **SKIP_DATA_DOWNLOAD**: `false` （データをダウンロードしてビルド）

### 本番環境

- **NODE_ENV**: `production`
- **USE_LLM_EXPANSION**: `true` （本番環境でもLLM機能を使用）
- **SKIP_DATA_DOWNLOAD**: `false` （データをダウンロードしてビルド）
- **K_SERVICE**: （自動設定 - Cloud Run環境のみ）
- **USE_INMEMORY_FS**: `true` （Cloud Run環境でパフォーマンス向上）

---

## トラブルシューティング

### ローカル環境で環境変数が読み込まれない

1. `.env.local` ファイルが存在するか確認
2. 環境変数名が正しいか確認（大文字・小文字を区別）
3. `.env.local` が `.gitignore` に含まれているか確認
4. アプリケーションを再起動

### 本番環境で環境変数が設定されない

1. `setup/apphosting.yaml` の設定を確認
2. Secret Manager にシークレットが存在するか確認
3. Firebase App Hosting の環境変数設定を確認（コンソール）
4. デプロイ後に環境変数が反映されているか確認

### Secret Manager の権限エラー

1. Firebase App Hosting のサービスアカウントに Secret Manager のアクセス権限があるか確認
2. Secret Manager のシークレット名が正しいか確認
3. シークレットが最新バージョンであるか確認

---

## 設定値の確認

### ローカル環境

```bash
# 環境変数の値を確認（テスト用）
npx tsx scripts/test-config-migration.ts
```

### 本番環境

```bash
# Firebase App Hosting の環境変数を確認
firebase hosting:channel:list

# Secret Manager のシークレットを確認
gcloud secrets list
```

---

## 参考資料

- [環境変数一覧](./environment-variables.md)
- [統合設定ファイル](../../src/config/app-config.ts)
- [Firebase App Hosting 設定ガイド](../../setup/apphosting.yaml)
- [Firebase App Hosting ドキュメント](https://firebase.google.com/docs/app-hosting/configure)

