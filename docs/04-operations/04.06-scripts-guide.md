# 📜 スクリプト利用ガイド

**最終更新日**: 2025年11月2日  
**対象**: 開発者・運用担当者

## 概要

このドキュメントでは、プロジェクト内の各種スクリプトの用途、実行方法、注意事項を説明します。

スクリプトは以下の2つのディレクトリに分かれています：
- `src/scripts/` - 主要な運用・同期スクリプト
- `scripts/` - データ管理・メンテナンススクリプト

---

## 📂 src/scripts/ - 主要運用スクリプト

### 🔄 データ同期スクリプト

#### `sync-jira.ts` - Jira同期

**用途**: Jira APIから課題データを取得し、FirestoreとLanceDBに同期します。

**実行方法**:
```bash
# デフォルト（最大1000件）
npx tsx src/scripts/sync-jira.ts

# 環境変数で件数を指定
JIRA_MAX_ISSUES=10000 npx tsx src/scripts/sync-jira.ts

# 全件取得モード
JIRA_MAX_ISSUES=0 npx tsx src/scripts/sync-jira.ts
```

**注意事項**:
- Jira APIのレート制限に注意
- 大量データ取得時は時間がかかる場合があります
- 実行後、LanceDBインデックスが自動更新されます

**関連ドキュメント**:
- [データ同期戦略](./04.03-data-synchronization-strategy.md)

---

#### `check-jira-firestore-count.ts` - Jira Firestore件数確認

**用途**: Firestoreの`jiraIssues`コレクションに保存されている件数を確認します。

**実行方法**:
```bash
npm run check:jira-firestore-count
```

**出力内容**:
- Firestoreの`jiraIssues`コレクションの総件数
- ユニークな`issue_key`数
- 重複チェック結果
- サンプルドキュメント（最初の5件）

**使用例**:
- 同期処理後のデータ件数確認
- データ整合性チェック

---

#### `test-jira-sync-termination.ts` - Jira同期終了条件テスト

**用途**: Jira同期処理が正しく終了するか（不要なループが発生していないか）をテストします。

**実行方法**:
```bash
npm run test:jira-sync-termination
```

**テスト内容**:
- `JIRA_MAX_ISSUES`設定値での最大取得件数チェック
- 実際のJiraの件数（約5500件）で正しく終了するか確認
- 不要なループが発生していないか確認

**出力内容**:
- 取得件数
- 保存件数、追加、更新、変更なしの件数
- 処理時間
- 期待値との比較結果

---

#### `test-firestore-write-permission.ts` - Firestore書き込み権限テスト

**用途**: Firebase Admin SDKのFirestore書き込み権限をテストします。

**実行方法**:
```bash
npm run test:firestore-write-permission
```

**テスト内容**:
- Firestoreへの書き込みテスト
- Firestoreからの読み込みテスト
- Firestoreからの削除テスト

**使用例**:
- サービスアカウントキーの権限確認
- Firestore接続確認

---

#### `batch-sync-confluence.ts` - Confluence一括同期

**用途**: Confluence APIから全ページを取得し、FirestoreとLanceDBに同期します。

**実行方法**:
```bash
npx tsx src/scripts/batch-sync-confluence.ts
```

**処理内容**:
1. Confluence APIから全ページを取得（ページネーション対応）
2. ページIDが存在しない場合：追加
3. ページIDが存在する場合：更新日時比較
   - Confluenceの方が新しい場合：削除して再作成
   - 更新がない場合：スキップ
4. Lunrインデックス再構築
5. LanceDBベクトルインデックス最適化

**注意事項**:
- 初回実行時は全ページを取得するため時間がかかります
- 実行後、インデックス再構築により処理時間が延びる場合があります

**関連ドキュメント**:
- [データ同期戦略](./04.03-data-synchronization-strategy.md)

---

### 💾 バックアップスクリプト

#### `backup-firestore-data.ts` - Firestoreバックアップ

**用途**: Firestoreデータをローカルにバックアップします。

**実行方法**:
```bash
# フルバックアップ
npx tsx src/scripts/backup-firestore-data.ts full

# 緊急バックアップ（管理者データのみ）
npx tsx src/scripts/backup-firestore-data.ts emergency

# バックアップから復元
npx tsx src/scripts/backup-firestore-data.ts restore backups/firestore-backup-YYYY-MM-DD.json
```

**処理内容**:
- **フルバックアップ**: ユーザー、会話、メッセージ、投稿ログ、管理者ログ
- **緊急バックアップ**: ユーザー、管理者ログのみ
- **自動クリーンアップ**: 30日分のバックアップを保持（古いものは自動削除）

**注意事項**:
- バックアップファイルは `backups/` ディレクトリに保存されます
- 復元時は既存データが上書きされる可能性があります

**関連ドキュメント**:
- [バックアップ管理ガイド](./04.04-backup-management-guide.md)

---

#### `schedule-backups.ts` - 定期バックアップスケジューラー

**用途**: 毎日の自動バックアップをスケジュールします。

**実行方法**:
```bash
# 定期バックアップを開始（毎日午前2時）
npx tsx src/scripts/schedule-backups.ts start

# 即座にバックアップ実行
npx tsx src/scripts/schedule-backups.ts backup-now

# 緊急バックアップ実行
npx tsx src/scripts/schedule-backups.ts emergency
```

**処理内容**:
- 毎日午前2時（JST）に自動的にフルバックアップを実行
- エラー時は緊急バックアップを自動実行
- プロセスを終了させるまで継続実行

**注意事項**:
- 長時間実行されるプロセスのため、サーバー上で実行する場合はプロセス管理ツール（PM2等）の使用を推奨

**関連ドキュメント**:
- [バックアップ管理ガイド](./04.04-backup-management-guide.md)

---

### 🚀 パイプライン実行スクリプト

#### `run-complete-pipeline.ts` - 完全パイプライン実行

**用途**: ドメイン知識抽出から検索精度テストまでの完全なパイプラインを実行します。

**実行方法**:
```bash
npx tsx src/scripts/run-complete-pipeline.ts
```

**実行されるステップ**:
1. ドメイン知識抽出（Confluence → LLM → 重複削除）
2. キーワード一覧ファイル生成
3. 設定値化キーワード抽出テスト（オプション）
4. 検索精度分析テスト（オプション）

**注意事項**:
- 実行時間が長くなることがあります（30分以上）
- LLM APIコストが発生する可能性があります
- 必須ステップが失敗した場合は中断されます

---

#### `run-lightweight-pipeline.ts` - 軽量パイプライン実行

**用途**: 既存データを使用した軽量なパイプラインを実行します。

**実行方法**:
```bash
npx tsx src/scripts/run-lightweight-pipeline.ts
```

**実行されるステップ**:
1. キーワード一覧ファイル生成（既存の場合はスキップ）
2. 設定値化キーワード抽出テスト（オプション）
3. 検索精度分析テスト（オプション）

**注意事項**:
- 既存のドメイン知識データが必要です
- 完全パイプラインよりも高速に実行されます（5分以内）

---

### 🔧 初期化・セットアップスクリプト

#### `initialize-default-admin.ts` - デフォルト管理者初期化

**用途**: アプリケーション起動時にデフォルト管理者ユーザーを初期化します。

**実行方法**:
```bash
npx tsx src/scripts/initialize-default-admin.ts
```

**処理内容**:
- デフォルト管理者ユーザーが存在しない場合、作成します
- 既に存在する場合は何もしません

**注意事項**:
- 本番環境では通常、アプリケーション起動時に自動実行されます

---

## 📂 scripts/ - データ管理・メンテナンススクリプト

### 🗄️ LanceDB管理スクリプト

#### `rebuild-lancedb-smart-chunking.ts` - LanceDBスマートチャンキング再構築

**用途**: 最適化されたチャンキング戦略でLanceDBを再構築します。

**実行方法**:
```bash
npx tsx scripts/rebuild-lancedb-smart-chunking.ts
```

**処理内容**:
- 8,192トークン以内: チャンク分割なし（約98%）
- 8,192トークン超過: チャンク分割あり（約2%）
- Phase 4: タイトル重複埋め込み（ベクトル検索での発見率向上）
- ページ除外フィルタリング（アーカイブ、フォルダ等）

**注意事項**:
- 実行時間が長くなることがあります（1時間以上）
- 既存のLanceDBテーブルは上書きされます
- 本番環境で実行する場合は事前にバックアップを推奨

**関連ドキュメント**:
- [拡張スキーマ運用ガイド](./04.05-extended-schema-operation-guide.md)

---

#### `prepare-production-deployment.ts` - 本番デプロイ準備

**用途**: マイグレーション済みデータベースを本番環境に適用するための準備を整えます。

**実行方法**:
```bash
npx tsx scripts/prepare-production-deployment.ts
```

**実行内容**:
1. ローカルデータベースの状態確認
2. マイグレーション済みであることの確認（`page_id`フィールドの存在確認）
3. スカラーインデックスの確認
4. ベクトルインデックスの確認
5. パフォーマンステスト

**注意事項**:
- 本番デプロイ前に必ず実行してください
- すべてのチェックが成功した場合のみ本番デプロイを進めることを推奨

**関連ドキュメント**:
- [デプロイガイド](./04.01-deployment-guide.md)

---

#### `sync-firestore-labels-to-lancedb.ts` - Firestoreラベル→LanceDB同期

**用途**: FirestoreのStructuredLabelデータをLanceDBに同期します。

**実行方法**:
```bash
npx tsx scripts/sync-firestore-labels-to-lancedb.ts
```

**処理内容**:
- Firestoreの`structuredLabels`コレクションからデータを取得
- LanceDBの該当レコードにラベル情報を反映
- スキーマ整合性を確認

**注意事項**:
- ラベルデータの変更時のみ実行
- 実行後、LanceDBインデックスの再構築を推奨

**関連ドキュメント**:
- [拡張スキーマ運用ガイド](./04.05-extended-schema-operation-guide.md)

---

#### `restore-lancedb-from-backup.ts` - LanceDBバックアップから復元

**用途**: LanceDBバックアップからデータを復元します。

**実行方法**:
```bash
npx tsx scripts/restore-lancedb-from-backup.ts <backup-path>
```

**注意事項**:
- 既存のLanceDBデータは上書きされます
- 復元前に現在のデータをバックアップすることを推奨

---

#### `warmup-cache.ts` - キャッシュウォームアップ

**用途**: 検索キャッシュを事前にウォームアップして、初回検索のパフォーマンスを向上させます。

**実行方法**:
```bash
npx tsx scripts/warmup-cache.ts
```

**処理内容**:
- よく使用される検索クエリを実行
- キャッシュに結果を保存
- 本番デプロイ後の初回検索を高速化

**注意事項**:
- 本番デプロイ後やメンテナンス後に実行することを推奨
- 実行時間は数分程度

---

#### `generate-structured-labels.ts` - 構造化ラベル生成

**用途**: Confluenceページから構造化ラベルを生成します。

**実行方法**:
```bash
npx tsx scripts/generate-structured-labels.ts
```

**処理内容**:
- Confluenceページデータを分析
- 構造化ラベルを自動生成
- Firestoreに保存

**注意事項**:
- 大量のページがある場合、実行時間が長くなることがあります
- 実行後、`sync-firestore-labels-to-lancedb.ts`でLanceDBに同期することを推奨

**関連ドキュメント**:
- [拡張スキーマ運用ガイド](./04.05-extended-schema-operation-guide.md)

---

#### `build-knowledge-graph.ts` - ナレッジグラフ構築

**用途**: ナレッジグラフを構築します。

**実行方法**:
```bash
npx tsx scripts/build-knowledge-graph.ts
```

**処理内容**:
- Confluenceページデータからエンティティとリレーションを抽出
- ナレッジグラフを構築
- グラフデータを保存

**注意事項**:
- 実行時間が長くなることがあります（1時間以上）
- 本番環境で実行する場合は事前にバックアップを推奨

**関連ドキュメント**:
- [ナレッジグラフ総合ドキュメント](../architecture/knowledge-graph-comprehensive-overview.md)

---

### 📊 データ確認スクリプト

#### `check-sync-progress.ts` - 同期進捗確認

**用途**: Jira/Confluence同期ジョブの進捗状況を確認します。

**実行方法**:
```bash
npx tsx src/scripts/check-sync-progress.ts
```

**表示内容**:
- 最新の同期ジョブの開始時刻・完了時刻
- 同期ステータス（実行中/完了/失敗）
- 取得件数・保存件数・スキップ件数
- LanceDBレコード数

---

#### `check-lancedb-tables.ts` - LanceDBテーブル確認

**用途**: LanceDBテーブルの存在と基本情報を確認します。

**実行方法**:
```bash
npx tsx src/scripts/check-lancedb-tables.ts
```

**表示内容**:
- テーブル一覧
- レコード数
- スキーマ情報

---

#### `check-firestore.ts` - Firestore確認

**用途**: Firestoreのコレクションとドキュメント数を確認します。

**実行方法**:
```bash
npx tsx src/scripts/check-firestore.ts
```

---

### 🛠️ セットアップスクリプト

#### `setup-firebase-secrets.sh` / `setup-firebase-secrets.ps1` - Firebase Secrets設定

**用途**: Firebase環境変数（Secrets）を設定します。

**実行方法**:
```bash
# Linux/Mac
bash scripts/setup-firebase-secrets.sh

# Windows PowerShell
.\scripts\setup-firebase-secrets.ps1
```

**処理内容**:
- Firebase Functions用の環境変数を設定
- Secret Managerへの値の保存

**注意事項**:
- 実行前に `.env` ファイルが正しく設定されていることを確認してください

**関連ドキュメント**:
- [デプロイガイド](./04.01-deployment-guide.md)

---

## 🔍 スクリプトの探し方

### 用途別一覧

| 用途 | スクリプト名 | 場所 |
|------|------------|------|
| **データ同期** | | |
| Confluence同期 | `batch-sync-confluence.ts` | `src/scripts/` |
| Jira同期 | `sync-jira.ts` | `src/scripts/` |
| **バックアップ** | | |
| Firestoreバックアップ | `backup-firestore-data.ts` | `src/scripts/` |
| 定期バックアップ | `schedule-backups.ts` | `src/scripts/` |
| **データベース管理** | | |
| LanceDB再構築 | `rebuild-lancedb-smart-chunking.ts` | `scripts/` |
| LanceDB復元 | `restore-lancedb-from-backup.ts` | `scripts/` |
| ラベル同期 | `sync-firestore-labels-to-lancedb.ts` | `scripts/` |
| ラベル生成 | `generate-structured-labels.ts` | `scripts/` |
| **パイプライン** | | |
| 完全パイプライン | `run-complete-pipeline.ts` | `src/scripts/` |
| 軽量パイプライン | `run-lightweight-pipeline.ts` | `src/scripts/` |
| **最適化** | | |
| キャッシュウォームアップ | `warmup-cache.ts` | `scripts/` |
| **ナレッジグラフ** | | |
| KG構築 | `build-knowledge-graph.ts` | `scripts/` |
| **確認・検証** | | |
| 同期進捗確認 | `check-sync-progress.ts` | `src/scripts/` |
| LanceDB確認 | `check-lancedb-tables.ts` | `src/scripts/` |
| Firestore確認 | `check-firestore.ts` | `src/scripts/` |
| Jira Firestore件数確認 | `check-jira-firestore-count.ts` | `scripts/` |
| Jira同期終了条件テスト | `test-jira-sync-termination.ts` | `scripts/` |
| Firestore書き込み権限テスト | `test-firestore-write-permission.ts` | `scripts/` |
| **セットアップ** | | |
| デフォルト管理者 | `initialize-default-admin.ts` | `src/scripts/` |
| Firebase Secrets | `setup-firebase-secrets.*` | `scripts/` |

---

## ⚠️ 注意事項

### 実行前の確認事項

1. **環境変数の設定**: `.env` ファイルが正しく設定されていることを確認
2. **データベース接続**: Firestore/LanceDBへの接続が可能であることを確認
3. **API認証情報**: Confluence/Jira APIの認証情報が設定されていることを確認
4. **バックアップ**: 重要なデータを変更するスクリプト実行前にバックアップを取得

### 実行時の注意

1. **実行時間**: データ量に応じて実行時間が変動します
2. **リソース使用**: 大量データ処理時はメモリ・CPU使用率が高くなります
3. **ネットワーク**: APIへのリクエストが多い場合、レート制限に注意
4. **ログ確認**: エラーが発生した場合はログを確認

### トラブルシューティング

問題が発生した場合：
1. [トラブルシューティングガイド](../troubleshooting/README.md)を確認
2. スクリプトのログ出力を確認
3. 関連するドキュメントを参照

---

## 📚 関連ドキュメント

- [データ同期戦略](./04.03-data-synchronization-strategy.md) - データ同期の全体戦略
- [バックアップ管理ガイド](./04.04-backup-management-guide.md) - バックアップの詳細
- [デプロイガイド](./04.01-deployment-guide.md) - デプロイ手順
- [拡張スキーマ運用ガイド](./04.05-extended-schema-operation-guide.md) - LanceDB運用
- [トラブルシューティングガイド](../troubleshooting/README.md) - 問題解決

---

**更新履歴**:
- 2025-11-02: 初版作成

