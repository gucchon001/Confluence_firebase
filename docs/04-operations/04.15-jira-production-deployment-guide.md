# Jira本番環境デプロイガイド

**最終更新**: 2025年1月（GitHub Actionsワークフロー追加、データ整合性テスト拡張）  
**ステータス**: ✅ 実装完了（自動同期ワークフロー含む）

このドキュメントは、Jira統合機能の本番環境へのデプロイ手順をまとめたものです。

---

## 📋 目次

1. [概要](#概要)
2. [現在の実装状況](#現在の実装状況)
3. [不足している実装](#不足している実装)
4. [実装手順](#実装手順)
5. [デプロイフロー](#デプロイフロー)
6. [検証手順](#検証手順)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

### Jira統合の目的

- Jira課題（CTJプロジェクト）を検索可能にする
- ConfluenceとJiraの両方から情報を取得できるようにする
- ハイブリッド検索エンジンでJiraデータも検索対象に含める

### アーキテクチャ

- **データソース**: Jira API (`/rest/api/3/search/jql`)
- **ストレージ**: 
  - Firestore: `jiraIssues`コレクション（生データ）
  - LanceDB: `jira_issues`テーブル（検索用、ベクトル化済み）
- **検索エンジン**: 
  - ベクトル検索（LanceDB）
  - BM25検索（Lunr.js）
- **インデックス**: 
  - ベクトルインデックス（IVF_PQ）
  - Lunrインデックス（`.cache/lunr-index-jira_issues.msgpack`）

---

## 現在の実装状況

### ✅ 実装済み

#### 1. データ同期機能

- **`src/scripts/sync-jira.ts`**: Jira APIからデータを取得してFirestoreとLanceDBに保存
- **`src/lib/jira-sync-service.ts`**: 同期処理の実装
  - ベクトル生成（バッチ処理、並列化、リトライ機能付き）
  - Firestore保存（バッチ処理: 500件/バッチ）
  - LanceDBテーブル作成（`jira_issues`）

#### 2. Lunrインデックス機能

- **`src/scripts/initialize-jira-lunr-index.ts`**: Jira用Lunrインデックスの初期化スクリプト
- **`src/lib/lunr-initializer.ts`**: Jiraテーブル対応済み
  - テーブル名: `jira_issues`
  - キャッシュファイル: `.cache/lunr-index-jira_issues.msgpack`

#### 3. 検索機能

- **`src/lib/hybrid-search-engine.ts`**: Jiraテーブル対応済み
- **`src/lib/lunr-search-client.ts`**: テーブルごとにインデックス管理
- **`src/lib/lancedb-search-client.ts`**: Jiraテーブル検索対応

#### 4. エラーハンドリング

- **`src/lib/startup-optimizer.ts`**: テーブル存在確認を追加（存在しないテーブルはスキップ）
- **`src/lib/lunr-initializer.ts`**: テーブル存在確認を追加

---

## 不足していた実装（✅ 実装完了）

### ✅ 実装完了

#### 1. 本番環境へのアップロード機能

- **`scripts/upload-production-data.ts`**: ✅ 作成完了
  - **実装済み機能**:
    - Confluenceテーブル（`confluence.lance`）のアップロード
    - **Jiraテーブル（`jira_issues.lance`）のアップロード** ✅
    - Lunrキャッシュ（`.cache/lunr-index*.msgpack`）のアップロード
    - 古いバージョンの自動削除
    - 全テーブルの自動検出

#### 2. 本番環境からのダウンロード機能

- **`scripts/download-production-data.ts`**: ✅ 拡張完了
  - **実装済み機能**:
    - **Jiraテーブル（`jira_issues.lance`）のダウンロード** ✅
    - Jira用Lunrキャッシュ（`lunr-index-jira_issues.msgpack`）のダウンロード ✅
    - 全テーブルの自動検出とダウンロード

#### 3. インデックス作成機能

- **`scripts/create-lancedb-indexes.ts`**: ✅ 作成完了
  - **実装済み機能**:
    - Confluenceテーブルのベクトルインデックス（IVF_PQ）作成
    - Confluenceテーブルのスカラーインデックス（`page_id`）作成
    - **Jiraテーブルのベクトルインデックス（IVF_PQ）作成** ✅
    - **Jiraテーブルのスカラーインデックス（`issue_key`）作成** ✅
    - 全テーブルの自動検出とインデックス作成

#### 4. ビルド時の自動ダウンロード

- **`scripts/conditional-download.js`**: ✅ 拡張完了
  - **実装済み機能**:
    - **Jiraテーブルの存在確認とダウンロード** ✅（`download-production-data.ts`経由）
    - ログメッセージの改善

---

## 実装完了内容

### ✅ Step 1: アップロードスクリプトの作成

#### 1.1 `scripts/upload-production-data.ts`の作成 ✅

**実装済み機能**:
- Confluenceテーブル（`confluence.lance`）のアップロード
- Jiraテーブル（`jira_issues.lance`）のアップロード（存在する場合）
- Lunrキャッシュ（`.cache/lunr-index*.msgpack`）のアップロード
- 古いバージョンの自動削除
- ローカルの`.lancedb`ディレクトリから全テーブルを自動検出
- 各テーブルを`lancedb/{tableName}.lance/`にアップロード

#### 1.2 `scripts/download-production-data.ts`の拡張 ✅

**実装済み機能**:
- Confluenceテーブル（`confluence.lance`）のダウンロード
- Jiraテーブル（`jira_issues.lance`）のダウンロード（存在する場合）
- Lunrキャッシュ（`lunr-index*.msgpack`）のダウンロード
- GCSから`lancedb/`配下の全テーブルを自動検出
- 各テーブルをローカルの`.lancedb/`にダウンロード

### ✅ Step 2: インデックス作成スクリプトの作成

#### 2.1 `scripts/create-lancedb-indexes.ts`の作成 ✅

**実装済み機能**:
- Confluenceテーブルのベクトルインデックス（IVF_PQ）作成
- Confluenceテーブルのスカラーインデックス（`page_id`）作成
- Jiraテーブルのベクトルインデックス（IVF_PQ）作成（存在する場合）
- Jiraテーブルのスカラーインデックス（`issue_key`）作成（存在する場合）
- ローカルの`.lancedb`ディレクトリから全テーブルを自動検出
- 既存インデックスの確認とスキップ

### ✅ Step 3: ビルド時の自動ダウンロード拡張

#### 3.1 `scripts/conditional-download.js`の拡張 ✅

**実装済み機能**:
- `download-production-data.ts`を呼び出して全テーブルをダウンロード
- ログメッセージの改善（Jiraテーブルも含まれることを明示）

---

## デプロイフロー

### 初回デプロイ手順

#### 1. データ同期

```bash
# Jiraデータを同期（Firestore + LanceDB）
npm run sync:jira
```

**確認ポイント**:
- Firestore `jiraIssues`コレクションにデータが保存されているか
- ローカルの`.lancedb/jira_issues.lance/`が作成されているか
- レコード数が期待どおりか

#### 2. Lunrインデックス初期化

```bash
# Jira用Lunrインデックスを初期化
npm run init:jira-lunr
```

**確認ポイント**:
- `.cache/lunr-index-jira_issues.msgpack`が作成されているか
- ドキュメント数が期待どおりか

#### 3. インデックス作成

```bash
# LanceDBインデックスを作成
npx tsx scripts/create-lancedb-indexes.ts
```

**確認ポイント**:
- ベクトルインデックス（IVF_PQ）が作成されているか
- スカラーインデックス（`issue_key`）が作成されているか

#### 4. 本番環境へのアップロード

```bash
# GCSにアップロード
npx tsx scripts/upload-production-data.ts
```

**確認ポイント**:
- `gs://confluence-copilot-data/lancedb/jira_issues.lance/`にファイルがアップロードされているか
- `.cache/lunr-index-jira_issues.msgpack`がアップロードされているか
- ファイル数とサイズが期待どおりか

#### 5. 検証

```bash
# 本番環境のデータをダウンロードして検証
npx tsx scripts/verify-production-readiness.ts
```

**確認ポイント**:
- Jiraテーブルが存在するか
- レコード数が期待どおりか
- インデックスが作成されているか

### 定期更新手順

#### 1. データ同期

```bash
# Jiraデータを同期
npm run sync:jira
```

#### 2. Lunrインデックス再構築（必要に応じて）

```bash
# キャッシュを削除して再初期化
rm .cache/lunr-index-jira_issues.msgpack
npm run init:jira-lunr
```

#### 3. インデックス再作成（必要に応じて）

```bash
# インデックスを再作成
npx tsx scripts/create-lancedb-indexes.ts
```

#### 4. 本番環境へのアップロード

```bash
# GCSにアップロード
npx tsx scripts/upload-production-data.ts
```

---

## 検証手順

### ローカル環境での検証

#### 1. データ同期の確認

```bash
# Firestoreデータ確認
npx tsx src/scripts/inspect-jira-firestore.ts

# LanceDBデータ確認（全テーブル）
npx tsx src/scripts/check-lancedb-tables.ts
```

#### 2. 検索機能の確認

```bash
# Jira検索テスト
npx tsx src/tests/test-jira-search.ts
```

#### 3. Lunrインデックスの確認

```bash
# Lunrインデックス状態確認
npx tsx src/scripts/initialize-jira-lunr-index.ts
```

### 本番環境での検証

#### 1. データ存在確認

```bash
# 本番環境のLanceDBデータをダウンロードして確認
npx tsx scripts/download-production-data.ts
npx tsx src/scripts/check-lancedb-tables.ts
```

#### 2. 検索機能の確認

- 本番UIでJiraタブを選択
- 検索クエリを実行
- 検索結果が正しく表示されるか確認

#### 3. ログ確認

```bash
# Cloud LoggingでJira関連のログを確認
gcloud logging read \
  'resource.type="run_revision" AND textPayload=~"jira" OR textPayload=~"Jira"' \
  --project=confluence-copilot-ppjye \
  --limit=50 \
  --format="value(timestamp,textPayload)"
```

---

## テストの連動状況

### ✅ 連動しているテスト

#### 1. デプロイフロー内のテスト

**`npm run deploy:data`スクリプト**:
```bash
npm run deploy:data
```

このスクリプトは以下の順序で実行されます：
1. `generate-structured-labels.ts` - StructuredLabel生成
2. `sync-firestore-labels-to-lancedb.ts` - Firestore→LanceDB同期
3. `create-lancedb-indexes.ts` - インデックス作成（**Jiraテーブル対応済み**）
4. `upload-production-data.ts` - GCSアップロード（**Jiraテーブル対応済み**）
5. `test-data-integrity.ts --env production` - データ整合性テスト

**注意**: `test-data-integrity.ts`は現在`confluence`テーブルのみを対象としています。

#### 2. Jira関連の個別テスト

- **`npm run test:jira-search`**: Jira検索機能のテスト
- **`npm run init:jira-lunr`**: Jira用Lunrインデックスの初期化テスト
- **`npx tsx src/scripts/check-lancedb-tables.ts`**: 全テーブル（Confluence + Jira）の存在確認

### ✅ 実装完了（2025年1月更新）

#### 1. データ整合性テスト（Jiraテーブル対応完了）✅

**`scripts/test-data-integrity.ts`**:
- **実装済み**: `--table`オプションで`confluence`、`jira_issues`、`all`を指定可能
- **実装済み**: Jiraテーブル用の`--issue-key`オプションを追加
- **実装済み**: Jiraテーブルのインデックス検証（`issue_key`フィールド）
- **使用方法**:
  ```bash
  # Confluenceテーブルのみ
  npx tsx scripts/test-data-integrity.ts --env production --table confluence
  
  # Jiraテーブルのみ
  npx tsx scripts/test-data-integrity.ts --env production --table jira_issues --issue-key CTJ-123
  
  # 両方のテーブル
  npx tsx scripts/test-data-integrity.ts --env production --table all
  ```

#### 2. GitHub Actionsワークフロー（Jira自動同期）✅

**`.github/workflows/sync-jira.yml`**:
- **実装済み**: 30分おきに自動実行（UTC時間の毎時0分と30分）
- **実装済み**: 手動実行時に最大取得件数を指定可能
- **実装済み**: Jira同期 → Lunrインデックス初期化 → LanceDBインデックス作成 → GCSアップロードの完全なパイプライン
- **実装済み**: エラーハンドリングと詳細なログ出力

#### 3. Confluenceワークフローの改善 ✅

**`.github/workflows/sync-confluence.yml`**:
- **改善**: インデックス作成ステップを追加
- **改善**: Lunrインデックス再構築ステップを追加
- **改善**: エラーハンドリングの改善（各ステップの結果を追跡）

### ⚠️ 未連動のテスト（改善の余地あり）

#### 2. アップロード/ダウンロードスクリプトの直接テスト（優先度: 中）

**`scripts/upload-production-data.ts`**:
- **現状**: 直接的なテストが存在しない
- **問題**: アップロード成功の検証が手動確認のみ

**`scripts/download-production-data.ts`**:
- **現状**: 直接的なテストが存在しない
- **問題**: ダウンロード成功の検証が手動確認のみ

**`scripts/create-lancedb-indexes.ts`**:
- **現状**: 直接的なテストが存在しない
- **問題**: インデックス作成成功の検証が手動確認のみ

### 🔧 推奨される改善（将来の拡張）

#### 1. アップロード/ダウンロードスクリプトのテスト追加（優先度: 中）

**必要な機能**:
- アップロード後のファイル存在確認
- ダウンロード後のファイル存在確認
- ファイルサイズと件数の検証

**実装方針**:
- 統合テストとして実装
- GCSへの実際のアップロード/ダウンロードをテスト（テスト用バケットを使用）

#### 2. インデックス作成スクリプトのテスト追加（優先度: 中）

**必要な機能**:
- インデックス作成後の存在確認
- インデックスタイプの検証（IVF_PQ、BTree）

**実装方針**:
- 統合テストとして実装
- インデックス作成前後の状態を比較

---

## トラブルシューティング

### 問題1: Jiraテーブルが見つからない

**症状**:
- 本番環境で`jira_issues`テーブルが見つからないエラーが発生

**原因**:
- 本番環境にJiraテーブルがアップロードされていない
- `download-production-data.ts`がJiraテーブルをダウンロードしていない

**解決方法**:
1. ローカル環境でJiraデータを同期: `npm run sync:jira`
2. 本番環境にアップロード: `npx tsx scripts/upload-production-data.ts`
3. ビルド時にダウンロードされることを確認

### 問題2: Lunrインデックスが初期化されない

**症状**:
- Jira検索で0件が返される
- Lunrインデックスが初期化されていない

**原因**:
- `.cache/lunr-index-jira_issues.msgpack`が存在しない
- キャッシュパスが間違っている

**解決方法**:
1. ローカル環境でLunrインデックスを初期化: `npm run init:jira-lunr`
2. 本番環境にアップロード: `npx tsx scripts/upload-production-data.ts`
3. キャッシュパスを確認（Cloud Run環境では`.next/standalone/.cache`を使用）

### 問題3: インデックスが作成されない

**症状**:
- 検索が遅い
- インデックスが存在しない

**原因**:
- `create-lancedb-indexes.ts`が実行されていない
- Jiraテーブルのインデックス作成が未実装

**解決方法**:
1. `scripts/create-lancedb-indexes.ts`を実行
2. Jiraテーブルのインデックス作成機能を確認

### 問題4: アップロードが失敗する

**症状**:
- `upload-production-data.ts`がエラーで終了

**原因**:
- GCSへのアクセス権限がない
- ファイルが存在しない

**解決方法**:
1. GCSへのアクセス権限を確認
2. ローカル環境にデータが存在するか確認
3. エラーメッセージを確認して対処

---

## GitHub Secrets設定

Jiraワークフローを動作させるには、以下のGitHub Secretsを設定する必要があります。

### 必須のSecrets

| Secret名 | 説明 | .env.localでの対応値 | 設定方法 |
|---------|------|---------------------|---------|
| `JIRA_PROJECT_KEY` | Jiraプロジェクトキー | `JIRA_PROJECT_KEY=CTJ` | GitHub → Settings → Secrets and variables → Actions → New repository secret |
| `GEMINI_API_KEY` | Gemini APIキー | `GEMINI_API_KEY=AIzaSyDgbOANBYpo-H5V9-HLwJR36fhNonSz4h4` | 同上 |
| `GOOGLE_CLOUD_CREDENTIALS` | Google Cloud認証情報（JSON） | `GOOGLE_APPLICATION_CREDENTIALS`で指定されたJSONファイルの内容 | 同上（JSON全体をコピー） |

### オプションのSecrets（Confluence設定をフォールバックとして使用）

| Secret名 | 説明 | .env.localでの対応値 | フォールバック |
|---------|------|---------------------|---------------|
| `JIRA_BASE_URL` | JiraベースURL | `CONFLUENCE_BASE_URL=https://giginc.atlassian.net` | `CONFLUENCE_BASE_URL` |
| `JIRA_USER_EMAIL` | Jiraユーザーメールアドレス | `CONFLUENCE_USER_EMAIL=kanri@jukust.jp` | `CONFLUENCE_USER_EMAIL` |
| `JIRA_API_TOKEN` | Jira APIトークン | `CONFLUENCE_API_TOKEN=ATATT3xFfGF0...` | `CONFLUENCE_API_TOKEN` |

### 既に設定されているSecrets（Confluenceワークフローで使用）

以下のSecretsは既にConfluenceワークフローで使用されているため、Jiraワークフローでも自動的に使用されます：

| Secret名 | .env.localでの対応値 |
|---------|---------------------|
| `CONFLUENCE_BASE_URL` | `CONFLUENCE_BASE_URL=https://giginc.atlassian.net` |
| `CONFLUENCE_USER_EMAIL` | `CONFLUENCE_USER_EMAIL=kanri@jukust.jp` |
| `CONFLUENCE_API_TOKEN` | `CONFLUENCE_API_TOKEN=ATATT3xFfGF0...` |

### 設定手順

#### 方法1: GitHub CLIを使用（推奨）

GitHub CLIを使用すると、コマンドラインから簡単にSecretsを設定できます。

**Windows (PowerShell):**

```powershell
# 1. GitHub CLIをインストール（未インストールの場合）
# wingetを使用:
winget install --id GitHub.cli

# または Chocolateyを使用:
choco install gh

# または Scoopを使用:
scoop install gh

# 2. PowerShellを再起動後、GitHub CLIにログイン
gh auth login

# 3. 自動設定スクリプトを実行
.\scripts\setup-github-secrets.ps1
```

**macOS / Linux (Bash):**

```bash
# 1. GitHub CLIをインストール（未インストールの場合）
# macOS: brew install gh
# Linux: https://cli.github.com/manual/installation

# 2. GitHub CLIにログイン
gh auth login

# 3. 自動設定スクリプトを実行
chmod +x scripts/setup-github-secrets.sh
./scripts/setup-github-secrets.sh
```

または、個別に設定する場合：

```bash
# 必須のSecrets
gh secret set JIRA_PROJECT_KEY --body "CTJ"
gh secret set GEMINI_API_KEY --body "AIzaSyDgbOANBYpo-H5V9-HLwJR36fhNonSz4h4"
gh secret set GOOGLE_CLOUD_CREDENTIALS < keys/firebase-adminsdk-key.json

# オプションのSecrets（Jira専用）
gh secret set JIRA_BASE_URL --body "https://giginc.atlassian.net"
gh secret set JIRA_USER_EMAIL --body "kanri@jukust.jp"
gh secret set JIRA_API_TOKEN --body "ATATT3xFfGF0..."

# Confluence用のSecrets（既に設定済みの場合はスキップ）
gh secret set CONFLUENCE_BASE_URL --body "https://giginc.atlassian.net"
gh secret set CONFLUENCE_USER_EMAIL --body "kanri@jukust.jp"
gh secret set CONFLUENCE_API_TOKEN --body "ATATT3xFfGF0..."
gh secret set CONFLUENCE_SPACE_KEY --body "CLIENTTOMO"
```

#### 方法2: GitHub Web UIを使用

1. GitHubリポジトリにアクセス
2. Settings → Secrets and variables → Actions に移動
3. 「New repository secret」をクリック
4. 上記の表に基づいて各Secretを設定
5. `GOOGLE_CLOUD_CREDENTIALS`は、`keys/firebase-adminsdk-key.json`ファイルの内容全体をコピーして設定

### 注意事項

- `GOOGLE_CLOUD_CREDENTIALS`はJSON形式の文字列として設定してください（GitHub CLIの場合はファイルから直接読み込み可能）
- Jira用のSecrets（`JIRA_*`）が設定されていない場合、Confluence用のSecrets（`CONFLUENCE_*`）が自動的に使用されます
- APIトークンや認証情報は機密情報のため、`.env.local`ファイルをGitにコミットしないでください
- GitHub CLIを使用する場合、`gh auth login`で事前に認証が必要です
- 設定されたSecretsを確認するには: `gh secret list`

---

## 関連ドキュメント

- [Jira統合計画](../01-architecture/06.01.01-confluence-jira-integration-plan.md)
- [Jira仕様書](../02-specifications/02.03-jira-spec.md)
- [デプロイガイド](./04.01-deployment-guide.md)
- [データ同期戦略](./04.03-data-synchronization-strategy.md)

---

## 更新履歴

- **2025-11-17**: 実装完了
  - ✅ `scripts/upload-production-data.ts`を作成（Jiraテーブル対応）
  - ✅ `scripts/download-production-data.ts`を拡張（Jiraテーブル対応）
  - ✅ `scripts/create-lancedb-indexes.ts`を作成（Jiraテーブル対応）
  - ✅ `scripts/conditional-download.js`を拡張（ログメッセージ改善）
  - 実装手順とデプロイフローを定義
  - トラブルシューティングガイドを追加

