# 完全再構築スクリプト運用ガイド

**最終更新**: 2025-01-28  
**ステータス**: ✅ 推奨方法

## 概要

このドキュメントでは、ConfluenceとJiraのデータ同期・インデックス作成・アップロードを確実に実行するための**完全再構築スクリプト**の使用方法を説明します。

> **重要**: データ同期、インデックス作成、GCSアップロードを行う場合は、**必ず完全再構築スクリプトを使用してください**。個別コマンドを手動で実行すると、処理順序の誤りや漏れが発生する可能性があります。

---

## なぜ完全再構築スクリプトを使用すべきか

### ✅ メリット

1. **処理順序が保証される**
   - データ同期 → StructuredLabel同期 → インデックス作成 → GCSアップロードの順序が自動的に守られる
   - インデックス作成がアップロード前に確実に実行される

2. **全ての処理が一括で実行される**
   - 複数のコマンドを実行する必要がない
   - 処理漏れが発生しない

3. **テーブル分離が確実に実現される**
   - ConfluenceとJiraのテーブルが互いに影響しない
   - テーブルフィルターが自動的に適用される

4. **エラーハンドリングが適切に実装されている**
   - 重要なステップでエラーが発生した場合、処理が停止する
   - 部分的な完了による不整合を防ぐ

### ⚠️ 個別コマンド実行の問題点

- 処理順序を間違える可能性がある（例: インデックス作成前にアップロード）
- 処理を忘れる可能性がある（例: インデックス作成を忘れる）
- テーブル分離が適切に適用されない可能性がある

---

## Confluence完全再構築スクリプト

### スクリプトファイル

- **パス**: `scripts/sync-confluence-full-rebuild.ts`
- **npmコマンド**: `npm run sync:confluence:rebuild`

### 処理フロー

```bash
1. Confluenceデータ同期（Firestore + LanceDB）
   ↓
2. StructuredLabel同期（Firestore → LanceDB）
   ↓
3. Lunrインデックスの再構築
   ↓
4. LanceDBインデックスの作成
   ↓
5. GCSへのアップロード（オプション）
```

### 使用方法

#### 基本的な使用方法

```bash
# 完全再構築（全ての処理を実行）
npm run sync:confluence:rebuild
```

#### 環境変数によるカスタマイズ

```bash
# 差分同期で再構築（変更されたページのみ）
SYNC_TYPE=differential npm run sync:confluence:rebuild

# StructuredLabel同期をスキップ
SKIP_STRUCTURED_LABELS=true npm run sync:confluence:rebuild

# GCSアップロードをスキップ（ローカルテスト時）
SKIP_GCS_UPLOAD=true npm run sync:confluence:rebuild

# 複数のオプションを組み合わせ
SYNC_TYPE=differential SKIP_GCS_UPLOAD=true npm run sync:confluence:rebuild
```

### 環境変数

| 環境変数 | 説明 | デフォルト値 | 備考 |
|---------|------|------------|------|
| `SYNC_TYPE` | 同期タイプ | `'batch'` | `'differential'`（差分同期）または `'batch'`（完全同期） |
| `SKIP_STRUCTURED_LABELS` | StructuredLabel同期をスキップ | `'false'` | `'true'`でスキップ |
| `SKIP_GCS_UPLOAD` | GCSアップロードをスキップ | `'false'` | `'true'`でスキップ |

### 処理時間の目安

- **差分同期**: 約5〜15分
- **完全同期**: 約30〜60分

---

## Jira完全再構築スクリプト

### スクリプトファイル

- **パス**: `scripts/sync-jira-full-rebuild.ts`
- **npmコマンド**: `npm run sync:jira:rebuild`

### 処理フロー

```bash
1. Jiraデータ同期（Firestore + LanceDB）
   ↓
2. StructuredLabel同期（Firestore → LanceDB）
   ↓
3. Lunrインデックスの初期化
   ↓
4. LanceDBインデックスの作成
   ↓
5. GCSへのアップロード（オプション）
```

### 使用方法

#### 基本的な使用方法

```bash
# 完全再構築（全ての処理を実行、最大1000件）
npm run sync:jira:rebuild
```

#### 環境変数によるカスタマイズ

```bash
# 全件取得モード（0で全件取得）
JIRA_MAX_ISSUES=0 npm run sync:jira:rebuild

# 最大取得件数を指定
JIRA_MAX_ISSUES=500 npm run sync:jira:rebuild

# StructuredLabel同期をスキップ
SKIP_STRUCTURED_LABELS=true npm run sync:jira:rebuild

# GCSアップロードをスキップ（ローカルテスト時）
SKIP_GCS_UPLOAD=true npm run sync:jira:rebuild

# テスト実行（最大10件、GCSアップロードスキップ）
JIRA_MAX_ISSUES=10 SKIP_GCS_UPLOAD=true npm run sync:jira:rebuild
```

### 環境変数

| 環境変数 | 説明 | デフォルト値 | 備考 |
|---------|------|------------|------|
| `JIRA_MAX_ISSUES` | 最大取得件数 | `1000` | `0`で全件取得 |
| `SKIP_STRUCTURED_LABELS` | StructuredLabel同期をスキップ | `'false'` | `'true'`でスキップ |
| `SKIP_GCS_UPLOAD` | GCSアップロードをスキップ | `'false'` | `'true'`でスキップ |

### 処理時間の目安

- **最大1000件**: 約10〜30分（チャンク分割や429エラーハンドリングを含む）
- **全件取得**: 約30〜60分（データ量による）

---

## 使用シーン

### Confluence完全再構築スクリプト

1. **初回セットアップ時**
   - 全てのデータを同期
   - インデックスを作成
   - 本番環境にデプロイ

2. **大規模変更後**
   - スキーマ変更後
   - データ不整合時

3. **定期メンテナンス**
   - 週次または月次の完全再構築

### Jira完全再構築スクリプト

1. **初回セットアップ時**
   - 全てのデータを同期
   - インデックスを作成
   - 本番環境にデプロイ

2. **チャンク分割機能追加後**
   - スキーマ変更後（`isChunked`, `chunkIndex`, `totalChunks`フィールド追加）
   - データ不整合時

3. **定期メンテナンス**
   - 週次または月次の完全再構築

---

## トラブルシューティング

### エラーが発生した場合

1. **エラーメッセージを確認**
   - スクリプトの出力を確認
   - エラーが発生したステップを特定

2. **環境変数の確認**
   - `.env.local`ファイルに必要な環境変数が設定されているか
   - APIトークンの有効期限を確認

3. **依存スクリプトの確認**
   - 依存スクリプトが存在するか
   - 依存スクリプトが正常に動作するか

### よくある問題

#### 1. インデックスが作成されていない

**症状**: 検索が遅い、またはエラーが発生する

**原因**: インデックス作成ステップが失敗した、またはスキップされた

**解決方法**:
```bash
# 完全再構築スクリプトを再実行
npm run sync:confluence:rebuild
# または
npm run sync:jira:rebuild
```

#### 2. GCSアップロードが失敗する

**症状**: アップロードステップでエラーが発生する

**原因**: GCSへのアクセス権限がない、またはネットワークエラー

**解決方法**:
1. GCSへのアクセス権限を確認
2. ネットワーク接続を確認
3. ローカルテスト時は`SKIP_GCS_UPLOAD=true`を使用

#### 3. 処理が長時間かかる

**症状**: 処理が完了しない

**原因**: データ量が多い、またはAPIレート制限

**解決方法**:
- Confluence: `SYNC_TYPE=differential`を使用して差分同期を試す
- Jira: `JIRA_MAX_ISSUES`を小さくしてテスト実行

---

## 完全再構築スクリプトの技術詳細

詳細な技術情報については、以下のドキュメントを参照してください：

- [完全再構築スクリプトの完全状態検証](../05-testing/05.110-complete-status-verification.md)
- [完全再構築スクリプト作成](../05-testing/05.105-full-rebuild-scripts-creation.md)

---

## 関連ドキュメント

- [データ同期戦略](./04.03-data-synchronization-strategy.md) - 自動同期の設定と運用
- [Jira本番環境デプロイガイド](./04.15-jira-production-deployment-guide.md) - Jira統合のデプロイ手順
- [スクリプト利用ガイド](./04.06-scripts-guide.md) - その他のスクリプトの使用方法

---

## 変更履歴

| 日付 | 変更内容 |
|-----|---------|
| 2025-01-28 | 初版作成 - 完全再構築スクリプトの推奨方法を説明 |

