# Phase 1 + Phase 2 改善の本番環境デプロイガイド

**作成日**: 2025年1月  
**対象**: Structured Label生成精度向上（Phase 1 + Phase 2）

---

## 📋 概要

このガイドでは、Phase 1 + Phase 2の改善（ルールベース生成の条件緩和、カテゴリ推測強化、ドメイン推測精度向上、プロンプト最適化）を本番環境にデプロイする手順を説明します。

---

## ✅ デプロイ前チェックリスト

### 1. コード品質チェック

- [x] TypeScriptエラーなし（`npx tsc --noEmit`が通る）
- [ ] ビルドエラーなし（`npm run build`が通る）
- [ ] ローカル環境で動作確認（検索・チャット・ログイン）

### 2. StructuredLabel関連チェック

- [ ] FirestoreにStructuredLabelが存在（`npm run label:analyze`）
- [ ] LanceDBにStructuredLabelが同期済み（カバレッジ: 100%）
- [ ] ローカル環境でPhase 1 + Phase 2の改善効果を確認

### 3. インデックス・データチェック

- [ ] LanceDBインデックスが作成済み（`npm run lancedb:create-indexes`）
- [ ] Lunrインデックスが最新（Confluence + Jira）
- [ ] ドメイン知識ファイルが最新（`data/domain-knowledge-v2/*.json`）

### 4. デプロイ準備

- [ ] データをGCSにアップロード（`npm run upload:production-data`）
- [ ] 最終検証（`npx tsx scripts/verify-production-readiness.ts`）

---

## 🚀 デプロイ手順

### Step 1: データ同期（必須）

**重要**: 以下の手順は**必ず順番に実行**してください。

```bash
# Step 1: FirestoreにStructuredLabelを生成（Phase 1 + Phase 2改善版を使用）
npx tsx scripts/generate-structured-labels.ts 5000

# Step 2: ローカルLanceDBに同期
npx tsx scripts/sync-firestore-labels-to-lancedb.ts

# Step 3: インデックスを作成（Step 2の後に実行）
npx tsx scripts/create-lancedb-indexes.ts

# Step 4: GCSにアップロード（Step 2の後に必須で実行）
npx tsx scripts/upload-production-data.ts
```

**確認ポイント**:
- Step 1: 生成されたラベル数が期待どおりか確認（Phase 2改善によりルールベース生成率が67-70%）
- Step 2: 同期結果の統計（ラベルあり/なしの件数）を確認
- Step 3: インデックスが作成されたことを確認
- Step 4: アップロード結果（ファイル数とサイズ）を確認

### Step 2: 最終検証（必須）

```bash
# すべての検証項目が合格することを確認
npx tsx scripts/verify-production-readiness.ts
```

**確認項目**:
- ✅ インデックスが作成されている
- ✅ StructuredLabelが正しく同期されている
- ✅ Firestore同期の状態が正常
- ✅ サンプルページ（`pageId=703594590`）の`structured_tags`が正しく同期されている

### Step 3: コードのプッシュ

```bash
# mainブランチにpush（自動デプロイが開始される）
git push origin main
```

### Step 4: ビルド監視

- Firebase Console → App Hosting → `confluence-chat`
- 所要時間: ビルド 2〜3 分 / デプロイ 1〜2 分

---

## 🔍 デプロイ後の確認

### 1. 本番環境データ検証

```bash
# 本番環境のLanceDBデータをダウンロードして確認
npx tsx scripts/check-production-lancedb-page703594590.ts
```

**確認項目**:
- サンプルページ（`pageId=703594590`）の`structured_tags`が正しく反映されているか
- ローカル環境と本番環境のタグが一致しているか

### 2. 動作確認

1. **スモークテスト**
   - ログイン → チャット表示 → 初期応答が即時ストリーミングされる
   - 代表クエリで検索結果が正しく表示される

2. **StructuredLabel生成精度の確認**
   - 新規ページでStructuredLabelが正しく生成されるか
   - ルールベース生成率が向上しているか（目標: 67-70%）
   - LLM生成の信頼度が0.75になっているか

### 3. ログ監視（初回30分 / 24時間）

- Firebase Console → App Hosting → ログ
- 例外、エラーログを確認
- StructuredLabel生成ログを確認

---

## ⚠️ デグレード防止の確認項目

### インデックス関連

- [ ] Confluence Lunrインデックスが正常に動作
- [ ] Jira Lunrインデックスが正常に動作
- [ ] LanceDBベクトルインデックスが正常に動作
- [ ] LanceDBスカラーインデックスが正常に動作

### ラベル関連

- [ ] StructuredLabelが正しく生成される
- [ ] Firestore → LanceDBの同期が正常
- [ ] 検索結果にStructuredLabelが正しく反映される
- [ ] Composite ScoringでStructuredLabelが使用される

### 検索機能

- [ ] ハイブリッド検索が正常に動作
- [ ] ベクトル検索が正常に動作
- [ ] BM25検索が正常に動作
- [ ] RRF融合が正常に動作
- [ ] Composite Scoringが正常に動作

---

## 📊 改善効果の確認方法

### Phase 1 + Phase 2の改善効果

1. **ルールベース生成率の向上**
   - 改善前: 61.5%
   - 改善後: 67-70%（目標: 75-80%）

2. **LLM生成信頼度の向上**
   - 改善前: 0.7
   - 改善後: 0.75

3. **ドメイン推測精度の向上**
   - 重み付きスコアリングによる精度向上

### 確認方法

```bash
# StructuredLabelの統計を確認
npm run label:analyze

# サンプルページを再生成して改善効果を測定
npm run label:regenerate:sample 30
```

---

## 🔧 トラブルシューティング

### 問題1: StructuredLabelが本番環境に反映されない

**原因**:
- `upload-production-data.ts`を実行していない
- GCSへのアップロードが失敗している

**解決方法**:
```bash
# Step 2とStep 4を再実行
npx tsx scripts/sync-firestore-labels-to-lancedb.ts
npx tsx scripts/upload-production-data.ts
```

### 問題2: インデックスが作成されない

**原因**:
- `sync-firestore-labels-to-lancedb.ts`の前に実行している

**解決方法**:
```bash
# 正しい順序で実行（Step 2 → Step 3）
npx tsx scripts/sync-firestore-labels-to-lancedb.ts
npx tsx scripts/create-lancedb-indexes.ts
```

### 問題3: 検索機能が動作しない

**原因**:
- Lunrインデックスが初期化されていない
- LanceDBインデックスが作成されていない

**解決方法**:
```bash
# Lunrインデックスを再初期化
npx tsx src/scripts/generate-lunr-index.ts

# LanceDBインデックスを再作成
npx tsx scripts/create-lancedb-indexes.ts

# GCSにアップロード
npx tsx scripts/upload-production-data.ts
```

---

## 📚 関連ドキュメント

- [デプロイガイド](./04.01-deployment-guide.md) - 包括的なデプロイガイド
- [拡張スキーマ運用ガイド](./04.05-extended-schema-operation-guide.md) - StructuredLabelの運用方法
- [Phase 1 改善まとめ](../01-architecture/PHASE1_IMPROVEMENT_SUMMARY.md)
- [Phase 2 改善まとめ](../01-architecture/PHASE2_IMPROVEMENT_SUMMARY.md)

---

## 📝 更新履歴

**2025年1月**: 初版作成
- Phase 1 + Phase 2の改善を本番環境にデプロイする手順を追加

