# 環境変数設定ガイド

## 概要

このプロジェクトでは、環境変数の一元管理を行っています。すべての環境変数は `src/config/app-config.ts` で検証され、型安全な設定値として提供されます。

**重要**: 環境変数の設定はアプリケーション起動時に検証されます。必須環境変数が不足している場合、アプリケーションは起動しません。

---

## 必須環境変数一覧

### Confluence設定（必須）

| 環境変数名 | 説明 | 例 | 用途 |
|----------|------|-----|------|
| `CONFLUENCE_BASE_URL` | ConfluenceのベースURL | `https://giginc.atlassian.net` | Confluence APIのエンドポイント |
| `CONFLUENCE_USER_EMAIL` | Confluence APIユーザーのメールアドレス | `kanri@jukust.jp` | API認証 |
| `CONFLUENCE_API_TOKEN` | Confluence APIトークン | （Secret Managerで管理） | API認証 |
| `CONFLUENCE_SPACE_KEY` | Confluenceスペースキー | `CLIENTTOMO` | 同期対象スペース |

**検証ルール**:
- `CONFLUENCE_BASE_URL`: 有効なURL形式である必要があります
- `CONFLUENCE_USER_EMAIL`: 有効なメールアドレス形式である必要があります
- `CONFLUENCE_API_TOKEN`: 空文字列でない必要があります
- `CONFLUENCE_SPACE_KEY`: 空文字列でない必要があります

---

### Gemini設定（必須）

| 環境変数名 | 説明 | 例 | 用途 |
|----------|------|-----|------|
| `GEMINI_API_KEY` | Gemini APIキー | （Secret Managerで管理） | Gemini API（埋め込み・LLM）の認証 |

**検証ルール**:
- 空文字列でない必要があります

**備考**: 
- Genkit SDKでは、`GOOGLEAI_API_KEY` または `GOOGLE_GENAI_API_KEY` もサポートされていますが、このプロジェクトでは `GEMINI_API_KEY` を使用します

---

### Firebase設定（必須 - クライアント側）

| 環境変数名 | 説明 | 例 | 用途 |
|----------|------|-----|------|
| `NEXT_PUBLIC_FIREBASE_API_KEY` | Firebase APIキー | `AIzaSyAga...` | Firebase認証（クライアント側） |
| `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` | Firebase認証ドメイン | `confluence-copilot-ppjye.firebaseapp.com` | Firebase認証（クライアント側） |
| `NEXT_PUBLIC_FIREBASE_PROJECT_ID` | FirebaseプロジェクトID | `confluence-copilot-ppjye` | Firebase設定（クライアント側） |
| `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET` | Firebaseストレージバケット | `confluence-copilot-ppjye.firebasestorage.app` | Firebaseストレージ（クライアント側） |
| `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID` | Firebaseメッセージング送信者ID | `122015916118` | Firebase Cloud Messaging（クライアント側） |
| `NEXT_PUBLIC_FIREBASE_APP_ID` | FirebaseアプリID | `1:122015916118:web:50d117434b1318f173dbf7` | Firebase設定（クライアント側） |

**検証ルール**:
- **Next.jsアプリケーション実行時**: すべての `NEXT_PUBLIC_*` 変数は空文字列でない必要があります（必須）
- **スクリプト実行時**: すべての `NEXT_PUBLIC_*` 変数はオプションです

**備考**: 
- `NEXT_PUBLIC_*` 変数は、Next.jsアプリケーションのビルド時とランタイム時の両方で必要です
- これらの変数はクライアントサイドで使用されるため、ブラウザに公開されます
- **スクリプト実行時（GitHub Actions等）**: これらの変数は不要です。実行環境は `process.env.NEXT_RUNTIME` の存在によって自動判別されます

**詳細**: [環境設定戦略](../01-architecture/01.04.01-environment-configuration-strategy.md) を参照してください。

---

## オプション環境変数

### Jira設定（オプション）

Jira固有の環境変数が設定されていない場合、Confluence設定をフォールバックとして使用します。

| 環境変数名 | 説明 | デフォルト値 | 用途 |
|----------|------|------------|------|
| `JIRA_BASE_URL` | JiraのベースURL | `CONFLUENCE_BASE_URL` の値 | Jira APIのエンドポイント |
| `JIRA_USER_EMAIL` | Jira APIユーザーのメールアドレス | `CONFLUENCE_USER_EMAIL` の値 | API認証 |
| `JIRA_API_TOKEN` | Jira APIトークン | `CONFLUENCE_API_TOKEN` の値 | API認証 |
| `JIRA_PROJECT_KEY` | Jiraプロジェクトキー | （未設定） | Jira同期対象プロジェクト |
| `JIRA_MAX_ISSUES` | 最大取得イシュー数 | `1000` | Jira同期の制限 |

**検証ルール**:
- `JIRA_BASE_URL`: URL形式の場合のみ有効
- `JIRA_USER_EMAIL`: メールアドレス形式の場合のみ有効
- `JIRA_MAX_ISSUES`: 数値形式である必要があります

**備考**: 
- `JIRA_PROJECT_KEY` が未設定の場合、Jira同期機能は使用できません

---

### Firebase設定（オプション - サーバー側）

| 環境変数名 | 説明 | デフォルト値 | 用途 |
|----------|------|------------|------|
| `FIREBASE_PROJECT_ID` | FirebaseプロジェクトID（サーバー側） | `NEXT_PUBLIC_FIREBASE_PROJECT_ID` の値 | Firebase Admin SDK |
| `GOOGLE_CLOUD_PROJECT` | Google CloudプロジェクトID | `NEXT_PUBLIC_FIREBASE_PROJECT_ID` の値 | Google Cloud SDK |

---

### 環境判定

| 環境変数名 | 説明 | デフォルト値 | 用途 |
|----------|------|------------|------|
| `NODE_ENV` | 実行環境 | `development` | 環境判定（development/production/test） |

**使用例**:
```typescript
import { appConfig } from '@/config/app-config';

if (appConfig.environment.isDevelopment) {
  // 開発環境のみの処理
}

if (appConfig.environment.isProduction) {
  // 本番環境のみの処理
}
```

---

### デプロイメント設定

| 環境変数名 | 説明 | デフォルト値 | 用途 |
|----------|------|------------|------|
| `K_SERVICE` | Cloud Runサービス名 | （未設定） | Cloud Run環境判定 |
| `USE_INMEMORY_FS` | インメモリファイルシステムを使用するか | `false` | LanceDBのパス設定 |

**使用例**:
```typescript
import { appConfig } from '@/config/app-config';

if (appConfig.deployment.isCloudRun) {
  // Cloud Run環境での処理
}

if (appConfig.deployment.useInMemoryFS) {
  // インメモリファイルシステムを使用
}
```

**備考**: 
- `USE_INMEMORY_FS=true` の場合、`K_SERVICE` も設定されている必要があります

---

### その他の設定

| 環境変数名 | 説明 | デフォルト値 | 用途 |
|----------|------|------------|------|
| `USE_LLM_EXPANSION` | LLM拡張を使用するか | `false` | LLM機能の有効化 |
| `SKIP_DATA_DOWNLOAD` | データダウンロードをスキップするか | `false` | ビルド最適化 |
| `EMBEDDINGS_PROVIDER` | 埋め込みプロバイダー | `local` | 埋め込み生成方法 |

---

## 環境別設定

### ローカル環境（開発環境）

**設定ファイル**: `.env.local`

```bash
# Confluence設定
CONFLUENCE_BASE_URL=https://giginc.atlassian.net
CONFLUENCE_USER_EMAIL=kanri@jukust.jp
CONFLUENCE_API_TOKEN=your_api_token
CONFLUENCE_SPACE_KEY=CLIENTTOMO

# Jira設定（オプション）
JIRA_PROJECT_KEY=CTJ

# Gemini設定
GEMINI_API_KEY=your_gemini_api_key

# Firebase設定（クライアント側）
NEXT_PUBLIC_FIREBASE_API_KEY=your-firebase-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=confluence-copilot-ppjye.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=confluence-copilot-ppjye
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=confluence-copilot-ppjye.firebasestorage.app
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=122015916118
NEXT_PUBLIC_FIREBASE_APP_ID=1:122015916118:web:50d117434b1318f173dbf7

# 環境判定
NODE_ENV=development
```

**設定方法**:
1. `.env.example` を `.env.local` にコピー
2. 各環境変数の値を設定
3. 機密情報（APIキー、トークン）は適切に管理

---

### 本番環境（Firebase App Hosting）

**設定ファイル**: `setup/apphosting.yaml`

```yaml
env:
  # Confluence API（ランタイムのみ）
  - variable: CONFLUENCE_BASE_URL
    value: https://giginc.atlassian.net
    availability:
      - RUNTIME
  
  - variable: CONFLUENCE_USER_EMAIL
    value: kanri@jukust.jp
    availability:
      - RUNTIME
  
  - variable: CONFLUENCE_SPACE_KEY
    value: CLIENTTOMO
    availability:
      - RUNTIME
  
  # シークレット参照（Secret Manager）
  - variable: CONFLUENCE_API_TOKEN
    secret: confluence_api_token
    availability:
      - RUNTIME
  
  - variable: GEMINI_API_KEY
    secret: gemini_api_key
    availability:
      - BUILD
      - RUNTIME
  
  # Next.js Public環境変数（ビルド時とランタイム時に必要）
  - variable: NEXT_PUBLIC_FIREBASE_API_KEY
    value: your-firebase-api-key
    availability:
      - BUILD
      - RUNTIME
  
  # ... その他の環境変数
```

**設定方法**:
1. `setup/apphosting.yaml` を編集
2. 機密情報は Secret Manager で管理
3. Firebase App Hosting にデプロイ

**Secret Manager の設定**:
```bash
# Secret Manager にシークレットを作成
gcloud secrets create gemini_api_key --data-file=- <<< "your_api_key"
gcloud secrets create confluence_api_token --data-file=- <<< "your_api_token"
```

---

## 設定値の使用方法

### 統合設定ファイルから取得

```typescript
import { appConfig } from '@/config/app-config';

// Confluence設定
const baseUrl = appConfig.confluence.baseUrl;
const userEmail = appConfig.confluence.userEmail;

// Jira設定（フォールバック含む）
const jiraBaseUrl = appConfig.jira.baseUrl;
const maxIssues = appConfig.jira.maxIssues;

// Gemini設定
const apiKey = appConfig.gemini.apiKey;

// Firebase設定
const firebaseConfig = appConfig.firebase;

// 環境判定
if (appConfig.environment.isDevelopment) {
  // 開発環境のみの処理
}

// デプロイメント判定
if (appConfig.deployment.isCloudRun) {
  // Cloud Run環境のみの処理
}
```

---

## エラーハンドリング

### 必須環境変数が不足している場合

アプリケーション起動時に以下のようなエラーが発生します：

```
必須環境変数が設定されていませんまたは無効です:
  - CONFLUENCE_BASE_URL: CONFLUENCE_BASE_URL は有効なURLである必要があります
  - GEMINI_API_KEY: GEMINI_API_KEY は必須です
```

**対処方法**:
1. `.env.local` ファイルに必要な環境変数を設定
2. または、`setup/apphosting.yaml` で環境変数を設定（本番環境）

---

## 設定値の検証

### 自動検証

すべての環境変数は `src/config/app-config.ts` で自動検証されます：

- **型チェック**: Zodスキーマによる型検証
- **フォーマット検証**: URL、メールアドレスなどのフォーマット検証
- **必須チェック**: 必須環境変数の存在確認

### 手動検証

環境変数が正しく設定されているか確認するには：

```bash
# 設定値管理移行のデグレード確認テストを実行
npx tsx scripts/test-config-migration.ts

# 統合テストを実行
npx tsx scripts/test-config-integration.ts
```

---

## ベストプラクティス

### 1. 機密情報の管理

- **ローカル環境**: `.env.local` を使用（`.gitignore` に含める）
- **本番環境**: Secret Manager を使用

### 2. 環境変数の命名規則

- **公開可能な設定**: `NEXT_PUBLIC_*` プレフィックスを使用
- **機密情報**: `*_API_KEY`, `*_API_TOKEN`, `*_SECRET` などの名前を使用

### 3. 設定値の変更

- 設定値を変更する場合は、`src/config/app-config.ts` を更新
- 環境変数のスキーマ定義を更新
- テストを実行して検証

### 4. フォールバックロジック

- Jira設定は、Confluence設定をフォールバックとして使用
- デフォルト値は、統合設定ファイルで一元管理

---

## トラブルシューティング

### 環境変数が読み込まれない

1. `.env.local` ファイルが存在するか確認
2. 環境変数名が正しいか確認（大文字・小文字を区別）
3. アプリケーションを再起動

### 型エラーが発生する

1. `src/config/app-config.ts` のスキーマ定義を確認
2. 環境変数の型が正しいか確認
3. TypeScriptの型チェックを実行: `npm run typecheck`

### 本番環境で環境変数が設定されない

1. `setup/apphosting.yaml` の設定を確認
2. Secret Manager にシークレットが存在するか確認
3. Firebase App Hosting の環境変数設定を確認

### GitHub ActionsでFirebaseクライアント側の環境変数エラーが発生する

**エラーメッセージ例**:
```
Error: 必須環境変数が設定されていませんまたは無効です:
  - NEXT_PUBLIC_FIREBASE_API_KEY: Required
  - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: Required
  ...
```

**原因**: スクリプト実行時にFirebaseクライアント側の環境変数が必須として検証されている（古いバージョンの可能性）

**対処方法**: 
1. 最新のコードをプルして、`src/config/app-config.ts` が最新であることを確認
2. スクリプト実行時は `process.env.NEXT_RUNTIME` が未設定のため、Firebaseクライアント側の環境変数は自動的にオプションとして扱われます
3. それでもエラーが発生する場合は、[環境設定戦略](../01-architecture/01.04.01-environment-configuration-strategy.md) を参照してください

**詳細**: [環境設定戦略](../01-architecture/01.04.01-environment-configuration-strategy.md) のトラブルシューティングセクションを参照してください。

---

## 参考資料

- [統合設定ファイル](../../src/config/app-config.ts)
- [環境設定戦略](../01-architecture/01.04.01-environment-configuration-strategy.md) - 実行環境別の環境変数管理戦略
- [設定値管理の分析結果](../../docs/99-archive/implementation/analysis-reports/config-value-management-analysis.md)
- [Firebase App Hosting 設定ガイド](../../setup/apphosting.yaml)

