# データベース再構築後の本番環境デプロイ手順

> **統合済み:** 再構築シナリオも含めた最新デプロイフローは `deployment-guide.md` に統合しています。本書の詳述手順は履歴として残してあります。

**作成日**: 2025年11月6日  
**対象**: BOM除去処理を含むデータベース再構築後の本番環境デプロイ  
**ステータス**: ✅ 準備完了

---

## 📋 前提条件

### ✅ 完了済み項目

- [x] **ローカル環境でのデータ再同期**: `npm run sync:confluence:batch`を実行済み
- [x] **BOM除去処理の実装**: すべての箇所でBOM除去処理が実装済み
- [x] **トークン化修正の実装**: kuromojiを使用するトークン化処理が実装済み
- [x] **コードのコミット**: すべての変更がコミット済み　

---

## 🚀 本番環境デプロイ手順

### Phase 1: ローカル環境での最終確認

#### ステップ1.1: データベースの状態確認

```bash
# データベースの状態を確認
npm run prepare:production
```

**確認ポイント**:
- ✅ データベースが存在する
- ✅ テーブルが存在する
- ✅ データ件数が想定通りか
- ✅ スキーマが正しい（`page_id`フィールドが存在する）
- ✅ StructuredLabelフィールドが存在する

#### ステップ1.2: インデックスの確認

```bash
# インデックスの状態を確認
npm run lancedb:check-indexes
```

**確認ポイント**:
- ✅ ベクトルインデックス（vector）が存在する
- ✅ スカラーインデックス（page_id）が存在する

#### ステップ1.3: 動作確認

```bash
# ローカル環境で動作確認
npm run dev
```

**確認ポイント**:
- ✅ アプリケーションが正常に起動する
- ✅ 検索機能が正常に動作する
- ✅ BOMエラーが発生しない
- ✅ 「自動オファー」関連のドキュメントが検索結果に含まれる

---

### Phase 2: データベースのアップロード

#### ステップ2.1: 本番データベースのバックアップ（推奨）

```bash
# 本番環境のデータベースをバックアップ
npm run backup:production-data
```

**確認ポイント**:
- ✅ バックアップが成功した
- ✅ バックアップファイルが保存された

#### ステップ2.2: ローカルデータベースのアップロード

```bash
# ローカルで再構築したデータベースを本番環境にアップロード
npm run upload:production-data
```

**確認ポイント**:
- ✅ アップロードが成功した
- ✅ Cloud Storage上のファイルサイズが想定通りか
- ✅ ファイル数が想定通りか
- ✅ エラーが発生していない

**期待される結果**:
- LanceDBファイル: 約7-8 MB
- Lunrインデックス: 約17-18 MB
- その他のキャッシュファイル: 約40 MB
- **合計**: 約65-70 MB

---

### Phase 3: コードのデプロイ

#### ステップ3.1: コードのコミットとプッシュ

```bash
# 変更をコミット（まだの場合）
git add .
git commit -m "fix: add BOM removal processing and tokenization fixes"

# リモートにプッシュ
git push origin main
```

**確認ポイント**:
- ✅ コミットが成功した
- ✅ プッシュが成功した
- ✅ GitHubに反映された

#### ステップ3.2: 自動デプロイの確認

Firebase App Hostingを使用している場合、`main`ブランチへのpushで自動デプロイが開始されます。

**Firebase Consoleで確認**:
```
https://console.firebase.google.com/project/confluence-copilot-ppjye/apphosting
```

**確認ポイント**:
- ✅ `confluence-chat`バックエンドの最新ビルドが開始されているか
- ✅ ビルドが成功しているか（約3-5分）
- ✅ デプロイが成功しているか

**期待される所要時間**:
- ビルド: 約2-3分
- デプロイ: 約1-2分
- **合計**: 約3-5分

---

### Phase 4: インデックスの再構築

#### ステップ4.1: Lunrインデックスの再構築（必須）⚠️

**重要**: 既存のLunrインデックスが古いトークン化方法で構築されている可能性があるため、**再構築が必須**です。

##### 方法A: アプリケーション再起動で自動再構築（推奨）

1. Firebase Consoleでアプリケーションを再起動
   - App Hosting → `confluence-chat` → 「再起動」ボタン
   
2. 再起動後、`LunrInitializer`が自動的にインデックスを再構築します
   - ログで確認: `[LunrInitializer] Building Lunr index...`
   - 再構築時間: 約26秒

##### 方法B: キャッシュファイルを削除して再起動

1. Cloud Shellで実行:
```bash
# プロジェクトを設定
gcloud config set project confluence-copilot-ppjye

# Cloud Storageのキャッシュファイルを削除（オプション）
# 注意: アプリケーションが使用している可能性があるため、再起動前に実行
gsutil rm gs://confluence-copilot-data/.cache/lunr-index.* 2>/dev/null || true
```

2. アプリケーションを再起動

##### 方法C: ローカルで再構築してアップロード

```bash
# ローカルでLunrインデックスを再構築
npm run rebuild:lunr

# 生成されたファイルをCloud Storageにアップロード
gsutil cp .cache/lunr-index.msgpack gs://confluence-copilot-data/.cache/lunr-index.msgpack
gsutil cp .cache/lunr-index.json gs://confluence-copilot-data/.cache/lunr-index.json
```

#### ステップ4.2: ベクトルインデックスの再構築（オプション・推奨）

ベクトルインデックスの再構築は必須ではありませんが、検索精度向上のため推奨されます。

**方法**: 本番環境で直接実行（Cloud Shellまたは適切な権限を持つ環境）

```bash
# プロジェクトを設定
gcloud config set project confluence-copilot-ppjye

# インデックス作成スクリプトを実行
npm run lancedb:create-indexes
```

**注意**: 本番環境のLanceDBテーブルに対して直接実行する必要があります。

---

### Phase 5: 動作確認

#### ステップ5.1: 基本機能の確認

本番環境で以下の項目を確認:

- [ ] **ログイン/認証**: 正常に動作するか
- [ ] **チャット画面の表示**: 正常に表示されるか
- [ ] **ストリーミング応答**: 即座に開始されるか
- [ ] **検索結果の表示**: 正常に表示されるか
- [ ] **参照元の表示**: 正常に表示されるか

#### ステップ5.2: BOMエラーの確認

**重要**: 以前エラーが発生したクエリで再テスト

```bash
# 以前エラーが発生したクエリ
「ログイン認証の仕組みはどうなっていますか？」
```

**確認ポイント**:
- ✅ BOMエラーが発生しない
- ✅ 検索結果が正常に返される
- ✅ 埋め込み生成が正常に動作する

#### ステップ5.3: 検索機能の確認

以下のキーワードで検索を実行し、結果を確認:

- **「自動オファー」**: 関連ドキュメントが検索結果に含まれるか ✅
- **「パーソナルオファー」**: 関連ドキュメントが検索結果に含まれるか
- **「教室コピー」**: 関連ドキュメントが検索結果に含まれるか
- **「ログイン認証」**: 関連ドキュメントが検索結果に含まれるか

#### ステップ5.4: ログの確認

Firebase Console → App Hosting → `confluence-chat` → ログで以下を確認:

```
[LunrInitializer] ✅ Index built in XXXms
[LunrSearchClient] Searching with tokenized query: '自動 オファー'
[BM25 Search] Found XX results
[Vector Search] Found XX results
[BOM REMOVED] searchLanceDB removed BOM from query: ...
```

**確認ポイント**:
- ✅ BOM除去処理が実行されているか
- ✅ トークン化処理が正常に動作しているか
- ✅ エラーが発生していないか

---

## 📊 期待される改善効果

### BOMエラーの解消

- ✅ **BOMエラー**: 発生しない（すべての箇所でBOM除去処理が実装済み）
- ✅ **埋め込み生成**: 正常に動作する
- ✅ **検索機能**: 正常に動作する

### 検索精度の向上

- ✅ **「自動オファー」検索**: 関連ドキュメントが検索結果に含まれる
- ✅ **トークン化の統一**: インデックス構築時と検索時で同じトークン化方法を使用
- ✅ **BM25検索**: 正常に動作する

---

## 🚨 トラブルシューティング

### デプロイ失敗時

1. **ビルドログ確認**: Firebase Consoleで詳細を確認
2. **ローカルビルド**: `npm run build` で再現
3. **ロールバック**: バックアップブランチから復元

### BOMエラーが発生する場合

1. **ログ確認**: Firebase ConsoleでBOM除去処理が実行されているか確認
2. **データ再同期**: `npm run sync:confluence:batch`を再実行
3. **インデックス再構築**: `npm run lancedb:rebuild`を再実行

### 検索結果が期待通りでない場合

1. **Lunrインデックスの確認**: 再構築が完了しているか確認
2. **トークン化の確認**: ログでトークン化処理が正常に動作しているか確認
3. **ベクトルインデックスの確認**: 再構築が完了しているか確認

---

## 📝 デプロイ後の作業

### 即座に実施

- [ ] 基本機能の動作確認
- [ ] BOMエラーの確認（以前エラーが発生したクエリで再テスト）
- [ ] 検索機能の確認（「自動オファー」など）
- [ ] エラーログの確認

### 24時間以内

- [ ] 管理画面でPostLogデータを確認
- [ ] パフォーマンストレンドを分析
- [ ] ユーザーフィードバックを収集
- [ ] BOMエラーが発生していないか確認

### 1週間以内

- [ ] 安定性レポートの作成
- [ ] パフォーマンスレポートの作成
- [ ] BOMエラーの発生状況を確認
- [ ] 次期改善計画の策定

---

## 🎯 成功基準

このデプロイは以下の基準を満たした場合に成功とみなされます：

- ✅ BOMエラーが発生しない
- ✅ 検索機能が正常に動作する
- ✅ 「自動オファー」関連のドキュメントが検索結果に含まれる
- ✅ エラー率 < 1%
- ✅ 総処理時間 < 30秒
- ✅ ユーザー体験の向上

---

## 🔗 関連ドキュメント

- [BOM文字エラーの根本原因（最終確定版）](./../analysis/bom-error-root-cause-final.md)
- [自動オファー検索問題の原因分析](./../analysis/auto-offer-search-issue-root-cause.md)
- [トークン化修正とBOM問題の関係分析](./../analysis/tokenization-bom-relationship-analysis.md)
- [本番環境インデックス再構築手順](./production-index-rebuild-instructions.md)
- [本番デプロイチェックリスト](./production-deployment-checklist.md)

---

**担当者**: 開発チーム  
**レビュー**: 完了  
**承認**: 準備完了  
**デプロイ日時**: 2025年11月6日（予定）

