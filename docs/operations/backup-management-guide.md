# バックアップ管理ガイド

## 概要

このガイドでは、Firestoreデータの自動バックアップシステムの使用方法について説明します。

## 🛡️ データ保護戦略

### 1. 自動バックアップ
- **毎日午前2時**: フルバックアップを自動実行
- **30日分の保持**: 古いバックアップは自動削除
- **エラー時**: 緊急バックアップを自動実行

### 2. 手動バックアップ
- **フルバックアップ**: 全データ（ユーザー、会話、メッセージ、投稿ログ、管理者ログ）
- **緊急バックアップ**: 管理者関連データのみ（ユーザー、管理者ログ）

## 📋 使用方法

### コマンドラインツール

#### フルバックアップ
```bash
# フルバックアップを実行
npm run backup:full

# 即座にフルバックアップを実行
npm run backup:now
```

#### 緊急バックアップ
```bash
# 緊急バックアップを実行
npm run backup:emergency

# 即座に緊急バックアップを実行
npm run backup:emergency-now
```

#### 定期バックアップ
```bash
# 毎日の自動バックアップを開始
npm run backup:schedule:start
```

#### 復元
```bash
# バックアップから復元
npm run backup:restore backups/firestore-backup-2024-01-01T00-00-00-000Z.json
```

### 管理ダッシュボード

1. **管理画面にアクセス**: 管理者権限でログイン
2. **バックアップタブを選択**: 「システム管理」タブ
3. **バックアップ実行**: 「フルバックアップ」または「緊急バックアップ」ボタンをクリック

## 📁 バックアップファイル

### 保存場所
```
backups/
├── firestore-backup-2024-01-01T00-00-00-000Z.json
├── firestore-backup-2024-01-02T00-00-00-000Z.json
├── emergency-backup-2024-01-01T12-00-00-000Z.json
└── ...
```

### ファイル形式
```json
{
  "users": [...],
  "conversations": [...],
  "messages": [...],
  "postLogs": [...],
  "adminLogs": [...],
  "backupDate": "2024-01-01T00:00:00.000Z",
  "backupVersion": "1.0.0"
}
```

## 🔧 トラブルシューティング

### バックアップが失敗する場合

1. **Firebase Admin SDKの認証を確認**
   ```bash
   # 環境変数を確認
   echo $GOOGLE_APPLICATION_CREDENTIALS
   ```

2. **ディスク容量を確認**
   ```bash
   # バックアップディレクトリの容量を確認
   du -sh backups/
   ```

3. **権限を確認**
   ```bash
   # バックアップディレクトリの権限を確認
   ls -la backups/
   ```

### 復元が失敗する場合

1. **バックアップファイルの整合性を確認**
   ```bash
   # JSONファイルの構文チェック
   jq . backups/firestore-backup-*.json
   ```

2. **Firestoreの書き込み権限を確認**
   - Firebase Admin SDKの認証
   - Firestoreルールの設定

## 📊 監視とアラート

### バックアップ状況の確認

1. **管理ダッシュボード**: リアルタイムでのバックアップ状況
2. **ログファイル**: 詳細な実行ログ
3. **ファイルシステム**: バックアップファイルの存在確認

### 推奨される監視項目

- バックアップの実行頻度
- バックアップファイルのサイズ
- バックアップの成功率
- 復元テストの実行

## 🚨 緊急時の対応

### データ損失が発生した場合

1. **最新のバックアップを確認**
   ```bash
   ls -la backups/ | tail -5
   ```

2. **緊急復元を実行**
   ```bash
   npm run backup:restore backups/firestore-backup-最新ファイル名.json
   ```

3. **復元後の検証**
   - ユーザーデータの確認
   - 管理者権限の確認
   - システムの動作確認

### 予防策

1. **定期的な復元テスト**
   ```bash
   # 月1回は復元テストを実行
   npm run backup:restore backups/firestore-backup-テスト用ファイル.json
   ```

2. **複数のバックアップ保存場所**
   - ローカル: `backups/`ディレクトリ
   - クラウドストレージ: Google Cloud Storage
   - 外部ストレージ: USB、外部HDD

## 📈 パフォーマンス最適化

### バックアップ時間の短縮

1. **増分バックアップ**: 変更されたデータのみをバックアップ
2. **並列処理**: 複数コレクションの同時処理
3. **圧縮**: バックアップファイルの圧縮

### ストレージ使用量の削減

1. **データの最適化**: 不要なデータの削除
2. **圧縮**: gzip圧縮の適用
3. **古いバックアップの削除**: 自動クリーンアップ

## 🔐 セキュリティ

### バックアップファイルの保護

1. **暗号化**: 機密データの暗号化
2. **アクセス制御**: ファイルシステムレベルの権限設定
3. **監査ログ**: バックアップ操作の記録

### 復元時のセキュリティ

1. **認証**: 管理者権限の確認
2. **検証**: 復元データの整合性確認
3. **ロールバック**: 問題発生時の即座復旧

## 📞 サポート

### 問題報告

バックアップシステムに関する問題が発生した場合は、以下を確認してください：

1. **ログファイル**: エラーメッセージの詳細
2. **システム状況**: ディスク容量、メモリ使用量
3. **ネットワーク**: Firebase接続状況

### 連絡先

- **技術サポート**: システム管理者
- **緊急時**: 24時間対応のエスカレーション手順
