{
  "id": "779944022",
  "title": "インフラ要件",
  "content": "1. ■前提 非機能要件 旧インフラ構成図 プロジェクト計画書 関連資料 2. ■インフラ構成図 https://drive.google.com/file/d/1geBiE0jHglXPCgZ_HA4YM0YtmLBQyrrS/view?usp=sharing 2.1. 【本番環境】 2.2. 【ステージング環境】 2.3. 【開発環境】 3. ■各種ミドルウェアバージョン ミドルウェア名 バージョン 補足 PHP 7.4.33 8.2.19 にアップデート Nginx 1.25.1 Amazon Aurora Aurora MySQL 3系（MySQL8.0） 4. ■各種サーバスペックおよびコスト 4.1. 【本番環境】 名称 種別 台数 スペック 1ヶ月あたりのコスト （730時間計算） ロードバランサ ALB 1台 - 17.74 USD Webサーバ EC2 2台〜 t3.medium 79.42USD バッチサーバ EC2 1台 t3.medium 39.71 USD 電子署名サーバ EC2 1台 t3.small 19.86 USD 踏み台サーバ EC2 1台 t3.micro 9.93 USD DB AWS Aurora 2台 db.t3.medium &rarr;db.r5.2xlarge（2024/6〜） &rarr;db.r5.xlarge（2024/9〜） 1,692.51 USD AWS Aurora (リーダー) 1台 db.r5.xlarge （2025/2〜） 511USD 4.2. 【ステージング環境】 （10:00 - 21:00までを開放時間とする） &rarr;現在は24時間開放中 にステージング環境を停止した（ロードバランサーは停止できないため、STGを稼働させる時は追加する必要がある） 名称 種別 台数 スペック 1ヶ月あたりのコスト （335時間計算） ロードバランサ ALB 1台 - 17.74 USD （開放時間外も常時稼働） Webサーバ EC2 2台〜 t3.micro 9.13 USD バッチサーバ EC2 1台 t3.micro 4.57 USD 電子署名サーバ EC2 1台 t3.micro 4.57 USD 踏み台サーバ EC2 1台 t3.micro 9.93 USD DB RDS（MySQL8） 1台 db.t3.small 47.88 USD 4.3. 【テスト環境】 （10:00 - 21:00までを開放時間とする） &rarr;現在は24時間開放中 名称 種別 台数 スペック 1ヶ月あたりのコスト （335時間計算） ロードバランサ ALB 1台 - 17.74 USD （開放時間外も常時稼働） Webサーバ EC2 1台 t3.micro 4.57 USD バッチサーバ EC2 1台 t3.micro 4.57 USD 電子署名サーバ EC2 1台 t3.micro 4.57 USD DB RDS（MySQL8） 1台 db.t3.small 47.88 USD 5. ■オートスケーリングの閾値 5.1.1. EC2 項目 設定値 メトリクスタイプ 平均CPU利用率 ターゲット値 50% 希望する台数 2 最小キャパシティ 2 最大キャパシティ 6 5.1.2. Amazon Aurora 項目 設定値 ターゲットメトリクス Aurora レプリカの平均 CPU 使用率 スケールイン閾値 (自動設定：スケールアウト値の-10%) 50% 変更：45%(15 分内の15データポイント) スケールアウト閾値 80% 変更：60%(3 分内の3データポイント) 変更：70% スケーリングアクション Aurora レプリカの追加または削除 最小キャパシティ 2 最大キャパシティ 6 6. ■デプロイフロー 6.1. 【テスト環境】 Bitbucketのdevelopブランチにプッシュ developブランチへのプッシュをトリガーにCodePipelineが作動。 CodeBuildによってテストおよびアプリケーションのパッケージ化を実施 CodeDeployによってテスト環境のインスタンスへ配布 6.2. 【ステージング環境】 Bitbucketのmainブランチにプッシュ mainブランチへのプッシュをトリガーにCodePipelineが作動。 CodeBuildによってテストおよびアプリケーションのパッケージ化を実施 CodeDeployによってステージング環境のインスタンスへ配布 6.3. 【本番環境】 Bitbucketのproductionブランチにプッシュ productionブランチへのプッシュをトリガーにCodePipelineが作動。 CodeBuildによってテストおよびアプリケーションのパッケージ化を実施 CodeDeployによって本番環境のインスタンスへ配布 7. ■旧環境から新環境への切り替えフロー ローカルのhostsを以下のように変更する ドメイン名 IPアドレス www.juku.st 新ロードバランサのIP cdn.juku.st 新CloudFrontのIP 2. 新環境のNginxのアクセスログをtailした上で「 www.juku.st 」にアクセスし以下を確認する 新環境にアクセスが来ていること サイトが不具合なく表示され機能が動作すること 3. ローカルのhostsを戻す 4. 疎通が確認できたらDNSの切り替えを実施 5. 本番環境の接続先が切り替わったことを確認し、動作確認を行う 6. 問題が発生したら旧戻しとしてDNSの戻しを実施する。 8. ■WAF トモノカイ様の 下記の固定IPからのアクセスは全て許可する 182.169.82.19/32（移転先のトモノカイ様のIP） 150.249.207.157/32（以前、トモノカイ様から依頼されたIP） 147.192.8.192/32（以前、トモノカイ様から依頼されたIP） UserAgent「Stanby Job Checker」からのアクセスは全て許可する（求人広告クローラー） サービスサイト配下に同一IPから1分間で50アクセス以上あった場合、ブロックする Stanby Job Checkerの条件は下記 同一 上記useragentで複数IPで1分間あたり25アクセス以上あった場合にブロック facebookexternalhitの条件は下記 上記のuseragentで複数IPで1分間あたり25アクセス以上あった場合にブロック 以下のURLはアクセスカウントから除外する（管理画面/アセット/API） https://www.juku.st/admin配下 https://www.juku.st/asset配下 https://www.juku.st/ favicon.ico 各種API 9. 関連チケット CTJ-1109 0f376871-0459-35fc-b139-2a34c915ec22 System Jira CTJ-1160 0f376871-0459-35fc-b139-2a34c915ec22 System Jira CTJ-191 0f376871-0459-35fc-b139-2a34c915ec22 System Jira ※旧システムで設けていた参照DBを新システムでは廃止とする結論の記載あり。",
  "parentId": "666927316",
  "parentTitle": "非機能要件",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/779944022",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2025-07-03T02:04:06.477Z",
  "author": "kotake_jin",
  "excerpt": "1. ■前提 非機能要件 旧インフラ構成図 プロジェクト計画書 関連資料 2. ■インフラ構成図 https://drive.google.com/file/d/1geBiE0jHglXPCgZ_HA4YM0YtmLBQyrrS/view?usp=sharing 2.1. 【本番環境】 2.2. 【ステージング環境】 2.3. 【開発環境】 3. ■各種ミドルウェアバージョン ミドルウェア名 バー..."
}