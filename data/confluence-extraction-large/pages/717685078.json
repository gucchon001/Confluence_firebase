{
  "id": "717685078",
  "title": "284_【FIX】請求書明細削除機能",
  "content": "1. 目次 1 6 false list false 2. 概要 本機能は 【FIX】請求：請求明細 の登録済みのデータの1件を削除するための機能です。 3. 要求事項 管理画面にログインできるシステム管理者、塾講師ステーション管理者のみが、 273_【FIX】請求詳細閲覧機能 から削除する 【FIX】請求：請求明細 を指定を削除できる。 削除ボタンを押下すると、削除の確認を求める モーダル が表示される。モーダルには次のデータとのボタンを表示する。 請求書明細番号 請求項目名 合計金額 削除するボタン キャンセルボタン 削除確認モーダルでキャンセルを押下すると削除はされず、 273_【FIX】請求詳細閲覧機能 に戻る。 削除ボタンを押下すると、以下の条件に1つでも当てはまる場合はエラーとする。エラーがない場合は、 【FIX】請求：請求明細 を削除し、システム全体に適用する。 条件は以下の通り 。 本システムにより自動生成された明細は削除できない 。 エ ラーメッセージ は次の通り 「システムで自動生成した請求のため削除できません。 」 条件を満たさなかったために削除ができなかった場合のは各条件に応じて表示する。 エラーなく削除された場合、関連する帳票を以下のように更新する。 紐づいていた 【修正中】請求：基本情報 の「請求金額（税込）」と「請求金額：税額」を再計算し更新する。 紐づいていた 【修正中】請求：基本情報 の「承認日時」「発行通知日時」「PDFファイルダウンロード日時」をNullに変更する。 削除後は削除完了ポップアップを表示し、閉じるボタンを配置し押下するとポップアップを閉じる。 削除で成功または失敗した場合、以下の情報が入ったログを出力する。 日時、管理者ID( 【FIX】全体管理者登録情報 のユーザー番号)、請求書明細番号、アクセス元IPアドレス、ユーザーエージェント、アクション（成功or失敗） 3.1. 権限 管理画面にログインできるシステム管理者、塾講師ステーション管理者のみ 3.2. 帳票 概要の記載に同じ。 3.3. メールテンプレート なし 3.4. ワークフロー 270_■請求管理機能 の記載と同じ 4. 要件定義 4.1. ユーザーインターフェース（画面） 4.1.1. 削除確認モーダル https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=76209-21111&amp;mode=design&amp;t=Uql8fO42XzyB2pzQ-0 4.1.2. 削除完了ポップアップ https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=76209-21096&amp;mode=design&amp;t=Uql8fO42XzyB2pzQ-0 4.2. 入力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 項目名 変数名 入力元 説明 制限とエラーメッセージ 1 請求書明細番号 &nbsp; 隠しフォーム 削除する対象の請求書明細の 【FIX】請求：請求明細 における請求書明細番号 &nbsp; 4.3. 出力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 出力項目 出力先 説明 1 請求書明細番号 画面 HTMLエスケープ処理をして出力する。 2 請求項目名 画面 HTMLエスケープ処理をして出力する。 3 合計金額 画面 HTMLエスケープ処理をし、3桁ごとにカンマ区切りで文頭に「&yen;」をつけて出力する。 4 請求金額（税込） データベース 明細の削除に伴い、紐づく 【修正中】請求：基本情報 の同項目を更新する。 5 請求金額：税額 データベース 明細の削除に伴い、紐づく 【修正中】請求：基本情報 の同項目を更新する。 6 承認日時 データベース 明細の削除に伴い、紐づく 【修正中】請求：基本情報 の同項目をNullに変更する。 7 発行通知日時 データベース 明細の削除に伴い、紐づく 【修正中】請求：基本情報 の同項目をNullに変更する。 8 PDFファイルダウンロード日時 データベース 明細の削除に伴い、紐づく 【修正中】請求：基本情報 の同項目をNullに変更する。 9 削除者 データベース 【作成中】帳票共通項目 に従う。 10 削除日時 データベース 【作成中】帳票共通項目 に従う。 4.4. 処理 ログイン状態を確認し、ログイン認証されていない場合は全体管理者画面のログイン画面にリダイレクトし、ログイン認証されているが権限の章に記載した権限を持っていない場合は全体管理者画面のTOP画面にリダイレクトする。 隠しフォームから取得した請求書明細番号文字列を取得し、請求書明細番号文字列が自然数に変換できない場合、レスポンスステータス404 not foundを出力して処理を終了する。 請求書明細番号文字列を元にデータベースから 【FIX】請求：請求明細 を取得する。対象の請求書明細番号のデータが存在しない場合、レスポンスステータス404 not foundを出力して処理を終了する。 削除対象の請求書明細が存在し、 要求定義に記載の条件を満たす場合 【FIX】請求：請求明細 を論理削除とし、削除時間と削除者を記録する。 エラーなく削除された場合、関連する帳票を以下のように更新する。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/906690562#1.1.-%E8%AB%8B%E6%B1%82%E9%9B%86%E8%A8%88%E5%87%A6%E7%90%86 の処理を行う。 紐づいていた 【修正中】請求：基本情報 の「承認日時」「発行通知日時」「PDFファイルダウンロード日時」をNullに変更する。 削除が完了したポップアップを表示し、成功ログを出力して処理を終了する。 なお削除時の影響範囲については https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/772014210#2.-%E5%89%8A%E9%99%A4%E6%99%82%E3%81%AE%E5%8B%95%E4%BD%9C%E4%B8%80%E8%A6%A7 にて まとめている。 4.5. エラー処理 途中で削除に失敗した場合は、それまでに削除した帳票は元に戻してエラーを表示する。 また削除に失敗した理由をエラーとして表示する。 設定ファイルが存在しない、データベースにテーブル・フィールドが存在しない、メールテンプレートファイルが存在しない場合はプログラム上で特別な処理を行わず、Laravelの例外出力に任せる。 4.6. ログ 削除に成功した場合に下記フォーマットでログを出力する User {全体管理者のユーザー番号} deleted invoice billing item. invoice_billing_item_number={請求書明細番号} invoice_number={請求番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 削除に失敗した場合に下記フォーマットでログを出力する 明細レコードの削除に失敗した場合 User {全体管理者のユーザー番号} failed to delete invoice billing item. invoice_billing_item_number={請求書明細番号} invoice_number={請求番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 請求の基本情報の更新に失敗した場 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/906690562#1.3.-%E3%83%AD%E3%82%B0 を参照する。 5. スコープ外・制限事項 なし",
  "parentId": "718798916",
  "parentTitle": "280_■請求書明細管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/717685078/284_+FIX",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2024-07-24T11:21:01.945Z",
  "author": "元ユーザー (Deleted)",
  "excerpt": "1. 目次 1 6 false list false 2. 概要 本機能は 【FIX】請求：請求明細 の登録済みのデータの1件を削除するための機能です。 3. 要求事項 管理画面にログインできるシステム管理者、塾講師ステーション管理者のみが、 273_【FIX】請求詳細閲覧機能 から削除する 【FIX】請求：請求明細 を指定を削除できる。 削除ボタンを押下すると、削除の確認を求める モーダル が表..."
}