{
  "id": "703594590",
  "title": "045_【FIX】パスワード再設定機能",
  "content": "1. 目次 2. 概要 会員がサービスサイトにてパスワードの再設定を行うための機能です。 3. 要求事項 パスワードを忘れた会員は、登録済みのメールアドレス宛に 【FIX】パスワード再設定リクエストメール（会員宛） を送信し、アクセス先の画面で新パスワードを入力することで、ログイン不要でパスワードを変更することができる。 書式や文字数は正しいが会員として登録のないメールアドレスだった場合、エラーは表示せずメールを送信したように見せかける。（攻撃者にヒントを与えないための対応） メールアドレスに書式や文字数の問題があった場合は、エラーを表示する。 退会済みのメールアドレスだった場合は、「送信する」ボタン押下後に、「お使いのメールアドレスは退会済みです。別のメールアドレスでの再登録をしてください。」のエラーメッセージを表示する。 再設定用URLの有効期限は1時間とする。無効となったURLにアクセスした場合、ステータス404（Page Not Found）のページを表示する。 メールアドレス及びパスワードの入力・登録規制は 共通要件 に記載の内容に準ずる。 パスワード再設定が完了してもログイン状態にはせず、完了ページに 042_【FIX】会員ログイン・ログアウト機能 への 導線を設ける。 パスワード再設定が完了 すると 【FIX】パスワード再設定完了通知メール（会員宛） を当該会員の登録済みメールアドレスに通知する。 会員がパスワード再設定のためにメール送信に成功した場合、以下の情報が入ったログを出力する。 日時、 ユーザー番号 、アクセス元IPアドレス、ユーザーエージェント 会員がパスワード再設定に成功した場合、以下の情報が入ったログを出力する。 日時、 ユーザー番号 、アクセス元IPアドレス、ユーザーエージェント 3.1. 権限 サービスサイトにログインできる会員のみ。 3.2. 帳票 【FIX】会員：アカウント情報 3.3. メールテンプレート 【FIX】パスワード再設定リクエストメール（会員宛） 【FIX】パスワード再設定完了通知メール（会員宛） 3.4. ワークフロー なし 3.4.1. 本機能 3.4.2. 関連 4. 要件定義 4.1. ユーザーインターフェース（画面） 4.1.1. パスワード再設定画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=3376-34213&amp;mode=design&amp;t=VTu5IRcFTbHUXT8V-4 4.1.2. パスワード再設定用のメール送信完了画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=3376-34229&amp;mode=design&amp;t=VTu5IRcFTbHUXT8V-4 4.1.3. パスワードを再設定画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=3376-34221&amp;mode=design&amp;t=VTu5IRcFTbHUXT8V-4 4.1.4. パスワード再設定完了 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=3376-34237&amp;mode=design&amp;t=VTu5IRcFTbHUXT8V-4 4.2. 入力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 4.2.1. パスワード再設定用メール送信機能 入力項目 変数名 入力方式 説明 制限とエラーメッセージ メールアドレス フォーム パスワード再設定を行う会員のメールアドレス 必須 パスワード再設定メールテンプレート ファイル パスワード再設定フォームでメールアドレスを入力され、そのメールアドレスのユーザが存在する時のみ、ファイルから取得する。Laravelのメールテンプレートの書式とする。 文字列長及び書式チェックはプログラムにおいては行わない。メールに記載する内容は、 【FIX】パスワード再設定リクエストメール（会員宛） に記載する。 再設定用のtoken有効期限 設定ファイル 設定ファイルに記述した、tokenの有効期限（分）。 設定可能な値は1-1440の数値とする。 設定ファイルの記述の数値が不正な場合、または取得できなかった場合は、デフォルト値を60として処理する。 4.2.2. パスワード再設定機能 入力項目 変数名 入力方式 説明 制限とエラーメッセージ トークン URLパラメータ パスワード再設定メールテンプレートに表示させるURLに仕様されるトークン 必須 パスワード 入力フォーム 初期値なし 必須 4.3. 出力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 4.3.1. パスワード再設定用メール送信機能 出力項目 出力先 説明 メールアドレス データベース／画面 画面の対象フォーム内にHTMLエスケープ処理をして出力、入力エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 トークン データベース パスワード再設定ページにて、バリデーションに問題がない場合のみ、生成されるトークン。 バリデーションに問題があった場合はなにもしない。 パスワード再設定メールテンプレート メール パスワード再設定ページにて、バリデーションに問題がない場合のみ、 【FIX】パスワード再設定リクエストメール（会員宛） を元に必要な変数を差込変換して送信する。 4.3.2. パスワード再設定機能 出力項目 出力先 説明 パスワード データベース／画面 管理者登録成功時にハッシュ化したパスワードを保存する。 更新者 データベース 【作成中】帳票共通項目 の定義に従う。 更新日時 データベース 【作成中】帳票共通項目 の定義に従う。 4.4. 処理 4.4.1. パスワード再設定リクエスト処理 入力されたメールアドレスが存在するかレコードを取得する。 アカウントが存在しなかった場合、以降のステップをスキップしエラーは表示せずメール送信完了画面を表示する（攻撃者にヒントを与えないための対応）。 Laravel準拠の機能でtokenを発行し、入力されたメールアドレスから対象のアカウントのメールアドレス、tokenをデータベースに保存する。 ステップ2で作成されたtoken、対象アカウントのメールアドレスを基にURLを作成し対象アカウントのメールにURLを記載して 【FIX】パスワード再設定リクエストメール（会員宛） を送信する。 送信完了画面を表示する。 4.4.2. パスワード再設定画面表示処理処理 URLからtoken、設定ファイルから再設定用のtoken有効期限を使用して対象のレコードをデータベースから取得する。 レコードが存在すれば再設定フォームを表示する。 レコードが存在しない場合は、ステータス404（Page Not Found）のページを表示する。 4.4.3. パスワード更新処理 URLから取得したトークンをフォームからhiddenで渡し 、対象のレコードをデータベースから取得する。存在しなければスキップしステータス404（Page Not Found）のページを表示する。 入力されたパスワードのバリデーションに問題があれば、エラーメッセージと共にパスワード再設定画面を表示する。 入力されたパスワードに問題がなければ、過去に使用していたパスワードをハッシュ化保存し、入力されたパスワードをLaravel準拠の機能でハッシュ化し対象アカウントのパスワードを更新する。 【FIX】パスワード再設定完了通知メール（会員宛） を対象アカウントに送信し、パスワード再設定完了画面を表示する 4.5. エラー処理 設定ファイルが存在しない、データベースにテーブル・フィールドが存在しない、メールテンプレートファイルが存在しない場合はプログラム上で特別な処理を行わず、Laravelの例外出力に任せる。 4.6. ログ パスワード再設定リクエスト処理 User {ユーザー番号} requested to change password. email={匿名化処理したメールアドレス} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} パスワード再設定画面表示処理 User {ユーザー番号} started to change password. email={匿名化処理したメールアドレス} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} パスワード再設定処理 成功時 User {ユーザー番号} changed password. email={匿名化処理したメールアドレス} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗時 User {ユーザー番号} failed to change password. email={匿名化処理したメールアドレス} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 5. スコープ外・制限事項 パスワードの変更はパスワード再設定機能をもって実施するものとし、マイページ内のパスワード変更機能は設けない。",
  "parentId": "721289315",
  "parentTitle": "040_■アカウント管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/703594590/045_+FIX",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2025-06-20T07:37:56.721Z",
  "author": "isamu saito",
  "excerpt": "1. 目次 2. 概要 会員がサービスサイトにてパスワードの再設定を行うための機能です。 3. 要求事項 パスワードを忘れた会員は、登録済みのメールアドレス宛に 【FIX】パスワード再設定リクエストメール（会員宛） を送信し、アクセス先の画面で新パスワードを入力することで、ログイン不要でパスワードを変更することができる。 書式や文字数は正しいが会員として登録のないメールアドレスだった場合、エラーは..."
}