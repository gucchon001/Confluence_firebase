{
  "id": "744784147",
  "title": "772_【FIX】（クライアント宛）請求書PDF発行通知バッチ",
  "content": "1. 概要 請求書PDF発行の通知をクライアント企業の請求担当者に行う機能です。 本バッチ処理は 毎時55分 (JST)に自動で以下の処理を行う。 クライアント企業に発行通知を行っていない有効な 請求書PDFについて、その発行通知をクライアント企業の請求担当者に1回メールで行う。メールに請求書PDFファイルの添付はしない。 2. 要求事項 コマンドラインで実行する。 バッチ処理を開始したらバッチ処理を開始した旨のメッセージと現在日時を含むログを出力する。 【FIX】請求：請求書PDF から 下記条件に当てはまる 請求書PDFレコードを抽出し、レコードごとにメール送信処理を行う。 作成日時が過去3ヶ月以内である。 ステータスが「承認」である。 送信対象のPDFが 署名付き である。 まだ 請求書PDF発行通知メールを送信していない 。 801_バウンスメール処理バッチ で 保存したバウンスしているメールアドレスかどうか確認 し、 バウンスメールアドレスに該当するならメール送信処理は行わず以下の情報が入った ログを出力 するとともに、そのメールアドレスと企業番号を含む通知メールを管理者に送信する 。 実行日時、請求番号、請求書PDF番号、企業番号、対象メールアドレス、メール送信をスキップしたことがわかる情報 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/851673282/FIX#772%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86-%E3%83%90%E3%82%A6%E3%83%B3%E3%82%B9%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AB%E3%82%88%E3%82%8B%E9%80%81%E4%BF%A1%E5%A4%B1%E6%95%97%E9%80%9A%E7%9F%A5%E3%83%A1%E3%83%BC%E3%83%AB%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88 に送信する。 バウンスメールアドレスに該当しない場合、請求対象のクライアント企業の請求担当者のメールアドレスにメールを送信し、送信を実行したら以下の情報が入ったログを出力する。 実行日時、請求番号、請求書PDF番号、企業番号、対象メールアドレス、アクション（成功or失敗） またPDFが署名されている場合は 、 【FIX】請求：請求書PDF の署名済フラグを「真」に更新する。 必達終了時間は開始から1時間未満とし、処理できる目安の処理件数は1000件とする、これを実現できるパフォーマンスを確保する。 バッチ処理終了時には、バッチ処理が終了した旨のメッセージと終了日時を含んだログを出力する。 本機能からメールを送信した際、 【作成中】メール送信履歴 を保存する。 2.1. メールテンプレート 【FIX】請求書PDF発行通知メール（クライアント企業管理者宛） https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/851673282/FIX#772%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86-%E3%83%90%E3%82%A6%E3%83%B3%E3%82%B9%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AB%E3%82%88%E3%82%8B%E9%80%81%E4%BF%A1%E5%A4%B1%E6%95%97%E9%80%9A%E7%9F%A5%E3%83%A1%E3%83%BC%E3%83%AB%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88 2.2. ワークフロー 【FIX】クライアント企業への請求・支払いフロー 3. 要件定義 3.1. 入力 入力項目 変数名 入力方式 説明 バリデーション 請求番号 &nbsp; データベース 詳細は 【FIX】企業：基本情報 を参照。 請求書PDF番号 データベース 詳細は 【FIX】企業：基本情報 を参照。 企業番号 データベース 詳細は 【FIX】企業：基本情報 を参照。 請求担当者のメールアドレス データベース 詳細は 【FIX】企業：基本情報 を参照。 コマンドラインオプション &nbsp; コマンドライン コマンドラインで実行する際に、 メールを送信をするかどうかをコマンドラインに引数で指定できるように実装する。 &nbsp; メールテンプレート &nbsp; ファイル メールの本文のテンプレート &nbsp; 3.2. 出力 出力項目 出力方式 説明 請求書PDF発行通知日時 データベース 発行通知メール送信済み日時を登録する。 請求書PDF発行通知メール：企業名 メール本文 送信先のクライアント企業名 請求書PDF発行通知メール：請求担当者のメールアドレス メール本文 送信先のクライアント企業の請求担当者のメールアドレス。 請求書PDF発行通知メール：発行年月 メール本文 レコード作成日時を「YYYY年MM月」の形式に変換して出力する。 エラー通知メール：メールアドレス メール本文 バウンスメールに登録されていて送信できなかったメールアドレスを出力する。 エラー通知メール：企業番号 メール本文 バウンスメールに登録されていて送信できなかったメールアドレスを持つ担当者の所属企業の企業番号を出力する。 3.3. 処理 バッチ処理を開始したら、バッチ処理を開始した旨のログを出力する。 書式については https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/744751362#3.5.-%E3%83%AD%E3%82%B0 を参照する。 【FIX】請求：請求書PDF から 下記条件に当てはまる 請求書PDFを抽出し、 請求書PDFごとにメール送信処理を行う。 【FIX】請求：請求書PDF 「created_at」が過去3ヶ月＝90日以内である。 【FIX】請求：請求書PDF のステータスが「承認」である。 【FIX】請求：請求書PDF 請求書PDF発行通知送信日時 が「null」である。 送信対象のPDFファイルが 署名付き である 。 こちらの参考資料を参考にしてください（開発者へ） ： 801_バウンスメール処理バッチ で保存したバウンスしているメールアドレスかどうか確認し、 バウンスメールアドレスに該当するならメール送信処理は行わず以下の情報が入った ログを出力 するとともに、 そのメールアドレスと企業番号を含む通知メールを 管理者に送信する 。 書式については https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/744751362#3.5.-%E3%83%AD%E3%82%B0 を参照する。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/851673282/FIX#772%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86-%E3%83%90%E3%82%A6%E3%83%B3%E3%82%B9%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AB%E3%82%88%E3%82%8B%E9%80%81%E4%BF%A1%E5%A4%B1%E6%95%97%E9%80%9A%E7%9F%A5%E3%83%A1%E3%83%BC%E3%83%AB%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88 に送信する。 バウンスメールアドレスに該当しない場合、メール送信を実行する。 送信成功した場合、 【FIX】請求：請求書PDF の 「請求書PDF発行通知メール送信日時」に処理時間を登録する 。 送信成功した場合、 【修正中】請求：基本情報 の 「発行通知日時」に処理時間を登録する 。 メール送信成功時にログを出力する。 連続してメール送信する場合は、各メールごとに0.1秒間スリープ処理を行う。 メール送信が失敗した場合はリトライ処理を行わない。 バッチ処理終了時には、バッチ処理が終了した旨のメッセージと終了日時を含んだログを出力する。 3.4. エラー処理 バウンスメールに起因しないエラー発生時には、下記通知先にエラーログ通知を行う。 【FIX】バッチエラー時通知先 3.5. ログ バッチ略称はsend_invoice_pdf_file_notification_mail (SIPFNM) とする。 バッジ処理全体が開始した時と終了した時に以下のログを出力する。 開始時 [772_SIPFNM] Started at {処理開始日時}. 終了時 [772_SIPFNM] Finished at {処理終了日時}. メール送信時 成功時 [772_SIPFNM] Succeeded to send invoice pdf file notification mail for mail_address={ メールアドレス } user_number={ユーザー番号（複数時はカンマ区切り）} invoice_number={請求番号} invoice_pdf_file_number={請求PDF番号} company_number={企業番号} time={現在時刻}. 失敗時 [772_SIPFNM] Failed to send invoice pdf file notification mail for mail_address={メールアドレス} user_number={ユーザー番号（複数時はカンマ区切り）} invoice_number={請求番号} invoice_pdf_file_number={請求PDF番号} company_number={企業番号} time={現在時刻}. バウンスメール対応でメール未送信時 [772_SIPFNM] Sending pending because of bounce mail for mail_address={メールアドレス} user_number={ユーザー番号（複数時はカンマ区切り）} invoice_number={請求番号} invoice_pdf_file_number={請求PDF番号} company_number={企業番号} time={現在時刻}. 4. スコープ外・制限事項 なし",
  "parentId": "744423753",
  "parentTitle": "770_■請求関連バッチ",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/744784147/772_+FIX+PDF",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2024-03-14T10:16:03.616Z",
  "author": "元ユーザー (Deleted)",
  "excerpt": "1. 概要 請求書PDF発行の通知をクライアント企業の請求担当者に行う機能です。 本バッチ処理は 毎時55分 (JST)に自動で以下の処理を行う。 クライアント企業に発行通知を行っていない有効な 請求書PDFについて、その発行通知をクライアント企業の請求担当者に1回メールで行う。メールに請求書PDFファイルの添付はしない。 2. 要求事項 コマンドラインで実行する。 バッチ処理を開始したらバッチ処..."
}