{
  "id": "719093957",
  "title": "124_【FIX】企業削除機能",
  "content": "1. 目次 2. 概要 本機能は 【FIX】企業：基本情報 【修正中】企業：設定情報（全体管理者向け） 【FIX】企業：設定情報（クライアント企業向け） の登録済みのデータの1件を削除するための機能です。 また企業削除による影響は 【レビュー中】レコード削除時の動作一覧 にて 列挙している 。 3. 要求事項 全体管理画面にログインすることができるシステム管理者、塾講師ステーション管理者、ゲスト管理者のみが、 125_【FIX】企業詳細閲覧機能 の 画面から企業を削除できる 。 削除ボタンを押下すると、削除の確認を求めるモーダル（アプリ独自）が表示される 。モーダルには次の2つのボタンを表示する。 企業コード 企業番号 企業名 削除するボタン キャンセルボタン 削除ボタンを押下すると、 以下の2つの条件を両方満たす場合に、 関連する帳票における削除対象企業に紐づくデータ が 論理 削除され、システム全体に適用する 。条件を満たさず削除ができなかった場合は、 「 現在、または 過去 半年 以内に有効だった契約がある ため、この企業は削除できません 」 「現在または過去半年以内に有効だった契約があるか、現在または過去に請求情報が存在しているため、この企業は削除できません」 というエラーメッセージを表示する。 条件は以下の通り 現在有効な契約がない。 最後の有効な契約が終了してから 半年 経っている。 現在または過去に請求情報が存在しない。 関連して削除する帳票は以下の通り 。なお、削除した後の動作は 【レビュー中】レコード削除時の動作一覧 とする。 【FIX】企業：基本情報 【修正中】企業：設定情報（全体管理者向け） 【FIX】企業：設定情報（クライアント企業向け） 【FIX】クライアント企業管理者 【FIX】クライアント企業管理者-企業紐付け 【FIX】教室：基本情報／所在地 【FIX】教室：応募情報転送連絡先／応募後連絡先電話番号 【FIX】教室：塾チャート 【FIX】教室：ロゴ・スライド画像 ■商品・契約 【FIX】契約情報（統合版） 【FIX】急募オプション申込付帯情報 ■オファー 【FIX】オファー候補会員検索条件（パーソナルオファー） 【FIX】オファー設定情報（自動オファー） 【FIX】オファー履歴 【FIX】オファーメッセージテンプレート（パーソナルオファー） ■求人・応募・採用 【FIX】求人：基本情報 【FIX】求人：勤務条件・指導科目 【FIX】求人：応募条件・研修情報 【FIX】求人：応募情報等 【FIX】求人：PR情報 【FIX】応募メッセージ情報 【作成中】オシゴトQ＆A 【作成中】オシゴトQ＆A評価 ■請求 【修正中】請求：基本情報 【FIX】請求：請求明細 【FIX】請求：請求書PDF 以下の帳票は削除はしないが、編集・新規紐付けなどをできないようにする。 【FIX】応募情報 【レビュー中】採用お祝い申請 【レビュー中】お祝い申請：質問・回答 キャンセルを押下すると削除はされず、元の詳細表示の画面に戻る。 削除後 は、企業を削除した旨をモーダルで表示し、 121_【FIX】企業一覧閲覧機能 に遷移する。 削除で成功または失敗した場合、以下の情報が入った ログ を出力する 。 日時、管理者ID( 【FIX】全体管理者登録情報 のユーザー番号)、企業番号( 【FIX】企業：基本情報 の企業番号)、アクセス元IPアドレス、ユーザーエージェント、アクション（成功or失敗） 3.1. 権限 全体管理画面にログインすることができるシステム管理者、塾講師ステーション管理者、ゲスト管理者のみ 3.2. 帳票 120_【FIX】企業管理機能 の記載と同じ 3.3. メールテンプレート なし 3.4. ワークフロー 120_【FIX】企業管理機能 の記載と同じ 3.4.1. 本機能 3.4.2. 関連 4. 要件定義 4.1. ユーザーインターフェース（画面） 4.1.1. 削除の確認を求めるモーダル https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=2109-34640&amp;t=nGyEaqDZcand6mWG-4 4.1.2. 削除完了を表示するモーダル https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=2109-34385&amp;t=nGyEaqDZcand6mWG-4 4.2. 入力 変数名、説明、バリデーションは、 【FIX】企業：基本情報 【修正中】企業：設定情報（全体管理者向け） 【FIX】企業：設定情報（クライアント企業向け） 各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 項目名 変数名 入力元 説明 制限とエラーメッセージ 1 企業番号 入力フォーム 隠しフォーム 削除する対象の企業の 【FIX】企業：基本情報 における企業番号 最後に有効な契約が終了してから半年は削除できない 4.3. 出力 出力項目 出力先 説明 1 削除者 データベース 【作成中】帳票共通項目 に従う。 2 削除日時 データベース 【作成中】帳票共通項目 に従う。 4.4. 処理 ログイン状態を確認し、ログイン認証されていない場合は全体管理者画面のログイン画面にリダイレクトし、ログイン認証されているが権限の章に記載した権限を持っていない場合は全体管理者画面のTOP画面にリダイレクトする。 隠しフォームから取得した企業番号文字列を取得し、企業番号文字列が自然数に変換できない場合、レスポンスステータス404 not foundを出力して処理を終了する。 企業番号文字列を元にデータベースから 【FIX】企業：基本情報 【修正中】企業：設定情報（全体管理者向け） 【FIX】企業：設定情報（クライアント企業向け） を取得する。対象の企業番号のデータが存在しない場合、レスポンスステータス404 not foundを出力して処理を終了する。 削除対象の企業が存在し、現在有効な契約がなく、また最後の有効な契約が終了してから 半年 経っている場合、 次の順番で帳票を 論理削除とし、削除時間のみを記録し処理を終了する。 下記を削除する 【修正中】請求：基本情報 【FIX】請求：請求明細 【FIX】請求：請求書PDF 【作成中】オシゴトQ＆A 【作成中】オシゴトQ＆A評価 【FIX】応募メッセージ情報 ■オファー 【FIX】オファー候補会員検索条件（パーソナルオファー） 【FIX】オファー設定情報（自動オファー） 【FIX】オファー履歴 【FIX】オファーメッセージテンプレート（パーソナルオファー） 下記を削除する 【FIX】求人：基本情報 【FIX】求人：勤務条件・指導科目 【FIX】求人：応募条件・研修情報 【FIX】求人：応募情報等 【FIX】求人：PR情報 下記を削除する 【FIX】教室：基本情報／所在地 【FIX】教室：応募情報転送連絡先／応募後連絡先電話番号 【FIX】教室：塾チャート 【FIX】教室：ロゴ・スライド画像 下記を削除する 【FIX】クライアント企業管理者 【FIX】クライアント企業管理者-企業紐付け ■商品・契約 【FIX】契約情報（統合版） 【FIX】急募オプション申込付帯情報 下記を削除する 【FIX】企業：基本情報 【修正中】企業：設定情報（全体管理者向け） 【FIX】企業：設定情報（クライアント企業向け） 削除が完了したポップアップを表示し、成功ログを出力し、 121_【FIX】企業一覧閲覧機能 ページに遷移する。 なお削除時の影響範囲については https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/772014210#2.-%E5%89%8A%E9%99%A4%E6%99%82%E3%81%AE%E5%8B%95%E4%BD%9C%E4%B8%80%E8%A6%A7 にてまとめている。 4.5. エラー処理 途中で削除に失敗した場合は、それまでに削除した帳票は元に戻してエラーを表示する。 削除に失敗した理由をエラーとして表示する。 設定ファイルが存在しない、データベースにテーブル・フィールドが存在しない、メールテンプレートファイルが存在しない場合はプログラム上で特別な処理を行わず、Laravelの例外出力に任せる。 4.6. ログ 企業の削除に成功した場合に下記フォーマットでログを出力する User {全体管理者のユーザー番号} deleted company. company_number={企業番号} company_code={企業コード} company_name={企業名} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 企業の削除に失敗した場合に下記フォーマットでログを出力する User {全体管理者のユーザー番号} failed to delete company. company_number={企業番号} company_code={企業コード} company_name={企業名} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 5. スコープ外 ・制限事項 なし",
  "parentId": "704675888",
  "parentTitle": "120_【FIX】企業管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/719093957/124_+FIX",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2024-03-06T04:34:17.311Z",
  "author": "isamu saito",
  "excerpt": "1. 目次 2. 概要 本機能は 【FIX】企業：基本情報 【修正中】企業：設定情報（全体管理者向け） 【FIX】企業：設定情報（クライアント企業向け） の登録済みのデータの1件を削除するための機能です。 また企業削除による影響は 【レビュー中】レコード削除時の動作一覧 にて 列挙している 。 3. 要求事項 全体管理画面にログインすることができるシステム管理者、塾講師ステーション管理者、ゲスト管..."
}