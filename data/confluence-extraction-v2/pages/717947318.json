{
  "id": "717947318",
  "title": "305_【FIX】請求書PDFダウンロード機能",
  "content": "1. 目次 2. 概要 本機能は全体管理者が 【FIX】請求：請求書PDF の登録済みのデータ1件に紐づくPDFファイルをダウンロードするための機能です。 企業管理画面の 632_【作成中】請求書ダウンロード機能 から同じ機能を利用するときは、共通の処理については本機能の記載に従う。 3. 要求事項 管理画面にログインできるシステム管理者、塾講師ステーション管理者のみ が本機能を利用することができる。 ただし企業管理画面から 632_【作成中】請求書ダウンロード機能 を利用するときは、企業管理画面にログインできるクライアント企業管理者のみが本機能を利用できる、とする。なお自分の企業に紐づかない請求書PDFは閲覧もダウンロードもできない。 301_【FIX】請求書PDF一覧閲覧機能 または 631_【作成中】請求管理 - 一覧閲覧機能 にて、各請求書PDFについて、 署名済みファイルのフォルダ内に対象のPDFファイルがあれば それぞれのダウンロードボタンを 活性化する 。 加えてクライアント管理画面では、該当のPDFのステータスが 「承認済み」 でないと活性化しない。 ダウンロードボタンを押下することで、 【FIX】請求：請求書PDF に記載の ファイルパス先から該当の請求書PDFファイルを（別タブで開くことなく）ダウンロードする。 外部署名サービスの仕様については添付資料を参照 本機能では、以下を表示する 本ページの 「要件定義」-「出力」 欄 で定義されている項目 クライアント管理画面から請求書PDFファイルをダウンロードした場合は、 【FIX】請求：請求書PDF のステータスを「DL済み」に変更し、 【修正中】請求：基本情報 の 「PDFファイルダウンロード日時」にダウンロードがあった時間を保存する。 請求書PDFファイルをダウンロードすると、以下の情報が入ったログを出力する。 日時、管理者ID、請求書PDF番号、アクセス元IPアドレス、ユーザーエージェント 3.1. 権限 要求事項の記載に同じ。 3.2. 帳票 概要の記載に同じ。 3.3. メールテンプレート なし 3.4. ワークフロー 270_■請求管理機能 の記載と同じ 4. 要件定義 4.1. ユーザーインターフェース（画面） なし 4.2. 入力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 項目名 変数名 入力元 説明 制限とエラーメッセージ 請求書PDF番号 URLパラメータ 閲覧する請求書PDFを一意に指定するためのID 入力がない、または、自然数ではない、またはデータベースに存在しない場合 エラーメッセージは出力せずレスポンスステータスを404 not foundとする ファイルパス データベース ダウンロードすべきファイルの所在地を指定する。 外部署名サービスの仕様に沿って、署名済みファイルを示すファイルパスを割り出す。 不正な入力、またはデータベースに存在しない場合 エラーメッセージは出力せずレスポンスステータスを404 not foundとする 4.3. 出力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 出力項目 出力先 説明 ファイル名 レスポンスヘッダー ダウンロードされるファイルのファイル名には、 【FIX】請求：請求書PDF のファイル名を指定する。 PDFファイル本体 レスポンスボディ ダウンロードされるファイル本体。 PDFファイルダウンロード日時 データベース クライアント管理画面からダウンロードした場合は 【修正中】請求：基本情報 の「PDFファイルダウンロード日時」にダウンロード日時を設定する。 ステータス データベース クライアント管理画面からダウンロードした場合は 【FIX】請求：請求書PDF の「ステータス」を「DL済み」に変更する。 4.4. 処理 ログイン状態を確認し、ログイン認証されていない場合は403 Forbiddenを出力して403画面を表示する。 URL文字列から入力されたID文字列を取得し、ID文字列が自然数に変換できない場合、レスポンスステータス404 not foundを出力して処理を終了する。 不正な権限だった場合は、403 Forbiddenを出力して403画面を開く。 外部署名サービスにより署名されたPDFファイルが存在するか確認する。 請求書PDF番号文字列とファイルパスを元にデータベースとストレージからファイル情報を取得する。対象の請求書PDF番号文字列またはファイルが存在しない場合、レスポンスステータス404 not foundを出力して処理を終了する。 対象のPDFデータとファイルが存在したら、出力の記載の通り、ファイルをダウンロードし処理を終了する。 4.5. エラー処理 上記以外で発生した例外に関してはフレームワークの例外処理に任せる。 4.6. ログ ダウンロードした場合に下記フォーマットでログを出力する User {全体管理者またはクライアント企業管理者のユーザー番号} downloaded invoice pdf file . invoice_pdf_file_number={請求書PDF番号} {URI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 5. 制限事項 ファイル署名サービスの仕様書は以下の通り",
  "parentId": "718635198",
  "parentTitle": "300_■請求書PDF管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/717947318/305_+FIX+PDF",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2023-12-22T08:32:37.505Z",
  "author": "元ユーザー (Deleted)",
  "excerpt": "1. 目次 2. 概要 本機能は全体管理者が 【FIX】請求：請求書PDF の登録済みのデータ1件に紐づくPDFファイルをダウンロードするための機能です。 企業管理画面の 632_【作成中】請求書ダウンロード機能 から同じ機能を利用するときは、共通の処理については本機能の記載に従う。 3. 要求事項 管理画面にログインできるシステム管理者、塾講師ステーション管理者のみ が本機能を利用することができ..."
}