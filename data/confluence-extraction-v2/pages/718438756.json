{
  "id": "718438756",
  "title": "303_【FIX】請求書PDF発行機能",
  "content": "1. 目次 2. 概要 本機能は請求書PDFファイルを1件作成するとともに、 【FIX】請求：請求書PDF の登録済みのデータを1件新規追加するための機能です。 現在のPDFファイルのサンプルはこちら ： 3. 要求事項 管理画面にログインできるシステム管理者、塾講師ステーション管理者のみが、 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/704577901 にてPDF発行ボタンを押下することで概要に記載の帳票とファイルを新規作成することができる。 PDFファイル中に使用する文字フォント は IPAゴシックとする 。 ただし数字はNimbusSansを使用する。 対象の請求に紐づく請求明細の再集計処理を行い、PDFの1ページ目を生成する 対象の請求に紐づく請求明細で、設定されている 【FIX】商品マスタ（統合版） の商品種別が 「課金形態」でそのうち「採用課金」と「応募課金」のいずれかである場合は、請求対象の成果報酬の情報収集処理を行い、 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/906690562#1.2.-%E6%8E%A1%E7%94%A8%E8%80%85%E4%B8%80%E8%A6%A7%E9%9B%86%E8%A8%88%E5%87%A6%E7%90%86 の処理を行って PDFの2ページ目以降に「採用者一覧」を生成する。 データベースに出力する内容は、「出力」欄で出力先がデータベースと指定しているものである。 PDFファイルに出力する内容は、「出力」欄で出力先がPDFファイルと指定しているものである。 入力項目に問題なければ、ストレージにファイルを保存し、データベースにレコードを保存し、作成したことを示すポップアップを表示する。ポップアップには閉じるボタンを表示し、押下するとポップアップを閉じる。 入力内容に問題がある場合は問題がわかるようにポップアップを表示する。 なお発行されたPDFファイルは、本システム外の署名サービスによって定期的に自動で署名が付与される。 参考資料は次のとおり： 。 PDF生成と保存で成功した場合、またはエラーが発生した場合、PDF発行操作をする直前に閲覧していたWebページで メッセージを画面上に出力する。 成功メッセージは以下の通り PDFを発行しました。 エラーメッセージは以下の通り PDFの発行に失敗しました。 新規登録で成功または失敗した場合、以下の情報が入ったログを出力する。 日時、管理者ID、請求書PDF番号、アクセス元IPアドレス、ユーザーエージェント、アクション（成功or失敗） 3.1. 権限 要求事項の記載に同じ。 3.2. 帳票 概要の記載と同じ 3.3. メールテンプレート なし 3.4. ワークフロー https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/704414005 に同じ。 4. 要件定義 4.1. ユーザーインターフェース 4.1.1. PDFファイル1枚目 左上の四角枠は、窓付き封筒に対応するもののため、その位置はサンプルと同じ位置で作成するようお願い致します。 厳密には、左上の四角枠は、ページの左端から下に30mm、左に17mmの位置とします。 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=86927-104913&amp;mode=design&amp;t=fPcyoyUMEOaNCB1Q-4 4.1.2. PDFファイル2枚目以降 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=86927-104954&amp;mode=design&amp;t=fPcyoyUMEOaNCB1Q-4 4.1.3. 作成失敗ポップアップ https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=84794-52735&amp;mode=design&amp;t=GDABWk91Dx9sBAtC-4 と同じフォーマットとする。 4.2. 入力 変数名、説明、バリデーションは、帳票の記載を前提とし、本ページに固有の特記事項のみ記載する。 項目名 変数名 入力元 説明 制限 1 請求番号 リクエストボディ 【修正中】請求：基本情報 の請求番号。PDFファイルを作成する対象の請求番号を指定する。 入力がない、または、自然数ではない、または指定IDのレコードがデータベースに存在しない場合 エラーメッセージは出力せずレスポンスステータスを404 not foundとする 4.3. 出力 説明は帳票の記載を前提とし、本ページに固有の特記事項のみ記載する。 項目名 出力先 説明 1 ファイル名 データベース SQLインジェクション対策をしてデータベースに保存する。 形式は「 $ FM請求集計ID $_ $請求年$年$請求月$月請求書.pdf」とする（ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/874151937/2023-11-08?focusedCommentId=877559977 より） また同じ請求に対して複数のPDFファイルを生成した場合は、作成順に応じて「請求書名_n.pdf」という名前とする。2つ目のファイルから_2, _3, &hellip;といった内容である。 2 ファイルサイズ データベース 生成されたファイルのサイズを保存する。 3 ファイルパス データベース 生成されたファイルのパスを保存する。 4 ステータス データベース 「未承認」を保存する。 5 請求金額（税込） データベース PDFファイルに出力する請求金額（税込）をデータベースにも保存する。 6 発行日 PDFファイル 発行日をYYYY年MM月DD日の形式で表示する。 7 発行ID PDFファイル 「年数（4桁）-請求番号-FM請求集計ID」の形式で出力する。 8 請求先情報：住所 PDFファイル 【FIX】企業：請求先・振込先マスタ の「郵便番号」「都道府県」「市区町村」「以降の住所」を表示する。 9 請求先情報：宛先 PDFファイル 【FIX】企業：請求先・振込先マスタ の「企業名」と 【FIX】企業：請求先・振込先マスタ の「担当部署」「担当者名」を表示する。 なお「担当者名」がある場合は、「住所＋企業名＋担当者名 様」と表示する。 「担当者名」がない場合は、「住所＋企業名 御中」と表示する。 10 振込先口座情報 PDFファイル 【FIX】企業：請求先・振込先マスタ の振込先情報の「金融機関名」「支店名」「口座種別」「口座番号」を全て連結して表示する。なお口座種別は「普通口座」なら（普）、総合口座なら（総）と表示する。 11 請求年月 PDFファイル 【修正中】請求：基本情報 の請求対象年月を「YYYY年MM月分」の形式で表示する。 12 支払い期限 PDFファイル 支払い期限日の「支払い期限日」をYYYY年MM月DD日の形式で表示する。 請求対象年月と 、 【FIX】企業：請求先・振込先マスタ の回収サイクル＋ 入金 締日から計算し表示する。 13 請求書明細情報配列 PDFファイル 該当の請求に紐づく請求書明細一覧をデータベースから抽出し、採用者情報レコードの配列をテーブル組みでPDFファイル内に表示する。表示データは以下「 請求書明細情報 ：」プレフィックスで始まる出力項目とする。 14 請求書明細情報：取引日 PDFファイル 1つ目のレコードを1とし、レコードの数だけ連番で数を表示する。なおこれは応募番号ではない。 15 請求書明細情報：請求項目名 PDFファイル 【FIX】請求：請求明細 の「請求項目名」を表示する。 16 請求書明細情報：数量 PDFファイル 【FIX】請求：請求明細 の「数量」を表示する。 17 請求書明細情報：単位 PDFファイル 【FIX】請求：請求明細 の「単位」を表示する。 18 請求書明細情報：単価 PDFファイル 【FIX】請求：請求明細 の「単価」を表示する。文頭に&yen;をつけ、3桁区切りのカンマ表示とする。 19 請求書明細情報：金額 PDFファイル 【FIX】請求：請求明細 の「金額」を表示する。文頭に&yen;をつけ、3桁区切りのカンマ表示とする。 20 小計 PDFファイル 各明細の合計金額を表示する。文頭に&yen;をつけ、3桁区切りのカンマ表示とする。 21 消費税 PDFファイル 請求金額の内税額を表示する。文頭に&yen;をつけ、3桁区切りのカンマ表示とする。 22 合計 PDFファイル 請求金額を税込で表示する。文頭に&yen;をつけ、3桁区切りのカンマ表示とする。 23 備考 PDFファイル 【修正中】請求：基本情報 の「備考」を表示する。 24 作成日 PDFファイル 発行日をYYYY年MM月DD日の形式で表示する。 25 お客様No. PDFファイル FM請求集計IDを表示する。 26 企業名 PDFファイル 請求先の企業名を表示する。 27 採用者情報配列 PDFファイル 該当の請求に紐づく採用者一覧をデータベースから抽出し、採用者情報レコードの配列をテーブル組みでPDFファイル内に表示する。表示データは以下「採用者情報：」プレフィックスで始まる出力項目とする。 28 採用者情報：レコード番号 PDFファイル 1つ目のレコードを1とし、レコードの数だけ連番で数を表示する。なおこれは応募番号ではない。 29 採用者情報：教室名 PDFファイル 【FIX】応募情報 の「採用された教室」の教室名を表示する。 30 採用者情報：単価（税込） PDFファイル 単価を税込で表示する。 税区分が内税の場合は「単価」*「数量」、税区分が外税の場合は「単価」*「数量」*（1＋「税率」） の計算を行って小数点以下が発生した場合は切り上げ 31 採用者情報：課金形態種別 PDFファイル その採用に紐づく契約の商品の「課金形態種別」を表示する。 4.4. 処理 4.4.1. 共通処理 ログイン状態を確認し、ログイン認証されていない場合は各管理者画面のログイン画面にリダイレクトする。全体管理画面の場合、ログイン認証されているが権限の章に記載した権限を持っていない場合は 全体管理者画面のTOP画面 にリダイレクトする。 4.4.2. 新規登録処理 リクエストボディから請求番号及び請求書PDF番号を受け取り、「入力」の定義にしたがって値の妥当性検査をおこなう。 入力項目値の妥当性に問題があった場合は、「入力」の定義にしたがって、本機能にリクエストを送信する際に表示していたページ上にエラーメッセージをポップアップを画面で表示して処理を終了する。 対象の請求番号に問題がなければ、要求事項に記載の請求書テンプレートに従い、下記処理の通りPDFファイルを生成する。 再集計処理を行ってPDFの１ページ目を生成する https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/906690562#1.1.-%E8%AB%8B%E6%B1%82%E9%9B%86%E8%A8%88%E5%87%A6%E7%90%86 に従って集計処理を行う。 対象の請求に対する教室・グループの契約で設定されている 【FIX】商品マスタ（統合版） の商品種別が 「課金形態」でそのうち「採用課金」と「応募課金」のいずれかである契約の場合は請求対象の成果報酬の情報収集処理を行う。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/906690562#1.2.-%E6%8E%A1%E7%94%A8%E8%80%85%E4%B8%80%E8%A6%A7%E9%9B%86%E8%A8%88%E5%87%A6%E7%90%86 に従って処理を行う。 生成したPDFを安全に保存可能なストレージに保存し、対象のPDFファイルの情報、作成日時、更新日時を操作している現在日時とし操作を行なっている全体管理者のユーザー番号を作成者/更新者に設定した上でデータベースに 【FIX】請求：請求書PDF の新規レコードとして挿入する。 PDF生成と保存でエラーが発生した場合PDF発行操作をする直前に閲覧していたWebページを表示し、 PDF作成が失敗した旨のメッセージ を画面上に出力する。成功した場合は同様に直前に閲覧していたWebページ上に成功した旨のメッセージを表示する。 成功メッセージは以下の通り PDFを発行しました。 エラーメッセージは以下の通り PDFの発行に失敗しました。 4.5. エラー処理 上記以外で発生した例外に関してはフレームワークの例外処理に任せる。 4.6. ログ 新規登録処理を実行した場合に下記フォーマットでログを出力する。 成功した場合 User {全体管理者のユーザー番号} created invoice pdf file. invoice_number={請求番号} invoice_pdf_file_number={請求書PDF番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} User {全体管理者のユーザー番号} created invoice pdf file. invoice_number={請求番号} invoice_pdf_file_number={請求書PDF番号} invoice_billing_items_numbers={再計算の対象にした請求詳細の番号をカンマ区切りで} application_numbers={レコード収集の対象にした応募の番号をカンマ区切りで} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗した場合 User {全体管理者のユーザー番号} failed to create invoice pdf file. invoice_number={請求番号} failure={失敗したプロセス} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} なお失敗したプロセスは以下 再集計で失敗した recalculation 成果報酬のレコード収集に失敗した collecting_hiring_bill_record PDFの生成に失敗した generating_pdf_file PDFファイルの保存に失敗した saving_pdf_file PDF情報のデータベース保存に失敗した creating_pdf_record 5. スコープ外・制限事項 なし",
  "parentId": "718635198",
  "parentTitle": "300_■請求書PDF管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/718438756/303_+FIX+PDF",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2024-10-07T09:48:02.248Z",
  "author": "ejiri_yusuke",
  "excerpt": "1. 目次 2. 概要 本機能は請求書PDFファイルを1件作成するとともに、 【FIX】請求：請求書PDF の登録済みのデータを1件新規追加するための機能です。 現在のPDFファイルのサンプルはこちら ： 3. 要求事項 管理画面にログインできるシステム管理者、塾講師ステーション管理者のみが、 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/..."
}