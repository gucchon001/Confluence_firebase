{
  "id": "717685125",
  "title": "306_【作成中】請求書PDF手動アップロード機能",
  "content": "1. 目次 2. 概要 本機能はPDFファイルをアップロードし 【FIX】請求：請求書PDF を1件登録するための機能です。 3. 要求事項 全体管理画面にログインすることができるシステム管理者、塾講師ステーション管理者、ゲスト管理者、のみが本機能を利用できる。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/880607390 で「請求書PDFアップロード」ボタンを押下することで、アップロード用のモーダルが表示され、必要な情報の入力、およびアップロードするPDFファイル選択を行うことができる。 必要な情報の入力、およびファイル選択後、「アップロード」ボタンを押下した際に、「アップロードしますか？」という確認モーダルを表示する。 OKが選択された場合 入力内容・ファイル形式をチェックする。 入力内容にエラーがあった場合は、該当箇所にエラー内容を表示し、処理は行わない。 PDFファイル以外の場合は、「PDF形式のファイルをアップロードしてください」とエラーメッセージを表示し、処理は行わない。 入力内容・ファイル形式に問題がない場合 ファイルをS3サーバに保存する。 入力内容を元に 【FIX】請求：請求書PDF の新規登録を行う。 キャンセルが選択された場合は処理を行わず、確認モーダルを閉じ、PDFファイル選択モーダルに戻る。 キャンセルが選択された場合は処理を行わず、PDFファイル選択モーダルを閉じて https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/880607390 に戻る。 同じファイル名のファイルがアップロードされた場合も、既存の同名ファイルの更新は行わず、新たなファイル名で新規登録する。 アップロードされたファイルは https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/718438756 で発行したPDFファイルと同じ様に、署名処理が行われる。 4. 要件定義 4.1. ユーザーインターフェース（画面） 4.1.1. 請求詳細（アップロードボタン設置ページ） https://www.figma.com/design/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?node-id=77634-51318&amp;t=sEs2omNdiqeXUbkP-0 4.1.2. PDFファイル選択モーダル https://www.figma.com/design/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?node-id=92892-62508&amp;t=VXykGy3LRjBbyDn0-0 4.2. 入力 変数名、説明、バリデーションは、帳票（ 【FIX】請求：請求書PDF ）の記載を前提とし、本ページに固有の特記事項のみ記載する。 項目名 変数名 入力元 説明 制限 1 請求番号 &nbsp; 隠しフォーム 【修正中】請求：基本情報 の請求番号。PDFファイルをアップロードする対象の請求番号を指定する。 必須 入力がない、または、自然数ではない、または指定IDのレコードがデータベースに存在しない場合 エラーメッセージは出力せずレスポンスステータスを404 not foundとする 2 ファイル名 入力フォーム 必須 最大100文字 3 請求金額（税込） 入力フォーム 半角数字 4.3. 出力 説明は帳票の記載を前提とし、本ページに固有の特記事項のみ記載する。 4.3.1. 請求書PDF 対象帳票： 【FIX】請求：請求書PDF 項目名 出力先 説明 1 請求番号 データベース SQLインジェクション対策をしてデータベースに保存する。 2 ファイル名 データベース SQLインジェクション対策をしてデータベースに保存する。 同じ請求に対して既存のPDFファイルと同じファイル名のPDFファイルをアップロードした場合は、重複する2つ目以降は作成順に応じて「[ファイル名]_n.pdf」という名前とする。（1つ目のファイルには番号をつけず、2つ目のファイルから_2, _3, &hellip;とする） 3 ファイルサイズ データベース アップロードされたファイルのサイズを保存する。 4 ファイルパス データベース アップロードされたファイルのパスを保存する。 5 ステータス データベース 「未承認」を保存する。 6 請求金額（税込） データベース SQLインジェクション対策をしてデータベースに保存する。 4.4. エラー処理 4.5. ログ アップロード処理を実行した場合に下記フォーマットでログを出力する。 成功した場合 User {全体管理者のユーザー番号} uploaded invoice pdf file. invoice_number={請求番号} invoice_pdf_file_number={請求書PDF番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗した場合 User {全体管理者のユーザー番号} failed to upload invoice pdf file. invoice_number={請求番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント}",
  "parentId": "718635198",
  "parentTitle": "300_■請求書PDF管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/717685125/306_+PDF",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2025-01-22T08:54:21.177Z",
  "author": "ejiri_yusuke",
  "excerpt": "1. 目次 2. 概要 本機能はPDFファイルをアップロードし 【FIX】請求：請求書PDF を1件登録するための機能です。 3. 要求事項 全体管理画面にログインすることができるシステム管理者、塾講師ステーション管理者、ゲスト管理者、のみが本機能を利用できる。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/880607390 ..."
}