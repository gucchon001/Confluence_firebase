{
  "id": "703496358",
  "title": "442_【FIX】管理者招待・登録機能",
  "content": "1. 目次 2. 概要 全体管理画面にログインしたいユーザーを招待し、招待されたユーザー が全体管理者 アカウント を登録するための機能。 3. 要求事項 全体管理者 招待 全体管理者が、全体 管理者招待用モーダル で、全体管理画面にログインしたい全体管理者へメールアドレスを指定して招待メール（ 【FIX】全体管理者招待メール（新規に利用する全体管理者宛） ）を送信する。 全体管理者招待用モーダルへは、 441_【FIX】管理者一覧閲覧機能 ページの「招待」用ボタンを押下することで遷移することができる。 全体管理者招待用モーダルの入力項目は以下とする。 本ページの本ページの「要件定義」-「入力」-「4.2.1. 管理者登録情報入力画面管理者招待ページ表示処理」欄（ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/703496358#4.2.1.-%E7%AE%A1%E7%90%86%E8%80%85%E7%99%BB%E9%8C%B2%E6%83%85%E5%A0%B1%E5%85%A5%E5%8A%9B%E7%94%BB%E9%9D%A2%E7%AE%A1%E7%90%86%E8%80%85%E6%8B%9B%E5%BE%85%E3%83%9A%E3%83%BC%E3%82%B8%E8%A1%A8%E7%A4%BA%E5%87%A6%E7%90%86 ）で入力元が「入力フォーム」と定義されている項目 招待する用ボタンを押下すると入力項目に問題なければ、招待したことがわかる表示がされると同時に、 441_【FIX】管理者一覧閲覧機能 ページへ遷移する。 問題があればエラーメッセージが表示される。（入力規制は要件定義で定義する。） メールアドレスがすでに全体管理者として登録済みのものである場合はエラーとし、招待メールは送信しない。 全体管理者招待で成功した場合、以下の情報が入ったログを出力する。 日時、招待をした全体管理者ID、アクセス元IPアドレス、ユーザーエージェント、アクション（成功）、部分的にマスクしたメールアドレス aaaaaa@bbb.co.jpをa************@bbb.co.jp と出力する、など。） 全体管理者登録 招待を受けた本人が必要な項目を登録することで新規の全体管理者アカウントを作成することができる。 招待を受けた本人は、招待メール（ 【FIX】全体管理者招待メール（新規に利用する全体管理者宛） ）に表示されるユニークなURLを押下することで、全体管理者アカウント登録用ページへ遷移することができる。 ユニークなURLの有効期限は 24時間 1週間 とする。 またメールが再送された場合、有効期限内であっても前回のメールにあるユニークなURLを無効とする。無効となったURLにアクセスした場合、ステータス404（Page Not Found）のページを表示する。 全体 管理者登録用ページの項目は 以下 とする。尚、以下の他は 【FIX】全体管理者登録情報 に記載の内容に準ずる。 本ページの「要件定義」-「入力」-「4.2.2管理者登録ページ」（ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/703496358#4.2.2%E7%AE%A1%E7%90%86%E8%80%85%E7%99%BB%E9%8C%B2%E3%83%9A%E3%83%BC%E3%82%B8 ）欄で入力元が「入力フォーム」と定義されている項目 登録する用ボタンを押下すると入力項目に問題なければ、更新されたことがわかる表示がされると同時に、全体 管理画面のログインページ（ 451_【FIX】全体管理者ログイン・ログアウト機能 ）へ遷移する 。 問題があればエラーメッセージが表示される。（入力規制は要件定義で定義する。） 全体管理者 登録で成功した場合、以下の情報が入ったログを出力する。 日時、新規登録された全体管理者のユーザー番号、アクセス元IPアドレス、ユーザーエージェント、アクション（成功） 本機能からメールを送信した際、 【作成中】メール送信履歴 を保存する。 3.1. 権限 全体管理画面にログインすることができるシステム管理者のみが、新規の全体管理者を招待することができる。 3.2. 帳票 【FIX】全体管理者登録情報 3.3. メールテンプレート 【FIX】全体管理者招待メール（新規に利用する全体管理者宛） 3.4. ワークフロー 【FIX】全体管理者登録・削除フロー 4. 要件定義 4.1. ユーザーインターフェース（画面） 4.1.1. 管理者招待画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=3293-34149&amp;mode=design&amp;t=1SHhS7Wt9wd3dII3-0 4.1.2. 管理者招待完了画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=1806%3A29417&amp;t=r3IqqflxoqksJqnt-1 4.1.3. 管理者登録情報入力画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=1806%3A30142&amp;t=r3IqqflxoqksJqnt-1 4.1.4. 管理者登録情報入力完了画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=1806%3A29431&amp;t=r3IqqflxoqksJqnt-1 4.2. 入力 変数名、説明、バリデーションは、 【FIX】全体管理者登録情報 の記載を前提とし、本ページに固有の特記事項のみ記載する。 440_【FIX】管理者管理機能 に記載の共通入力・取得項目は項目自体を省略する。 4.2.1. 全体管理者招待処理 項目名 変数名 入力元 説明 制限とエラーメッセージ 1 管理者種別 入力フォーム 初期値なし 必須 2 メールアドレス &nbsp; 入力フォーム 初期値なし 必須 3 IPアドレス制限 入力フォーム 初期値＝する 必須 4 管理者招待メールテンプレート ファイル 管理者招待フォームでバリデーションチェックに問題がない時にのみ、ファイルから取得する。Laravelのメールテンプレートの書式とする。 文字列長及び書式チェックはプログラムにおいては行わない。メールに記載する内容は、 【FIX】全体管理者招待メール（新規に利用する全体管理者宛） に記載する。 5 登録認証用のtoken有効期限 設定ファイル 設定ファイルに記述した、tokenの有効期限（分）。 設定可能な値は1- 1440 10080 の数値とする。 設定ファイルの記述の数値が不正な場合、または取得できなかった場合は、デフォルト値を60として処理する。 &nbsp; 4.2.2. 全体管理者登録処理 項目名 変数名 入力元 説明 制限とエラーメッセージ 1 氏名 name 入力フォーム &nbsp;初期値なし 必須 2 氏名（フリガナ） 入力フォーム 初期値なし 必須 3 パスワード password 入力フォーム 初期値なし 必須 4 画像 入力フォーム 初期値なし 5 ニックネーム 入力フォーム 初期値なし 6 PR 入力フォーム 初期値なし 7 自己紹介ページURL 入力フォーム 初期値なし 8 トークン &nbsp; URLパラメータ 管理者アカウント招待メーに表示させるURLに仕様されるトークン 必須 4.3. 出力 4.3.1. 全体管理者招待処理 出力項目 出力先 説明 1 トークン データベース 管理者招待ページにて、バリデーションに問題がない場合のみ、生成されるトークン。招待用テーブルに保存される バリデーションに問題があった場合はなにもしない。 2 管理者種別 データベース 管理者招待ページにて、バリデーションに問題がない場合のみ、招待用のテーブルに保存する。 バリデーションに問題があった場合はなにもしない。 3 メールアドレス データベース 管理者招待ページにて、バリデーションに問題がない場合のみ、招待用のテーブルに保存する。 バリデーションに問題があった場合はなにもしない。 4 IPアドレス制限 データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内に、入力された値が指し示す選択肢が選択された状態で表示する。エラーがない場合は入力された値にSQLインジェクション対策をしてデータベースに保存する。 5 管理者招待メール メール 管理者招待ページにて、バリデーションに問題がない場合のみ、管理者招待メールテンプレートを元に必要な変数を差込変換して送信する。 4.3.2. 全体管理者登録処理 出力項目 出力先 説明 1 氏名 データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内にHTMLエスケープ処理をして出力、エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 2 氏名（フリガナ） データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内にHTMLエスケープ処理をして出力、エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 3 パスワード データベース 管理者登録成功時にハッシュ化したパスワードを保存する。 4 画像 データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内に出力、エラーがない場合はデータベースに保存する。 5 ニックネーム データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内にHTMLエスケープ処理をして出力、エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 6 PR データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内にHTMLエスケープ処理をして出力、エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 7 自己紹介ページURL データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内にHTMLエスケープ処理をして出力、エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 8 作成者 データベース 【作成中】帳票共通項目 の定義に従う。 9 作成日時 データベース 【作成中】帳票共通項目 の定義に従う。 10 更新者 データベース 【作成中】帳票共通項目 の定義に従う。 11 更新日時 データベース 【作成中】帳票共通項目 の定義に従う。 4.4. 処理 ログイン状態を確認し、ログイン認証されていない場合は全体管理者画面のログイン画面にリダイレクトし、ログイン認証されているが権限の章に記載した権限を持っていない場合は全体管理者画面のTOP画面にリダイレクトする。 4.4.1. 入力画面表示処理 本ページの「入力」（ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/703496358#4.2.-%E5%85%A5%E5%8A%9B ）に記載の全ての項目の入力フォームと登録ボタンを配置した画面を表示する。 4.4.2.全体管理者招待処理 入力フォームからのデータを受け取り、「入力」の定義にしたがって値の妥当性検査をおこなう。 入力項目値の妥当性に問題があった場合は、どの項目にどのような問題が発生したかわかるようにエラーメッセージを表示し、入力された値を入力フォーム内に表示・選択された状態で画面を出力して処理を終了する。 入力項目値の妥当性に問題がない場合は、入力された項目値と、作成日時、更新日時を操作している現在時刻とし、操作を行なっている全体管理者のユーザー番号を作成者/更新者に設定した上でデータベースに新規レコードとして挿入する。 4.4.3. 全体管理者登録処理 入力フォームからのデータを受け取り、「入力」の定義にしたがって値の妥当性検査をおこなう。 入力項目値の妥当性に問題があった場合は、どの項目にどのような問題が発生したかわかるようにエラーメッセージを表示し、入力された値を入力フォーム内に表示・選択された状態で画面を出力して処理を終了する。 入力項目値の妥当性に問題がない場合は、入力された項目値と、 作成日時、 更新日時を操作している現在時刻とし、操作を行なっている全体管理者のユーザー番号を 作成者/ 更新者に設定した上でデータベースに 新規レコードとして挿入 保存 する。 451_【FIX】全体管理者ログイン・ログアウト機能 ページへリダイレクト し、新規データ登録が完了したことがわかるように以下のメッセージを表示する。 管理者情報を新規登録しました。 4.5. エラー処理 上記以外で発生した例外に関してはフレームワークの例外処理に任せる。 4.5.1. ログ 全体管理者招待画面を表示した場合に下記フォーマットでログを出力する。 User {操作を実行した全体管理者のユーザー番号} started to invite administrator. {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 全体管理者招待処理を実行した場合に下記フォーマットでログを出力する。 成功 User {操作を実行した全体管理者のユーザー番号} invited administrator. type={管理者種別} email={ 匿名化処理した メールアドレス} ip_restriction={IPアドレス制限} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗 User {操作を実行した全体管理者のユーザー番号} failed to invite administrator. type={管理者種別} email={ 匿名化処理した メールアドレス} ip_restriction={IPアドレス制限} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 全体管理者登録画面を表示した場合に下記フォーマットでログを出力する。 Invited user started to create administrator. type={管理者種別} email={ 匿名化処理した メールアドレス} ip_restriction={IPアドレス制限} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 全体管理者登録処理を実行した場合に下記フォーマットでログを出力する。 成功 Invited user created administrator. user_number={登録された全体管理者のユーザー番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗 Invited user failed to create administrator. type={管理者種別} email={ 匿名化処理した メールアドレス} ip_restriction={IPアドレス制限} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} メールアドレスの匿名化処理は 共通要件 の記載に従う。 5. 制限事項 なし",
  "parentId": "703791312",
  "parentTitle": "440_【FIX】管理者管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/703496358/442_+FIX",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2024-03-13T03:37:13.741Z",
  "author": "元ユーザー (Deleted)",
  "excerpt": "1. 目次 2. 概要 全体管理画面にログインしたいユーザーを招待し、招待されたユーザー が全体管理者 アカウント を登録するための機能。 3. 要求事項 全体管理者 招待 全体管理者が、全体 管理者招待用モーダル で、全体管理画面にログインしたい全体管理者へメールアドレスを指定して招待メール（ 【FIX】全体管理者招待メール（新規に利用する全体管理者宛） ）を送信する。 全体管理者招待用モーダル..."
}