{
  "id": "906690562",
  "title": "（共通）請求関連共通処理",
  "content": "1. 集計処理 1.1. 請求集計処理 指定の 【修正中】請求：基本情報 の 請求番号 に紐づく全ての 【FIX】請求：請求明細 について、税額について 以下の条件で 集計し、すべての合計額を 【修正中】請求：基本情報 の「請求金額：税額」に設定する。 外税の場合は「単価」*「数量」*（「税率」/100）の計算を行って小数点以下が発生した場合は切り上げ。 内税の場合は、「単価」*「数量」* （税率/（100＋税率））を小数点を切り下げ。 指定の 【修正中】請求：基本情報 の請求番号に紐づく全ての 【FIX】請求：請求明細 について、以下の条件で金額を集計し、すべての合計額を 【修正中】請求：基本情報 の「請求金額（税込）」に設定する。 外税の場合は「単価」*「数量」*（（税率＋100）/100）の計算を行って小数点以下が発生した場合は切り上げ。 内税の場合は「金額」をそのまま使用する。 1.2. 採用者一覧集計処理 対象の 【FIX】請求：請求明細 に紐づく 契約の 【FIX】商品マスタ（統合版） の商品種別が 「課金形態」であり、課金種別が「応募課金」または「採用課金」である 場合は、以下の通り、該当する 採用者の一覧集計 処理を 行う。 応募課金の場合 対象の 【FIX】請求：請求明細 に紐づく 【FIX】応募情報 を すべて抽出する 。 採用課金の場合 対象の 【FIX】請求：請求明細 に紐づく 【FIX】応募情報 をすべて抽出する。 （請求書PDFファイル発行の場合）抽出した 【FIX】応募情報 を、請求書PDFの２ページ目以降にページを追加しながらすべて出力する。 1.3. ログ 再計算を行い、基本情報を更新した時のみログを出す。 再計算の対象にした請求明細の番号をカンマ区切りで出力する。 レコード収集の対象にした応募の番号をカンマ区切りで出力する。 成功した場合 User {操作した人のユーザー番号} do invoice recalculation process. invoice_number={請求番号} invoice_billing_items_numbers={再計算の対象にした請求詳細の番号をカンマ区切りで} application_numbers ={レコード収集の対象にした応募の番号をカンマ区切りで} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} エラーがあった場合 User {操作した人のユーザー番号} failed to update invoice. invoice_number={請求番号} failure_type={失敗したプロセス} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 再集計で失敗した recalculation 成果報酬のレコード収集に失敗した collecting_hiring_bill_record 基本情報の更新に失敗した場合 updating_invoice_fields 2. 採用・在籍確認変更による請求反映処理 2.1. 採用ステータス変更による請求への反映処理 【FIX】応募情報 の 採用ステータスが変更された 時に、対象の 【FIX】応募情報 に紐づく課金形態商品が「採用課金」の場合、下記を行う。 該当する月の請求明細との紐付け処理 「採用課金：確定時期」が「即時」の場合 該当の採用課金契約に紐づく 【FIX】請求：請求明細 のうち、採用ステータス変更日が含まれる月の 【FIX】請求：請求明細 を 【FIX】応募情報 と紐づける。 「採用課金：確定時期」が「即時」以外の場合 何もしない 紐づけた 【FIX】請求：請求明細 において、下記を行う。 「採用」以外から「採用」へ変更した場合 数量を１増やす。 「採用」から「採用」以外へ変更した場合 数量を１減らす。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/906690562#1.1.-%E8%AB%8B%E6%B1%82%E9%9B%86%E8%A8%88%E5%87%A6%E7%90%86 の処理で 【修正中】請求：基本情報 へ更新内容を反映する。 2.2. 在籍確認 などの 変更による請求への反映処理 【FIX】応募情報 の 「在籍確認：日付」 「請求確定日時」 が設定 ・変更 された時 、または「採用された教室番号」が変更された時 に、対象の 【FIX】応募情報 に紐づく課金形態商品が「採用課金」の場合、下記を行う。 該当する月の請求明細との紐付け処理 「採用課金：確定時期」が「即時」の場合 何もしない 「採用課金：確定時期」が「即時」以外の場合 該当の採用課金契約に紐づく 【FIX】請求：請求明細 のうち、 採用ステータス変更日 「請求確定日時」 が含まれる月 から、紐づく 【FIX】商品マスタ（統合版） の「採用課金：確定時期」の分だけ後の月 の 【FIX】請求：請求明細 を 【FIX】応募情報 と紐づける。 ただし、 紐付け予定の月の 【FIX】請求：請求明細 および 【修正中】請求：基本情報 が存在していない場合は、 紐付け前にそれぞれ新規に作成する 。 【FIX】請求：請求明細 ： https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714211558/112+FIX#4.3.3.-%E8%AB%8B%E6%B1%82%E6%98%8E%E7%B4%B0 の定義に従って作成する。 【修正中】請求：基本情報 ： https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714211558/112+FIX#4.3.2.-%E8%AB%8B%E6%B1%82%E5%9F%BA%E6%9C%AC%E6%83%85%E5%A0%B1 の定義に従って作成する。 「請求確定日時」を変更した場合 は、変更前に紐づけていた 【FIX】請求：請求明細 との紐付けは解除する。 紐づけた 【FIX】請求：請求明細 において、下記を行う。 「採用」以外から「採用」へ変更した場合 数量を１増やす。 「採用」から「採用」以外へ変更した場合 数量を１減らす。 紐づけを解除した 【FIX】請求：請求明細 において、下記を行う。 数量を1減らす。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/906690562#1.1.-%E8%AB%8B%E6%B1%82%E9%9B%86%E8%A8%88%E5%87%A6%E7%90%86 の処理で 【修正中】請求：基本情報 へ更新内容を反映する。 3. 関連機能 本ページの処理が参照されている機能は下記の通り。 サービスサイト 応募 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/703463606 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/865599790 全体管理画面 契約 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714211558 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637410 請求明細 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/718307540 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/704446760 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/717685078 請求書PDF https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/744784147 応募管理 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/704381188 採用確認 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/724631564 クライアント企業管理者向け管理画面 応募管理 ※現行踏襲の場合は採用確認へ遷移させているが、応募管理への統一も考えられる。 採用確認 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/721256720",
  "parentId": "704414005",
  "parentTitle": "270_■請求管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/906690562",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2025-02-27T08:45:35.472Z",
  "author": "ejiri_yusuke",
  "excerpt": "1. 集計処理 1.1. 請求集計処理 指定の 【修正中】請求：基本情報 の 請求番号 に紐づく全ての 【FIX】請求：請求明細 について、税額について 以下の条件で 集計し、すべての合計額を 【修正中】請求：基本情報 の「請求金額：税額」に設定する。 外税の場合は「単価」*「数量」*（「税率」/100）の計算を行って小数点以下が発生した場合は切り上げ。 内税の場合は、「単価」*「数量」* （税率..."
}