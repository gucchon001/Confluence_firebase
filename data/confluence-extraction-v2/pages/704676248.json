{
  "id": "704676248",
  "title": "453_【FIX】パスワード再設定機能",
  "content": "1. 目次 1 6 false list false 2. 概要 全体管理者が全体管理画面にて、パスワードを再設定するための機能。 3. 要求事項 パスワードを忘れた全体管理者が、登録済みのメールアドレス宛に再設定用URLを送信し、アクセス先の画面で新パスワードを入力することで、ログイン不要でパスワードを変更することができる。 書式や文字数は正しいが担当者として登録のないメールアドレスだった場合、エラーは表示せずメールを送信したように見せかける。（攻撃者にヒントを与えないための対応） メールアドレスに書式や文字数の問題があった場合は、エラーを表示する。 パスワード再設定ページのメールアドレス入力画面 ではログイン状態に合わせて以下のボタンを表示する。 ログイン時 「トップへ」ボタンを押下すると、全体管理画面トップへ遷移する。 未ログイン時 「ログインページに戻る」ボタンを押下すると、 451_【FIX】全体管理者ログイン・ログアウト機能 へ遷移する。 再設定用URLの有効期限は1時間とする。無効となったURLにアクセスした場合、ステータス404（Page Not Found）のページを表示する。 メールアドレス及びパスワードの入力・登録規制は 共通要件 に記載の内容に準ずる。 パスワード再設定が完了してもログイン状態にはせず、完了ページに 451_【FIX】全体管理者ログイン・ログアウト機能 への導線を設ける。 パスワード再設定が完了した旨を、当該の全体管理者の登録済みメールアドレスに通知する。 全体管理者がパスワード再設定のためにメール送信に成功した場合、以下の情報が入ったログを出力する。 日時、管理者ID、アクセス元IPアドレス、ユーザーエージェント、アクション（成功） 全体管理者がパスワード再設定に成功した場合、以下の情報が入ったログを出力する。 日時、管理者ID、アクセス元IPアドレス、ユーザーエージェント、アクション（成功） 本機能からメールを送信した際、 【作成中】メール送信履歴 を保存する。 3.1. 権限 全体管理画面にログインすることができる、アカウントを持つ全体管理者のみ。 3.2. 帳票 【FIX】全体管理者登録情報 3.3. メールテンプレート 3.3.1. パスワード再設定メール 【作成中】パスワード再設定メール（全体管理者宛） 3.3.2. パスワード再設定完了通知メール 【作成中】パスワード再設定完了通知メール（全体管理者宛） 3.4. ワークフロー なし 4. 要件定義 4.1. ユーザーインターフェース（画面） 4.1.1. パスワード再設定_メール送信画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=35927-43057&amp;mode=design&amp;t=j7JIxmHIPrljOLqp-0 4.1.2. パスワード再設定_送信完了画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=35927-43782&amp;mode=design&amp;t=8HxJWdHYMTViQgKG-0 4.1.3. パスワード再設定_新パスワード設定画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=35927-43827&amp;mode=design&amp;t=FyK8jGyGxSPzxL1a-0 4.1.4. パスワード再設定_新パスワード設定完了画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=35927-43894&amp;mode=design&amp;t=LZj7HAC3YZb7p5oH-0 4.2. 入力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 4.2.1. パスワード再設定 入力項目 変数名 入力方式 説明 バリデーション メールアドレス email フォーム パスワード再設定を行う全体管理者のメールアドレス 必須 128文字以下 email (Laravel準拠) パスワード再設定メールテンプレート ファイル パスワード再設定フォームでメールアドレスを入力され、そのメールアドレスのユーザが存在する時のみ、ファイルから取得する。Laravelのメールテンプレートの書式とする。 文字列長及び書式チェックはプログラムにおいては行わない。メールに記載する内容は、本表以下に記載する。 メールアドレス データベース パスワード再設定メールテンプレートに表示させるURLに使用されるメールアドレス トークン データベース パスワード再設定メールテンプレートに表示させるURLに使用されるトークン 再設定用のtoken有効期限 設定ファイル 設定ファイルに記述した、tokenの有効期限（分）。 設定可能な値は1-1440の数値とする。 設定ファイルの記述の数値が不正な場合、または取得できなかった場合は、デフォルト値を60として処理する。 4.2.2. 新パスワード設定 入力項目 変数名 入力方式 説明 バリデーション 新しいパスワード password フォーム 新しく設定するパスワード 使用できる記号は 共通要件 参照 必須 共通要件 に従う。 7文字以上 20文字以下 半角英数字 英大文字・英小文字・数字の3種を必ず含む。 半角記号 過去２回使用していたパスワードは使用不可。 照合用の発行されたトークン token フォーム Laravelの機能で作成されたtoken hiddenで渡す 必須 パスワード再設定完了通知メールテンプレート ファイル パスワード再設定が完了した時のみ、ファイルから取得する。Laravelのメールテンプレートの書式とする。 文字列長及び書式チェックはプログラムにおいては行わない。メールに記載する内容は、本表以下に記載する。 4.3. 出力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 4.3.1. パスワード再設定 出力項目 出力方式 説明 パスワード再設定メール メール パスワード再設定ページにて、バリデーションに問題がない場合のみ、 【作成中】パスワード再設定メール（全体管理者宛） を元に必要な変数を差込変換して送信する。 トークン データベース パスワード再設定ページにて、バリデーションに問題がない場合のみ、生成されるトークン。 バリデーションに問題があった場合はなにもしない。 管理者ID データベース パスワード再設定メールのtokenの照合に用いるuserIDを保存する。 メールアドレス データベース／画面 画面の対象フォーム内にHTMLエスケープ処理をして出力、入力エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 4.3.2. 新パスワード設定 出力項目 出力方式 説明 パスワード再設定完了通知メール メール パスワード再設定成功時に、 【作成中】パスワード再設定完了通知メール（全体管理者宛） を元に必要な変数を差込変換して送信する。 パスワード データベース パスワード再設定に成功した場合に新しいパスワードをLaravel準拠の暗号方式で暗号化して保存する。 更新者 データベース 【作成中】帳票共通項目 の定義に従う。 更新日時 データベース 【作成中】帳票共通項目 の定義に従う。 4.4. 処理 4.4.1. パスワード再設定リクエスト処理 入力されたメールアドレスが存在するかレコードを取得する。 アカウントが存在しなかった場合、以降のステップをスキップしエラーは表示せずメール送信完了画面を表示する（攻撃者にヒントを与えないための対応）。 Laravel準拠の機能でtokenを発行し、入力されたメールアドレスから対象のアカウントのメールアドレス、tokenをデータベースに保存する。 ステップ2で作成されたtoken、対象アカウントのメールアドレスを基にURLを作成し対象アカウントのメールにURLを記載して 【作成中】パスワード再設定メール（全体管理者宛） を送信する。 送信完了画面を表示する。 4.4.2. パスワード再設定画面表示処理処理 URLからtoken、設定ファイルから再設定用のtoken有効期限を使用して対象のレコードをデータベースから取得する。 レコードが存在すれば再設定フォームを表示する。 レコードが存在しない場合は、ステータス404（Page Not Found）のページを表示する。 4.4.3. パスワード更新処理 URLから取得したトークンをフォームからhiddenで渡し、対象のレコードをデータベースから取得する。存在しなければスキップしステータス404（Page Not Found）のページを表示する。 入力されたパスワードのバリデーションに問題があれば、エラーメッセージと共にパスワード再設定画面を表示する。 入力されたパスワードに問題がなければ、過去に使用していたパスワードをハッシュ化保存し、入力されたパスワードをLaravel準拠の機能でハッシュ化し対象アカウントのパスワードを更新する。 【作成中】パスワード再設定完了通知メール（全体管理者宛） を対象アカウントに送信し、パスワード再設定完了画面を表示する 4.5. エラー処理 設定ファイルが存在しない、データベースにテーブル・フィールドが存在しない、メールテンプレートファイルが存在しない場合はプログラム上で特別な処理を行わず、Laravelの例外出力に任せる。 4.6. ログ パスワード再設定リクエスト処理 User {操作をした全体管理者のユーザー番号} requested to change password. email={匿名化処理したメールアドレス} user={メールアドレスに紐づくユーザーのユーザー番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} パスワード再設定画面表示処理 User {操作をした全体管理者のユーザー番号} started to change password. user={メールアドレスに紐づくユーザーのユーザー番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} パスワード再設定処理 成功時 User {操作をした全体管理者のユーザー番号} changed password. user={メールアドレスに紐づくユーザーのユーザー番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗時 User {操作をした全体管理者のユーザー番号} failed to change password. user={メールアドレスに紐づくユーザーのユーザー番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 5. スコープ外・制限事項 パスワードの変更はパスワード再設定機能を以って実施するものとし、マイページ内のパスワード変更機能は初期フェーズでは実装しない。",
  "parentId": "721027302",
  "parentTitle": "450_■アカウント管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/704676248/453_+FIX",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2024-03-13T03:38:07.753Z",
  "author": "元ユーザー (Deleted)",
  "excerpt": "1. 目次 1 6 false list false 2. 概要 全体管理者が全体管理画面にて、パスワードを再設定するための機能。 3. 要求事項 パスワードを忘れた全体管理者が、登録済みのメールアドレス宛に再設定用URLを送信し、アクセス先の画面で新パスワードを入力することで、ログイン不要でパスワードを変更することができる。 書式や文字数は正しいが担当者として登録のないメールアドレスだった場合、..."
}