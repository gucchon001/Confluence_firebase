{
  "id": "714637410",
  "title": "114_【FIX】契約編集機能",
  "content": "1. 目次 2. 概要 本機能は 【FIX】契約情報（統合版） の登録済みのデータ1件を編集するための機能です。 3. 要求事項 管 理画面にログインすることができるシステム管理者、塾ステーション管理者のみが本機能を利用することができる。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 のページにおいて、本ページの「要件定義」-「入力」欄（ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637410#4.2.-%E5%85%A5%E5%8A%9B ）で入力元が「入力フォーム」または「ボタン」と定義されている項目を編集することができる。 編集操作は、それぞれ下記にて行う 無効にするボタン 「課金形態」の商品に紐づく契約の場合は、ボタンが表示されず、無効にすることができない。 押下すると、ユーザーへの実行確認ダイアログが表示される。 無効にするボタンを押下すると、対象の契約、および、紐づく子契約も併せて無効化し、 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 へ遷移して無効化が完了したことがわかるメッセージを表示する。 キャンセルボタンを押下することで無効化を取り消し、 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 に遷移する。 メモを保存するボタン 押下することで、編集した入力フォームの内容をデータベースに保存し、 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 へ遷移して保存が完了したことがわかるメッセージを表示する。 契約を無効にした場合、紐づく商品の種類によって下記の通りとする。 基本の場合、該当の企業、教室グループに紐づく教室の 求人を非 掲載 とする。 オプションの場合、該当のオプションの効果を無効にする。 無効化の内容は下記とする。 設定した「付与プラン」を解除し、残っている契約の設定値に戻す 。 つまり、該当教室のプランおよび プラン優先度 を残った契約に従って更新する。 設定した「急募追加数」によって登録されている急募をすべて無効化する 。詳細は、 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/718438619 で定める定義に従う。 付与した「パーソナルオファー追加数」によって追加されたオファー可能数のうち、 未使用のオファー数分を削減する 。詳細は https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/704413832 で定める定義に従う。 商品の種類によらず 、無効にした契約に紐づく 【FIX】請求：請求明細 のうち、無効日時が含まれる月より未来の月の 【FIX】請求：請求明細 はすべて削除（論理削除）する。 また、対象の 【FIX】請求：請求明細 に紐づく 【修正中】請求：基本情報 の請求金額、税額を （共通）請求関連共通処理 に基づいて更新する。 また、 【FIX】請求：請求明細 削除によって紐づく 【FIX】請求：請求明細 が無くなった 【修正中】請求：基本情報 および紐付く 【FIX】請求：請求書PDF も 削除（論理削除）する。 編集で成功または失敗した場合、以下の情報が入ったログを出力する。ログは、変更した契約情報1レコードごとに別々に出力する。 日時、編集を実行した全体管理者のユーザー番号、アクセス元IPアドレス、ユーザーエージェント、アクション（成功or失敗） 3.1. 権限 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637353 の記載と同じ 3.2. 帳票 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637353 の記載と同じ 3.3. メールテンプレート なし 3.4. ワークフロー https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637353 の記載と同じ 4. 要件定義 4.1. ユーザーインターフェース（画面） 4.1.1. 契約詳細閲覧画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=1888-30160&amp;mode=design&amp;t=U96XB953ZxpQmuog-0 4.1.2. 契約無効化確認画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=3767-35340&amp;mode=design&amp;t=AEts0oS8FbxkgdvV-0 4.1.3. 契約無効化完了画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=3767-35725&amp;mode=design&amp;t=AEts0oS8FbxkgdvV-0 4.1.4. メモ保存完了画面 https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=1888-30207&amp;mode=design&amp;t=AEts0oS8FbxkgdvV-0 4.2. 入力 変数名、説明、バリデーションは、 【FIX】契約情報（統合版） の記載を前提とし、本ページに固有の特記事項のみ記載する。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637353 に記載の共通入力・取得項目は項目自体を省略する。 「制限」に「必須」とある場合に入力がない場合のエラーメッセージは統一して「{項目名}を入力してください」とする。 項目名 変数名 入力元 説明 制限とエラーメッセージ 1 契約番号 &nbsp; URLパラメータ 編集する対象の契約を一意に指定する。 入力がない、または、自然数ではない、または指定IDのレコードがデータベースに存在しない場合 エラーメッセージは出力せずレスポンスステータスを404 not foundとする 2 無効化日時 &nbsp; ボタン https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 の「無効にする」ボタンおよび、無効化確認画面の「無効にする」ボタンを押下することで、無効化が完了した日時を設定する。 3 無効化実行者 ボタン https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 の「無効にする」ボタンおよび、無効化確認画面の「無効にする」ボタンを押下することで、無効化をおこなった全体管理者情報を設定する。 4 メモ &nbsp; 入力フォーム 初期値はデータベースから読み込んだ値。 テキストボックス。 任意項目。 4.3. 出力 説明は、 【FIX】契約情報（統合版） の記載を前提とし、本ページに固有の特記事項のみ記載する。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637353 に記載の共通出力項目は項目自体を省略する。 出力項目 出力先 説明 1 契約情報 画面 無効にする契約情報、および、該当契約が親契約として紐づいている他の契約情報を、HTMLエスケープ処理をして出力する。 1契約あたりの表示は、「[契約番号]_[商品ID]_[対象サイト]_[商品種別]_[有効期間：開始日]-[有効期間：終了日]」形式とする。有効期間の開始日・終了日は、yyyy/mm/dd-yy/mm/ddとする。 2 無効化日時 データベース 無効化が完了した日時を保存する。 3 無効化実行者 データベース 無効化を行った全体管理者のユーザー番号を保存する。 4 メモ データベース/画面 入力妥当性検査によるエラー発生時は画面の対象フォーム内に入力された改行を維持したままHTMLエスケープ処理をして出力、エラーがない場合はSQLインジェクション対策をしてデータベースに保存する。 5 更新者 データベース 【作成中】帳票共通項目 の定義に従う。 6 更新日時 データベース 【作成中】帳票共通項目 の定義に従う。 4.4. 処理 ログイン状態を確認し、ログイン認証されていない場合は全体管理者画面のログイン画面にリダイレクトし、ログイン認証されているが権限の章に記載した権限を持っていない場合は全体管理者画面のTOP画面にリダイレクトする。 URL文字列または隠しフォーム入力から契約番号文字列を取得し、入力がない場合/自然数ではない場合はレスポンスステータス404 not foundを出力して処理を終了する。 指定された契約番号でデータベースから該当するレコードを抽出する。 該当するレコードがデータベース上に存在しない場合はレスポンスステータス404 not foundを出力して処理を終了する。 4.4.1. 編集フォーム画面表示処理 該当するレコードが見つかったら、「出力」（ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637410#4.3.-%E5%87%BA%E5%8A%9B ） に記載の通り、表示項目と入力可能項目に項目値を反映させて画面を出力し処理を終了する。 4.4.2. 編集処理 該当するレコードが見つかったら、「入力」（ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714637410#4.2.-%E5%85%A5%E5%8A%9B ） に記載の入力項目値の妥当性検査を行う。 入力項目値の妥当性に問題があった場合は、どの項目にどのような問題が発生したかわかるようにエラーメッセージを表示し、入力された値を入力フォーム内に表示・選択された状態で編集フォーム画面を出力して処理を終了する。 入力項目値の妥当性に問題がない場合は、入力された項目値と、更新日時を操作している現在時刻とし、操作を行なっている全体管理者のユーザー番号を更新者に設定した上でデータベースの該当レコードを更新する。 該当のレコードの保存した情報を閲覧できる https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 へリダイレクトし処理を終了する。 4.5. エラー処理 上記以外で発生したエラー/例外に関してはフレームワークの例外処理に任せる。 4.6. ログ 編集画面に遷移した場合に下記フォーマットでログを出力する User {全体管理者のユーザー番号} started to update contract. contract_number={契約番号} company_number={企業番号} brand _number={教室グループ番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 編集処理を実行した場合に下記フォーマットでログを出力する 成功の場合 User {全体管理者のユーザー番号} updated contract. contract_number={契約番号} company_number={企業番号} brand _number={教室グループ番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗の場合 User {全体管理者のユーザー番号} failed to update contract. contract_number={契約番号} company_number={企業番号} brand _number={教室グループ番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 無効化処理を実行した場合に下記フォーマットでログを出力する 成功の場合 User {全体管理者のユーザー番号} invalidated contract. contract_number={契約番号} company_number={企業番号} brand_number={教室グループ番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 失敗の場合 User {全体管理者のユーザー番号} failed to invalidate contract. contract_number={契約番号} company_number={企業番号} brand_number={教室グループ番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 5. スコープ外・制限事項 同時編集に対する明示的な対策は施さない。 同時に編集が実行された際は後勝ちとし、後から保存ボタンを押して実行した時の編集値が適用される。 編集画面において他のユーザーまたは他のウィンドウ・タブが本機能にアクセスしたことをアプリケーションは検知しない。",
  "parentId": "714637353",
  "parentTitle": "110_【FIX】契約管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/714637410/114_+FIX",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2025-05-09T08:42:56.764Z",
  "author": "ejiri_yusuke",
  "excerpt": "1. 目次 2. 概要 本機能は 【FIX】契約情報（統合版） の登録済みのデータ1件を編集するための機能です。 3. 要求事項 管 理画面にログインすることができるシステム管理者、塾ステーション管理者のみが本機能を利用することができる。 https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/714604678 のページにおいて、本ペー..."
}