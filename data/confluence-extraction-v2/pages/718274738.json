{
  "id": "718274738",
  "title": "135_【FIX】企業担当者削除機能",
  "content": "1. 目次 2. 概要 本機能は 【FIX】クライアント企業管理者 【FIX】クライアント企業管理者-企業紐付け の登録済みのデータの1件を削除するための機能です。 3. 要求事項 131_【FIX】企業担当者一覧閲覧機能 ページの該当レコード内にある削除用ボタンを押下し、削除確認モーダル上で削除実行用のボタンを押下することで、以下の条件が満たされていれば対象のクライアント企業管理者情報を論理削除することができる。 削除対象のクライアント企業管理者が所属する企業には、削除対象のクライアント企業管理者以外にも管理者フラグがOFFの請求担当が存在する（言い換えると、そのクライアント企業管理者がその企業で唯一の管理者フラグがOFFの請求担当ではない）。 逆に以上の条件が満たされない場合は、対象のクライアント企業管理者を削除できない 通知モーダルを表示 する。 削除確認用モーダルには、本ページの 「要件定義」-「出力」欄 （ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/718274738#4.3.-%E5%87%BA%E5%8A%9B ）で出力先として「画面」が定義されている項目を表示する。 削除に成功すると、削除されたことがわかる表示がされると同時に、 131_【FIX】企業担当者一覧閲覧機能 ページへ遷移する。削除に失敗した場合はエラーメッセージが表示される。（規制は要件定義で定義する。） 全体管理者情報は削除時に本ページの 「要件定義」-「出力」欄 （ https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/718274738#4.3.-%E5%87%BA%E5%8A%9B ）で説明欄に匿名化する旨の記載がある項目の匿名化を行う。 削除後は 131_【FIX】企業担当者一覧閲覧機能 ページから非表示となる。 削除に成功した場合、以下の情報が入ったログを出力する。 削除日時、削除操作を実施した全体管理者のユーザー番号、削除されたクライアント企業管理者のユーザー番号、アクセス元IPアドレス、ユーザーエージェント 3.1. 権限 全体管理画面にログインすることができるシステム管理者、塾講師ステーション管理者、ゲスト管理者のみ 3.2. 帳票 130_【FIX】企業担当者管理機能 の記載と同じ 3.3. メールテンプレート なし 3.4. ワークフロー 130_【FIX】企業担当者管理機能 の記載と同じ 3.4.1. 本機能 3.4.2. 関連 4. 要件定義 4.1. ユーザーインターフェース （画面） 4.1.1. 削除確認モーダル https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=5044-60992&amp;mode=design&amp;t=KfnMrjmjwXJIgmnS-4 4.1.2. 削除不可通知モーダル https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=14987-16621&amp;mode=design&amp;t=KfnMrjmjwXJIgmnS-4 4.1.3. 削除完了モーダル https://www.figma.com/file/8zITZViFoU0WYNnwig5AKc/%E3%80%90%E5%85%B1%E6%9C%89%E3%80%91%E3%83%88%E3%83%A2%E3%83%8E%E3%82%AB%E3%82%A4%E6%A7%98_%E5%A1%BE?type=design&amp;node-id=5044-61003&amp;mode=design&amp;t=KfnMrjmjwXJIgmnS-4 4.2. 入力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 項目名 変数名 入力元 説明 制限とエラーメッセージ 1 ユーザー番号：クライアント企業管理者 入力フォーム（隠しフォーム） 削除する対象 の 【FIX】クライアント企業管理者 のユーザー番号：クライアント企業管理者 2 企業番号 入力フォーム 隠しフォーム 編集する対象のクライアント企業管理者の、現在表示している企業との 【FIX】クライアント企業管理者-企業紐付け における企業番号 4.3. 出力 説明は、帳票の各ページの記載を前提とし、本ページに固有の特記事項のみ記載する。 出力項目 出力先 説明 1 ユーザー番号：クライアント企業管理者 画面 HTMLエスケープ処理をして出力する。 2 氏名 画面／データベース HTMLエスケープ処理をして出力する。 データベースへの保存時に匿名化する。 3 メールアドレス 画面／データベース HTMLエスケープ処理をして出力する。 データベースへの保存時に匿名化する。 4 担当者電話番号 データベース データベースへの保存時に匿名化する。 5 削除者 データベース 【作成中】帳票共通項目 に従う。 6 削除日時 データベース 【作成中】帳票共通項目 に従う。 4.4. 処理 ログイン状態を確認し、ログイン認証されていない場合は全体管理者画面のログイン画面にリダイレクトし、ログイン認証されているが権限の章に記載した権限を持っていない場合は全体管理者画面のTOP画面にリダイレクトする。 隠しフォームから取得した ユーザー番号： クライアント企業管理者 および企業番号の文字列 を取得し、ユーザー番号：クライアント企業管理者の文字列が自然数に変換できない場合、レスポンスステータス404 not foundを出力して処理を終了する。 ユーザー番号：クライアント企業管理者の文字列を元にデータベースから 【FIX】クライアント企業管理者 【FIX】クライアント企業管理者-企業紐付け を取得する。対象のユーザー番号：クライアント企業管理者のデータが存在しない場合、レスポンスステータス404 not foundを出力して処理を終了する。 削除対象の企業管理者が存在し、その企業管理者がその企業で唯一の管理者フラグがOFFの請求担当ではない場合、 次の順番で 帳票を論理削除とし、削除時間のみを記録し処理を終了する。 下記を削除する 【FIX】クライアント企業管理者-企業紐付け 前処理により、そのユーザーと紐づく企業が1つもなくなった場合は下記を削除する。紐づく企業が残っている場合は、下記は削除せずに、処理を終了する。 【FIX】クライアント企業管理者 削除が完了したポップアップを表示し、成功ログを出力し、 131_【FIX】企業担当者一覧閲覧機能 ページに遷移する。 なお削除時の影響範囲については https://giginc.atlassian.net/wiki/spaces/CLIENTTOMO/pages/772014210#2.-%E5%89%8A%E9%99%A4%E6%99%82%E3%81%AE%E5%8B%95%E4%BD%9C%E4%B8%80%E8%A6%A7 にて まとめている 。 4.5. エラー処理 途中で削除に失敗した場合は、それまでに削除した帳票は元に戻してエラーを表示する。 削除に失敗した理由をエラーとして表示する。 設定ファイルが存在しない、データベースにテーブル・フィールドが存在しない、メールテンプレートファイルが存在しない場合はプログラム上で特別な処理を行わず、Laravelの例外出力に任せる。 4.6. ログ 企業管理者の削除に成功した場合に下記フォーマットでログを出力する User {全体管理者のユーザー番号} deleted company_user . user_number={企業担当者のユーザー番号} company_number={企業番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 企業管理者の削除に失敗した場合に下記フォーマットでログを出力する User {全体管理者のユーザー番号} failed to delete company_user. user_number={企業担当者のユーザー番号} company_number={企業番号} {アクセスURI} {日時} {アクセス元IPアドレス} {ユーザーエージェント} 5. スコープ外・制限事項 なし",
  "parentId": "704544810",
  "parentTitle": "130_【FIX】企業担当者管理機能",
  "labels": [],
  "url": "/spaces/CLIENTTOMO/pages/718274738/135_+FIX",
  "spaceKey": "CLIENTTOMO",
  "lastModified": "2023-12-19T09:25:05.501Z",
  "author": "feng_xiaomeng (Unlicensed)",
  "excerpt": "1. 目次 2. 概要 本機能は 【FIX】クライアント企業管理者 【FIX】クライアント企業管理者-企業紐付け の登録済みのデータの1件を削除するための機能です。 3. 要求事項 131_【FIX】企業担当者一覧閲覧機能 ページの該当レコード内にある削除用ボタンを押下し、削除確認モーダル上で削除実行用のボタンを押下することで、以下の条件が満たされていれば対象のクライアント企業管理者情報を論理削除..."
}