# Settings to manage and configure a Firebase App Hosting backend.
# https://firebase.google.com/docs/app-hosting/configure

runConfig:
  # インスタンス設定（パフォーマンス最適化 2025-10-20）
  # コールドスタート完全回避のため2インスタンス維持
  minInstances: 2  # 1→2に増強（冗長性とパフォーマンス向上）
  maxInstances: 4
  
  # メモリ設定（埋め込みモデル + 複数同時リクエスト対応）
  memoryMiB: 4096
  
  # CPU設定
  cpu: 2
  
  # コンカレンシー設定（安定性優先）
  # 1インスタンスで1リクエスト処理（リソース競合回避）
  concurrency: 1
  
  # タイムアウト設定（検索処理時間を考慮）
  timeoutSeconds: 300  # 5分（デフォルト60秒から延長）
  
  # Phase 0A-4 ROLLBACK: Gen1に戻す（Gen2で問題発生）
  # 理由: Gen2では Kuromoji辞書ファイルやデータファイルの配置に問題
  # 前のバージョン（Gen1）では問題なく動作していた
  # executionEnvironment: gen2  ← コメントアウト（Gen1がデフォルト）

# 環境変数（runConfigと同じレベル）
env:
  # Next.js Public環境変数（ビルド時とランタイム時に必要）
  - variable: NEXT_PUBLIC_FIREBASE_API_KEY
    value: AIzaSyAgaGihnyshajIN2YC7CdJR_H0bJMg_hkI
    availability:
      - BUILD
      - RUNTIME
  
  - variable: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
    value: confluence-copilot-ppjye.firebaseapp.com
    availability:
      - BUILD
      - RUNTIME
  
  - variable: NEXT_PUBLIC_FIREBASE_PROJECT_ID
    value: confluence-copilot-ppjye
    availability:
      - BUILD
      - RUNTIME
  
  # ★★★ Xenova Transformers.js完全オフラインモード設定 ★★★
  # 問題: Cloud Run環境からHugging Face Hubへの通信が失敗
  # 原因: ネットワーク制限、ファイアウォール、一時的障害
  # 解決: HF_HUB_OFFLINE=1で一切の外部通信を無効化
  - variable: HF_HUB_OFFLINE
    value: "1"
    availability:
      - BUILD
      - RUNTIME
  
  # ★★★ 追加のオフライン設定 ★★★
  # transformers.jsの内部設定を強制的にオフラインモードに
  - variable: TRANSFORMERS_CACHE
    value: "/tmp/transformers_cache"
    availability:
      - BUILD
      - RUNTIME
  - variable: HF_HUB_DISABLE_TELEMETRY
    value: "1"
    availability:
      - BUILD
      - RUNTIME
  
  - variable: NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
    value: confluence-copilot-ppjye.firebasestorage.app
    availability:
      - BUILD
      - RUNTIME
  
  - variable: NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
    value: "122015916118"
    availability:
      - BUILD
      - RUNTIME
  
  - variable: NEXT_PUBLIC_FIREBASE_APP_ID
    value: 1:122015916118:web:50d117434b1318f173dbf7
    availability:
      - BUILD
      - RUNTIME
  
  - variable: NEXT_PUBLIC_USE_MOCK_DATA
    value: "false"
    availability:
      - BUILD
      - RUNTIME
  
  # Confluence API（ランタイムのみ）
  - variable: CONFLUENCE_BASE_URL
    value: https://giginc.atlassian.net
    availability:
      - RUNTIME
  
  - variable: CONFLUENCE_USER_EMAIL
    value: kanri@jukust.jp
    availability:
      - RUNTIME
  
  - variable: CONFLUENCE_API_TOKEN
    secret: confluence_api_token
    availability:
      - RUNTIME
  
  - variable: CONFLUENCE_SPACE_KEY
    value: CLIENTTOMO
    availability:
      - RUNTIME
  
  # Google Cloud（ビルド時とランタイムの両方）
  - variable: GOOGLE_CLOUD_PROJECT
    value: confluence-copilot-ppjye
    availability:
      - BUILD
      - RUNTIME
  
  # Gemini API（ビルド時とランタイムの両方）
  - variable: GEMINI_API_KEY
    secret: gemini_api_key
    availability:
      - BUILD
      - RUNTIME
  
  # その他（ランタイムのみ）
  - variable: EMBEDDINGS_PROVIDER
    value: local
    availability:
      - RUNTIME
  
  - variable: USE_LLM_EXPANSION
    value: "true"
    availability:
      - RUNTIME
  
  # ビルド最適化: データダウンロードをスキップ（実行時にCloud Storageから直接読み込む）
  # Note: false = ビルド時にダウンロード, true = 実行時に読み込み
  # ROLLBACK: インメモリFS再び失敗、ビルド時ダウンロードに戻す
  - variable: SKIP_DATA_DOWNLOAD
    value: "false"
    availability:
      - BUILD
      - RUNTIME
  
  # ROLLBACK: インメモリファイルシステムを再び無効化
  - variable: USE_INMEMORY_FS
    value: "false"
    availability:
      - RUNTIME
  
  # Cloud Storage設定（インメモリローダー用）
  - variable: STORAGE_BUCKET
    value: confluence-firebase-c3a86.firebasestorage.app
    availability:
      - RUNTIME