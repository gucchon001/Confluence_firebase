rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ğŸ” æœ¬ç•ªç’°å¢ƒ: èªè¨¼æ¸ˆã¿ã‹ã¤tomonokai-corp.comãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
    function isAllowedUser() {
      return request.auth != null 
        && request.auth.token.email_verified == true
        && request.auth.token.email.matches('.*@tomonokai-corp\\.com$');
    }
    
    // ğŸ§ª é–‹ç™ºç’°å¢ƒç”¨: èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å‰Šé™¤ã™ã‚‹ã“ã¨ï¼‰
    // TODO: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã« isDevMode() ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„
    function isDevMode() {
      // é–‹ç™ºç’°å¢ƒã§ã¯ä¸€æ™‚çš„ã«å…¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
      // æœ¬ç•ªç’°å¢ƒã§ã¯ã“ã®é–¢æ•°ã‚’å¿…ãš false ã«ã™ã‚‹ã“ã¨
      return true;  // â† æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã« false ã«å¤‰æ›´
    }

    // å…¨ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /{document=**} {
      allow read, write: if isAllowedUser() || isDevMode();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒ‡ãƒ¼ã‚¿
    match /users/{userId} {
      allow read: if isAllowedUser() && request.auth.uid == userId;
      allow write: if isAllowedUser() && request.auth.uid == userId;
      
      // ä¼šè©±å±¥æ­´
      match /conversations/{conversationId} {
        allow read: if isAllowedUser() && request.auth.uid == userId;
        allow write: if isAllowedUser() && request.auth.uid == userId;
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
    match /userPreferences/{userId} {
      allow read: if isAllowedUser() && request.auth.uid == userId;
      allow write: if isAllowedUser() && request.auth.uid == userId;
    }

    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
    match /systemMetrics/{metricId} {
      allow read, write: if isAllowedUser();
    }

    // ç®¡ç†è€…æ¨©é™ã®ç¢ºèªé–¢æ•°
    function isAdmin() {
      return isAllowedUser() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ç®¡ç†è€…å°‚ç”¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /adminLogs/{logId} {
      allow read, write: if isAdmin();
    }

    match /postLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isAllowedUser();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    match /feedback/{feedbackId} {
      allow read: if isAllowedUser();
      allow write: if isAllowedUser() && request.auth.uid == request.resource.data.userId;
    }
  }
}